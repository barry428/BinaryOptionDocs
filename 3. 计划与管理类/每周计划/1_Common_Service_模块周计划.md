# Common Service 模块周计划

## 项目基本信息
- **模块名称**: Common Service (用户和账户管理服务)
- **负责团队**: 后端开发团队
- **开发周期**: 6周 + 2周测试
- **当前进度**: 第2周 (开发阶段)

---

## 本周工作总结 (第2周)

### ✅ 已完成任务

#### 1. 用户管理功能
- ✅ 用户信息查询接口 (`GET /api/user/profile`)
- ✅ 用户协议状态更新接口 (`PUT /api/user/agreements`)
- ✅ OAuth自动注册机制集成
- ✅ 用户基础DTO统一和重复类合并

#### 2. 账户管理功能
- ✅ 账户列表查询接口 (`GET /api/account/list`)
- ✅ 账户余额查询接口 (`GET /api/account/balance/{accountType}`)
- ✅ DEMO账户初始资金领取功能 (`POST /api/account/demo/claim-bonus`)
- ✅ 移除重复的账户类型查询接口，统一使用余额接口

#### 3. BTSE集成 (Mock实现)
- ✅ BTSE转账服务Mock实现
- ✅ DEMO资金领取逻辑
- ✅ 资金流水记录完善
- ⚠️ **注意**: 由于BTSE API尚未完整提供，当前使用Mock数据

#### 4. 架构优化
- ✅ 账户统计字段修正 (区分存储字段和计算字段)
- ✅ DTO重复类合并 (`AccountBalanceDTO` → `AccountDTO`)
- ✅ 时间格式统一为时间戳 (毫秒)
- ✅ 全局Jackson配置实现

### 📊 完成度评估
- **用户管理**: 65% (基础功能完成，OAuth集成进行中)
- **账户管理**: 70% (核心接口完成，业务逻辑待完善)
- **BTSE集成**: 50% (Mock实现完成，真实API集成待开始)

---

## 下周计划 (第3周)

### 🎯 主要目标

#### 1. BTSE API真实集成
- [ ] 替换Mock实现为真实BTSE API调用
- [ ] BTSE用户余额查询集成
- [ ] BTSE转账接口集成
- [ ] BTSE转账记录同步

#### 2. 账户功能完善
- [ ] 实盘账户充值流程
- [ ] 实盘账户提现流程
- [ ] 账户资金流水详细记录
- [ ] 账户统计数据优化

#### 3. 用户功能增强
- [ ] 用户KYC状态管理
- [ ] 用户风险等级评估
- [ ] 用户操作日志记录

#### 4. 性能和稳定性
- [ ] 数据库连接池优化
- [ ] 缓存机制引入
- [ ] 异常处理完善
- [ ] 单元测试补充

### ⚠️ 风险和依赖

#### 关键风险
1. **BTSE API延期**: 如果BTSE API继续延期，将影响真实交易功能
2. **数据同步**: BTSE和本地数据的一致性保证
3. **安全性**: 资金操作的安全性验证

#### 外部依赖
- **BTSE方**: 提供完整的API文档和测试环境
- **Gateway**: OAuth认证机制的稳定性
- **Database**: PostgreSQL兼容性测试

### 📈 预期交付

#### 本周交付目标
- 真实BTSE API集成 (如API可用)
- 完整的账户资金管理功能
- 用户管理功能的性能优化
- 单元测试覆盖率达到70%

#### 质量标准
- 所有接口响应时间 < 500ms
- 数据一致性保证
- 完整的错误处理机制
- 符合安全编码规范

---

## 技术债务和后续优化

### 当前技术债务
1. Mock数据需要替换为真实API
2. 部分业务逻辑需要重构以适应BTSE API
3. 缓存层设计需要完善
4. 监控和日志系统需要加强

### 长期优化计划
- 引入Redis缓存提升性能
- 实现分布式事务保证数据一致性
- 添加全链路监控
- 优化数据库查询性能

---

## 📋 Jira任务分解

### **Epic**: Common Service模块开发

#### **Story 1**: 用户管理功能 (第1-2周完成)
```
优先级: High
标签: 后端-Common, OAuth集成

Task 1.1: 用户信息查询接口开发
- 子任务: UserController.getCurrentUserProfile()实现 [2h]
- 子任务: UserDTO统一和重复类合并 [1h]
- 子任务: 用户信息接口测试 [1h]

Task 1.2: 用户协议管理接口开发
- 子任务: PUT /api/user/agreements接口实现 [2h]
- 子任务: 协议状态业务逻辑验证 [1h]
- 子任务: 接口文档更新 [0.5h]
```

#### **Story 2**: 账户管理功能 (第1-2周完成)
```
优先级: High
标签: 后端-Common, 资金管理

Task 2.1: 账户查询接口开发
- 子任务: GET /api/account/list接口实现 [1h]
- 子任务: GET /api/account/balance/{accountType}接口实现 [1h]
- 子任务: 重复接口清理和统一 [1h]

Task 2.2: DEMO账户资金管理
- 子任务: POST /api/account/demo/claim-bonus实现 [2h]
- 子任务: 资金流水记录完善 [1h]
- 子任务: 账户统计字段修正 [1h]
```

#### **Story 3**: BTSE集成 (第2-3周)
```
优先级: Highest
标签: 后端-Common, 待BTSE-API, Mock实现

Task 3.1: BTSE Mock服务实现 (第2周完成)
- 子任务: BTSE转账服务Mock实现 [3h]
- 子任务: BTSE用户余额Mock接口 [2h]
- 子任务: Mock数据测试验证 [1h]

Task 3.2: BTSE真实API集成 (第3周)
- 子任务: 替换转账Mock为真实API [4h]
- 子任务: 替换余额查询Mock为真实API [2h]
- 子任务: BTSE API异常处理 [2h]
- 子任务: 数据同步验证 [2h]
```

#### **Story 4**: OAuth认证集成 (第2-3周)
```
优先级: Highest
标签: 后端-Common, OAuth集成

Task 4.1: OAuth用户自动注册 (第2周完成)
- 子任务: resolveOAuthUser RPC接口实现 [3h]
- 子任务: Mock用户ID映射逻辑 [2h]
- 子任务: 自动注册业务流程 [2h]

Task 4.2: OAuth集成优化 (第3周)
- 子任务: OAuth token验证优化 [2h]
- 子任务: 用户认证异常处理 [1h]
- 子任务: OAuth测试脚本完善 [1h]
```

#### **Story 5**: 架构优化和配置 (第1-3周)
```
优先级: Medium
标签: 后端-Common, 架构优化

Task 5.1: 数据库和DTO优化 (第2周完成)
- 子任务: 双数据库支持(MySQL/PostgreSQL) [3h]
- 子任务: 时间格式统一为时间戳 [2h]
- 子任务: 全局Jackson配置实现 [2h]

Task 5.2: 性能和监控优化 (第3周)
- 子任务: 数据库连接池优化 [2h]
- 子任务: 缓存机制引入 [3h]
- 子任务: 单元测试补充 [4h]
```

### **周次任务总结**

#### **第2周已完成任务** (实际工作量: ~25小时)
- ✅ Story 1: 用户管理功能 (6.5小时)
- ✅ Story 2: 账户管理功能 (6小时)  
- ✅ Task 3.1: BTSE Mock服务实现 (6小时)
- ✅ Task 4.1: OAuth用户自动注册 (7小时)
- ✅ Task 5.1: 数据库和DTO优化 (7小时)

#### **第3周计划任务** (预估工作量: ~20小时)
- [ ] Task 3.2: BTSE真实API集成 (10小时)
- [ ] Task 4.2: OAuth集成优化 (4小时)
- [ ] Task 5.2: 性能和监控优化 (9小时)
- [ ] 新增: 用户KYC和风险评估功能 (预留)

---

**更新时间**: 2025-08-17  
**下次更新**: 2025-08-24