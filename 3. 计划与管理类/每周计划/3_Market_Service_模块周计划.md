# Market Service 模块周计划

## 项目基本信息
- **模块名称**: Market Service (行情数据服务)
- **负责团队**: 后端开发团队
- **开发周期**: 6周 + 2周测试
- **当前进度**: 第2周 (开发阶段)

---

## 本周工作总结 (第2周)

### ✅ 已完成任务

#### 1. 基础行情服务
- ✅ 交易对配置管理 (`GET /api/market/symbols`)
- ✅ 交易对信息DTO重构 (添加baseCurrency、quoteCurrency)
- ✅ 移除冗余的价格和统计接口
- ✅ 双数据库支持 (MySQL/PostgreSQL)

#### 2. WebSocket实时行情系统
- ✅ **WebSocket服务器架构** - 完整的高性能推送系统
- ✅ **多交易对订阅机制** - 支持按需订阅指定交易对
- ✅ **实时行情推送** - 500ms频率的价格数据推送
- ✅ **24小时统计推送** - 2秒频率的统计数据推送
- ✅ **心跳检测机制** - ping/pong保活连接
- ✅ **连接管理优化** - 支持大量并发连接
- ✅ **性能监控** - 实时性能指标报告

#### 3. Mock数据系统
- ✅ **8个主流交易对支持** (BTC、ETH、BNB等)
- ✅ **实时价格模拟** - 基于真实波动模式
- ✅ **24小时统计模拟** - 包含高低价、涨跌幅等
- ✅ **数据缓存优化** - 100ms TTL缓存提升性能
- ⚠️ **注意**: 由于BTSE行情API尚未完整，当前使用Mock数据

#### 4. 架构优化
- ✅ **DTO架构统一** - 删除本地VO，使用共享DTO
- ✅ **时间格式统一** - 全部转换为时间戳格式
- ✅ **高性能消息队列** - 支持高并发WebSocket消息处理
- ✅ **WebSocket测试页面** - 完整的功能测试界面

### 📊 完成度评估
- **基础行情服务**: 65% (基础接口完成，数据处理待完善)
- **WebSocket系统**: 75% (核心功能完成，性能优化进行中)
- **Mock数据系统**: 70% (基础数据完成，复杂场景待补充)
- **数据存储**: 50% (架构设计完成，实现待开始)

---

## 下周计划 (第3周)

### 🎯 主要目标

#### 1. BTSE行情API集成
- [ ] **替换Mock为真实BTSE WebSocket行情**
- [ ] BTSE行情数据格式适配
- [ ] BTSE连接异常处理和重连机制
- [ ] 行情数据校验和过滤

#### 2. 行情数据存储
- [ ] **历史价格数据存储**
- [ ] K线数据生成和存储
- [ ] 24小时统计数据计算优化
- [ ] 数据清理和归档策略

#### 3. 性能和稳定性
- [ ] **WebSocket连接池优化**
- [ ] 大并发下的内存管理
- [ ] 行情数据延迟监控
- [ ] 异常情况下的服务降级

#### 4. 监控和运维
- [ ] 行情数据质量监控
- [ ] WebSocket连接状态监控
- [ ] 性能指标收集和告警
- [ ] 日志系统优化

### ⚠️ 风险和依赖

#### 关键风险
1. **BTSE行情API延期**: 影响真实行情数据的集成
2. **WebSocket稳定性**: 高并发下的连接稳定性
3. **数据延迟**: 行情数据的实时性要求
4. **存储性能**: 大量历史数据的存储和查询

#### 外部依赖
- **BTSE方**: WebSocket行情API和历史数据API
- **Gateway**: 路由配置和负载均衡
- **Database**: 大数据量存储性能

### 📈 预期交付

#### 本周交付目标
- 真实BTSE行情集成 (如API可用)
- 完整的历史数据存储系统
- 优化的WebSocket性能
- 完善的监控体系

#### 质量标准
- WebSocket推送延迟 < 100ms
- 支持1000+并发连接
- 行情数据准确率 99.9%
- 系统可用性 > 99.5%

---

## 技术债务和特殊考虑

### 当前技术债务
1. **Mock数据依赖**: 需要替换为真实BTSE行情
2. **存储策略**: 历史数据存储方案需要优化
3. **缓存层**: Redis缓存层需要引入
4. **API设计**: 部分RPC接口需要重构

### BTSE行情集成策略
由于BTSE行情API尚未完整提供，采用以下策略：
- **Phase 1**: 完善Mock数据系统，确保业务逻辑正确
- **Phase 2**: BTSE API可用后，实现无缝切换
- **Phase 3**: 数据对比验证，确保一致性

### WebSocket系统优势
当前实现的WebSocket系统具有以下特点：
- **高性能**: 基于事件驱动架构，支持大并发
- **可扩展**: 模块化设计，易于扩展新功能
- **稳定性**: 完善的异常处理和重连机制
- **监控**: 实时性能监控和告警

### 长期优化计划
- 引入Redis集群提升缓存性能
- 实现行情数据的分布式存储
- 建立完善的数据质量监控
- 优化WebSocket的内存使用

---

## 📋 Jira任务分解

### **Epic**: Market Service模块开发

#### **Story 1**: 基础行情服务 (第1-2周完成)
```
优先级: High
标签: 后端-Market, 基础服务

Task 1.1: 交易对配置管理
- 子任务: GET /api/market/symbols接口实现 [2h]
- 子任务: SymbolConfigDTO重构(baseCurrency/quoteCurrency) [1h]
- 子任务: 冗余接口清理和统一 [1h]

Task 1.2: 数据库架构优化
- 子任务: 双数据库支持(MySQL/PostgreSQL) [3h]
- 子任务: SymbolConverter转换逻辑优化 [1h]
- 子任务: 时间格式统一为时间戳 [1h]
```

#### **Story 2**: WebSocket实时推送系统 (第1-3周)
```
优先级: Highest
标签: 后端-Market, WebSocket, 实时推送

Task 2.1: WebSocket服务器架构 (第2周完成)
- 子任务: MarketWebSocketHandler基础架构 [4h]
- 子任务: 高性能消息队列设计 [3h]
- 子任务: 连接管理和会话管理 [3h]

Task 2.2: 实时数据推送功能 (第2周完成)
- 子任务: 多交易对订阅机制 [3h]
- 子任务: 实时行情推送(500ms频率) [2h]
- 子任务: 24小时统计推送(2秒频率) [2h]
- 子任务: 心跳检测机制(ping/pong) [1h]

Task 2.3: WebSocket性能优化 (第3周)
- 子任务: 连接池和内存管理优化 [3h]
- 子任务: 大并发下的性能调优 [3h]
- 子任务: 异常情况服务降级 [2h]
- 子任务: 实时性能监控和告警 [2h]
```

#### **Story 3**: Mock数据系统 (第1-2周完成)
```
优先级: High
标签: 后端-Market, Mock实现

Task 3.1: Mock数据生成
- 子任务: 8个主流交易对数据模拟 [3h]
- 子任务: 实时价格波动算法 [2h]
- 子任务: 24小时统计数据模拟 [2h]

Task 3.2: 数据缓存优化
- 子任务: 100ms TTL缓存机制 [2h]
- 子任务: 数据更新策略优化 [1h]
- 子任务: Mock数据质量验证 [1h]
```

#### **Story 4**: BTSE行情集成 (第3-4周)
```
优先级: Highest
标签: 后端-Market, 待BTSE-API, 真实数据

Task 4.1: BTSE WebSocket行情集成 (第3周)
- 子任务: 替换Mock为真实BTSE WebSocket [6h]
- 子任务: BTSE行情数据格式适配 [3h]
- 子任务: BTSE连接异常处理和重连 [3h]
- 子任务: 行情数据校验和过滤 [2h]

Task 4.2: 数据质量保证 (第3-4周)
- 子任务: 行情数据质量监控 [2h]
- 子任务: 数据延迟监控和告警 [2h]
- 子任务: 真实数据与Mock数据对比验证 [3h]
- 子任务: 数据一致性检查 [2h]
```

#### **Story 5**: 数据存储和历史数据 (第3-5周)
```
优先级: Medium
标签: 后端-Market, 数据存储

Task 5.1: 历史数据存储 (第3周)
- 子任务: 历史价格数据存储设计 [3h]
- 子任务: K线数据生成和存储 [4h]
- 子任务: 数据清理和归档策略 [2h]

Task 5.2: 查询和缓存优化 (第4-5周)
- 子任务: Redis缓存层引入 [4h]
- 子任务: 大数据量查询优化 [3h]
- 子任务: 数据分布式存储方案 [4h]
- 子任务: 存储性能监控 [2h]
```

#### **Story 6**: 监控和运维 (第3-4周)
```
优先级: Medium
标签: 后端-Market, 监控运维

Task 6.1: 系统监控 (第3周)
- 子任务: WebSocket连接状态监控 [2h]
- 子任务: 性能指标收集(QPS/延迟/内存) [3h]
- 子任务: 日志系统优化和分级 [2h]

Task 6.2: 运维工具 (第4周)
- 子任务: 健康检查端点 [1h]
- 子任务: 配置热更新机制 [2h]
- 子任务: 故障自动恢复机制 [3h]
```

### **周次任务总结**

#### **第2周已完成任务** (实际工作量: ~24小时)
- ✅ Story 1: 基础行情服务 (8小时)
- ✅ Task 2.1: WebSocket服务器架构 (10小时)
- ✅ Task 2.2: 实时数据推送功能 (8小时)
- ✅ Story 3: Mock数据系统 (9小时)

#### **第3周计划任务** (预估工作量: ~26小时)
- [ ] Task 2.3: WebSocket性能优化 (10小时)
- [ ] Task 4.1: BTSE WebSocket行情集成 (14小时，需BTSE API)
- [ ] Task 5.1: 历史数据存储 (9小时)
- [ ] Task 6.1: 系统监控 (7小时)

#### **第4周计划任务** (预估工作量: ~22小时)
- [ ] Task 4.2: 数据质量保证 (9小时)
- [ ] Task 5.2: 查询和缓存优化开始 (7小时)
- [ ] Task 6.2: 运维工具 (6小时)

#### **第5周计划任务** (预估工作量: ~15小时)
- [ ] Task 5.2: 查询和缓存优化完成 (6小时)
- [ ] 性能调优和压力测试 (9小时)

---

**更新时间**: 2025-08-17  
**下次更新**: 2025-08-24