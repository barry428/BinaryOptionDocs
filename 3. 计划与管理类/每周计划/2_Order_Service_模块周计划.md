# Order Service 模块周计划

## 项目基本信息
- **模块名称**: Order Service (订单管理服务)
- **负责团队**: 后端开发团队
- **开发周期**: 6周 + 2周测试
- **当前进度**: 第2周 (开发阶段)

---

## 本周工作总结 (第2周)

### ✅ 已完成任务

#### 1. 订单核心功能
- ✅ 订单创建接口 (`POST /api/order`)
- ✅ 订单详情查询接口 (`GET /api/order/{id}`)
- ✅ 活跃订单列表查询 (`POST /api/order/list/active`)
- ✅ 历史订单列表查询 (`POST /api/order/list/history`)
- ✅ 订单取消功能 (`POST /api/order/{id}/cancel`)
- ✅ 订单统计接口 (`GET /api/order/stats`)

#### 2. 交易轮次管理
- ✅ 公开交易轮次查询接口 (`GET /api/public/order/round/current/{symbolId}`)
- ✅ 多时长轮次支持 (5分钟、10分钟、15分钟)
- ✅ 轮次状态管理 (OPEN、LOCKED、SETTLED)
- ✅ 轮次自动生成和调度

#### 3. 订单结算系统
- ✅ 单订单结算功能
- ✅ 批量轮次结算功能
- ✅ REAL账户结算资金转出到BTSE (Mock)
- ✅ DEMO账户结算资金本地处理
- ✅ 结算盈亏统计更新

#### 4. 订单状态机
- ✅ PENDING → ACTIVE → WIN/LOSE/DRAW流程
- ✅ 订单取消机制
- ✅ 预订单补偿逻辑 (已简化为本地事务)

#### 5. 架构优化
- ✅ DTO统一 (`OrderDetailDTO` → `OrderDTO`)
- ✅ 时间格式统一为时间戳
- ✅ 双数据库支持 (MySQL/PostgreSQL)
- ✅ RPC接口标准化

### 📊 完成度评估
- **订单管理**: 70% (基础功能完成，复杂业务逻辑待完善)
- **交易轮次**: 60% (基础轮次完成，多时长调度待优化)
- **结算系统**: 55% (DEMO基础完成，REAL和风控待开发)
- **对冲系统**: 50% (架构设计完成，具体实现待开始)

---

## 下周计划 (第3周)

### 🎯 主要目标

#### 1. BTSE Fixture集成
- [ ] 替换Mock Fixture为真实BTSE Fixture API
- [ ] 订单对冲逻辑完善
- [ ] Fixture选择策略优化
- [ ] 对冲失败补偿机制

#### 2. 订单风控系统
- [ ] 用户下单频率限制
- [ ] 单日最大投注金额控制
- [ ] 账户余额不足检查增强
- [ ] 异常订单监控和告警

#### 3. 结算系统优化
- [ ] 结算价格获取优化 (集成BTSE实时价格)
- [ ] 结算准确性验证
- [ ] 结算异常处理机制
- [ ] 结算数据对账功能

#### 4. 性能优化
- [ ] 订单查询性能优化
- [ ] 大数据量分页优化
- [ ] 数据库索引优化
- [ ] 缓存策略实现

### ⚠️ 风险和依赖

#### 关键风险
1. **BTSE Fixture API延期**: 影响对冲功能的真实实现
2. **价格数据准确性**: 结算价格的实时性和准确性
3. **高并发处理**: 交易高峰期的系统稳定性
4. **数据一致性**: 分布式环境下的事务保证

#### 外部依赖
- **BTSE方**: Fixture API和实时价格API
- **Market Service**: 价格数据服务的稳定性
- **Common Service**: 账户资金操作的可靠性

### 📈 预期交付

#### 本周交付目标
- 真实Fixture集成 (如API可用)
- 完整的订单风控系统
- 优化的结算流程
- 单元测试覆盖率达到75%

#### 质量标准
- 订单创建响应时间 < 200ms
- 结算准确率 100%
- 并发订单处理能力 > 1000/秒
- 零资金错误率

---

## 技术债务和特殊考虑

### 当前技术债务
1. **Mock数据依赖**: Fixture和价格数据仍使用Mock
2. **对冲逻辑**: 需要根据真实BTSE API调整
3. **性能优化**: 大量订单查询的性能需要优化
4. **监控系统**: 订单异常监控需要完善

### BTSE API集成计划
由于BTSE API尚未完整提供，当前采用以下策略：
- **Phase 1**: 继续使用Mock数据完善业务逻辑
- **Phase 2**: BTSE API可用后立即替换Mock实现
- **Phase 3**: 真实环境测试和数据校验

### 长期优化计划
- 实现订单数据的实时同步
- 引入消息队列处理高并发订单
- 建立完善的订单审计系统
- 优化大数据量的查询性能

---

## 📋 Jira任务分解

### **Epic**: Order Service模块开发

#### **Story 1**: 订单核心功能 (第1-2周完成)
```
优先级: Highest
标签: 后端-Order, 核心业务

Task 1.1: 订单CRUD接口开发
- 子任务: POST /api/order订单创建接口 [3h]
- 子任务: GET /api/order/{id}订单详情查询 [1h]
- 子任务: POST /api/order/{id}/cancel订单取消功能 [2h]

Task 1.2: 订单列表查询功能
- 子任务: POST /api/order/list/active活跃订单查询 [2h]
- 子任务: POST /api/order/list/history历史订单查询 [2h]
- 子任务: 分页和筛选逻辑优化 [1h]

Task 1.3: 订单统计功能
- 子任务: GET /api/order/stats订单统计接口 [2h]
- 子任务: 统计数据计算逻辑 [2h]
- 子任务: DTO统一和重复类合并 [1h]
```

#### **Story 2**: 交易轮次管理 (第1-2周完成)
```
优先级: High
标签: 后端-Order, 轮次管理

Task 2.1: 公开轮次查询接口
- 子任务: GET /api/public/order/round/current/{symbolId}实现 [2h]
- 子任务: 多时长轮次支持(5min/10min/15min) [2h]
- 子任务: TradingRoundInfoDTO设计和实现 [1h]

Task 2.2: 轮次状态管理
- 子任务: 轮次状态机(OPEN/LOCKED/SETTLED) [2h]
- 子任务: 轮次自动生成调度逻辑 [3h]
- 子任务: 轮次锁定和结算时机控制 [2h]
```

#### **Story 3**: 订单结算系统 (第2-3周)
```
优先级: High
标签: 后端-Order, 结算系统

Task 3.1: 基础结算功能 (第2周完成)
- 子任务: 单订单结算逻辑实现 [3h]
- 子任务: 批量轮次结算功能 [2h]
- 子任务: DEMO账户结算资金处理 [2h]

Task 3.2: REAL账户结算优化 (第3周)
- 子任务: REAL账户结算资金转出到BTSE [4h]
- 子任务: 结算准确性验证机制 [2h]
- 子任务: 结算异常处理和补偿 [3h]
- 子任务: 结算数据对账功能 [2h]
```

#### **Story 4**: 订单对冲系统 (第2-4周)
```
优先级: High
标签: 后端-Order, 待BTSE-API, Mock实现

Task 4.1: 对冲架构设计 (第2周完成)
- 子任务: OrderHedgeService基础架构 [3h]
- 子任务: 对冲状态机设计 [2h]
- 子任务: 对冲记录和补偿逻辑 [2h]

Task 4.2: Fixture集成和对冲实现 (第3-4周)
- 子任务: 替换Mock Fixture为真实BTSE API [6h]
- 子任务: Fixture选择策略优化 [3h]
- 子任务: 对冲失败补偿机制 [3h]
- 子任务: 对冲性能和监控优化 [2h]
```

#### **Story 5**: 风控和性能优化 (第3-4周)
```
优先级: Medium
标签: 后端-Order, 风控系统

Task 5.1: 订单风控系统 (第3周)
- 子任务: 用户下单频率限制 [2h]
- 子任务: 单日最大投注金额控制 [2h]
- 子任务: 账户余额检查增强 [1h]
- 子任务: 异常订单监控和告警 [3h]

Task 5.2: 性能优化 (第3-4周)
- 子任务: 订单查询性能优化 [3h]
- 子任务: 大数据量分页优化 [2h]
- 子任务: 数据库索引优化 [2h]
- 子任务: 缓存策略实现 [3h]
```

### **周次任务总结**

#### **第2周已完成任务** (实际工作量: ~28小时)
- ✅ Story 1: 订单核心功能 (16小时)
- ✅ Story 2: 交易轮次管理 (10小时)
- ✅ Task 3.1: 基础结算功能 (7小时)
- ✅ Task 4.1: 对冲架构设计 (7小时)

#### **第3周计划任务** (预估工作量: ~25小时)
- [ ] Task 3.2: REAL账户结算优化 (11小时)
- [ ] Task 4.2: Fixture集成开始 (8小时，需BTSE API)
- [ ] Task 5.1: 订单风控系统 (8小时)

#### **第4周计划任务** (预估工作量: ~20小时)
- [ ] Task 4.2: Fixture集成完成 (6小时)
- [ ] Task 5.2: 性能优化 (10小时)
- [ ] 新增: 高级风控和监控功能 (预留)

---

**更新时间**: 2025-08-17  
**下次更新**: 2025-08-24