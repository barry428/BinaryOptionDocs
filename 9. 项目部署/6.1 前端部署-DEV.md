# Binary Option 前端部署文档 - BTSE DEV 环境

## 1. 前端架构图

```
┌─────────────────┐
│   Load Balancer │ (外部负载均衡器)
│   (Port: 80)    │
└─────────┬───────┘
          │
┌─────────▼───────┐
│     Nginx       │ (前端静态资源 + 反向代理)
│   (Port: 80)    │
│                 │
│ ┌─────────────┐ │
│ │Static Files │ │ (HTML/CSS/JS)
│ │   /dist/    │ │
│ └─────────────┘ │
└─────────┬───────┘
          │ /api/borc/*
┌─────────▼───────┐
│  option-gateway │ (API网关服务)
│   (Port: 8080)  │
└─────────────────┘
```

## 2. 技术栈

- **框架**: Vue.js 3 / React 18 / Angular 15+
- **构建工具**: Vite / Webpack 5
- **UI库**: Element Plus / Ant Design / Material-UI
- **状态管理**: Pinia / Redux Toolkit / NgRx
- **HTTP客户端**: Axios
- **WebSocket**: Socket.io-client / native WebSocket

## 3. 环境配置

### 3.1 环境变量配置
**文件**: `.env.btsedev`
```bash
# API配置
VITE_API_BASE_URL=http://dev-gateway.btse.example.com:80/api/borc
VITE_WS_BASE_URL=ws://dev-market.btse.example.com:80/ws

# 环境标识
VITE_APP_ENV=btsedev
VITE_APP_NAME=Binary Option DEV

# 调试配置
VITE_DEBUG=true
VITE_LOG_LEVEL=debug

# OAuth配置
VITE_OAUTH_CLIENT_ID=btse_binary_option_dev
VITE_OAUTH_REDIRECT_URI=http://dev.btse.example.com/auth/callback
```

### 3.2 构建配置
**文件**: `vite.config.btsedev.js`
```javascript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  mode: 'btsedev',
  base: '/',
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: true,
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: false,
        drop_debugger: false
      }
    }
  },
  server: {
    port: 3000,
    host: '0.0.0.0',
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        secure: false
      },
      '/ws': {
        target: 'ws://localhost:8080',
        ws: true
      }
    }
  }
})
```

## 4. 构建和部署

### 4.1 本地构建
```bash
# 安装依赖
npm install

# 开发环境启动
npm run dev:btsedev

# 构建生产包
npm run build:btsedev
```

### 4.2 Docker构建
**文件**: `Dockerfile`
```dockerfile
# 构建阶段
FROM node:18-alpine as build

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build:btsedev

# 运行阶段
FROM nginx:alpine

# 复制构建产物
COPY --from=build /app/dist /usr/share/nginx/html

# 复制Nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 创建日志目录
RUN mkdir -p /var/log/nginx && chmod 755 /var/log/nginx

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 4.3 package.json 脚本
```json
{
  "scripts": {
    "dev:btsedev": "vite --config vite.config.btsedev.js --mode btsedev",
    "build:btsedev": "vite build --config vite.config.btsedev.js --mode btsedev",
    "preview:btsedev": "vite preview --config vite.config.btsedev.js"
  }
}
```

## 5. Nginx配置

### 5.1 主要配置文件
**文件**: `nginx.conf`
```nginx
server {
    listen 80;
    server_name dev.btse.example.com;
    
    # 静态资源目录
    root /usr/share/nginx/html;
    index index.html;

    # 启用gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API反向代理
    location /api/borc/ {
        proxy_pass http://option-gateway:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS配置
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With";
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    # WebSocket代理
    location /ws/ {
        proxy_pass http://option-market-service:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

## 6. Docker Compose部署

### 6.1 前端服务配置
**文件**: `docker-compose.btsedev.yml` (添加到现有文件)
```yaml
services:
  # ... 后端服务配置 ...

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    volumes:
      - ./logs/nginx:/var/log/nginx
    environment:
      - NGINX_HOST=dev.btse.example.com
    depends_on:
      - option-gateway
      - option-market-service
    networks:
      - btse-network

networks:
  btse-network:
    external: true
```

## 7. 启动命令

### 7.1 开发模式
```bash
# 启动开发服务器
npm run dev:btsedev

# 访问地址: http://localhost:3000
```

### 7.2 生产部署
```bash
# 构建前端
npm run build:btsedev

# Docker部署
docker-compose -f docker-compose.btsedev.yml up -d frontend

# 访问地址: http://dev.btse.example.com
```

## 8. 环境变量

### 8.1 必需的环境变量
```bash
# API配置
API_BASE_URL=http://dev-gateway.btse.example.com:80/api/borc
WS_BASE_URL=ws://dev-market.btse.example.com:80/ws

# OAuth配置
OAUTH_CLIENT_ID=btse_binary_option_dev
OAUTH_REDIRECT_URI=http://dev.btse.example.com/auth/callback

# Nginx配置
NGINX_HOST=dev.btse.example.com
NGINX_PORT=80
```

## 9. 健康检查

### 9.1 健康检查URLs
- **前端页面**: `http://dev.btse.example.com/`
- **Nginx健康检查**: `http://dev.btse.example.com/health`
- **静态资源**: `http://dev.btse.example.com/assets/`

### 9.2 预期响应
```bash
# 健康检查
curl http://dev.btse.example.com/health
# 响应: healthy

# 首页访问
curl -I http://dev.btse.example.com/
# 响应: HTTP/1.1 200 OK
```

## 10. 常见问题排查

### 10.1 构建失败
```bash
# 清理缓存重新构建
rm -rf node_modules package-lock.json
npm install
npm run build:btsedev
```

### 10.2 API调用失败
检查Nginx代理配置:
```bash
# 查看Nginx日志
docker logs frontend-container

# 检查代理转发
curl -v http://dev.btse.example.com/api/borc/health
```

### 10.3 WebSocket连接失败
```bash
# 检查WebSocket代理
curl -H "Upgrade: websocket" \
     -H "Connection: Upgrade" \
     http://dev.btse.example.com/ws/market
```

### 10.4 静态资源404
```bash
# 检查文件权限
docker exec frontend-container ls -la /usr/share/nginx/html

# 检查Nginx配置
docker exec frontend-container nginx -t
```

## 11. 监控和日志

### 11.1 Nginx访问日志
```bash
# 查看访问日志
tail -f logs/nginx/access.log

# 查看错误日志  
tail -f logs/nginx/error.log
```

### 11.2 性能监控
- **页面加载时间**: < 2秒
- **API响应时间**: < 500ms
- **WebSocket连接时间**: < 1秒
- **静态资源缓存命中率**: > 90%

---

## 部署检查清单

- [ ] Node.js环境已安装 (v18+)
- [ ] 依赖包已安装 (`npm install`)
- [ ] 环境变量已配置 (`.env.btsedev`)
- [ ] 构建配置已更新 (`vite.config.btsedev.js`)
- [ ] Nginx配置已创建 (`nginx.conf`)
- [ ] Docker镜像已构建
- [ ] 容器网络已配置 (`btse-network`)
- [ ] 日志目录已创建并有写权限
- [ ] 健康检查接口正常响应
- [ ] API代理转发正常
- [ ] WebSocket连接正常
- [ ] 静态资源访问正常

**部署完成后，访问 http://dev.btse.example.com 验证前端页面正常加载。**