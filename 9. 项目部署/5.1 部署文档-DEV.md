# Binary Option 项目部署文档 - BTSE DEV 环境

## 1. 服务调用关系图

```
┌─────────────────┐
│   Load Balancer │ (外部负载均衡器)
│   (Port: 80)    │
└─────────┬───────┘
          │
┌─────────▼───────┐
│     Nginx       │ (前端静态资源 + 反向代理)
│   (Port: 80)    │
└─────────┬───────┘
          │ /api/borc/*
┌─────────▼───────┐
│  option-gateway │ (API网关服务)
│   (Port: 8080)  │
└─────────┬───────┘
          │
┌─────────▼───────┐
│  Nginx Internal │ (内部服务负载均衡)
│   (Port: 8080)  │
└─────────┬───────┘
          │
    ┌─────┴─────┬─────────────┬─────────────┐
    │           │             │             │
┌───▼────┐ ┌───▼────┐ ┌─────▼─────┐ ┌─────▼─────┐
│common  │ │order   │ │  market   │ │   Redis   │
│service │ │service │ │  service  │ │  Cluster  │
│:8080   │ │:8080   │ │  :8080    │ │:7001-7006 │
└────────┘ └────────┘ └───────────┘ └───────────┘
                            │
                    ┌───────▼────────┐
                    │   PostgreSQL   │
                    │    Database    │
                    │   (Port: 5432) │
                    └────────────────┘
```

### 服务端口分配
- **Nginx (前端)**: 80
- **option-gateway**: 8080  
- **option-common-service**: 8080
- **option-order-service**: 8080
- **option-market-service**: 8080
- **Redis Cluster**: 7001-7006
- **PostgreSQL**: 5432

**注意**: 所有后端服务都使用8080端口，通过容器网络和服务名区分

## 2. 配置文件目录和修改说明

### 2.1 需要创建的配置文件

为BTSE DEV环境创建以下配置文件 (基于staging但使用Redis集群):

#### Gateway服务
**文件**: `option-gateway/src/main/resources/application-btsedev.yml`
```yaml
# BTSE DEV环境配置
spring:
  redis:
    cluster:
      nodes: ${REDIS_CLUSTER_NODES:redis-node1:7001,redis-node2:7002,redis-node3:7003,redis-node4:7004,redis-node5:7005,redis-node6:7006}
      password: ${REDIS_PASSWORD}
      max-redirects: 3
    lettuce:
      pool:
        max-active: 16
        max-idle: 8
        min-idle: 4
      cluster:
        refresh:
          adaptive: true
          period: 60s
  cloud:
    nacos:
      discovery:
        enabled: false
      config:
        enabled: false
    gateway:
      routes:
        # BTSE DEV环境通过Nginx转发到后端服务
        - id: auth-api
          uri: ${NGINX_SERVICE_URL:http://nginx-internal:8080}
          predicates:
            - Path=/api/borc/auth/**
        - id: user-api
          uri: ${NGINX_SERVICE_URL:http://nginx-internal:8080}
          predicates:
            - Path=/api/borc/user/**
        - id: account-api
          uri: ${NGINX_SERVICE_URL:http://nginx-internal:8080}
          predicates:
            - Path=/api/borc/account/**
        - id: order-api
          uri: ${NGINX_SERVICE_URL:http://nginx-internal:8080}
          predicates:
            - Path=/api/borc/order/**
        - id: public-order-api
          uri: ${NGINX_SERVICE_URL:http://nginx-internal:8080}
          predicates:
            - Path=/api/borc/public/order/**

# BTSE DEV环境服务地址配置 (通过Nginx转发)
option:
  common-service:
    url: ${NGINX_SERVICE_URL:http://nginx-internal:8080}
```

#### Common服务
**文件**: `option-common-service/src/main/resources/application-btsedev.yml`
```yaml
# BTSE DEV环境配置
spring:
  application:
    name: option-common-service
  datasource:
    url: jdbc:postgresql://${DB_HOST:postgres-server}:${DB_PORT:5432}/${DB_NAME:binary_option}
    username: ${DB_USER:postgres}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
  redis:
    cluster:
      nodes: ${REDIS_CLUSTER_NODES:redis-node1:7001,redis-node2:7002,redis-node3:7003,redis-node4:7004,redis-node5:7005,redis-node6:7006}
      password: ${REDIS_PASSWORD}
      max-redirects: 3
    lettuce:
      pool:
        max-active: 16
        max-idle: 8
        min-idle: 4
      cluster:
        refresh:
          adaptive: true
          period: 60s
  cloud:
    nacos:
      discovery:
        enabled: false
      config:
        enabled: false

# MyBatis配置
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.binaryoption.commonservice.domain
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
    database-id: postgresql

# Actuator配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized

# 缓存配置
cache:
  redis:
    key-prefix: "bo:"
```

#### Order服务
**文件**: `option-order-service/src/main/resources/application-btsedev.yml`
```yaml
# BTSE DEV环境配置  
spring:
  datasource:
    url: jdbc:postgresql://${DB_HOST:postgres-server}:${DB_PORT:5432}/${DB_NAME:binary_option}
    username: ${DB_USER:postgres}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
  redis:
    cluster:
      nodes: ${REDIS_CLUSTER_NODES:redis-node1:7001,redis-node2:7002,redis-node3:7003,redis-node4:7004,redis-node5:7005,redis-node6:7006}
      password: ${REDIS_PASSWORD}
      max-redirects: 3
    lettuce:
      pool:
        max-active: 16
        max-idle: 8
        min-idle: 4
      cluster:
        refresh:
          adaptive: true
          period: 60s
  cloud:
    nacos:
      discovery:
        enabled: false
      config:
        enabled: false

# MyBatis配置
mybatis:
  configuration:
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
    database-id: postgresql

# Feign配置
feign:
  client:
    config:
      default:
        readTimeout: 15000
      option-common-service:
        url: ${COMMON_SERVICE_URL:http://option-common-service:8080}

# Actuator配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized

# 缓存配置  
cache:
  redis:
    key-prefix: "bo:"
```

#### Market服务
**文件**: `option-market-service/src/main/resources/application-btsedev.yml`
```yaml
# BTSE DEV环境配置
spring:
  application:
    name: option-market-service
  datasource:
    url: jdbc:postgresql://${DB_HOST:postgres-server}:${DB_PORT:5432}/${DB_NAME:binary_option}
    username: ${DB_USER:postgres}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
  redis:
    cluster:
      nodes: ${REDIS_CLUSTER_NODES:redis-node1:7001,redis-node2:7002,redis-node3:7003,redis-node4:7004,redis-node5:7005,redis-node6:7006}
      password: ${REDIS_PASSWORD}
      max-redirects: 3
    lettuce:
      pool:
        max-active: 16
        max-idle: 8
        min-idle: 4
      cluster:
        refresh:
          adaptive: true
          period: 60s
  cloud:
    nacos:
      discovery:
        enabled: false
      config:
        enabled: false

# MyBatis配置
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.binaryoption.marketservice.domain
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
    database-id: postgresql

# 行情数据源配置 - BTSE DEV环境
external:
  websocket:
    mock:
      enabled: ${EXTERNAL_WEBSOCKET_MOCK_ENABLED:true}
    url: ${EXTERNAL_WEBSOCKET_URL:wss://dev.btse.example.com/v1/ws/}
    reconnect:
      interval: ${EXTERNAL_WEBSOCKET_RECONNECT_INTERVAL:5000}
    heartbeat:
      interval: ${EXTERNAL_WEBSOCKET_HEARTBEAT_INTERVAL:30000}

# 缓存配置
cache:
  price:
    expire-seconds: 60
  kline:
    expire-seconds: 7200
  symbol:
    expire-seconds: 86400
  redis:
    key-prefix: "bo:"

# WebSocket配置
websocket:
  endpoint: /ws
  allowed-origins: ${WS_ALLOWED_ORIGINS:*}
  buffer-size: 16384

# Swagger配置 - 在DEV环境启用
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true

# Actuator配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized
```

### 2.2 配置文件修改点

#### 主要差异对比 (staging -> btsedev)
1. **Redis配置**: 单机 → 集群模式
2. **数据库地址**: host.docker.internal → postgres-server
3. **Redis节点**: redis → redis-node1~6:7001-7006
4. **WebSocket URL**: staging.btse → dev.btse
5. **Swagger**: 禁用 → 启用 (DEV环境需要API文档)

## 3. 数据库初始化

### 3.1 数据库初始化文件
**位置**: `sql/2025-09-08-postgresql-v3.sql`

### 3.2 执行步骤
1. 确保PostgreSQL服务运行正常
2. 创建数据库和用户:
```sql
-- 连接到PostgreSQL
CREATE DATABASE binary_option;
CREATE USER binary_option_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE binary_option TO binary_option_user;
```

3. 执行初始化脚本:
```bash
psql -h postgres-server -U binary_option_user -d binary_option -f sql/2025-09-08-postgresql-v3.sql
```

### 3.3 数据库表结构
初始化脚本包含以下核心表:
- `users` - 用户表
- `accounts` - 账户表
- `orders` - 订单表
- `trading_rounds` - 交易轮次表
- `symbols` - 交易对配置表
- `account_transactions` - 账户交易记录表
- `btse_transfer_log` - BTSE转账日志表

## 4. 服务启动命令

### 4.1 Docker Compose 启动 (推荐)
**文件**: `docker-compose.btsedev.yml`
```yaml
version: '3.8'

services:
  option-gateway:
    image: option-gateway:latest
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=btsedev
      - REDIS_CLUSTER_NODES=redis-node1:7001,redis-node2:7002,redis-node3:7003,redis-node4:7004,redis-node5:7005,redis-node6:7006
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - DB_HOST=postgres-server
      - DB_PASSWORD=${DB_PASSWORD}
      - NGINX_SERVICE_URL=http://nginx-internal:8080
    volumes:
      - ./logs:/logs
    depends_on:
      - redis-cluster
      - postgres

  option-common-service:
    image: option-common-service:latest
    environment:
      - SPRING_PROFILES_ACTIVE=btsedev
      - REDIS_CLUSTER_NODES=redis-node1:7001,redis-node2:7002,redis-node3:7003,redis-node4:7004,redis-node5:7005,redis-node6:7006
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - DB_HOST=postgres-server
      - DB_PASSWORD=${DB_PASSWORD}
    volumes:
      - ./logs:/logs
    depends_on:
      - redis-cluster
      - postgres

  option-order-service:
    image: option-order-service:latest
    environment:
      - SPRING_PROFILES_ACTIVE=btsedev
      - REDIS_CLUSTER_NODES=redis-node1:7001,redis-node2:7002,redis-node3:7003,redis-node4:7004,redis-node5:7005,redis-node6:7006
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - DB_HOST=postgres-server
      - DB_PASSWORD=${DB_PASSWORD}
      - COMMON_SERVICE_URL=http://option-common-service:8080
    volumes:
      - ./logs:/logs
    depends_on:
      - redis-cluster
      - postgres
      - option-common-service

  option-market-service:
    image: option-market-service:latest
    environment:
      - SPRING_PROFILES_ACTIVE=btsedev
      - REDIS_CLUSTER_NODES=redis-node1:7001,redis-node2:7002,redis-node3:7003,redis-node4:7004,redis-node5:7005,redis-node6:7006
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - DB_HOST=postgres-server
      - DB_PASSWORD=${DB_PASSWORD}
    volumes:
      - ./logs:/logs
    depends_on:
      - redis-cluster
      - postgres

networks:
  default:
    name: btse-network
```

启动命令:
```bash
docker-compose -f docker-compose.btsedev.yml up -d
```

### 4.2 JAR包启动方式
```bash
# Gateway
java -jar -Dspring.profiles.active=btsedev option-gateway-0.0.1-SNAPSHOT.jar

# Common Service  
java -jar -Dspring.profiles.active=btsedev option-common-service-0.0.1-SNAPSHOT.jar

# Order Service
java -jar -Dspring.profiles.active=btsedev option-order-service-0.0.1-SNAPSHOT.jar

# Market Service
java -jar -Dspring.profiles.active=btsedev option-market-service-0.0.1-SNAPSHOT.jar
```

## 5. 环境变量配置

### 5.1 必需的环境变量
```bash
# Redis集群配置
REDIS_CLUSTER_NODES=redis-node1:7001,redis-node2:7002,redis-node3:7003,redis-node4:7004,redis-node5:7005,redis-node6:7006
REDIS_PASSWORD=your_redis_password

# 数据库配置
DB_HOST=postgres-server
DB_PORT=5432
DB_NAME=binary_option
DB_USER=binary_option_user
DB_PASSWORD=your_db_password

# 服务配置
NGINX_SERVICE_URL=http://nginx-internal:8080
COMMON_SERVICE_URL=http://option-common-service:8080

# WebSocket配置
EXTERNAL_WEBSOCKET_URL=wss://dev.btse.example.com/v1/ws/
EXTERNAL_WEBSOCKET_MOCK_ENABLED=true
WS_ALLOWED_ORIGINS=*

# JVM配置 (可选)
JAVA_OPTS=-Xmx2g -Xms1g -XX:+UseG1GC
```

## 6. 日志配置

### 6.1 日志目录结构
所有服务的日志将写入到 `/logs` 目录:
```
/logs/
├── option-gateway-application.log
├── option-gateway-access.log  
├── option-gateway-error.log
├── option-common-service-application.log
├── option-common-service-access.log
├── option-common-service-error.log
├── option-order-service-application.log
├── option-order-service-access.log
├── option-order-service-error.log
├── option-market-service-application.log
├── option-market-service-access.log
├── option-market-service-error.log
└── gc/
    ├── option-gateway-gc.log
    ├── option-common-service-gc.log  
    ├── option-order-service-gc.log
    └── option-market-service-gc.log
```

### 6.2 日志格式 (符合BTSE规范)
```
2025-09-10T17:31:40.439+08:00 ACCESS 42647 [http-nio-8082-exec-3] [ACCESS_LOG] [959f1178-842e-40ad-a78c-62491473e916] [0c1f53d9f638428cb82f6a594962d90a] [testuser_123] [192.168.1.100] [] : GET /api/borc/order/list 200 15ms - API Access
```

字段说明:
- **Timestamp**: ISO8601格式时间戳
- **LogLevel**: 日志级别  
- **PID**: 进程ID
- **Thread**: 线程名称
- **Logger**: 日志记录器名称
- **call-id**: 请求唯一标识
- **trace-id**: 分布式追踪ID
- **user-name**: 用户名
- **IP-address**: 客户端IP地址
- **error-code**: 错误码
- **Message**: 具体日志内容

## 7. 健康检查

### 7.1 服务健康检查URL
通过容器名或负载均衡器访问：
- Gateway: `http://option-gateway:8080/actuator/health`
- Common Service: `http://option-common-service:8080/actuator/health`
- Order Service: `http://option-order-service:8080/actuator/health`
- Market Service: `http://option-market-service:8080/actuator/health`

**注意**: 所有服务都使用8080端口，在容器环境中通过服务名区分

### 7.2 预期健康检查响应
```json
{
  "status": "UP",
  "components": {
    "db": {"status": "UP"},
    "redis": {"status": "UP"},
    "ping": {"status": "UP"}
  }
}
```

## 8. 常见问题排查

### 8.1 Redis集群连接问题
```bash
# 检查Redis集群状态
redis-cli -c -h redis-node1 -p 7001 cluster nodes

# 测试Redis连接
redis-cli -c -h redis-node1 -p 7001 -a your_password ping
```

### 8.2 数据库连接问题
```bash
# 测试数据库连接
psql -h postgres-server -U binary_option_user -d binary_option -c "SELECT version();"
```

### 8.3 服务启动失败
检查日志文件中的ERROR信息:
```bash
tail -f /logs/option-*-error.log
```

### 8.4 常见错误码
- `503 Service Unavailable`: 后端服务未启动
- `500 Internal Server Error`: 检查数据库/Redis连接
- `401 Unauthorized`: OAuth认证配置问题

## 9. 监控指标

### 9.1 关键指标监控
- **应用指标**: `/actuator/metrics`
- **JVM内存**: `jvm.memory.used`
- **数据库连接池**: `hikaricp.connections.active`
- **Redis连接**: `lettuce.command.completion`
- **HTTP请求**: `http.server.requests`

### 9.2 告警阈值建议
- JVM堆内存使用率 > 80%
- 数据库连接池使用率 > 80%
- HTTP 5xx错误率 > 5%
- 接口响应时间 > 2000ms

## 10. 备份和恢复

### 10.1 数据库备份
```bash
# 备份数据库
pg_dump -h postgres-server -U binary_option_user binary_option > backup_$(date +%Y%m%d_%H%M%S).sql

# 恢复数据库
psql -h postgres-server -U binary_option_user binary_option < backup_20250910_120000.sql
```

### 10.2 Redis数据备份
Redis集群会自动进行数据持久化，确保配置了AOF和RDB。

---

## 部署检查清单

- [ ] PostgreSQL数据库服务正常运行
- [ ] Redis集群6个节点正常运行
- [ ] 所有配置文件已创建并配置正确
- [ ] 环境变量已设置
- [ ] 数据库初始化脚本已执行
- [ ] 所有服务的JAR包已构建
- [ ] 日志目录已创建并有写权限
- [ ] Nginx配置已更新
- [ ] 健康检查接口正常响应
- [ ] 测试用例验证功能正常

**部署完成后，建议运行完整的业务流程测试以验证系统功能正常。**