# Binary Option Platform - Staging 环境部署文档

## 概述

本文档详细描述了 Binary Option Platform 在 Staging 环境的部署流程。Staging 环境采用 Docker Compose + Nginx 负载均衡的架构，每个服务运行单实例，适合测试和预发布验证。

## 架构设计

### 服务架构图
```
Internet
    ↓
Nginx (80/443)
    ↓
┌─────────────────────────────────────┐
│              Docker Network        │
│                                     │
│  ┌─────────────┐  ┌───────────────┐ │
│  │   Gateway   │  │ Common Service│ │
│  │   (8080)    │  │   (8080)      │ │
│  └─────────────┘  └───────────────┘ │
│                                     │
│  ┌─────────────┐  ┌───────────────┐ │
│  │Order Service│  │Market Service │ │
│  │   (8080)    │  │   (8080)      │ │
│  └─────────────┘  └───────────────┘ │
│                                     │
│  ┌─────────────┐                    │
│  │    Redis    │                    │
│  │   (6379)    │                    │
│  └─────────────┘                    │
└─────────────────────────────────────┘
         ↓
   PostgreSQL
 (Host Machine)
```

### 服务职责

| 服务 | 职责 | 端口 | 健康检查 |
|------|------|------|----------|
| **Nginx** | 负载均衡、SSL终止、静态资源 | 80, 443 | `/health` |
| **Gateway** | API网关、路由、认证 | 8080 | `/actuator/health` |
| **Common Service** | 用户管理、账户、BTSE集成 | 8080 | `/actuator/health` |
| **Order Service** | 订单处理、交易轮次 | 8080 | `/actuator/health` |
| **Market Service** | 行情数据、WebSocket | 8080 | `/actuator/health` |
| **Redis** | 缓存、会话存储 | 6379 | `PING` |

## 部署前准备

### 1. 系统要求

**硬件要求：**
- CPU: 4 核心以上
- 内存: 8GB 以上
- 存储: 50GB 可用空间

**软件要求：**
- Docker Engine 20.10+
- Docker Compose 1.29+
- Git
- curl (用于健康检查)

### 2. 外部依赖

**宿主机服务：**
- **PostgreSQL 数据库** (宿主机，通过 host.docker.internal 访问)

**可选外部服务：**
- **BTSE API** (可选，支持Mock模式)

**内置容器服务：**
- **Redis 单机版** (Docker容器内置)

### 3. 网络配置

确保服务器可以访问：
- 宿主机PostgreSQL数据库 (localhost:5432)
- Docker Hub (拉取镜像)
- BTSE API (如果启用)

**重要说明：**
- 容器使用 `host.docker.internal` 访问宿主机服务
- 在 Linux 系统上可能需要使用 `host.docker.internal` 或 `172.17.0.1`
- macOS/Windows Docker Desktop 自动支持 `host.docker.internal`

## 部署配置

### 1. 项目结构
```
BinaryOption/
├── docker-compose.staging.yml     # Docker编排文件
├── .env.staging                    # 环境变量配置
├── nginx/                          # Nginx配置
│   ├── Dockerfile
│   ├── nginx.conf
│   └── conf.d/
│       ├── upstream.conf
│       └── default.conf
├── deploy/
│   └── deploy-staging.sh          # 部署脚本
└── [服务目录]/
    └── Dockerfile                 # 各服务Dockerfile
```

### 2. 环境变量配置

创建 `.env.staging` 文件：
```bash
# Database Configuration (Host PostgreSQL)
DB_HOST=host.docker.internal
DB_PORT=5432
DB_NAME=binaryoption
DB_USER=binaryoption
DB_PASSWORD=your_secure_password_here

# Redis Configuration (Single Instance in Docker)
REDIS_PASSWORD=your_redis_password_here

# BTSE Configuration
BTSE_API_KEY=your_btse_api_key
BTSE_API_SECRET=your_btse_api_secret
BTSE_API_URL=https://testnet.btse.com
BTSE_WS_URL=wss://testws.btse.com
BTSE_MOCK_ENABLED=false

# Market Configuration
MARKET_MOCK_ENABLED=true

# Docker Image Version
VERSION=latest
```

### 3. Spring Profile 配置

Staging 环境使用 `application-staging.yml` 配置：

**关键配置特点：**
- 使用宿主机 PostgreSQL 数据库 (host.docker.internal)
- 使用内置 Redis 单机实例
- 禁用 Nacos 服务发现
- 启用生产级日志
- 禁用 Swagger UI
- 配置连接池优化

## 部署流程

### 方式一：使用部署脚本（推荐）

```bash
# 1. 确保部署脚本可执行
chmod +x deploy/deploy-staging.sh

# 2. 执行部署
./deploy/deploy-staging.sh
```

**部署脚本功能：**
- 自动检查环境变量文件
- 拉取最新镜像
- 按依赖顺序启动服务
- 执行健康检查
- 显示部署结果

### 方式二：手动部署

```bash
# 1. 拉取最新镜像
docker-compose -f docker-compose.staging.yml pull

# 2. 停止现有服务
docker-compose -f docker-compose.staging.yml down

# 3. 按顺序启动服务
docker-compose -f docker-compose.staging.yml up -d redis
sleep 5

docker-compose -f docker-compose.staging.yml up -d option-common-service
sleep 10

docker-compose -f docker-compose.staging.yml up -d option-market-service
sleep 10

docker-compose -f docker-compose.staging.yml up -d option-order-service
sleep 10

docker-compose -f docker-compose.staging.yml up -d option-gateway
sleep 10

docker-compose -f docker-compose.staging.yml up -d nginx
```

## 服务健康检查

### 1. 自动健康检查

每个服务都配置了健康检查：
```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
  interval: 30s
  timeout: 3s
  retries: 3
```

### 2. 手动健康检查

```bash
# 检查所有服务状态
docker-compose -f docker-compose.staging.yml ps

# 检查特定服务健康状态
curl -f http://localhost/health                    # Nginx
curl -f http://localhost/actuator/health           # 通过Gateway
docker exec option-common-service curl -f http://localhost:8080/actuator/health

# 检查服务日志
docker-compose -f docker-compose.staging.yml logs -f [service-name]
```

### 3. 健康检查端点

| 服务 | 健康检查URL | 预期响应 |
|------|-------------|----------|
| Nginx | `http://localhost/health` | `healthy` |
| Gateway | `http://localhost/actuator/health` | `{"status":"UP"}` |
| Common | `http://gateway/api/common/actuator/health` | `{"status":"UP"}` |
| Order | `http://gateway/api/order/actuator/health` | `{"status":"UP"}` |
| Market | `http://gateway/api/market/actuator/health` | `{"status":"UP"}` |
| Redis | `redis-cli -h localhost -p 6379 -a password PING` | `PONG` |

## 网络配置

### 1. Docker 网络

使用自定义桥接网络：
```yaml
networks:
  binaryoption-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 2. 服务间通信

**内部通信（容器间）：**
- `http://option-common-service:8080`
- `http://option-order-service:8080`
- `http://option-market-service:8080`
- `http://option-gateway:8080`
- `redis:6379`

**外部访问（通过Nginx）：**
- Gateway: `http://localhost/`
- API: `http://localhost/api/{service}/*`
- WebSocket: `ws://localhost/ws/market`

### 3. Nginx 路由配置

```nginx
# 主要路由
location / {
    proxy_pass http://option-gateway;
}

# WebSocket路由
location /ws/ {
    proxy_pass http://option-market-ws;
    # WebSocket升级头
}

# 直接服务访问
location /api/common/ {
    proxy_pass http://option-common-service/;
}
```

## 监控和日志

### 1. 容器日志

```bash
# 查看所有服务日志
docker-compose -f docker-compose.staging.yml logs -f

# 查看特定服务日志
docker-compose -f docker-compose.staging.yml logs -f option-gateway

# 查看最近日志
docker-compose -f docker-compose.staging.yml logs --tail=100 option-common-service
```

### 2. Nginx 访问日志

```bash
# 实时查看访问日志
docker exec nginx-internal tail -f /var/log/nginx/access.log

# 查看错误日志
docker exec nginx-internal tail -f /var/log/nginx/error.log
```

### 3. 应用监控端点

**Spring Boot Actuator 端点：**
- `/actuator/health` - 健康状态
- `/actuator/info` - 应用信息
- `/actuator/metrics` - 指标数据

## 故障排查

### 1. 常见问题

**服务启动失败：**
```bash
# 检查容器状态
docker-compose -f docker-compose.staging.yml ps

# 查看详细错误
docker-compose -f docker-compose.staging.yml logs [service-name]

# 检查环境变量
docker exec [container-name] env | grep -E "(DB_|REDIS_|BTSE_)"
```

**数据库连接失败：**
```bash
# 测试数据库连接
docker exec option-common-service pg_isready -h ${DB_HOST} -p ${DB_PORT}

# 检查网络连通性 (host.docker.internal)
docker exec option-common-service ping host.docker.internal

# 测试PostgreSQL连接
docker exec option-common-service nc -z host.docker.internal 5432
```

**Redis 连接失败：**
```bash
# 测试Redis连接
docker exec redis redis-cli -a ${REDIS_PASSWORD} ping

# 从应用容器测试Redis连接
docker exec option-common-service redis-cli -h redis -p 6379 -a ${REDIS_PASSWORD} ping
```

### 2. 性能问题

**内存使用过高：**
```bash
# 查看容器资源使用
docker stats

# 检查JVM堆使用
docker exec [service] jstat -gc 1
```

**响应时间慢：**
```bash
# 检查Nginx访问日志中的响应时间
docker exec nginx-internal grep "rt=" /var/log/nginx/access.log | tail -10
```

### 3. 网络问题

**服务间通信失败：**
```bash
# 测试容器间网络
docker exec option-gateway ping option-common-service

# 检查端口可访问性
docker exec option-gateway nc -z option-common-service 8080
```

## 安全配置

### 1. 网络安全

- 所有服务运行在内部Docker网络中
- 只有Nginx暴露到外部网络
- 敏感端点（actuator）通过Nginx访问控制

### 2. 配置安全

- 敏感信息通过环境变量传递
- 数据库密码、API密钥不写入配置文件
- 使用强密码和随机生成的密钥

### 3. 访问控制

```nginx
# 限制Actuator端点访问
location ~ ^/actuator/(.*)$ {
    deny all;
    return 404;
}

# API速率限制
limit_req zone=api_limit burst=200 nodelay;
```

## 备份和恢复

### 1. 配置备份

```bash
# 备份配置文件
tar -czf config-backup-$(date +%Y%m%d).tar.gz \
    .env.staging \
    docker-compose.staging.yml \
    nginx/
```

### 2. 容器镜像管理

```bash
# 保存镜像到本地
docker save -o staging-images-$(date +%Y%m%d).tar \
    binaryoption/option-gateway:latest \
    binaryoption/option-common-service:latest \
    binaryoption/option-order-service:latest \
    binaryoption/option-market-service:latest \
    binaryoption/nginx:latest

# 加载镜像
docker load -i staging-images-20250820.tar
```

## 升级流程

### 1. 滚动升级

```bash
# 更新镜像版本
export VERSION=v2.0.1

# 逐个服务更新
docker-compose -f docker-compose.staging.yml up -d --no-deps option-common-service
# 等待健康检查通过...
docker-compose -f docker-compose.staging.yml up -d --no-deps option-market-service
# 等待健康检查通过...
# 继续其他服务...
```

### 2. 版本回滚

```bash
# 回滚到指定版本
export VERSION=v1.9.8
docker-compose -f docker-compose.staging.yml up -d
```

## 维护操作

### 1. 定期维护

**每日检查：**
```bash
# 检查服务状态
docker-compose -f docker-compose.staging.yml ps

# 检查磁盘使用
df -h

# 检查日志大小
docker system df
```

**每周维护：**
```bash
# 清理无用镜像和容器
docker system prune -f

# 重启服务（如有必要）
docker-compose -f docker-compose.staging.yml restart
```

### 2. 服务重启

```bash
# 重启单个服务
docker-compose -f docker-compose.staging.yml restart option-gateway

# 重启所有服务
docker-compose -f docker-compose.staging.yml restart

# 完全重新部署
./deploy/deploy-staging.sh
```

## 附录

### 1. 端口映射表

| 服务 | 容器端口 | 宿主机端口 | 用途 |
|------|----------|------------|------|
| Nginx | 80 | 80 | HTTP访问 |
| Nginx | 443 | 443 | HTTPS访问 |
| Gateway | 8080 | - | 内部API |
| Common | 8080 | - | 内部API |
| Order | 8080 | - | 内部API |
| Market | 8080 | - | 内部API |
| Redis | 6379 | 6379 | Redis访问 |

### 2. 环境变量参考

完整的环境变量列表请参考 `.env.staging` 模板文件。

### 3. 性能调优参数

**JVM调优（已在Dockerfile中配置）：**
```
JAVA_OPTS="-Xmx512m -Xms256m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
```

**Nginx调优：**
```nginx
worker_processes auto;
worker_connections 2048;
keepalive_timeout 65;
```

---

## 联系信息

- **维护团队**: Binary Option 开发团队
- **文档版本**: v1.0
- **最后更新**: 2025-08-20