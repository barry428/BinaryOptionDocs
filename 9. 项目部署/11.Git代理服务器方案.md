# Git代理服务器方案

## 业务场景
本地开发环境无法直接访问远端GitLab，通过中转服务器搭建代理服务，实现透明访问。

## 架构对比

### 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **代理服务器** | 配置简单、透明访问、实时同步 | 依赖代理在线 | 中转服务器稳定可用 |
| **镜像仓库** | 离线可用、数据备份 | 配置复杂、需要同步 | 需要本地备份或离线工作 |

### 架构图

```
本地 --Git请求--> 代理服务器 --转发--> GitLab
                  (Proxy)
```

## 代理方案选择

### 方案一：SSH隧道（推荐 - 最简单）

**优点**：
- 无需安装额外软件
- 配置简单，一条命令搞定
- 加密传输，安全可靠

**缺点**：
- 需要保持SSH连接
- 仅支持SSH协议的Git操作

**适用**：使用SSH方式访问Git（git@gitlab.com:...）

### 方案二：SOCKS5代理

**优点**：
- 支持多种协议（SSH、HTTPS）
- 灵活性强
- 可以代理其他应用

**缺点**：
- 需要配置代理软件

**适用**：需要同时支持SSH和HTTPS的Git操作

### 方案三：HTTP/HTTPS代理（Squid）

**优点**：
- 标准HTTP代理协议
- 支持缓存加速
- 可以做访问控制

**缺点**：
- 仅支持HTTPS协议的Git
- 配置相对复杂

**适用**：使用HTTPS方式访问Git（https://gitlab.com/...）

### 方案四：VPN隧道（WireGuard）

**优点**：
- 全流量代理
- 性能最好
- 支持所有协议

**缺点**：
- 配置最复杂
- 需要较高权限

**适用**：需要完整网络访问，不仅限于Git

## 详细实施方案

### 方案一：SSH隧道（推荐）

#### 1. 服务器端配置

```bash
# 确保SSH服务运行
sudo systemctl status sshd

# 允许SSH端口转发（编辑 /etc/ssh/sshd_config）
sudo vi /etc/ssh/sshd_config

# 确保以下配置启用：
# AllowTcpForwarding yes
# GatewayPorts yes  # 如果需要监听非本地地址

# 重启SSH服务
sudo systemctl restart sshd
```

#### 2. 本地配置

```bash
# 方式A：动态端口转发（SOCKS5代理）
ssh -D 1080 -C -N user@your-proxy-server

# 参数说明：
# -D 1080: 在本地1080端口创建SOCKS5代理
# -C: 压缩数据
# -N: 不执行远程命令
# -f: 后台运行（可选）

# 配置Git使用SOCKS5代理
git config --global http.proxy 'socks5://127.0.0.1:1080'
git config --global https.proxy 'socks5://127.0.0.1:1080'

# 配置SSH使用代理（编辑 ~/.ssh/config）
cat >> ~/.ssh/config << 'EOF'
Host gitlab.your-company.com
    ProxyCommand nc -X 5 -x 127.0.0.1:1080 %h %p
    # 或使用 socat（如果有的话）
    # ProxyCommand socat - PROXY:127.0.0.1:%h:%p,proxyport=1080
EOF
```

```bash
# 方式B：本地端口转发（针对特定GitLab服务器）
# 假设GitLab SSH端口是22
ssh -L 2222:gitlab.your-company.com:22 user@your-proxy-server -N -f

# 配置Git使用本地端口（编辑 ~/.ssh/config）
cat >> ~/.ssh/config << 'EOF'
Host gitlab-proxy
    HostName 127.0.0.1
    Port 2222
    User git
EOF

# 使用方式
git clone gitlab-proxy:your-group/your-project.git

# 或修改现有仓库
git remote set-url origin gitlab-proxy:your-group/your-project.git
```

#### 3. 保持SSH隧道持久运行

```bash
# 使用autossh自动重连
sudo apt install autossh

# 运行autossh
autossh -M 0 -f -N -D 1080 -C \
    -o "ServerAliveInterval 30" \
    -o "ServerAliveCountMax 3" \
    user@your-proxy-server

# 创建systemd服务（推荐）
sudo vi /etc/systemd/system/git-ssh-tunnel.service
```

**Systemd服务配置**：

```ini
[Unit]
Description=SSH Tunnel for Git Proxy
After=network.target

[Service]
Type=simple
User=your-username
ExecStart=/usr/bin/ssh -D 1080 -C -N -o ServerAliveInterval=30 -o ServerAliveCountMax=3 user@your-proxy-server
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# 启用并启动服务
sudo systemctl daemon-reload
sudo systemctl enable git-ssh-tunnel
sudo systemctl start git-ssh-tunnel

# 查看状态
sudo systemctl status git-ssh-tunnel
```

### 方案二：SOCKS5代理（Dante Server）

#### 1. 服务器端安装Dante

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install dante-server

# CentOS/RHEL
sudo yum install dante-server
```

#### 2. 配置Dante

```bash
# 编辑配置文件
sudo vi /etc/danted.conf

# 基本配置示例
logoutput: syslog /var/log/danted.log

# 内网接口
internal: eth0 port = 1080

# 外网接口
external: eth0

# 认证方式
clientmethod: none
# 或使用用户名密码认证
# clientmethod: username

# 访问规则
client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
}

socks pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    protocol: tcp udp
}
```

#### 3. 启动Dante服务

```bash
# 启动服务
sudo systemctl start danted
sudo systemctl enable danted

# 查看状态
sudo systemctl status danted

# 查看监听端口
sudo netstat -tlnp | grep 1080
```

#### 4. 本地配置

```bash
# 配置Git代理
git config --global http.proxy 'socks5://your-proxy-server:1080'
git config --global https.proxy 'socks5://your-proxy-server:1080'

# 配置SSH代理（~/.ssh/config）
Host gitlab.your-company.com
    ProxyCommand nc -X 5 -x your-proxy-server:1080 %h %p
```

### 方案三：HTTP/HTTPS代理（Squid）

#### 1. 服务器端安装Squid

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install squid

# CentOS/RHEL
sudo yum install squid
```

#### 2. 配置Squid

```bash
# 备份原配置
sudo cp /etc/squid/squid.conf /etc/squid/squid.conf.backup

# 编辑配置
sudo vi /etc/squid/squid.conf

# 基本配置
http_port 3128

# 访问控制
acl localnet src 0.0.0.0/0
http_access allow localnet
http_access deny all

# SSL支持（用于HTTPS的Git）
https_port 3129 cert=/etc/squid/ssl/squid.pem

# 缓存设置（可选）
cache_dir ufs /var/spool/squid 1000 16 256
maximum_object_size 100 MB
```

#### 3. 生成SSL证书（用于HTTPS）

```bash
# 创建SSL目录
sudo mkdir -p /etc/squid/ssl

# 生成自签名证书
sudo openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
    -keyout /etc/squid/ssl/squid.pem \
    -out /etc/squid/ssl/squid.pem

# 设置权限
sudo chown -R proxy:proxy /etc/squid/ssl
sudo chmod 400 /etc/squid/ssl/squid.pem
```

#### 4. 启动Squid

```bash
# 初始化缓存目录
sudo squid -z

# 启动服务
sudo systemctl start squid
sudo systemctl enable squid

# 查看状态
sudo systemctl status squid
```

#### 5. 本地配置

```bash
# 配置Git使用HTTP代理
git config --global http.proxy 'http://your-proxy-server:3128'
git config --global https.proxy 'http://your-proxy-server:3128'

# 或使用环境变量
export http_proxy="http://your-proxy-server:3128"
export https_proxy="http://your-proxy-server:3128"
```

### 方案四：WireGuard VPN（最完整）

#### 1. 服务器端安装WireGuard

```bash
# Ubuntu 20.04+
sudo apt update
sudo apt install wireguard

# CentOS 8+
sudo yum install elrepo-release epel-release
sudo yum install kmod-wireguard wireguard-tools
```

#### 2. 生成密钥

```bash
# 生成服务器密钥
wg genkey | sudo tee /etc/wireguard/server_private.key
sudo chmod 600 /etc/wireguard/server_private.key
sudo cat /etc/wireguard/server_private.key | wg pubkey | sudo tee /etc/wireguard/server_public.key

# 生成客户端密钥
wg genkey | sudo tee /etc/wireguard/client_private.key
sudo chmod 600 /etc/wireguard/client_private.key
sudo cat /etc/wireguard/client_private.key | wg pubkey | sudo tee /etc/wireguard/client_public.key
```

#### 3. 配置服务器

```bash
sudo vi /etc/wireguard/wg0.conf

# 服务器配置
[Interface]
Address = 10.0.0.1/24
ListenPort = 51820
PrivateKey = <SERVER_PRIVATE_KEY>
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

[Peer]
PublicKey = <CLIENT_PUBLIC_KEY>
AllowedIPs = 10.0.0.2/32
```

#### 4. 启用IP转发

```bash
# 启用IP转发
sudo sysctl -w net.ipv4.ip_forward=1
sudo sysctl -w net.ipv6.conf.all.forwarding=1

# 永久启用
echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
echo "net.ipv6.conf.all.forwarding=1" | sudo tee -a /etc/sysctl.conf
```

#### 5. 启动WireGuard

```bash
sudo systemctl start wg-quick@wg0
sudo systemctl enable wg-quick@wg0

# 查看状态
sudo wg show
```

#### 6. 客户端配置（macOS）

```bash
# 安装WireGuard
brew install wireguard-tools

# 创建客户端配置
sudo vi /etc/wireguard/wg0.conf

[Interface]
PrivateKey = <CLIENT_PRIVATE_KEY>
Address = 10.0.0.2/24
DNS = 8.8.8.8

[Peer]
PublicKey = <SERVER_PUBLIC_KEY>
Endpoint = your-proxy-server:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25

# 启动VPN
sudo wg-quick up wg0

# 关闭VPN
sudo wg-quick down wg0
```

## 快速选择指南

### 场景一：临时使用，快速测试
**推荐**：SSH隧道（方式A）
```bash
ssh -D 1080 -N user@proxy-server
git config --global http.proxy 'socks5://127.0.0.1:1080'
```

### 场景二：长期使用，稳定可靠
**推荐**：SSH隧道 + systemd服务
- 参考方案一的systemd配置

### 场景三：需要代理多种服务
**推荐**：SOCKS5代理（Dante）或WireGuard VPN

### 场景四：仅需HTTPS方式的Git
**推荐**：HTTP代理（Squid）

## 性能对比

| 方案 | 速度 | 资源占用 | 稳定性 | 配置难度 |
|------|------|----------|--------|----------|
| SSH隧道 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| SOCKS5 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| HTTP代理 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| WireGuard | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |

## 故障排查

### 1. 测试代理连通性

```bash
# 测试SOCKS5代理
curl --socks5 127.0.0.1:1080 https://www.google.com

# 测试HTTP代理
curl -x http://proxy-server:3128 https://www.google.com

# 测试Git操作
GIT_TRACE=1 GIT_CURL_VERBOSE=1 git ls-remote https://gitlab.com/test/repo.git
```

### 2. 查看代理日志

```bash
# SSH隧道
ssh -v -D 1080 -N user@proxy-server

# Dante
sudo tail -f /var/log/danted.log

# Squid
sudo tail -f /var/log/squid/access.log
sudo tail -f /var/log/squid/cache.log

# WireGuard
sudo wg show
sudo journalctl -u wg-quick@wg0 -f
```

### 3. 取消代理配置

```bash
# 取消Git代理
git config --global --unset http.proxy
git config --global --unset https.proxy

# 或临时禁用
git config --global http.proxy ""
git config --global https.proxy ""
```

## 安全建议

1. **认证加密**
   - 使用SSH密钥认证
   - 启用SOCKS5用户名密码认证
   - 配置防火墙限制访问来源

2. **访问控制**
   - 仅允许特定IP访问代理
   - 限制可访问的目标地址
   - 定期审查访问日志

3. **监控告警**
   - 监控代理服务状态
   - 记录异常访问行为
   - 设置流量告警

## 成本对比

| 方案 | 服务器要求 | 带宽消耗 | 维护成本 |
|------|-----------|----------|----------|
| SSH隧道 | 低 | 低 | 极低 |
| SOCKS5 | 低 | 低 | 低 |
| HTTP代理 | 中 | 中 | 中 |
| WireGuard | 中 | 高 | 中 |

## 最佳实践

1. **开发环境**：使用SSH隧道，简单快速
2. **生产环境**：使用WireGuard VPN，安全稳定
3. **团队协作**：使用SOCKS5代理，易于管理
4. **临时访问**：使用SSH本地端口转发

## 参考资料

- [SSH隧道端口转发](https://www.ssh.com/academy/ssh/tunneling/example)
- [Dante SOCKS服务器](https://www.inet.no/dante/)
- [Squid代理服务器](http://www.squid-cache.org/)
- [WireGuard官方文档](https://www.wireguard.com/)

## 最后更新
2025-11-19：初始版本创建
