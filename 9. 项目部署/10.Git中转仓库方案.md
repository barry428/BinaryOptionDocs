# Git中转仓库方案

## 业务场景
本地开发环境无法直接访问远端GitLab，需要通过中转服务器进行代码的拉取和推送。

## 架构设计

```
本地开发环境 <--SSH--> 中转服务器 <--SSH--> 远端GitLab
   (Local)            (Mirror)           (Origin)
```

## 方案选择

### 方案一：Git Hook自动同步（推荐）
使用Git的post-receive hook实现自动同步到远端。

**优点**：
- 配置简单，维护成本低
- 实时同步，无延迟
- 无需额外服务或定时任务

**缺点**：
- 推送时间稍长（需要等待同步完成）
- 远端不可用时推送会失败

### 方案二：定时任务同步
使用cron定时任务定期同步到远端。

**优点**：
- 推送速度快（本地到中转）
- 远端短暂不可用不影响本地推送

**缺点**：
- 存在同步延迟
- 需要配置定时任务
- 可能存在冲突需要处理

## 实施方案（方案一：Git Hook）

### 1. 中转服务器环境准备

```bash
# 安装Git
sudo apt update
sudo apt install git -y

# 创建Git用户（可选，建议使用专用用户）
sudo useradd -m -s /bin/bash git
sudo passwd git

# 切换到git用户
sudo su - git
```

### 2. 创建中转仓库

```bash
# 创建仓库目录
mkdir -p ~/repositories
cd ~/repositories

# 创建bare仓库（裸仓库，不包含工作目录）
git init --bare BinaryOption.git
cd BinaryOption.git

# 配置远端GitLab地址
git remote add origin git@your-gitlab-server:your-group/BinaryOption.git

# 或使用HTTPS方式
git remote add origin https://your-gitlab-server/your-group/BinaryOption.git
```

### 3. 配置SSH密钥（中转服务器到GitLab）

```bash
# 在中转服务器生成SSH密钥
ssh-keygen -t ed25519 -C "git-mirror@your-server"

# 查看公钥
cat ~/.ssh/id_ed25519.pub

# 将公钥添加到GitLab
# 1. 登录GitLab
# 2. 进入 Settings -> SSH Keys
# 3. 粘贴公钥内容并保存

# 测试连接
ssh -T git@your-gitlab-server
```

### 4. 配置Git Hook自动同步

```bash
cd ~/repositories/BinaryOption.git/hooks

# 创建post-receive hook
cat > post-receive << 'EOF'
#!/bin/bash

# Git Hook: 自动同步到远端GitLab

echo "========================================"
echo "Starting sync to remote GitLab..."
echo "========================================"

# 推送所有分支到远端
git push --mirror origin

if [ $? -eq 0 ]; then
    echo "✓ Successfully synced to remote GitLab"
else
    echo "✗ Failed to sync to remote GitLab"
    exit 1
fi

echo "========================================"
echo "Sync completed"
echo "========================================"
EOF

# 设置执行权限
chmod +x post-receive
```

### 5. 初始化仓库数据（首次同步）

```bash
# 从远端GitLab拉取所有数据
cd ~/repositories/BinaryOption.git
git fetch origin --prune

# 更新所有本地分支引用
git for-each-ref --format='%(refname:short)' refs/heads/ | \
  xargs -I {} git update-ref refs/heads/{} origin/{}

# 或者直接克隆镜像
cd ~/repositories
rm -rf BinaryOption.git
git clone --mirror git@your-gitlab-server:your-group/BinaryOption.git
cd BinaryOption.git
git remote add origin git@your-gitlab-server:your-group/BinaryOption.git
```

### 6. 本地开发环境配置

```bash
# 方式一：修改现有仓库的remote
cd /Users/barry.wang/Documents/BinaryOption

# 备份原有remote配置
git remote -v > .git/remote-backup.txt

# 重命名原有remote为gitlab（保留引用）
git remote rename origin gitlab

# 添加中转服务器为新的origin
git remote add origin git@your-mirror-server:repositories/BinaryOption.git

# 设置默认推送到中转服务器
git config branch.main.remote origin

# 验证配置
git remote -v
# 输出示例：
# origin    git@your-mirror-server:repositories/BinaryOption.git (fetch)
# origin    git@your-mirror-server:repositories/BinaryOption.git (push)
# gitlab    git@your-gitlab-server:your-group/BinaryOption.git (fetch)
# gitlab    git@your-gitlab-server:your-group/BinaryOption.git (push)

# 方式二：重新克隆（如果方式一有问题）
cd /Users/barry.wang/Documents
mv BinaryOption BinaryOption.backup
git clone git@your-mirror-server:repositories/BinaryOption.git
cd BinaryOption
git remote add gitlab git@your-gitlab-server:your-group/BinaryOption.git
```

### 7. 配置SSH密钥（本地到中转服务器）

```bash
# 在本地生成SSH密钥（如果还没有）
ssh-keygen -t ed25519 -C "barry.wang@local"

# 查看公钥
cat ~/.ssh/id_ed25519.pub

# 将公钥添加到中转服务器
# 方式一：使用ssh-copy-id
ssh-copy-id git@your-mirror-server

# 方式二：手动添加
# 登录到中转服务器，编辑 ~/.ssh/authorized_keys
# 将本地公钥内容粘贴进去

# 测试连接
ssh git@your-mirror-server
```

### 8. 日常使用流程

```bash
# 拉取代码（从中转服务器）
git pull origin main

# 推送代码（到中转服务器，自动同步到GitLab）
git push origin main

# 查看远端GitLab状态（可选）
git fetch gitlab
git log gitlab/main

# 紧急情况直接推送到GitLab（如果中转服务器故障）
git push gitlab main
```

## 高级配置

### 1. 双向同步（可选）

如果需要从GitLab同步更新到中转服务器，可以使用定时任务：

```bash
# 在中转服务器创建同步脚本
cat > ~/sync-from-gitlab.sh << 'EOF'
#!/bin/bash

REPO_PATH=~/repositories/BinaryOption.git

cd $REPO_PATH

echo "[$(date)] Starting sync from GitLab..."

# 从GitLab拉取更新
git fetch origin --prune

if [ $? -eq 0 ]; then
    echo "[$(date)] Successfully synced from GitLab"
else
    echo "[$(date)] Failed to sync from GitLab"
fi
EOF

chmod +x ~/sync-from-gitlab.sh

# 添加到crontab（每5分钟同步一次）
crontab -e
# 添加以下内容：
# */5 * * * * ~/sync-from-gitlab.sh >> ~/sync-from-gitlab.log 2>&1
```

### 2. 同步状态监控

```bash
# 创建监控脚本
cat > ~/check-sync-status.sh << 'EOF'
#!/bin/bash

REPO_PATH=~/repositories/BinaryOption.git

cd $REPO_PATH

echo "========================================"
echo "Git Mirror Sync Status"
echo "========================================"
echo ""

# 检查本地和远端的差异
echo "Checking differences between mirror and origin..."
git fetch origin --prune > /dev/null 2>&1

# 比较所有分支
for branch in $(git for-each-ref --format='%(refname:short)' refs/heads/); do
    local_commit=$(git rev-parse $branch 2>/dev/null)
    remote_commit=$(git rev-parse origin/$branch 2>/dev/null)

    if [ "$local_commit" = "$remote_commit" ]; then
        echo "✓ $branch: Synced"
    else
        echo "✗ $branch: Out of sync"
        echo "  Local:  $local_commit"
        echo "  Remote: $remote_commit"
    fi
done

echo ""
echo "========================================"
EOF

chmod +x ~/check-sync-status.sh

# 运行检查
~/check-sync-status.sh
```

### 3. 配置多分支保护

```bash
# 编辑post-receive hook，添加分支保护
cat > ~/repositories/BinaryOption.git/hooks/post-receive << 'EOF'
#!/bin/bash

echo "========================================"
echo "Starting sync to remote GitLab..."
echo "========================================"

# 只同步特定分支（可选）
# BRANCHES="main develop feature/*"
# for branch in $BRANCHES; do
#     git push origin $branch
# done

# 或推送所有分支
git push --mirror origin

if [ $? -eq 0 ]; then
    echo "✓ Successfully synced to remote GitLab"

    # 发送通知（可选）
    # curl -X POST https://your-webhook-url \
    #   -H "Content-Type: application/json" \
    #   -d '{"text":"Git sync completed"}'
else
    echo "✗ Failed to sync to remote GitLab"

    # 发送告警（可选）
    # curl -X POST https://your-webhook-url \
    #   -H "Content-Type: application/json" \
    #   -d '{"text":"Git sync failed! Please check."}'

    exit 1
fi

echo "========================================"
echo "Sync completed"
echo "========================================"
EOF

chmod +x ~/repositories/BinaryOption.git/hooks/post-receive
```

## 故障处理

### 1. 同步失败处理

```bash
# 查看最近的推送日志
cd ~/repositories/BinaryOption.git
git log --reflog

# 手动同步到远端
git push --mirror origin

# 如果有冲突，强制同步（谨慎使用）
git push --mirror --force origin
```

### 2. 中转服务器故障

```bash
# 本地临时直接推送到GitLab
git push gitlab main

# 中转服务器恢复后，同步数据
# 在中转服务器执行：
cd ~/repositories/BinaryOption.git
git fetch origin --prune
git push --mirror origin
```

### 3. 数据不一致修复

```bash
# 在中转服务器执行完全同步
cd ~/repositories/BinaryOption.git

# 备份当前数据
cd ..
tar -czf BinaryOption.git.backup.$(date +%Y%m%d_%H%M%S).tar.gz BinaryOption.git

# 从GitLab完全重新同步
rm -rf BinaryOption.git
git clone --mirror git@your-gitlab-server:your-group/BinaryOption.git
cd BinaryOption.git

# 重新配置hook
cd hooks
# ... 重新创建post-receive hook（参考步骤4）
```

## 安全建议

1. **SSH密钥管理**
   - 使用专用的SSH密钥对
   - 定期轮换密钥
   - 限制密钥权限（chmod 600 ~/.ssh/id_ed25519）

2. **仓库权限控制**
   - 使用专用git用户
   - 限制文件系统权限（chmod 700 ~/repositories）
   - 配置防火墙规则

3. **监控和日志**
   - 配置同步日志
   - 设置告警通知
   - 定期检查同步状态

## 性能优化

1. **网络优化**
   ```bash
   # 启用Git协议压缩
   git config --global core.compression 9

   # 增大网络缓冲区
   git config --global http.postBuffer 524288000
   ```

2. **仓库优化**
   ```bash
   # 定期清理和优化仓库
   cd ~/repositories/BinaryOption.git
   git gc --aggressive --prune=now
   ```

## 维护检查清单

- [ ] 每周检查同步状态
- [ ] 每月检查磁盘空间
- [ ] 每月验证备份可用性
- [ ] 每季度更新系统和Git版本
- [ ] 每半年审查访问权限

## 常见问题

**Q: 推送速度很慢怎么办？**
A: 检查网络带宽和Git配置，可以启用压缩和增大缓冲区。

**Q: 如何处理大文件？**
A: 考虑使用Git LFS（Large File Storage），或者使用shallow clone减少传输量。

**Q: 多人同时推送会有问题吗？**
A: Git本身支持并发推送，但建议使用分支工作流避免冲突。

**Q: 如何备份中转仓库？**
A: 定期使用rsync或tar备份~/repositories目录。

## 参考资料

- [Git官方文档 - Git Hooks](https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks)
- [Git官方文档 - Git on the Server](https://git-scm.com/book/en/v2/Git-on-the-Server-Getting-Git-on-a-Server)
- [Pro Git Book - Distributed Git](https://git-scm.com/book/en/v2/Distributed-Git-Distributed-Workflows)

## 最后更新
2025-11-19：初始版本创建
