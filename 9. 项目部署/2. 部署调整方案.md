# 部署调整方案

## 文档信息
- **创建时间**: 2025-08-20
- **文档版本**: v1.0
- **基于分析**: BTSE CI/CD模板适配分析
- **目标**: 明确具体修改清单，最小化变更风险

---

## 1. 方案概述

### 1.1 核心发现
✅ **项目结构已兼容**: 当前`option-parent`目录的Maven多模块结构完全符合BTSE模板要求
✅ **构建验证通过**: `mvn -f option-parent/pom.xml clean compile`执行成功
✅ **最小化修改**: 无需重构项目结构，只需调整配置

### 1.2 调整策略
- **保持现有结构**: 不移动pom.xml，保持option-parent目录结构
- **CI指向调整**: 修改`TARGET_PROJECT_FOLDER`指向`option-parent`
- **配置标准化**: 统一端口、环境配置、Docker化
- **渐进式部署**: 分阶段实施，降低风险

---

## 2. 具体修改清单

### 2.1 服务端口统一 ⭐ **必须修改**

#### 修改目标
将所有服务端口统一为8080，支持环境变量覆盖

#### 需要修改的文件
```bash
📁 需修改的配置文件 (4个)
├── option-common-service/src/main/resources/application.yml
├── option-order-service/src/main/resources/application.yml  
├── option-market-service/src/main/resources/application.yml
└── option-gateway/src/main/resources/application.yml
```

#### 具体修改内容
```yaml
# 当前配置 → 目标配置
server:
  port: 8081  # option-common-service  → port: ${SERVER_PORT:8080}
  port: 8082  # option-order-service   → port: ${SERVER_PORT:8080}
  port: 8083  # option-market-service  → port: ${SERVER_PORT:8080}
  port: 8080  # option-gateway         → port: ${SERVER_PORT:8080}
```

#### 详细修改示例
```yaml
# 所有服务统一修改为
server:
  port: ${SERVER_PORT:8080}
  
# 开发环境仍可通过环境变量区分
# export SERVER_PORT=8081  # common-service
# export SERVER_PORT=8082  # order-service
# export SERVER_PORT=8083  # market-service
# export SERVER_PORT=8080  # gateway
```

### 2.2 生产环境配置 ⭐ **必须新建**

#### 修改目标
为所有服务创建生产环境专用配置，禁用Nacos，优化PostgreSQL

#### 需要新建的文件
```bash
📁 需新建的配置文件 (4个)
├── option-common-service/src/main/resources/application-production.yml
├── option-order-service/src/main/resources/application-production.yml
├── option-market-service/src/main/resources/application-production.yml
└── option-gateway/src/main/resources/application-production.yml
```

#### 生产环境配置模板
```yaml
# application-production.yml (所有服务通用)
spring:
  # 数据库配置 - 只使用PostgreSQL
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:binaryoption}
    username: ${DB_USER:binaryoption}
    password: ${DB_PASSWORD}
    driver-class-name: org.postgresql.Driver
    
  # Redis配置 - 生产环境集群
  redis:
    cluster:
      nodes: ${REDIS_CLUSTER_NODES:127.0.0.1:7001,127.0.0.1:7002,127.0.0.1:7003}
      password: ${REDIS_PASSWORD}
      
  # 禁用Nacos服务发现
  cloud:
    nacos:
      discovery:
        enabled: false

# MyBatis配置 - PostgreSQL专用
mybatis:
  configuration:
    database-id: postgresql
    
# 生产环境安全配置
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: never

# BTSE配置 - 生产环境
btse:
  api:
    base-url: ${BTSE_API_BASE_URL:https://api.btse.com}
    auth:
      api-key: ${BTSE_API_KEY}
      api-secret: ${BTSE_API_SECRET}
  mock:
    enabled: false  # 生产环境禁用Mock

# 应用配置
server:
  port: ${SERVER_PORT:8080}
```

### 2.3 敏感信息环境变量化 ⭐ **必须修改**

#### 修改目标
移除所有硬编码的敏感信息，改为环境变量注入

#### 需要修改的文件
```bash
📁 需修改敏感信息的文件 (4个)
├── option-common-service/src/main/resources/application.yml
├── option-order-service/src/main/resources/application.yml
├── option-market-service/src/main/resources/application.yml
└── option-gateway/src/main/resources/application.yml
```

#### 具体修改内容
```yaml
# 当前硬编码配置 → 环境变量化配置

# 数据库配置
spring:
  datasource:
    username: root                    → username: ${DB_USER:root}
    password: root                    → password: ${DB_PASSWORD:root}
    
# Redis配置  
  redis:
    password: WOJdJ4HLWCQx9K3E       → password: ${REDIS_PASSWORD:WOJdJ4HLWCQx9K3E}

# BTSE配置
btse:
  api:
    auth:
      api-key: your_api_key_here      → api-key: ${BTSE_API_KEY:your_api_key_here}
      api-secret: your_api_secret_here → api-secret: ${BTSE_API_SECRET:your_api_secret_here}
```

### 2.4 Docker化支持 🔶 **高优先级推荐**

#### 修改目标
为核心4个服务创建标准化Dockerfile

#### 需要新建的文件
```bash
📁 需新建的Dockerfile (4个)
├── option-common-service/Dockerfile
├── option-order-service/Dockerfile
├── option-market-service/Dockerfile
└── option-gateway/Dockerfile
```

#### 标准Dockerfile模板
```dockerfile
# 统一Dockerfile模板 (4个服务使用相同模板)
FROM openjdk:17-slim

# 安装curl用于健康检查
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# 工作目录
WORKDIR /app

# 复制JAR文件 (使用通配符适配不同服务名)
COPY target/*.jar app.jar

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# 环境变量
ENV JAVA_OPTS="-Xmx512m -Xms256m"

# 启动命令
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar"]
```

### 2.5 CI/CD配置调整 ⭐ **必须修改**

#### 修改目标
调整GitLab CI配置，适配当前项目结构

#### 需要修改的文件
```bash
📁 CI配置调整
└── .gitlab-ci.yml (已存在，需要更新)
```

#### 关键变量调整
```yaml
# 当前 .gitlab-ci.yml 需要的关键修改
variables:
  BUILD_IMAGE: "registry.gitlab.com/nogle/btsecom/btse-backend/binary_option/binaryoption-build-image-21:latest"
  TARGET_PROJECT_FOLDER: "option-parent"  # 🔑 关键修改：指向option-parent
  APP_SERVICE_NAME: "binaryoption"
  
  # 新增变量
  DEPLOY_SERVICES: "option-common-service,option-order-service,option-market-service,option-gateway"
  SERVICE_PORT: 8080
  STARTUP_ORDER: "option-common-service,option-market-service,option-order-service,option-gateway"
```

---

## 3. 修改优先级和风险评估

### 3.1 优先级矩阵

| 修改项 | 优先级 | 复杂度 | 风险 | 预估工时 |
|--------|--------|--------|------|----------|
| 服务端口统一 | ⭐ 必须 | 低 | 低 | 1小时 |
| 生产环境配置 | ⭐ 必须 | 中 | 低 | 2小时 |
| 敏感信息环境变量化 | ⭐ 必须 | 低 | 低 | 1小时 |
| CI/CD配置调整 | ⭐ 必须 | 中 | 中 | 2小时 |
| Docker化支持 | 🔶 高推荐 | 中 | 低 | 3小时 |
| **总计** | | | | **9小时** |

### 3.2 风险分析

#### 低风险项 ✅
- **端口统一**: 仅配置修改，不影响业务逻辑
- **环境变量化**: 向后兼容，可设置默认值
- **Docker化**: 新增文件，不影响现有构建

#### 中等风险项 ⚠️
- **生产环境配置**: 新配置需要充分测试
- **CI/CD调整**: 需要验证构建和部署流程

#### 降低风险措施
1. **分步骤实施**: 每个修改后都进行验证
2. **保留原配置**: 修改时保留原有配置作为备份
3. **测试环境先行**: 在开发环境充分验证后再应用到生产

---

## 4. 详细实施步骤

### 4.1 第一阶段：基础配置调整 (3-4小时)

#### 步骤1：服务端口统一 (1小时)
```bash
# 修改4个application.yml文件
1. option-common-service/src/main/resources/application.yml
2. option-order-service/src/main/resources/application.yml
3. option-market-service/src/main/resources/application.yml
4. option-gateway/src/main/resources/application.yml

# 修改内容
server:
  port: ${SERVER_PORT:8080}
```

#### 步骤2：敏感信息环境变量化 (1小时)
```bash
# 在相同的4个文件中进行替换
- 数据库密码环境变量化
- Redis密码环境变量化
- BTSE配置环境变量化
```

#### 步骤3：创建生产环境配置 (2小时)
```bash
# 创建4个新的production配置文件
- 复制并修改现有配置
- 禁用Nacos
- 只配置PostgreSQL
- 优化安全设置
```

#### 验证步骤
```bash
# 本地验证
export SERVER_PORT=8081
cd option-parent && mvn spring-boot:run -pl option-common-service

export SERVER_PORT=8082
cd option-parent && mvn spring-boot:run -pl option-order-service

# 验证健康检查
curl http://localhost:8081/actuator/health
curl http://localhost:8082/actuator/health
```

### 4.2 第二阶段：Docker化 (3小时)

#### 步骤1：创建Dockerfile (2小时)
```bash
# 为4个服务创建相同的Dockerfile
cp standard-dockerfile option-common-service/Dockerfile
cp standard-dockerfile option-order-service/Dockerfile
cp standard-dockerfile option-market-service/Dockerfile
cp standard-dockerfile option-gateway/Dockerfile
```

#### 步骤2：验证Docker构建 (1小时)
```bash
# 逐个验证Docker构建
cd option-parent
mvn clean package -DskipTests -pl option-common-service

cd ../option-common-service
docker build -t option-common-service:test .
docker run -d -p 8081:8080 option-common-service:test
curl http://localhost:8081/actuator/health
```

### 4.3 第三阶段：CI/CD集成 (2-3小时)

#### 步骤1：更新CI配置 (1小时)
```yaml
# 更新.gitlab-ci.yml关键变量
TARGET_PROJECT_FOLDER: "option-parent"
DEPLOY_SERVICES: "option-common-service,option-order-service,option-market-service,option-gateway"
```

#### 步骤2：配置GitLab变量 (1小时)
```bash
# 在GitLab项目设置中配置环境变量
SSH_PWD, DB_PASSWORD, REDIS_PASSWORD, BTSE_API_KEY, BTSE_API_SECRET
```

#### 步骤3：测试CI流程 (1小时)
```bash
# 创建测试分支验证CI
git checkout -b ci-test
git push origin ci-test
# 观察GitLab CI执行情况
```

---

## 5. 环境变量配置清单

### 5.1 GitLab CI/CD Variables 配置

#### 必须配置的变量
```bash
# SSH连接
SSH_PWD                     # SSH连接密码 (Protected, Masked)

# 数据库配置  
DEV_DB_PASSWORD            # 开发环境数据库密码
STAGING_DB_PASSWORD        # 预发布环境数据库密码
PROD_DB_PASSWORD           # 生产环境数据库密码

# Redis配置
REDIS_PASSWORD             # Redis集群密码 (Protected, Masked)
REDIS_CLUSTER_NODES        # 生产环境Redis集群节点

# BTSE配置
BTSE_API_KEY              # BTSE API密钥 (Protected, Masked)
BTSE_API_SECRET           # BTSE API秘钥 (Protected, Masked)
BTSE_API_BASE_URL         # BTSE API地址 (生产环境)

# 安全配置
JWT_SECRET                # JWT签名密钥 (Protected, Masked)
```

#### 环境特定变量
```bash
# 开发环境
DEV_DB_HOST=10.1.29.45
DEV_DB_NAME=binaryoption
DEV_DB_USER=binaryoption

# 预发布环境
STAGING_DB_HOST_01=10.1.35.186  
STAGING_DB_HOST_02=10.1.35.187
STAGING_DB_NAME=binaryoption
STAGING_DB_USER=binaryoption

# 生产环境
PROD_DB_HOST=prod-postgres-cluster
PROD_DB_NAME=binaryoption
PROD_DB_USER=binaryoption
```

### 5.2 本地开发环境变量

#### .env.local 文件示例
```bash
# 本地开发环境变量文件 (不提交到Git)
SERVER_PORT=8081
DB_USER=root
DB_PASSWORD=root
REDIS_PASSWORD=WOJdJ4HLWCQx9K3E
BTSE_API_KEY=your_dev_api_key
BTSE_API_SECRET=your_dev_api_secret
BTSE_MOCK_ENABLED=true
```

---

## 6. 验收标准

### 6.1 配置修改验收
- [ ] 所有服务支持`SERVER_PORT`环境变量
- [ ] 生产环境配置文件创建完成
- [ ] 所有敏感信息已环境变量化
- [ ] 本地启动所有服务成功

### 6.2 Docker化验收
- [ ] 所有核心服务Docker镜像构建成功
- [ ] Docker容器启动和健康检查通过
- [ ] 容器间网络通信正常

### 6.3 CI/CD验收  
- [ ] GitLab CI构建阶段通过
- [ ] 开发环境自动部署成功
- [ ] 预发布环境手动部署成功
- [ ] 所有环境健康检查端点正常

### 6.4 功能验收
- [ ] 核心业务功能验证通过
- [ ] 数据库连接和操作正常
- [ ] Redis缓存功能正常
- [ ] 服务间RPC调用正常

---

## 7. 回滚计划

### 7.1 配置回滚
```bash
# 如果出现问题，可以快速回滚配置
git checkout HEAD~1 -- option-*/src/main/resources/application.yml
git checkout HEAD~1 -- .gitlab-ci.yml
```

### 7.2 服务回滚
```bash
# CI/CD部署失败时的回滚
- 使用GitLab环境管理的停止部署功能
- 手动回滚到上一个稳定版本
- 恢复原有端口配置临时运行
```

### 7.3 数据库回滚
```bash
# 如果数据库配置有问题
- 切换回MySQL配置 (开发环境)
- 恢复原有连接参数
- 重启服务验证
```

---

## 8. 注意事项和建议

### 8.1 关键注意事项
1. **端口冲突**: 开发环境统一端口后注意本地端口冲突
2. **服务依赖**: 修改启动顺序，确保依赖服务先启动
3. **配置备份**: 修改前备份原有配置文件
4. **环境隔离**: 不同环境使用不同的数据库和Redis

### 8.2 最佳实践建议
1. **渐进式修改**: 一次修改一个服务，验证后再修改下一个
2. **充分测试**: 每个阶段完成后进行完整的功能测试
3. **文档更新**: 及时更新README和部署文档
4. **监控告警**: 部署后密切关注服务状态和日志

### 8.3 后续优化方向
1. **配置中心**: 后续可考虑引入配置中心统一管理
2. **服务网格**: 生产环境可考虑Service Mesh架构
3. **监控完善**: 引入Prometheus + Grafana监控栈
4. **日志聚合**: 配置ELK或类似日志聚合方案

---

## 9. 确认清单

请确认以下修改方案是否合适：

### 核心修改确认
- [ ] **同意端口统一方案**: 所有服务改为8080端口，通过环境变量支持本地开发区分
- [ ] **同意配置文件方案**: 创建production profile，环境变量化敏感信息
- [ ] **同意Docker化方案**: 为核心4个服务创建标准Dockerfile
- [ ] **同意CI调整方案**: TARGET_PROJECT_FOLDER指向option-parent目录

### 实施计划确认
- [ ] **同意分阶段实施**: 基础配置 → Docker化 → CI/CD集成
- [ ] **同意工时评估**: 总计约9小时的修改工作量
- [ ] **同意风险评估**: 大部分修改为低风险，可控制影响范围

### 环境准备确认
- [ ] **确认GitLab环境**: 有权限配置CI/CD变量
- [ ] **确认服务器环境**: 目标服务器已准备就绪
- [ ] **确认回滚方案**: 理解并同意回滚计划

---

**请确认上述方案后，我们即可开始实施第一阶段的修改工作。**

---

**文档更新记录**

| 版本 | 日期 | 更新内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-08-20 | 初始版本，详细部署调整方案 | DevOps团队 |

**下次更新计划**: 根据确认结果和实施进度更新具体修改内容