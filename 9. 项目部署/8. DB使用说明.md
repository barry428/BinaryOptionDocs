# Binary Option 数据库使用说明

## 概述

本文档面向运维和开发团队，提供Binary Option平台数据库的完整使用说明，基于PostgreSQL v5真实表结构和实际Mapper.xml中的SQL操作。

## 数据库架构概览

### 基本信息
- **数据库类型**：PostgreSQL 13+
- **表命名规范**：所有业务表使用 `bo_` 前缀
- **总表数量**：15个核心业务表

### 业务架构
- **账户体系**：DEMO（演示）和REAL（真实）双账户模式
- **交易流程**：OAuth认证 → 下单 → 轮次结算 → 资金划转
- **外部集成**：BTSE交易所API集成
- **风控系统**：多维度风控统计和黑名单管理

## 数据库表总览

| 表名 | 业务作用 | 主要功能 | 数据特征 |
|------|----------|----------|----------|
| bo_user | 用户基础信息管理 | OAuth认证、用户状态管理、协议同意 | 外部ID唯一、支持状态管理 |
| bo_account | 用户账户资金管理 | DEMO/REAL双账户、余额冻结、统计汇总 | 原子操作、余额约束、支持多币种 |
| bo_account_transaction | 资金变动审计流水 | 完整资金流水、对账审计 | 高频写入、完整审计链路 |
| bo_option_order | 期权订单核心表 | 订单创建、状态流转、结算处理 | 状态机管理、支持多种结算结果 |
| bo_trading_round | 交易轮次管理 | 轮次时间控制、价格设置、投注统计 | 时间驱动、状态流转、价格锁定 |
| bo_btse_transfer_log | BTSE转账日志 | 资金转入转出、API交互记录 | 外部API集成、重试机制 |
| bo_user_round | 用户轮次统计 | 用户轮次参与汇总、转账状态管理 | 统计优化、转账链路 |
| bo_blacklist | 用户黑名单管理 | 风控封禁、时间范围控制 | 实时风控检查 |
| bo_user_risk_stats | 用户风控统计 | 多维度交易统计、风控检查 | 定时重置、行为分析 |
| bo_symbol_config | 交易对配置 | 支持的交易对管理、参数配置 | 配置驱动、启用控制 |
| bo_duration_config | 交易周期配置 | 支持的交易时长设置 | 时长管理、配置化 |
| bo_global_config | 全局系统配置 | 系统开关、参数配置 | 键值配置、分组管理 |
| bo_risk_config | 风控规则配置 | 风控参数、规则管理 | 动态配置、规则驱动 |
| bo_risk_log | 风控触发日志 | 风控事件记录、行为追踪 | 事件审计、行为分析 |
| bo_option_order_hedge | 订单对冲记录 | 风险对冲、对冲失败重试 | 一对一关系、重试机制 |

## 详细表结构和SQL操作说明

### 1. bo_user - 用户基础信息表

**业务作用**: 存储系统用户基础信息，支持OAuth外部认证集成

**完整建表语句**:
```sql
CREATE TABLE public.bo_user (
    id bigint NOT NULL,
    external_id character varying(64) NOT NULL,
    nickname character varying(64),
    status smallint DEFAULT 1 NOT NULL,
    signature character varying(128),
    risk_agreement smallint DEFAULT 0 NOT NULL,
    aml_agreement smallint DEFAULT 0 NOT NULL,
    create_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    update_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT bo_user_pkey PRIMARY KEY (id),
    CONSTRAINT uk_bo_user_external_id UNIQUE (external_id)
);
```

**实际SQL操作**:

**查询操作 (SELECT)**:
```sql
-- 根据ID查询用户 (findById)
SELECT id, external_id, nickname, status, signature, risk_agreement, aml_agreement, create_time, update_time 
FROM "bo_user" WHERE id = #{id}

-- 根据外部ID查询用户 (findByExternalId) - OAuth认证核心查询
SELECT id, external_id, nickname, status, signature, risk_agreement, aml_agreement, create_time, update_time 
FROM "bo_user" WHERE external_id = #{externalId}

-- 分页查询用户 (findAll)
SELECT id, external_id, nickname, status, signature, risk_agreement, aml_agreement, create_time, update_time 
FROM "bo_user" ORDER BY create_time DESC OFFSET #{offset} LIMIT #{limit}

-- 按状态查询用户 (findByStatus)  
SELECT id, external_id, nickname, status, signature, risk_agreement, aml_agreement, create_time, update_time 
FROM "bo_user" WHERE status = #{status} ORDER BY create_time DESC OFFSET #{offset} LIMIT #{limit}

-- 检查外部ID是否存在 (existsByExternalId)
SELECT COUNT(*) FROM "bo_user" WHERE external_id = #{externalId}

-- 用户统计 (count)
SELECT COUNT(*) FROM "bo_user"
```

**插入操作 (INSERT)**:
```sql
-- 插入新用户 (insert)
INSERT INTO "bo_user" (external_id, nickname, status, signature, risk_agreement, aml_agreement) 
VALUES (#{externalId}, #{nickname}, #{status}, #{signature}, #{riskAgreement}, #{amlAgreement})
```

**更新操作 (UPDATE)**:
```sql
-- 更新用户信息 (update) - 动态字段更新
UPDATE "bo_user" SET nickname = #{nickname}, status = #{status}, signature = #{signature}, 
       risk_agreement = #{riskAgreement}, aml_agreement = #{amlAgreement}, update_time = CURRENT_TIMESTAMP 
WHERE id = #{id}

-- 更新用户状态 (updateStatus)
UPDATE "bo_user" SET status = #{status}, update_time = CURRENT_TIMESTAMP WHERE id = #{id}

-- 更新协议状态 (updateAgreements)
UPDATE "bo_user" SET risk_agreement = #{riskAgreement}, aml_agreement = #{amlAgreement}, 
       update_time = CURRENT_TIMESTAMP WHERE id = #{id}
```

### 2. bo_account - 用户账户表

**业务作用**: 管理用户的DEMO和REAL账户，支持余额管理和原子操作

**完整建表语句**:
```sql
CREATE TABLE public.bo_account (
    id bigint DEFAULT nextval('public.account_id_seq'::regclass) NOT NULL,
    user_id bigint NOT NULL,
    account_type character varying(16) NOT NULL,
    currency character varying(8) DEFAULT 'USDT'::character varying NOT NULL,
    balance numeric(32,16) DEFAULT 0.0000000000000000 NOT NULL,
    frozen_balance numeric(32,16) DEFAULT 0.0000000000000000 NOT NULL,
    total_deposit numeric(32,16) DEFAULT 0.0000000000000000 NOT NULL,
    total_withdraw numeric(32,16) DEFAULT 0.0000000000000000 NOT NULL,
    total_profit numeric(32,16) DEFAULT 0.0000000000000000 NOT NULL,
    total_loss numeric(32,16) DEFAULT 0.0000000000000000 NOT NULL,
    reset_count integer DEFAULT 0 NOT NULL,
    last_reset_time timestamp without time zone,
    create_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    update_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT bo_account_pkey PRIMARY KEY (id),
    CONSTRAINT uk_bo_account_user_account_type UNIQUE (user_id, account_type),
    CONSTRAINT check_positive_balances CHECK (((balance >= (0)::numeric) AND (frozen_balance >= (0)::numeric))),
    CONSTRAINT check_valid_account_type CHECK (((account_type)::text = ANY ((ARRAY['REAL'::character varying, 'DEMO'::character varying])::text[]))),
    CONSTRAINT check_valid_currency CHECK (((currency)::text = ANY ((ARRAY['USDT'::character varying, 'BTC'::character varying, 'ETH'::character varying])::text[])))
);
```

**实际SQL操作**:

**查询操作 (SELECT)**:
```sql
-- 根据用户ID和账户类型查询 (findByUserIdAndAccountType) - 高频查询
SELECT id, user_id, account_type, currency, balance, frozen_balance, total_deposit, total_withdraw, 
       total_profit, total_loss, reset_count, last_reset_time, create_time, update_time 
FROM "bo_account" WHERE user_id = #{userId} AND account_type = #{accountType}

-- 根据用户ID查询所有账户 (findByUserId)
SELECT id, user_id, account_type, currency, balance, frozen_balance, total_deposit, total_withdraw, 
       total_profit, total_loss, reset_count, last_reset_time, create_time, update_time 
FROM "bo_account" WHERE user_id = #{userId}

-- 检查账户是否存在 (existsByUserIdAndAccountType)
SELECT COUNT(*) FROM "bo_account" WHERE user_id = #{userId} AND account_type = #{accountType}
```

**插入操作 (INSERT)**:
```sql
-- 插入新账户 (insert)
INSERT INTO "bo_account" (user_id, account_type, currency, balance, frozen_balance) 
VALUES (#{userId}, #{accountType}, #{currency}, #{balance}, #{frozenBalance})
```

**更新操作 (UPDATE)**:
```sql
-- 原子性余额变更 (atomicBalanceChange) - 并发安全
UPDATE "bo_account" 
SET balance = balance + #{balanceChange}, 
    frozen_balance = frozen_balance + #{frozenChange}, 
    update_time = CURRENT_TIMESTAMP 
WHERE user_id = #{userId} AND account_type = #{accountType}

-- 更新统计数据 (updateDepositWithdrawStats)
UPDATE "bo_account" 
SET total_deposit = total_deposit + #{depositAmount}, 
    total_withdraw = total_withdraw + #{withdrawAmount}, 
    total_profit = total_profit + #{profitAmount}, 
    total_loss = total_loss + #{lossAmount}, 
    update_time = CURRENT_TIMESTAMP 
WHERE user_id = #{userId} AND account_type = #{accountType}
```

### 3. bo_account_transaction - 账户交易流水表

**业务作用**: 记录所有账户资金变动，确保资金流水完整性

**完整建表语句**:
```sql
CREATE TABLE public.bo_account_transaction (
    id bigint DEFAULT nextval('public.account_transaction_id_seq'::regclass) NOT NULL,
    user_id bigint NOT NULL,
    account_id bigint NOT NULL,
    type character varying(16) NOT NULL,
    amount numeric(32,16) NOT NULL,
    frozen_amount numeric(32,16) DEFAULT 0.0000000000000000,
    balance_before numeric(32,16) NOT NULL,
    balance_after numeric(32,16) NOT NULL,
    frozen_before numeric(32,16) DEFAULT 0.0000000000000000,
    frozen_after numeric(32,16) DEFAULT 0.0000000000000000,
    ref_id bigint,
    ref_type character varying(16),
    description character varying(255),
    remark character varying(255),
    create_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT bo_account_transaction_pkey PRIMARY KEY (id),
    CONSTRAINT check_valid_ref_type CHECK (((ref_type IS NULL) OR ((ref_type)::text = ANY ((ARRAY['ORDER'::character varying, 'BTSE_TRANSFER'::character varying, 'WITHDRAWAL'::character varying, 'MANUAL'::character varying, 'BONUS_CLAIM'::character varying])::text[])))),
    CONSTRAINT check_valid_transaction_type CHECK (((type)::text = ANY ((ARRAY['DEPOSIT'::character varying, 'WITHDRAW'::character varying, 'FREEZE_OUT'::character varying, 'CANCEL'::character varying, 'BTSE_IN'::character varying, 'BTSE_OUT'::character varying, 'SETTLE_WIN'::character varying, 'SETTLE_LOSE'::character varying, 'ADJUSTMENT'::character varying, 'TRANSFER'::character varying, 'DEMO_INIT'::character varying])::text[])))
);
```

**实际SQL操作**:

**查询操作 (SELECT)**:
```sql
-- 根据用户ID分页查询流水 (findByUserId)
SELECT id, user_id, account_id, type, amount, frozen_amount, balance_before, balance_after, 
       frozen_before, frozen_after, ref_id, ref_type, description, remark, create_time 
FROM "bo_account_transaction" WHERE user_id = #{userId} 
ORDER BY create_time DESC OFFSET #{offset} LIMIT #{limit}

-- 根据交易类型查询 (findByType)
SELECT id, user_id, account_id, type, amount, frozen_amount, balance_before, balance_after, 
       frozen_before, frozen_after, ref_id, ref_type, description, remark, create_time 
FROM "bo_account_transaction" WHERE type = #{type} 
ORDER BY create_time DESC OFFSET #{offset} LIMIT #{limit}

-- 根据关联信息查询 (findByRef)
SELECT id, user_id, account_id, type, amount, frozen_amount, balance_before, balance_after, 
       frozen_before, frozen_after, ref_id, ref_type, description, remark, create_time 
FROM "bo_account_transaction" WHERE ref_id = #{refId} AND ref_type = #{refType}
```

**插入操作 (INSERT)**:
```sql
-- 插入流水记录 (insert)
INSERT INTO "bo_account_transaction" (user_id, account_id, type, amount, frozen_amount, 
       balance_before, balance_after, frozen_before, frozen_after, ref_id, ref_type, description, remark) 
VALUES (#{userId}, #{accountId}, #{type}, #{amount}, #{frozenAmount}, #{balanceBefore}, 
       #{balanceAfter}, #{frozenBefore}, #{frozenAfter}, #{refId}, #{refType}, #{description}, #{remark})
```

### 4. bo_option_order - 期权订单表

**业务作用**: 核心业务表，存储所有二元期权交易订单

**完整建表语句**:
```sql
CREATE TABLE public.bo_option_order (
    id bigint DEFAULT nextval('public.option_order_id_seq'::regclass) NOT NULL,
    user_id bigint NOT NULL,
    account_type character varying(16) NOT NULL,
    symbol_id bigint NOT NULL,
    round_id bigint NOT NULL,
    round_no character varying(64) NOT NULL,
    direction character varying(8) NOT NULL,
    amount numeric(32,16) NOT NULL,
    odds numeric(10,4) NOT NULL,
    expected_profit numeric(32,16) NOT NULL,
    order_price numeric(32,16) NOT NULL,
    settle_price numeric(32,16),
    status character varying(16) DEFAULT 'PENDING'::character varying NOT NULL,
    profit numeric(32,16),
    fee numeric(32,16),
    cancel_time timestamp without time zone,
    settle_time timestamp without time zone,
    create_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    update_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT bo_option_order_pkey PRIMARY KEY (id),
    CONSTRAINT check_positive_amount CHECK ((amount > (0)::numeric)),
    CONSTRAINT check_valid_account_type_order CHECK (((account_type)::text = ANY ((ARRAY['REAL'::character varying, 'DEMO'::character varying])::text[]))),
    CONSTRAINT check_valid_direction CHECK (((direction)::text = ANY ((ARRAY['UP'::character varying, 'DOWN'::character varying])::text[]))),
    CONSTRAINT check_valid_status CHECK (((status)::text = ANY ((ARRAY['PENDING'::character varying, 'ACTIVE'::character varying, 'WIN'::character varying, 'LOSE'::character varying, 'DRAW'::character varying, 'CANCELLED'::character varying, 'EXPIRED'::character varying])::text[])))
);
```

**实际SQL操作**:

**查询操作 (SELECT)**:
```sql
-- 根据用户ID查询订单 (findByUserId) - 高频查询
SELECT id, user_id, account_type, symbol_id, round_id, round_no, direction, amount, odds, 
       expected_profit, order_price, settle_price, status, profit, fee, cancel_time, 
       settle_time, create_time, update_time 
FROM "bo_option_order" WHERE user_id = #{userId} 
ORDER BY create_time DESC OFFSET #{offset} LIMIT #{limit}

-- 根据轮次ID查询订单 (findByRoundId)
SELECT id, user_id, account_type, symbol_id, round_id, round_no, direction, amount, odds, 
       expected_profit, order_price, settle_price, status, profit, fee, cancel_time, 
       settle_time, create_time, update_time 
FROM "bo_option_order" WHERE round_id = #{roundId}

-- 多条件复合查询 (findByCondition)
SELECT id, user_id, account_type, symbol_id, round_id, round_no, direction, amount, odds, 
       expected_profit, order_price, settle_price, status, profit, fee, cancel_time, 
       settle_time, create_time, update_time 
FROM "bo_option_order" 
WHERE user_id = #{userId} AND account_type = #{accountType} AND status = #{status}
ORDER BY create_time DESC OFFSET #{offset} LIMIT #{limit}

-- 统计查询 - 用户盈利统计 (sumProfitByUser)
SELECT COALESCE(SUM(profit), 0) FROM "bo_option_order" 
WHERE user_id = #{userId} AND status IN ('WIN', 'LOSE', 'DRAW')

-- 统计查询 - 时间范围内金额统计 (sumAmountByUserAndTime)
SELECT COALESCE(SUM(amount), 0) FROM "bo_option_order" 
WHERE user_id = #{userId} AND create_time BETWEEN #{startTime} AND #{endTime}
```

**插入操作 (INSERT)**:
```sql
-- 插入新订单 (insert)
INSERT INTO "bo_option_order" (user_id, account_type, symbol_id, round_id, round_no, direction, 
       amount, odds, expected_profit, order_price, status) 
VALUES (#{userId}, #{accountType}, #{symbolId}, #{roundId}, #{roundNo}, #{direction}, 
       #{amount}, #{odds}, #{expectedProfit}, #{orderPrice}, #{status})
```

**更新操作 (UPDATE)**:
```sql
-- 动态更新订单 (update)
UPDATE "bo_option_order" 
SET status = #{status}, settle_price = #{settlePrice}, profit = #{profit}, 
    fee = #{fee}, settle_time = #{settleTime}, update_time = CURRENT_TIMESTAMP 
WHERE id = #{id}
```

### 5. bo_trading_round - 交易轮次表

**业务作用**: 管理交易轮次，控制订单的开仓、锁单、结算流程

**完整建表语句**:
```sql
CREATE TABLE public.bo_trading_round (
    id bigint NOT NULL,
    round_no character varying(64) NOT NULL,
    symbol_id bigint NOT NULL,
    duration_minutes integer NOT NULL,
    start_time timestamp without time zone NOT NULL,
    lock_time timestamp without time zone NOT NULL,
    end_time timestamp without time zone NOT NULL,
    start_price numeric(32,16),
    end_price numeric(32,16),
    status character varying(16) DEFAULT 'OPEN'::character varying NOT NULL,
    total_up_amount numeric(32,16) DEFAULT 0.0000000000000000 NOT NULL,
    total_down_amount numeric(32,16) DEFAULT 0.0000000000000000 NOT NULL,
    create_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    update_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT bo_trading_round_pkey PRIMARY KEY (id),
    CONSTRAINT uk_bo_trading_round_round_no UNIQUE (round_no),
    CONSTRAINT check_valid_round_status CHECK (((status)::text = ANY ((ARRAY['OPEN'::character varying, 'LOCKED'::character varying, 'SETTLING'::character varying, 'SETTLED'::character varying, 'CANCELLED'::character varying])::text[])))
);
```

**实际SQL操作**:

**查询操作 (SELECT)**:
```sql
-- 查找当前轮次 (findCurrentRound)
SELECT id, round_no, symbol_id, duration_minutes, start_time, lock_time, end_time, 
       start_price, end_price, status, total_up_amount, total_down_amount, create_time, update_time 
FROM "bo_trading_round" 
WHERE symbol_id = #{symbolId} AND duration_minutes = #{durationMinutes} 
  AND status = 'OPEN' AND lock_time > CURRENT_TIMESTAMP 
ORDER BY start_time LIMIT 1

-- 查找待结算轮次 (findCompletedRoundsForSettlement)
SELECT id, round_no, symbol_id, duration_minutes, start_time, lock_time, end_time, 
       start_price, end_price, status, total_up_amount, total_down_amount, create_time, update_time 
FROM "bo_trading_round" 
WHERE status = 'LOCKED' AND end_time <= CURRENT_TIMESTAMP

-- 根据轮次编号查询 (findByRoundNo)
SELECT id, round_no, symbol_id, duration_minutes, start_time, lock_time, end_time, 
       start_price, end_price, status, total_up_amount, total_down_amount, create_time, update_time 
FROM "bo_trading_round" WHERE round_no = #{roundNo}
```

**插入操作 (INSERT)**:
```sql
-- 插入新轮次 (insert)
INSERT INTO "bo_trading_round" (round_no, symbol_id, duration_minutes, start_time, 
       lock_time, end_time, status) 
VALUES (#{roundNo}, #{symbolId}, #{durationMinutes}, #{startTime}, #{lockTime}, #{endTime}, #{status})

-- 插入或忽略重复 (insertOrIgnore) - PostgreSQL语法
INSERT INTO "bo_trading_round" (round_no, symbol_id, duration_minutes, start_time, 
       lock_time, end_time, status) 
VALUES (#{roundNo}, #{symbolId}, #{durationMinutes}, #{startTime}, #{lockTime}, #{endTime}, #{status}) 
ON CONFLICT (round_no) DO NOTHING
```

**更新操作 (UPDATE)**:
```sql
-- 设置开盘价 (updateStartPrice)
UPDATE "bo_trading_round" 
SET start_price = #{startPrice}, update_time = CURRENT_TIMESTAMP 
WHERE id = #{id}

-- 设置收盘价并结算 (updateEndPrice)
UPDATE "bo_trading_round" 
SET end_price = #{endPrice}, status = 'SETTLED', update_time = CURRENT_TIMESTAMP 
WHERE id = #{id}

-- 更新投注金额 (updateBetAmounts)
UPDATE "bo_trading_round" 
SET total_up_amount = #{totalUpAmount}, total_down_amount = #{totalDownAmount}, 
    update_time = CURRENT_TIMESTAMP 
WHERE id = #{id}
```

### 6. bo_btse_transfer_log - BTSE转账日志表

**业务作用**: 记录与BTSE API的所有转账交互，支持REAL账户资金管理

**完整建表语句**:
```sql
CREATE TABLE public.bo_btse_transfer_log (
    id bigint NOT NULL,
    trace_id character varying(100) NOT NULL,
    user_id bigint NOT NULL,
    transfer_type character varying(20) NOT NULL,
    refer_id bigint,
    direction character varying(10) NOT NULL,
    amount numeric(18,8) NOT NULL,
    currency character varying(10) DEFAULT 'USDT'::character varying,
    transfer_id character varying(100),
    api_method character varying(50),
    status character varying(20) DEFAULT 'PENDING'::character varying,
    error_message text,
    request_data text,
    response_data text,
    retry_count integer DEFAULT 0,
    environment character varying(20),
    is_mock smallint DEFAULT 0,
    request_time timestamp without time zone,
    response_time timestamp without time zone,
    create_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    update_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT bo_btse_transfer_log_pkey PRIMARY KEY (id),
    CONSTRAINT uk_bo_btse_transfer_log_trace_id UNIQUE (trace_id),
    CONSTRAINT check_valid_btse_direction CHECK (((direction)::text = ANY ((ARRAY['IN'::character varying, 'OUT'::character varying])::text[]))),
    CONSTRAINT check_valid_btse_status CHECK (((status)::text = ANY ((ARRAY['PENDING'::character varying, 'SUCCESS'::character varying, 'FAILED'::character varying, 'TIMEOUT'::character varying, 'CANCELLED'::character varying])::text[]))),
    CONSTRAINT check_valid_transfer_type CHECK (((transfer_type)::text = ANY ((ARRAY['ORDER_IN'::character varying, 'ORDER_OUT'::character varying, 'ROUND_OUT'::character varying, 'MANUAL_IN'::character varying, 'MANUAL_OUT'::character varying])::text[])))
);
```

**实际SQL操作**:

**查询操作 (SELECT)**:
```sql
-- 根据订单ID查询转账记录 (findByOrderId)
SELECT id, trace_id, user_id, transfer_type, refer_id, direction, amount, currency, 
       transfer_id, api_method, status, error_message, request_data, response_data, 
       retry_count, environment, is_mock, request_time, response_time, create_time, update_time 
FROM "bo_btse_transfer_log" WHERE refer_id = #{orderId} AND transfer_type LIKE '%ORDER%'

-- 查找超时待补偿转账 (findTimeoutPendingTransfers)
SELECT id, trace_id, user_id, transfer_type, refer_id, direction, amount, currency, 
       transfer_id, api_method, status, error_message, request_data, response_data, 
       retry_count, environment, is_mock, request_time, response_time, create_time, update_time 
FROM "bo_btse_transfer_log" 
WHERE status = 'PENDING' AND create_time < (CURRENT_TIMESTAMP - INTERVAL '5 seconds')

-- 根据用户查询转账历史 (findByUserId)
SELECT id, trace_id, user_id, transfer_type, refer_id, direction, amount, currency, 
       transfer_id, api_method, status, error_message, request_data, response_data, 
       retry_count, environment, is_mock, request_time, response_time, create_time, update_time 
FROM "bo_btse_transfer_log" WHERE user_id = #{userId} 
ORDER BY create_time DESC OFFSET #{offset} LIMIT #{limit}
```

**插入操作 (INSERT)**:
```sql
-- 插入转账日志 (insert)
INSERT INTO "bo_btse_transfer_log" (trace_id, user_id, transfer_type, refer_id, direction, 
       amount, currency, api_method, status, request_data, environment, is_mock) 
VALUES (#{traceId}, #{userId}, #{transferType}, #{referId}, #{direction}, #{amount}, 
       #{currency}, #{apiMethod}, #{status}, #{requestData}, #{environment}, #{isMock})
```

**更新操作 (UPDATE)**:
```sql
-- 更新转账状态 (updateStatus)
UPDATE "bo_btse_transfer_log" 
SET status = #{status}, transfer_id = #{transferId}, response_data = #{responseData}, 
    error_message = #{errorMessage}, response_time = CURRENT_TIMESTAMP, 
    update_time = CURRENT_TIMESTAMP 
WHERE id = #{id}

-- 更新重试次数 (updateRetryCount)
UPDATE "bo_btse_transfer_log" 
SET retry_count = retry_count + 1, update_time = CURRENT_TIMESTAMP 
WHERE id = #{id}
```

### 7. bo_user_round - 用户轮次表

**业务作用**: 记录用户在每个交易轮次的参与情况和盈亏统计

**完整建表语句**:
```sql
CREATE TABLE public.bo_user_round (
    id bigint NOT NULL,
    user_id bigint NOT NULL,
    round_id bigint NOT NULL,
    account_type character varying(10) NOT NULL,
    first_order_time timestamp without time zone NOT NULL,
    last_settle_time timestamp without time zone,
    total_orders integer DEFAULT 0,
    total_amount numeric(18,8) DEFAULT 0,
    net_profit numeric(18,8) DEFAULT 0,
    create_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    update_time timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    status character varying(20) DEFAULT 'PENDING'::character varying,
    CONSTRAINT bo_user_round_pkey PRIMARY KEY (id),
    CONSTRAINT uk_bo_user_round_user_round_account UNIQUE (user_id, round_id, account_type),
    CONSTRAINT check_valid_account_type_user_round CHECK (((account_type)::text = ANY ((ARRAY['REAL'::character varying, 'DEMO'::character varying])::text[]))),
    CONSTRAINT check_valid_user_round_status CHECK (((status)::text = ANY ((ARRAY['PENDING'::character varying, 'SETTLED'::character varying, 'TRANSFERRED'::character varying, 'TRANSFER_SUCCESS'::character varying, 'TRANSFER_FAILED'::character varying, 'SKIPPED'::character varying])::text[])))
);
```

**实际SQL操作**:

**查询操作 (SELECT)**:
```sql
-- 查询用户轮次记录 (findByUserIdAndRoundIdAndAccountType)
SELECT id, user_id, round_id, account_type, first_order_time, last_settle_time, 
       total_orders, total_amount, net_profit, create_time, update_time, status 
FROM "bo_user_round" 
WHERE user_id = #{userId} AND round_id = #{roundId} AND account_type = #{accountType}

-- 查询用户历史轮次ID (findHistoryRoundIdsByUser)
SELECT round_id FROM "bo_user_round" 
WHERE user_id = #{userId} AND account_type = #{accountType} AND status = 'SETTLED'
ORDER BY last_settle_time DESC OFFSET #{offset} LIMIT #{limit}
```

**插入和更新操作**:
```sql
-- UPSERT操作 - PostgreSQL语法 (upsertUserRound)
INSERT INTO "bo_user_round" (user_id, round_id, account_type, first_order_time, 
       total_orders, total_amount, net_profit) 
VALUES (#{userId}, #{roundId}, #{accountType}, #{firstOrderTime}, 1, #{amount}, 0) 
ON CONFLICT (user_id, round_id, account_type) DO UPDATE SET 
    total_orders = bo_user_round.total_orders + 1, 
    total_amount = bo_user_round.total_amount + #{amount}, 
    update_time = CURRENT_TIMESTAMP

-- 结算统计更新 - PostgreSQL语法 (updateSettlementStats)
UPDATE "bo_user_round" 
SET net_profit = #{netProfit}, last_settle_time = #{settleTime}, 
    status = 'SETTLED', update_time = CURRENT_TIMESTAMP 
WHERE user_id = #{userId} AND round_id = #{roundId} AND account_type = #{accountType}
```

### 8. 配置管理表

### bo_global_config - 全局配置表
```sql
-- 按键查询配置 (findByKey)
SELECT config_key, config_value, config_group, description, status, create_time, update_time 
FROM "bo_global_config" WHERE config_key = #{key}

-- 按分组查询配置 (findByGroup)
SELECT config_key, config_value, config_group, description, status, create_time, update_time 
FROM "bo_global_config" WHERE config_group = #{group} AND status = 1
```

### bo_symbol_config - 交易对配置表
```sql
-- 查询启用的交易对 (findAllEnabled)
SELECT id, symbol, symbol_name, base_currency, quote_currency, min_amount, max_amount, 
       odds, status, create_time, update_time 
FROM "bo_symbol_config" WHERE status = 1 ORDER BY id

-- 根据交易对符号查询 (findBySymbol)
SELECT id, symbol, symbol_name, base_currency, quote_currency, min_amount, max_amount, 
       odds, status, create_time, update_time 
FROM "bo_symbol_config" WHERE symbol = #{symbol}
```

### bo_blacklist - 黑名单表
```sql
-- 查询活跃黑名单 (findActiveByUserId)
SELECT id, user_id, reason, operator_id, operator_name, start_time, end_time, 
       status, create_time, update_time 
FROM "bo_blacklist" 
WHERE user_id = #{userId} AND status = 1 
  AND start_time <= CURRENT_TIMESTAMP 
  AND (end_time IS NULL OR end_time > CURRENT_TIMESTAMP)
```

### bo_user_risk_stats - 用户风控统计表
```sql
-- 查询用户风控统计 (findByUserId)
SELECT id, user_id, today_orders, today_amount, week_orders, week_amount, 
       month_orders, month_amount, total_orders, total_amount, consecutive_losses, 
       max_single_amount, last_order_time, last_reset_time, update_time 
FROM "bo_user_risk_stats" WHERE user_id = #{userId}

-- 批量重置今日统计 (batchResetTodayStats)
UPDATE "bo_user_risk_stats" 
SET today_orders = 0, today_amount = 0, last_reset_time = CURRENT_TIMESTAMP 
WHERE last_reset_time < CURRENT_DATE
```

