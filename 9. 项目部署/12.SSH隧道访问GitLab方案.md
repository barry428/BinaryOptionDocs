# SSH隧道访问GitLab方案（仅SSH协议）

## 方案概述

通过SSH隧道（动态端口转发）创建SOCKS5代理，实现本地通过中转服务器使用SSH协议访问GitLab。

## 架构图

```
┌─────────────┐   SSH隧道(SOCKS5)   ┌──────────────┐   SSH协议   ┌─────────────┐
│  本地开发    │ ──────────────────> │  中转服务器   │ ─────────> │   GitLab    │
│  Mac/Linux  │   127.0.0.1:1080    │   (Proxy)    │             │   服务器     │
└─────────────┘                     └──────────────┘             └─────────────┘
```

## 优势

- ✅ **配置简单**：无需安装额外软件，SSH内置功能
- ✅ **安全可靠**：SSH加密传输，安全性高
- ✅ **仅需SSH**：只配置SSH协议，无需HTTPS
- ✅ **开箱即用**：支持macOS、Linux、Windows (Git Bash)

## 前置条件

1. 中转服务器可以SSH访问GitLab
2. 本地可以SSH连接到中转服务器
3. 本地已安装Git和SSH客户端

## 实施步骤

### 一、中转服务器配置

#### 1. 检查SSH服务

```bash
# SSH登录到中转服务器
ssh user@your-proxy-server

# 检查SSH服务状态
sudo systemctl status sshd
```

#### 2. 配置SSH允许端口转发

```bash
# 编辑SSH配置文件
sudo vi /etc/ssh/sshd_config

# 确保以下配置存在且未被注释（如果不存在则添加）
AllowTcpForwarding yes

# 保存并重启SSH服务
sudo systemctl restart sshd
```

#### 3. 验证中转服务器可访问GitLab

```bash
# 测试SSH方式连接GitLab
ssh -T git@gitlab.com
# 成功会显示：Welcome to GitLab, @username!

# 如果GitLab使用非标准端口（如2222），测试如下
# ssh -T -p 2222 git@gitlab.com

# 退出中转服务器
exit
```

**✓ 中转服务器配置完成！**

---

### 二、本地客户端配置

#### 1. 配置SSH密钥认证（推荐）

```bash
# 在本地生成SSH密钥（如果还没有）
ssh-keygen -t ed25519 -C "git-proxy"

# 将公钥复制到中转服务器
ssh-copy-id user@your-proxy-server

# 测试免密登录
ssh user@your-proxy-server
# 如果能直接登录而不需要密码，说明配置成功
exit
```

#### 2. 创建SSH隧道

##### 方式A：手动启动（测试用）

```bash
# 创建动态端口转发（SOCKS5代理）
ssh -D 1080 -C -N user@your-proxy-server

# 参数说明：
# -D 1080  : 在本地1080端口创建SOCKS5代理
# -C       : 压缩数据传输
# -N       : 不执行远程命令，仅做端口转发
```

**保持这个终端窗口打开**，或使用 `-f` 参数让它在后台运行：

```bash
ssh -D 1080 -C -N -f user@your-proxy-server
```

##### 方式B：自动启动（推荐）

**使用autossh自动重连**（需要先安装autossh）：

```bash
# macOS安装autossh
brew install autossh

# Linux安装autossh
# Ubuntu/Debian:
sudo apt install autossh
# CentOS/RHEL:
sudo yum install autossh

# 使用autossh启动SSH隧道（自动重连）
autossh -M 0 -f -N -D 1080 -C \
    -o "ServerAliveInterval=30" \
    -o "ServerAliveCountMax=3" \
    user@your-proxy-server
```

#### 3. 配置SSH使用代理

编辑SSH配置文件：

```bash
# 编辑SSH配置
vi ~/.ssh/config

# 添加以下配置
Host gitlab.com
    ProxyCommand nc -X 5 -x 127.0.0.1:1080 %h %p
    User git

# 如果没有nc命令，可以使用socat（需要先安装）
# Host gitlab.com
#     ProxyCommand socat - SOCKS4A:127.0.0.1:%h:%p,socksport=1080
#     User git

# 如果GitLab使用非标准SSH端口（如2222）
# Host gitlab.com
#     ProxyCommand nc -X 5 -x 127.0.0.1:1080 %h %p
#     Port 2222
#     User git
```

**注意**：
- macOS和大多数Linux发行版自带 `nc` (netcat) 命令
- 如果 `nc` 不支持 `-X` 参数，可以安装 `nmap-ncat`：
  ```bash
  # macOS
  brew install nmap
  # Linux
  sudo apt install ncat  # Ubuntu/Debian
  sudo yum install nmap-ncat  # CentOS/RHEL
  ```

#### 4. 测试连接

```bash
# 测试SSH Git连接
ssh -T git@gitlab.com
# 成功会显示类似：Welcome to GitLab, @username!

# 测试克隆仓库
git clone git@gitlab.com:nogle/btsecom/btse-backend/binary-option-rc.git
```
