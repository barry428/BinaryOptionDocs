# CI/CD 前期准备工作

## 文档信息
- **创建时间**: 2025-08-20
- **文档版本**: v1.0
- **基于模板**: BTSE企业级CI/CD模板
- **目标**: 为当前二元期权项目适配BTSE CI/CD模板

---

## 1. 当前项目结构分析

### 1.1 项目架构现状
```
BinaryOption/
├── option-parent/          # Maven父项目
├── option-common-utils/    # 公共工具类
├── option-common-dto/      # 数据传输对象
├── option-security-base/   # 安全基础模块
├── option-common-service/  # 用户和账户管理服务 (8081)
├── option-order-service/   # 订单处理服务 (8082)
├── option-market-service/  # 行情数据服务 (8083)
├── option-gateway/         # API网关服务 (8080)
├── option-admin-service/   # 管理后台服务
├── option-job-executor/    # 定时任务执行器
└── option-xxl-job/        # XXL-JOB调度中心
```

### 1.2 技术栈分析
| 组件 | 当前配置 | BTSE模板要求 | 兼容性 | 修改需求 |
|------|----------|--------------|--------|----------|
| **Java版本** | Java 17 | ✅ Java 17+ | ✅ 完全兼容 | 无需修改 |
| **Spring Boot** | 2.7.18 | ✅ 2.x+ | ✅ 完全兼容 | 无需修改 |
| **Maven** | 多模块项目 | ✅ Maven构建 | ✅ 完全兼容 | 无需修改 |
| **服务发现** | Nacos | ❌ 生产环境不使用 | ⚠️ 需调整 | 生产环境禁用 |
| **数据库** | MySQL + PostgreSQL | ✅ 双数据库支持 | ✅ 完全兼容 | 生产环境只用PG |
| **服务端口** | 8080-8083 | ❌ 统一8080 | ⚠️ 需调整 | 统一改为8080 |

---

## 2. 必需的基础设施修改

### 2.1 Maven构建结构调整

#### 2.1.1 根POM文件缺失
**问题**: 项目缺少根级别的pom.xml，BTSE模板需要统一构建入口

**解决方案**: 创建根POM文件
```xml
<!-- /pom.xml -->
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.binaryoption</groupId>
    <artifactId>binaryoption-root</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <packaging>pom</packaging>
    
    <modules>
        <module>option-parent</module>
    </modules>
    
    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>
</project>
```

#### 2.1.2 构建目标调整
**当前**: 各服务独立构建
**目标**: 支持`TARGET_PROJECT_FOLDER: \".\"`的统一构建

**修改清单**:
- [ ] 创建根POM文件
- [ ] 调整模块依赖关系
- [ ] 确保从根目录可以构建所有服务

### 2.2 服务端口统一

#### 2.2.1 当前端口分布
```yaml
option-common-service:  8081
option-order-service:   8082
option-market-service:  8083
option-gateway:         8080
```

#### 2.2.2 统一端口策略
**BTSE模板要求**: 所有服务使用8080端口（通过容器和负载均衡区分）

**修改方案**:
```yaml
# 所有服务的application.yml
server:
  port: ${SERVER_PORT:8080}  # 支持环境变量覆盖
```

**配置文件修改清单**:
- [ ] `option-common-service/src/main/resources/application.yml`
- [ ] `option-order-service/src/main/resources/application.yml`
- [ ] `option-market-service/src/main/resources/application.yml`
- [ ] `option-gateway/src/main/resources/application.yml`

### 2.3 生产环境配置调整

#### 2.3.1 Nacos依赖移除
**问题**: 生产环境使用Nginx负载均衡，不需要Nacos服务发现

**解决方案**: 创建生产环境Profile
```yaml
# application-production.yml
spring:
  cloud:
    nacos:
      discovery:
        enabled: false  # 生产环境禁用Nacos
```

#### 2.3.2 PostgreSQL专用配置
**当前**: 支持MySQL和PostgreSQL双数据库
**生产要求**: 只使用PostgreSQL

**配置调整**:
```yaml
# application-production.yml
spring:
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:binaryoption}
    username: ${DB_USER:binaryoption}
    password: ${DB_PASSWORD:}
    driver-class-name: org.postgresql.Driver

mybatis:
  configuration:
    database-id: postgresql
```

---

## 3. BTSE模板适配要求

### 3.1 构建镜像兼容性

#### 3.1.1 BTSE构建镜像分析
```yaml
BUILD_IMAGE: "registry.gitlab.com/nogle/btsecom/btse-backend/binary_option/binaryoption-build-image-21:latest"
```

**镜像包含组件**:
- Maven 3.x
- Java 17
- 常用构建工具
- BTSE特定配置

#### 3.1.2 项目兼容性检查
**检查项目**:
- [ ] Maven版本兼容性 (需要3.6+)
- [ ] Java版本兼容性 (需要17)
- [ ] 依赖包兼容性
- [ ] 构建插件兼容性

### 3.2 部署脚本适配

#### 3.2.1 服务启动顺序
**BTSE模板期望**: 通过模板变量控制启动顺序
**当前需求**: 
```
option-common-service → option-market-service → option-order-service → option-gateway
```

**适配方案**: 在CI变量中定义启动顺序
```yaml
variables:
  STARTUP_ORDER: "option-common-service,option-market-service,option-order-service,option-gateway"
  SERVICE_DEPENDENCIES: |
    option-order-service: option-common-service,option-market-service
    option-gateway: option-common-service,option-order-service,option-market-service
```

#### 3.2.2 健康检查端点
**BTSE模板期望**: 标准Spring Boot Actuator端点
**当前状态**: 已配置actuator依赖

**验证清单**:
- [ ] 确认所有服务包含`spring-boot-starter-actuator`依赖
- [ ] 验证`/actuator/health`端点可访问
- [ ] 配置健康检查端点权限

---

## 4. 环境配置准备

### 4.1 GitLab环境准备

#### 4.1.1 必需的GitLab变量
```bash
# SSH连接配置
SSH_PWD               # SSH密码 (加密存储)

# 数据库配置
DEV_DB_PASSWORD       # 开发环境数据库密码
STAGING_DB_PASSWORD   # 预发布环境数据库密码
PROD_DB_PASSWORD      # 生产环境数据库密码

# Redis配置
REDIS_PASSWORD        # Redis集群密码

# BTSE配置
BTSE_API_KEY         # BTSE API密钥
BTSE_API_SECRET      # BTSE API密钥
BTSE_MOCK_ENABLED    # Mock模式开关

# 安全配置
JWT_SECRET           # JWT签名密钥
```

#### 4.1.2 GitLab Runner配置
**要求**:
- 支持Docker构建
- 网络访问目标服务器
- 足够的构建资源

### 4.2 目标服务器准备

#### 4.2.1 开发环境 (10.1.29.45)
**准备工作**:
- [ ] 安装Docker和Docker Compose
- [ ] 配置SSH密钥访问
- [ ] 准备PostgreSQL数据库
- [ ] 配置Redis集群
- [ ] 网络防火墙配置

#### 4.2.2 预发布环境 (10.1.35.186/187)
**双节点配置**:
- [ ] 两台服务器相同的环境配置
- [ ] 负载均衡器配置
- [ ] 数据库连接配置
- [ ] 监控和日志配置

---

## 5. 代码结构适配

### 5.1 应用入口类标准化

#### 5.1.1 当前应用入口
```java
// option-market-service/src/main/java/com/binaryoption/marketservice/Application.java
@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

#### 5.1.2 标准化要求
**BTSE模板期望**: 统一的应用入口命名和配置

**标准化清单**:
- [ ] 确认所有服务都有Application.java入口类
- [ ] 统一包名结构
- [ ] 统一Spring Boot配置注解

### 5.2 配置文件标准化

#### 5.2.1 Profile配置
**当前**: 部分服务支持postgresql profile
**目标**: 所有服务支持统一的profile策略

**Profile规划**:
```yaml
# 开发环境
spring.profiles.active: dev

# 预发布环境  
spring.profiles.active: staging

# 生产环境
spring.profiles.active: production
```

#### 5.2.2 外部化配置
**目标**: 支持环境变量注入
```yaml
# 数据库配置
spring:
  datasource:
    url: ${DB_URL}
    username: ${DB_USER}
    password: ${DB_PASSWORD}

# Redis配置
redis:
  cluster:
    nodes: ${REDIS_NODES}
    password: ${REDIS_PASSWORD}

# 服务端口
server:
  port: ${SERVER_PORT:8080}
```

---

## 6. Docker化准备

### 6.1 Dockerfile标准化

#### 6.1.1 当前状态
**问题**: 项目缺少Dockerfile文件

#### 6.1.2 标准Dockerfile模板
```dockerfile
# 每个服务目录下创建Dockerfile
FROM openjdk:17-slim

# 工作目录
WORKDIR /app

# 复制JAR文件
COPY target/*.jar app.jar

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# 启动命令
ENTRYPOINT ["java", "-jar", "/app/app.jar"]
```

#### 6.1.3 Dockerfile创建清单
- [ ] `option-common-service/Dockerfile`
- [ ] `option-order-service/Dockerfile`
- [ ] `option-market-service/Dockerfile`
- [ ] `option-gateway/Dockerfile`

### 6.2 Docker Compose配置

#### 6.2.1 开发环境配置
```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  common-service:
    build: ./option-common-service
    ports:
      - "8081:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
  
  # 其他服务...
```

---

## 7. 测试和验证准备

### 7.1 单元测试配置

#### 7.1.1 当前测试状态
**分析**: 检查各服务的测试覆盖率和配置

**测试框架**:
- JUnit 5
- Spring Boot Test
- Mockito

#### 7.1.2 测试标准化
**要求**:
- [ ] 所有服务包含基础单元测试
- [ ] 集成测试配置
- [ ] 测试数据库配置
- [ ] Mock服务配置

### 7.2 健康检查验证

#### 7.2.1 端点验证清单
```bash
# 验证所有服务健康检查端点
curl http://localhost:8080/actuator/health  # gateway
curl http://localhost:8081/actuator/health  # common-service
curl http://localhost:8082/actuator/health  # order-service
curl http://localhost:8083/actuator/health  # market-service
```

#### 7.2.2 依赖服务检查
**检查项**:
- [ ] 数据库连接健康检查
- [ ] Redis连接健康检查
- [ ] 外部API健康检查

---

## 8. 安全配置准备

### 8.1 敏感信息管理

#### 8.1.1 当前配置审查
**问题识别**:
```yaml
# 当前配置中的敏感信息
spring:
  datasource:
    password: root  # 硬编码密码
  redis:
    password: WOJdJ4HLWCQx9K3E  # 硬编码密码
```

#### 8.1.2 环境变量化改造
```yaml
# 安全化配置
spring:
  datasource:
    password: ${DB_PASSWORD}
  redis:
    password: ${REDIS_PASSWORD}
    
btse:
  api:
    auth:
      api-key: ${BTSE_API_KEY}
      api-secret: ${BTSE_API_SECRET}
```

### 8.2 生产环境安全加固

#### 8.2.1 Spring Boot安全配置
```yaml
# application-production.yml
management:
  endpoints:
    web:
      exposure:
        include: health,info  # 只暴露必要端点
  endpoint:
    health:
      show-details: never   # 生产环境不显示详细信息
```

---

## 9. 监控和日志准备

### 9.1 日志配置标准化

#### 9.1.1 Logback配置
```xml
<!-- src/main/resources/logback-spring.xml -->
<configuration>
    <springProfile name="production">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>/var/log/binaryoption/${spring.application.name}.log</file>
            <!-- 配置滚动策略 -->
        </appender>
    </springProfile>
</configuration>
```

### 9.2 监控指标配置

#### 9.2.1 Actuator指标
```yaml
management:
  metrics:
    export:
      prometheus:
        enabled: true
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
```

---

## 10. 实施计划

### 10.1 第一阶段：基础架构调整
**优先级**: 高
**工期**: 2-3天

**任务清单**:
- [ ] 创建根POM文件
- [ ] 统一服务端口配置
- [ ] 创建生产环境Profile
- [ ] 配置环境变量支持

### 10.2 第二阶段：Docker化改造
**优先级**: 高  
**工期**: 2-3天

**任务清单**:
- [ ] 为所有服务创建Dockerfile
- [ ] 创建Docker Compose配置
- [ ] 验证容器化构建和运行

### 10.3 第三阶段：CI/CD集成
**优先级**: 中
**工期**: 3-5天

**任务清单**:
- [ ] 配置GitLab变量
- [ ] 创建CI/CD配置文件
- [ ] 测试构建和部署流程
- [ ] 验证各环境部署

### 10.4 第四阶段：测试和优化
**优先级**: 中
**工期**: 2-3天

**任务清单**:
- [ ] 完善单元测试
- [ ] 集成测试验证
- [ ] 性能测试
- [ ] 安全测试

---

## 11. 风险评估

### 11.1 技术风险

| 风险项 | 影响程度 | 可能性 | 缓解措施 |
|--------|----------|--------|----------|
| BTSE构建镜像不兼容 | 高 | 低 | 本地验证构建过程 |
| 端口统一导致冲突 | 中 | 中 | 使用容器网络隔离 |
| Nacos依赖移除影响 | 中 | 中 | 渐进式配置切换 |
| 数据库配置迁移 | 低 | 低 | 已有双数据库支持 |

### 11.2 部署风险

| 风险项 | 影响程度 | 可能性 | 缓解措施 |
|--------|----------|--------|----------|
| 服务启动顺序错误 | 中 | 中 | 详细的依赖检查 |
| 环境变量配置错误 | 高 | 中 | 完整的配置验证清单 |
| 网络连接问题 | 中 | 低 | 网络连通性预检查 |

---

## 12. 验收标准

### 12.1 构建验收
- [ ] 从根目录可以成功构建所有服务
- [ ] 所有服务可以成功打包为Docker镜像
- [ ] Maven测试全部通过

### 12.2 部署验收
- [ ] 开发环境自动部署成功
- [ ] 预发布环境手动部署成功
- [ ] 所有服务健康检查通过
- [ ] 服务间调用正常

### 12.3 功能验收
- [ ] 核心业务流程验证通过
- [ ] 数据库操作正常
- [ ] Redis缓存功能正常
- [ ] 外部API调用正常

---

**文档更新记录**

| 版本 | 日期 | 更新内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-08-20 | 初始版本，分析当前项目CI/CD适配需求 | DevOps团队 |

**下次更新计划**: 根据实施进度更新完成状态和遇到的问题