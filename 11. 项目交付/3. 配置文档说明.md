# 配置文档说明

## 概述
二元期权交易平台使用多个配置表来管理系统运行参数，包括交易对配置、时长配置、风控配置和黑名单管理。所有配置表都采用 `bo_` 前缀命名规范。

## 1. 交易对配置 (bo_symbol_config)

### 1.1 表结构说明
交易对配置表管理平台支持的所有交易品种，包括币种对和BTSE映射关系。

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|---------|
| id | bigint | 主键ID | 1 |
| symbol | varchar(32) | 交易对名称 | BTC-USDT |
| base_currency | varchar(16) | 基础货币 | BTC |
| quote_currency | varchar(16) | 计价货币 | USDT |
| enabled | smallint | 是否启用(1:启用 0:禁用) | 1 |
| min_amount | numeric(32,16) | ⚠️ **已废弃**，使用风控配置替代 | 10.00 |
| max_amount | numeric(32,16) | ⚠️ **已废弃**，使用风控配置替代 | 10000.00 |
| btse_symbol | varchar(32) | BTSE对应的交易对名称 | BTC-USDT |
| sort_order | integer | 排序权重 | 1 |
| create_time | timestamp | 创建时间 | 2025-08-05 07:25:00 |
| update_time | timestamp | 更新时间 | 2025-08-05 07:25:00 |

> **重要说明**：`min_amount` 和 `max_amount` 字段已废弃，订单金额限制统一使用 `bo_risk_config` 表中的 `SINGLE_ORDER_MIN_AMOUNT` 和 `SINGLE_ORDER_MAX_AMOUNT` 配置。后续如果需要针对单个交易对设置不同限额，可以进行升级扩展。

### 1.2 配置示例
```sql
-- 添加BTC交易对
INSERT INTO bo_symbol_config (symbol, base_currency, quote_currency, enabled, min_amount, max_amount, btse_symbol, sort_order) 
VALUES ('BTC-USDT', 'BTC', 'USDT', 1, 10.00, 10000.00, 'BTC-USDT', 1);

-- 添加ETH交易对
INSERT INTO bo_symbol_config (symbol, base_currency, quote_currency, enabled, min_amount, max_amount, btse_symbol, sort_order) 
VALUES ('ETH-USDT', 'ETH', 'USDT', 1, 10.00, 5000.00, 'ETH-USDT', 2);
```

### 1.3 业务逻辑
- **SymbolService.java**：提供交易对查询和验证服务
  - `getActiveSymbols()`：获取所有启用的交易对
  - `getSymbolConfig(String symbol)`：根据符号获取配置
  - `isSymbolActive(String symbol)`：检查交易对是否启用
  - ~~`isValidAmount(BigDecimal amount)`~~：已废弃，使用风控配置进行金额验证

## 2. 时长配置 (bo_duration_config)

### 2.1 表结构说明
时长配置表定义交易周期的时间规则、赔率和手续费。

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|---------|
| id | bigint | 主键ID | 1 |
| duration_minutes | integer | 周期时长(分钟) | 5 |
| duration_name | varchar(32) | 周期名称 | 5分钟 |
| enabled | smallint | 是否启用 | 1 |
| lock_seconds | integer | 锁单时间(秒) | 30 |
| base_odds | numeric(10,4) | 基础赔率 | 1.9000 |
| fee_rate | numeric(6,4) | 手续费率 | 0.1000 |
| sort_order | integer | 排序权重 | 1 |
| description | varchar(255) | 描述说明 | NULL |
| create_time | timestamp | 创建时间 | 2025-07-24 13:24:57 |
| update_time | timestamp | 更新时间 | 2025-07-24 13:24:57 |

### 2.2 配置示例
```sql
-- 5分钟周期
INSERT INTO bo_duration_config (duration_minutes, duration_name, enabled, lock_seconds, base_odds, fee_rate, sort_order) 
VALUES (5, '5分钟', 1, 30, 1.90, 0.10, 1);

-- 15分钟周期
INSERT INTO bo_duration_config (duration_minutes, duration_name, enabled, lock_seconds, base_odds, fee_rate, sort_order) 
VALUES (15, '15分钟', 1, 60, 1.85, 0.10, 2);

-- 1小时周期
INSERT INTO bo_duration_config (duration_minutes, duration_name, enabled, lock_seconds, base_odds, fee_rate, sort_order) 
VALUES (60, '1小时', 1, 120, 1.80, 0.10, 3);
```

### 2.3 业务说明
- **lock_seconds**：在每个交易周期结束前的锁单时间，此时间内不允许新下单
- **base_odds**：基础赔率，实际赔率可能根据市场情况调整
- **fee_rate**：手续费率，0.1表示10%手续费

### 2.4 轮次和交易对关系
时长配置与交易对是多对多的关系，每个时长配置会为所有启用的交易对自动创建轮次：

#### 2.4.1 轮次生成规则
- **自动创建**：系统定时任务 (`maintainAllTradingRounds`) 为每个交易对创建轮次
- **全覆盖原则**：每增加一个时长配置，系统会为所有启用的交易对自动生成对应的轮次
- **轮次编号格式**：`S{symbolId}_D{durationMinutes}_{yyyyMMddHHmm}`
  - 示例：`S1_D5_202511132130` (交易对ID=1, 5分钟周期, 2025年11月13日21:30)

#### 2.4.2 维护机制
```java
// 定时任务每1分钟执行一次轮次维护
public void maintainAllTradingRounds() {
    List<SymbolConfig> activeSymbols = symbolService.getActiveSymbols();
    List<DurationConfig> enabledConfigs = durationConfigMapper.findAllEnabled();
    
    // 为每个交易对 × 每个时长配置创建轮次
    for (SymbolConfig symbol : activeSymbols) {
        for (DurationConfig config : enabledConfigs) {
            getOrCreateRoundForDuration(symbol.getId(), config, now);
        }
    }
}
```

#### 2.4.3 实际应用场景
假设系统配置了：
- **交易对**：BTC-USDT (ID=1), ETH-USDT (ID=2)  
- **时长配置**：5分钟, 15分钟, 60分钟

则系统会自动创建以下轮次：
```
BTC-USDT: S1_D5_202511132130, S1_D15_202511132130, S1_D60_202511132100
ETH-USDT: S2_D5_202511132130, S2_D15_202511132130, S2_D60_202511132100
```

#### 2.4.4 动态扩展
- **新增交易对**：系统会为新交易对创建所有已配置时长的轮次
- **新增时长**：系统会为所有交易对创建新时长的轮次
- **禁用处理**：禁用交易对或时长配置后，相关轮次不再创建新周期

## 3. 风控配置 (bo_risk_config)

### 3.1 表结构说明
风控配置表管理系统的风险控制参数，包括限额、频率限制等。

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|---------|
| id | bigint | 主键ID | 1 |
| config_key | varchar(64) | 配置键 | SINGLE_ORDER_MAX_AMOUNT |
| config_value | varchar(255) | 配置值 | 100 |
| config_type | varchar(16) | 配置类型 | DECIMAL |
| description | varchar(255) | 描述 | 单笔订单最大金额(USDT) |
| enabled | smallint | 是否启用 | 1 |
| create_time | timestamp | 创建时间 | 2025-08-05 07:25:00 |
| update_time | timestamp | 更新时间 | 2025-08-05 07:25:00 |

### 3.2 风控配置项说明

#### 3.2.1 全局控制
```sql
-- 全局风控开关
INSERT INTO bo_risk_config (config_key, config_value, config_type, description, enabled) 
VALUES ('GLOBAL_RISK_CONTROL_ENABLED', '1', 'BOOLEAN', '全局风控开关', 1);
```

#### 3.2.2 单笔限额
```sql
-- 单笔订单最小金额
INSERT INTO bo_risk_config (config_key, config_value, config_type, description, enabled) 
VALUES ('SINGLE_ORDER_MIN_AMOUNT', '1', 'DECIMAL', '单笔订单最小金额(USDT)', 1);

-- 单笔订单最大金额
INSERT INTO bo_risk_config (config_key, config_value, config_type, description, enabled) 
VALUES ('SINGLE_ORDER_MAX_AMOUNT', '100', 'DECIMAL', '单笔订单最大金额(USDT)', 1);
```

#### 3.2.3 周期限额
```sql
-- 每日限额
INSERT INTO bo_risk_config (config_key, config_value, config_type, description, enabled) 
VALUES ('DAILY_ORDER_LIMIT', '500', 'DECIMAL', '用户每日累计下单限额(USDT)', 1);

-- 每周限额
INSERT INTO bo_risk_config (config_key, config_value, config_type, description, enabled) 
VALUES ('WEEKLY_ORDER_LIMIT', '2000', 'DECIMAL', '用户每周累计下单限额(USDT)', 1);

-- 每月限额
INSERT INTO bo_risk_config (config_key, config_value, config_type, description, enabled) 
VALUES ('MONTHLY_ORDER_LIMIT', '5000', 'DECIMAL', '用户每月累计下单限额(USDT)', 1);
```

##### 周期限额重置时间说明
系统通过定时任务自动重置用户的周期限额统计，具体规则如下：

1. **每日限额重置**
   - 重置时间：每天凌晨1点（由定时任务触发）
   - 实际生效：用户下单时检查，如果日期已变更则立即重置
   - 重置内容：当日订单数量、金额、盈亏等统计清零

2. **每周限额重置**
   - 重置时间：每周一凌晨1点（由定时任务触发）
   - 实际生效：用户下单时检查，如果已进入新的一周则立即重置
   - 周期计算：以周一为每周的第一天
   - 重置内容：本周订单数量、金额、盈亏等统计清零

3. **每月限额重置**
   - 重置时间：每月1日凌晨1点（由定时任务触发）
   - 实际生效：用户下单时检查，如果已进入新的月份则立即重置
   - 周期计算：以每月1日为月度开始
   - 重置内容：本月订单数量、金额、盈亏等统计清零

4. **重置机制说明**
   - 采用双重保障机制：定时任务批量重置 + 用户下单时实时检查
   - 定时任务：`ScheduledTaskService.executeUserRiskStatsResetTask()` 每天凌晨1点执行
   - 实时检查：`UserRiskStatsService.checkAndResetPeriodStats()` 在用户下单时触发

#### 3.2.4 频率限制
```sql
-- 下单频率限制 (格式: 次数:分钟)
INSERT INTO bo_risk_config (config_key, config_value, config_type, description, enabled) 
VALUES ('ORDER_FREQUENCY_LIMIT', '10:5', 'STRING', '下单频率限制(格式: 次数:分钟)', 1);
```

#### 3.2.5 轮次订单限制
```sql
-- 轮次订单限制 (JSON格式)
INSERT INTO bo_risk_config (config_key, config_value, config_type, description, enabled) 
VALUES ('ROUND_ORDER_LIMIT', '{"5":3,"15":5,"60":10,"default":5}', 'JSON', '每轮次最大订单数限制(按时长分钟区分)', 1);
```

### 3.3 风控检查流程

系统通过 `RiskControlService.checkOrderRisk()` 方法执行完整的风控检查，检查顺序如下：

#### 3.3.1 检查流程
1. **全局风控开关检查** (`GLOBAL_RISK_CONTROL_ENABLED`)
   - 如果关闭，跳过所有风控检查
   - 如果开启，继续执行后续检查

2. **黑名单检查** (`checkBlacklist`)
   - 查询用户是否在有效的黑名单中
   - 检查黑名单的有效期（start_time <= 当前时间 <= end_time）
   - 风险级别：CRITICAL

3. **单笔限额检查** (`checkSingleOrderLimit`)
   - 风控配置最小金额：`SINGLE_ORDER_MIN_AMOUNT`
   - 风控配置最大金额：`SINGLE_ORDER_MAX_AMOUNT`
   - 交易对限额：symbol_config.min_amount, max_amount (已废弃，但代码仍保留)
   - 风险级别：HIGH

4. **每日限额检查** (`checkDailyLimit`)
   - 配置项：`DAILY_ORDER_LIMIT`
   - 统计范围：当日00:00:00 到当前时间
   - 累计计算：当日已下单金额 + 当前订单金额 > 限额
   - 风险级别：HIGH

5. **每周限额检查** (`checkWeeklyLimit`)
   - 配置项：`WEEKLY_ORDER_LIMIT`
   - 统计范围：本周一00:00:00 到当前时间
   - 累计计算：本周已下单金额 + 当前订单金额 > 限额
   - 风险级别：HIGH

6. **每月限额检查** (`checkMonthlyLimit`)
   - 配置项：`MONTHLY_ORDER_LIMIT`
   - 统计范围：本月1日00:00:00 到当前时间
   - 累计计算：本月已下单金额 + 当前订单金额 > 限额
   - 风险级别：HIGH

7. **频率限制检查** (`checkFrequencyLimit`)
   - 配置项：`ORDER_FREQUENCY_LIMIT`
   - 配置格式：`{最大次数}:{时间窗口分钟数}` (如: "10:5")
   - 检查逻辑：过去N分钟内的订单数量 >= 最大次数
   - 风险级别：MEDIUM

8. **轮次订单限制检查** (`checkRoundOrderLimit`)
   - 配置项：`ROUND_ORDER_LIMIT`
   - 配置格式：JSON，按交易轮次时长区分限制
   - 检查逻辑：当前轮次中用户已下单数量 >= 配置限制
   - 风险级别：MEDIUM

#### 3.3.2 轮次限制详细说明
轮次订单限制使用JSON格式配置，支持按不同交易时长设置不同的限制：

```json
{
  "5": 3,        // 5分钟轮次最多3单
  "15": 5,       // 15分钟轮次最多5单
  "60": 10,      // 60分钟轮次最多10单
  "default": 5   // 其他时长默认最多5单
}
```

#### 3.3.3 风险等级说明
根据 `RiskControlService` 代码分析，系统实际使用的风险等级如下：

- **CRITICAL**: 严重风险
  - 黑名单用户 (`BLACKLIST`)
  
- **HIGH**: 高风险  
  - 单笔订单限额 (`SINGLE_LIMIT`) - 最小/最大金额
  - 交易对限额 (`SYMBOL_LIMIT`) - min_amount/max_amount (已废弃但代码保留)
  - 周期限额 (`DAILY_LIMIT`, `WEEKLY_LIMIT`, `MONTHLY_LIMIT`) - 每日/周/月累计限额
  
- **MEDIUM**: 中等风险
  - 频率限制 (`FREQUENCY_LIMIT`) - 短时间内下单过频
  - 轮次限制 (`ROUND_ORDER_LIMIT`) - 单轮次订单数量超限

#### 3.3.4 风险检查结果类型
系统使用 `RiskCheckResult` 类来表示风控检查结果，包含三种结果类型：

- **PASS**: 检查通过，允许下单
- **REJECT**: 拒绝下单，阻断操作

#### 3.3.5 风险日志记录  
所有触发风控的事件都会记录到 `bo_risk_log` 表中，包含：
- **用户ID、订单ID**: 标识风险事件的主体
- **风险类型和等级**: 如 BLACKLIST/CRITICAL, SINGLE_LIMIT/HIGH
- **触发值和阈值**: 实际值与配置限制的对比
- **采取的动作和结果**: BLOCK/SUCCESS
- **详细描述信息**: 包含具体的风险触发原因

### 3.4 配置类型说明
- **BOOLEAN**: 布尔值配置 (0/1)
- **DECIMAL**: 数值配置
- **STRING**: 字符串配置，支持特定格式如 "次数:分钟"
- **JSON**: JSON格式配置，支持复杂的结构化配置

## 4. 黑名单配置 (bo_blacklist)

### 4.1 表结构说明
黑名单表用于限制特定用户的交易权限，支持通过用户ID和用户名两种方式管理。

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|---------|
| id | bigint | 主键ID | 1 |
| user_id | bigint | 用户ID，可为0（当仅使用username时） | 10001 |
| username | varchar(64) | 用户账号，可作为用户ID的替代标识 | user001 |
| reason | varchar(255) | 限制原因 | 违反平台规则 |
| type | varchar(64) | 黑名单类型 | auto / admin |
| operator_id | bigint | 操作员ID | 1 |
| operator_name | varchar(64) | 操作员名称 | admin |
| start_time | timestamp | 开始时间 | 2025-08-05 10:00:00 |
| end_time | timestamp | 结束时间(NULL表示永久) | 2025-08-12 10:00:00 |
| status | smallint | 状态(1:激活 0:失效) | 1 |
| create_time | timestamp | 创建时间 | 2025-08-05 10:00:00 |
| update_time | timestamp | 更新时间 | 2025-08-05 10:00:00 |

### 4.1.1 字段说明
- **username**: 用户账号
- **type**: 黑名单类型，用于区分添加方式和管理级别
  - `auto`: 系统自动风控添加
  - `admin`: 管理员手动添加  
  - `batch`: 批量导入添加
  - `api`: API接口添加

### 4.2 配置示例
```sql
-- 1. 通过用户ID添加临时黑名单(7天)
INSERT INTO bo_blacklist (user_id, username, reason, type, operator_id, operator_name, start_time, end_time, status) 
VALUES (10001, NULL, '频繁下单触发风控', 'auto', 1, 'system', NOW(), NOW() + INTERVAL '7 days', 1);

-- 2. 通过用户名添加永久黑名单
INSERT INTO bo_blacklist (user_id, username, reason, type, operator_id, operator_name, start_time, status) 
VALUES (0, 'user002', '恶意操作', 'admin', 1, 'admin', NOW(), 1);

-- 3. 同时使用用户ID和用户名（推荐方式）
INSERT INTO bo_blacklist (user_id, username, reason, type, operator_id, operator_name, start_time, end_time, status) 
VALUES (10003, 'user003', '多次违规', 'admin', 1, 'admin', NOW(), NOW() + INTERVAL '30 days', 1);

-- 4. 解除黑名单
UPDATE bo_blacklist SET status = 0, update_time = NOW() 
WHERE user_id = 10001 AND status = 1;
```

## 5. 全局配置 (bo_global_config)

### 5.1 表结构说明
全局配置表存储系统级的配置参数。

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|---------|
| id | bigint | 主键ID | 1 |
| config_key | varchar(64) | 配置键 | demo.bonus.amount |
| config_value | text | 配置值 | 10000 |
| config_type | varchar(32) | 配置类型 | DECIMAL |
| config_group | varchar(32) | 配置分组 | DEMO_BONUS |
| description | varchar(255) | 描述 | DEMO账户领取金额(USDT) |
| enabled | smallint | 是否启用 | 1 |
| sort_order | integer | 排序 | 1 |

### 5.2 DEMO账户配置示例
```sql
-- DEMO领取金额
INSERT INTO bo_global_config (config_key, config_value, config_type, config_group, description, enabled) 
VALUES ('demo.bonus.amount', '10000', 'DECIMAL', 'DEMO_BONUS', 'DEMO账户领取金额(USDT)', 1);

-- DEMO领取余额阈值
INSERT INTO bo_global_config (config_key, config_value, config_type, config_group, description, enabled) 
VALUES ('demo.bonus.max_balance', '1000', 'DECIMAL', 'DEMO_BONUS', 'DEMO账户余额低于此值才能领取(USDT)', 1);

-- DEMO多次领取开关
INSERT INTO bo_global_config (config_key, config_value, config_type, config_group, description, enabled) 
VALUES ('demo.bonus.allow_multiple', '0', 'BOOLEAN', 'DEMO_BONUS', '是否允许多次领取DEMO资金(1:允许 0:不允许)', 1);
```

## 6. 配置生效时间机制

### 6.1 缓存使用情况
目前系统中**所有配置项都不使用缓存**，采用实时数据库查询方式，具体情况如下：

### 6.2 配置生效时间说明
由于所有配置都**直接查询数据库**，配置变更的生效时间如下：

#### 6.2.1 实时生效配置
以下配置在数据库更新后立即生效：

1. **交易对配置 (bo_symbol_config)**
   - **生效方式**: 每次调用时实时查询数据库
   - **生效时间**: 数据库更新后立即生效
   - **影响范围**: 交易对启用/禁用、BTSE映射、金额限制等
   - **典型场景**: 启用/禁用交易对、修改BTSE映射关系

2. **风控配置 (bo_risk_config)**
   - **生效方式**: 每次下单时查询全部启用的风控配置
   - **生效时间**: 数据库更新后下一次风控检查时生效
   - **影响范围**: 单笔限额、周期限额、频率限制、轮次限制等
   - **典型场景**: 调整订单限额、修改风控规则

3. **黑名单配置 (bo_blacklist)**
   - **生效方式**: 每次下单时实时查询有效黑名单记录
   - **生效时间**: 数据库更新后立即生效
   - **影响范围**: 用户交易权限控制
   - **典型场景**: 添加/移除黑名单用户、修改限制期限

#### 6.2.2 延迟生效配置
以下配置存在一定延迟：

1. **时长配置 (bo_duration_config)**
   - **生效方式**: 轮次维护定时任务每分钟查询启用的配置
   - **生效时间**: 最多延迟1分钟（定时任务执行间隔）
   - **影响范围**: 新轮次创建、赔率设置、锁单时间等
   - **典型场景**: 添加新的交易时长、修改赔率参数
   - **相关任务**: `ScheduledTaskService.executeTradingRoundMaintenanceTask()` (每分钟第1秒执行)

2. **全局配置 (bo_global_config)**
   - **生效方式**: 根据具体使用场景而定
   - **DEMO账户配置**: 用户操作时实时查询，立即生效
   - **系统级配置**: 服务启动时加载或定时任务检查

### 6.3 配置优化
考虑到当前无缓存机制，会根据实际情况作以下优化：

1. **高频查询优化**: 对于SymbolService等高频调用的配置查询，可考虑添加短期缓存 (如5-10分钟TTL)
2. **风控配置缓存**: RiskControlService可使用1-2分钟TTL缓存，平衡性能和实时性
3. **配置变更通知**: 实现配置变更时的缓存失效机制，确保关键配置立即生效
4. **数据库性能**: 确保配置表有合适的索引，支持高并发查询

### 6.4 配置变更操作指南
修改配置后的验证步骤：

1. **立即生效类**: 可直接测试新配置是否生效
2. **延迟生效类**: 等待对应的定时任务执行周期或手动触发
3. **验证方式**: 通过日志、测试接口或实际业务操作确认配置已应用
