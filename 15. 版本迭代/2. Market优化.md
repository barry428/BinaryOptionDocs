# Market æœåŠ¡ä¼˜åŒ–æ–¹æ¡ˆ

## æ–‡æ¡£ä¿¡æ¯
- **åˆ›å»ºæ—¥æœŸ**: 2025-01-27
- **ç‰ˆæœ¬**: v1.0
- **çŠ¶æ€**: å¾…å®æ–½

## ç›®å½•
- [èƒŒæ™¯](#èƒŒæ™¯)
- [å½“å‰æ¶æ„](#å½“å‰æ¶æ„)
- [æ€§èƒ½ç“¶é¢ˆåˆ†æ](#æ€§èƒ½ç“¶é¢ˆåˆ†æ)
- [ä¼˜åŒ–æ–¹æ¡ˆ](#ä¼˜åŒ–æ–¹æ¡ˆ)
- [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)

---

## èƒŒæ™¯

### ä¸šåŠ¡åœºæ™¯
- **ç›®æ ‡ç”¨æˆ·é‡**: 500-1000 åŒæ—¶åœ¨çº¿ç”¨æˆ·
- **äº¤æ˜“å¯¹æ•°é‡**: 20 ä¸ªæ´»è·ƒ symbols
- **è®¢é˜…æ¨¡å¼**: æ¯ä¸ªç”¨æˆ·å¹³å‡è®¢é˜… 5 ä¸ª symbols
- **æ¨é€é¢‘ç‡**: æ¯ä¸ª symbol æ¯ç§’ 5-10 æ¡æ•°æ®

### æ€§èƒ½è¦æ±‚
- WebSocket æ¨é€å»¶è¿Ÿ < 100ms
- CPU å ç”¨ç‡ < 20%
- å•æœåŠ¡å™¨æ”¯æŒ 1000+ å¹¶å‘è¿æ¥

---

## å½“å‰æ¶æ„

### 1. WebSocket æ¶ˆæ¯å¤„ç†æµç¨‹

```
BTSE WebSocket æ•°æ®æº
    â†“
BtseWebSocketClient.onMessage
    â†“ (å…¥é˜Ÿï¼Œä¸é˜»å¡ I/O çº¿ç¨‹)
messageQueue (10000 å®¹é‡)
    â†“
processMessageQueue (4 ä¸ªå¼‚æ­¥çº¿ç¨‹)
    â†“
onExternalMarketData (è§£æã€è½¬æ¢)
    â†“
MarketWebSocketHandler.onBtseMarketData
    â†“
éå†æ‰€æœ‰ sessions (âŒ O(N) ç“¶é¢ˆ)
    â†“
æ¨é€ç»™è®¢é˜…çš„å®¢æˆ·ç«¯
```

### 2. æ ¸å¿ƒä»£ç ç»“æ„

**æ–‡ä»¶**: `option-market-service/src/main/java/com/binaryoption/marketservice/ws/MarketWebSocketHandler.java`

```java
// ä¼šè¯ç®¡ç†
private final Set<WebSocketSession> sessions = new CopyOnWriteArraySet<>();
private final Map<String, Set<String>> sessionSymbols = new ConcurrentHashMap<>();

// æ¨é€é€»è¾‘ (å½“å‰å®ç°)
private void onBtseMarketData(MarketTick marketTick) {
    String symbol = marketTick.getSymbol();
    String tickJson = objectMapper.writeValueAsString(marketTick);

    // âŒ é—®é¢˜ï¼šéå†æ‰€æœ‰ session
    for (WebSocketSession session : sessions) {  // O(N)
        Set<String> subscribedSymbols = sessionSymbols.get(session.getId());
        if (subscribedSymbols != null && subscribedSymbols.contains(symbol)) {
            queueMessage(session, tickJson);
        }
    }
}
```

---

## æ€§èƒ½ç“¶é¢ˆåˆ†æ

### 1. O(N) éå†é—®é¢˜

#### åœºæ™¯ï¼š1000 ç”¨æˆ·åœ¨çº¿

| æŒ‡æ ‡ | è®¡ç®— | ç»“æœ |
|------|------|------|
| å•æ¬¡æ¨é€éå† | 1000 sessions Ã— 0.001ms | 1ms |
| æ¯ç§’æ¨é€æ¬¡æ•° | 20 symbols Ã— 10 æ¡/ç§’ | 200 æ¬¡/ç§’ |
| **æ¯ç§’éå†æ€»è€—æ—¶** | 1ms Ã— 200 | **200ms** |
| **CPU å ç”¨** | 200ms / 1000ms | **20%** |

**é—®é¢˜**:
- âŒ CPU å ç”¨éšç”¨æˆ·æ•°çº¿æ€§å¢é•¿
- âŒ å¤§é‡æ— æ•ˆéå†ï¼ˆç”¨æˆ·æœªè®¢é˜…è¯¥ symbolï¼‰
- âŒ 1000 ç”¨æˆ·æ—¶å·²è¾¾ 20% CPUï¼Œæ‰©å±•æ€§å·®

### 2. æ€§èƒ½æµ‹è¯•æ•°æ®

| ç”¨æˆ·æ•° | CPU å ç”¨ | æ¨é€å»¶è¿Ÿ | å¯è¡Œæ€§ |
|--------|----------|----------|--------|
| 100 | 2% | < 10ms | âœ… å®Œå…¨å¯è¡Œ |
| 500 | 10% | < 50ms | âš ï¸ å¼€å§‹æœ‰å‹åŠ› |
| 1000 | 20% | < 100ms | âŒ ä¸¥é‡ç“¶é¢ˆ |
| 2000 | 40% | > 200ms | âŒ ä¸å¯æ¥å— |

---

## ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: åå‘ç´¢å¼•ä¼˜åŒ– â­â­â­â­â­

#### æ ¸å¿ƒæ€æƒ³
**å°† O(æ€»ç”¨æˆ·æ•°) é™ä½åˆ° O(è®¢é˜…è€…æ•°)**

```
ä¼˜åŒ–å‰: éå† 1000 ä¸ª sessionï¼Œæ‰¾å‡º 250 ä¸ªè®¢é˜…è€…
ä¼˜åŒ–å: ç›´æ¥è·å– 250 ä¸ªè®¢é˜…è€…
```

#### å®ç°æ–¹æ¡ˆ

##### 1.1 æ·»åŠ åå‘ç´¢å¼•

```java
// MarketWebSocketHandler.java

// æ–°å¢æ•°æ®ç»“æ„ï¼šsymbol -> sessions åå‘ç´¢å¼•
private final Map<String, Set<WebSocketSession>> symbolSubscribers = new ConcurrentHashMap<>();
```

##### 1.2 è®¢é˜…æ—¶æ›´æ–°ç´¢å¼•

```java
private void handleSubscribe(WebSocketSession session, String symbol) {
    symbol = symbol.trim().toUpperCase();

    Set<String> symbols = sessionSymbols.get(session.getId());
    if (symbols != null) {
        // 1. æ›´æ–° session -> symbols æ˜ å°„
        symbols.add(symbol);

        // 2. æ›´æ–° symbol -> sessions åå‘ç´¢å¼• â­ æ–°å¢
        symbolSubscribers.computeIfAbsent(symbol, k -> ConcurrentHashMap.newKeySet())
                         .add(session);

        // 3. è®¢é˜…ä¸Šæ¸¸æ•°æ®æº
        if (!btseMarketDataClient.isRunning()) {
            btseMarketDataClient.start();
            final String symbolToSubscribe = symbol;
            scheduler.schedule(() -> {
                if (btseMarketDataClient.isRunning()) {
                    btseMarketDataClient.subscribeSymbol(symbolToSubscribe);
                }
            }, 1000, TimeUnit.MILLISECONDS);
        } else {
            btseMarketDataClient.subscribeSymbol(symbol);
        }

        sendSubscriptionConfirmation(session, symbol);
        log.info("Session {} subscribed to: {}", session.getId(), symbol);
    }
}
```

##### 1.3 å–æ¶ˆè®¢é˜…æ—¶æ¸…ç†ç´¢å¼•

```java
private void handleUnsubscribe(WebSocketSession session, String symbol) {
    symbol = symbol.trim().toUpperCase();

    Set<String> symbols = sessionSymbols.get(session.getId());
    if (symbols != null) {
        // 1. ä» session è®¢é˜…åˆ—è¡¨ç§»é™¤
        symbols.remove(symbol);

        // 2. ä»åå‘ç´¢å¼•ä¸­ç§»é™¤ â­ æ–°å¢
        Set<WebSocketSession> subscribers = symbolSubscribers.get(symbol);
        if (subscribers != null) {
            subscribers.remove(session);

            // 3. å¦‚æœæ²¡æœ‰è®¢é˜…è€…äº†ï¼Œæ¸…ç†ç©ºé›†åˆ
            if (subscribers.isEmpty()) {
                symbolSubscribers.remove(symbol);
            }
        }

        sendUnsubscriptionConfirmation(session, symbol);
        log.info("Session {} unsubscribed from: {}", session.getId(), symbol);
    }
}
```

##### 1.4 ä¼˜åŒ–æ¨é€é€»è¾‘

```java
private void onBtseMarketData(MarketTick marketTick) {
    if (marketTick == null) {
        return;
    }

    String symbol = marketTick.getSymbol();

    // 1. å†™å…¥ Redis ç¼“å­˜
    try {
        marketTickCacheService.cacheMarketTick(marketTick);
        log.debug("Market tick cached: symbol={}", symbol);
    } catch (Exception e) {
        log.error("Failed to cache market tick: symbol={}", symbol, e);
    }

    // 2. ç›´æ¥è·å–è¯¥ symbol çš„è®¢é˜…è€… â­ O(1) æŸ¥æ‰¾
    Set<WebSocketSession> subscribers = symbolSubscribers.get(symbol);
    if (subscribers == null || subscribers.isEmpty()) {
        log.debug("No subscribers for symbol: {}", symbol);
        return; // æ— è®¢é˜…è€…ï¼Œç›´æ¥è¿”å›
    }

    // 3. é¢‘ç‡æ§åˆ¶
    long currentTime = System.currentTimeMillis();
    Long lastPush = lastPushTime.get(symbol);

    if (lastPush != null && (currentTime - lastPush) < pushIntervalMs) {
        log.trace("Skipping push for {} - interval not reached", symbol);
        return;
    }

    lastPushTime.put(symbol, currentTime);

    try {
        // 4. åºåˆ—åŒ–ä¸€æ¬¡ï¼Œå¤ç”¨ç»“æœ
        String tickJson = objectMapper.writeValueAsString(marketTick);

        // 5. åªéå†è®¢é˜…è€…ï¼Œä¸éå†æ‰€æœ‰ session â­ O(M) M=è®¢é˜…è€…æ•°é‡
        int pushCount = 0;
        for (WebSocketSession session : subscribers) {
            if (session.isOpen()) {
                queueMessage(session, tickJson);
                pushCount++;
            } else {
                // æ¸…ç†å·²å…³é—­çš„è¿æ¥
                cleanupSession(session);
            }
        }

        if (pushCount > 0) {
            log.debug("Pushed {} to {} subscribers", symbol, pushCount);
        }

    } catch (JsonProcessingException e) {
        log.error("Failed to serialize market data: {}", symbol, e);
    } catch (Exception e) {
        log.error("Failed to process market data: {}", symbol, e);
    }
}
```

##### 1.5 æ¸…ç† session æ—¶åŒæ­¥æ¸…ç†ç´¢å¼•

```java
private void cleanupSession(WebSocketSession session) {
    String sessionId = session.getId();

    // 1. ä» sessions é›†åˆç§»é™¤
    sessions.remove(session);

    // 2. è·å–è¯¥ session è®¢é˜…çš„æ‰€æœ‰ symbols
    Set<String> symbols = sessionSymbols.remove(sessionId);

    // 3. ä»åå‘ç´¢å¼•ä¸­æ¸…ç† â­ æ–°å¢
    if (symbols != null) {
        for (String symbol : symbols) {
            Set<WebSocketSession> subscribers = symbolSubscribers.get(symbol);
            if (subscribers != null) {
                subscribers.remove(session);

                // å¦‚æœè¯¥ symbol æ²¡æœ‰è®¢é˜…è€…äº†ï¼Œç§»é™¤ç©ºé›†åˆ
                if (subscribers.isEmpty()) {
                    symbolSubscribers.remove(symbol);
                    log.debug("No more subscribers for symbol: {}", symbol);
                }
            }
        }
    }

    log.info("Session cleaned up: {}, remaining sessions: {}", sessionId, sessions.size());
}
```

#### æ€§èƒ½æå‡

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **1000 ç”¨æˆ·** | éå† 1000 æ¬¡ | éå† 250 æ¬¡ | **4x** |
| **CPU å ç”¨** | 20% | 5% | **4x** |
| **æ¨é€å»¶è¿Ÿ** | 1ms | 0.25ms | **4x** |
| **æ‰©å±•æ€§** | çº¿æ€§å¢é•¿ | ä¸è®¢é˜…è€…æ•°ç›¸å…³ | **æ˜¾è‘—æå‡** |

---

### æ–¹æ¡ˆ 2: è®¢é˜…æ•°é‡é™åˆ¶ â­â­â­â­

#### ç›®çš„
é˜²æ­¢å•ä¸ªç”¨æˆ·è®¢é˜…è¿‡å¤š symbol å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½

#### å®ç°

```java
// MarketWebSocketHandler.java

// é…ç½®é¡¹
private static final int MAX_SUBSCRIPTIONS_PER_USER = 20;

private void handleSubscribe(WebSocketSession session, String symbol) {
    symbol = symbol.trim().toUpperCase();

    Set<String> symbols = sessionSymbols.get(session.getId());

    // æ£€æŸ¥è®¢é˜…æ•°é‡é™åˆ¶ â­
    if (symbols != null && symbols.size() >= MAX_SUBSCRIPTIONS_PER_USER) {
        String errorMsg = String.format(
            "{\"type\":\"error\",\"code\":\"SUBSCRIPTION_LIMIT\",\"message\":\"Maximum %d subscriptions per user exceeded\"}",
            MAX_SUBSCRIPTIONS_PER_USER
        );
        queueMessage(session, errorMsg);
        log.warn("User {} exceeded subscription limit: {}/{}",
                 session.getId(), symbols.size(), MAX_SUBSCRIPTIONS_PER_USER);
        return;
    }

    // ... æ­£å¸¸è®¢é˜…é€»è¾‘ ...
}
```

#### é…ç½®åŒ–

```yaml
# application.yml
websocket:
  market:
    max-subscriptions-per-user: 20  # æ¯ç”¨æˆ·æœ€å¤§è®¢é˜…æ•°
    push-interval: 1000  # æ¨é€é—´éš”ï¼ˆæ¯«ç§’ï¼‰
```

```java
@Value("${websocket.market.max-subscriptions-per-user:20}")
private int maxSubscriptionsPerUser;
```

---

### æ–¹æ¡ˆ 3: ç›‘æ§å‘Šè­¦ â­â­â­â­

#### å®ç°

```java
// MarketWebSocketHandler.java

@PostConstruct
public void init() {
    // ... ç°æœ‰åˆå§‹åŒ–ä»£ç  ...

    // å¯åŠ¨æ€§èƒ½ç›‘æ§ä»»åŠ¡
    scheduler.scheduleAtFixedRate(this::monitorPerformance, 10, 10, TimeUnit.SECONDS);
}

private void monitorPerformance() {
    int onlineUsers = sessions.size();
    int totalSubscriptions = sessionSymbols.values().stream()
                                           .mapToInt(Set::size)
                                           .sum();
    int queueSize = messageQueue.size();
    int activeSymbols = symbolSubscribers.size();

    log.info("WebSocket Stats: users={}, subscriptions={}, symbols={}, queue={}/{}",
             onlineUsers, totalSubscriptions, activeSymbols, queueSize, MAX_QUEUE_SIZE);

    // å‘Šè­¦é˜ˆå€¼æ£€æŸ¥
    if (onlineUsers > 800) {
        log.warn("âš ï¸ High user count: {} (threshold: 800)", onlineUsers);
    }

    if (queueSize > MAX_QUEUE_SIZE * 0.8) {
        log.error("ğŸ”´ Message queue nearly full: {}/{} ({}%)",
                  queueSize, MAX_QUEUE_SIZE, (queueSize * 100 / MAX_QUEUE_SIZE));
    }

    if (totalSubscriptions > onlineUsers * 10) {
        log.warn("âš ï¸ High subscription rate: {} subscriptions for {} users (avg: {})",
                 totalSubscriptions, onlineUsers, totalSubscriptions / Math.max(1, onlineUsers));
    }
}

// æä¾›æ€§èƒ½æŒ‡æ ‡æŸ¥è¯¢æ¥å£ï¼ˆç”¨äºç›‘æ§ç³»ç»Ÿé›†æˆï¼‰
public Map<String, Object> getPerformanceMetrics() {
    Map<String, Object> metrics = new HashMap<>();
    metrics.put("onlineUsers", sessions.size());
    metrics.put("totalSubscriptions", sessionSymbols.values().stream().mapToInt(Set::size).sum());
    metrics.put("activeSymbols", symbolSubscribers.size());
    metrics.put("queueSize", messageQueue.size());
    metrics.put("queueCapacity", MAX_QUEUE_SIZE);
    metrics.put("queueUsagePercent", (messageQueue.size() * 100.0 / MAX_QUEUE_SIZE));
    return metrics;
}
```

#### ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | å‘Šè­¦é˜ˆå€¼ | è¯´æ˜ |
|------|----------|----------|------|
| onlineUsers | < 800 | > 800 | åœ¨çº¿ç”¨æˆ·æ•° |
| queueSize | < 5000 | > 8000 | æ¶ˆæ¯é˜Ÿåˆ—ç§¯å‹ |
| queueUsagePercent | < 50% | > 80% | é˜Ÿåˆ—ä½¿ç”¨ç‡ |
| avgSubscriptions | < 10 | > 15 | äººå‡è®¢é˜…æ•° |

---

### æ–¹æ¡ˆ 4: æ¶ˆæ¯é˜Ÿåˆ—æ‰©å®¹ â­â­â­

#### è°ƒæ•´é˜Ÿåˆ—å®¹é‡

```java
// MarketWebSocketHandler.java

// å½“å‰é…ç½®
private static final int MAX_QUEUE_SIZE = 10000;

// ä¼˜åŒ–åé…ç½®ï¼ˆ1000 ç”¨æˆ·åœºæ™¯ï¼‰
private static final int MAX_QUEUE_SIZE = 50000;  // 5 å€ç¼“å†²
```

#### å®¹é‡è®¡ç®—

```
åœºæ™¯: 1000 ç”¨æˆ· Ã— 5 è®¢é˜…/ç”¨æˆ· = 5000 è®¢é˜…å…³ç³»
æ¨é€é€Ÿç‡: 20 symbols Ã— 10 æ¡/ç§’ = 200 æ¡/ç§’
æ¯æ¡æ¶ˆæ¯æ¨é€ç»™: 5000 è®¢é˜… / 20 symbols = 250 ç”¨æˆ·

æ¯ç§’äº§ç”Ÿæ¶ˆæ¯: 200 æ¡ Ã— 250 ç”¨æˆ· = 50000 æ¡/ç§’
æ¶ˆè´¹é€Ÿç‡: å–å†³äºå‘é€çº¿ç¨‹æ•°

é˜Ÿåˆ—å®¹é‡è®¾è®¡: è‡³å°‘èƒ½ç¼“å†² 1 ç§’çš„æ•°æ®
æ¨èå®¹é‡: 50000 (1 ç§’ç¼“å†²)
```

---

### æ–¹æ¡ˆ 5: çº¿ç¨‹æ± è°ƒä¼˜ â­â­â­

#### Tomcat è¿æ¥æ± é…ç½®

```yaml
# application.yml
server:
  tomcat:
    threads:
      max: 500        # æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ”¯æŒ 1000+ WebSocket è¿æ¥ï¼‰
      min-spare: 50   # æœ€å°ç©ºé—²çº¿ç¨‹
    max-connections: 2000   # æœ€å¤§è¿æ¥æ•°
    accept-count: 200       # ç­‰å¾…é˜Ÿåˆ—é•¿åº¦
    connection-timeout: 20000  # è¿æ¥è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
```

#### æ¶ˆæ¯å¤„ç†çº¿ç¨‹æ± 

```java
// MarketWebSocketHandler.java

// å½“å‰é…ç½®
private static final int MESSAGE_PROCESSOR_THREADS = 4;

// 1000 ç”¨æˆ·åœºæ™¯å»ºè®®
private static final int MESSAGE_PROCESSOR_THREADS = 8;  // å¢åŠ åˆ° 8 ä¸ªçº¿ç¨‹
```

---

## å®æ–½è®¡åˆ’

### é˜¶æ®µ 1: æ ¸å¿ƒä¼˜åŒ–ï¼ˆå¿…é¡»å®æ–½ï¼‰â­â­â­â­â­

**ä¼˜å…ˆçº§**: P0 - æœ€é«˜
**é¢„è®¡å·¥æœŸ**: 2 å¤©

#### ä»»åŠ¡æ¸…å•
- [ ] 1.1 æ·»åŠ åå‘ç´¢å¼•æ•°æ®ç»“æ„ (`symbolSubscribers`)
- [ ] 1.2 ä¿®æ”¹ `handleSubscribe` æ–¹æ³•æ›´æ–°åå‘ç´¢å¼•
- [ ] 1.3 ä¿®æ”¹ `handleUnsubscribe` æ–¹æ³•æ¸…ç†åå‘ç´¢å¼•
- [ ] 1.4 ä¼˜åŒ– `onBtseMarketData` æ¨é€é€»è¾‘
- [ ] 1.5 ä¿®æ”¹ `cleanupSession` åŒæ­¥æ¸…ç†ç´¢å¼•
- [ ] 1.6 å•å…ƒæµ‹è¯•ï¼šéªŒè¯ç´¢å¼•ä¸€è‡´æ€§
- [ ] 1.7 æ€§èƒ½æµ‹è¯•ï¼šå¯¹æ¯”ä¼˜åŒ–å‰åæ€§èƒ½

#### éªŒæ”¶æ ‡å‡†
- âœ… 1000 ç”¨æˆ·åœºæ™¯ä¸‹ CPU å ç”¨ < 10%
- âœ… æ¨é€å»¶è¿Ÿ < 50ms
- âœ… æ— å†…å­˜æ³„æ¼ï¼ˆç´¢å¼•æ­£ç¡®æ¸…ç†ï¼‰

---

### é˜¶æ®µ 2: é™æµä¿æŠ¤ï¼ˆé‡è¦ï¼‰â­â­â­â­

**ä¼˜å…ˆçº§**: P1 - é«˜
**é¢„è®¡å·¥æœŸ**: 1 å¤©

#### ä»»åŠ¡æ¸…å•
- [ ] 2.1 å®ç°è®¢é˜…æ•°é‡é™åˆ¶ï¼ˆMAX_SUBSCRIPTIONS_PER_USERï¼‰
- [ ] 2.2 é…ç½®åŒ–å‚æ•°ï¼ˆapplication.ymlï¼‰
- [ ] 2.3 é”™è¯¯æ¶ˆæ¯è¿”å›ç»™å®¢æˆ·ç«¯
- [ ] 2.4 å‰ç«¯é€‚é…ï¼šå¤„ç†è®¢é˜…é™åˆ¶é”™è¯¯

#### éªŒæ”¶æ ‡å‡†
- âœ… å•ç”¨æˆ·æœ€å¤šè®¢é˜… 20 ä¸ª symbols
- âœ… è¶…å‡ºé™åˆ¶æ—¶è¿”å›å‹å¥½é”™è¯¯æ¶ˆæ¯
- âœ… å‰ç«¯æ­£ç¡®å¤„ç†é”™è¯¯æç¤º

---

### é˜¶æ®µ 3: ç›‘æ§å‘Šè­¦ï¼ˆé‡è¦ï¼‰â­â­â­â­

**ä¼˜å…ˆçº§**: P1 - é«˜
**é¢„è®¡å·¥æœŸ**: 1 å¤©

#### ä»»åŠ¡æ¸…å•
- [ ] 3.1 å®ç°æ€§èƒ½ç›‘æ§å®šæ—¶ä»»åŠ¡
- [ ] 3.2 å®šä¹‰å‘Šè­¦é˜ˆå€¼
- [ ] 3.3 æ—¥å¿—è¾“å‡ºæ ¼å¼åŒ–
- [ ] 3.4 é›†æˆåˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheus/Grafanaï¼‰
- [ ] 3.5 å‘Šè­¦é€šçŸ¥ï¼ˆé‚®ä»¶/é’‰é’‰ï¼‰

#### éªŒæ”¶æ ‡å‡†
- âœ… æ¯ 10 ç§’è¾“å‡ºæ€§èƒ½æŒ‡æ ‡
- âœ… è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘å‘Šè­¦
- âœ… å¯è§†åŒ–ç›‘æ§é¢æ¿

---

### é˜¶æ®µ 4: å®¹é‡æ‰©å±•ï¼ˆä¼˜åŒ–ï¼‰â­â­â­

**ä¼˜å…ˆçº§**: P2 - ä¸­
**é¢„è®¡å·¥æœŸ**: 0.5 å¤©

#### ä»»åŠ¡æ¸…å•
- [ ] 4.1 æ‰©å¤§æ¶ˆæ¯é˜Ÿåˆ—å®¹é‡ï¼ˆ10000 â†’ 50000ï¼‰
- [ ] 4.2 å¢åŠ æ¶ˆæ¯å¤„ç†çº¿ç¨‹ï¼ˆ4 â†’ 8ï¼‰
- [ ] 4.3 è°ƒä¼˜ Tomcat è¿æ¥æ± é…ç½®
- [ ] 4.4 å‹åŠ›æµ‹è¯•éªŒè¯

#### éªŒæ”¶æ ‡å‡†
- âœ… æ”¯æŒ 1000+ å¹¶å‘è¿æ¥
- âœ… æ¶ˆæ¯é˜Ÿåˆ—æ— æº¢å‡º

---

## æµ‹è¯•éªŒè¯

### æ€§èƒ½æµ‹è¯•åœºæ™¯

#### åœºæ™¯ 1: åŸºå‡†æµ‹è¯•
- **ç”¨æˆ·æ•°**: 100
- **è®¢é˜…æ•°**: æ¯ç”¨æˆ· 5 ä¸ª symbols
- **é¢„æœŸ**: CPU < 2%, å»¶è¿Ÿ < 10ms

#### åœºæ™¯ 2: ç›®æ ‡è´Ÿè½½
- **ç”¨æˆ·æ•°**: 1000
- **è®¢é˜…æ•°**: æ¯ç”¨æˆ· 5 ä¸ª symbols
- **é¢„æœŸ**: CPU < 10%, å»¶è¿Ÿ < 50ms

#### åœºæ™¯ 3: å‹åŠ›æµ‹è¯•
- **ç”¨æˆ·æ•°**: 2000
- **è®¢é˜…æ•°**: æ¯ç”¨æˆ· 10 ä¸ª symbols
- **é¢„æœŸ**: CPU < 20%, å»¶è¿Ÿ < 100ms

### æµ‹è¯•å·¥å…·
- **WebSocket å‹æµ‹**: `wscat`, `Artillery`
- **æ€§èƒ½ç›‘æ§**: `JProfiler`, `VisualVM`
- **ç³»ç»Ÿç›‘æ§**: `htop`, `Prometheus`

---

## å›æ»šæ–¹æ¡ˆ

### é£é™©è¯„ä¼°
- **å…¼å®¹æ€§é£é™©**: ä½ï¼ˆä»…ä¼˜åŒ–å†…éƒ¨å®ç°ï¼Œä¸æ”¹å˜æ¥å£ï¼‰
- **æ•°æ®é£é™©**: ä½ï¼ˆæ— æ•°æ®åº“å˜æ›´ï¼‰
- **æ€§èƒ½é£é™©**: ä¸­ï¼ˆå¯èƒ½å¼•å…¥æ–°çš„æ€§èƒ½é—®é¢˜ï¼‰

### å›æ»šæ­¥éª¤
1. ä¿ç•™ä¼˜åŒ–å‰çš„ä»£ç åˆ†æ”¯ `feature/market-optimization-backup`
2. å¦‚å‘ç°é—®é¢˜ï¼Œä½¿ç”¨ `git revert` å›é€€æäº¤
3. é‡å¯æœåŠ¡æ¢å¤åˆ°ä¼˜åŒ–å‰ç‰ˆæœ¬

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `option-market-service/src/main/java/com/binaryoption/marketservice/ws/MarketWebSocketHandler.java` | æ ¸å¿ƒä¼˜åŒ–æ–‡ä»¶ |
| `option-market-service/src/main/java/com/binaryoption/marketservice/integration/BtseWebSocketClient.java` | ä¸Šæ¸¸æ•°æ®å¤„ç† |
| `option-market-service/src/main/resources/application.yml` | é…ç½®æ–‡ä»¶ |

### B. æ€§èƒ½å¯¹æ¯”æ•°æ®

#### ä¼˜åŒ–å‰
```
1000 ç”¨æˆ·åœºæ™¯:
- æ¨é€éå†: 1000 æ¬¡/æ¨é€
- CPU å ç”¨: 20%
- æ¨é€å»¶è¿Ÿ: 1ms
- æ‰©å±•æ€§: âŒ å·®ï¼ˆçº¿æ€§å¢é•¿ï¼‰
```

#### ä¼˜åŒ–å
```
1000 ç”¨æˆ·åœºæ™¯:
- æ¨é€éå†: 250 æ¬¡/æ¨é€
- CPU å ç”¨: 5%
- æ¨é€å»¶è¿Ÿ: 0.25ms
- æ‰©å±•æ€§: âœ… å¥½ï¼ˆä¸è®¢é˜…è€…æ•°ç›¸å…³ï¼‰
```

### C. å‚è€ƒèµ„æ–™
- [WebSocket æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](https://web.dev/websockets/)
- [Spring WebSocket æ–‡æ¡£](https://docs.spring.io/spring-framework/reference/web/websocket.html)
- [é«˜æ€§èƒ½ WebSocket æœåŠ¡å™¨è®¾è®¡](https://www.nginx.com/blog/websocket-nginx/)

---

## æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| 2025-01-27 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡ |
