# TGW-3ï¼šäºŒå…ƒæœŸæƒé£é™©æ§åˆ¶å¢å¼º - æŠ€æœ¯è®¾è®¡ v1.10

**é¡¹ç›®**ï¼šäºŒå…ƒæœŸæƒç¬¬ä¸€é˜¶æ®µå¢å¼º
**è¦æ±‚ ID**ï¼šTGW-3
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.10ï¼ˆæ ‡å‡†åŒ–ç»“æ„ï¼‰
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-12-24
**ä¿®è®¢æ—¥æœŸ**ï¼š2025-12-25
**æ‰€æœ‰è€…**ï¼šå¼€å‘å›¢é˜Ÿ

---

## ç‰ˆæœ¬å†å²

### v1.10 æ–‡æ¡£æ ‡å‡†åŒ– â­
- é‡æ–°ç»„ç»‡æ–‡æ¡£ç»“æ„ä»¥éµå¾ªæŠ€æœ¯æ–‡æ¡£æ ‡å‡†
- æŒ‰åŠŸèƒ½æ¨¡å—åˆ†ç»„æ¶æ„è®¾è®¡
- è¡¨ç»“æ„æ¶æ„ä¸è¡¨ç»“æ„è®¾è®¡åˆ†ç¦»
- æŒ‰åŠŸèƒ½æ¨¡å—é‡æ–°ç»„ç»‡æ•°æ®æµè®¾è®¡
- ä¿ç•™ v1.9 çš„æ‰€æœ‰æŠ€æœ¯å†…å®¹

### v1.9 å®šæ—¶æ‰«ææ¨¡å¼â­ï¼ˆç»§æ‰¿ï¼‰
- è¿èƒœæ£€æµ‹ä»äº‹ä»¶é©±åŠ¨æ”¹ä¸ºè®¡åˆ’ä»»åŠ¡æ‰«æ
- ä¸è®¢å•ä¸šåŠ¡é€»è¾‘è§£è€¦
- æ‰«æé—´éš”ï¼š30ç§’
- æ–°ç»“ç®—è®¢å•å¢é‡æ‰«ææœºåˆ¶

### v1.8 é»‘åå•æ¨¡å¼ï¼ˆç»§æ‰¿ï¼‰
- åˆ›å»ºè®¢å•ä»…æ£€æŸ¥ï¼šé»‘åå•+å¸‚åœºæš‚åœ+IP/è®¾å¤‡æŒ‡çº¹
- å®šæ—¶ä»»åŠ¡æ£€æµ‹åˆ°çš„å…¶ä»–é£æ§ç­–ç•¥
- é£é™©ç­–ç•¥è§¦å‘é»‘åå•æ’å…¥
- é€šè¿‡æœ€å°‘çš„æ£€æŸ¥ç®€åŒ–è®¢å•åˆ›å»ºæµç¨‹

---

## ç›®å½•

- [1. éœ€æ±‚æ¦‚è¿°](#1-éœ€æ±‚æ¦‚è¿°)
  - [1.1 è¦æ±‚è¯¦æƒ…](#11-è¦æ±‚è¯¦æƒ…)
- [2. æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
  - [2.1 æ—¥ç›ˆæ§æ¶æ„](#21-æ—¥ç›ˆæ§æ¶æ„)
  - [2.2 è¿èƒœæ§åˆ¶æ¶æ„](#22-è¿èƒœæ§åˆ¶æ¶æ„)
  - [2.3 é«˜èƒœç‡æ§åˆ¶æ¶æ„](#23-é«˜èƒœç‡æ§åˆ¶æ¶æ„)
  - [2.4 é«˜é¢‘äº¤æ˜“æ§åˆ¶æ¶æ„](#24-é«˜é¢‘äº¤æ˜“æ§åˆ¶æ¶æ„)
  - [2.5 IPå¤šè´¦æˆ·æ§åˆ¶æ¶æ„](#25-ipå¤šè´¦æˆ·æ§åˆ¶æ¶æ„)
  - [2.6 å¸‚åœºæ³¢åŠ¨æ§åˆ¶æ¶æ„](#26-å¸‚åœºæ³¢åŠ¨æ§åˆ¶æ¶æ„)
- [3. è¡¨ç»“æ„æ¶æ„](#3-è¡¨ç»“æ„æ¶æ„)
  - [3.1 æ—¥åˆ©æ¶¦è¡¨ç»“æ„](#31-æ—¥åˆ©æ¶¦è¡¨ç»“æ„)
  - [3.2 è¿èƒœè¡¨ç»“æ„](#32-è¿èƒœè¡¨ç»“æ„)
  - [3.3 é«˜èƒœç‡è¡¨ç»“æ„](#33-é«˜èƒœç‡è¡¨ç»“æ„)
  - [3.4 é«˜é¢‘è¡¨ç»“æ„](#34-é«˜é¢‘è¡¨ç»“æ„)
  - [3.5 å¸‚åœºåœç‰Œè¡¨ç»“æ„](#35-å¸‚åœºåœç‰Œè¡¨ç»“æ„)
- [4. æ•°æ®æµè®¾è®¡](#4-æ•°æ®æµè®¾è®¡)
  - [4.1 è®¢å•åˆ›å»ºé£é™©æ£€æŸ¥æµç¨‹](#41-è®¢å•åˆ›å»ºé£é™©æ£€æŸ¥æµç¨‹)
  - [4.2 è¿èƒœæ£€æµ‹æµç¨‹](#42-è¿èƒœæ£€æµ‹æµç¨‹)
  - [4.3 æ¯æ—¥ç›ˆåˆ©æ£€æµ‹æµç¨‹](#43-æ¯æ—¥ç›ˆåˆ©æ£€æµ‹æµç¨‹)
  - [4.4 é«˜èƒœç‡æ£€æµ‹æµç¨‹](#44-é«˜èƒœç‡æ£€æµ‹æµç¨‹)
  - [4.5 é«˜é¢‘æ£€æµ‹æµç¨‹](#45-é«˜é¢‘æ£€æµ‹æµç¨‹)
  - [4.6 IPå¤šè´¦å·æ£€æµ‹æµç¨‹](#46-ipå¤šè´¦å·æ£€æµ‹æµç¨‹)
  - [4.7 å¸‚åœºæ³¢åŠ¨æ£€æµ‹æµç¨‹](#47-å¸‚åœºæ³¢åŠ¨æ£€æµ‹æµç¨‹)
- [5. è¡¨ç»“æ„è®¾è®¡](#5-è¡¨ç»“æ„è®¾è®¡)
  - [5.1 æ•°æ®åº“å˜æ›´æ€»ç»“](#51-æ•°æ®åº“å˜æ›´æ€»ç»“)
  - [5.2 æ–°çš„è¡¨ç»“æ„](#52-æ–°çš„è¡¨ç»“æ„)
  - [5.3 æ‰©å±•è¡¨ç»“æ„](#53-æ‰©å±•è¡¨ç»“æ„)
  - [5.4 é…ç½®æ•°æ®åˆå§‹åŒ–](#54-é…ç½®æ•°æ®åˆå§‹åŒ–)
- [6. ä¸šåŠ¡æµç¨‹è®¾è®¡](#6-ä¸šåŠ¡æµç¨‹è®¾è®¡)
  - [6.1 è®¾å¤‡æŒ‡çº¹é‡‡é›†](#61-è®¾å¤‡æŒ‡çº¹é‡‡é›†)
  - [6.2 Redisæ•°æ®ç»“æ„](#62-redisæ•°æ®ç»“æ„)
  - [6.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#63-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
- [7. è®¡åˆ’ä»»åŠ¡è®¾è®¡](#7-è®¡åˆ’ä»»åŠ¡è®¾è®¡)
  - [7.1 ä»»åŠ¡åˆ—è¡¨](#71-ä»»åŠ¡åˆ—è¡¨)
  - [7.2 ä»»åŠ¡æ‰§è¡Œæµç¨‹](#72-ä»»åŠ¡æ‰§è¡Œæµç¨‹)

---

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 è¦æ±‚è¯¦æƒ…

#### åˆ†ç±»å›¾

```mermaid
graph TB
    A[TGW-3 é£é™©æ§åˆ¶] --> B[äº¤æ˜“é£é™©æ§åˆ¶]
    A --> C[ç³»ç»Ÿé£é™©æ§åˆ¶]
    A --> D[å¸‚åœºé£é™©æ§åˆ¶]

    B --> B1[1.1 æ¯æ—¥åˆ©æ¶¦é™é¢ v1.4âœ“]
    B --> B2[1.2 è¿èƒœé”å®š â­v1.9]
    B --> B3[1.3 é«˜èƒœç‡æ£€æµ‹ v1.4âœ“]
    B --> B4[1.4 é«˜é¢‘äº¤æ˜“ v1.4âœ“]

    C --> C1[2.1 IPå¤šè´¦æˆ·æ£€æµ‹ v1.2âœ“]

    D --> D1[3.1 å¸‚åœºæ³¢åŠ¨ä¿æŠ¤ v1.2âœ“]

    style B1 fill:#9f9
    style B2 fill:#ff9
    style B3 fill:#9f9
    style B4 fill:#9f9
    style C1 fill:#9f9
    style D1 fill:#9f9
```

---

#### ğŸ“Š è¦æ±‚1.1ï¼šæ¯æ—¥åˆ©æ¶¦é™é¢ï¼ˆv1.4+ï¼‰

**è§¦å‘æ¡ä»¶**ï¼šç”¨æˆ·24å°æ—¶å‡€åˆ©æ¶¦â‰¥+10,000 USDTï¼ˆæ»šåŠ¨çª—å£ï¼‰

**è¡ŒåŠ¨**ï¼š
- ç«‹å³æš‚åœç”¨æˆ·æŠ•æ³¨
- è‡ªåŠ¨æ·»åŠ åˆ°é»‘åå•
- æ‰‹åŠ¨è§£é”åé‡æ–°è®¡ç®—åˆ©æ¶¦

**è®¡ç®—æ–¹æ³•** â­v1.5ï¼š
- åŸºäºè®¢å•`profit`å­—æ®µå€¼ï¼ˆå·²è§£å†³æ ‡å¿—ï¼‰
- æŸ¥è¯¢æ¡ä»¶ï¼š`WHERE profit IS NOT NULL`
- 24å°æ—¶æ»šåŠ¨æ»‘åŠ¨çª—å£
- çª—å£éšæ—¶é—´ä¸æ–­æ›´æ–°

**é…ç½®**ï¼š
```sql
('DAILY_PROFIT_LIMIT', '10000.00', 'NUMBER', 'Daily profit limit (USDT)', 1),
('DAILY_PROFIT_CHECK_ENABLE', 'true', 'BOOLEAN', 'Enable daily profit check', 1),
('DAILY_PROFIT_BLACKLIST_DAYS', '7', 'NUMBER', 'Blacklist days for profit limit', 1),
('DAILY_PROFIT_ROLLING_HOURS', '24', 'NUMBER', 'Profit rolling window (hours)', 1)
```

---

#### ğŸ¯è¦æ±‚1.2ï¼šè¿èƒœé”å®šâ­v1.9

**è§¦å‘æ¡ä»¶**ï¼šç”¨æˆ·è¿èƒœâ‰¥8åœº

**è¡ŒåŠ¨**ï¼š
- è‡ªåŠ¨æ·»åŠ åˆ°é»‘åå•
- æš‚åœæ–°æŠ•æ³¨
- éœ€è¦äººå·¥å®¡æ ¸æ‰èƒ½è§£é”

**æ£€æµ‹æ–¹æ³•** â­v1.9ï¼š
- **è®¡åˆ’ä»»åŠ¡æ‰«æ**ï¼šæ¯ 30 ç§’ä¸€æ¬¡
- **å¢é‡å¤„ç†**ï¼šä»…å¤„ç†è‡ªä¸Šæ¬¡æ‰«æä»¥æ¥æ–°ç»“ç®—çš„è®¢å•
- **æ‰¹å¤„ç†**ï¼šæ¯æ¬¡æ‰«ææœ€å¤š 1000 ä¸ªç”¨æˆ·
- **æ— ä¸šåŠ¡å…¥ä¾µ**ï¼šè®¢å•ç»“ç®—è¿‡ç¨‹å®Œå…¨æ— æ„ŸçŸ¥æ£€æµ‹

**è®¡ç®—é€»è¾‘**ï¼š
- æŒ‰ç”¨æˆ·+è´¦æˆ·ç±»å‹å¯¹å¢é‡è®¢å•è¿›è¡Œåˆ†ç»„
- æŒ‰è®¢å•IDé¡ºåºæŸ¥çœ‹ç»“æœï¼ˆæ—¶é—´é¡ºåºï¼‰
- è¿ç»­è·èƒœå¢åŠ è®¡æ•°ï¼Œå¤±è´¥/å¹³å±€é‡ç½®ä¸º 0
- è¾¾åˆ°8èƒœç«‹å³æ’å…¥é»‘åå•

**é…ç½®**ï¼š
```sql
('WIN_STREAK_LIMIT', '8', 'NUMBER', 'Win streak blacklist threshold', 1),
('WIN_STREAK_CHECK_ENABLE', 'true', 'BOOLEAN', 'Enable win streak check', 1),
('WIN_STREAK_BLACKLIST_DAYS', '7', 'NUMBER', 'Blacklist days for win streak', 1),
-- â­v1.9 New Configuration
('WIN_STREAK_SCAN_INTERVAL', '30', 'NUMBER', 'Win streak scan interval (seconds)', 1),
('WIN_STREAK_BATCH_SIZE', '1000', 'NUMBER', 'Max users per scan', 1),
('WIN_STREAK_ORDER_LIMIT', '100', 'NUMBER', 'Max orders per user per scan', 1)
```

---

#### ğŸ¯è¦æ±‚1.3ï¼šé«˜èƒœç‡æ£€æµ‹ï¼ˆv1.4+ï¼‰

**è§¦å‘æ¡ä»¶**ï¼šç”¨æˆ·èƒœç‡>70%ï¼ˆæ ·æœ¬é‡åœ¨é…ç½®èŒƒå›´å†…ï¼Œè®¢å•é‡‘é¢æ»¡è¶³æœ€ä½è¦æ±‚ï¼‰

**æ ·æœ¬å¤§å°æ§åˆ¶**ï¼š
- **ä¸‹é™**ï¼š10 ä¸ªè®¢å•ï¼ˆå¯é…ç½®ï¼‰- å¦‚æœä½äºåˆ™ä¸æ£€æµ‹
- **ä¸Šé™**ï¼š100 ä¸ªè®¢å•ï¼ˆå¯é…ç½®ï¼‰- æ¥å—æœ€è¿‘çš„ä¸Šé™è®¢å•

**æ•°é‡æ§åˆ¶**ï¼š
- **æœ€ä½é‡‘é¢**ï¼š10 USDTï¼ˆå¯é…ç½®ï¼‰- ä»…è®¡ç®—â‰¥æœ€ä½é‡‘é¢çš„è®¢å•
- **ç›®çš„**ï¼šè¿‡æ»¤å°æµ‹è¯•è®¢å•ï¼Œé¿å…è¯¯æŠ¥

**å›ºå®šæ ‡å¿—** â­v1.5ï¼š
- **å¥åº·ï¼‰çŠ¶å†µ**ï¼š`profit IS NOT NULL`
- **è¯´æ˜**ï¼šæœ‰æ•°å€¼çš„åˆ©æ¶¦å­—æ®µè¡¨ç¤ºå·²ç»“ç®—è®¢å•

**è®¡ç®—å…¬å¼**ï¼š
```sql
-- Valid order query conditions
WHERE profit IS NOT NULL              -- Settled orders â­v1.5
  AND amount >= MIN_BET_AMOUNT        -- Amount filter

-- Win rate calculation
Win Rate = Win Orders / Total Valid Orders
Sample Orders = Most Recent [lower_limit, upper_limit] valid orders
```

**è¡ŒåŠ¨**ï¼š
- è‡ªåŠ¨æ·»åŠ åˆ°é»‘åå•
- æš‚åœæ–°æŠ•æ³¨

**é…ç½®**ï¼š
```sql
('HIGH_WINRATE_THRESHOLD', '70.0', 'NUMBER', 'High win rate threshold (%)', 1),
('HIGH_WINRATE_SAMPLE_SIZE_MIN', '10', 'NUMBER', 'Min sample size', 1),
('HIGH_WINRATE_SAMPLE_SIZE_MAX', '100', 'NUMBER', 'Max sample size', 1),
('HIGH_WINRATE_MIN_BET_AMOUNT', '10.0', 'NUMBER', 'Min bet amount (USDT)', 1),
('HIGH_WINRATE_CHECK_ENABLE', 'true', 'BOOLEAN', 'Enable win rate check', 1),
('HIGH_WINRATE_BLACKLIST_DAYS', '7', 'NUMBER', 'Blacklist days', 1)
```

---

#### âš¡ è¦æ±‚1.4ï¼šé«˜é¢‘äº¤æ˜“æ£€æµ‹ï¼ˆv1.4+ï¼‰

**è§¦å‘æ¡ä»¶**ï¼šç”¨æˆ·1åˆ†é’Ÿä¸‹å•â‰¥20å•

**è¡ŒåŠ¨**ï¼š
- **æ¨¡å¼ 1**ï¼šä»…é€Ÿç‡é™åˆ¶ï¼ˆé»˜è®¤ï¼‰- 60 ç§’å†·å´æ—¶é—´
- **æ¨¡å¼2**ï¼šè‡ªåŠ¨é»‘åå•ï¼ˆå¯é…ç½®ï¼‰

**é…ç½®**ï¼š
```sql
('HIGH_FREQUENCY_THRESHOLD', '20', 'NUMBER', 'Orders per minute threshold', 1),
('HIGH_FREQUENCY_TIME_WINDOW', '60', 'NUMBER', 'Time window (seconds)', 1),
('HIGH_FREQUENCY_CHECK_ENABLE', 'true', 'BOOLEAN', 'Enable frequency check', 1),
('HIGH_FREQUENCY_AUTO_BLACKLIST', 'false', 'BOOLEAN', 'Auto blacklist (false=rate limit only)', 1),
('HIGH_FREQUENCY_BLACKLIST_DAYS', '3', 'NUMBER', 'Blacklist days', 1),
('HIGH_FREQUENCY_COOLDOWN_SECONDS', '60', 'NUMBER', 'Cooldown time (seconds)', 1)
```

---

#### ğŸ–¥ï¸éœ€æ±‚2.1ï¼šIPå¤šè´¦æˆ·æ£€æµ‹ï¼ˆv1.2ï¼‰

**è§¦å‘æ¡ä»¶**ï¼šç›¸åŒIPåœ°å€ï¼Œ1å°æ—¶æŠ•æ³¨æ¬¡æ•°â‰¥500ï¼Œæ¥è‡ªâ‰¥3ä¸ªä¸åŒè®¾å¤‡æŒ‡çº¹

**è¡ŒåŠ¨**ï¼š
- ç«‹å³é˜»æ­¢å½“å‰è®¢å•
- è‡ªåŠ¨å°†IPåŠ å…¥é»‘åå•
- è¯¥IPä¸‹æ‰€æœ‰ç”¨æˆ·æš‚åœæŠ•æ³¨

**æ£€æµ‹æ–¹æ³•**ï¼š
- è®¢å•åˆ›å»ºè¿‡ç¨‹å®æ—¶æ£€æµ‹ï¼ˆRedisç»Ÿè®¡ï¼‰
- è®¡ç®—æ¯ä¸ª IP å’Œè®¾å¤‡æŒ‡çº¹é›†çš„èµŒæ³¨
- æ»‘åŠ¨ 1 å°æ—¶çª—å£
- è®¾å¤‡æŒ‡çº¹å»é‡

**è®¾å¤‡æŒ‡çº¹é‡‡é›†**ï¼š
- å‰ç«¯ä½¿ç”¨ FingerprintJS åº“
- é€šè¿‡ HTTP æ ‡å¤´ä¼ é€’`X-Device-Fingerprint`
- åç«¯éªŒè¯å’Œå­˜å‚¨

**é…ç½®**ï¼š
```sql
('IP_MULTI_ACCOUNT_BET_THRESHOLD', '500', 'NUMBER', 'IP bet count threshold', 1),
('IP_MULTI_ACCOUNT_DEVICE_THRESHOLD', '3', 'NUMBER', 'IP device count threshold', 1),
('IP_MULTI_ACCOUNT_TIME_WINDOW', '3600', 'NUMBER', 'Detection time window (seconds)', 1),
('IP_MULTI_ACCOUNT_CHECK_ENABLE', 'true', 'BOOLEAN', 'Enable IP check', 1),
('IP_BLACKLIST_DAYS', '30', 'NUMBER', 'IP blacklist days', 1)
```

---

#### ğŸ“ˆ è¦æ±‚ 3.1ï¼šå¸‚åœºæ³¢åŠ¨ä¿æŠ¤ (v1.2)

**è§¦å‘æ¡ä»¶**ï¼š
- äº¤æ˜“å¯¹1åˆ†é’Ÿä»·æ ¼æ³¢åŠ¨ç‡â‰¥5%
- æˆ–è¿ç»­3åˆ†é’Ÿå•å‘æ³¢åŠ¨ç‡â‰¥3%

**è¡ŒåŠ¨**ï¼š
- è‡ªåŠ¨æš‚åœäº¤æ˜“å¯¹
- å‘é€è­¦æŠ¥é€šçŸ¥
- 5åˆ†é’Ÿåè‡ªåŠ¨æ¢å¤ï¼ˆå¯é…ç½®ï¼‰

**æ£€æµ‹æ–¹æ³•**ï¼š
- å®æ—¶ä»·æ ¼å˜åŠ¨ç›‘æ§
- è®¡ç®—1åˆ†é’Ÿã€3åˆ†é’Ÿæ³¢åŠ¨ç‡
- åŸºäº BTSE å¸‚åœºæ•°æ®

**é…ç½®**ï¼š
```sql
('MARKET_VOLATILITY_THRESHOLD_1MIN', '5.0', 'NUMBER', '1-min volatility threshold (%)', 1),
('MARKET_VOLATILITY_THRESHOLD_3MIN', '3.0', 'NUMBER', '3-min volatility threshold (%)', 1),
('MARKET_SUSPENSION_DURATION', '300', 'NUMBER', 'Suspension duration (seconds)', 1),
('MARKET_VOLATILITY_CHECK_ENABLE', 'true', 'BOOLEAN', 'Enable volatility check', 1)
```

---

## 2ã€æ¶æ„è®¾è®¡

### 2.1 æ—¥ç›ˆæ§æ¶æ„

```mermaid
graph TB
    subgraph "æ—¥ç›ˆåˆ©æ§åˆ¶"
        A[å®šæ—¶ä»»åŠ¡<br/>æ¯5åˆ†é’Ÿ]
        B[æŸ¥è¯¢ç”¨æˆ·åˆ©æ¶¦<br/>24å°æ—¶æ»šåŠ¨çª—å£]
        C{åˆ©æ¶¦ >= 10,000?}
        D[æ’å…¥é»‘åå•<br/>è‡ªåŠ¨æ‹‰é»‘]
        E[æ›´æ–° bo_user_daily_profit<br/>è®¾ç½® is_blacklisted=1]
        F[å†™å…¥ Redis<br/>é»‘åå•ç¼“å­˜]
    end

    subgraph "æ•°æ®å­˜å‚¨"
        G[(bo_user_daily_profit)]
        H[(bo_blacklist)]
        I[(Redis é»‘åå•ç¼“å­˜)]
    end

    A --> B
    B --> G
    B --> C
    C -->|æ˜¯| D
    D --> H
    D --> E
    E --> G
    D --> F
    F --> I

    style A fill:#9f9
    style D fill:#f99
```

**ä¸»è¦ç‰¹ç‚¹**ï¼š
- âœ… 24å°æ—¶æ»šåŠ¨çª—å£è®¡ç®—
- âœ… æ ¹æ®å·²ç»“ç®—çš„è®¢å•ï¼ˆ`profit IS NOT NULL`)
- âœ… å®šæ—¶ä»»åŠ¡æ£€æµ‹ï¼ˆ5åˆ†é’Ÿï¼‰
- âœ… è‡ªåŠ¨æ’å…¥é»‘åå•

---

### 2.2 è¿èƒœæ§åˆ¶æ¶æ„ â­v1.9

```mermaid
graph TB
    subgraph "è¿èƒœæ§åˆ¶ - å®šæ—¶æ‰«ææ¨¡å¼"
        A[å®šæ—¶ä»»åŠ¡<br/>æ¯30ç§’]
        B[æŸ¥è¯¢ç”¨æˆ·<br/>é™åˆ¶1000]
        C[æŸ¥è¯¢å¢é‡è®¢å•<br/>id > last_processed_order_id]
        D[è®¡ç®—è¿èƒœ<br/>èµ¢+1, è¾“/å¹³=0]
        E{è¿èƒœ >= 8?}
        F[æ’å…¥é»‘åå•<br/>è‡ªåŠ¨æ‹‰é»‘]
        G[æ›´æ–°è¿èƒœè®°å½•<br/>æ›´æ–° last_processed_order_id]
    end

    subgraph "æ•°æ®å­˜å‚¨"
        H[(bo_user_win_streak)]
        I[(bo_option_order)]
        J[(bo_blacklist)]
        K[(Redis é»‘åå•ç¼“å­˜)]
    end

    A --> B
    B --> H
    B --> C
    C --> I
    C --> D
    D --> E
    E -->|æ˜¯| F
    E -->|å¦| G
    F --> J
    F --> K
    F --> G
    G --> H

    style A fill:#ff9
    style F fill:#f99
```

**ä¸»è¦ç‰¹ç‚¹** â­v1.9ï¼š
- âœ… ä¸è®¢å•ä¸šåŠ¡å½»åº•è§£è€¦
- âœ… å¢é‡æ‰«æï¼ˆä»…é™æ–°è®¢å•ï¼‰
- âœ… æ‰¹å¤„ç†ï¼ˆæ¯æ¬¡æ‰«æ 1000 ä¸ªç”¨æˆ·ï¼‰
- âœ… å¯¹è®¢å•ç»“ç®—æ€§èƒ½é›¶å½±å“

---

### 2.3 é«˜èƒœç‡æ§åˆ¶æ¶æ„

```mermaid
graph TB
    subgraph "é«˜èƒœç‡æ§åˆ¶"
        A[å®šæ—¶ä»»åŠ¡<br/>æ¯1å°æ—¶]
        B[æŸ¥è¯¢ç”¨æˆ·èƒœç‡<br/>æ ·æœ¬é‡ 10-100]
        C{èƒœç‡ >= 70%<br/>ä¸” é‡‘é¢ >= 10?}
        D[æ’å…¥é»‘åå•<br/>è‡ªåŠ¨æ‹‰é»‘]
        E[æ›´æ–° bo_user_win_rate_stats<br/>è®¾ç½® is_blacklisted=1]
        F[å†™å…¥ Redis<br/>é»‘åå•ç¼“å­˜]
    end

    subgraph "æ•°æ®å­˜å‚¨"
        G[(bo_user_win_rate_stats)]
        H[(bo_option_order)]
        I[(bo_blacklist)]
        J[(Redis é»‘åå•ç¼“å­˜)]
    end

    A --> B
    B --> H
    B --> G
    B --> C
    C -->|æ˜¯| D
    D --> I
    D --> E
    E --> G
    D --> F
    F --> J

    style A fill:#9f9
    style D fill:#f99
```

**ä¸»è¦ç‰¹ç‚¹**ï¼š
- âœ… æ ·æœ¬å¤§å°èŒƒå›´ [10, 100] å¯é…ç½®
- âœ… æœ€ä½æŠ•æ³¨é¢ç­›é€‰ï¼ˆ10 USDTï¼‰
- âœ… æ ¹æ®å·²ç»“ç®—çš„è®¢å•ï¼ˆ`profit IS NOT NULL`)
- âœ… å®šæ—¶ä»»åŠ¡æ£€æµ‹ï¼ˆ1å°æ—¶ï¼‰

---

### 2.4 é«˜é¢‘äº¤æ˜“æ§åˆ¶æ¶æ„

```mermaid
graph TB
    subgraph "é«˜é¢‘æ§åˆ¶"
        A[å®šæ—¶ä»»åŠ¡<br/>æ¯1åˆ†é’Ÿ]
        B[æŸ¥è¯¢ç”¨æˆ·ä¸‹æ³¨æ¬¡æ•°<br/>æœ€è¿‘1åˆ†é’Ÿ]
        C{æ¬¡æ•° >= 20?}
        D[æ¨¡å¼æ£€æŸ¥]
        E[é€Ÿç‡é™åˆ¶<br/>60ç§’å†·å´]
        F[æ’å…¥é»‘åå•<br/>è‡ªåŠ¨æ‹‰é»‘]
        G[æ›´æ–° bo_user_frequency_stats]
    end

    subgraph "æ•°æ®å­˜å‚¨"
        H[(bo_option_order)]
        I[(bo_user_frequency_stats)]
        J[(bo_blacklist)]
        K[(Redis é»‘åå•ç¼“å­˜)]
    end

    A --> B
    B --> H
    B --> C
    C -->|æ˜¯| D
    D -->|é€Ÿç‡é™åˆ¶æ¨¡å¼| E
    D -->|é»‘åå•æ¨¡å¼| F
    E --> G
    F --> J
    F --> K
    F --> G
    G --> I

    style A fill:#9f9
    style F fill:#f99
```

**ä¸»è¦ç‰¹ç‚¹**ï¼š
- âœ… ä¸¤ç§æ¨¡å¼ï¼šé€Ÿç‡é™åˆ¶ï¼ˆé»˜è®¤ï¼‰/è‡ªåŠ¨é»‘åå•
- âœ… æ»‘åŠ¨1åˆ†é’Ÿçª—å£
- âœ… è®¡åˆ’ä»»åŠ¡æ£€æµ‹
- âœ… å†·å´æœºåˆ¶

---

### 2.5 IPå¤šè´¦æˆ·æ§åˆ¶æ¶æ„ â­v1.8

```mermaid
graph TB
    subgraph "IPå¤šè´¦æˆ·æ§åˆ¶"
        A[è®¢å•åˆ›å»º<br/>å®æ—¶æ£€æŸ¥]
        B[è·å–è®¾å¤‡æŒ‡çº¹<br/>X-Device-Fingerprint]
        C[æŸ¥è¯¢IPç»Ÿè®¡<br/>Redis]
        D[é€’å¢ä¸‹æ³¨æ¬¡æ•°<br/>æ·»åŠ è®¾å¤‡æŒ‡çº¹]
        E{ä¸‹æ³¨ >= 500<br/>ä¸” è®¾å¤‡ >= 3?}
        F[æ’å…¥é»‘åå•<br/>IPé»‘åå•]
        G[é˜»æ­¢è®¢å•<br/>403 ç¦æ­¢]
    end

    subgraph "æ•°æ®å­˜å‚¨"
        H[(Redis IPç»Ÿè®¡<br/>bo:risk:ip:*)]
        I[(bo_blacklist)]
        J[(Redis é»‘åå•ç¼“å­˜)]
    end

    A --> B
    B --> C
    C --> H
    C --> D
    D --> H
    D --> E
    E -->|æ˜¯| F
    F --> I
    F --> J
    F --> G
    G --> A

    style A fill:#ffd
    style F fill:#f99
    style G fill:#f99
```

**ä¸»è¦ç‰¹ç‚¹** â­v1.8ï¼š
- âœ… è®¢å•åˆ›å»ºè¿‡ç¨‹ä¸­çš„å®æ—¶æ£€æµ‹
- âœ… è®¾å¤‡æŒ‡çº¹å»é‡
- âœ… è§¦å‘åç«‹å³å°† IP åˆ—å…¥é»‘åå•
- âœ… Redisæ»‘åŠ¨çª—å£ç»Ÿè®¡

---

### 2.6 å¸‚åœºæ³¢åŠ¨æ§åˆ¶æ¶æ„

```mermaid
graph TB
    subgraph "å¸‚åœºæ³¢åŠ¨æ§åˆ¶"
        A[å®šæ—¶ä»»åŠ¡<br/>æ¯1åˆ†é’Ÿ]
        B[æŸ¥è¯¢å¸‚åœºä»·æ ¼<br/>BTSE API]
        C[è®¡ç®—æ³¢åŠ¨ç‡<br/>1åˆ†é’Ÿ, 3åˆ†é’Ÿ]
        D{æ³¢åŠ¨ç‡é˜ˆå€¼<br/>è¶…è¿‡?}
        E[æ’å…¥å¸‚åœºæš‚åœ<br/>bo_market_suspension]
        F[å†™å…¥ Redis<br/>æš‚åœç¼“å­˜]
        G[è‡ªåŠ¨æ¢å¤æ£€æŸ¥<br/>æ¯5åˆ†é’Ÿ]
    end

    subgraph "æ•°æ®å­˜å‚¨"
        H[(bo_market_suspension)]
        I[(Redis å¸‚åœºç¼“å­˜<br/>bo:risk:market:suspended:*)]
    end

    A --> B
    B --> C
    C --> D
    D -->|æ˜¯| E
    E --> H
    E --> F
    F --> I
    G --> I
    G --> H

    style A fill:#9f9
    style E fill:#f99
```

**ä¸»è¦ç‰¹ç‚¹**ï¼š
- âœ… å®æ—¶ä»·æ ¼ç›‘æ§
- âœ… 1 åˆ†é’Ÿé˜ˆå€¼ï¼š5%ï¼Œ3 åˆ†é’Ÿé˜ˆå€¼ï¼š3%
- âœ… 5åˆ†é’Ÿåè‡ªåŠ¨æ¢å¤
- âœ… Redis æ‚¬æŒ‚æ ‡å¿—

---

## 3.è¡¨ç»“æ„æ¶æ„

### 3.1 æ—¥åˆ©æ¶¦è¡¨ç»“æ„

```mermaid
graph LR
    A[bo_user_daily_profit] --> B[ç”¨æˆ·æ ‡è¯†<br/>user_id + account_type + profit_date]
    A --> C[åˆ©æ¶¦ç»Ÿè®¡<br/>total_profit, total_loss, net_profit]
    A --> D[è®¢å•ç»Ÿè®¡<br/>total_orders, win_orders, lose_orders, win_rate]
    A --> E[é»‘åå•æ ‡å¿—<br/>is_blacklisted, blacklist_time]

    style A fill:#ffd
    style E fill:#f99
```

**å…³é”®å­—æ®µ**ï¼š
- `net_profit`ï¼š24å°æ—¶å‡€åˆ©æ¶¦ï¼ˆtotal_profit -total_lossï¼‰
- `is_blacklisted`ï¼šåˆ©æ¶¦é™åˆ¶é»‘åå•æ ‡å¿—
- `profit_date`ï¼šç»Ÿè®¡æ—¥æœŸï¼ˆæ»šåŠ¨çª—å£ï¼‰

**ç´¢å¼•**ï¼š
- `uk_user_account_date`ï¼šå”¯ä¸€é”®ï¼ˆuser_idã€account_typeã€profit_dateï¼‰
- `idx_net_profit`ï¼šå‡€åˆ©æ¶¦DESCæŒ‡æ•°
- `idx_blacklisted`ï¼šé»‘åå•æŸ¥è¯¢ç´¢å¼•

---

### 3.2 è¿èƒœè¡¨ç»“æ„ â­v1.9

```mermaid
graph LR
    A[bo_user_win_streak] --> B[ç”¨æˆ·æ ‡è¯†<br/>user_id + account_type]
    A --> C[è¿èƒœç»Ÿè®¡<br/>current_streak, max_streak]
    A --> D[å¢é‡æ‰«æ â­v1.9<br/>last_processed_order_id, last_scan_time]
    A --> E[é»‘åå•æ ‡å¿—<br/>is_blacklisted, blacklist_time]
    A --> F[é‡ç½®ä¿¡æ¯<br/>last_reset_time, reset_reason]

    style A fill:#ff9
    style D fill:#ff9
    style E fill:#f99
```

**å…³é”®å­—æ®µ** â­v1.9ï¼š
- `current_streak`ï¼šå½“å‰è¿ç»­è·èƒœ
- `last_processed_order_id`ï¼šæœ€åå¤„ç†çš„æœ€å¤§è®¢å•IDï¼ˆå¢é‡æ‰«æèµ·ç‚¹ï¼‰
- `last_scan_time`ï¼šä¸Šæ¬¡æ‰«ææ—¶é—´ï¼ˆç›‘æ§å’Œè°ƒè¯•ï¼‰
- `is_blacklisted`ï¼šè¿èƒœé»‘åå•æ ‡å¿—

**ç´¢å¼•** â­v1.9ï¼š
- `uk_user_account`ï¼šå”¯ä¸€é”®ï¼ˆuser_idï¼Œaccount_typeï¼‰
- `idx_last_processed_order`ï¼šå¢é‡æ‰«æç´¢å¼•

**å…³è”ç´¢å¼•** â­v1.9ï¼š
```sql
-- Order table incremental scan index
CREATE INDEX idx_order_incremental_scan
ON bo_option_order (user_id, account_type, id)
WHERE status IN ('WIN', 'LOSE', 'DRAW');
```

---

### 3.3 é«˜èƒœç‡è¡¨ç»“æ„

```mermaid
graph LR
    A[bo_user_win_rate_stats] --> B[ç”¨æˆ·æ ‡è¯†<br/>user_id + account_type]
    A --> C[èƒœç‡ç»Ÿè®¡<br/>sample_size, win_count, lose_count, win_rate]
    A --> D[é»‘åå•æ ‡å¿—<br/>is_blacklisted, blacklist_trigger_win_rate]
    A --> E[è®¡ç®—æ—¶é—´<br/>last_calculate_time]

    style A fill:#ffd
    style D fill:#f99
```

**å…³é”®å­—æ®µ**ï¼š
- `sample_size`ï¼šå½“å‰æ ·æœ¬é‡ï¼ˆå®é™…è®¢å•æ•°ï¼‰
- `win_rate`ï¼šèƒœç‡ (%) = win_count / æ ·æœ¬å¤§å° * 100
- `blacklist_trigger_win_rate`ï¼šé»‘åå•è§¦å‘æ—¶çš„èƒœç‡
- `blacklist_trigger_sample_size`ï¼šé»‘åå•è§¦å‘æ—¶çš„æ ·æœ¬å¤§å°

**ç´¢å¼•**ï¼š
- `uk_user_account`ï¼šå”¯ä¸€é”®ï¼ˆuser_idï¼Œaccount_typeï¼‰
- `idx_win_rate`ï¼šèƒœç‡DESCæŒ‡æ•°
- `idx_sample_size`ï¼šæ ·æœ¬é‡æŒ‡æ•°

---

### 3.4 é«˜é¢‘è¡¨ç»“æ„

```mermaid
graph LR
    A[bo_user_frequency_stats] --> B[ç”¨æˆ·æ ‡è¯†<br/>user_id]
    A --> C[é¢‘ç‡ç»Ÿè®¡<br/>total_trigger_count, last_trigger_time]
    A --> D[è§¦å‘è¯¦æƒ…<br/>last_trigger_bet_count, last_trigger_time_window]
    A --> E[é»‘åå•æ ‡å¿—<br/>is_blacklisted, blacklist_trigger_count]

    style A fill:#ffd
    style E fill:#f99
```

**å…³é”®å­—æ®µ**ï¼š
- `total_trigger_count`ï¼šç´¯è®¡è§¦å‘æ¬¡æ•°
- `last_trigger_bet_count`: æœ€åè§¦å‘æ—¶çš„æŠ•æ³¨æ•°
- `last_trigger_time_window`ï¼šæœ€åä¸€æ¬¡è§¦å‘çš„æ—¶é—´çª—å£ï¼ˆä¾‹å¦‚ï¼Œ202512241530ï¼‰
- `is_blacklisted`ï¼šé«˜é¢‘é»‘åå•æ ‡å¿—

**ç´¢å¼•**ï¼š
- `uk_user`ï¼šå”¯ä¸€é”®ï¼ˆuser_idï¼‰
- `idx_trigger_count`ï¼šè§¦å‘â€‹â€‹æ¬¡æ•° DESC ç´¢å¼•

---

### 3.5 å¸‚åœºåœç‰Œè¡¨ç»“æ„

```mermaid
graph LR
    A[bo_market_suspension] --> B[äº¤æ˜“å¯¹<br/>symbol]
    A --> C[æš‚åœä¿¡æ¯<br/>suspension_reason, volatility_1min, volatility_3min]
    A --> D[æ—¶é—´ä¿¡æ¯<br/>suspension_time, resume_time, duration]
    A --> E[çŠ¶æ€<br/>status, auto_resume]

    style A fill:#ffd
    style E fill:#f9f
```

**å…³é”®å­—æ®µ**ï¼š
- `volatility_1min`ï¼š1åˆ†é’Ÿæ³¢åŠ¨ç‡ï¼ˆ%ï¼‰
- `volatility_3min`ï¼š3åˆ†é’Ÿæ³¢åŠ¨ç‡ï¼ˆ%ï¼‰
- `status`ï¼šçŠ¶æ€ï¼ˆæ´»åŠ¨/æ¢å¤ï¼‰
- `auto_resume`ï¼šè‡ªåŠ¨æ¢å¤æ ‡å¿—

**ç´¢å¼•**ï¼š
- `idx_symbol_status`ï¼šï¼ˆç¬¦å·ã€çŠ¶æ€ï¼‰ç´¢å¼•
- `idx_suspension_time`ï¼šæš‚åœæ—¶é—´ DESC æŒ‡æ•°

---

## 4. æ•°æ®æµè®¾è®¡

### 4.1 è®¢å•åˆ›å»ºé£é™©æ£€æŸ¥æµç¨‹ â­v1.8/v1.9

```mermaid
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant OrderController as è®¢å•æ§åˆ¶å™¨
    participant RiskControlService as é£æ§æœåŠ¡
    participant Redis
    participant DB as æ•°æ®åº“

    User->>OrderController: POST /api/borc/order<br/>è¯·æ±‚å¤´: X-Device-Fingerprint
    OrderController->>RiskControlService: checkOrderRisk()

    rect rgb(255, 240, 240)
        Note over RiskControlService,Redis: æ£€æŸ¥1: ç”¨æˆ·é»‘åå•
        RiskControlService->>Redis: GET bo:risk:blacklist:user:{userId}
        Redis-->>RiskControlService: è¿”å›ç¼“å­˜çŠ¶æ€
        alt åœ¨é»‘åå•ä¸­
            RiskControlService-->>OrderController: æ‹¦æˆª - ç”¨æˆ·å·²æ‹‰é»‘
            OrderController-->>User: 403 ç¦æ­¢
        end
    end

    rect rgb(255, 245, 240)
        Note over RiskControlService,Redis: æ£€æŸ¥2: IP/è®¾å¤‡æŒ‡çº¹ â­v1.8
        RiskControlService->>Redis: GET bo:risk:blacklist:ip:{ip}
        alt IPåœ¨é»‘åå•ä¸­
            RiskControlService-->>OrderController: æ‹¦æˆª - IPå·²æ‹‰é»‘
            OrderController-->>User: 403 ç¦æ­¢
        end

        RiskControlService->>Redis: HINCRBY bo:risk:ip:{ip}:{hour} bet_count 1
        RiskControlService->>Redis: HGET bo:risk:ip:{ip}:{hour} devices
        RiskControlService->>RiskControlService: è§£æè®¾å¤‡é›†åˆ, æ·»åŠ å½“å‰è®¾å¤‡
        RiskControlService->>Redis: HSET bo:risk:ip:{ip}:{hour} devices {jsonArray}

        RiskControlService->>RiskControlService: æ£€æŸ¥: bet_count >= 500 && devices >= 3?
        alt è§¦å‘IPå¤šè´¦æˆ·
            RiskControlService->>DB: INSERT bo_blacklist (IP)
            RiskControlService->>Redis: SET bo:risk:blacklist:ip:{ip}
            RiskControlService-->>OrderController: æ‹¦æˆª - IPå¤šè´¦æˆ·
            OrderController-->>User: 403 ç¦æ­¢
        end
    end

    rect rgb(245, 250, 255)
        Note over RiskControlService,Redis: æ£€æŸ¥3: å¸‚åœºæš‚åœ
        RiskControlService->>Redis: EXISTS bo:risk:market:suspended:{symbol}
        alt å¸‚åœºå·²æš‚åœ
            RiskControlService-->>OrderController: æ‹¦æˆª - å¸‚åœºå·²æš‚åœ
            OrderController-->>User: 503 æœåŠ¡ä¸å¯ç”¨
        end
    end

    RiskControlService-->>OrderController: é€šè¿‡ - æ‰€æœ‰æ£€æŸ¥é€šè¿‡
    OrderController->>DB: åˆ›å»ºè®¢å•
    OrderController-->>User: 200 æˆåŠŸ - è®¢å•å·²åˆ›å»º

    Note over Redis,DB: å®šæ—¶ä»»åŠ¡åœ¨åå°è¿è¡Œ
    Note over Redis,DB: æ£€æµ‹å…¶ä»–é£é™©ç­–ç•¥å¹¶æ’å…¥é»‘åå•
```

**å…³é”®ç®€åŒ–** (v1.8/v1.9)ï¼š
- âœ… æ£€æŸ¥1ï¼šç”¨æˆ·é»‘åå•-Rediså¿«é€ŸæŸ¥è¯¢
- âœ… æ£€æŸ¥2ï¼šIP/è®¾å¤‡æŒ‡çº¹-Rediså®æ—¶ç»Ÿè®¡ï¼Œé˜ˆå€¼ç«‹å³åˆ—å…¥é»‘åå•â­ä¿ç•™
- âœ… æ£€æŸ¥3ï¼šå¸‚åœºæš‚åœ-Redisæš‚åœæ ‡å¿—

**åˆ é™¤äº†æ£€æŸ¥** (v1.8/v1.9)ï¼š
- âŒæ¯æ—¥åˆ©æ¶¦æŸ¥çœ‹-æ”¹ä¸ºè®¡åˆ’ä»»åŠ¡
- âŒ é«˜èƒœç‡æ£€æŸ¥-æ”¹ä¸ºè®¡åˆ’ä»»åŠ¡
- âŒ é«˜é¢‘æ£€æŸ¥-æ”¹ä¸ºè®¡åˆ’ä»»åŠ¡
- âŒè¿èƒœæ£€æŸ¥-æ”¹ä¸ºè®¡åˆ’ä»»åŠ¡â­v1.9æ‰«ææ¨¡å¼

---

### 4.2 è¿èƒœæ£€æµ‹æµç¨‹ â­v1.9

```mermaid
sequenceDiagram
    autonumber
    participant Task as è¿èƒœæ‰«æä»»åŠ¡
    participant Lock as åˆ†å¸ƒå¼é”
    participant DB as PostgreSQL
    participant Blacklist as é»‘åå•æœåŠ¡

    Note over Task: æ¯30ç§’æ‰§è¡Œä¸€æ¬¡

    Task->>Lock: tryLock("bo:schedule:risk:win-streak-scan")
    alt é”å®šå¤±è´¥
        Lock-->>Task: å…¶ä»–å®ä¾‹æ­£åœ¨è¿è¡Œ
        Task->>Task: è·³è¿‡æ‰§è¡Œ
    end

    Lock-->>Task: è·å–é”

    Note over Task,DB: æ­¥éª¤1: æŸ¥è¯¢éœ€è¦æ£€æµ‹çš„ç”¨æˆ·
    Task->>DB: SELECT user_id, account_type, last_processed_order_id<br/>FROM bo_user_win_streak<br/>WHERE is_blacklisted = 0<br/>LIMIT 1000
    DB-->>Task: è¿”å›ç”¨æˆ·åˆ—è¡¨

    Note over Task,DB: æ­¥éª¤2: æ‰¹é‡æŸ¥è¯¢å¢é‡è®¢å•
    loop æ¯ä¸ªç”¨æˆ·
        Task->>DB: SELECT id, status, settle_time<br/>FROM bo_option_order<br/>WHERE user_id = ?<br/>AND id > last_processed_order_id<br/>AND status IN ('WIN', 'LOSE', 'DRAW')<br/>ORDER BY id ASC<br/>LIMIT 100
        DB-->>Task: è¿”å›ç”¨æˆ·å¢é‡è®¢å•

        Task->>Task: è®¡ç®—è¿èƒœ

        alt è¾¾åˆ°8è¿èƒœ
            Task->>Blacklist: æ’å…¥é»‘åå•
            Task->>DB: UPDATE bo_user_win_streak<br/>SET is_blacklisted = 1,<br/>current_streak = 8,<br/>blacklist_time = NOW()
        else è¾“/å¹³å±€é‡ç½®
            Task->>DB: UPDATE bo_user_win_streak<br/>SET current_streak = 0,<br/>reset_reason = 'LOSE/DRAW'
        else ç»§ç»­è¿èƒœ
            Task->>DB: UPDATE bo_user_win_streak<br/>SET current_streak = X
        end

        Task->>DB: UPDATE bo_user_win_streak<br/>SET last_processed_order_id = MAX(order_id),<br/>last_scan_time = NOW()
    end

    Task->>Lock: unlock()

    Note over Task: è®°å½•æ‰§è¡Œç»Ÿè®¡
```

**æ€§èƒ½ä¼˜åŒ–**ï¼š
1. é™åˆ¶æ‰«æç”¨æˆ·ï¼šæ¯æ¬¡æ‰«ææœ€å¤š 1000 ä¸ªç”¨æˆ·
2. å¢é‡æŸ¥è¯¢ï¼š`id > last_processed_order_id`
3. é™ä»·è®¢å•ï¼šæ¯ä¸ªç”¨æˆ·æœ€å¤š100ä¸ªå¢é‡è®¢å•
4. æ‰¹é‡æ›´æ–°ï¼šä½¿ç”¨äº¤æ˜“è¿›è¡Œæ‰¹é‡è¿èƒœæ›´æ–°

---

### 4.3 æ¯æ—¥ç›ˆåˆ©æ£€æµ‹æµç¨‹

```mermaid
sequenceDiagram
    autonumber
    participant Task as æ¯æ—¥åˆ©æ¶¦ä»»åŠ¡
    participant Lock as åˆ†å¸ƒå¼é”
    participant DB as PostgreSQL
    participant Blacklist as é»‘åå•æœåŠ¡

    Note over Task: æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡

    Task->>Lock: tryLock("bo:schedule:risk:daily-profit")
    Lock-->>Task: è·å–é”

    Task->>DB: SELECT user_id, account_type, net_profit<br/>FROM bo_user_daily_profit<br/>WHERE net_profit >= 10000<br/>AND is_blacklisted = 0

    loop æ¯ä¸ªç”¨æˆ·
        Task->>Blacklist: æ’å…¥é»‘åå•
        Task->>DB: UPDATE bo_user_daily_profit<br/>SET is_blacklisted = 1
    end

    Task->>Lock: unlock()
```

---

### 4.4 é«˜èƒœç‡æ£€æµ‹æµç¨‹

```mermaid
sequenceDiagram
    autonumber
    participant Task as èƒœç‡ä»»åŠ¡
    participant Lock as åˆ†å¸ƒå¼é”
    participant DB as PostgreSQL
    participant Blacklist as é»‘åå•æœåŠ¡

    Note over Task: æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡

    Task->>Lock: tryLock("bo:schedule:risk:win-rate")
    Lock-->>Task: è·å–é”

    Task->>DB: è®¡ç®—ç”¨æˆ·èƒœç‡<br/>æ ·æœ¬é‡ [10, 100]<br/>é‡‘é¢ >= 10 USDT

    loop æ¯ä¸ªç”¨æˆ·
        alt èƒœç‡ >= 70%
            Task->>Blacklist: æ’å…¥é»‘åå•
            Task->>DB: UPDATE bo_user_win_rate_stats<br/>SET is_blacklisted = 1
        end
    end

    Task->>Lock: unlock()
```

---

### 4.5 é«˜é¢‘æ£€æµ‹æµç¨‹

```mermaid
sequenceDiagram
    autonumber
    participant Task as é¢‘ç‡ä»»åŠ¡
    participant Lock as åˆ†å¸ƒå¼é”
    participant DB as PostgreSQL
    participant Blacklist as é»‘åå•æœåŠ¡

    Note over Task: æ¯1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡

    Task->>Lock: tryLock("bo:schedule:risk:frequency")
    Lock-->>Task: è·å–é”

    Task->>DB: SELECT user_id, COUNT(*) as bet_count<br/>FROM bo_option_order<br/>WHERE create_time >= NOW() - INTERVAL '1 minute'<br/>GROUP BY user_id<br/>HAVING COUNT(*) >= 20

    loop æ¯ä¸ªç”¨æˆ·
        alt é»‘åå•æ¨¡å¼
            Task->>Blacklist: æ’å…¥é»‘åå•
        else é€Ÿç‡é™åˆ¶æ¨¡å¼
            Task->>Task: åº”ç”¨å†·å´
        end
        Task->>DB: UPDATE bo_user_frequency_stats
    end

    Task->>Lock: unlock()
```

---

### 4.6 IPå¤šè´¦å·æ£€æµ‹æµç¨‹

**ç¬¬4.1èŠ‚ä¸­ä»‹ç»**ï¼ˆè®¢å•åˆ›å»ºè¿‡ç¨‹ä¸­çš„å®æ—¶æ£€æŸ¥ï¼‰

---

### 4.7 å¸‚åœºæ³¢åŠ¨æ£€æµ‹æµç¨‹

```mermaid
sequenceDiagram
    autonumber
    participant Task as å¸‚åœºæ³¢åŠ¨ä»»åŠ¡
    participant BTSE as BTSE API
    participant DB as PostgreSQL
    participant Redis

    Note over Task: æ¯1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡

    Task->>BTSE: æŸ¥è¯¢å¸‚åœºä»·æ ¼
    BTSE-->>Task: è¿”å›ä»·æ ¼æ•°æ®

    Task->>Task: è®¡ç®—æ³¢åŠ¨ç‡<br/>1åˆ†é’Ÿ, 3åˆ†é’Ÿ

    loop æ¯ä¸ªäº¤æ˜“å¯¹
        alt æ³¢åŠ¨ç‡ >= é˜ˆå€¼
            Task->>DB: INSERT bo_market_suspension
            Task->>Redis: SET bo:risk:market:suspended:{symbol}
        end
    end
```

---

## 5. è¡¨ç»“æ„è®¾è®¡

### 5.1 æ•°æ®åº“å˜æ›´æ€»ç»“

```mermaid
graph TD
    A[v1.9 æ•°æ®åº“æ¶æ„] --> B[æ–°è¡¨ v1.4]
    A --> C[v1.2 è¡¨ â­v1.9 ä¼˜åŒ–]
    A --> D[æ‰©å±•è¡¨ v1.2]
    A --> E[é…ç½®æ•°æ® â­v1.9]

    B --> B1[bo_user_daily_profit<br/>æ¯æ—¥åˆ©æ¶¦è¡¨]
    B --> B2[bo_user_win_rate_stats<br/>èƒœç‡ç»Ÿè®¡è¡¨ â­ç‹¬ç«‹]
    B --> B3[bo_user_frequency_stats<br/>é¢‘ç‡ç»Ÿè®¡è¡¨ â­ç‹¬ç«‹]

    C --> C1[bo_user_win_streak<br/>è¿èƒœè¡¨ â­v1.9]
    C --> C2[bo_market_suspension<br/>å¸‚åœºæš‚åœè¡¨]

    D --> D1[bo_blacklist<br/>4ä¸ªæ–°ç±»å‹]

    E --> E1[bo_risk_config<br/>29ä¸ªé…ç½® â­v1.9]

    style C1 fill:#ff9
    style E1 fill:#ff9
    style B2 fill:#ffd
    style B3 fill:#ffd
```

|è¿è¥|è¡¨|æè¿° |ä¼˜å…ˆ|
|-----------|-------|-------------|----------|
| **æ–°** |`bo_user_daily_profit`|æ¯æ—¥åˆ©æ¶¦è¿½è¸ªè¡¨ï¼ˆv1.4ï¼‰| P0|
| **æ–°** |`bo_user_win_rate_stats`|èƒœç‡ç»Ÿè®¡è¡¨â­ç‹¬ç«‹ï¼ˆv1.4ï¼‰| P0|
| **æ–°** |`bo_user_frequency_stats`|é¢‘ç‡ç»Ÿè®¡è¡¨â­ç‹¬ç«‹ï¼ˆv1.4ï¼‰| P0|
| **ç»§æ‰¿+ä¼˜åŒ–** |`bo_user_win_streak`|è¿èƒœè¡¨â­v1.9å¢é‡æ‰«æå­—æ®µ| P0|
| **ç»§æ‰¿** |`bo_market_suspension`|å¸‚åœºæš‚åœè¡¨ï¼ˆv1.2ï¼‰| - |
| **å»¶é•¿** |`bo_blacklist`|æ”¯æŒ 4 ä¸ªæ–°ç±»å‹å€¼ | P0|
| **æ’å…¥** |`bo_risk_config`| 29 ä¸ªæ–°é…ç½® â­v1.9 | P0|

---

### 5.2 æ–°çš„è¡¨ç»“æ„

#### A. ç”¨æˆ·æ—¥æ”¶ç›Šè¡¨

```sql
-- =====================================================
-- è¡¨: bo_user_daily_profit
-- æè¿°: ç”¨æˆ·æ¯æ—¥åˆ©æ¶¦è¿½è¸ªï¼ˆ24å°æ—¶æ»šåŠ¨çª—å£ï¼‰
-- =====================================================
CREATE TABLE bo_user_daily_profit (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    account_type VARCHAR(20) NOT NULL COMMENT 'è´¦æˆ·ç±»å‹: DEMO/REAL',
    profit_date DATE NOT NULL COMMENT 'ç»Ÿè®¡æ—¥æœŸ',

    -- åˆ©æ¶¦ç»Ÿè®¡
    total_profit DECIMAL(20,2) DEFAULT 0 COMMENT '24å°æ—¶æ€»åˆ©æ¶¦ï¼ˆå‡€å€¼ï¼‰',
    total_loss DECIMAL(20,2) DEFAULT 0 COMMENT '24å°æ—¶æ€»æŸå¤±',
    net_profit DECIMAL(20,2) DEFAULT 0 COMMENT '24å°æ—¶å‡€åˆ©æ¶¦ = total_profit - total_loss',

    -- è®¢å•ç»Ÿè®¡
    total_orders INT DEFAULT 0 COMMENT 'æ€»è®¢å•æ•°',
    win_orders INT DEFAULT 0 COMMENT 'ç›ˆåˆ©è®¢å•æ•°',
    lose_orders INT DEFAULT 0 COMMENT 'äºæŸè®¢å•æ•°',
    win_rate DECIMAL(5,2) DEFAULT 0 COMMENT 'èƒœç‡ (%)',

    -- é»‘åå•æ ‡å¿—
    is_blacklisted TINYINT(1) DEFAULT 0 COMMENT 'åˆ©æ¶¦é™é¢æ‹‰é»‘æ ‡å¿—',
    blacklist_time TIMESTAMP NULL COMMENT 'æ‹‰é»‘æ—¶é—´',

    -- æ—¶é—´æˆ³
    last_update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´¢å¼•
    UNIQUE KEY uk_user_account_date (user_id, account_type, profit_date),
    INDEX idx_net_profit (net_profit DESC),
    INDEX idx_blacklisted (is_blacklisted, user_id),
    INDEX idx_profit_date (profit_date)
) COMMENT 'ç”¨æˆ·æ¯æ—¥åˆ©æ¶¦è¿½è¸ªè¡¨ - 24å°æ—¶æ»šåŠ¨çª—å£';
```

---

#### B. ç”¨æˆ·èƒœç‡ç»Ÿè®¡è¡¨

```sql
-- =====================================================
-- è¡¨: bo_user_win_rate_stats
-- æè¿°: ç”¨æˆ·èƒœç‡ç»Ÿè®¡ï¼ˆç‹¬ç«‹è¡¨ï¼‰
-- v1.5: åŸºäº profit IS NOT NULL è®¢å•çš„ç»Ÿè®¡
-- v1.6/v1.7: ä»…ç”±å®šæ—¶ä»»åŠ¡æ›´æ–°ï¼Œè®¢å•åˆ›å»ºæ—¶åªè¯»
-- =====================================================
CREATE TABLE bo_user_win_rate_stats (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    account_type VARCHAR(20) NOT NULL COMMENT 'è´¦æˆ·ç±»å‹: DEMO/REAL',

    -- èƒœç‡ç»Ÿè®¡ï¼ˆå¯é…ç½®æ ·æœ¬é‡ï¼‰
    sample_size INT DEFAULT 0 COMMENT 'å½“å‰æ ·æœ¬é‡ï¼ˆå®é™…è®¢å•æ•°ï¼‰',
    win_count INT DEFAULT 0 COMMENT 'ç›ˆåˆ©è®¢å•æ•°',
    lose_count INT DEFAULT 0 COMMENT 'äºæŸè®¢å•æ•°',
    draw_count INT DEFAULT 0 COMMENT 'å¹³å±€è®¢å•æ•°',
    win_rate DECIMAL(5,2) DEFAULT 0 COMMENT 'èƒœç‡ (%) = win_count / sample_size * 100',

    -- é»‘åå•æ ‡å¿—
    is_blacklisted TINYINT(1) DEFAULT 0 COMMENT 'é«˜èƒœç‡æ‹‰é»‘æ ‡å¿—',
    blacklist_time TIMESTAMP NULL COMMENT 'æ‹‰é»‘æ—¶é—´',
    blacklist_trigger_win_rate DECIMAL(5,2) COMMENT 'æ‹‰é»‘è§¦å‘æ—¶çš„èƒœç‡',
    blacklist_trigger_sample_size INT COMMENT 'æ‹‰é»‘è§¦å‘æ—¶çš„æ ·æœ¬é‡',

    -- æ—¶é—´æˆ³
    last_calculate_time TIMESTAMP NULL COMMENT 'æœ€åè®¡ç®—æ—¶é—´',
    last_update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´¢å¼•
    UNIQUE KEY uk_user_account (user_id, account_type),
    INDEX idx_win_rate (win_rate DESC),
    INDEX idx_blacklisted (is_blacklisted, user_id),
    INDEX idx_sample_size (sample_size)
) COMMENT 'ç”¨æˆ·èƒœç‡ç»Ÿè®¡è¡¨ - v1.7: ä»…ç”±å®šæ—¶ä»»åŠ¡æ›´æ–°';
```

---

#### C. ç”¨æˆ·é¢‘ç‡ç»Ÿè®¡è¡¨

```sql
-- =====================================================
-- è¡¨: bo_user_frequency_stats
-- æè¿°: ç”¨æˆ·é¢‘ç‡ç»Ÿè®¡ï¼ˆç‹¬ç«‹è¡¨ï¼‰
-- =====================================================
CREATE TABLE bo_user_frequency_stats (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',

    -- é¢‘ç‡ç»Ÿè®¡
    total_trigger_count INT DEFAULT 0 COMMENT 'ç´¯è®¡è§¦å‘æ¬¡æ•°',
    last_trigger_time TIMESTAMP NULL COMMENT 'æœ€åè§¦å‘æ—¶é—´',
    last_trigger_bet_count INT COMMENT 'æœ€åè§¦å‘æ—¶çš„ä¸‹æ³¨æ¬¡æ•°',
    last_trigger_time_window VARCHAR(20) COMMENT 'æœ€åè§¦å‘çš„æ—¶é—´çª—å£ï¼ˆä¾‹å¦‚ï¼š202512241530ï¼‰',

    -- é»‘åå•æ ‡å¿—
    is_blacklisted TINYINT(1) DEFAULT 0 COMMENT 'é«˜é¢‘æ‹‰é»‘æ ‡å¿—',
    blacklist_time TIMESTAMP NULL COMMENT 'æ‹‰é»‘æ—¶é—´',
    blacklist_trigger_count INT COMMENT 'æ‹‰é»‘è§¦å‘æ—¶çš„ä¸‹æ³¨æ¬¡æ•°',

    -- æ—¶é—´æˆ³
    last_update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´¢å¼•
    UNIQUE KEY uk_user (user_id),
    INDEX idx_trigger_count (total_trigger_count DESC),
    INDEX idx_last_trigger_time (last_trigger_time),
    INDEX idx_blacklisted (is_blacklisted, user_id)
) COMMENT 'ç”¨æˆ·é¢‘ç‡ç»Ÿè®¡è¡¨ - é«˜é¢‘äº¤æ˜“è§¦å‘å†å²';
```

---

#### D. è¿èƒœæ¦œ â­v1.9 ä¼˜åŒ–

```sql
-- =====================================================
-- è¡¨: bo_user_win_streak
-- æè¿°: ç”¨æˆ·è¿èƒœè¡¨ï¼ˆv1.9ï¼šå®šæ—¶æ‰«ææ¨¡å¼ï¼‰
-- =====================================================
CREATE TABLE bo_user_win_streak (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    account_type VARCHAR(20) NOT NULL COMMENT 'è´¦æˆ·ç±»å‹: DEMO/REAL',

    -- è¿èƒœç»Ÿè®¡
    current_streak INT DEFAULT 0 COMMENT 'å½“å‰è¿èƒœæ¬¡æ•°',
    max_streak INT DEFAULT 0 COMMENT 'å†å²æœ€å¤§è¿èƒœ',
    last_win_time TIMESTAMP NULL COMMENT 'æœ€åç›ˆåˆ©æ—¶é—´',
    last_order_id BIGINT COMMENT 'æœ€åè®¢å•ID',

    -- â­v1.9 æ–°å¢: å¢é‡æ‰«ææ ‡è®°
    last_processed_order_id BIGINT DEFAULT 0 COMMENT 'æœ€åå¤„ç†çš„æœ€å¤§è®¢å•ID',
    last_scan_time TIMESTAMP NULL COMMENT 'æœ€åæ‰«ææ—¶é—´',

    -- é»‘åå•æ ‡å¿—
    is_blacklisted TINYINT(1) DEFAULT 0 COMMENT 'è¿èƒœæ‹‰é»‘æ ‡å¿—',
    blacklist_time TIMESTAMP NULL COMMENT 'æ‹‰é»‘æ—¶é—´',
    blacklist_trigger_streak INT COMMENT 'æ‹‰é»‘è§¦å‘æ—¶çš„è¿èƒœæ¬¡æ•°',

    -- é‡ç½®æ ‡è®°
    last_reset_time TIMESTAMP NULL COMMENT 'æœ€åé‡ç½®æ—¶é—´',
    reset_reason VARCHAR(50) COMMENT 'é‡ç½®åŸå› : LOSE/DRAW/MANUAL',

    -- æ—¶é—´æˆ³
    last_update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´¢å¼•
    UNIQUE KEY uk_user_account (user_id, account_type),
    INDEX idx_current_streak (current_streak DESC),
    INDEX idx_blacklisted (is_blacklisted, user_id),
    INDEX idx_last_processed_order (last_processed_order_id)  -- â­v1.9 æ–°å¢
) COMMENT 'ç”¨æˆ·è¿èƒœè¡¨ - v1.9 å®šæ—¶æ‰«ææ¨¡å¼';
```

**â­v1.9 ç´¢å¼•ä¼˜åŒ–**ï¼š
```sql
-- è®¢å•è¡¨å¢é‡æ‰«æç´¢å¼•
CREATE INDEX idx_order_incremental_scan
ON bo_option_order (user_id, account_type, id)
WHERE status IN ('WIN', 'LOSE', 'DRAW');

-- éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–: ä»…ç´¢å¼•å·²ç»“ç®—è®¢å•
CREATE INDEX idx_order_settled
ON bo_option_order (user_id, settle_time)
WHERE profit IS NOT NULL;
```

---

#### E. å¸‚åœºæš‚åœè¡¨ï¼ˆv1.2ï¼‰

```sql
-- =====================================================
-- è¡¨: bo_market_suspension
-- æè¿°: å¸‚åœºæš‚åœè®°å½•è¡¨ï¼ˆv1.2å·²å®ç°ï¼‰
-- =====================================================
CREATE TABLE bo_market_suspension (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL COMMENT 'äº¤æ˜“å¯¹ç¬¦å·',

    -- æš‚åœä¿¡æ¯
    suspension_reason VARCHAR(100) COMMENT 'æš‚åœåŸå› ',
    volatility_1min DECIMAL(10,2) COMMENT '1åˆ†é’Ÿæ³¢åŠ¨ç‡ (%)',
    volatility_3min DECIMAL(10,2) COMMENT '3åˆ†é’Ÿæ³¢åŠ¨ç‡ (%)',
    trigger_price DECIMAL(20,8) COMMENT 'è§¦å‘ä»·æ ¼',

    -- æ—¶é—´ä¿¡æ¯
    suspension_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æš‚åœæ—¶é—´',
    resume_time TIMESTAMP NULL COMMENT 'æ¢å¤æ—¶é—´',
    duration INT COMMENT 'æš‚åœæ—¶é•¿ï¼ˆç§’ï¼‰',

    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'ACTIVE' COMMENT 'çŠ¶æ€: ACTIVE/RESUMED',
    auto_resume TINYINT(1) DEFAULT 1 COMMENT 'è‡ªåŠ¨æ¢å¤æ ‡å¿—',

    -- æ—¶é—´æˆ³
    last_update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- ç´¢å¼•
    INDEX idx_symbol_status (symbol, status),
    INDEX idx_suspension_time (suspension_time DESC)
) COMMENT 'å¸‚åœºæš‚åœè®°å½•è¡¨ - v1.2å·²å®ç°';
```

---

### 5.3 æ‰©å±•è¡¨ç»“æ„

#### æ‰©å±•é»‘åå•è¡¨

```sql
-- =====================================================
-- æ‰©å±• bo_blacklist è¡¨
-- æ–°å¢é»‘åå•ç±»å‹: DAILY_PROFIT, HIGH_WINRATE, HIGH_FREQUENCY, WIN_STREAK
-- =====================================================
-- v1.2å·²æ‰©å±•ï¼Œv1.4/v1.9æ— é¢å¤–å˜æ›´ï¼Œä»…æ”¯æŒæ–°çš„ç±»å‹å€¼

-- ç¤ºä¾‹æ’å…¥
INSERT INTO bo_blacklist (user_id, blacklist_type, reason, type, auto_trigger_rule, status) VALUES
(1001, 'DAILY_PROFIT', 'è‡ªåŠ¨æ‹‰é»‘: æ¯æ—¥åˆ©æ¶¦è¶…é™', 'auto', 'DAILY_PROFIT_10K', 1),
(1002, 'HIGH_WINRATE', 'è‡ªåŠ¨æ‹‰é»‘: èƒœç‡75.5% (æ ·æœ¬é‡: 85)', 'auto', 'HIGH_WINRATE_70', 1),
(1003, 'HIGH_FREQUENCY', 'è‡ªåŠ¨æ‹‰é»‘: 1åˆ†é’Ÿå†…ä¸‹æ³¨25æ¬¡', 'auto', 'HIGH_FREQUENCY_20', 1),
(1004, 'WIN_STREAK', 'è‡ªåŠ¨æ‹‰é»‘: è¿ç»­8æ¬¡ç›ˆåˆ©', 'auto', 'WIN_STREAK_8', 1);
```

---

### 5.4 é…ç½®æ•°æ®åˆå§‹åŒ–

```sql
-- =====================================================
-- é£æ§é…ç½®æ•°æ® - v1.9å®Œæ•´ç‰ˆ
-- è¡¨: bo_risk_config
-- =====================================================

-- ============ æ¯æ—¥åˆ©æ¶¦é™é¢é…ç½® ============
INSERT INTO bo_risk_config (config_key, config_value, config_type, description, enabled) VALUES
('DAILY_PROFIT_LIMIT', '10000.00', 'NUMBER', 'æ¯æ—¥å‡€åˆ©æ¶¦é™é¢ (USDT)', 1),
('DAILY_PROFIT_CHECK_ENABLE', 'true', 'BOOLEAN', 'å¯ç”¨æ¯æ—¥åˆ©æ¶¦æ£€æŸ¥', 1),
('DAILY_PROFIT_BLACKLIST_DAYS', '7', 'NUMBER', 'åˆ©æ¶¦è¶…é™æ‹‰é»‘å¤©æ•°', 1),
('DAILY_PROFIT_ROLLING_HOURS', '24', 'NUMBER', 'åˆ©æ¶¦æ»šåŠ¨çª—å£ï¼ˆå°æ—¶ï¼‰', 1),

-- ============ è¿èƒœé”å®šé…ç½® â­v1.9 ============
('WIN_STREAK_LIMIT', '8', 'NUMBER', 'è¿èƒœæ‹‰é»‘é˜ˆå€¼', 1),
('WIN_STREAK_CHECK_ENABLE', 'true', 'BOOLEAN', 'å¯ç”¨è¿èƒœæ£€æŸ¥', 1),
('WIN_STREAK_BLACKLIST_DAYS', '7', 'NUMBER', 'è¿èƒœæ‹‰é»‘å¤©æ•°', 1),
-- â­v1.9 æ–°å¢é…ç½®
('WIN_STREAK_SCAN_INTERVAL', '30', 'NUMBER', 'è¿èƒœæ‰«æé—´éš”ï¼ˆç§’ï¼‰', 1),
('WIN_STREAK_BATCH_SIZE', '1000', 'NUMBER', 'æ¯æ¬¡æ‰«ææœ€å¤§ç”¨æˆ·æ•°', 1),
('WIN_STREAK_ORDER_LIMIT', '100', 'NUMBER', 'æ¯ä¸ªç”¨æˆ·æ¯æ¬¡æ‰«ææœ€å¤§è®¢å•æ•°', 1),

-- ============ é«˜èƒœç‡æ£€æµ‹é…ç½® â­ä¼˜åŒ– ============
('HIGH_WINRATE_THRESHOLD', '70.0', 'NUMBER', 'é«˜èƒœç‡æ‹‰é»‘é˜ˆå€¼ (%)', 1),
('HIGH_WINRATE_SAMPLE_SIZE_MIN', '10', 'NUMBER', 'æœ€å°æ ·æœ¬é‡ï¼ˆè®¢å•æ•°ï¼‰', 1),
('HIGH_WINRATE_SAMPLE_SIZE_MAX', '100', 'NUMBER', 'æœ€å¤§æ ·æœ¬é‡ï¼ˆè®¢å•æ•°ï¼‰', 1),
('HIGH_WINRATE_MIN_BET_AMOUNT', '10.0', 'NUMBER', 'æœ€ä½æŠ•æ³¨é‡‘é¢ (USDT)', 1),
('HIGH_WINRATE_CHECK_ENABLE', 'true', 'BOOLEAN', 'å¯ç”¨èƒœç‡æ£€æŸ¥', 1),
('HIGH_WINRATE_BLACKLIST_DAYS', '7', 'NUMBER', 'é«˜èƒœç‡æ‹‰é»‘å¤©æ•°', 1),

-- ============ é«˜é¢‘äº¤æ˜“æ£€æµ‹é…ç½® ============
('HIGH_FREQUENCY_THRESHOLD', '20', 'NUMBER', 'é«˜é¢‘é˜ˆå€¼ï¼ˆæ¯åˆ†é’Ÿè®¢å•æ•°ï¼‰', 1),
('HIGH_FREQUENCY_TIME_WINDOW', '60', 'NUMBER', 'æ£€æµ‹æ—¶é—´çª—å£ï¼ˆç§’ï¼‰', 1),
('HIGH_FREQUENCY_CHECK_ENABLE', 'true', 'BOOLEAN', 'å¯ç”¨é¢‘ç‡æ£€æŸ¥', 1),
('HIGH_FREQUENCY_AUTO_BLACKLIST', 'false', 'BOOLEAN', 'è‡ªåŠ¨æ‹‰é»‘ï¼ˆfalse=ä»…é€Ÿç‡é™åˆ¶ï¼‰', 1),
('HIGH_FREQUENCY_BLACKLIST_DAYS', '3', 'NUMBER', 'æ‹‰é»‘å¤©æ•°', 1),
('HIGH_FREQUENCY_COOLDOWN_SECONDS', '60', 'NUMBER', 'å†·å´æ—¶é—´ï¼ˆç§’ï¼‰', 1),

-- ============ IPå¤šè´¦æˆ·æ£€æµ‹é…ç½® â­v1.8 ============
('IP_MULTI_ACCOUNT_BET_THRESHOLD', '500', 'NUMBER', 'IPä¸‹æ³¨æ¬¡æ•°é˜ˆå€¼', 1),
('IP_MULTI_ACCOUNT_DEVICE_THRESHOLD', '3', 'NUMBER', 'IPè®¾å¤‡æ•°é˜ˆå€¼', 1),
('IP_MULTI_ACCOUNT_TIME_WINDOW', '3600', 'NUMBER', 'æ£€æµ‹æ—¶é—´çª—å£ï¼ˆç§’ï¼‰', 1),
('IP_MULTI_ACCOUNT_CHECK_ENABLE', 'true', 'BOOLEAN', 'å¯ç”¨IPæ£€æŸ¥', 1),
('IP_BLACKLIST_DAYS', '30', 'NUMBER', 'IPæ‹‰é»‘å¤©æ•°', 1),

-- ============ å¸‚åœºæ³¢åŠ¨ä¿æŠ¤é…ç½® (v1.2) ============
('MARKET_VOLATILITY_THRESHOLD_1MIN', '5.0', 'NUMBER', '1åˆ†é’Ÿæ³¢åŠ¨ç‡é˜ˆå€¼ (%)', 1),
('MARKET_VOLATILITY_THRESHOLD_3MIN', '3.0', 'NUMBER', '3åˆ†é’Ÿæ³¢åŠ¨ç‡é˜ˆå€¼ (%)', 1),
('MARKET_SUSPENSION_DURATION', '300', 'NUMBER', 'å¸‚åœºæš‚åœæ—¶é•¿ï¼ˆç§’ï¼‰', 1),
('MARKET_VOLATILITY_CHECK_ENABLE', 'true', 'BOOLEAN', 'å¯ç”¨æ³¢åŠ¨ç‡æ£€æŸ¥', 1),

-- ============ é”™è¯¯æ¶ˆæ¯ ============
('DAILY_PROFIT_ERROR_MESSAGE', 'æ‚¨çš„è´¦æˆ·å·²å—é™ï¼šæ¯æ—¥åˆ©æ¶¦è¶…é™ã€‚è¯·è”ç³»å®¢æœã€‚', 'STRING', 'æ¯æ—¥åˆ©æ¶¦é™é¢é”™è¯¯æ¶ˆæ¯', 1),
('WIN_STREAK_ERROR_MESSAGE', 'æ‚¨çš„è´¦æˆ·å·²å—é™ï¼šè¿ç»­ç›ˆåˆ©è¶…é™ã€‚è¯·è”ç³»å®¢æœã€‚', 'STRING', 'è¿èƒœé”å®šé”™è¯¯æ¶ˆæ¯', 1),
('HIGH_WINRATE_ERROR_MESSAGE', 'æ‚¨çš„è´¦æˆ·å› èƒœç‡å¼‚å¸¸è€Œå—é™ã€‚è¯·è”ç³»å®¢æœã€‚', 'STRING', 'é«˜èƒœç‡é”™è¯¯æ¶ˆæ¯', 1),
('HIGH_FREQUENCY_ERROR_MESSAGE', 'æ‚¨çš„ä¸‹å•é€Ÿåº¦è¿‡å¿«ã€‚è¯·ç¨åå†è¯•ã€‚', 'STRING', 'é«˜é¢‘é€Ÿç‡é™åˆ¶æ¶ˆæ¯', 1),
('IP_MULTI_ACCOUNT_WARNING_MESSAGE', 'æ£€æµ‹åˆ°æ‚¨çš„IPåœ°å€ä¸‹æœ‰å¤šä¸ªè´¦æˆ·ã€‚æ‚¨çš„æ´»åŠ¨æ­£åœ¨è¢«ç›‘æ§ã€‚', 'STRING', 'IPå¤šè´¦æˆ·è­¦å‘Šæ¶ˆæ¯', 1),
('MARKET_SUSPENDED_ERROR_MESSAGE', 'è¯¥äº¤æ˜“å¯¹å› å¸‚åœºæ³¢åŠ¨æš‚æ—¶åœæ­¢äº¤æ˜“ã€‚è¯·ç¨åå†è¯•ã€‚', 'STRING', 'å¸‚åœºæš‚åœé”™è¯¯æ¶ˆæ¯', 1);
```

**é…ç½®ç»„**ï¼š

|é›†å›¢|è®¡æ•° |å…³é”®é…ç½®|
|-------|-------|-------------------|
|æ¯æ—¥åˆ©æ¶¦| 4 |`DAILY_PROFIT_LIMIT` |
|è¿èƒœâ­v1.9 | 6 |`WIN_STREAK_SCAN_INTERVAL` + `BATCH_SIZE` |
|é«˜èƒœç‡| 6 |`HIGH_WINRATE_SAMPLE_SIZE_MIN/MAX` + `MIN_BET_AMOUNT` |
|é«˜é¢‘| 6 |`HIGH_FREQUENCY_THRESHOLD` |
| IPå¤šè´¦æˆ·â­v1.8 | 5 |`IP_MULTI_ACCOUNT_BET_THRESHOLD` + `DEVICE_THRESHOLD` |
|å¸‚åœºæ³¢åŠ¨ (v1.2) | 4 |`MARKET_VOLATILITY_THRESHOLD_1MIN/3MIN` |
|é”™è¯¯æ¶ˆæ¯ | 6 | - |

---

## 6. ä¸šåŠ¡æµç¨‹è®¾è®¡

### 6.1 è®¾å¤‡æŒ‡çº¹é‡‡é›†

#### å‰ç«¯é›†åˆ

```javascript
// å¯¼å…¥ FingerprintJS
import FingerprintJS from '@fingerprintjs/fingerprintjs';

// åˆå§‹åŒ–å¹¶è·å–è®¾å¤‡æŒ‡çº¹
async function getDeviceFingerprint() {
  const fp = await FingerprintJS.load();
  const result = await fp.get();
  return result.visitorId; // è¿”å›è®¾å¤‡æŒ‡çº¹
}

// åˆ›å»ºè®¢å•æ—¶åŒ…å«è®¾å¤‡æŒ‡çº¹
async function createOrder(orderData) {
  const deviceFingerprint = await getDeviceFingerprint();

  return fetch('/api/borc/order', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Device-Fingerprint': deviceFingerprint  // é€šè¿‡è¯·æ±‚å¤´ä¼ é€’
    },
    body: JSON.stringify(orderData)
  });
}
```

#### åå°æ¥å¾…

```java
@PostMapping
public ApiResponse<OrderDTO> createOrder(
    @RequestBody @Valid CreateOrderRequest dto,
    @RequestHeader(value = "X-Real-IP", required = false) String clientIp,
    @RequestHeader(value = "User-Agent", required = false) String userAgent,
    @RequestHeader(value = "X-Device-Fingerprint", required = false) String deviceFingerprint,
    HttpServletRequest request) {

    // è·å–ç”¨æˆ·ID
    Long userId = SecurityUtils.getCurrentUserId();

    // å¦‚æœæ²¡æœ‰ X-Real-IPï¼Œä»è¯·æ±‚ä¸­è·å–
    if (clientIp == null) {
        clientIp = getClientIp(request);
    }

    // é£æ§æ£€æŸ¥ï¼ˆåŒ…æ‹¬IP/è®¾å¤‡æŒ‡çº¹æ£€æŸ¥ï¼‰
    riskControlService.checkOrderRisk(userId, dto, clientIp, deviceFingerprint);

    // åˆ›å»ºè®¢å•
    return ApiResponse.success(orderService.createOrder(dto, clientIp, userAgent, deviceFingerprint));
}
```

---

### 6.2 Redisæ•°æ®ç»“æ„

#### A. é»‘åå•ç¼“å­˜

**å¯†é’¥æ ¼å¼**ï¼š`bo:risk:blacklist:user:{userId}`æˆ–è€…`bo:risk:blacklist:ip:{ip}`
**ç±»å‹**ï¼šå­—ç¬¦ä¸²
**TTL**ï¼šæ ¹æ®é»‘åå•è¿‡æœŸæ—¶é—´è®¾ç½®

**æ›´æ–°æ—¶é—´**ï¼š
- å®šæ—¶ä»»åŠ¡æ£€æµ‹åˆ°é£é™©ç­–ç•¥è§¦å‘æ—¶å†™å…¥
- å½“IP/è®¾å¤‡æŒ‡çº¹æ£€æŸ¥è§¦å‘æ—¶å†™å…¥
- é»‘åå•åˆ°æœŸè‡ªåŠ¨æ¸…é™¤

---

#### B. IPç»Ÿè®¡ç¼“å­˜â­v1.8

**å¯†é’¥æ ¼å¼**ï¼š`bo:risk:ip:{ip}:{hourKey}`
**ç±»å‹**ï¼šå“ˆå¸Œ
**TTL**ï¼š2 å°æ—¶

**å°æ—¶å¯†é’¥ç”Ÿæˆ**ï¼š`yyyyMMddHH`ï¼ˆä¾‹å¦‚ï¼Œ2025122514ï¼‰

**å­—æ®µ**ï¼š
|é¢†åŸŸ |ç±»å‹ |æè¿° |
|-------|------|-------------|
| `bet_count`|æ•´æ•°|å½“å‰å°æ—¶å†…è¯¥ IP çš„æŠ•æ³¨æ¬¡æ•° |
| `devices`| JSON æ•°ç»„ |è®¾å¤‡æŒ‡çº¹é›†ï¼ˆå»é‡ï¼‰|

**ä¾‹å­**ï¼š
```
Key: bo:risk:ip:192.168.1.100:2025122514
Value: {
  "bet_count": 523,
  "devices": ["fp1", "fp2", "fp3", "fp4"]
}
TTL: 7200
```

**æ“ä½œæµç¨‹**ï¼š
1. å…³äºè®¢å•åˆ›å»ºï¼š`HINCRBY bet_count 1`
2. åˆ›å»ºè®¢å•æ—¶ï¼šè§£æè®¾å¤‡ JSONï¼Œæ·»åŠ å½“å‰è®¾å¤‡æŒ‡çº¹ï¼Œé‡æ–°åºåˆ—åŒ–
3. æ£€æŸ¥ï¼šå¦‚æœ`bet_count >= 500`å’Œ`devices.length >= 3`,è§¦å‘é»‘åå•
4. è‡ªåŠ¨è¿‡æœŸï¼š2å°æ—¶åè‡ªåŠ¨æ¸…é™¤

---

#### C. å¸‚åœºæš‚åœç¼“å­˜ï¼ˆv1.2ï¼‰

**å¯†é’¥æ ¼å¼**ï¼š`bo:risk:market:suspended:{symbol}`
**ç±»å‹**ï¼šå“ˆå¸Œ
**TTL**ï¼šæ ¹æ®æš‚åœæ—¶é•¿åŠ¨æ€è®¾ç½®

**å­—æ®µ**ï¼š
|é¢†åŸŸ |ç±»å‹ |æè¿° |
|-------|------|-------------|
| `reason`|å­—ç¬¦ä¸²|æš‚åœåŸå›  |
| `volatility_1min`|åè¿›åˆ¶| 1åˆ†é’Ÿæ³¢åŠ¨ç‡|
| `volatility_3min`|åè¿›åˆ¶| 3åˆ†é’Ÿæ³¢åŠ¨ç‡|
| `suspension_time`|æ—¶é—´æˆ³|æš‚åœæ—¶é—´ |
| `resume_time`|æ—¶é—´æˆ³|é¢„è®¡æ¢å¤æ—¶é—´|

---

### 6.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### A. å¢é‡æ‰«ææœºåˆ¶

**æ ¸å¿ƒæ€æƒ³**ï¼šä»…å¤„ç†è‡ªä¸Šæ¬¡æ‰«æä»¥æ¥æ–°ç»“ç®—çš„è®¢å•

**æ‰§è¡Œ**ï¼š
```sql
-- æŸ¥è¯¢å¢é‡è®¢å•
SELECT id, user_id, account_type, status, settle_time
FROM bo_option_order
WHERE user_id = ?
  AND account_type = ?
  AND id > ?  -- last_processed_order_id (å¢é‡èµ·ç‚¹)
  AND status IN ('WIN', 'LOSE', 'DRAW')
ORDER BY id ASC
LIMIT 100;
```

**æ€§èƒ½æ”¹è¿›**ï¼š
- âœ… é¿å…å…¨è¡¨æ‰«æ
- âœ… åªå¤„ç†æ–°è®¢å•
- âœ… æ¯ä¸ªç”¨æˆ·æœ€å¤š100ä¸ªè®¢å•ï¼Œé¿å…å¤§é‡è®¢å•ç§¯å‹

---

#### B. æ‰¹å¤„ç†ä¼˜åŒ–

**æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·**ï¼š
```sql
SELECT user_id, account_type, current_streak,
       last_processed_order_id, is_blacklisted
FROM bo_user_win_streak
WHERE is_blacklisted = 0  -- ä»…å¤„ç†æœªæ‹‰é»‘ç”¨æˆ·
  AND (last_scan_time IS NULL OR last_scan_time < NOW() - INTERVAL '30 second')
LIMIT 1000;  -- é™åˆ¶æ‰¹å¤„ç†å¤§å°
```

**æ‰¹é‡æ›´æ–°**ï¼š
```java
// äº‹åŠ¡æ‰¹é‡æ›´æ–°
@Transactional
public void batchUpdateWinStreak(List<UserWinStreak> updates) {
    for (UserWinStreak streak : updates) {
        winStreakMapper.updateByPrimaryKeySelective(streak);
    }
}
```

---

#### C. ç´¢å¼•ä¼˜åŒ–

**è®¢å•è¡¨ç´¢å¼•**ï¼š
```sql
-- å¢é‡æ‰«æç´¢å¼•
CREATE INDEX idx_order_incremental_scan
ON bo_option_order (user_id, account_type, id)
WHERE status IN ('WIN', 'LOSE', 'DRAW');

-- éƒ¨åˆ†ç´¢å¼•ï¼šä»…ç´¢å¼•å·²ç»“ç®—è®¢å•
CREATE INDEX idx_order_settled
ON bo_option_order (user_id, settle_time)
WHERE profit IS NOT NULL;
```

**è¿èƒœè¡¨æŒ‡æ•°**ï¼š
```sql
-- æ‰«æä»»åŠ¡æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_win_streak_scan
ON bo_user_win_streak (is_blacklisted, last_scan_time);

-- å¢é‡å¤„ç†ç´¢å¼•
CREATE INDEX idx_win_streak_processed
ON bo_user_win_streak (last_processed_order_id);
```

---

#### D. æ€§èƒ½ç›‘æ§æŒ‡æ ‡

|å…¬åˆ¶|ç›®æ ‡|æè¿° |
|--------|--------|-------------|
|å•æ¬¡æ‰«ææ—¶é—´| < 10 ç§’ | 1000 ä¸ªç”¨æˆ·çš„æ‰«ææ—¶é—´ |
|å•ç”¨æˆ·å¤„ç†æ—¶é—´| < 10 æ¯«ç§’ |åŒ…æ‹¬æŸ¥è¯¢+è®¡ç®—+æ›´æ–° |
|å¢é‡è®¢å•è®¡æ•° | < 100 ä¸ªè®¢å•/ç”¨æˆ· | 30ç§’æ–°å¢è®¢å• |
|ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ | 30 å¤šå² |å›ºå®šå»¶è¿Ÿ|
|é”äº‰ç”¨ç‡| < 1% |å¤šå®ä¾‹é”å†²çªç‡|

**ç›‘æ§æ—¥å¿—**ï¼š
```java
log.info("Win streak scan completed - " +
         "users processed: {}, " +
         "orders scanned: {}, " +
         "blacklisted: {}, " +
         "duration: {}ms",
         processedUsers, totalOrders, blacklistedCount, duration);
```

---

## 7. è®¡åˆ’ä»»åŠ¡è®¾è®¡

### 7.1 ä»»åŠ¡åˆ—è¡¨

|ä»»åŠ¡åç§° |é¢‘ç‡|è®¡åˆ’/å»¶è¿Ÿ |æœåŠ¡ |æè¿°â­v1.9 |
|-----------|-----------|-----------|---------|-------------------|
| **è¿èƒœæ‰«æ** â­ |æ¯ 30 ç§’ |`fixedDelay=30000`|è®¢å•æœåŠ¡ |å¢é‡æ‰«æè®¢å•ï¼Œæ£€æµ‹è¿èƒœå’Œé»‘åå• |
| **æ¯æ—¥åˆ©æ¶¦æ£€æµ‹** |æ¯ 5 åˆ†é’Ÿ |`0 */5 * * * ?`|è®¢å•æœåŠ¡ |åœ¨è§¦å‘å™¨ä¸Šæ’å…¥é»‘åå• |
| **èƒœç‡æ£€æµ‹** |æ¯å°æ—¶ :05 |`0 5 * * * ?`|è®¢å•æœåŠ¡ |åœ¨è§¦å‘å™¨ä¸Šæ’å…¥é»‘åå• |
| **é¢‘ç‡æ£€æµ‹** |æ¯åˆ†é’Ÿ |`0 * * * * ?`|è®¢å•æœåŠ¡ |åœ¨è§¦å‘å™¨ä¸Šæ’å…¥é»‘åå• |
|é»‘åå•è¿‡æœŸæ£€æŸ¥ |æ¯å°æ—¶ :01 |`0 1 * * * ?`|è®¢å•æœåŠ¡ |è‡ªåŠ¨åˆ é™¤è¿‡æœŸé»‘åå• |
|å¸‚åœºæ³¢åŠ¨ç›‘è§†å™¨ï¼ˆv1.2ï¼‰|æ¯åˆ†é’Ÿ |`0 * * * * ?`|å¸‚åœºæœåŠ¡|æ£€æµ‹å¸‚åœºæ³¢åŠ¨ |
|å¸‚åœºæ¢å¤æ£€æŸ¥ï¼ˆv1.2ï¼‰|æ¯ 5 åˆ†é’Ÿ |`0 */5 * * * ?`|å¸‚åœºæœåŠ¡|æ±½è½¦æ¢å¤å¸‚åœº|

**åˆ†å¸ƒå¼é”**ï¼š
- æ‰€æœ‰å®šæ—¶ä»»åŠ¡å‡ä½¿ç”¨Redisåˆ†å¸ƒå¼é”
- é”å®šå¯†é’¥æ ¼å¼ï¼š`bo:schedule:risk:{taskName}`
- é¿å…å¤šå®ä¾‹ç¯å¢ƒä¸‹é‡å¤æ‰§è¡Œ

---

### 7.2 ä»»åŠ¡æ‰§è¡Œæµç¨‹

#### è¿èƒœæ‰«æä»»åŠ¡ â­v1.9

```java
/**
 * è¿èƒœæ£€æµ‹å®šæ—¶ä»»åŠ¡ - v1.9
 */
@Component
@Slf4j
public class WinStreakScanTask {

    @Autowired
    private UserWinStreakMapper winStreakMapper;

    @Autowired
    private OrderMapper orderMapper;

    @Autowired
    private BlacklistService blacklistService;

    @Autowired
    private RiskConfigService riskConfigService;

    @Autowired
    private DistributedLock distributedLock;

    /**
     * è¿èƒœæ£€æµ‹æ‰«æä»»åŠ¡
     * æ‰§è¡Œé¢‘ç‡ï¼šæ¯30ç§’
     */
    @Scheduled(fixedDelay = 30000)
    @DistributedScheduled(
        lockKey = "bo:schedule:risk:win-streak-scan",
        expireTime = 25,
        timeUnit = TimeUnit.SECONDS,
        description = "è¿èƒœæ£€æµ‹æ‰«æä»»åŠ¡"
    )
    public void scanWinStreakIncremental() {
        log.debug("å¼€å§‹è¿èƒœæ‰«æä»»åŠ¡");

        try {
            // è·å–é…ç½®
            int batchSize = riskConfigService.getIntValue("WIN_STREAK_BATCH_SIZE", 1000);
            int orderLimit = riskConfigService.getIntValue("WIN_STREAK_ORDER_LIMIT", 100);
            int winStreakLimit = riskConfigService.getIntValue("WIN_STREAK_LIMIT", 8);

            // 1. æŸ¥è¯¢éœ€è¦æ£€æµ‹çš„ç”¨æˆ·ï¼ˆæœªæ‹‰é»‘ï¼Œé™åˆ¶æ‰¹æ¬¡å¤§å°ï¼‰
            List<UserWinStreak> users = winStreakMapper.selectNeedScan(batchSize);

            if (users.isEmpty()) {
                log.debug("æ²¡æœ‰éœ€è¦æ‰«æè¿èƒœçš„ç”¨æˆ·");
                return;
            }

            int blacklistedCount = 0;
            int processedUsers = 0;
            int totalOrders = 0;

            // 2. å¤„ç†æ¯ä¸ªç”¨æˆ·
            for (UserWinStreak userStreak : users) {
                try {
                    // æŸ¥è¯¢è¯¥ç”¨æˆ·çš„å¢é‡è®¢å•
                    List<Order> incrementalOrders = orderMapper.selectIncrementalOrders(
                        userStreak.getUserId(),
                        userStreak.getAccountType(),
                        userStreak.getLastProcessedOrderId(),
                        orderLimit
                    );

                    if (incrementalOrders.isEmpty()) {
                        continue;
                    }

                    totalOrders += incrementalOrders.size();

                    // 3. è®¡ç®—è¿èƒœ
                    int currentStreak = userStreak.getCurrentStreak();
                    Long maxOrderId = userStreak.getLastProcessedOrderId();

                    for (Order order : incrementalOrders) {
                        if ("WIN".equals(order.getStatus())) {
                            currentStreak++;

                            // è¾¾åˆ°è¿èƒœé˜ˆå€¼ï¼Œç«‹å³æ‹‰é»‘
                            if (currentStreak >= winStreakLimit && userStreak.getIsBlacklisted() == 0) {
                                autoBlacklistUserForWinStreak(userStreak, currentStreak);
                                blacklistedCount++;
                                break; // å·²æ‹‰é»‘ï¼Œåœæ­¢å¤„ç†è¯¥ç”¨æˆ·
                            }
                        } else if ("LOSE".equals(order.getStatus()) || "DRAW".equals(order.getStatus())) {
                            // é‡ç½®è¿èƒœ
                            currentStreak = 0;
                        }

                        maxOrderId = Math.max(maxOrderId, order.getId());
                    }

                    // 4. æ›´æ–°è¿èƒœè®°å½•
                    userStreak.setCurrentStreak(currentStreak);
                    userStreak.setMaxStreak(Math.max(userStreak.getMaxStreak(), currentStreak));
                    userStreak.setLastProcessedOrderId(maxOrderId);
                    userStreak.setLastScanTime(LocalDateTime.now());

                    winStreakMapper.updateByPrimaryKey(userStreak);
                    processedUsers++;

                } catch (Exception e) {
                    log.error("å¤„ç†ç”¨æˆ·è¿èƒœå¤±è´¥: {}", userStreak.getUserId(), e);
                }
            }

            log.info("è¿èƒœæ‰«æå®Œæˆ - å¤„ç†: {} ç”¨æˆ·, {} è®¢å•, æ‹‰é»‘: {}",
                     processedUsers, totalOrders, blacklistedCount);

        } catch (Exception e) {
            log.error("è¿èƒœæ‰«æä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
        }
    }

    /**
     * å› è¿èƒœè‡ªåŠ¨æ‹‰é»‘ç”¨æˆ·
     */
    private void autoBlacklistUserForWinStreak(UserWinStreak winStreak, int currentStreak) {
        try {
            int banDays = riskConfigService.getIntValue("WIN_STREAK_BLACKLIST_DAYS", 7);

            // 1. åˆ›å»ºé»‘åå•è®°å½•
            Blacklist blacklist = new Blacklist();
            blacklist.setUserId(winStreak.getUserId());
            blacklist.setBlacklistType("WIN_STREAK");
            blacklist.setReason(String.format(
                "è‡ªåŠ¨æ‹‰é»‘: æ£€æµ‹åˆ°%dè¿èƒœ",
                currentStreak
            ));
            blacklist.setType("auto");
            blacklist.setAutoTriggerRule("WIN_STREAK_8");
            blacklist.setTriggerValue(String.format("è¿èƒœ: %d", currentStreak));
            blacklist.setStartTime(LocalDateTime.now());
            blacklist.setEndTime(LocalDateTime.now().plusDays(banDays));
            blacklist.setStatus(1);

            blacklistService.insert(blacklist);

            // 2. æ›´æ–°è¿èƒœæ‹‰é»‘æ ‡å¿—
            winStreak.setIsBlacklisted(1);
            winStreak.setBlacklistTime(LocalDateTime.now());
            winStreak.setBlacklistTriggerStreak(currentStreak);

            log.warn("ç”¨æˆ· {} å› {}è¿èƒœè¢«æ‹‰é»‘",
                     winStreak.getUserId(), currentStreak);

        } catch (Exception e) {
            log.error("è¿èƒœæ‹‰é»‘ç”¨æˆ·å¤±è´¥: {}", winStreak.getUserId(), e);
        }
    }
}
```

---

## æ¦‚æ‹¬

### v1.10 ä¸»è¦æ”¹è¿› â­

|æ”¹è¿›|æè¿° |
|-------------|-------------|
| **æ–‡æ¡£æ ‡å‡†åŒ–** |æŒ‰ç…§æŠ€æœ¯æ–‡æ¡£æ ‡å‡†é‡ç»„ç»“æ„ |
| **åŸºäºç‰¹å¾çš„æ¶æ„** |æŒ‰åŠŸèƒ½æ¨¡å—åˆ†ç»„æ¶æ„è®¾è®¡ï¼ˆ6å¤§åŠŸèƒ½ï¼‰|
| **åˆ†ç¦»è¡¨æ¶æ„** |è¡¨ç»“æ„æ¶æ„ä¸è¡¨ç»“æ„è®¾è®¡åˆ†ç¦»|
| **æ•°æ®æµç»„ç»‡** |æŒ‰åŠŸèƒ½æ¨¡å—é‡æ–°ç»„ç»‡æ•°æ®æµè®¾è®¡ï¼ˆ7å¤§æµç¨‹ï¼‰|
| **å¢å¼ºå¯è¯»æ€§** |æ¸…æ™°çš„ç« èŠ‚å±‚æ¬¡ç»“æ„å’Œé€»è¾‘æµç¨‹ |

### v1.9 æ ¸å¿ƒä¼˜åŒ–ï¼ˆç»§æ‰¿ï¼‰

|ä¼˜åŒ–| v1.2/v1.8 æ–¹æ³• | v1.9 æ–¹æ³• |
|--------------|-------------------|--------------|
| **è¿èƒœæ£€æµ‹** |è®¢å•ç»“ç®—æ—¶è§¦å‘ | âœ… è®¡åˆ’ä»»åŠ¡æ‰«æï¼ˆ30 ç§’ï¼‰|
| **ä¸šåŠ¡è€¦åˆ** |ç»“ç®—æµç¨‹å‘¼å”¤é£é™©æ§åˆ¶| âœ… å½»åº•è§£è€¦ |
| **è®¢å•ç»“ç®—è¡¨ç°** |æ¯ä¸ªè®¢å• +5-10ms | âœ… é›¶å½±å“ï¼ˆ0msï¼‰|
| **æ£€æµ‹å»¶è¿Ÿ** | 0ç§’ï¼ˆå®æ—¶ï¼‰| âœ… æœ€é•¿ 30 ç§’ï¼ˆå¯æ¥å—ï¼‰|
| **æ‰¹å¤„ç†** |æŒ‰è®¢å•å¤„ç† | âœ… æ‰¹é‡1000ä¸ªç”¨æˆ· |
| **å¢é‡æ‰«æ** |ä¸æ”¯æŒ | âœ… æ”¯æŒ (last_processed_order_id) |
| **æ€§èƒ½ç›‘æ§** |åˆ†æ•£ï¼Œéš¾ä»¥è¿½è¸ª| âœ… é›†ä¸­åŒ–ï¼Œæ˜“äºç›‘æ§ |
| **ç»´æŠ¤å›°éš¾** |é«˜ï¼ˆä¸šåŠ¡å…¥ä¾µï¼‰| âœ… ä½ï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰ |

### æŠ€æœ¯äº®ç‚¹

- âœ¨ **å®Œå…¨è§£è€¦**ï¼šè®¢å•ä¸šåŠ¡å®Œå…¨ä¸æ„ŸçŸ¥è¿èƒœæ£€æµ‹â­v1.9
- âœ¨ **å¢é‡æ‰«æ**ï¼šåªå¤„ç†æ–°è®¢å•ï¼Œé¿å…é‡å¤è®¡ç®—â­v1.9
- âœ¨ **æ‰¹é‡ä¼˜åŒ–**ï¼š1000ä¸ªç”¨æˆ·æ‰¹é‡ï¼Œæœ€ä½³æ€§èƒ½â­v1.9
- âœ¨ **ç´¢å¼•ä¼˜åŒ–**ï¼šå¢é‡æŸ¥è¯¢ä¸“ç”¨ç´¢å¼•â­v1.9
- âœ¨ **å¯è§‚å¯Ÿæ€§**ï¼šå®šæ—¶ä»»åŠ¡ç»Ÿä¸€ç›‘æ§â­v1.9
- âœ¨ **é»‘åå•é©±åŠ¨**ï¼šæ‰€æœ‰é£é™©ç­–ç•¥éƒ½ä¼šè§¦å‘é»‘åå•æ’å…¥
- âœ¨ **æœ€å°æ¶æ„**ï¼šè®¢å•æµä»…æ£€æŸ¥é»‘åå•+IP/è®¾å¤‡æŒ‡çº¹+å¸‚åœºæš‚åœ
- âœ¨ **å®æ—¶æ‹¦æˆª**ï¼šIPå¤šè´¦æˆ·å¼‚å¸¸ç«‹å³æ‹¦æˆª
- âœ¨ **è®¾å¤‡æŒ‡çº¹**ï¼šå®Œæ•´çš„è®¾å¤‡æŒ‡çº¹é‡‡é›†å’ŒéªŒè¯æœºåˆ¶
- âœ¨ **æ ‡å‡†åŒ–æ–‡æ¡£**ï¼šéµå¾ªæŠ€æœ¯æ–‡æ¡£æ ‡å‡†çš„æ¸…æ™°ç»“æ„â­v1.10

---

**æ–‡æ¡£ç»´æŠ¤**ï¼š
- ç‰ˆæœ¬ï¼šv1.10ï¼ˆæ ‡å‡†åŒ–ç»“æ„ï¼‰
- åˆ›å»ºæ—¥æœŸï¼š2025-12-24
- ä¿®è®¢æ—¥æœŸï¼š2025-12-25
- æ‰€æœ‰è€…ï¼šå¼€å‘å›¢é˜Ÿ
- å®¡ç¨¿äººï¼šæŠ€æœ¯è´Ÿè´£äºº

---

*æœ¬æ–‡æ¡£æ˜¯TGW-3è¦æ±‚v1.10ï¼ˆæ ‡å‡†åŒ–ç»“æ„ï¼‰çš„æŠ€æœ¯è®¾è®¡è§„èŒƒï¼Œç»è¿‡é‡æ–°ç»„ç»‡ï¼Œéµå¾ªæŠ€æœ¯æ–‡æ¡£æ ‡å‡†ï¼Œé‡‡ç”¨åŸºäºç‰¹å¾çš„æ¶æ„è®¾è®¡ã€åˆ†ç¦»çš„è¡¨ç»“æ„æ¶æ„å’Œç»„ç»‡çš„æ•°æ®æµè®¾è®¡ã€‚ä¿ç•™v1.9çš„æ‰€æœ‰æŠ€æœ¯å†…å®¹ï¼ŒåŒ…æ‹¬å®Œæ•´çš„è¡¨ç»“æ„SQLã€æµç¨‹å›¾ã€ä¸šåŠ¡é€»è¾‘å’Œå®æ–½è®¡åˆ’ã€‚*
