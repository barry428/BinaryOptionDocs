# 24小时最高、最低、涨跌幅获取方案

## 1. 概述

通过订阅 BTSE WebSocket 获取：
1. **指数价格**（index-price:USDT）→ 写入 Redis `pricer:index`，使用 BTSE 官方指数价格
2. **24小时价格统计数据**（最高价、最低价、涨跌幅、成交量）→ 存内存，直接推送给客户端

**数据来源**: BTSE WebSocket API

| 数据类型 | WebSocket端点 | 订阅频道 | 推送频率 | 存储位置 | 用途 |
|---------|--------------|---------|---------|---------|------|
| 指数价格 | `/ws/spot` | `index-price:USDT` | 实时 | Redis | 使用官方指数价格 |
| 24h统计 | `/public-api` | `changeIn24HrBySymbol` | 每 500ms | 内存 | 最高/最低/涨跌幅 |

**Symbol List is read from Redis (BO:Symbols:Active) written by order-service.**

## 2. 需要修改的文件

```
BinaryOption/
├── option-common-utils/
│   └── src/main/java/com/binaryoption/commonutils/constants/
│       └── CacheConstants.java                    # [已有] PRICER_INDEX_KEY 无需修改
│
├── option-market-service/
│   └── src/main/java/com/binaryoption/marketservice/
│       ├── btse/
│       │   ├── BtseMarketWebSocketClient.java     # [新增] BTSE WebSocket客户端
│       │   └── BtseMarketWebSocketConfig.java     # [新增] WebSocket配置类
│       │
│       ├── cache/
│       │   └── MarketTickCacheService.java        # [修改] get24hStats()从内存读取
│       │
│       └── Application.java                       # [修改] 添加@EnableScheduling
│
└── option-market-service/
    └── src/main/resources/
        └── application.yml                        # [修改] 添加BTSE WebSocket配置
```

### 2.1 文件修改说明

| 文件 | 操作 | 说明 |
|------|------|------|
| `BtseMarketWebSocketClient.java` | 新增 | BTSE WebSocket客户端，从Redis读取币对列表，订阅 `lastPrice` 写Redis，订阅 `changeIn24HrBySymbol` 存内存 |
| `BtseMarketWebSocketConfig.java` | 新增 | 配置类，通过 `@ConditionalOnProperty` 控制是否启用 |
| `MarketTickCacheService.java` | 修改 | `get24hStats()` 方法从内存（BtseMarketWebSocketClient）读取24h数据 |
| `Application.java` | 修改 | 添加 `@EnableScheduling` 注解支持心跳和币对更新定时任务 |
| `application.yml` | 修改 | 添加 `btse.websocket.*` 配置项（不含symbols，从Redis读取） |

## 3. BTSE WebSocket API

### 3.1 连接地址

系统连接两个独立的 WebSocket 端点：

| 用途 | 端点路径 | 完整地址示例 |
|------|---------|-------------|
| 指数价格 | `/ws/spot` | `wss://ws.btse.com/ws/spot` |
| 24h统计 | `/public-api` | `wss://ws.btse.com/public-api` |

**环境配置**:
| 环境 | 基础地址 |
|------|---------|
| 生产环境 | `wss://ws.btse.com` |
| 测试环境 | `wss://testws.btse.io` |
| 预发布环境 | `wss://ws.btse.co` |
| 开发环境 | `wss://ws.btse.dev` |

### 3.2 订阅请求

```json
// 订阅指数价格 (通过 /ws/spot 端点)
{"op":"subscribe","args":["systemEvent","index-price:USDT"]}

// 订阅24h统计数据 (通过 /public-api 端点)
{"op":"subscribe","channel":"changeIn24HrBySymbol","params":["BTC-USDT","ETH-USDT"]}
```

### 3.3 响应数据格式

#### 3.3.1 指数价格响应 (index-price:USDT) → 写入Redis

```json
{
  "topic": "index-price:USDT",
  "data": {
    "BTC": 92689.7730931913,
    "ETH": 3323.819385200316,
    "SOL": 139.17986818539651,
    "BNB": 894.0319060388337,
    "XRP": 2.0883639469480006,
    ...
  }
}
```

**处理逻辑**:
- 遍历 `data` 对象中的所有键值对
- 将基础货币转换为完整交易对（如 `BTC` → `BTC-USDT`）
- 根据配置的活跃交易对列表过滤
- 写入 `pricer:index` Redis Hash

#### 3.3.2 24小时统计数据响应 (changeIn24HrBySymbol) → 存内存

```json
{
  "channel": "changeIn24HrBySymbol",
  "params": "BTC-USDT",
  "data": {
    "price": "66922.4",
    "change": "0.009",
    "volume": "2909.2",
    "high": "67186.4",
    "low": "65922.6"
  }
}
```

**处理逻辑**: 解析后存入内存 `ConcurrentHashMap<String, Stats24h>`

### 3.4 心跳保活

```json
{"op": "ping"}
```

**建议**: 每 30 秒发送一次 ping（两个 WebSocket 连接都需要发送）

## 4. 整体架构

```
+----------------------------------+     +----------------------------------+
|     BTSE Spot WebSocket          |     |    BTSE Public WebSocket         |
|   wss://ws.btse.com/ws/spot      |     |  wss://ws.btse.com/public-api    |
+----------------+-----------------+     +----------------+-----------------+
                 |                                        |
                 | index-price:USDT                       | changeIn24HrBySymbol
                 | (所有USDT交易对指数价格)               | (每500ms推送)
                 v                                        v
+-------------------------------------------------------------------+
|                  BtseMarketWebSocketClient                         |
|                   (option-market-service)                          |
|                                                                    |
|  IndexPriceWebSocketHandler        Stats24hWebSocketHandler        |
|  handleIndexPriceUpdate()          handle24hStatsUpdate()          |
|  → 写入 Redis pricer:index         → 存入内存 stats24hCache        |
|                                                                    |
|  checkAndUpdateSubscriptions() (每60秒)                            |
|  → 从 Redis 读取 BO:Symbols:Active，检测变化并重新订阅24h统计      |
+-----------------------------+-------------------------------------+
            |                                   |
            v                                   v
+------------------------+          +---------------------------+
|        Redis           |          |    Memory (ConcurrentMap) |
|                        |          |                           |
| Key: pricer:index      |          | Key: BTC-USDT             |
| Field: BTC-USDT        |          | Value: Stats24h {         |
| Value: "92689.77"      |          |   high, low, change,      |
|                        |          |   volume, timestamp       |
| Key: BO:Symbols:Active |          | }                         |
| Value: List<String>    |          +---------------------------+
| (由order-service写入)  |                      |
+------------------------+                      |
            |                                   |
            +-----------------------------------+
                               |
                               v
+-------------------------------------------------------------------+
|                  MarketTickCacheService                            |
|                                                                    |
|  getIndexPrice(symbol) → 从 Redis 读取                             |
|  get24hStats(symbol) → 从内存读取                                  |
|  getMarketTick(symbol) → 合并返回 MarketTickDTO                    |
+-------------------------------------------------------------------+
                               |
                               v
              MarketWebSocketHandler.pushMarketData()
                               |
                               v
                     前端 WebSocket 客户端
```

## 5. 数据存储

### 5.1 Redis (Index Price)

| Redis Key | 类型 | 说明 | 数据来源 |
|-----------|------|------|----------|
| `pricer:index` | Hash | 指数价格（Index Price） | index-price:USDT topic |

```bash
# 指数价格 (来自 BTSE 官方指数价格)
HSET pricer:index BTC-USDT "92689.7730931913"
HSET pricer:index ETH-USDT "3323.819385200316"
```

### 5.2 内存 (24h统计数据)

24h数据存储在 `BtseMarketWebSocketClient.stats24hCache` 中：

```java
// 数据结构
public record Stats24h(
    BigDecimal high,      // 24小时最高价
    BigDecimal low,       // 24小时最低价
    BigDecimal change,    // 24小时涨跌幅（小数形式 0.009 = 0.9%）
    BigDecimal volume,    // 24小时成交量
    long timestamp        // 更新时间戳
) {}

// 存储
Map<String, Stats24h> stats24hCache = new ConcurrentHashMap<>();
```

## 6. 配置项

在 `application.yml` 中：

```yaml
btse:
  websocket:
    # 是否启用BTSE WebSocket (外部报价系统就绪后可设为false)
    enabled: ${BTSE_WEBSOCKET_ENABLED:true}
    # WebSocket连接地址 (只配置基础地址，路径 /public-api 在代码中拼接)
    url: ${BTSE_WEBSOCKET_URL:wss://ws.btse.com}
    # 订阅的交易对列表从Redis读取 (BO:Symbols:Active)，由order-service写入
    # 心跳间隔(毫秒)
    ping-interval: ${BTSE_WEBSOCKET_PING_INTERVAL:30000}
    # 重连延迟(毫秒)
    reconnect-delay: ${BTSE_WEBSOCKET_RECONNECT_DELAY:5000}
```

### 6.1 交易对列表来源

交易对列表不再通过配置文件指定，而是动态从Redis读取：

- **Redis Key**: `BO:Symbols:Active`
- **写入方**: order-service 的 SymbolService
- **数据格式**: `List<String>` (如 `["BTC-USDT", "ETH-USDT", ...]`)
- **更新检测**: 每60秒检查一次，自动处理增减变化

## 7. 涨跌幅计算说明

BTSE 返回的 `change` 字段是小数形式：
- `0.009` 表示 +0.9%
- `-0.012` 表示 -1.2%

**后端处理**: `MarketTickCacheService.get24hStats()` 读取时乘以100转为百分比

**前端展示**:
```javascript
// price24hChange 已经是百分比形式
const displayText = (price24hChange >= 0 ? '+' : '') + price24hChange.toFixed(2) + '%';
// 0.9 -> "+0.90%"
// -1.2 -> "-1.20%"
```

## 8. 与现有方案的关系

本方案使用 BTSE 官方指数价格：

| 数据 | 数据来源 | 存储位置 | 说明 |
|------|---------|---------|------|
| 指数价格 | index-price:USDT | Redis `pricer:index` | BTSE 官方指数价格 |
| 24h最高价 | changeIn24HrBySymbol | 内存 | 24小时最高成交价 |
| 24h最低价 | changeIn24HrBySymbol | 内存 | 24小时最低成交价 |
| 24h涨跌幅 | changeIn24HrBySymbol | 内存 | 24小时涨跌幅百分比 |
| 24h成交量 | changeIn24HrBySymbol | 内存 | 24小时成交量 |

### 8.1 指数价格说明

**使用 BTSE 官方 index-price 作为指数价格**：

- **数据来源**：`wss://ws.btse.com/ws/spot` 的 `index-price:USDT` topic
- **数据格式**：一次推送包含所有 USDT 交易对的指数价格
- **写入位置**：`pricer:index`（与原设计一致，无需修改读取代码）
- **禁用方式**：设置 `btse.websocket.enabled=false` 即可禁用

### 8.2 注意事项

- **数据精度**：index-price 是 BTSE 计算的综合指数价格，相比 lastPrice 更加稳定
- **推送频率**：index-price 实时推送，包含所有交易对
- **24h数据生命周期**：存内存，服务重启后需要等待BTSE推送才有数据
- **双 WebSocket 连接**：系统维护两个独立的 WebSocket 连接，分别用于指数价格和24h统计

## 9. 测试验证

### 9.1 WebSocket连接测试

```bash
# 测试指数价格 (spot WebSocket)
wscat -c wss://ws.btse.com/ws/spot

# 发送订阅请求
{"op":"subscribe","args":["systemEvent","index-price:USDT"]}

# 预期收到指数价格推送
{"topic":"index-price:USDT","data":{"BTC":92689.77,"ETH":3323.81,"SOL":139.17,...}}

# 测试24h统计 (public-api WebSocket)
wscat -c wss://ws.btse.com/public-api

# 发送订阅请求
{"op":"subscribe","channel":"changeIn24HrBySymbol","params":["BTC-USDT"]}

# 预期收到24h统计数据推送
{"channel":"changeIn24HrBySymbol","params":"BTC-USDT","data":{"price":"66922.4","change":"0.009","volume":"2909.2","high":"67186.4","low":"65922.6"}}
```

### 9.2 Redis数据验证

```bash
# 查看指数价格 (Index Price)
redis-cli HGETALL pricer:index
```

### 9.3 API响应验证

```bash
# 调用market接口，验证返回数据包含完整字段
curl http://localhost:8083/api/market/tick/BTC-USDT

# 预期响应
{
  "code": 200,
  "data": {
    "symbol": "BTC-USDT",
    "price": 66925.8,
    "price24hMax": 67186.4,
    "price24hMin": 65922.6,
    "price24hChange": 0.9,
    "timestamp": 1733836800000
  }
}
```
