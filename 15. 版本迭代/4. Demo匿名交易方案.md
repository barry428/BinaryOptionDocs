# DemoåŒ¿åäº¤æ˜“æ–¹æ¡ˆ

## 1. ä¸šåŠ¡èƒŒæ™¯

### 1.1 ç°çŠ¶é—®é¢˜
- **æ³¨å†Œé—¨æ§›é«˜**: ç”¨æˆ·å¿…é¡»å…ˆæ³¨å†Œæ‰èƒ½ä½“éªŒDemoäº¤æ˜“ï¼Œå¯¼è‡´æµå¤±ç‡é«˜
- **ä½“éªŒå»¶è¿Ÿ**: æ–°ç”¨æˆ·æ— æ³•ç«‹å³ä½“éªŒäº§å“æ ¸å¿ƒåŠŸèƒ½
- **è½¬åŒ–ç‡ä½**: éƒ¨åˆ†ç”¨æˆ·å› ä¸ºæ³¨å†Œæµç¨‹ç¹çè€Œæ”¾å¼ƒä½¿ç”¨

### 1.2 ä¼˜åŒ–ç›®æ ‡
- **å³å¼€å³ç”¨**: æœªç™»å½•ç”¨æˆ·å¯ä»¥ç›´æ¥è¿›è¡ŒDemoäº¤æ˜“
- **ç‹¬ç«‹è´¦æˆ·**: ç™»å½•ååˆ›å»ºå…¨æ–°æ­£å¼ç”¨æˆ·ï¼ŒDemoè´¦æˆ·ç‹¬ç«‹ä¿ç•™
- **ç®€å•æ¸…æ™°**: æ— æ•°æ®åˆå¹¶ï¼Œé¿å…å¤æ‚çš„è½¬æ¢é€»è¾‘

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```mermaid
flowchart TB
    subgraph Frontend["Frontend (Vue)"]
        subgraph TokenManager["Token Manager (auth.ts)"]
            OAuthToken["OAuth Token<br/>æ­£å¼ç”¨æˆ·"]
            DemoToken["Demo Token<br/>åŒ¿åç”¨æˆ·"]
        end
        LocalStorage["localStorage"]
        AuthCheck["isAuthenticated =<br/>hasOAuthToken || hasDemoToken"]

        OAuthToken --> LocalStorage
        DemoToken --> LocalStorage
        TokenManager --> AuthCheck
    end

    subgraph Backend["Backend Services"]
        subgraph GatewayFilter["Gateway Token Filter"]
            Step1["1. æ£€æŸ¥OAuth Token"]
            Step2["2. æ£€æŸ¥Demo Token"]
            Step3["3. éªŒè¯JWT + æ³¨å…¥Headers"]
            Step4["4. æ— Tokenåˆ™åˆ›å»ºç”¨æˆ·"]
        end

        subgraph SecurityFilter["Security Filter"]
            AuthType["X-Auth-Type"]
            OAuth["OAuth â†’ æ­£å¼ç”¨æˆ·"]
            Demo["Demo â†’ Demoç”¨æˆ·"]
            AuthType --> OAuth
            AuthType --> Demo
        end

        subgraph Storage["å­˜å‚¨å±‚"]
            DB[("bo_user<br/>+is_demoå­—æ®µ")]
            Redis[("Redisç¼“å­˜<br/>ç”¨æˆ·IDæ˜ å°„")]
        end

        GatewayFilter --> SecurityFilter
        SecurityFilter --> Storage
    end

    Frontend -->|APIè¯·æ±‚<br/>Token| Backend
```

### 2.2 æ•°æ®åº“è®¾è®¡

#### 2.2.1 ç”¨æˆ·è¡¨æ‰©å±• (bo_user)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| is_demo | BOOLEAN | Demoç”¨æˆ·æ ‡è¯†ï¼ˆTRUE=Demoç”¨æˆ·ï¼ŒFALSE=æ­£å¼ç”¨æˆ·ï¼‰|

**external_idç”¨é€”**ï¼š
- **Demoç”¨æˆ·**: åç«¯ç”Ÿæˆçš„æ ‡è¯†ï¼ˆä¾‹å¦‚ï¼š`demo_20251128_abc123`ï¼‰
- **æ­£å¼ç”¨æˆ·**: OAuthæä¾›çš„external_id

#### 2.2.2 è´¦æˆ·åˆ›å»ºè§„åˆ™

| ç”¨æˆ·ç±»å‹ | DEMOè´¦æˆ· | REALè´¦æˆ· | è¯´æ˜ |
|---------|----------|----------|------|
| Demoç”¨æˆ·ï¼ˆé¦–æ¬¡è®¿é—®ï¼‰ | âœ… åˆ›å»ºï¼ˆ10000 USDTï¼‰ | âŒ ä¸åˆ›å»º | åŒ¿åç”¨æˆ·åªèƒ½ä½¿ç”¨Demoäº¤æ˜“ |
| æ­£å¼ç”¨æˆ·ï¼ˆç›´æ¥ç™»å½•ï¼‰ | âœ… åˆ›å»ºï¼ˆ10000 USDTï¼‰ | âœ… åˆ›å»ºï¼ˆ0 USDTï¼‰ | æ­£å¼ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸¤ç§è´¦æˆ· |
| Demoç”¨æˆ·ç™»å½•å | âŒ Demoç”¨æˆ·ç‹¬ç«‹ä¿ç•™ | âœ… åˆ›å»ºå…¨æ–°æ­£å¼ç”¨æˆ· | ä¸åšåˆå¹¶ï¼Œåˆ›å»ºå…¨æ–°ç”¨æˆ· |

### 2.3 Tokenè®¾è®¡ï¼ˆåç«¯ç”ŸæˆJWTï¼‰

#### 2.3.1 JWTç»“æ„

```
Header.Payload.Signature

Header:  { "alg": "HS256", "typ": "JWT" }
Payload: { "type": "demo", "sub": "demo_20251128_abc123", "iat": 1732752000 }
Signature: HMAC-SHA256(base64(Header) + "." + base64(Payload), SECRET_KEY)
```

**Payloadå­—æ®µ**ï¼š
- `type`: å›ºå®šä¸º "demo"ï¼Œæ ‡è¯†Tokenç±»å‹
- `sub`: external_idï¼Œæ ¼å¼ä¸º `demo_{date}_{random}`
- `iat`: ç­¾å‘æ—¶é—´æˆ³

#### 2.3.2 ç”Ÿæˆæµç¨‹

```
ç”¨æˆ·é¦–æ¬¡è®¿é—®ï¼ˆæ— Tokenï¼‰
    â†“
Gatewayæ£€æµ‹æ— Token
    â†“
åç«¯ç”ŸæˆexternalId: demo_20251128_abc123
    â†“
åç«¯ç”¨å¯†é’¥ç­¾åç”ŸæˆJWT
    â†“
åˆ›å»ºDemoç”¨æˆ·ï¼Œè¿”å›JWTç»™å‰ç«¯
    â†“
å‰ç«¯ä¿å­˜åˆ°localStorageï¼Œåç»­è¯·æ±‚æºå¸¦
```

#### 2.3.3 éªŒè¯æµç¨‹

```
å‰ç«¯è¯·æ±‚æºå¸¦: X-Demo-Token: eyJhbGci...
    â†“
Gatewayç”¨å¯†é’¥éªŒè¯JWTç­¾å
    â†“
ç­¾åæœ‰æ•ˆ â†’ æå–externalId â†’ æŸ¥è¯¢userId
ç­¾åæ— æ•ˆ â†’ æ‹’ç»è¯·æ±‚
```

### 2.4 æ ¸å¿ƒæµç¨‹è®¾è®¡

#### 2.4.1 Demoç”¨æˆ·åˆ›å»ºæµç¨‹

```mermaid
sequenceDiagram
    participant Frontend as å‰ç«¯
    participant Gateway as Gateway<br/>(DemoTokenFilter)
    participant UserRPC as UserRpcClient
    participant UserService as UserService
    participant DB as bo_user
    participant Redis as Redis

    Frontend->>Frontend: æ£€æŸ¥localStorageæ˜¯å¦æœ‰DemoToken
    alt æ²¡æœ‰DemoTokenä¸”æœªç™»å½•
        Frontend->>Gateway: è¯·æ±‚ä»»æ„API (æ— Authorization, æ— X-Demo-Token)
        Gateway->>Gateway: æ£€æµ‹æ— OAuth Token
        Gateway->>Gateway: æ£€æµ‹æ— Demo Token
        Gateway->>Gateway: ç”ŸæˆexternalId: demo_{date}_{random}
        Gateway->>Gateway: ç”¨å¯†é’¥ç”ŸæˆJWT Token
        Gateway->>UserRPC: resolveDemoUser(externalId)
        UserRPC->>UserService: createOrGetDemoUser(externalId)

        UserService->>UserService: ç”Ÿæˆnickname: Demo_{random8}
        UserService->>DB: INSERT INTO bo_user<br/>(external_id, is_demo=TRUE, nickname)
        UserService->>UserService: åªåˆ›å»ºDEMOè´¦æˆ·<br/>åˆå§‹åŒ–10000 USDT<br/>(ä¸åˆ›å»ºREALè´¦æˆ·)
        UserService-->>UserRPC: è¿”å›userId
        UserRPC-->>Gateway: è¿”å›userId
        Gateway->>Redis: ç¼“å­˜ externalId â†’ userId
        Gateway->>Gateway: æ³¨å…¥Headers<br/>X-User-Id, X-Auth-Type=Demo
        Gateway-->>Frontend: è¿”å›å“åº”<br/>Header: X-Demo-Token={JWT}
        Frontend->>Frontend: ä¿å­˜JWTåˆ°localStorage
    else å·²æœ‰DemoToken
        Frontend->>Gateway: è¯·æ±‚API (X-Demo-Token: JWT)
        Gateway->>Gateway: éªŒè¯JWTç­¾å
        Gateway->>Gateway: æå–externalId
        Gateway->>Redis: æŸ¥è¯¢ç¼“å­˜userId
        alt ç¼“å­˜å‘½ä¸­
            Gateway->>Gateway: æ³¨å…¥X-User-Id
        else ç¼“å­˜æœªå‘½ä¸­
            Gateway->>UserRPC: resolveDemoUser(externalId)
            UserRPC->>DB: SELECT * FROM bo_user WHERE external_id = ?
            UserRPC-->>Gateway: è¿”å›userId
            Gateway->>Redis: ç¼“å­˜ externalId â†’ userId
            Gateway->>Gateway: æ³¨å…¥X-User-Id
        end
        Gateway-->>Frontend: ç»§ç»­å¤„ç†è¯·æ±‚
    end
```

#### 2.4.2 Demoç”¨æˆ·ç™»å½•æµç¨‹ï¼ˆä¸åˆå¹¶ï¼Œåˆ›å»ºæ–°ç”¨æˆ·ï¼‰

```mermaid
sequenceDiagram
    participant Frontend as å‰ç«¯
    participant Gateway as Gateway
    participant UserRPC as UserRpcClient
    participant UserService as UserService
    participant DB as bo_user
    participant Redis as Redis

    Frontend->>Frontend: ç”¨æˆ·ç‚¹å‡»ç™»å½•
    Frontend->>Frontend: è·å–localStorageä¸­çš„DemoToken (JWT)
    Frontend->>Gateway: POST /api/auth/login<br/>Authorization: Bearer {OAuthToken}<br/>X-Demo-Token: {JWT}

    Gateway->>Gateway: éªŒè¯OAuth Token
    Gateway->>Redis: æŸ¥è¯¢OAuth Tokenä¿¡æ¯
    Redis-->>Gateway: è¿”å›Tokenä¿¡æ¯(å«realExternalId)

    Note over Gateway: å¿½ç•¥X-Demo-Token<br/>ä¸åšä»»ä½•åˆå¹¶æ“ä½œ

    Gateway->>UserRPC: resolveOAuthUser(realExternalId)

    UserRPC->>UserService: createOrGetRealUser(realExternalId)

    UserService->>DB: SELECT * FROM bo_user<br/>WHERE external_id = realExternalId

    alt æ­£å¼ç”¨æˆ·å·²å­˜åœ¨
        DB-->>UserService: è¿”å›å·²å­˜åœ¨ç”¨æˆ·
        UserService-->>UserRPC: è¿”å›å·²å­˜åœ¨ç”¨æˆ·ID
    else æ­£å¼ç”¨æˆ·ä¸å­˜åœ¨
        Note over UserService,DB: åˆ›å»ºå…¨æ–°æ­£å¼ç”¨æˆ·
        UserService->>DB: INSERT INTO bo_user<br/>(external_id, is_demo=FALSE, nickname)
        UserService->>UserService: åˆ›å»ºDEMOè´¦æˆ·ï¼ˆ10000 USDTï¼‰<br/>åˆ›å»ºREALè´¦æˆ·ï¼ˆ0 USDTï¼‰
        UserService-->>UserRPC: è¿”å›æ–°ç”¨æˆ·ID
    end

    Note over UserService: Demoç”¨æˆ·ç‹¬ç«‹ä¿ç•™<br/>ä¸ç¦ç”¨ã€ä¸åˆ é™¤ã€ä¸åˆå¹¶

    UserRPC-->>Gateway: è¿”å›userId
    Gateway->>Gateway: æ³¨å…¥X-User-Idåˆ°è¯·æ±‚
    Gateway-->>Frontend: è¿”å›ç™»å½•æˆåŠŸ

    Frontend->>Frontend: ä¿å­˜OAuth Token
    Frontend->>Frontend: æ¸…é™¤localStorageä¸­çš„DemoToken
    Note over Frontend: Demoè´¦æˆ·æ•°æ®ç‹¬ç«‹å­˜åœ¨<br/>ç”¨æˆ·å¯ç»§ç»­ä½¿ç”¨æ–°è´¦æˆ·
```

#### 2.4.3 Demoç”¨æˆ·ä¸‹å•æµç¨‹

```
Demoç”¨æˆ·ä¸‹å•
    â”‚
    â”œâ”€> 1. å‰ç«¯æºå¸¦JWT DemoToken
    â”‚      POST /api/order/create
    â”‚      Headers: { X-Demo-Token: JWT }
    â”‚      Body: { symbol, direction, amount, duration }
    â”‚
    â”œâ”€> 2. GatewayéªŒè¯JWTå¹¶æ³¨å…¥Headers
    â”‚      â”œâ”€> æ£€æµ‹åˆ°X-Demo-Token
    â”‚      â”œâ”€> éªŒè¯JWTç­¾å
    â”‚      â”œâ”€> æå–external_id
    â”‚      â”œâ”€> æŸ¥è¯¢bo_userè·å–userIdå’ŒisDemo
    â”‚      â””â”€> æ³¨å…¥Headersåˆ°è¯·æ±‚:
    â”‚            - X-User-Id: {userId}
    â”‚            - X-Auth-Type: Demo
    â”‚
    â”œâ”€> 3. OrderServiceæ£€æŸ¥è´¦æˆ·ç±»å‹
    â”‚      â”œâ”€> ä»Headerè·å–X-Auth-Type
    â”‚      â”œâ”€> å¦‚æœAuthType=Demoä¸”accountType=REAL
    â”‚      â”‚      â””â”€> æ‹’ç»ï¼šDemoç”¨æˆ·ä¸èƒ½åˆ›å»ºRealè®¢å•
    â”‚      â””â”€> å¦‚æœAuthType=Demoä¸”accountType=DEMO
    â”‚             â””â”€> å…è®¸ï¼šç»§ç»­åˆ›å»ºè®¢å•
    â”‚
    â””â”€> 4. åˆ›å»ºè®¢å•
           â””â”€> æ­£å¸¸è®¢å•æµç¨‹
```

## 3. å‰ç«¯å®ç°

### 3.1 è®¤è¯çŠ¶æ€ç®¡ç† (auth.ts)

```typescript
// çŠ¶æ€
const token = ref<string>('')           // OAuth tokenï¼ˆæ­£å¼ç”¨æˆ·ï¼‰
const demoToken = ref<string>('')       // Demo tokenï¼ˆåŒ¿åç”¨æˆ·ï¼‰
const hasOAuthToken = ref<boolean>(false)

// è®¡ç®—å±æ€§ - isAuthenticated ç»Ÿä¸€åˆ¤æ–­
const isAuthenticated = computed(() => {
  return hasOAuthToken.value || !!demoToken.value || !!localStorage.getItem('demo_token')
})

const isDemo = computed(() => {
  return !hasOAuthToken.value && (!!demoToken.value || !!localStorage.getItem('demo_token'))
})
```

**å…³é”®è®¾è®¡**ï¼š
- `isAuthenticated` æ”¹ä¸ºè®¡ç®—å±æ€§ï¼Œè‡ªåŠ¨åŒ…å« OAuth å’Œ Demo åˆ¤æ–­
- å…¶ä»–ç»„ä»¶æ— éœ€ä¿®æ”¹ï¼Œç»§ç»­ä½¿ç”¨ `authStore.isAuthenticated`

### 3.2 HTTPè¯·æ±‚å¤„ç† (http.ts)

```typescript
// è¯·æ±‚æ‹¦æˆª - æ·»åŠ Demo Tokenå¤´
if (needAuth) {
  const demoToken = authStore.getDemoToken()
  if (demoToken) {
    headers['X-Demo-Token'] = demoToken
  }
}

// å“åº”æ‹¦æˆª - ä¿å­˜æœåŠ¡ç«¯è¿”å›çš„Demo Token
const newDemoToken = response.headers.get('X-Demo-Token')
if (newDemoToken) {
  authStore.setDemoToken(newDemoToken)
}
```

### 3.3 iframeé€šä¿¡ (App.vue)

```typescript
function handleAuthentication(payload: { token: string; demoToken?: string }) {
  // è®¾ç½®OAuth tokenï¼ˆå¯èƒ½ä¸ºç©ºï¼Œè¡¨ç¤ºDemoç”¨æˆ·ï¼‰
  authStore.setToken(token)

  // å¦‚æœçˆ¶é¡µé¢ä¼ é€’äº†Demo tokenï¼Œè®¾ç½®å®ƒ
  if (demoToken) {
    authStore.setDemoToken(demoToken)
  }

  // æ— è®ºæ˜¯å¦æœ‰OAuth tokenï¼Œéƒ½è°ƒç”¨profileè·å–ç”¨æˆ·ä¿¡æ¯
  fetchProfile()
}
```

### 3.4 æ–‡ä»¶ä¿®æ”¹æ¸…å•ï¼ˆå‰ç«¯ï¼‰

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `src/store/auth.ts` | Demo tokenç®¡ç†ï¼ŒisAuthenticatedæ”¹ä¸ºè®¡ç®—å±æ€§ |
| `src/api/http.ts` | è¯·æ±‚æ·»åŠ X-Demo-Tokenï¼Œå“åº”ä¿å­˜Demo Token |
| `src/App.vue` | è®¤è¯æ¶ˆæ¯å¤„ç†ï¼Œprofileè·å– |
| `src/utils/iframeComm.ts` | æ¶ˆæ¯ç±»å‹æ”¯æŒdemoTokenå­—æ®µ |
| `public/iframe-test.html` | ä¸‰ç§è®¤è¯æ¨¡å¼æµ‹è¯•ï¼ˆOAuth/Demoå·²æœ‰/Demoæ–°å»ºï¼‰ |

## 4. åç«¯å®ç°

### 4.1 Gatewayè¿‡æ»¤å™¨

**OAuthTokenFilter.java** - å¤„ç†OAuthå’ŒDemoä¸¤ç§è®¤è¯ï¼š
- æœ‰OAuth Token â†’ èµ°OAuthæµç¨‹ï¼Œå¿½ç•¥Demo Token
- æ— OAuthä½†æœ‰Demo Token â†’ éªŒè¯JWTï¼Œæ³¨å…¥ç”¨æˆ·ä¿¡æ¯
- æ— ä»»ä½•Token â†’ åˆ›å»ºæ–°Demoç”¨æˆ·ï¼Œè¿”å›JWT

**å…³é”®Header**ï¼š
- `X-User-Id`: ç”¨æˆ·ID
- `X-Username`: ç”¨æˆ·å
- `X-Auth-Type`: è®¤è¯ç±»å‹ï¼ˆOAuth/Demoï¼‰

### 4.2 Securityè¿‡æ»¤å™¨

**OAuthAuthenticationFilter.java** - è®¾ç½®Spring Securityä¸Šä¸‹æ–‡ï¼š
```java
// æ”¯æŒOAuthå’ŒDemoä¸¤ç§è®¤è¯ç±»å‹
if (userId != null && username != null &&
    ("OAuth".equals(authType) || "Demo".equals(authType))) {
    // åˆ›å»ºè®¤è¯tokenå¹¶è®¾ç½®åˆ°SecurityContext
}
```

### 4.3 æ–‡ä»¶ä¿®æ”¹æ¸…å•ï¼ˆåç«¯ï¼‰

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `option-gateway/.../OAuthTokenFilter.java` | æ”¯æŒDemo TokenéªŒè¯å’Œç”¨æˆ·åˆ›å»º |
| `option-security-base/.../OAuthAuthenticationFilter.java` | æ”¯æŒDemoè®¤è¯ç±»å‹ |
| `option-common-service/.../UserService.java` | createOrGetDemoUseræ–¹æ³• |
| `option-common-utils/.../DemoTokenUtil.java` | JWTç”ŸæˆéªŒè¯å·¥å…· |

## 5. é˜²æ­¢åƒåœ¾è´¦å·ï¼ˆå·²å®Œæˆï¼‰

> âœ… **çŠ¶æ€**: å·²å®Œæˆ - 2025-12-01

### 5.1 é™åˆ¶ç­–ç•¥

| ç­–ç•¥ | é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|--------|------|
| IPé¢‘ç‡é™åˆ¶ | demo.register.ip-limit-per-hour | 5 | åŒä¸€IPæ¯å°æ—¶æœ€å¤šåˆ›å»ºNä¸ªDemoè´¦å· |
| ç³»ç»Ÿæ¯æ—¥æ€»é‡é™åˆ¶ | demo.register.daily-limit | 1000 | å•æ—¥æ•´ä¸ªç³»ç»Ÿæœ€å¤šåˆ›å»ºNä¸ªDemoè´¦å· |
| é™æµå¼€å…³ | demo.register.rate-limit-enabled | true | æ˜¯å¦å¯ç”¨é™æµ |

### 5.2 å®ç°ç»†èŠ‚

**1. é…ç½®å­˜å‚¨æ¶æ„**:

```mermaid
flowchart LR
    DB[("æ•°æ®åº“<br/>bo_global_config")] -->|å¯åŠ¨æ—¶åŒæ­¥| CS["common-service<br/>ConfigSyncService"]
    CS -->|å†™å…¥| Redis[("Redis<br/>BO:Config:DemoRegister:*")]
    Redis -->|è¯»å–| GW["Gateway<br/>DemoRegisterProperties"]
    CS -->|æ¯5åˆ†é’ŸåŒæ­¥| Redis
```

**2. Redis Key å¸¸é‡** (`CacheConstants.java`):
```java
// é…ç½®Keyï¼ˆcommon-serviceå†™å…¥ï¼ŒGatewayè¯»å–ï¼‰
String DEMO_REGISTER_RATE_LIMIT_ENABLED_KEY = "BO:Config:DemoRegister:RateLimitEnabled";
String DEMO_REGISTER_IP_LIMIT_PER_HOUR_KEY = "BO:Config:DemoRegister:IpLimitPerHour";
String DEMO_REGISTER_DAILY_LIMIT_KEY = "BO:Config:DemoRegister:DailyLimit";

// è®¡æ•°å™¨Keyï¼ˆGatewayè¯»å†™ï¼‰
static String buildDemoRegisterDailyKey(String date);  // BO:Demo:Register:Daily:{yyyyMMdd}
static String buildDemoRegisterIpKey(String ip, String hourKey);  // BO:Demo:Register:IP:{ip}:{yyyyMMddHH}
```

**3. common-service é…ç½®åŒæ­¥** (`ConfigSyncService.java`):
- åº”ç”¨å¯åŠ¨æ—¶ä»æ•°æ®åº“è¯»å–é…ç½®å¹¶å†™å…¥ Redis
- æ¯5åˆ†é’Ÿå®šæ—¶åŒæ­¥ï¼Œç¡®ä¿é…ç½®å˜æ›´ç”Ÿæ•ˆ
- æ”¯æŒæ‰‹åŠ¨åˆ·æ–°æ¥å£

**4. Gateway é…ç½®è¯»å–** (`DemoRegisterProperties.java`):
- ä» Redis è¯»å–é…ç½®
- Redis ä¸å¯ç”¨æ—¶ä½¿ç”¨é»˜è®¤å€¼

**5. Gatewayé™æµé€»è¾‘** (`OAuthTokenFilter.java`):
```
åˆ›å»ºDemoç”¨æˆ·å‰æ£€æŸ¥
    â†“
1. æ£€æŸ¥ç³»ç»Ÿæ¯æ—¥æ€»é‡
   Redis Key: BO:Demo:Register:Daily:{yyyyMMdd}
   å¦‚æœ >= daily_limit â†’ è¿”å› 429 Too Many Requests
    â†“
2. æ£€æŸ¥IPé¢‘ç‡
   Redis Key: BO:Demo:Register:IP:{ip}:{yyyyMMddHH}
   å¦‚æœ >= ip_limit_per_hour â†’ è¿”å› 429 Too Many Requests
    â†“
3. é€šè¿‡æ£€æŸ¥ â†’ åˆ›å»ºç”¨æˆ· â†’ Redisè®¡æ•°å™¨+1
```

**6. æ•°æ®åº“é…ç½®** (`sql/demo_rate_limit_config.sql`):
```sql
INSERT INTO bo_global_config (config_key, config_value, config_type, config_group, description, enabled, sort_order) VALUES
('demo.register.ip_limit_per_hour', '5', 'INTEGER', 'DEMO_REGISTER', 'Max Demo accounts per IP per hour', 1, 1),
('demo.register.daily_limit', '1000', 'INTEGER', 'DEMO_REGISTER', 'Max Demo accounts per day (system-wide)', 1, 2),
('demo.register.rate_limit_enabled', '1', 'BOOLEAN', 'DEMO_REGISTER', 'Enable Demo registration rate limiting', 1, 3);
```

**7. ä¿®æ”¹é…ç½®ç”Ÿæ•ˆæµç¨‹**:
1. ä¿®æ”¹æ•°æ®åº“ `bo_global_config` è¡¨ä¸­çš„é…ç½®å€¼
2. ç­‰å¾…æœ€å¤š5åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ï¼Œæˆ–é‡å¯ common-service ç«‹å³ç”Ÿæ•ˆ
3. Gateway ä¸‹æ¬¡è¯»å–æ—¶è·å–æ–°é…ç½®

## 6. Demoæ•°æ®å®šæœŸæ¸…ç†

> â³ **çŠ¶æ€**: å¾…å¼€å‘

### 6.1 æ¸…ç†ç­–ç•¥

| ç­–ç•¥ | æ‰§è¡Œæ—¶é—´ | è¯´æ˜ |
|------|----------|------|
| å‘¨æœŸæ€§æ¸…ç† | æ¯å‘¨ä¸€ UTC 00:00:00 | æ¸…ç†æ‰€æœ‰Demoç”¨æˆ·çš„äº¤æ˜“æ•°æ®ï¼Œé‡ç½®è´¦æˆ·ä½™é¢ |

### 6.2 æ¸…ç†èŒƒå›´

| æ•°æ®ç±»å‹ | è¡¨å | æ¸…ç†æ“ä½œ | è´Ÿè´£æœåŠ¡ |
|---------|------|----------|----------|
| è®¢å•è®°å½• | bo_option_order | DELETE | order-service |
| è´¦æˆ·æµæ°´ | bo_account_transaction | DELETE | common-service |
| è´¦æˆ·ä½™é¢ | bo_account | RESET | common-service |
| ç”¨æˆ·è®°å½• | bo_user | ä¿ç•™ | - |

### 6.3 æ¶æ„è®¾è®¡

**è®¾è®¡åŸåˆ™**: å„æœåŠ¡ç‹¬ç«‹æ¸…ç†è‡ªå·±ç®¡ç†çš„æ•°æ®ï¼Œæ— è·¨æœåŠ¡RPCè°ƒç”¨

```mermaid
flowchart TB
    subgraph Redis["Redis åˆ†å¸ƒå¼é”"]
        Lock["BO:Demo:DataCleanup:Lock"]
    end

    subgraph CommonService["common-service"]
        CSTask["BtseTransferScheduledTaskService<br/>æ¯å‘¨ä¸€ UTC 00:00"]
        CSTask -->|1. æŸ¥è¯¢| UM["UserMapper<br/>findAllDemoUserIds"]
        CSTask -->|2. åˆ é™¤æµæ°´| ATM["AccountTransactionMapper<br/>deleteByUserIds"]
        CSTask -->|3. é‡ç½®è´¦æˆ·| AM["AccountMapper<br/>resetDemoUserAccounts"]
    end

    subgraph OrderService["order-service"]
        OSTask["ScheduledTasks<br/>æ¯å‘¨ä¸€ UTC 00:00"]
        OSTask -->|1. æŸ¥è¯¢| RPC["UserRpcClient<br/>getDemoUserIds"]
        OSTask -->|2. åˆ é™¤è®¢å•| OM["OrderMapper<br/>deleteByUserIds"]
    end

    RPC -.->|RPCè°ƒç”¨| UM
    CSTask -.->|è·å–é”| Lock
    OSTask -.->|è·å–é”| Lock
```

### 6.4 æ‰§è¡Œæµç¨‹

**common-service (è´¦æˆ·/æµæ°´æ¸…ç†)**:
```
æ¯å‘¨ä¸€ UTC 00:00:00
    â†“
1. è·å–åˆ†å¸ƒå¼é” (BO:Demo:DataCleanup:Lock)
   TTL: 30åˆ†é’Ÿ
    â†“
2. æŸ¥è¯¢ Demo ç”¨æˆ· ID åˆ—è¡¨
   SELECT id FROM bo_user WHERE is_demo = TRUE
    â†“
3. å¦‚æœç”¨æˆ·åˆ—è¡¨ä¸ºç©º â†’ ç»“æŸ
    â†“
4. åˆ é™¤è´¦æˆ·æµæ°´
   DELETE FROM bo_account_transaction WHERE user_id IN (...)
    â†“
5. é‡ç½®è´¦æˆ·ä½™é¢
   UPDATE bo_account SET balance=10000, frozen_balance=0, ...
    â†“
6. è®°å½•æ¸…ç†ç»“æœæ—¥å¿—
```

**order-service (è®¢å•æ¸…ç†)**:
```
æ¯å‘¨ä¸€ UTC 00:01:00 (å»¶è¿Ÿ1åˆ†é’Ÿï¼Œç¡®ä¿è´¦æˆ·å…ˆæ¸…ç†)
    â†“
1. è·å–åˆ†å¸ƒå¼é” (BO:Demo:Order:Cleanup:Lock)
   TTL: 30åˆ†é’Ÿ
    â†“
2. è°ƒç”¨ RPC è·å– Demo ç”¨æˆ· ID åˆ—è¡¨
   GET /rpc/borc/user/demo-user-ids
    â†“
3. å¦‚æœç”¨æˆ·åˆ—è¡¨ä¸ºç©º â†’ ç»“æŸ
    â†“
4. åˆ é™¤è®¢å•æ•°æ®
   DELETE FROM bo_option_order WHERE user_id IN (...)
    â†“
5. è®°å½•æ¸…ç†ç»“æœæ—¥å¿—
```

### 6.5 å®ç°ç»†èŠ‚

#### 6.5.1 Redis Key å¸¸é‡ (`CacheConstants.java`)

```java
/**
 * Demo data cleanup task lock (common-service: account & transaction)
 * TTL: 30 minutes
 */
String LOCK_DEMO_DATA_CLEANUP = "BO:Demo:DataCleanup:Lock";

/**
 * Demo order cleanup task lock (order-service: orders)
 * TTL: 30 minutes
 */
String LOCK_DEMO_ORDER_CLEANUP = "BO:Demo:Order:Cleanup:Lock";
```

#### 6.5.2 Mapper æ–°å¢æ–¹æ³•

**UserMapper.xml** (common-service):
```xml
<!-- Get all demo user IDs -->
<select id="findAllDemoUserIds" resultType="java.lang.Long">
    SELECT id FROM bo_user WHERE is_demo = TRUE
</select>
```

**AccountTransactionMapper.xml** (common-service):
```xml
<!-- Delete transactions by user IDs -->
<delete id="deleteByUserIds">
    DELETE FROM bo_account_transaction
    WHERE user_id IN
    <foreach collection="userIds" item="userId" open="(" separator="," close=")">
        #{userId}
    </foreach>
</delete>
```

**AccountMapper.xml** (common-service):
```xml
<!-- Reset demo user accounts to initial state -->
<update id="resetDemoUserAccounts">
    UPDATE bo_account
    SET balance = 10000.00,
        frozen_balance = 0,
        total_deposit = 10000.00,
        total_withdraw = 0,
        total_profit = 0,
        total_loss = 0,
        reset_count = reset_count + 1,
        last_reset_time = CURRENT_TIMESTAMP,
        update_time = CURRENT_TIMESTAMP
    WHERE user_id IN
    <foreach collection="userIds" item="userId" open="(" separator="," close=")">
        #{userId}
    </foreach>
</update>
```

**OrderMapper.xml** (order-service):
```xml
<!-- Delete orders by user IDs -->
<delete id="deleteByUserIds">
    DELETE FROM bo_option_order
    WHERE user_id IN
    <foreach collection="userIds" item="userId" open="(" separator="," close=")">
        #{userId}
    </foreach>
</delete>
```

#### 6.5.3 RPC æ¥å£ (`UserRpcController.java`)

```java
/**
 * Get all demo user IDs (for order-service cleanup)
 */
@GetMapping("/demo-user-ids")
@Operation(summary = "Get demo user IDs", description = "Get all demo user IDs for cleanup")
public Result<List<Long>> getDemoUserIds() {
    List<Long> userIds = userMapper.findAllDemoUserIds();
    return Result.success(userIds);
}
```

#### 6.5.4 common-service å®šæ—¶ä»»åŠ¡ (`BtseTransferScheduledTaskService.java`)

```java
/**
 * Demo data weekly cleanup task (account & transaction)
 * Runs every Monday at UTC 00:00:00
 */
@Scheduled(cron = "0 0 0 * * MON", zone = "UTC")
@DistributedScheduled(
    lockKey = CacheConstants.LOCK_DEMO_DATA_CLEANUP,
    expireTime = 30,
    timeUnit = TimeUnit.MINUTES,
    description = "Demo account/transaction weekly cleanup"
)
public void executeDemoDataCleanupTask() {
    log.info("Starting demo data cleanup (account/transaction)");

    try {
        // 1. Get demo user IDs
        List<Long> demoUserIds = userMapper.findAllDemoUserIds();

        if (demoUserIds == null || demoUserIds.isEmpty()) {
            log.info("No demo users found, cleanup skipped");
            return;
        }

        log.info("Found {} demo users for cleanup", demoUserIds.size());

        // 2. Delete transactions
        int transactionsDeleted = accountTransactionMapper.deleteByUserIds(demoUserIds);
        log.info("Deleted {} transactions for demo users", transactionsDeleted);

        // 3. Reset accounts
        int accountsReset = accountMapper.resetDemoUserAccounts(demoUserIds);
        log.info("Reset {} accounts for demo users", accountsReset);

        log.info("Demo data cleanup completed - transactions: {}, accounts reset: {}",
                transactionsDeleted, accountsReset);

    } catch (Exception e) {
        log.error("Demo data cleanup task failed", e);
    }
}
```

#### 6.5.5 order-service å®šæ—¶ä»»åŠ¡ (`ScheduledTasks.java`)

```java
/**
 * Demo order weekly cleanup task
 * Runs every Monday at UTC 00:01:00 (1 min after account cleanup)
 */
@Scheduled(cron = "0 1 0 * * MON", zone = "UTC")
@DistributedScheduled(
    lockKey = CacheConstants.LOCK_DEMO_ORDER_CLEANUP,
    expireTime = 30,
    timeUnit = TimeUnit.MINUTES,
    description = "Demo order weekly cleanup"
)
public void executeDemoOrderCleanupTask() {
    log.info("Starting demo order cleanup");

    try {
        // 1. Get demo user IDs via RPC
        List<Long> demoUserIds = userRpcClient.getDemoUserIds();

        if (demoUserIds == null || demoUserIds.isEmpty()) {
            log.info("No demo users found, order cleanup skipped");
            return;
        }

        log.info("Found {} demo users for order cleanup", demoUserIds.size());

        // 2. Delete orders
        int ordersDeleted = orderMapper.deleteByUserIds(demoUserIds);
        log.info("Demo order cleanup completed - deleted {} orders", ordersDeleted);

    } catch (Exception e) {
        log.error("Demo order cleanup task failed", e);
    }
}
```

### 6.6 æ–‡ä»¶ä¿®æ”¹æ¸…å•

```
BinaryOption/
â”œâ”€â”€ option-common-utils/
â”‚   â””â”€â”€ src/main/java/com/binaryoption/commonutils/constants/
â”‚       â””â”€â”€ CacheConstants.java                              # æ·»åŠ  LOCK_DEMO_DATA_CLEANUP, LOCK_DEMO_ORDER_CLEANUP
â”‚
â”œâ”€â”€ option-common-service/
â”‚   â””â”€â”€ src/main/
â”‚       â”œâ”€â”€ java/com/binaryoption/commonservice/
â”‚       â”‚   â”œâ”€â”€ mapper/
â”‚       â”‚   â”‚   â”œâ”€â”€ UserMapper.java                          # æ·»åŠ  findAllDemoUserIds()
â”‚       â”‚   â”‚   â”œâ”€â”€ AccountMapper.java                       # æ·»åŠ  resetDemoUserAccounts()
â”‚       â”‚   â”‚   â””â”€â”€ AccountTransactionMapper.java            # æ·»åŠ  deleteByUserIds()
â”‚       â”‚   â”œâ”€â”€ rpc/
â”‚       â”‚   â”‚   â””â”€â”€ UserRpcController.java                   # æ·»åŠ  getDemoUserIds() æ¥å£
â”‚       â”‚   â””â”€â”€ task/
â”‚       â”‚       â””â”€â”€ BtseTransferScheduledTaskService.java    # æ·»åŠ è´¦æˆ·/æµæ°´æ¸…ç†ä»»åŠ¡
â”‚       â””â”€â”€ resources/mapper/
â”‚           â”œâ”€â”€ UserMapper.xml                               # æ·»åŠ æŸ¥è¯¢ Demo ç”¨æˆ· ID çš„ SQL
â”‚           â”œâ”€â”€ AccountMapper.xml                            # æ·»åŠ é‡ç½®è´¦æˆ·çš„ SQL
â”‚           â””â”€â”€ AccountTransactionMapper.xml                 # æ·»åŠ åˆ é™¤æµæ°´çš„ SQL
â”‚
â””â”€â”€ option-order-service/
    â””â”€â”€ src/main/
        â”œâ”€â”€ java/com/binaryoption/orderservice/
        â”‚   â”œâ”€â”€ mapper/
        â”‚   â”‚   â””â”€â”€ OrderMapper.java                         # æ·»åŠ  deleteByUserIds()
        â”‚   â””â”€â”€ task/
        â”‚       â””â”€â”€ ScheduledTasks.java                      # æ·»åŠ è®¢å•æ¸…ç†ä»»åŠ¡
        â””â”€â”€ resources/mapper/
            â””â”€â”€ OrderMapper.xml                              # æ·»åŠ åˆ é™¤è®¢å•çš„ SQL
```

### 6.7 æ³¨æ„äº‹é¡¹

1. **æ‰§è¡Œé¡ºåº**: order-service å»¶è¿Ÿ1åˆ†é’Ÿæ‰§è¡Œï¼Œç¡®ä¿è´¦æˆ·æ•°æ®å…ˆæ¸…ç†å®Œæˆ
2. **ç‹¬ç«‹é”**: ä¸¤ä¸ªæœåŠ¡ä½¿ç”¨ä¸åŒçš„åˆ†å¸ƒå¼é”ï¼Œäº’ä¸é˜»å¡
3. **æ—¶åŒºå¤„ç†**: å®šæ—¶ä»»åŠ¡ä½¿ç”¨ UTC æ—¶åŒºï¼Œç¡®ä¿å…¨çƒä¸€è‡´çš„æ¸…ç†æ—¶é—´
4. **æ•°æ®å®‰å…¨**: åªæ¸…ç† `is_demo=TRUE` çš„ç”¨æˆ·æ•°æ®ï¼Œä¸å½±å“æ­£å¼ç”¨æˆ·
5. **å®¹é”™è®¾è®¡**: å„æœåŠ¡ç‹¬ç«‹æ‰§è¡Œï¼Œå•ä¸ªæœåŠ¡å¤±è´¥ä¸å½±å“å¦ä¸€ä¸ª
6. **æ—¥å¿—è®°å½•**: å®Œæ•´è®°å½•æ¸…ç†è¿‡ç¨‹ï¼Œä¾¿äºé—®é¢˜è¿½è¸ª

## 7. æ€»ç»“

### 7.1 æ ¸å¿ƒç‰¹ç‚¹

- **æ”¹åŠ¨æœ€å°**: åªéœ€1ä¸ªæ•°æ®åº“å­—æ®µï¼ˆis_demoï¼‰ï¼Œæ— éœ€ç´¢å¼•
- **åç«¯ç”ŸæˆJWT**: å¯†é’¥å®‰å…¨ä¿å­˜åœ¨åç«¯ï¼Œå‰ç«¯åªè´Ÿè´£å­˜å‚¨å’Œæºå¸¦
- **ä¸åšåˆå¹¶**: ç™»å½•æ—¶ç›´æ¥åˆ›å»ºå…¨æ–°æ­£å¼ç”¨æˆ·ï¼ŒDemoç”¨æˆ·ç‹¬ç«‹ä¿ç•™
- **é€»è¾‘ç®€å•**: æ— å¤æ‚çš„æ•°æ®åˆå¹¶å’Œè¿ç§»é€»è¾‘ï¼Œé¿å…æ½œåœ¨é—®é¢˜
- **å”¯ä¸€æ€§ä¿è¯**: external_idä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œnicknameä¸è¦æ±‚å”¯ä¸€
- **å‰ç«¯å…¼å®¹**: isAuthenticatedæ”¹ä¸ºè®¡ç®—å±æ€§ï¼Œå…¶ä»–ç»„ä»¶æ— éœ€ä¿®æ”¹

### 7.2 Demoç”¨æˆ·ç™»å½•è¡Œä¸º

| åœºæ™¯ | è¡Œä¸º | Demoç”¨æˆ· | æ­£å¼ç”¨æˆ· |
|------|------|----------|----------|
| Demoç”¨æˆ·é¦–æ¬¡ç™»å½• | åˆ›å»ºå…¨æ–°æ­£å¼ç”¨æˆ· | ç‹¬ç«‹ä¿ç•™ | æ–°åˆ›å»º |
| Demoç”¨æˆ·å†æ¬¡ç™»å½• | è¿”å›å·²å­˜åœ¨çš„æ­£å¼ç”¨æˆ· | ç‹¬ç«‹ä¿ç•™ | å·²å­˜åœ¨ |
| æ­£å¼ç”¨æˆ·ç›´æ¥ç™»å½• | è¿”å›/åˆ›å»ºæ­£å¼ç”¨æˆ· | æ— å…³è” | è¿”å›/åˆ›å»º |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.6
**åˆ›å»ºæ—¶é—´**: 2025-11-28
**æœ€åæ›´æ–°**: 2025-12-29
**çŠ¶æ€**: ğŸš§ å¼€å‘ä¸­

**å˜æ›´è®°å½•**:
- v1.6 - æ–°å¢Demoæ•°æ®å®šæœŸæ¸…ç†è®¾è®¡ï¼šæ¯å‘¨ä¸€UTC 00:00æ¸…ç†äº¤æ˜“è®°å½•ï¼Œé‡ç½®è´¦æˆ·ä½™é¢
- v1.5 - å®ŒæˆDemoæ³¨å†Œé™æµåŠŸèƒ½ï¼šIPé¢‘ç‡é™åˆ¶ã€æ¯æ—¥æ€»é‡é™åˆ¶
- v1.4 - åŠŸèƒ½å¼€å‘å®Œæˆï¼Œè¡¥å……å‰ç«¯å®ç°ç»†èŠ‚ï¼Œæ›´æ–°æ¶æ„å›¾
- v1.3 - ç§»é™¤Demoè½¬æ­£å¼ç”¨æˆ·çš„åˆå¹¶é€»è¾‘ï¼Œæ”¹ä¸ºåˆ›å»ºå…¨æ–°æ­£å¼ç”¨æˆ·
