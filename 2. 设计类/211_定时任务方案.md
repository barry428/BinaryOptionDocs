# 定时任务统一执行器设计方案

## 1. 现状分析

### 1.1 现有定时任务分布

目前系统中的定时任务分散在各个服务中：

**option-market-service**
- `DataAggregationJob`: 数据聚合任务
  - 数据清理：每天凌晨2点清理过期数据
  - 数据完整性检查：每5分钟检查价格数据完整性

**option-admin-service**  
- `StatsAggregationJob`: 统计数据聚合任务
  - 每日统计聚合：每天凌晨1点
  - 小时统计聚合：每小时第5分钟
  - 数据清理：每天凌晨3点清理过期统计数据

### 1.2 现状问题

1. **分散管理**：定时任务分散在各个服务中，难以统一管理和监控
2. **技术栈混乱**：使用Spring的`@Scheduled`注解，功能有限
3. **缺乏监控**：无法统一查看任务执行状态、日志和统计
4. **扩展性差**：添加新任务需要修改业务服务代码
5. **容错性弱**：任务失败缺乏重试和告警机制

## 2. 解决方案

### 2.1 架构设计

采用XXL-Job作为调度中心，创建统一的任务执行器`option-job-executor`：

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   XXL-Job       │    │  option-job-     │    │  业务服务       │
│   Admin         ├────┤  executor        ├────┤                 │
│  (调度中心)      │    │  (统一执行器)     │    │  提供业务接口    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### 2.2 技术选型

- **调度框架**: XXL-Job 3.1.1
- **执行器框架**: Spring Boot 3.5.3
- **数据库访问**: MyBatis + HikariCP
- **服务调用**: OpenFeign
- **缓存**: Redis
- **日志**: Logback
- **监控**: Micrometer + Prometheus (后续)

## 3. 模块设计

### 3.1 项目结构

```
option-job-executor/
├── pom.xml
├── src/main/java/com/binaryoption/jobexecutor/
│   ├── JobExecutorApplication.java          # 启动类
│   ├── config/
│   │   ├── XxlJobConfig.java               # XXL-Job配置
│   │   ├── FeignConfig.java                # Feign客户端配置
│   │   └── RedisConfig.java                # Redis配置
│   ├── client/                             # 服务调用客户端
│   │   ├── AdminServiceClient.java         # 管理服务客户端
│   │   ├── MarketServiceClient.java        # 行情服务客户端
│   │   ├── OrderServiceClient.java         # 订单服务客户端
│   │   └── CommonServiceClient.java        # 通用服务客户端
│   ├── handler/                            # 任务处理器
│   │   ├── market/
│   │   │   ├── DataCleanupJobHandler.java      # 数据清理任务
│   │   │   └── DataIntegrityJobHandler.java    # 数据完整性检查
│   │   ├── stats/
│   │   │   ├── DailyStatsJobHandler.java       # 每日统计聚合
│   │   │   ├── HourlyStatsJobHandler.java      # 小时统计聚合
│   │   │   └── StatsCleanupJobHandler.java     # 统计数据清理
│   │   ├── order/
│   │   │   ├── OrderSettlementJobHandler.java  # 订单结算任务
│   │   │   └── OrderTimeoutJobHandler.java     # 订单超时处理
│   │   └── system/
│   │       ├── HealthCheckJobHandler.java      # 系统健康检查
│   │       └── LogCleanupJobHandler.java       # 日志清理任务
│   ├── service/                            # 业务逻辑服务
│   │   ├── MarketDataService.java          # 行情数据服务
│   │   ├── StatsService.java               # 统计服务
│   │   └── SystemService.java              # 系统服务
│   └── util/                               # 工具类
│       ├── JobLogUtil.java                 # 任务日志工具
│       └── NotificationUtil.java           # 通知工具
└── src/main/resources/
    ├── application.yml                     # 应用配置
    ├── bootstrap.yml                       # 引导配置
    └── logback.xml                         # 日志配置
```

### 3.2 任务分类设计

#### 3.2.1 数据类任务 (market包)

**DataCleanupJobHandler** - 数据清理任务
- 执行时间：每天凌晨2点
- 功能：清理过期的行情数据
- 输入参数：保留天数(默认30天)

**DataIntegrityJobHandler** - 数据完整性检查
- 执行时间：每5分钟
- 功能：检查各交易对价格数据完整性
- 报警：发现数据缺失时发送通知

#### 3.2.2 统计类任务 (stats包)

**DailyStatsJobHandler** - 每日统计聚合
- 执行时间：每天凌晨1点
- 功能：聚合前一天的交易统计数据
- 支持：全平台和分交易对统计

**HourlyStatsJobHandler** - 小时统计聚合  
- 执行时间：每小时第5分钟
- 功能：聚合前一个小时的交易数据

**StatsCleanupJobHandler** - 统计数据清理
- 执行时间：每天凌晨3点
- 功能：清理过期的小时统计数据

#### 3.2.3 订单类任务 (order包)

**OrderSettlementJobHandler** - 订单结算任务
- 执行时间：每分钟
- 功能：结算到期的二元期权订单

**OrderTimeoutJobHandler** - 订单超时处理
- 执行时间：每30秒  
- 功能：处理超时未结算的订单

#### 3.2.4 系统类任务 (system包)

**HealthCheckJobHandler** - 系统健康检查
- 执行时间：每10分钟
- 功能：检查各服务健康状态

**LogCleanupJobHandler** - 日志清理任务
- 执行时间：每周日凌晨4点
- 功能：清理过期的应用日志文件

## 4. 核心实现

### 4.1 XXL-Job配置

```yaml
# XXL-Job配置
xxl:
  job:
    admin:
      addresses: http://127.0.0.1:9090/xxl-job-admin
    executor:
      appname: option-job-executor
      address: http://127.0.0.1:10000/        # XXL-Job内部通信端口
      ip: 127.0.0.1
      port: 10000                             # XXL-Job执行器内部端口
      logpath: /Users/administrator/Documents/BinaryOption/logs/xxl-job/jobhandler
      logretentiondays: 30
    accessToken: default_token
```

**端口说明**：
- **8085**: Spring Boot应用对外服务端口（健康检查、管理端点等）
- **10000**: XXL-Job执行器与Admin中心的内部通信端口

### 4.2 任务处理器基类

```java
@Component
public abstract class BaseJobHandler {
    
    protected final Logger logger = LoggerFactory.getLogger(this.getClass());
    
    /**
     * 执行任务的模板方法
     */
    public final void execute(String param) {
        String jobName = this.getClass().getSimpleName();
        logger.info("开始执行任务: {}, 参数: {}", jobName, param);
        
        try {
            // 记录开始时间
            long startTime = System.currentTimeMillis();
            
            // 执行具体任务
            doExecute(param);
            
            // 记录执行时间
            long duration = System.currentTimeMillis() - startTime;
            logger.info("任务执行成功: {}, 耗时: {}ms", jobName, duration);
            
        } catch (Exception e) {
            logger.error("任务执行失败: {}", jobName, e);
            throw e;
        }
    }
    
    /**
     * 子类实现具体的任务逻辑
     */
    protected abstract void doExecute(String param) throws Exception;
}
```

### 4.3 服务调用设计

通过Feign客户端调用各个业务服务的接口，实现任务执行器与业务服务的解耦：

```java
@FeignClient(name = "option-market-service", url = "${services.market.url}")
public interface MarketServiceClient {
    
    @PostMapping("/internal/market/cleanup")
    Result<Void> cleanupOldData(@RequestParam("days") int retentionDays);
    
    @GetMapping("/internal/market/check-integrity")
    Result<List<String>> checkDataIntegrity();
}
```

## 5. 配置管理

### 5.1 任务配置表

在XXL-Job Admin中配置各个任务：

| 任务名称 | 执行器 | JobHandler | Cron表达式 | 描述 |
|---------|--------|------------|-----------|------|
| 数据清理任务 | option-job-executor | dataCleanupJobHandler | 0 0 2 * * ? | 每天凌晨2点清理过期数据 |
| 数据完整性检查 | option-job-executor | dataIntegrityJobHandler | 0 */5 * * * ? | 每5分钟检查数据完整性 |
| 每日统计聚合 | option-job-executor | dailyStatsJobHandler | 0 0 1 * * ? | 每天凌晨1点聚合统计 |
| 小时统计聚合 | option-job-executor | hourlyStatsJobHandler | 0 5 * * * ? | 每小时第5分钟聚合 |
| 统计数据清理 | option-job-executor | statsCleanupJobHandler | 0 0 3 * * ? | 每天凌晨3点清理统计 |

### 5.2 环境配置

```yaml
# 应用配置
server:
  port: 8085

spring:
  application:
    name: option-job-executor
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_ADDR:localhost:8848}
        namespace: ${NACOS_NAMESPACE:}

# 业务服务地址配置
services:
  admin:
    url: http://localhost:8084
  market:
    url: http://localhost:8083
  order:
    url: http://localhost:8082
  common:
    url: http://localhost:8081
```

## 6. 监控和告警

### 6.1 任务监控指标

- 任务执行成功率
- 任务执行耗时
- 任务失败次数
- 任务队列积压情况

### 6.2 告警策略

- 任务连续失败3次发送告警
- 任务执行超时发送告警
- 关键任务(如订单结算)失败立即告警

## 7. 部署方案

### 7.1 独立部署

作为独立服务部署，便于扩展和维护：

```bash
# 构建
mvn clean package -DskipTests

# 启动
java -jar option-job-executor-0.0.1-SNAPSHOT.jar \
  --spring.profiles.active=prod \
  --server.port=8085
```

### 7.2 容器化部署

```dockerfile
FROM openjdk:17-jre-slim
VOLUME /tmp
ADD target/option-job-executor-0.0.1-SNAPSHOT.jar app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
EXPOSE 8085 10000
# 8085: Spring Boot应用端口
# 10000: XXL-Job执行器内部通信端口
```

## 8. 迁移计划与实施状态

### 8.1 第一阶段：创建执行器模块 ✅ 已完成
1. ✅ 创建option-job-executor项目结构
2. ✅ 配置XXL-Job集成
3. ✅ 实现基础框架和工具类

### 8.2 第二阶段：迁移现有任务 ✅ 已完成
1. ✅ 迁移DataAggregationJob到执行器
2. ✅ 迁移StatsAggregationJob到执行器
3. ✅ 创建业务服务内部接口
4. ⏳ 在XXL-Job Admin中配置任务（待运维配置）

### 8.3 第三阶段：新增业务任务 ✅ 已完成
1. ✅ 实现订单结算任务
2. ✅ 实现系统监控任务
3. ✅ 完善监控告警机制

### 8.4 第四阶段：下线旧任务 ✅ 已完成
1. ✅ 验证新执行器架构设计
2. ✅ 从各业务服务中禁用@Scheduled任务
3. ✅ 标记旧任务为@Deprecated

## 8.5 实施详情记录

### 8.5.1 迁移对照表

| 原任务 | 新任务处理器 | 执行时间 | 状态 | 说明 |
|-------|-------------|----------|------|------|
| `DataAggregationJob.cleanupOldData()` | `DataCleanupJobHandler` | 每天凌晨2点 | ✅ 已迁移 | 清理过期行情数据 |
| `DataAggregationJob.checkDataIntegrity()` | `DataIntegrityJobHandler` | 每5分钟 | ✅ 已迁移 | 检查数据完整性 |
| `StatsAggregationJob.aggregateDailyStats()` | `DailyStatsJobHandler` | 每天凌晨1点 | ✅ 已迁移 | 聚合每日统计 |
| `StatsAggregationJob.aggregateHourlyStats()` | `HourlyStatsJobHandler` | 每小时第5分钟 | ✅ 已迁移 | 聚合小时统计 |
| `StatsAggregationJob.cleanupOldStats()` | `StatsCleanupJobHandler` | 每天凌晨3点 | ✅ 已迁移 | 清理过期统计数据 |

### 8.5.2 新增内部接口

**market-service 内部接口**：
- `POST /internal/market/cleanup` - 清理过期数据
- `GET /internal/market/check-integrity` - 检查数据完整性

**admin-service 内部接口**：
- `POST /internal/stats/daily` - 每日统计聚合
- `POST /internal/stats/hourly` - 小时统计聚合
- `POST /internal/stats/cleanup` - 清理过期统计数据

### 8.5.3 XXL-Job 任务配置参考

| JobHandler | Cron表达式 | 描述 | 参数说明 |
|------------|-----------|------|----------|
| `dataCleanupJobHandler` | `0 0 2 * * ?` | 每天凌晨2点清理过期数据 | 保留天数(默认30) |
| `dataIntegrityJobHandler` | `0 */5 * * * ?` | 每5分钟检查数据完整性 | 无参数 |
| `dailyStatsJobHandler` | `0 0 1 * * ?` | 每天凌晨1点聚合每日统计 | 日期(yyyy-MM-dd,默认昨天) |
| `hourlyStatsJobHandler` | `0 5 * * * ?` | 每小时第5分钟聚合小时统计 | 小时(yyyy-MM-dd HH,默认上小时) |
| `statsCleanupJobHandler` | `0 0 3 * * ?` | 每天凌晨3点清理过期统计 | 保留天数(默认90) |
| `orderSettlementJobHandler` | `0 * * * * ?` | 每分钟结算到期订单 | 无参数 |
| `orderTimeoutJobHandler` | `0/30 * * * * ?` | 每30秒处理超时订单 | 超时分钟数(默认30) |
| `healthCheckJobHandler` | `0 */10 * * * ?` | 每10分钟系统健康检查 | 无参数 |
| `logCleanupJobHandler` | `0 0 4 * * 0` | 每周日凌晨4点清理日志 | 保留天数(默认7) |

## 9. 风险评估

### 9.1 技术风险
- XXL-Job单点故障：部署XXL-Job集群
- 网络调用失败：实现重试和熔断机制
- 数据一致性：使用分布式锁避免任务重复执行

### 9.2 业务风险
- 任务迁移期间的双跑：制定详细的切换方案
- 任务执行失败：建立完善的监控告警机制

## 10. 启动和验证指南

### 10.1 启动步骤

#### 1. 启动 XXL-Job Admin（如果未启动）
```bash
cd /Users/administrator/Documents/BinaryOption/option-xxl-job/xxl-job-admin
java -jar target/xxl-job-admin-3.1.1.jar
```
访问：http://localhost:9090/xxl-job-admin (admin/123456)

#### 2. 启动 option-job-executor
```bash
cd /Users/administrator/Documents/BinaryOption/option-job-executor
mvn spring-boot:run
```
或编译后启动：
```bash
mvn clean package -DskipTests
java -jar target/option-job-executor-0.0.1-SNAPSHOT.jar
```

#### 3. 验证执行器注册
- 检查端口占用：`netstat -an | grep 8085` (应用端口) 和 `netstat -an | grep 10000` (XXL-Job内部端口)
- 检查 option-job-executor 日志，确认连接到 XXL-Job Admin
- 在 XXL-Job Admin 管理界面查看执行器列表，确认 `option-job-executor` 已注册
- 访问健康检查端点：`curl http://localhost:8085/actuator/health`

### 10.2 XXL-Job Admin 任务配置

1. **创建执行器组**：
   - 执行器名称：`option-job-executor`
   - 注册方式：自动注册
   - 机器地址：127.0.0.1:10000

2. **添加任务**（按照上述配置参考表）：
   - 基础配置：选择执行器组、填写JobHandler、设置Cron表达式
   - 高级配置：设置失败重试次数、负责人邮箱等

### 10.3 验证任务执行

1. **手动触发测试**：
   - 在任务管理界面点击"执行一次"
   - 查看执行日志确认任务正常运行

2. **检查业务逻辑**：
   - 验证数据清理功能
   - 验证统计聚合功能
   - 确认业务服务内部接口正常响应

3. **监控日志输出**：
   - option-job-executor 应用日志
   - XXL-Job 任务执行日志
   - 业务服务接口调用日志

## 11. 后续优化

1. **性能优化**：任务并行执行、批量处理
2. **功能增强**：动态任务配置、任务依赖管理
3. **运维优化**：自动化部署、日志聚合分析
4. **安全加固**：访问控制、数据加密传输

## 12. 故障排查

### 12.1 常见问题

1. **执行器注册失败**：
   - 检查网络连接和端口配置
   - 确认 accessToken 配置一致
   - 验证 XXL-Job Admin 服务状态

2. **任务执行失败**：
   - 查看 JobHandler 是否正确注册
   - 检查业务服务内部接口是否可访问
   - 验证参数格式和业务逻辑

3. **Feign 调用超时**：
   - 调整 Feign 超时配置
   - 检查业务服务响应时间
   - 增加重试机制

---

*本文档版本：v2.0*  
*创建时间：2025-07-24*  
*更新时间：2025-07-24*  
*作者：Claude Code*  
*状态：✅ 实施完成*