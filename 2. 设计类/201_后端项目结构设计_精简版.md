# 后端项目结构设计（精简版）

## 1. 项目概述

二元期权交易平台，采用Spring Boot微服务架构，支持MySQL/PostgreSQL双数据库，集成BTSE API。

### 技术栈
- Spring Boot 2.7.x + Spring Cloud 2021.x
- MySQL 8.0+ / PostgreSQL 13+
- MyBatis 3.5+ + Redis 6.0+ + XXL-JOB
- Spring Cloud Gateway + Nacos

## 2. 项目结构

```
BinaryOption/
├── docs/                          # 项目文档
├── FE/                           # 前端项目  
├── logs/                         # 运行日志
├── sql/                          # 数据库脚本
├── test-scripts/                 # 自动化测试脚本
├── option-parent/                # Maven父项目
├── option-gateway/               # API网关 (8080)
├── option-common-service/        # 公共服务 (8081)
├── option-order-service/         # 订单服务 (8082)
├── option-market-service/        # 行情服务 (8083)
├── option-admin-service/         # 管理后台 (8084)
├── option-job-executor/          # 定时任务 (8085)
├── option-common-dto/            # 公共DTO
├── option-common-utils/          # 公共工具类
├── option-security-base/         # 安全基础组件
├── option-xxl-job/               # XXL-JOB任务调度
├── start-all.sh                  # 启动脚本
├── stop-all.sh                   # 停止脚本
└── CLAUDE.md                     # 项目记忆文档
```

## 3. 服务模块

### 3.1 option-gateway (API网关)
- **端口**: 8080
- **职责**: 统一入口、路由转发、认证鉴权

### 3.2 option-common-service (公共服务)
- **端口**: 8081  
- **职责**: 用户管理、账户管理、BTSE集成
- **核心模块**: 
  - 账户服务 (Account)
  - BTSE转账服务 (BtseTransfer)
  - 用户服务 (User)

### 3.3 option-order-service (订单服务)
- **端口**: 8082
- **职责**: 订单管理、风控、交易轮次、结算
- **核心模块**:
  - 订单服务 (Order)
  - 风控服务 (Risk) 
  - 交易轮次 (TradingRound)
  - 结算服务 (Settlement)

### 3.4 option-market-service (行情服务)
- **端口**: 8083
- **职责**: 行情数据、价格推送、WebSocket

### 3.5 option-admin-service (管理后台)
- **端口**: 8084
- **职责**: 后台管理、报表统计、系统配置

### 3.6 option-job-executor (任务执行器)
- **端口**: 8085
- **职责**: 定时任务、结算任务、补偿任务

## 4. 公共模块

### 4.1 option-common-dto
- **职责**: 公共数据传输对象
- **模块**: account、btse、order、user、common等

### 4.2 option-common-utils
- **职责**: 公共工具类和异常处理
- **模块**: exception、validator、btse、security、util

### 4.3 option-security-base
- **职责**: 安全基础组件
- **模块**: JWT认证、用户详情、过滤器

## 5. 标准模块结构

### 5.1 Java包结构
```
src/main/java/com.binaryoption.{servicename}/
├── config/                    # 配置类
├── controller/                # REST控制器
├── rpc/                      # RPC控制器  
├── service/                  # 业务服务
├── domain/                   # 数据模型
├── mapper/                   # MyBatis映射器接口
├── client/                   # 外部服务客户端
└── integration/              # 第三方集成
```

### 5.2 Resources资源结构
```
src/main/resources/
├── application.yml                 # 主配置(MySQL)
├── application-postgresql.yml      # PostgreSQL配置
├── application-dev.yml            # 开发环境配置
├── application-test.yml           # 测试环境配置
├── application-prod.yml           # 生产环境配置
├── bootstrap.yml                  # 引导配置(Nacos等)
├── i18n/                          # 国际化资源
│   ├── messages.properties        # 默认语言
│   ├── messages_en.properties     # 英文
│   ├── messages_ja.properties     # 日文
│   └── messages_zh_CN.properties  # 中文
├── mapper/                        # MyBatis XML映射
│   ├── UserMapper.xml            # 用户映射
│   ├── AccountMapper.xml         # 账户映射
│   ├── OrderMapper.xml           # 订单映射
│   └── BtseTransferLogMapper.xml # BTSE转账日志映射
└── static/                       # 静态资源(如需要)
```

### 5.3 各服务Resources示例

#### Common Service (公共服务)
```
option-common-service/src/main/resources/
├── application.yml
├── application-postgresql.yml
├── application-btse-transfer.yml     # BTSE转账专用配置
├── application-btse-compensation.yml # BTSE补偿配置
├── bootstrap.yml
├── btse-field-mapping.yml           # BTSE字段映射配置
├── i18n/                           # 国际化资源
└── mapper/                         # MyBatis映射
    ├── UserMapper.xml
    ├── AccountMapper.xml
    ├── AccountTransactionMapper.xml
    ├── BtseTransferLogMapper.xml
    └── GlobalConfigMapper.xml
```

#### Order Service (订单服务)
```
option-order-service/src/main/resources/
├── application.yml
├── application-postgresql.yml
├── bootstrap.yml
├── i18n/                          # 国际化资源
└── mapper/                        # MyBatis映射
    ├── OrderMapper.xml
    ├── TradingRoundMapper.xml
    ├── RiskConfigMapper.xml
    ├── RiskLogMapper.xml
    └── DurationConfigMapper.xml
```

#### Job Executor (任务执行器)
```
option-job-executor/src/main/resources/
├── application.yml
├── bootstrap.yml
└── logback.xml                    # 日志配置
```

## 6. 核心特性

### 6.1 双数据库支持
- 使用MyBatis的`databaseId`机制
- 支持MySQL和PostgreSQL切换
- 配置文件: `application.yml` (MySQL) / `application-postgresql.yml` (PostgreSQL)

### 6.2 BTSE集成架构
```
BtseTransferService
├── BtseApiClient (接口)
├── BtseApiClientImpl (真实实现)
├── BtseMockApiClient (Mock实现)
└── BtseDataConverter (数据转换)
```

### 6.3 资金流向设计
- **DEMO账户**: `balance` ↔ `frozen_balance` (本地)
- **REAL账户**: `BTSE` ↔ `frozen_balance` (跳过balance)

### 6.4 订单状态流转
```
PENDING → ACTIVE → WIN/LOSE/DRAW
   ↓         ↓
CANCELLED  CANCELLED
```

## 7. 开发规范

### 7.1 命名规范
- **类名**: `XxxController`, `XxxService`, `XxxMapper`
- **方法**: `find/get/query`, `create/add`, `update`, `delete`
- **表名**: 小写下划线，业务前缀 (`user_`, `order_`, `btse_`)

### 7.2 API规范
- **REST**: `/api/orders`, `/api/orders/{id}`
- **RPC**: `/rpc/order/create`, `/rpc/btse/transfer`
- **响应**: 统一Result格式 `{code, message, data, success}`

### 7.3 日志规范
- **业务日志**: `log.info("订单创建，用户：{}，金额：{}", userId, amount)`
- **异常日志**: `log.error("转账失败，用户：{}，错误：{}", userId, e.getMessage())`

## 8. 测试体系

### 8.1 测试脚本结构
```
test-scripts/
├── modules/           # 模块化测试 (auth, account, order)
├── flows/            # 流程测试
├── integration/      # 集成测试
├── utils/           # 测试工具
└── simple-flow-test.sh
```

### 8.2 测试特性
- 支持MySQL/PostgreSQL双库测试
- 自动化数据准备和清理
- 完整的API和RPC测试覆盖

## 9. 部署运维

### 9.1 部署脚本
- `start-all.sh` - 启动所有服务
- `stop-all.sh` - 停止所有服务  
- `status.sh` - 检查服务状态
- `rebuild-restart.sh` - 重新构建部署

### 9.2 监控配置
- 健康检查: `/actuator/health`
- 指标监控: `/actuator/metrics`
- 日志路径: `logs/` 目录

## 10. 项目优势

1. **微服务架构** - 职责分离，独立部署
2. **双数据库支持** - MySQL/PostgreSQL兼容
3. **完整的BTSE集成** - 真实API + Mock支持
4. **规范的代码结构** - 统一的包结构和命名
5. **完善的测试体系** - 自动化测试脚本
6. **国际化支持** - 多语言资源文件
7. **企业级特性** - 监控、日志、异常处理