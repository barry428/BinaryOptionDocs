# 二元期权平台API接口设计

## 1. 统一异常处理与响应格式

### 1.1 统一响应格式

所有API接口统一使用`ApiResponse<T>`泛型响应格式：

```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ApiResponse<T> {
    private Integer code;        // 响应码
    private String message;      // 响应消息
    private T data;             // 响应数据（泛型）
    @Builder.Default
    private LocalDateTime timestamp = LocalDateTime.now(); // 响应时间
    
    // 成功响应
    public static <T> ApiResponse<T> success(T data) {
        return ApiResponse.<T>builder()
                .code(200)
                .message("success")
                .data(data)
                .build();
    }
    
    public static <T> ApiResponse<T> success(T data, String message) {
        return ApiResponse.<T>builder()
                .code(200)
                .message(message)
                .data(data)
                .build();
    }
    
    // 错误响应
    public static <T> ApiResponse<T> error(Integer code, String message) {
        return ApiResponse.<T>builder()
                .code(code)
                .message(message)
                .build();
    }
}
```

### 1.2 业务异常类

```java
@Getter
public class BusinessException extends RuntimeException {
    private final Integer code;
    
    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
    }
    
    // 常用快捷方法
    public static BusinessException notFound(String message) {
        return new BusinessException(404, message);
    }
    
    public static BusinessException badRequest(String message) {
        return new BusinessException(400, message);
    }
    
    public static BusinessException forbidden(String message) {
        return new BusinessException(403, message);
    }
}
```

### 1.3 全局异常处理器

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    // 业务异常处理
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Void>> handleBusinessException(BusinessException e) {
        log.warn("Business exception: [{}] {}", e.getCode(), e.getMessage());
        ApiResponse<Void> response = ApiResponse.error(e.getCode(), e.getMessage());
        return ResponseEntity.ok(response);
    }
    
    // 参数验证异常
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<Map<String, String>>> handleValidationException(
            MethodArgumentNotValidException e) {
        Map<String, String> errors = new HashMap<>();
        e.getBindingResult().getAllErrors().forEach(error -> {
            String fieldName = ((FieldError) error).getField();
            String errorMessage = error.getDefaultMessage();
            errors.put(fieldName, errorMessage);
        });
        
        ApiResponse<Map<String, String>> response = ApiResponse.<Map<String, String>>builder()
                .code(400)
                .message("参数验证失败")
                .data(errors)
                .build();
        
        return ResponseEntity.badRequest().body(response);
    }
    
    // 其他系统异常
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Void>> handleGenericException(Exception e) {
        log.error("Unexpected error occurred", e);
        ApiResponse<Void> response = ApiResponse.error(500, "系统内部错误");
        return ResponseEntity.status(500).body(response);
    }
}
```

### 1.4 响应码规范

| 响应码 | 含义 | 使用场景 |
|--------|------|----------|
| 200 | 成功 | 正常业务处理成功 |
| 400 | 请求参数错误 | 参数验证失败、格式错误 |
| 401 | 未认证 | 用户未登录、Token无效 |
| 403 | 权限不足 | 用户权限不够、操作被禁止 |
| 404 | 资源不存在 | 用户不存在、订单不存在 |
| 405 | 方法不支持 | HTTP方法错误 |
| 409 | 业务冲突 | 用户已存在、重复操作 |
| 500 | 系统错误 | 服务内部异常、数据库连接异常 |

### 1.5 响应示例

**成功响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "test_user",
    "email": "test@example.com"
  },
  "timestamp": "2025-07-22T10:30:45"
}
```

**错误响应示例**:
```json
{
  "code": 404,
  "message": "用户不存在",
  "data": null,
  "timestamp": "2025-07-22T10:30:45"
}
```

**参数验证错误响应示例**:
```json
{
  "code": 400,
  "message": "参数验证失败",
  "data": {
    "username": "用户名不能为空",
    "email": "邮箱格式不正确"
  },
  "timestamp": "2025-07-22T10:30:45"
}
```

## 2. option-common-service 接口

### 2.1 用户管理接口

```http
# 创建用户
POST /user
Content-Type: application/json
{
  "externalId": "btse_user_123",
  "nickname": "用户昵称",
  "email": "user@example.com",
  "phone": "+8613800138000",
  "password": "password123"
}

# 获取当前用户信息 (Gateway信任模式)
GET /user/me
X-User-Id: 1
X-User-Name: testuser

# 更新用户信息
PUT /user/profile
X-User-Id: 1
X-User-Name: testuser
{
  "nickname": "新昵称",
  "signature": "个性签名"
}

# 同意风险协议
POST /user/agreement
X-User-Id: 1
X-User-Name: testuser
{
  "riskAgreement": true,
  "amlAgreement": true
}
```

### 2.2 账户管理接口

```http
# 获取账户列表 (Gateway信任模式)
GET /account/list?accountType=REAL
X-User-Id: 1
X-User-Name: testuser

# 获取账户余额 (Gateway信任模式)
GET /account/balance?accountType=REAL&currency=USDT
X-User-Id: 1
X-User-Name: testuser

# 重置模拟账户
POST /account/reset
X-User-Id: 1
X-User-Name: testuser
{
  "accountType": "DEMO",
  "currency": "USDT"
}

# 获取资金流水 (Gateway信任模式)
GET /account/transactions?page=1&size=20&type=BET&startDate=2025-07-01&endDate=2025-07-31
X-User-Id: 1
X-User-Name: testuser
```

### 2.3 配置管理接口

```http
# 获取币种配置列表
GET /config/symbols

# 获取全局配置
GET /config/global?group=SYSTEM

# 获取指定配置项
GET /config/global/{configKey}
```

## 3. option-order-service 接口

### 3.1 交易接口

```http
# 获取当前回合信息
GET /trading/rounds/current?symbolId=1&duration=5

# 获取回合历史
GET /trading/rounds/history?symbolId=1&page=1&size=20

# 下单 (Gateway信任模式)
POST /order/place
X-User-Id: 1
X-User-Name: testuser
Content-Type: application/json
{
  "symbolId": 1,
  "accountType": "REAL", 
  "direction": "UP",
  "amount": "100.0000000000000000"
}

# 撤单 (Gateway信任模式)
POST /order/cancel/{orderId}
X-User-Id: 1
X-User-Name: testuser

# 获取我的订单 (Gateway信任模式)
GET /order/my?status=PENDING&page=1&size=20&startDate=2025-07-01&endDate=2025-07-31
X-User-Id: 1
X-User-Name: testuser

# 获取订单详情 (Gateway信任模式)
GET /order/{orderId}
X-User-Id: 1
X-User-Name: testuser

# 获取订单统计 (Gateway信任模式)
GET /order/stats?accountType=REAL&period=7d
X-User-Id: 1
X-User-Name: testuser
```

### 3.2 风控接口

```http
# 风控校验
POST /risk/check
Content-Type: application/json
{
  "userId": 123,
  "action": "PLACE_ORDER",
  "amount": "1000.0000000000000000",
  "accountType": "REAL"
}

# 获取风控日志 (Gateway信任模式)
GET /risk/logs?page=1&size=20&riskType=AMOUNT_LIMIT
X-User-Id: 1
X-User-Name: testuser
```

### 3.3 配置接口

```http
# 获取周期配置
GET /config/durations

# 获取指定周期配置
GET /config/durations/{durationId}
```

## 4. option-market-service 接口

### 4.1 行情数据接口

```http
# 获取实时价格
GET /market/price/current?symbol=BTC/USDT

# 获取价格历史
GET /market/price/history?symbol=BTC/USDT&limit=100

# 获取K线数据
GET /market/kline?symbol=BTC/USDT&interval=1m&limit=100&startTime=1627776000000&endTime=1627862400000

# WebSocket 订阅实时价格 (需要升级协议)
WS /market/ws/price/{symbol}
```

### 4.2 WebSocket 推送格式

```javascript
// 价格推送消息格式
{
  "type": "price_update",
  "symbol": "BTC/USDT",
  "price": "45123.45678901",
  "timestamp": 1627776000000,
  "volume": "1234.56789012"
}

// K线数据推送格式
{
  "type": "kline_update", 
  "symbol": "BTC/USDT",
  "interval": "1m",
  "data": {
    "openTime": 1627776000000,
    "closeTime": 1627776059999,
    "openPrice": "45000.00000000",
    "highPrice": "45200.00000000", 
    "lowPrice": "44900.00000000",
    "closePrice": "45123.45678901",
    "volume": "1234.56789012"
  }
}
```

## 5. option-admin-service 接口

### 5.1 用户管理接口

```http
# 获取用户列表 (需要JWT认证)
GET /admin/users?page=1&size=20&status=1&keyword=test&accountType=REAL
Authorization: Bearer {jwt_token}

# 获取用户详情 (需要JWT认证)
GET /admin/users/{userId}
Authorization: Bearer {jwt_token}

# 更新用户状态
PUT /admin/users/{userId}/status
Authorization: Bearer {jwt_token}
Content-Type: application/json
{
  "status": 2,  // 1:正常 2:禁用
  "reason": "违规操作"
}

# 获取用户账户信息
GET /admin/users/{userId}/accounts
Authorization: Bearer {jwt_token}

# 获取用户资金流水
GET /admin/users/{userId}/transactions?page=1&size=20&type=BET&startDate=2025-07-01&endDate=2025-07-31
Authorization: Bearer {jwt_token}

# 手动调整用户余额
POST /admin/users/{userId}/balance/adjust
Authorization: Bearer {jwt_token}
Content-Type: application/json
{
  "accountType": "REAL",
  "currency": "USDT",
  "amount": "1000.0000000000000000",
  "type": "DEPOSIT",  // DEPOSIT:增加 WITHDRAW:扣减
  "reason": "管理员调整"
}
```

### 5.2 交易管理接口

```http
# 获取订单列表
GET /admin/orders?page=1&size=20&status=PENDING&symbolId=1&userId=123&startDate=2025-07-01&endDate=2025-07-31
Authorization: Bearer {jwt_token}

# 获取订单详情
GET /admin/orders/{orderId}
Authorization: Bearer {jwt_token}

# 获取回合列表
GET /admin/rounds?page=1&size=20&status=OPEN&symbolId=1&startDate=2025-07-01&endDate=2025-07-31
Authorization: Bearer {jwt_token}

# 获取回合详情
GET /admin/rounds/{roundId}
Authorization: Bearer {jwt_token}

# 手动结算回合(紧急情况)
POST /admin/rounds/{roundId}/settle
Authorization: Bearer {jwt_token}
Content-Type: application/json
{
  "settlePrice": "45000.12345678",
  "reason": "紧急处理"
}

# 获取交易统计
GET /admin/trading/stats?symbolId=1&period=7d&startDate=2025-07-01&endDate=2025-07-31
Authorization: Bearer {jwt_token}
```

### 5.3 风控管理接口

```http
# 获取风控配置
GET /admin/risk/configs?configType=LIMIT
Authorization: Bearer {jwt_token}

# 更新风控配置
PUT /admin/risk/configs/{configKey}
Authorization: Bearer {jwt_token}
Content-Type: application/json
{
  "configValue": "10000",
  "enabled": true,
  "description": "单笔最大下注金额"
}

# 获取风控日志
GET /admin/risk/logs?page=1&size=20&riskType=AMOUNT_LIMIT&userId=123&startDate=2025-07-01&endDate=2025-07-31
Authorization: Bearer {jwt_token}

# 黑名单管理
GET /admin/risk/blacklist?page=1&size=20&status=1
Authorization: Bearer {jwt_token}

POST /admin/risk/blacklist
Authorization: Bearer {jwt_token}
Content-Type: application/json
{
  "userId": 123,
  "reason": "异常交易行为",
  "duration": 7  // 天数，0表示永久
}

# 移除黑名单
DELETE /admin/risk/blacklist/{blacklistId}
Authorization: Bearer {jwt_token}
```

### 5.4 系统配置接口

```http
# 币种配置管理
GET /admin/configs/symbols?enabled=true
Authorization: Bearer {jwt_token}

PUT /admin/configs/symbols/{symbolId}
Authorization: Bearer {jwt_token}
Content-Type: application/json
{
  "enabled": true,
  "minAmount": "10.0000000000000000",
  "maxAmount": "10000.0000000000000000",
  "btseSymbol": "BTCUSDT"
}

# 周期配置管理
GET /admin/configs/durations?enabled=true
Authorization: Bearer {jwt_token}

PUT /admin/configs/durations/{durationId}
Authorization: Bearer {jwt_token}
Content-Type: application/json
{
  "enabled": true,
  "lockSeconds": 30,
  "baseOdds": "1.9000",
  "feeRate": "0.1000"
}

# 全局配置管理
GET /admin/configs/global?group=SYSTEM
Authorization: Bearer {jwt_token}

PUT /admin/configs/global/{configKey}
Authorization: Bearer {jwt_token}
Content-Type: application/json
{
  "configValue": "value",
  "description": "配置说明",
  "enabled": true
}
```

### 5.5 数据统计接口

```http
# 业务概览统计
GET /admin/stats/overview?startDate=2025-07-01&endDate=2025-07-18
Authorization: Bearer {jwt_token}

# 交易统计
GET /admin/stats/trading?startDate=2025-07-01&endDate=2025-07-18&symbolId=1&period=day
Authorization: Bearer {jwt_token}

# 用户统计
GET /admin/stats/users?startDate=2025-07-01&endDate=2025-07-18&period=day
Authorization: Bearer {jwt_token}

# 财务统计
GET /admin/stats/finance?startDate=2025-07-01&endDate=2025-07-18&currency=USDT
Authorization: Bearer {jwt_token}

# 实时监控数据
GET /admin/monitor/realtime
Authorization: Bearer {jwt_token}

# 导出统计报表
GET /admin/stats/export?type=trading&format=excel&startDate=2025-07-01&endDate=2025-07-31
Authorization: Bearer {jwt_token}
```

### 5.6 系统监控接口

```http
# 获取系统健康状态
GET /admin/monitor/health
Authorization: Bearer {jwt_token}

# 获取系统性能指标
GET /admin/monitor/metrics
Authorization: Bearer {jwt_token}

# 获取在线用户统计
GET /admin/monitor/online-users
Authorization: Bearer {jwt_token}

# 获取服务状态
GET /admin/monitor/services
Authorization: Bearer {jwt_token}
```

## 6. 认证模式说明

### 6.1 Gateway信任模式

用于业务服务（common-service, order-service, market-service）：

- **无需JWT**: 直接从Header获取用户信息
- **Header传递**: Gateway解析JWT后通过Header传递用户信息
- **信任关系**: 下游服务完全信任Gateway传递的用户信息

**Header格式**:
```
X-User-Id: 123
X-User-Name: username
X-External-Id: btse_user_123
```

### 6.2 JWT认证模式

用于管理服务（admin-service）：

- **需要JWT**: 所有接口都需要有效的JWT Token
- **角色控制**: 需要admin角色才能访问
- **权限验证**: 支持细粒度权限控制

**Header格式**:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## 7. 分页和排序

### 7.1 分页参数

所有列表查询接口支持统一的分页参数：

- `page`: 页码（从1开始，默认1）
- `size`: 每页数量（默认20，最大100）
- `sort`: 排序字段（可选）
- `order`: 排序方向（asc/desc，默认desc）

### 7.2 分页响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "content": [...],      // 数据列表
    "totalElements": 150,  // 总记录数
    "totalPages": 8,       // 总页数
    "page": 1,            // 当前页码
    "size": 20,           // 每页数量
    "first": true,        // 是否首页
    "last": false,        // 是否末页
    "hasNext": true,      // 是否有下一页
    "hasPrevious": false  // 是否有上一页
  },
  "timestamp": "2025-08-04T10:30:45"
}
```

---
**文档版本**: v1.7  
**最后更新**: 2025年8月04日  
**维护者**: Barry  
**相关文档**: [详细设计概述](./207_01_详细设计概述.md), [系统架构设计](./207_02_系统架构设计.md), [数据库设计](./207_03_数据库设计.md)