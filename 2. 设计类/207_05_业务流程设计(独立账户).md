# äºŒå…ƒæœŸæƒå¹³å°ä¸šåŠ¡æµç¨‹è®¾è®¡ï¼ˆç‹¬ç«‹è´¦æˆ·æ¨¡å¼ï¼‰

## 1. æ¶æ„å˜æ›´è¯´æ˜

### 1.1 æ ¸å¿ƒå˜æ›´
- **ä¸‹å•æµç¨‹**ï¼šä¸å†è°ƒç”¨BTSE APIï¼Œåªä½¿ç”¨æœ¬åœ°è´¦æˆ·ä½™é¢
- **ç»“ç®—æµç¨‹**ï¼šç›ˆåˆ©èµ„é‡‘ç›´æ¥åˆ°æœ¬åœ°è´¦æˆ·ï¼Œä¸è½¬å›BTSE
- **æ–°å¢è´¦æˆ·åˆ’è½¬åŠŸèƒ½**ï¼šç”¨æˆ·ä¸»åŠ¨è¿›è¡ŒBTSE â†” Binary Optionè´¦æˆ·é—´èµ„é‡‘åˆ’è½¬
- **è´¦æˆ·ç‹¬ç«‹æ€§**ï¼šBinary Optionå¹³å°ç»´æŠ¤ç‹¬ç«‹çš„ç”¨æˆ·è´¦æˆ·ä½“ç³»

### 1.2 èµ„é‡‘æµå‘å˜æ›´
**åŸæµç¨‹ï¼ˆç›´æ¥é›†æˆï¼‰**ï¼š
```
BTSEè´¦æˆ· â‡„ Binary Optionå†»ç»“ä½™é¢ â†’ ç»“ç®—æ—¶è¿”å›BTSE
```

**æ–°æµç¨‹ï¼ˆç‹¬ç«‹è´¦æˆ·ï¼‰**ï¼š
```
BTSEè´¦æˆ· â†’ è´¦æˆ·åˆ’è½¬ â†’ Binary Optionä½™é¢ â†’ ä¸‹å•å†»ç»“ â†’ ç»“ç®—è§£å†»
```

## 2. ç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹

### 2.1 æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant G as Gateway
    participant C as Common-Service
    participant B as BTSE-API
    participant DB as Database

    U->>G: ç™»å½•è¯·æ±‚(BTSE Token)
    G->>C: è½¬å‘ç™»å½•è¯·æ±‚
    C->>B: éªŒè¯BTSEç”¨æˆ·è®¤è¯
    alt BTSEè®¤è¯æˆåŠŸ
        B->>C: è¿”å›ç”¨æˆ·ä¿¡æ¯
        C->>DB: æŸ¥è¯¢æœ¬åœ°ç”¨æˆ·
        alt ç”¨æˆ·ä¸å­˜åœ¨
            C->>B: è·å–BTSEç”¨æˆ·è¯¦æƒ…
            C->>DB: åˆ›å»ºç”¨æˆ·è®°å½•
            C->>DB: åˆ›å»ºç‹¬ç«‹è´¦æˆ·(DEMO+REAL)
        end
        C->>C: ç”Ÿæˆæœ¬åœ°JWT Token
        C->>G: è¿”å›ç™»å½•æˆåŠŸ
        G->>U: ç™»å½•æˆåŠŸ(JWT Token)
    else BTSEè®¤è¯å¤±è´¥
        B->>C: è®¤è¯å¤±è´¥
        C->>G: è¿”å›è®¤è¯å¤±è´¥é”™è¯¯
        G->>U: ç™»å½•å¤±è´¥
    end
```

### 2.2 è´¦æˆ·åˆå§‹åŒ–
åˆ›å»ºç”¨æˆ·æ—¶è‡ªåŠ¨åˆ›å»ºä¸¤ç§ç‹¬ç«‹è´¦æˆ·ï¼š

```sql
-- åˆ›å»ºç”¨æˆ·è®°å½•
INSERT INTO user (external_id, nickname, email, status, create_time, update_time)
VALUES ('btse_user_123', 'BTSEç”¨æˆ·', 'user@btse.com', 1, NOW(), NOW());

-- åˆ›å»ºREALè´¦æˆ·ï¼ˆç‹¬ç«‹ä½™é¢ï¼Œåˆå§‹ä¸º0ï¼‰
INSERT INTO account (user_id, account_type, currency, balance, frozen_balance, create_time, update_time)
VALUES (1, 'REAL', 'USDT', '0.0000000000000000', '0.0000000000000000', NOW(), NOW());

-- åˆ›å»ºDEMOè´¦æˆ·ï¼ˆå¯é¢†å–ä½“éªŒé‡‘ï¼‰
INSERT INTO account (user_id, account_type, currency, balance, frozen_balance, create_time, update_time)
VALUES (1, 'DEMO', 'USDT', '0.0000000000000000', '0.0000000000000000', NOW(), NOW());
```

## 3. è´¦æˆ·åˆ’è½¬æµç¨‹ **[æ–°å¢åŠŸèƒ½]**

### 3.1 åˆ’è½¬çŠ¶æ€æœºè®¾è®¡

```mermaid
stateDiagram-v2
    [*] --> PENDING : åˆ›å»ºåˆ’è½¬è®°å½•
    PENDING --> PROCESSING : å¼€å§‹è°ƒç”¨BTSE API
    PROCESSING --> SUCCESS : APIè°ƒç”¨æˆåŠŸ
    PROCESSING --> FAILED : APIè°ƒç”¨å¤±è´¥
    PROCESSING --> TIMEOUT : APIè°ƒç”¨è¶…æ—¶
    FAILED --> RETRYING : è¿›å…¥é‡è¯•æœºåˆ¶
    TIMEOUT --> RETRYING : è¿›å…¥é‡è¯•æœºåˆ¶
    RETRYING --> SUCCESS : é‡è¯•æˆåŠŸ
    RETRYING --> COMPENSATION : è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
    SUCCESS --> [*]
    COMPENSATION --> COMPENSATED : è¡¥å¿å®Œæˆ
    COMPENSATED --> [*]
```

### 3.2 åˆ’è½¬æµç¨‹å›¾ï¼ˆå«å¼‚å¸¸å¤„ç†ï¼‰

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant G as Gateway
    participant C as Common-Service
    participant B as BTSE-API
    participant DB as Database
    participant JOB as è¡¥å¿ä»»åŠ¡

    Note over U,JOB: FROM_BTSEåˆ’è½¬æµç¨‹
    U->>G: åˆ’è½¬è¯·æ±‚(FROM_BTSE, é‡‘é¢)
    G->>C: è½¬å‘åˆ’è½¬è¯·æ±‚
    
    C->>DB: 1.åˆ›å»ºPENDINGçŠ¶æ€åˆ’è½¬è®°å½•(å¹‚ç­‰ID)
    C->>DB: 2.æ£€æŸ¥æ˜¯å¦é‡å¤è¯·æ±‚
    alt é‡å¤è¯·æ±‚
        C->>G: è¿”å›å·²å­˜åœ¨çš„åˆ’è½¬ç»“æœ
        G->>U: å¹‚ç­‰å“åº”
    else æ–°è¯·æ±‚
        C->>DB: 3.æ›´æ–°çŠ¶æ€ä¸ºPROCESSING
        C->>B: 4.æŸ¥è¯¢BTSEè´¦æˆ·ä½™é¢
        alt BTSEä½™é¢å……è¶³
            loop é‡è¯•æœºåˆ¶(æœ€å¤š3æ¬¡)
                C->>B: æ‰§è¡ŒBTSEè½¬å‡º
                alt APIè°ƒç”¨æˆåŠŸ
                    C->>DB: 5.å¢åŠ æœ¬åœ°è´¦æˆ·ä½™é¢
                    C->>DB: 6.æ›´æ–°çŠ¶æ€ä¸ºSUCCESS
                    C->>DB: 7.è®°å½•æˆåŠŸæµæ°´
                    C->>G: è¿”å›åˆ’è½¬æˆåŠŸ
                    G->>U: åˆ’è½¬æˆåŠŸ
                else APIè¶…æ—¶/å¤±è´¥
                    C->>DB: è®°å½•é‡è¯•æ¬¡æ•°
                    alt æœªè¾¾æœ€å¤§é‡è¯•æ¬¡æ•°
                        Note over C: å»¶è¿Ÿé‡è¯•(æŒ‡æ•°é€€é¿)
                    else è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
                        C->>DB: æ›´æ–°çŠ¶æ€ä¸ºCOMPENSATION
                        JOB->>JOB: è§¦å‘è¡¥å¿ä»»åŠ¡
                        C->>G: è¿”å›å¤„ç†ä¸­çŠ¶æ€
                        G->>U: åˆ’è½¬å¤„ç†ä¸­
                    end
                end
            end
        else BTSEä½™é¢ä¸è¶³
            C->>DB: æ›´æ–°çŠ¶æ€ä¸ºFAILED
            C->>G: è¿”å›ä½™é¢ä¸è¶³é”™è¯¯
            G->>U: åˆ’è½¬å¤±è´¥
        end
    end

    Note over JOB: å¼‚æ­¥è¡¥å¿æµç¨‹
    JOB->>DB: æŸ¥è¯¢COMPENSATIONçŠ¶æ€è®°å½•
    JOB->>B: æŸ¥è¯¢BTSEè½¬è´¦çŠ¶æ€
    alt BTSEè½¬è´¦æˆåŠŸ
        JOB->>DB: å¢åŠ æœ¬åœ°è´¦æˆ·ä½™é¢
        JOB->>DB: æ›´æ–°çŠ¶æ€ä¸ºSUCCESS
    else BTSEè½¬è´¦å¤±è´¥
        JOB->>DB: æ›´æ–°çŠ¶æ€ä¸ºFAILED
        JOB->>JOB: å‘é€å‘Šè­¦é€šçŸ¥
    end
```

### 3.3 å¹‚ç­‰æ€§è®¾è®¡

**å¹‚ç­‰IDç”Ÿæˆç­–ç•¥**ï¼š
```java
// ç»„åˆç”¨æˆ·IDã€æ–¹å‘ã€æ—¶é—´æˆ³å’Œéšæœºæ•°ç”Ÿæˆå”¯ä¸€ID
String idempotentId = userId + "_" + direction + "_" + timestamp + "_" + randomCode;
// ç¤ºä¾‹: "123_FROM_BTSE_20250808103000_ABC123"
```

**å¹‚ç­‰æ€§æ£€æŸ¥**ï¼š
```sql
-- åˆ›å»ºåˆ’è½¬è®°å½•å‰æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
SELECT id, status, result FROM account_transfer 
WHERE idempotent_id = ? AND user_id = ?;

-- å¦‚æœå­˜åœ¨ä¸”çŠ¶æ€ä¸ºSUCCESS/FAILEDï¼Œç›´æ¥è¿”å›ç»“æœ
-- å¦‚æœå­˜åœ¨ä¸”çŠ¶æ€ä¸ºPENDING/PROCESSINGï¼Œè¿”å›å¤„ç†ä¸­
-- å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•
```

### 3.4 é‡è¯•æœºåˆ¶è®¾è®¡

**é‡è¯•ç­–ç•¥**ï¼š
- **æœ€å¤§é‡è¯•æ¬¡æ•°**ï¼š3æ¬¡
- **é€€é¿ç­–ç•¥**ï¼šæŒ‡æ•°é€€é¿ (1s, 2s, 4s)
- **é‡è¯•æ¡ä»¶**ï¼šè¶…æ—¶ã€ç½‘ç»œå¼‚å¸¸ã€BTSEç³»ç»Ÿç¹å¿™
- **ä¸é‡è¯•æ¡ä»¶**ï¼šä½™é¢ä¸è¶³ã€å‚æ•°é”™è¯¯ã€ç”¨æˆ·ä¸å­˜åœ¨

**é‡è¯•å®ç°**ï¼š
```java
@Retryable(
    value = {BtseTimeoutException.class, BtseSystemException.class},
    maxAttempts = 3,
    backoff = @Backoff(delay = 1000, multiplier = 2)
)
public BtseTransferResponse callBtseWithRetry(TransferRequest request) {
    // BTSE APIè°ƒç”¨é€»è¾‘
}
```

### 3.5 è¡¥å¿æœºåˆ¶è®¾è®¡

**è¡¥å¿ä»»åŠ¡è§¦å‘æ¡ä»¶**ï¼š
1. APIè°ƒç”¨è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
2. ç³»ç»Ÿå¼‚å¸¸å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
3. å®šæ—¶ä»»åŠ¡å‘ç°é•¿æ—¶é—´æœªå®Œæˆçš„åˆ’è½¬

**è¡¥å¿æµç¨‹**ï¼š
```java
@Scheduled(fixedDelay = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œ
public void compensateTransfers() {
    // 1. æŸ¥è¯¢éœ€è¦è¡¥å¿çš„è®°å½•
    List<Transfer> needCompensation = findCompensationTransfers();
    
    for (Transfer transfer : needCompensation) {
        try {
            // 2. æŸ¥è¯¢BTSEçœŸå®çŠ¶æ€
            BtseTransferStatus realStatus = queryBtseTransferStatus(transfer.getBtseTransferId());
            
            // 3. æ ¹æ®çœŸå®çŠ¶æ€è¿›è¡Œè¡¥å¿
            if ("SUCCESS".equals(realStatus.getStatus())) {
                // BTSEè½¬è´¦æˆåŠŸï¼Œè¡¥å¿æœ¬åœ°è´¦æˆ·
                compensateLocalAccount(transfer);
            } else if ("FAILED".equals(realStatus.getStatus())) {
                // BTSEè½¬è´¦å¤±è´¥ï¼Œæ›´æ–°æœ¬åœ°çŠ¶æ€
                updateTransferStatus(transfer.getId(), "FAILED");
            }
        } catch (Exception e) {
            log.error("è¡¥å¿åˆ’è½¬å¤±è´¥ï¼ŒIDï¼š{}ï¼Œé”™è¯¯ï¼š{}", transfer.getId(), e.getMessage());
        }
    }
}
```

### 3.6 åˆ’è½¬ç±»å‹

**FROM_BTSEï¼ˆå……å€¼ï¼‰**ï¼š
- ä»BTSEè´¦æˆ·è½¬å…¥Binary Optionè´¦æˆ·
- ç”¨æˆ·éœ€è¦æœ‰è¶³å¤Ÿçš„BTSEä½™é¢
- èµ„é‡‘æµå‘ï¼šBTSE â†’ Binary Option

**TO_BTSEï¼ˆæç°ï¼‰**ï¼š
- ä»Binary Optionè´¦æˆ·è½¬å‡ºåˆ°BTSEè´¦æˆ·  
- ç”¨æˆ·éœ€è¦æœ‰è¶³å¤Ÿçš„æœ¬åœ°ä½™é¢
- èµ„é‡‘æµå‘ï¼šBinary Option â†’ BTSE

### 3.3 åˆ’è½¬é™åˆ¶

```sql
-- åˆ’è½¬é…ç½®è¡¨
INSERT INTO transfer_config VALUES
('transfer.min.amount', '10.0000000000000000', 'æœ€å°åˆ’è½¬é‡‘é¢'),
('transfer.max.amount', '50000.0000000000000000', 'æœ€å¤§åˆ’è½¬é‡‘é¢'),
('transfer.daily.limit', '100000.0000000000000000', 'æ—¥åˆ’è½¬é™é¢'),
('transfer.fee.rate', '0.0000000000000000', 'åˆ’è½¬æ‰‹ç»­è´¹ç‡(æš‚æ—¶å…è´¹)');
```

### 3.7 æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡

**account_transfer è¡¨ï¼ˆæ–°å¢ï¼‰**ï¼š
```sql
CREATE TABLE account_transfer (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    idempotent_id VARCHAR(100) NOT NULL UNIQUE COMMENT 'å¹‚ç­‰ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    direction VARCHAR(20) NOT NULL COMMENT 'æ–¹å‘ï¼šFROM_BTSE, TO_BTSE',
    amount DECIMAL(28,16) NOT NULL COMMENT 'åˆ’è½¬é‡‘é¢',
    currency VARCHAR(10) NOT NULL DEFAULT 'USDT' COMMENT 'å¸ç§',
    status VARCHAR(20) NOT NULL COMMENT 'çŠ¶æ€ï¼šPENDING,PROCESSING,SUCCESS,FAILED,COMPENSATION,COMPENSATED',
    btse_transfer_id VARCHAR(100) COMMENT 'BTSEåˆ’è½¬ID',
    retry_count INT DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',
    error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    request_data JSON COMMENT 'è¯·æ±‚æ•°æ®',
    response_data JSON COMMENT 'å“åº”æ•°æ®',
    balance_before DECIMAL(28,16) COMMENT 'åˆ’è½¬å‰ä½™é¢',
    balance_after DECIMAL(28,16) COMMENT 'åˆ’è½¬åä½™é¢',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    process_time DATETIME COMMENT 'å¼€å§‹å¤„ç†æ—¶é—´',
    complete_time DATETIME COMMENT 'å®Œæˆæ—¶é—´',
    
    INDEX idx_user_status (user_id, status),
    INDEX idx_idempotent (idempotent_id),
    INDEX idx_btse_transfer (btse_transfer_id),
    INDEX idx_compensation (status, create_time)
) COMMENT='è´¦æˆ·åˆ’è½¬è®°å½•è¡¨';
```

**transfer_config è¡¨ï¼ˆæ–°å¢ï¼‰**ï¼š
```sql
CREATE TABLE transfer_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    config_key VARCHAR(100) NOT NULL UNIQUE,
    config_value VARCHAR(500) NOT NULL,
    config_type VARCHAR(50) NOT NULL COMMENT 'LIMIT,RETRY,TIMEOUT',
    description VARCHAR(200),
    is_enabled TINYINT DEFAULT 1,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT='åˆ’è½¬é…ç½®è¡¨';

-- åˆå§‹åŒ–é…ç½®æ•°æ®
INSERT INTO transfer_config VALUES
('transfer.min.amount', '10.0000000000000000', 'LIMIT', 'æœ€å°åˆ’è½¬é‡‘é¢', 1, NOW(), NOW()),
('transfer.max.amount', '50000.0000000000000000', 'LIMIT', 'æœ€å¤§åˆ’è½¬é‡‘é¢', 1, NOW(), NOW()),
('transfer.daily.limit', '100000.0000000000000000', 'LIMIT', 'æ—¥åˆ’è½¬é™é¢', 1, NOW(), NOW()),
('transfer.retry.max.count', '3', 'RETRY', 'æœ€å¤§é‡è¯•æ¬¡æ•°', 1, NOW(), NOW()),
('transfer.retry.delay.base', '1000', 'RETRY', 'é‡è¯•åŸºç¡€å»¶è¿Ÿ(æ¯«ç§’)', 1, NOW(), NOW()),
('transfer.timeout.btse.api', '30000', 'TIMEOUT', 'BTSE APIè¶…æ—¶æ—¶é—´(æ¯«ç§’)', 1, NOW(), NOW()),
('transfer.compensation.interval', '300000', 'TIMEOUT', 'è¡¥å¿ä»»åŠ¡é—´éš”(æ¯«ç§’)', 1, NOW(), NOW());
```

### 3.8 æ ¸å¿ƒå®ç°ä»£ç 

**åˆ’è½¬æœåŠ¡ä¸»è¦æ–¹æ³•**ï¼š
```java
@Service
@Transactional
public class AccountTransferService {
    
    /**
     * ä»BTSEåˆ’è½¬åˆ°Binary Option
     */
    public TransferResult transferFromBtse(TransferRequest request) {
        // 1. å¹‚ç­‰æ€§æ£€æŸ¥
        AccountTransfer existingTransfer = checkIdempotent(request.getIdempotentId());
        if (existingTransfer != null) {
            return buildResultFromTransfer(existingTransfer);
        }
        
        // 2. åˆ›å»ºåˆ’è½¬è®°å½•
        AccountTransfer transfer = createTransferRecord(request);
        
        try {
            // 3. æ›´æ–°çŠ¶æ€ä¸ºPROCESSING
            updateTransferStatus(transfer.getId(), "PROCESSING");
            
            // 4. è°ƒç”¨BTSE APIï¼ˆå¸¦é‡è¯•ï¼‰
            BtseTransferResponse btseResponse = callBtseWithRetry(transfer);
            
            // 5. æ›´æ–°æœ¬åœ°è´¦æˆ·ä½™é¢
            updateLocalBalance(transfer.getUserId(), transfer.getAmount(), "ADD");
            
            // 6. æ›´æ–°åˆ’è½¬çŠ¶æ€ä¸ºSUCCESS
            updateTransferSuccess(transfer.getId(), btseResponse);
            
            return TransferResult.success(transfer.getId());
            
        } catch (MaxRetryExceededException e) {
            // 7. è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œè¿›å…¥è¡¥å¿é˜Ÿåˆ—
            updateTransferStatus(transfer.getId(), "COMPENSATION");
            return TransferResult.processing(transfer.getId(), "ç³»ç»Ÿæ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨åæŸ¥è¯¢ç»“æœ");
            
        } catch (BusinessException e) {
            // 8. ä¸šåŠ¡å¼‚å¸¸ï¼Œç›´æ¥å¤±è´¥
            updateTransferStatus(transfer.getId(), "FAILED", e.getMessage());
            return TransferResult.failed(e.getMessage());
        }
    }
    
    /**
     * BTSE APIè°ƒç”¨ï¼ˆå¸¦é‡è¯•ï¼‰
     */
    @Retryable(
        value = {BtseTimeoutException.class, BtseSystemException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public BtseTransferResponse callBtseWithRetry(AccountTransfer transfer) {
        // è®°å½•é‡è¯•æ¬¡æ•°
        incrementRetryCount(transfer.getId());
        
        // è°ƒç”¨BTSE API
        BtseTransferRequest btseRequest = BtseTransferRequest.builder()
            .userId(transfer.getUserId())
            .amount(transfer.getAmount())
            .currency(transfer.getCurrency())
            .clientTransferId(transfer.getIdempotentId())
            .description("ç”¨æˆ·è´¦æˆ·åˆ’è½¬")
            .build();
            
        return btseApiClient.transferFromBtse(btseRequest);
    }
    
    /**
     * è¡¥å¿ä»»åŠ¡
     */
    @Scheduled(fixedDelayString = "${transfer.compensation.interval:300000}")
    public void compensateTransfers() {
        List<AccountTransfer> needCompensation = 
            transferMapper.findByStatusAndCreateTimeBefore("COMPENSATION", 
                LocalDateTime.now().minusMinutes(5));
                
        for (AccountTransfer transfer : needCompensation) {
            try {
                compensateTransfer(transfer);
            } catch (Exception e) {
                log.error("è¡¥å¿åˆ’è½¬å¼‚å¸¸ï¼ŒIDï¼š{}ï¼Œé”™è¯¯ï¼š{}", transfer.getId(), e.getMessage());
                // å‘é€å‘Šè­¦
                sendAlertNotification(transfer, e);
            }
        }
    }
    
    private void compensateTransfer(AccountTransfer transfer) {
        // æŸ¥è¯¢BTSEçœŸå®çŠ¶æ€
        BtseTransferStatus realStatus = 
            btseApiClient.queryTransferStatus(transfer.getBtseTransferId());
            
        if ("SUCCESS".equals(realStatus.getStatus())) {
            // BTSEæˆåŠŸï¼Œè¡¥å¿æœ¬åœ°è´¦æˆ·
            updateLocalBalance(transfer.getUserId(), transfer.getAmount(), "ADD");
            updateTransferStatus(transfer.getId(), "SUCCESS");
            
        } else if ("FAILED".equals(realStatus.getStatus())) {
            // BTSEå¤±è´¥ï¼Œæ›´æ–°æœ¬åœ°çŠ¶æ€
            updateTransferStatus(transfer.getId(), "FAILED", "BTSEåˆ’è½¬å¤±è´¥");
            
        } else {
            // çŠ¶æ€æœªæ˜ç¡®ï¼Œç»§ç»­ç­‰å¾…ä¸‹æ¬¡è¡¥å¿
            log.warn("BTSEåˆ’è½¬çŠ¶æ€æœªæ˜ç¡®ï¼ŒIDï¼š{}ï¼ŒçŠ¶æ€ï¼š{}", 
                transfer.getId(), realStatus.getStatus());
        }
    }
}
```

### 3.9 åˆ’è½¬æ•°æ®è®°å½•

**åˆ›å»ºåˆ’è½¬è®°å½•**ï¼š
```sql
INSERT INTO account_transfer (
    idempotent_id, user_id, direction, amount, currency, status,
    request_data, balance_before, create_time
) VALUES (
    '123_FROM_BTSE_20250808103000_ABC123',
    1, 'FROM_BTSE', '1000.0000000000000000', 'USDT', 'PENDING',
    '{"userId": 1, "amount": "1000.0000000000000000", "direction": "FROM_BTSE"}',
    '500.0000000000000000', NOW()
);
```

**æ›´æ–°æˆåŠŸçŠ¶æ€**ï¼š
```sql
UPDATE account_transfer SET 
    status = 'SUCCESS',
    btse_transfer_id = 'btse_123456789',
    balance_after = '1500.0000000000000000',
    response_data = '{"transferId": "btse_123456789", "status": "SUCCESS"}',
    complete_time = NOW(),
    update_time = NOW()
WHERE id = 1;
```

**è®°å½•è´¦æˆ·å˜åŠ¨**ï¼š
```sql
INSERT INTO account_transaction (
    user_id, account_id, type, direction, amount, 
    balance_before, balance_after, related_id, remark, create_time
) VALUES (
    1, 1, 'TRANSFER', 'IN', '1000.0000000000000000',
    '500.0000000000000000', '1500.0000000000000000', 
    '123_FROM_BTSE_20250808103000_ABC123', 'ä»BTSEè´¦æˆ·è½¬å…¥', NOW()
);
```

## 4. ä¸‹å•äº¤æ˜“æµç¨‹ **[ç®€åŒ–ç‰ˆ]**

### 4.1 æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant G as Gateway
    participant O as Order-Service
    participant C as Common-Service
    participant DB as Database

    U->>G: ä¸‹å•è¯·æ±‚
    G->>O: è½¬å‘ä¸‹å•è¯·æ±‚
    O->>O: é£æ§æ ¡éªŒ
    alt é£æ§é€šè¿‡
        O->>C: æ£€æŸ¥è´¦æˆ·ä½™é¢(æœ¬åœ°)
        alt ä½™é¢å……è¶³
            O->>C: å†»ç»“èµ„é‡‘(balance â†’ frozen_balance)
            O->>DB: åˆ›å»ºè®¢å•(çŠ¶æ€:ACTIVE)
            O->>G: è¿”å›ä¸‹å•æˆåŠŸ
            G->>U: ä¸‹å•æˆåŠŸ
        else ä½™é¢ä¸è¶³
            O->>G: è¿”å›ä½™é¢ä¸è¶³é”™è¯¯
            G->>U: ä¸‹å•å¤±è´¥(æç¤ºç”¨æˆ·å…ˆåˆ’è½¬)
        end
    else é£æ§æ‹¦æˆª
        O->>DB: è®°å½•é£æ§æ—¥å¿—
        O->>G: è¿”å›é£æ§é”™è¯¯
        G->>U: ä¸‹å•å¤±è´¥
    end
```

### 4.2 æµç¨‹è¯´æ˜

**å…³é”®å˜æ›´**ï¼š
- **ç»Ÿä¸€å¤„ç†**ï¼šDEMOå’ŒREALè´¦æˆ·éƒ½ä½¿ç”¨ç›¸åŒçš„ä¸‹å•æµç¨‹
- **æ— BTSEè°ƒç”¨**ï¼šä¸‹å•æ—¶ä¸å†è°ƒç”¨BTSE API
- **ä½™é¢æ£€æŸ¥**ï¼šåªæ£€æŸ¥æœ¬åœ°è´¦æˆ·ä½™é¢
- **ç›´æ¥æ¿€æ´»**ï¼šè®¢å•ç›´æ¥åˆ›å»ºä¸ºACTIVEçŠ¶æ€ï¼Œæ— PENDINGçŠ¶æ€

**èµ„é‡‘æµè½¬**ï¼š
```
æœ¬åœ°è´¦æˆ·ä½™é¢(balance) â†’ å†»ç»“ä½™é¢(frozen_balance)
```

### 4.3 æ•°æ®å˜åŒ–

```sql
-- 1. æ£€æŸ¥è´¦æˆ·ä½™é¢
SELECT balance FROM account WHERE user_id = 1 AND account_type = 'REAL';

-- 2. å†»ç»“èµ„é‡‘
UPDATE account SET 
    balance = balance - 100.0000000000000000,
    frozen_balance = frozen_balance + 100.0000000000000000
WHERE user_id = 1 AND account_type = 'REAL';

-- 3. åˆ›å»ºè®¢å•(ç›´æ¥ACTIVEçŠ¶æ€)
INSERT INTO option_order (
    user_id, account_type, symbol_id, round_id, direction, 
    amount, odds, status, create_time
) VALUES (
    1, 'REAL', 1, 123, 'UP', '100.0000000000000000', 
    '1.9000', 'ACTIVE', NOW()
);

-- 4. è®°å½•èµ„é‡‘æµæ°´
INSERT INTO account_transaction (type, amount, remark) 
VALUES ('BET_FREEZE', 100.0000000000000000, 'ä¸‹å•å†»ç»“èµ„é‡‘');
```

## 5. è‡ªåŠ¨ç»“ç®—æµç¨‹ **[ç®€åŒ–ç‰ˆ]**

### 5.1 æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant S as è°ƒåº¦ä»»åŠ¡
    participant O as Order-Service
    participant C as Common-Service
    participant M as Market-Service
    participant DB as Database

    S->>O: å®šæ—¶è§¦å‘ç»“ç®—
    O->>DB: æŸ¥è¯¢å¾…ç»“ç®—å›åˆ
    loop æ¯ä¸ªå›åˆ
        O->>M: è·å–ç»“ç®—ä»·æ ¼
        O->>DB: æŸ¥è¯¢å›åˆå†…ACTIVEçŠ¶æ€è®¢å•
        loop æ¯ä¸ªè®¢å•
            O->>O: è®¡ç®—ç›ˆäº
            alt ç›ˆåˆ©(WIN)
                O->>O: è®¡ç®—æ‰‹ç»­è´¹(10%)
                O->>C: è§£å†»+æ´¾å¥–åˆ°balance
                O->>C: è®°å½•ç›ˆåˆ©æµæ°´
            else äºæŸ(LOSE)
                O->>C: æ‰£é™¤å†»ç»“èµ„é‡‘
                O->>C: è®°å½•äºæŸæµæ°´
            else å¹³å±€(DRAW)
                O->>C: é€€è¿˜å†»ç»“èµ„é‡‘åˆ°balance
                O->>C: è®°å½•å¹³å±€æµæ°´
            end
            O->>DB: æ›´æ–°è®¢å•çŠ¶æ€
        end
        O->>DB: æ›´æ–°å›åˆçŠ¶æ€ä¸ºå·²ç»“ç®—
    end
```

### 5.2 æµç¨‹è¯´æ˜

**å…³é”®å˜æ›´**ï¼š
- **ç»Ÿä¸€å¤„ç†**ï¼šDEMOå’ŒREALè´¦æˆ·ç»“ç®—æµç¨‹å®Œå…¨ç›¸åŒ
- **æ— BTSEè°ƒç”¨**ï¼šç»“ç®—æ—¶ä¸è°ƒç”¨BTSE API
- **æœ¬åœ°ç»“ç®—**ï¼šæ‰€æœ‰ç›ˆåˆ©èµ„é‡‘ä¿ç•™åœ¨æœ¬åœ°è´¦æˆ·
- **ç”¨æˆ·é€‰æ‹©**ï¼šç›ˆåˆ©åç”¨æˆ·å¯é€‰æ‹©æ˜¯å¦æç°åˆ°BTSE

**èµ„é‡‘æµè½¬**ï¼š
- **ç›ˆåˆ©**ï¼š`frozen_balance` â†’ `balance` (æœ¬é‡‘+å‡€åˆ©æ¶¦)
- **äºæŸ**ï¼šæ‰£é™¤`frozen_balance`
- **å¹³å±€**ï¼š`frozen_balance` â†’ `balance` (é€€è¿˜æœ¬é‡‘)

### 5.3 ç»“ç®—ç¤ºä¾‹

**ç›ˆåˆ©ç»“ç®— (WIN)**ï¼š
```sql
-- 1. æ›´æ–°è®¢å•çŠ¶æ€
UPDATE option_order SET 
    status = 'WIN',
    expected_profit = 190.0000000000000000,  -- æœ¬é‡‘100 + èµ”ç‡æ”¶ç›Š90
    profit = 90.0000000000000000,           -- å®é™…ç›ˆåˆ©
    fee = 9.0000000000000000,               -- 10%æ‰‹ç»­è´¹
    settle_price = 45100.56789012,
    settle_time = NOW()
WHERE id = 1;

-- 2. è§£å†»å¹¶æ´¾å‘åˆ°ä½™é¢
UPDATE account SET 
    balance = balance + 181.0000000000000000,        -- æœ¬é‡‘100 + ç›ˆåˆ©90 - æ‰‹ç»­è´¹9
    frozen_balance = frozen_balance - 100.0000000000000000
WHERE user_id = 1 AND account_type = 'REAL';

-- 3. è®°å½•ç›ˆåˆ©æµæ°´
INSERT INTO account_transaction (type, amount, remark) 
VALUES ('BET_WIN', 181.0000000000000000, 'æŠ•æ³¨ç›ˆåˆ©(å«æœ¬é‡‘)');
```

**äºæŸç»“ç®— (LOSE)**ï¼š
```sql
-- 1. æ›´æ–°è®¢å•çŠ¶æ€
UPDATE option_order SET 
    status = 'LOSE',
    profit = -100.0000000000000000,
    fee = 0.0000000000000000,
    settle_price = 44900.98765432,
    settle_time = NOW()
WHERE id = 1;

-- 2. æ‰£é™¤å†»ç»“èµ„é‡‘
UPDATE account SET 
    frozen_balance = frozen_balance - 100.0000000000000000
WHERE user_id = 1 AND account_type = 'REAL';

-- 3. è®°å½•äºæŸæµæ°´
INSERT INTO account_transaction (type, amount, remark) 
VALUES ('BET_LOSE', -100.0000000000000000, 'æŠ•æ³¨äºæŸ');
```

## 6. è®¢å•çŠ¶æ€æµè½¬ **[ç®€åŒ–ç‰ˆ]**

### 6.1 çŠ¶æ€æµè½¬å›¾

```mermaid
stateDiagram-v2
    [*] --> ACTIVE : ä¸‹å•æˆåŠŸ(ä½™é¢å……è¶³)
    ACTIVE --> CANCELLED : æ’¤å•(é”å•å‰)
    ACTIVE --> WIN : ç»“ç®—ç›ˆåˆ©
    ACTIVE --> LOSE : ç»“ç®—äºæŸ  
    ACTIVE --> DRAW : ç»“ç®—å¹³å±€
    WIN --> [*]
    LOSE --> [*]
    DRAW --> [*]
    CANCELLED --> [*]
```

### 6.2 çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | å«ä¹‰ | è§¦å‘æ¡ä»¶ | åç»­çŠ¶æ€ |
|------|------|----------|----------|
| ACTIVE | è¿›è¡Œä¸­ | ä¸‹å•æˆåŠŸï¼Œèµ„é‡‘å·²å†»ç»“ | WIN/LOSE/DRAW/CANCELLED |
| WIN | ç›ˆåˆ© | ç»“ç®—æ—¶ç”¨æˆ·é¢„æµ‹æ­£ç¡® | ç»ˆæ€ |
| LOSE | äºæŸ | ç»“ç®—æ—¶ç”¨æˆ·é¢„æµ‹é”™è¯¯ | ç»ˆæ€ |
| DRAW | å¹³å±€ | ç»“ç®—ä»·æ ¼ç­‰äºä¸‹å•ä»·æ ¼ | ç»ˆæ€ |
| CANCELLED | å·²æ’¤é”€ | ç”¨æˆ·ä¸»åŠ¨æ’¤å• | ç»ˆæ€ |

**å…³é”®å˜æ›´**ï¼š
- **ç§»é™¤PENDINGçŠ¶æ€**ï¼šæ— éœ€BTSEåˆ’è½¬ç¡®è®¤
- **ç®€åŒ–æµç¨‹**ï¼šåªæœ‰æˆåŠŸä¸‹å•æ‰åˆ›å»ºè®¢å•
- **ç»Ÿä¸€å¤„ç†**ï¼šDEMOå’ŒREALè´¦æˆ·çŠ¶æ€æµè½¬ç›¸åŒ

## 7. ç”¨æˆ·èµ„é‡‘ç®¡ç†æµç¨‹

### 7.1 èµ„é‡‘æ¦‚è§ˆé¡µé¢

```mermaid
graph TD
    A[ç”¨æˆ·èµ„é‡‘æ€»è§ˆ] --> B[BTSEè´¦æˆ·ä½™é¢]
    A --> C[Binary Optionè´¦æˆ·ä½™é¢]
    A --> D[å†»ç»“èµ„é‡‘]
    
    B --> E[æŸ¥è¯¢BTSE APIè·å–]
    C --> F[æœ¬åœ°æ•°æ®åº“æŸ¥è¯¢]
    D --> G[æœ¬åœ°æ•°æ®åº“æŸ¥è¯¢]
    
    A --> H[åˆ’è½¬æ“ä½œ]
    H --> I[BTSE â†’ Binary Option]
    H --> J[Binary Option â†’ BTSE]
```

### 7.2 èµ„é‡‘æµè½¬å®Œæ•´é“¾è·¯

**ç”¨æˆ·æ“ä½œæµç¨‹**ï¼š
1. **ç™»å½•**: BTSEè®¤è¯ â†’ åˆ›å»ºæœ¬åœ°è´¦æˆ·
2. **å……å€¼**: BTSE â†’ è´¦æˆ·åˆ’è½¬ â†’ Binary Optionä½™é¢
3. **ä¸‹å•**: Binary Optionä½™é¢ â†’ å†»ç»“ä½™é¢
4. **ç»“ç®—**: å†»ç»“ä½™é¢ â†’ Binary Optionä½™é¢(ç›ˆåˆ©)/æ‰£é™¤(äºæŸ)
5. **æç°**: Binary Optionä½™é¢ â†’ è´¦æˆ·åˆ’è½¬ â†’ BTSE

## 8. APIæ¥å£è®¾è®¡

### 8.1 è´¦æˆ·åˆ’è½¬æ¥å£

**ä»BTSEå……å€¼**ï¼š
```http
POST /api/account/transfer/from-btse
Content-Type: application/json
Authorization: Bearer {jwt_token}

{
  "amount": "1000.0000000000000000",
  "accountType": "REAL",
  "idempotentId": "user123_FROM_BTSE_20250808103000_ABC123"
}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "transferId": "transfer_001",
    "status": "SUCCESS",  // SUCCESS, FAILED, PROCESSING
    "amount": "1000.0000000000000000",
    "estimatedTime": "2-5åˆ†é’Ÿ"
  },
  "success": true
}
```

**æç°åˆ°BTSE**ï¼š
```http
POST /api/account/transfer/to-btse
Content-Type: application/json
Authorization: Bearer {jwt_token}

{
  "amount": "500.0000000000000000",
  "accountType": "REAL",
  "idempotentId": "user123_TO_BTSE_20250808104000_DEF456"
}

Response:
{
  "code": 200,
  "message": "success", 
  "data": {
    "transferId": "transfer_002",
    "status": "PROCESSING",
    "amount": "500.0000000000000000",
    "estimatedTime": "2-5åˆ†é’Ÿ"
  },
  "success": true
}
```

**æŸ¥è¯¢åˆ’è½¬çŠ¶æ€**ï¼š
```http
GET /api/account/transfer/status/{transferId}
Authorization: Bearer {jwt_token}

Response:
{
  "code": 200,
  "data": {
    "transferId": "transfer_001",
    "status": "SUCCESS",
    "direction": "FROM_BTSE",
    "amount": "1000.0000000000000000",
    "createTime": "2025-08-08 10:30:00",
    "completeTime": "2025-08-08 10:32:15",
    "errorMessage": null
  }
}
```

**æŸ¥è¯¢åˆ’è½¬è®°å½•**ï¼š
```http
GET /api/account/transfer/history?accountType=REAL&status=SUCCESS&limit=20&offset=0
Authorization: Bearer {jwt_token}

Response:
{
  "code": 200,
  "data": {
    "transfers": [
      {
        "transferId": "transfer_001",
        "direction": "FROM_BTSE",
        "amount": "1000.0000000000000000",
        "status": "SUCCESS",
        "createTime": "2025-08-08 10:30:00",
        "completeTime": "2025-08-08 10:32:15"
      }
    ],
    "total": 1,
    "hasMore": false
  }
}
```

**é‡è¯•åˆ’è½¬**ï¼š
```http
POST /api/account/transfer/retry/{transferId}
Authorization: Bearer {jwt_token}

Response:
{
  "code": 200,
  "message": "é‡è¯•è¯·æ±‚å·²æäº¤",
  "data": {
    "transferId": "transfer_003",
    "retryCount": 2,
    "status": "PROCESSING"
  }
}
```

### 8.2 è´¦æˆ·ä½™é¢æ¥å£

**æŸ¥è¯¢è´¦æˆ·ä½™é¢**ï¼š
```http
GET /api/account/balance?accountType=REAL
Authorization: Bearer {jwt_token}

Response:
{
  "code": 200,
  "data": {
    "accountType": "REAL",
    "balance": "1500.0000000000000000",
    "frozenBalance": "100.0000000000000000",
    "availableBalance": "1400.0000000000000000"
  }
}
```

**æŸ¥è¯¢BTSEä½™é¢**ï¼š
```http
GET /api/account/btse-balance
Authorization: Bearer {jwt_token}

Response:
{
  "code": 200,
  "data": {
    "availableBalance": "5000.0000000000000000",
    "currency": "USDT"
  }
}
```

## 9. ä¼˜åŠ¿ä¸ç‰¹ç‚¹

### 9.1 æ¶æ„ä¼˜åŠ¿

**ç‹¬ç«‹æ€§**ï¼š
- Binary Optionå¹³å°ç»´æŠ¤ç‹¬ç«‹è´¦æˆ·ä½“ç³»
- å‡å°‘å¯¹BTSE APIçš„ä¾èµ–
- æé«˜ç³»ç»Ÿå¯ç”¨æ€§å’Œç¨³å®šæ€§

**ç”¨æˆ·ä½“éªŒ**ï¼š
- å¿«é€Ÿä¸‹å•ï¼Œæ— éœ€ç­‰å¾…BTSEç¡®è®¤
- ç›ˆåˆ©èµ„é‡‘ç«‹å³å¯ç”¨
- ç”¨æˆ·å¯çµæ´»é€‰æ‹©èµ„é‡‘å­˜æ”¾ä½ç½®

**é£é™©æ§åˆ¶**ï¼š
- å¹³å°èµ„é‡‘æ± ç®¡ç†
- æ›´å¥½çš„æµåŠ¨æ€§æ§åˆ¶
- å‡å°‘å¤–éƒ¨APIæ•…éšœå½±å“

### 9.2 æŠ€æœ¯ä¼˜åŠ¿

**æ€§èƒ½æå‡**ï¼š
- ä¸‹å•æµç¨‹æ— å¤–éƒ¨APIè°ƒç”¨
- ç»“ç®—é€Ÿåº¦æ›´å¿«
- å‡å°‘ç½‘ç»œå»¶è¿Ÿå’Œè¶…æ—¶

**ç»´æŠ¤ç®€åŒ–**ï¼š
- å‡å°‘BTSE APIé›†æˆå¤æ‚åº¦
- é™ä½åˆ†å¸ƒå¼äº‹åŠ¡é£é™©
- ç®€åŒ–çŠ¶æ€ç®¡ç†

**æ‰©å±•æ€§**ï¼š
- æ˜“äºæ”¯æŒå¤šå¸ç§
- ä¾¿äºæ·»åŠ æ–°çš„æ”¯ä»˜æ–¹å¼
- æ”¯æŒæ›´å¤æ‚çš„äº§å“åŠŸèƒ½

## 10. å¼‚å¸¸åœºæ™¯å¤„ç†

### 10.1 å¸¸è§å¼‚å¸¸åœºæ™¯

| å¼‚å¸¸ç±»å‹ | å¤„ç†ç­–ç•¥ | ç”¨æˆ·ä½“éªŒ | è¡¥å¿æœºåˆ¶ |
|---------|----------|----------|----------|
| BTSE APIè¶…æ—¶ | é‡è¯•3æ¬¡ â†’ è¿›å…¥è¡¥å¿é˜Ÿåˆ— | æ˜¾ç¤º"å¤„ç†ä¸­" | å®šæ—¶ä»»åŠ¡æŸ¥è¯¢çœŸå®çŠ¶æ€ |
| BTSEä½™é¢ä¸è¶³ | ç«‹å³è¿”å›å¤±è´¥ | æç¤ºå……å€¼BTSEè´¦æˆ· | æ— éœ€è¡¥å¿ |
| ç½‘ç»œå¼‚å¸¸ | é‡è¯•3æ¬¡ â†’ è¿›å…¥è¡¥å¿é˜Ÿåˆ— | æ˜¾ç¤º"å¤„ç†ä¸­" | å®šæ—¶ä»»åŠ¡é‡æ–°å¤„ç† |
| ç³»ç»Ÿå¼‚å¸¸ | è®°å½•æ—¥å¿— â†’ äººå·¥å¤„ç† | æç¤ºç³»ç»Ÿç¹å¿™ | äººå·¥ä»‹å…¥è¡¥å¿ |
| é‡å¤è¯·æ±‚ | å¹‚ç­‰æ€§æ£€æŸ¥ | è¿”å›åŸç»“æœ | æ— éœ€è¡¥å¿ |
| æ•°æ®åº“å¼‚å¸¸ | äº‹åŠ¡å›æ»š | æç¤ºç¨åé‡è¯• | æ— æ•°æ®ä¸ä¸€è‡´ |

### 10.2 çŠ¶æ€ä¸ä¸€è‡´å¤„ç†

**åœºæ™¯1ï¼šBTSEæˆåŠŸï¼Œæœ¬åœ°å¤±è´¥**
```java
// è¡¥å¿é€»è¾‘ï¼šæŸ¥è¯¢BTSEçŠ¶æ€ï¼Œè¡¥å¿æœ¬åœ°è´¦æˆ·
if (btseStatus.equals("SUCCESS") && localStatus.equals("FAILED")) {
    // è¡¥å¿æœ¬åœ°è´¦æˆ·ä½™é¢
    updateLocalBalance(transfer.getUserId(), transfer.getAmount(), "ADD");
    updateTransferStatus(transfer.getId(), "SUCCESS");
    
    // è®°å½•è¡¥å¿æ—¥å¿—
    log.info("è¡¥å¿æˆåŠŸï¼šBTSEè½¬è´¦æˆåŠŸä½†æœ¬åœ°çŠ¶æ€å¼‚å¸¸ï¼ŒIDï¼š{}", transfer.getId());
}
```

**åœºæ™¯2ï¼šæœ¬åœ°æ‰£æ¬¾æˆåŠŸï¼ŒBTSEè½¬è´¦å¤±è´¥**
```java
// è¡¥å¿é€»è¾‘ï¼šå›æ»šæœ¬åœ°æ‰£æ¬¾
if (btseStatus.equals("FAILED") && localBalanceDeducted) {
    // é€€å›æœ¬åœ°è´¦æˆ·ä½™é¢  
    updateLocalBalance(transfer.getUserId(), transfer.getAmount(), "ADD");
    updateTransferStatus(transfer.getId(), "FAILED", "BTSEè½¬è´¦å¤±è´¥ï¼Œå·²é€€å›ä½™é¢");
    
    // è®°å½•è¡¥å¿æ—¥å¿—
    log.info("è¡¥å¿æˆåŠŸï¼šBTSEè½¬è´¦å¤±è´¥ï¼Œå·²é€€å›ç”¨æˆ·ä½™é¢ï¼ŒIDï¼š{}", transfer.getId());
}
```

### 10.3 ç›‘æ§å‘Šè­¦æœºåˆ¶

**å‘Šè­¦è§„åˆ™é…ç½®**ï¼š
```sql
INSERT INTO alert_config VALUES
('transfer.timeout.count', '10', '5åˆ†é’Ÿå†…è¶…æ—¶åˆ’è½¬æ•°é‡è¶…è¿‡é˜ˆå€¼'),
('transfer.failed.rate', '0.1', 'åˆ’è½¬å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼'),
('transfer.compensation.count', '5', 'éœ€è¦è¡¥å¿çš„åˆ’è½¬æ•°é‡è¶…è¿‡é˜ˆå€¼'),
('transfer.large.amount', '10000.0000000000000000', 'å•ç¬”å¤§é¢åˆ’è½¬å‘Šè­¦'),
('transfer.daily.total', '100000.0000000000000000', 'æ—¥åˆ’è½¬æ€»é¢è¶…è¿‡é˜ˆå€¼');
```

**å‘Šè­¦å®ç°**ï¼š
```java
@Service
public class TransferAlertService {
    
    /**
     * æ£€æŸ¥å¹¶å‘é€å‘Šè­¦
     */
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void checkAndSendAlerts() {
        // 1. è¶…æ—¶å‘Šè­¦
        checkTimeoutAlerts();
        
        // 2. å¤±è´¥ç‡å‘Šè­¦
        checkFailureRateAlerts();
        
        // 3. è¡¥å¿é˜Ÿåˆ—å‘Šè­¦
        checkCompensationQueueAlerts();
        
        // 4. å¤§é¢åˆ’è½¬å‘Šè­¦
        checkLargeAmountAlerts();
    }
    
    private void checkTimeoutAlerts() {
        LocalDateTime fiveMinutesAgo = LocalDateTime.now().minusMinutes(5);
        int timeoutCount = transferMapper.countTimeoutTransfers(fiveMinutesAgo);
        
        int threshold = alertConfigService.getIntValue("transfer.timeout.count", 10);
        if (timeoutCount > threshold) {
            sendAlert("åˆ’è½¬è¶…æ—¶å‘Šè­¦", 
                String.format("5åˆ†é’Ÿå†…è¶…æ—¶åˆ’è½¬æ•°é‡ï¼š%dï¼Œè¶…è¿‡é˜ˆå€¼ï¼š%d", timeoutCount, threshold));
        }
    }
    
    private void checkFailureRateAlerts() {
        LocalDateTime oneHourAgo = LocalDateTime.now().minusHours(1);
        TransferStats stats = transferMapper.getTransferStats(oneHourAgo);
        
        double failureRate = (double) stats.getFailedCount() / stats.getTotalCount();
        double threshold = alertConfigService.getDoubleValue("transfer.failed.rate", 0.1);
        
        if (failureRate > threshold) {
            sendAlert("åˆ’è½¬å¤±è´¥ç‡å‘Šè­¦",
                String.format("1å°æ—¶å†…åˆ’è½¬å¤±è´¥ç‡ï¼š%.2f%%ï¼Œè¶…è¿‡é˜ˆå€¼ï¼š%.2f%%", 
                    failureRate * 100, threshold * 100));
        }
    }
    
    private void sendAlert(String title, String message) {
        // å‘é€é’‰é’‰/ä¼å¾®/é‚®ä»¶å‘Šè­¦
        alertNotificationService.sendAlert(AlertLevel.HIGH, title, message);
        
        // è®°å½•å‘Šè­¦æ—¥å¿—
        log.warn("ğŸ“¢ {}: {}", title, message);
    }
}
```

### 10.4 é£é™©æ§åˆ¶ä¸ç›‘æ§

**åˆ’è½¬é£æ§è§„åˆ™**ï¼š
```java
@Service
public class TransferRiskService {
    
    /**
     * åˆ’è½¬å‰é£æ§æ£€æŸ¥
     */
    public RiskCheckResult checkTransferRisk(TransferRequest request) {
        // 1. é‡‘é¢é™åˆ¶æ£€æŸ¥
        if (!checkAmountLimit(request)) {
            return RiskCheckResult.reject("åˆ’è½¬é‡‘é¢è¶…å‡ºé™åˆ¶");
        }
        
        // 2. é¢‘æ¬¡é™åˆ¶æ£€æŸ¥
        if (!checkFrequencyLimit(request)) {
            return RiskCheckResult.reject("æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }
        
        // 3. æ—¥ç´¯è®¡é™é¢æ£€æŸ¥
        if (!checkDailyLimit(request)) {
            return RiskCheckResult.reject("ä»Šæ—¥ç´¯è®¡åˆ’è½¬å·²è¾¾ä¸Šé™");
        }
        
        // 4. ç”¨æˆ·çŠ¶æ€æ£€æŸ¥
        if (!checkUserStatus(request.getUserId())) {
            return RiskCheckResult.reject("è´¦æˆ·çŠ¶æ€å¼‚å¸¸ï¼Œè¯·è”ç³»å®¢æœ");
        }
        
        // 5. å¤§é¢åˆ’è½¬å®¡æ ¸
        if (isLargeAmount(request.getAmount())) {
            return RiskCheckResult.requireApproval("å¤§é¢åˆ’è½¬éœ€è¦å®¡æ ¸");
        }
        
        return RiskCheckResult.pass();
    }
    
    private boolean checkFrequencyLimit(TransferRequest request) {
        // æ£€æŸ¥5åˆ†é’Ÿå†…åˆ’è½¬æ¬¡æ•°
        LocalDateTime fiveMinutesAgo = LocalDateTime.now().minusMinutes(5);
        int recentCount = transferMapper.countRecentTransfers(
            request.getUserId(), fiveMinutesAgo);
        
        return recentCount < 3; // 5åˆ†é’Ÿå†…æœ€å¤š3æ¬¡
    }
}
```

**å®æ—¶ç›‘æ§æŒ‡æ ‡**ï¼š
```java
@Component
public class TransferMetrics {
    
    private final MeterRegistry meterRegistry;
    
    // åˆ’è½¬æˆåŠŸç‡
    private final Counter successCounter;
    private final Counter failureCounter;
    
    // åˆ’è½¬é‡‘é¢ç»Ÿè®¡
    private final Timer transferTimer;
    private final DistributionSummary transferAmount;
    
    // è¡¥å¿é˜Ÿåˆ—å¤§å°
    private final Gauge compensationQueueSize;
    
    public void recordTransferSuccess(String direction, BigDecimal amount) {
        successCounter.increment(
            Tags.of("direction", direction, "result", "success"));
        transferAmount.record(amount.doubleValue());
    }
    
    public void recordTransferFailure(String direction, String reason) {
        failureCounter.increment(
            Tags.of("direction", direction, "result", "failure", "reason", reason));
    }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 (ç‹¬ç«‹è´¦æˆ·æ¨¡å¼)  
**æœ€åæ›´æ–°**: 2025å¹´8æœˆ08æ—¥  
**ç»´æŠ¤è€…**: Claude AI  
**ä¸»è¦å˜æ›´**: ç§»é™¤ä¸‹å•/ç»“ç®—ä¸­çš„BTSE APIè°ƒç”¨ï¼Œæ–°å¢ç‹¬ç«‹çš„è´¦æˆ·åˆ’è½¬åŠŸèƒ½