# è‡ªåŠ¨åŒ–æµ‹è¯•æ–¹æ¡ˆ

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†äºŒå…ƒæœŸæƒäº¤æ˜“ç³»ç»Ÿçš„è‡ªåŠ¨åŒ–æµ‹è¯•æ–¹æ¡ˆï¼ŒåŸºäºbashè„šæœ¬å®ç°çš„APIæµ‹è¯•æ¡†æ¶ï¼Œæ¶µç›–æœåŠ¡å¥åº·æ£€æŸ¥ã€RPCæ¥å£æµ‹è¯•ã€APIåŠŸèƒ½æµ‹è¯•å’Œå®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•ã€‚

## æµ‹è¯•æ¶æ„

### æµ‹è¯•å±‚æ¬¡ç»“æ„

```
è‡ªåŠ¨åŒ–æµ‹è¯•æ¶æ„
â”œâ”€â”€ æœåŠ¡å¥åº·æ£€æŸ¥ (Health Checks)
â”‚   â”œâ”€â”€ æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥
â”‚   â”œâ”€â”€ æ•°æ®åº“è¿æ¥æ£€æŸ¥
â”‚   â””â”€â”€ Redisè¿æ¥æ£€æŸ¥
â”œâ”€â”€ RPCæ¥å£æµ‹è¯• (RPC Tests)
â”‚   â”œâ”€â”€ å¸‚åœºæœåŠ¡RPCæµ‹è¯•
â”‚   â”œâ”€â”€ è´¦æˆ·æœåŠ¡RPCæµ‹è¯•
â”‚   â””â”€â”€ è®¢å•æœåŠ¡RPCæµ‹è¯•
â”œâ”€â”€ APIæ¥å£æµ‹è¯• (API Tests)
â”‚   â”œâ”€â”€ è®¤è¯ç›¸å…³API
â”‚   â”œâ”€â”€ å¸‚åœºæ•°æ®API
â”‚   â”œâ”€â”€ è´¦æˆ·ç®¡ç†API
â”‚   â””â”€â”€ è®¢å•ç®¡ç†API
â””â”€â”€ ä¸šåŠ¡æµç¨‹æµ‹è¯• (Flow Tests)
    â”œâ”€â”€ ç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹
    â”œâ”€â”€ å®Œæ•´ä¸‹å•æµç¨‹
    â””â”€â”€ è´¦æˆ·èµ„é‡‘æµç¨‹
```

## æŠ€æœ¯æ ˆ

### æµ‹è¯•å·¥å…·é€‰æ‹©

- **è„šæœ¬è¯­è¨€**: Bash Shell
- **HTTPå®¢æˆ·ç«¯**: cURL
- **JSONå¤„ç†**: jq
- **æ•°æ®åº“å®¢æˆ·ç«¯**: mysqlå‘½ä»¤è¡Œå·¥å…·
- **Tokenç®¡ç†**: åŸºäºæ–‡ä»¶çš„JWT tokenç¼“å­˜
- **æµ‹è¯•æŠ¥å‘Š**: æ§åˆ¶å°è¾“å‡º + æ—¥å¿—æ–‡ä»¶

### ç›®å½•ç»“æ„

```
test-scripts/
â”œâ”€â”€ run-all-tests.sh          # æµ‹è¯•æ‰§è¡Œå…¥å£
â”œâ”€â”€ common/                   # å…¬å…±å‡½æ•°åº“
â”‚   â”œâ”€â”€ functions.sh          # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ config.sh            # é…ç½®æ–‡ä»¶
â”œâ”€â”€ data/                    # æµ‹è¯•æ•°æ®
â”‚   â”œâ”€â”€ last_token.json      # JWT tokenç¼“å­˜
â”‚   â””â”€â”€ test_users.json      # æµ‹è¯•ç”¨æˆ·æ•°æ®
â”œâ”€â”€ modules/                 # æ¨¡å—åŒ–æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ health/              # å¥åº·æ£€æŸ¥
â”‚   â”‚   â””â”€â”€ services.sh
â”‚   â”œâ”€â”€ auth/                # è®¤è¯æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ login.sh
â”‚   â”‚   â””â”€â”€ register.sh
â”‚   â”œâ”€â”€ market/              # å¸‚åœºæœåŠ¡æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ symbol.sh        # RPCæ¥å£æµ‹è¯•
â”‚   â”‚   â””â”€â”€ api.sh          # APIæ¥å£æµ‹è¯•
â”‚   â”œâ”€â”€ account/             # è´¦æˆ·æœåŠ¡æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ rpc.sh
â”‚   â”‚   â””â”€â”€ api.sh
â”‚   â””â”€â”€ order/               # è®¢å•æœåŠ¡æµ‹è¯•
â”‚       â”œâ”€â”€ rpc.sh
â”‚       â””â”€â”€ create.sh
â”œâ”€â”€ flows/                   # æµç¨‹æµ‹è¯•
â”‚   â””â”€â”€ complete_order.sh    # å®Œæ•´ä¸‹å•æµç¨‹
â””â”€â”€ logs/                    # æµ‹è¯•æ—¥å¿—
    â””â”€â”€ test_results.log
```

## æµ‹è¯•å®ç°

### 1. ä¸»æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash

# äºŒå…ƒæœŸæƒäº¤æ˜“ç³»ç»Ÿ - è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶
# æŒ‰ç…§é€»è¾‘é¡ºåºæ‰§è¡Œæ‰€æœ‰æµ‹è¯•

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "=== äºŒå…ƒæœŸæƒäº¤æ˜“ç³»ç»Ÿè‡ªåŠ¨åŒ–æµ‹è¯• ==="
echo "å¼€å§‹æ—¶é—´: $(date)"
echo

# 1. æœåŠ¡å¥åº·æ£€æŸ¥ (æœ€å…ˆæ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰æœåŠ¡å¯ç”¨)
echo "1. æ‰§è¡ŒæœåŠ¡å¥åº·æ£€æŸ¥..."
./modules/health/services.sh
echo

# 2. åŸºç¡€æœåŠ¡æµ‹è¯• (ä¸éœ€è¦è®¤è¯çš„RPCæœåŠ¡)
echo "2. æ‰§è¡Œå¸‚åœºæœåŠ¡RPCæµ‹è¯•..."
./modules/market/symbol.sh
echo

echo "3. æ‰§è¡Œè´¦æˆ·æœåŠ¡RPCæµ‹è¯•..."
./modules/account/rpc.sh
echo

# 3. è®¤è¯ç›¸å…³æµ‹è¯• (ä¸ºåç»­æµ‹è¯•å‡†å¤‡token)
echo "4. æ‰§è¡Œè®¤è¯æµ‹è¯•..."
./modules/auth/login.sh
echo

# 4. åŸºç¡€APIæµ‹è¯• (éœ€è¦è®¤è¯çš„API)
echo "5. æ‰§è¡Œå¸‚åœºæœåŠ¡APIæµ‹è¯•..."
./modules/market/api.sh
echo

echo "6. æ‰§è¡Œè´¦æˆ·æœåŠ¡APIæµ‹è¯•..."
./modules/account/api.sh
echo

# 5. è®¢å•ç›¸å…³æµ‹è¯•
echo "7. æ‰§è¡Œè®¢å•æœåŠ¡RPCæµ‹è¯•..."
./modules/rpc/order/get-order.sh
echo

echo "8. æ‰§è¡Œè®¢å•åˆ›å»ºæµ‹è¯•..."
./modules/order/create.sh
echo

# 6. å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
echo "9. æ‰§è¡Œå®Œæ•´ä¸‹å•æµç¨‹æµ‹è¯•..."
./flows/complete_order.sh
echo

echo "=== æ‰€æœ‰æµ‹è¯•å®Œæˆ ==="
echo "ç»“æŸæ—¶é—´: $(date)"
```

### 2. å…¬å…±å‡½æ•°åº“

#### common/functions.sh

```bash
#!/bin/bash

# å…¬å…±å‡½æ•°åº“
BASE_URL="http://localhost:8080"

# æ£€æŸ¥HTTPçŠ¶æ€ç 
check_http_status() {
    local status_code=$1
    local expected=$2
    local test_name=$3
    
    if [ "$status_code" = "$expected" ]; then
        echo "âœ… $test_name passed (HTTP $status_code)"
        return 0
    else
        echo "âŒ $test_name failed (HTTP $status_code, expected $expected)"
        return 1
    fi
}

# æ£€æŸ¥JSONå“åº”æˆåŠŸçŠ¶æ€
check_json_success() {
    local response=$1
    local test_name=$2
    
    local success=$(echo "$response" | jq -r '.success // false')
    if [ "$success" = "true" ]; then
        echo "âœ… $test_name success"
        return 0
    else
        echo "âŒ $test_name failed"
        echo "Response: $response"
        return 1
    fi
}

# è·å–ç¼“å­˜çš„token
get_cached_token() {
    local token_file="$SCRIPT_DIR/../../data/last_token.json"
    if [ -f "$token_file" ]; then
        cat "$token_file" | jq -r '.token // empty'
    fi
}

# ä¿å­˜tokenåˆ°ç¼“å­˜
save_token() {
    local token=$1
    local token_file="$SCRIPT_DIR/../../data/last_token.json"
    mkdir -p "$(dirname "$token_file")"
    echo "{\"token\":\"$token\",\"timestamp\":$(date +%s)}" > "$token_file"
}
```

### 3. æ¨¡å—åŒ–æµ‹è¯•è„šæœ¬

#### modules/market/api.sh (Market APIæµ‹è¯•)

#!/bin/bash

# Market Service API Test Script
BASE_URL="http://localhost:8080"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TOKEN_FILE="$SCRIPT_DIR/../../data/last_token.json"

source "$SCRIPT_DIR/../../common/functions.sh"

echo "=== Market Service API Test ==="

# æ£€æŸ¥tokenæ–‡ä»¶
if [ ! -f "$TOKEN_FILE" ]; then
    echo "âŒ Token file not found: $TOKEN_FILE"
    echo "Please run authentication tests first"
    exit 1
fi

TOKEN=$(cat "$TOKEN_FILE" | jq -r '.token')
echo "Using token: ${TOKEN:0:20}..."

# æµ‹è¯•è·å–ä»·æ ¼
echo "1. Testing Get Price by Symbol (BTC-USDT)..."
RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    "$BASE_URL/api/market/price/BTC-USDT")
HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')

check_http_status "$HTTP_CODE" "200" "Get price by symbol"
if [ $? -eq 0 ]; then
    check_json_success "$BODY" "Price data retrieval"
fi

# ... æ›´å¤šæµ‹è¯•ç”¨ä¾‹
```

### 4. ä¸šåŠ¡æµç¨‹æµ‹è¯•

#### flows/complete_order.sh

```bash
#!/bin/bash

# å®Œæ•´ä¸‹å•æµç¨‹æµ‹è¯•
# æ¨¡æ‹Ÿç”¨æˆ·ä»ç™»å½•åˆ°ä¸‹å•çš„å®Œæ•´ä¸šåŠ¡æµç¨‹

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../common/functions.sh"

echo "=== å®Œæ•´ä¸‹å•æµç¨‹æµ‹è¯• ==="

# 1. ç”¨æˆ·ç™»å½•
echo "æ­¥éª¤1: ç”¨æˆ·ç™»å½•..."
LOGIN_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
    -H "Content-Type: application/json" \
    -d '{"username":"testuser","password":"password123"}' \
    "$BASE_URL/api/auth/login")

LOGIN_HTTP_CODE=$(echo "$LOGIN_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
LOGIN_BODY=$(echo "$LOGIN_RESPONSE" | sed '/HTTP_CODE:/d')

if ! check_http_status "$LOGIN_HTTP_CODE" "200" "ç”¨æˆ·ç™»å½•"; then
    echo "âŒ ç™»å½•å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹æµ‹è¯•"
    exit 1
fi

TOKEN=$(echo "$LOGIN_BODY" | jq -r '.data.token')
USER_ID=$(echo "$LOGIN_BODY" | jq -r '.data.userId')
save_token "$TOKEN"

# 2. æŸ¥è¯¢è´¦æˆ·ä½™é¢
echo "æ­¥éª¤2: æŸ¥è¯¢è´¦æˆ·ä½™é¢..."
BALANCE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    "$BASE_URL/api/account/balance")

# 3. è·å–äº¤æ˜“å¯¹ä¿¡æ¯
echo "æ­¥éª¤3: è·å–äº¤æ˜“å¯¹ä¿¡æ¯..."
SYMBOLS_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    "$BASE_URL/api/market/symbols")

# 4. è·å–å®æ—¶ä»·æ ¼
echo "æ­¥éª¤4: è·å–BTC-USDTå®æ—¶ä»·æ ¼..."
PRICE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    "$BASE_URL/api/market/price/BTC-USDT")

# 5. åˆ›å»ºè®¢å•
echo "æ­¥éª¤5: åˆ›å»ºè®¢å•..."
ORDER_REQUEST='{
    "symbol": "BTC-USDT",
    "amount": 10.0,
    "direction": "UP",
    "duration": 60,
    "accountType": "DEMO"
}'

ORDER_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "$ORDER_REQUEST" \
    "$BASE_URL/api/orders")

ORDER_HTTP_CODE=$(echo "$ORDER_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
ORDER_BODY=$(echo "$ORDER_RESPONSE" | sed '/HTTP_CODE:/d')

if check_http_status "$ORDER_HTTP_CODE" "200" "åˆ›å»ºè®¢å•"; then
    ORDER_ID=$(echo "$ORDER_BODY" | jq -r '.data.id')
    echo "âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•ID: $ORDER_ID"
    
    # 6. æŸ¥è¯¢è®¢å•çŠ¶æ€
    echo "æ­¥éª¤6: æŸ¥è¯¢è®¢å•çŠ¶æ€..."
    ORDER_STATUS_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
        -H "Authorization: Bearer $TOKEN" \
        "$BASE_URL/api/orders/$ORDER_ID")
    
    # 7. éªŒè¯è´¦æˆ·ä½™é¢å˜åŒ–
    echo "æ­¥éª¤7: éªŒè¯è´¦æˆ·ä½™é¢å˜åŒ–..."
    NEW_BALANCE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
        -H "Authorization: Bearer $TOKEN" \
        "$BASE_URL/api/account/balance")
fi

echo "=== å®Œæ•´ä¸‹å•æµç¨‹æµ‹è¯•å®Œæˆ ==="
```

## é…ç½®ç®¡ç†

### ç¯å¢ƒé…ç½®

```bash
# common/config.sh
#!/bin/bash

# æµ‹è¯•ç¯å¢ƒé…ç½®
export TEST_ENV="local"
export BASE_URL="http://localhost:8080"
export DB_HOST="localhost"
export DB_PORT="3306"
export DB_NAME="binary_option"
export REDIS_HOST="localhost"
export REDIS_PORT="6379"

# æµ‹è¯•ç”¨æˆ·é…ç½®
export TEST_USERNAME="testuser"
export TEST_PASSWORD="password123"
export TEST_EMAIL="test@example.com"

# æµ‹è¯•æ•°æ®é…ç½®
export DEFAULT_SYMBOL="BTC-USDT"
export DEFAULT_AMOUNT="10.0"
export DEFAULT_DURATION="60"
```

## MockæœåŠ¡é›†æˆ

### BTSE Mocké…ç½®

```bash
# åœ¨è®¢å•æœåŠ¡æµ‹è¯•ä¸­ä½¿ç”¨Mock
if [ "$USE_MOCK" = "true" ]; then
    echo "ä½¿ç”¨Mockæ¨¡å¼è¿›è¡Œæµ‹è¯•"
    export BTSE_MOCK_ENABLED=true
    # å¯åŠ¨æ—¶è®¾ç½® --spring.profiles.active=test,mock
fi
```

## æŒç»­é›†æˆé…ç½®

### Jenkins Pipeline

```groovy
pipeline {
    agent any
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build Services') {
            steps {
                sh './rebuild-restart.sh all'
            }
        }
        
        stage('Wait for Services') {
            steps {
                sh 'sleep 30'  // ç­‰å¾…æœåŠ¡å¯åŠ¨
            }
        }
        
        stage('Run Tests') {
            steps {
                dir('test-scripts') {
                    sh './run-all-tests.sh > ../test-results.log 2>&1'
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'test-results.log'
                }
            }
        }
    }
}
```

## æµ‹è¯•æ•°æ®ç®¡ç†

### æµ‹è¯•æ•°æ®åˆå§‹åŒ–

```sql
-- test-data/init.sql
-- æµ‹è¯•ç”¨æˆ·æ•°æ®
INSERT INTO user (username, password, email, status) VALUES 
('testuser', '$2a$10$encoded_password', 'test@example.com', 'ACTIVE');

-- æµ‹è¯•äº¤æ˜“å¯¹æ•°æ®
INSERT INTO symbol_config (symbol, display_name, enabled, min_amount, max_amount) VALUES 
('BTC-USDT', 'æ¯”ç‰¹å¸/USDT', 1, 1.00, 10000.00),
('ETH-USDT', 'ä»¥å¤ªåŠ/USDT', 1, 1.00, 10000.00);

-- æµ‹è¯•è´¦æˆ·æ•°æ®
INSERT INTO account (user_id, account_type, balance, frozen_balance) VALUES 
(1, 'DEMO', 10000.00, 0.00),
(1, 'REAL', 1000.00, 0.00);
```

## æµ‹è¯•æŠ¥å‘Šä¸ç›‘æ§

### æµ‹è¯•ç»“æœç»Ÿè®¡

```bash
# æµ‹è¯•ç»“æœç»Ÿè®¡å‡½æ•°
generate_test_report() {
    local total_tests=$1
    local passed_tests=$2
    local failed_tests=$3
    
    echo "=== æµ‹è¯•æŠ¥å‘Š ==="
    echo "æ€»æµ‹è¯•æ•°: $total_tests"
    echo "é€šè¿‡: $passed_tests"
    echo "å¤±è´¥: $failed_tests"
    echo "æˆåŠŸç‡: $(( passed_tests * 100 / total_tests ))%"
    echo "=================="
}
```

### æ—¥å¿—ç®¡ç†

```bash
# æ—¥å¿—è®°å½•å‡½æ•°
log_test_result() {
    local test_name=$1
    local result=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "[$timestamp] $test_name: $result" >> logs/test_results.log
}
```

## æœ€ä½³å®è·µ

### 1. æµ‹è¯•è„šæœ¬ç¼–å†™è§„èŒƒ

- æ¯ä¸ªæµ‹è¯•è„šæœ¬ç‹¬ç«‹å¯æ‰§è¡Œ
- ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- æä¾›æ¸…æ™°çš„æµ‹è¯•è¾“å‡ºå’Œæ—¥å¿—
- æ”¯æŒé…ç½®åŒ–çš„æµ‹è¯•å‚æ•°

### 2. Tokenç®¡ç†ç­–ç•¥

- ä½¿ç”¨æ–‡ä»¶ç¼“å­˜JWT token
- è‡ªåŠ¨æ£€æµ‹tokenè¿‡æœŸå¹¶é‡æ–°è·å–
- æ”¯æŒå¤šç”¨æˆ·å¹¶å‘æµ‹è¯•

### 3. é”™è¯¯å¤„ç†æœºåˆ¶

```bash
# ç»Ÿä¸€é”™è¯¯å¤„ç†
handle_error() {
    local exit_code=$1
    local error_msg=$2
    
    if [ $exit_code -ne 0 ]; then
        echo "âŒ é”™è¯¯: $error_msg"
        log_test_result "ERROR" "$error_msg"
        return 1
    fi
    return 0
}
```

### 4. å¹¶å‘æµ‹è¯•æ”¯æŒ

```bash
# å¹¶å‘æ‰§è¡Œæµ‹è¯•
run_parallel_tests() {
    local test_scripts=("$@")
    
    for script in "${test_scripts[@]}"; do
        ./"$script" &
    done
    
    wait  # ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡å®Œæˆ
}
```

## æ€»ç»“

æœ¬è‡ªåŠ¨åŒ–æµ‹è¯•æ–¹æ¡ˆåŸºäºbashè„šæœ¬å®ç°ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### æ ¸å¿ƒä¼˜åŠ¿
- **è½»é‡çº§**: æ— éœ€å¤æ‚çš„æµ‹è¯•æ¡†æ¶ä¾èµ–
- **çµæ´»æ€§**: æ˜“äºæ‰©å±•å’Œä¿®æ”¹æµ‹è¯•ç”¨ä¾‹  
- **é›†æˆæ€§**: ä¸ç°æœ‰CI/CDæµç¨‹æ— ç¼é›†æˆ
- **å¯ç»´æŠ¤æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºç»´æŠ¤

### æµ‹è¯•è¦†ç›–èŒƒå›´
- æœåŠ¡å¥åº·çŠ¶æ€æ£€æŸ¥
- RPCæ¥å£åŠŸèƒ½éªŒè¯
- APIæ¥å£å®Œæ•´æ€§æµ‹è¯•
- ç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹éªŒè¯
- MockæœåŠ¡é›†æˆæµ‹è¯•

### æµ‹è¯•æ‰§è¡Œç­–ç•¥
- æŒ‰é€»è¾‘é¡ºåºæ‰§è¡Œæµ‹è¯•
- è‡ªåŠ¨å¤„ç†ä¾èµ–å…³ç³»
- æ”¯æŒå¹¶å‘æµ‹è¯•æ‰§è¡Œ
- è¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Šè¾“å‡º

é€šè¿‡è¿™å¥—æµ‹è¯•æ–¹æ¡ˆï¼Œèƒ½å¤Ÿæœ‰æ•ˆä¿éšœç³»ç»Ÿè´¨é‡ï¼Œæ”¯æŒå¿«é€Ÿè¿­ä»£å¼€å‘ï¼Œé™ä½ç”Ÿäº§ç¯å¢ƒé£é™©ã€‚

## ç‰ˆæœ¬æ›´æ–°å†å²

### v2.0ç‰ˆæœ¬æ›´æ–°ï¼ˆ2025å¹´8æœˆ06æ—¥ï¼‰
**æ ¸å¿ƒå˜æ›´ï¼šBTSEè½¬è´¦æ—¥å¿—è®°å½•å’Œå®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•**
- æµ‹è¯•è„šæœ¬å¢å¼ºï¼šæ·»åŠ complete-workflowæµ‹è¯•ï¼Œè¦†ç›–æ³¨å†Œã€ç™»å½•ã€DEMOèµ„é‡‘é¢†å–ã€ä¸‹å•ã€ç»“ç®—å…¨æµç¨‹
- BTSEè½¬è´¦éªŒè¯ï¼šæ–°å¢btse_transfer_logè¡¨æ•°æ®éªŒè¯ï¼Œç¡®ä¿æ‰€æœ‰BTSEè½¬è´¦æ“ä½œæ­£ç¡®è®°å½•
- è®¢å•ç»“ç®—æµ‹è¯•ï¼šå®ç°è®¢å•ç»“ç®—é€»è¾‘æµ‹è¯•ï¼ŒåŒ…æ‹¬ç›ˆåˆ©/äºæŸåœºæ™¯çš„èµ„é‡‘æµå‘éªŒè¯
- Mock APIé›†æˆï¼šå®Œå–„BTSE Mock APIæµ‹è¯•ï¼Œæ”¯æŒè½¬è´¦å¤±è´¥ã€ä½™é¢ä¸è¶³ç­‰å¼‚å¸¸åœºæ™¯æ¨¡æ‹Ÿ
- æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥ï¼šå¢åŠ è´¦æˆ·ä½™é¢ä¸äº¤æ˜“æµæ°´ä¸€è‡´æ€§éªŒè¯

## æ–°å¢æµ‹è¯•è„šæœ¬

### simple-flow-test.sh - ç®€åŒ–ä¸šåŠ¡æµç¨‹æµ‹è¯•

è¿™æ˜¯v2.0ç‰ˆæœ¬æ–°å¢çš„æ ¸å¿ƒæµ‹è¯•è„šæœ¬ï¼Œå®ç°äº†å®Œæ•´çš„ä¸šåŠ¡æµç¨‹éªŒè¯ï¼š

```bash
#!/bin/bash

# ç®€åŒ–çš„å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
# ç”¨äºè°ƒè¯•å’ŒéªŒè¯å„ä¸ªæ­¥éª¤

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/utils/common.sh"
source "$SCRIPT_DIR/common/config.sh"

print_header "ç®€åŒ–å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•"

# æµ‹è¯•æ¦‚è¿°
print_info "æµ‹è¯•æ¦‚è¿°:"
print_info "1. æ³¨å†Œç™»å½• â†’ 2. é¢†å–DEMOèµ„é‡‘ â†’ 3. DEMOä¸‹å• â†’ 4. REALä¸‹å• â†’ 5. è®¢å•ç»“ç®— â†’ 6. æ£€æŸ¥æ—¥å¿—"

# é…ç½®å˜é‡
USERNAME="flowtest_$(date +%s)"
PASSWORD="password123"
DEMO_ORDER_AMOUNT="10.00"
REAL_ORDER_AMOUNT="5.00"

# æ­¥éª¤1: ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
print_step "æ­¥éª¤1: ç”¨æˆ·æ³¨å†Œ"
REGISTER_RESPONSE=$(api_call "POST" "/api/user/register" "{
    \"username\": \"$USERNAME\",
    \"password\": \"$PASSWORD\",
    \"nickname\": \"Flow Test\",
    \"phone\": \"138$(date +%s | tail -c 9)\",
    \"email\": \"$USERNAME@test.com\"
}")

if check_success "$REGISTER_RESPONSE"; then
    USER_ID=$(echo "$REGISTER_RESPONSE" | jq -r '.data.userId')
    print_success "âœ… æ³¨å†ŒæˆåŠŸï¼Œç”¨æˆ·ID: $USER_ID"
else
    print_error "âŒ æ³¨å†Œå¤±è´¥"
    exit 1
fi

print_step "æ­¥éª¤2: ç”¨æˆ·ç™»å½•"
LOGIN_RESPONSE=$(api_call "POST" "/api/user/login" "{
    \"username\": \"$USERNAME\",
    \"password\": \"$PASSWORD\"
}")

if check_success "$LOGIN_RESPONSE"; then
    TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.data.token')
    print_success "âœ… ç™»å½•æˆåŠŸ"
    echo "{\"username\": \"$USERNAME\", \"userId\": $USER_ID, \"token\": \"$TOKEN\"}" > "$SCRIPT_DIR/data/last_token.json"
else
    print_error "âŒ ç™»å½•å¤±è´¥"
    exit 1
fi

# æ­¥éª¤3: æ£€æŸ¥ç”¨æˆ·è´¦æˆ·
print_step "æ­¥éª¤3: æ£€æŸ¥ç”¨æˆ·è´¦æˆ·"
ACCOUNTS=$(execute_sql "SELECT id, account_type, balance, frozen_balance FROM account WHERE user_id = $USER_ID;")
if [ -n "$ACCOUNTS" ]; then
    print_success "âœ… æ‰¾åˆ°ç”¨æˆ·è´¦æˆ·"
    echo "ID | ç±»å‹ | ä½™é¢ | å†»ç»“"
    echo "$ACCOUNTS" | while IFS=$'\t' read -r id type balance frozen; do
        if [ -n "$id" ]; then
            printf "%s | %s | %s | %s\n" "$id" "$type" "$balance" "$frozen"
        fi
    done
else
    print_error "âŒ ç”¨æˆ·æ²¡æœ‰è´¦æˆ·"
    exit 1
fi

# æ­¥éª¤4: é¢†å–DEMOèµ„é‡‘
print_step "æ­¥éª¤4: é¢†å–DEMOèµ„é‡‘"
CLAIM_RESPONSE=$(api_call "POST" "/api/account/demo/claim-bonus" "" "$TOKEN")
if check_success "$CLAIM_RESPONSE"; then
    print_success "âœ… DEMOèµ„é‡‘é¢†å–æˆåŠŸ"
    
    # éªŒè¯ä½™é¢
    sleep 1
    DEMO_BALANCE_RESPONSE=$(api_call "GET" "/api/account/balance/DEMO" "" "$TOKEN")
    if check_success "$DEMO_BALANCE_RESPONSE"; then
        DEMO_BALANCE=$(echo "$DEMO_BALANCE_RESPONSE" | jq -r '.data.balance')
        print_info "DEMOè´¦æˆ·ä½™é¢: $DEMO_BALANCE"
    fi
else
    print_error "âŒ DEMOèµ„é‡‘é¢†å–å¤±è´¥"
fi

# æ­¥éª¤5: DEMOä¸‹å•
print_step "æ­¥éª¤5: DEMOä¸‹å•"
DEMO_ORDER_RESPONSE=$(api_call "POST" "/api/order" "{
    \"accountType\": \"DEMO\",
    \"symbolId\": 1,
    \"direction\": \"UP\",
    \"amount\": $DEMO_ORDER_AMOUNT
}" "$TOKEN")

if check_success "$DEMO_ORDER_RESPONSE"; then
    DEMO_ORDER_ID=$(echo "$DEMO_ORDER_RESPONSE" | jq -r '.data.id')
    print_success "âœ… DEMOè®¢å•åˆ›å»ºæˆåŠŸï¼ŒID: $DEMO_ORDER_ID"
else
    print_error "âŒ DEMOä¸‹å•å¤±è´¥"
fi

# æ­¥éª¤6: REALä¸‹å•æµ‹è¯•
print_step "æ­¥éª¤6: REALä¸‹å• (BTSE Mockæµ‹è¯•)"
REAL_ORDER_RESPONSE=$(api_call "POST" "/api/order" "{
    \"accountType\": \"REAL\",
    \"symbolId\": 1,
    \"direction\": \"DOWN\",
    \"amount\": $REAL_ORDER_AMOUNT
}" "$TOKEN")

if check_success "$REAL_ORDER_RESPONSE"; then
    REAL_ORDER_ID=$(echo "$REAL_ORDER_RESPONSE" | jq -r '.data.id')
    print_success "âœ… REALè®¢å•åˆ›å»ºæˆåŠŸï¼ŒID: $REAL_ORDER_ID"
    print_info "ğŸ’¡ BTSE Mock APIå·²è‡ªåŠ¨æ‰§è¡Œèµ„é‡‘è½¬è´¦"
else
    print_error "âŒ REALä¸‹å•å¤±è´¥"
fi

# æ­¥éª¤7: è®¢å•ç»“ç®—
print_step "æ­¥éª¤7: è®¢å•ç»“ç®— (ç­‰å¾…5ç§’åç»“ç®—)"
sleep 5  # ç­‰å¾…è®¢å•åˆ°æœŸ

# æ¨¡æ‹Ÿå¸‚åœºä»·æ ¼ï¼ˆåŸºäºä¸‹å•ä»·æ ¼æµ®åŠ¨ï¼‰
DEMO_SETTLE_PRICE="50100.00"  # å‡è®¾DEMOè®¢å•UPæ–¹å‘ç›ˆåˆ©
REAL_SETTLE_PRICE="49900.00"  # å‡è®¾REALè®¢å•DOWNæ–¹å‘ç›ˆåˆ©

if [ -n "$DEMO_ORDER_ID" ]; then
    print_info "ç»“ç®—DEMOè®¢å•ï¼ŒID: $DEMO_ORDER_IDï¼Œç»“ç®—ä»·æ ¼: $DEMO_SETTLE_PRICE"
    DEMO_SETTLE_RESPONSE=$(api_call "POST" "/rpc/order/$DEMO_ORDER_ID/settle?settlePrice=$DEMO_SETTLE_PRICE" "" "$TOKEN")
    
    if check_success "$DEMO_SETTLE_RESPONSE"; then
        print_success "âœ… DEMOè®¢å•ç»“ç®—æˆåŠŸ"
    else
        print_warning "âš ï¸  DEMOè®¢å•ç»“ç®—å¤±è´¥"
    fi
fi

if [ -n "$REAL_ORDER_ID" ]; then
    print_info "ç»“ç®—REALè®¢å•ï¼ŒID: $REAL_ORDER_IDï¼Œç»“ç®—ä»·æ ¼: $REAL_SETTLE_PRICE"
    REAL_SETTLE_RESPONSE=$(api_call "POST" "/rpc/order/$REAL_ORDER_ID/settle?settlePrice=$REAL_SETTLE_PRICE" "" "$TOKEN")
    
    if check_success "$REAL_SETTLE_RESPONSE"; then
        print_success "âœ… REALè®¢å•ç»“ç®—æˆåŠŸ"
    else
        print_warning "âš ï¸  REALè®¢å•ç»“ç®—å¤±è´¥"
    fi
fi

# æ­¥éª¤8: æ£€æŸ¥btse_transfer_logè®°å½•
print_step "æ­¥éª¤8: æ£€æŸ¥BTSEè½¬è´¦æ—¥å¿—"
BTSE_LOGS=$(execute_sql "SELECT id, user_id, direction, amount, status, transfer_id FROM btse_transfer_log ORDER BY create_time DESC LIMIT 5;")

if [ -n "$BTSE_LOGS" ]; then
    print_success "âœ… æ‰¾åˆ°BTSEè½¬è´¦æ—¥å¿—è®°å½•:"
    echo "ID | ç”¨æˆ·ID | æ–¹å‘ | é‡‘é¢ | çŠ¶æ€ | è½¬è´¦ID"
    echo "$BTSE_LOGS" | while IFS=$'\t' read -r id user_id direction amount status transfer_id; do
        if [ -n "$id" ]; then
            printf "%s | %s | %s | %s | %s | %s\n" "$id" "$user_id" "$direction" "$amount" "$status" "$transfer_id"
        fi
    done
else
    print_warning "âš ï¸  æœªæ‰¾åˆ°BTSEè½¬è´¦æ—¥å¿—è®°å½•"
fi

# ç»“æœæ€»ç»“
print_header "æµ‹è¯•ç»“æœæ€»ç»“"
echo "ç”¨æˆ·ä¿¡æ¯:"
echo "  ç”¨æˆ·å: $USERNAME"
echo "  ç”¨æˆ·ID: $USER_ID"
echo "  Tokenå·²ä¿å­˜åˆ°: data/last_token.json"
echo
echo "è®¢å•ä¿¡æ¯:"
echo "  DEMOè®¢å•ID: $DEMO_ORDER_ID (ç»“ç®—ä»·æ ¼: $DEMO_SETTLE_PRICE)"
echo "  REALè®¢å•ID: $REAL_ORDER_ID (ç»“ç®—ä»·æ ¼: $REAL_SETTLE_PRICE)"
echo

# æœ€ç»ˆè´¦æˆ·çŠ¶æ€æ£€æŸ¥
print_info "æœ€ç»ˆè´¦æˆ·çŠ¶æ€:"
FINAL_ACCOUNTS=$(execute_sql "SELECT account_type, balance, frozen_balance FROM account WHERE user_id = $USER_ID;")
if [ -n "$FINAL_ACCOUNTS" ]; then
    echo "ç±»å‹ | ä½™é¢ | å†»ç»“"
    echo "$FINAL_ACCOUNTS" | while IFS=$'\t' read -r type balance frozen; do
        if [ -n "$type" ]; then
            printf "%s | %s | %s\n" "$type" "$balance" "$frozen"
        fi
    done
fi

print_success "ğŸ‰ å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•å®Œæˆï¼"

echo
print_info "ğŸ’¡ æµ‹è¯•å®Œæˆé¡¹ç›®ï¼š"
print_info "âœ… ç”¨æˆ·æ³¨å†Œç™»å½•"
print_info "âœ… DEMOèµ„é‡‘é¢†å–"
print_info "âœ… DEMOè´¦æˆ·ä¸‹å• (balance â†’ frozen_balance)"
print_info "âœ… REALè´¦æˆ·ä¸‹å• (BTSE Mock â†’ frozen_balance)"
print_info "âœ… è®¢å•ç»“ç®— (ç›ˆäºè®¡ç®—)"
print_info "âœ… BTSEè½¬è´¦æ—¥å¿—è®°å½• (btse_transfer_logè¡¨)"
print_info "âœ… è´¦æˆ·äº¤æ˜“è®°å½• (account_transactionè¡¨)"
```

### å…³é”®æµ‹è¯•éªŒè¯ç‚¹

#### 1. DEMOè´¦æˆ·èµ„é‡‘æµå‘æµ‹è¯•
```bash
# DEMOè´¦æˆ·æµ‹è¯•éªŒè¯ç‚¹
# 1. åˆå§‹ä½™é¢ä¸º0
# 2. é¢†å–DEMOèµ„é‡‘åä½™é¢å¢åŠ åˆ°é…ç½®é‡‘é¢
# 3. ä¸‹å•æ—¶ï¼šbalance â†’ frozen_balance
# 4. ç»“ç®—æ—¶ï¼šfrozen_balance â†’ balance (ç›ˆåˆ©) æˆ– frozen_balanceæ¸…é›¶ (äºæŸ)
```

#### 2. REALè´¦æˆ·BTSEè½¬è´¦æµ‹è¯•
```bash
# REALè´¦æˆ·æµ‹è¯•éªŒè¯ç‚¹  
# 1. ä¸‹å•æ—¶ï¼šBTSE Mock API â†’ frozen_balance
# 2. btse_transfer_logè®°å½•ï¼šdirection='IN', status='SUCCESS'
# 3. ç»“ç®—æ—¶ï¼ˆç›ˆåˆ©ï¼‰ï¼šfrozen_balance â†’ BTSE Mock API
# 4. btse_transfer_logè®°å½•ï¼šdirection='OUT', status='SUCCESS', order_idå…³è”
# 5. ç»“ç®—æ—¶ï¼ˆäºæŸï¼‰ï¼šfrozen_balanceæ¸…é›¶ï¼Œæ— BTSEè½¬è´¦ï¼Œæ— æ—¥å¿—
```

#### 3. æ•°æ®å®Œæ•´æ€§éªŒè¯
```bash
# æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
verify_data_integrity() {
    # æ£€æŸ¥è´¦æˆ·ä½™é¢ä¸äº¤æ˜“æµæ°´ä¸€è‡´æ€§
    local consistency_check=$(execute_sql "
        SELECT a.id, a.balance + a.frozen_balance as total_balance,
               COALESCE(SUM(CASE WHEN at.type IN ('DEPOSIT', 'BET_WIN', 'BTSE_IN') THEN at.amount ELSE 0 END), 0) -
               COALESCE(SUM(CASE WHEN at.type IN ('WITHDRAW', 'BET_LOSE', 'BTSE_OUT') THEN ABS(at.amount) ELSE 0 END), 0) as calculated_balance
        FROM account a
        LEFT JOIN account_transaction at ON a.id = at.account_id
        WHERE a.user_id = $USER_ID
        GROUP BY a.id
        HAVING ABS(total_balance - calculated_balance) > 0.0001;
    ")
    
    if [ -z "$consistency_check" ]; then
        print_success "âœ… è´¦æˆ·æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"
    else
        print_warning "âš ï¸  å‘ç°è´¦æˆ·æ•°æ®ä¸ä¸€è‡´"
    fi
}
```

#### 4. BTSEè½¬è´¦æ—¥å¿—å®Œæ•´æ€§éªŒè¯
```bash
# BTSEè½¬è´¦æ—¥å¿—éªŒè¯
verify_btse_logs() {
    # éªŒè¯æ¯ä¸ªREALè®¢å•éƒ½æœ‰å¯¹åº”çš„è½¬å…¥æ—¥å¿—
    local missing_in_logs=$(execute_sql "
        SELECT o.id FROM option_order o
        WHERE o.account_type = 'REAL' 
        AND NOT EXISTS (
            SELECT 1 FROM btse_transfer_log btl 
            WHERE btl.order_id = o.id AND btl.direction = 'IN'
        );
    ")
    
    # éªŒè¯ç›ˆåˆ©è®¢å•éƒ½æœ‰å¯¹åº”çš„è½¬å‡ºæ—¥å¿—  
    local missing_out_logs=$(execute_sql "
        SELECT o.id FROM option_order o
        WHERE o.account_type = 'REAL' 
        AND o.status = 'WIN'
        AND NOT EXISTS (
            SELECT 1 FROM btse_transfer_log btl 
            WHERE btl.order_id = o.id AND btl.direction = 'OUT'
        );
    ")
    
    if [ -z "$missing_in_logs" ] && [ -z "$missing_out_logs" ]; then
        print_success "âœ… BTSEè½¬è´¦æ—¥å¿—å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"
    else
        print_warning "âš ï¸  å‘ç°BTSEè½¬è´¦æ—¥å¿—ç¼ºå¤±"
    fi
}
```

### æµ‹è¯•æ‰§è¡Œç­–ç•¥ä¼˜åŒ–

#### å¹¶å‘æµ‹è¯•æ”¯æŒ
```bash
# æ”¯æŒå¤šç”¨æˆ·å¹¶å‘æµ‹è¯•
run_concurrent_user_tests() {
    local user_count=$1
    
    for ((i=1; i<=user_count; i++)); do
        (
            USERNAME="concurrent_user_$i_$(date +%s)"
            ./simple-flow-test.sh
        ) &
    done
    
    wait  # ç­‰å¾…æ‰€æœ‰ç”¨æˆ·æµ‹è¯•å®Œæˆ
    
    # éªŒè¯å¹¶å‘æµ‹è¯•ç»“æœ
    verify_concurrent_data_integrity
}
```

#### å¼‚å¸¸åœºæ™¯æµ‹è¯•
```bash
# BTSE Mockå¼‚å¸¸åœºæ™¯æµ‹è¯•
test_btse_failure_scenarios() {
    # æµ‹è¯•ä½™é¢ä¸è¶³åœºæ™¯
    export BTSE_MOCK_BALANCE_INSUFFICIENT_RATE=1.0
    
    # æµ‹è¯•è½¬è´¦å¤±è´¥åœºæ™¯
    export BTSE_MOCK_TRANSFER_FAILURE_RATE=1.0
    
    # æ‰§è¡Œæµ‹è¯•å¹¶éªŒè¯å¼‚å¸¸å¤„ç†
    ./simple-flow-test.sh
    
    # é‡ç½®Mocké…ç½®
    unset BTSE_MOCK_BALANCE_INSUFFICIENT_RATE
    unset BTSE_MOCK_TRANSFER_FAILURE_RATE
}
```

### æµ‹è¯•è¦†ç›–èŒƒå›´æ‰©å±•

v2.0ç‰ˆæœ¬æµ‹è¯•è¦†ç›–çš„æ–°å¢åŠŸèƒ½ï¼š

1. âœ… **DEMOèµ„é‡‘é¢†å–æµç¨‹**ï¼šé…ç½®é©±åŠ¨çš„èµ„é‡‘å‘æ”¾ï¼Œä½™é¢é˜ˆå€¼æ£€æŸ¥
2. âœ… **BTSE Mock APIé›†æˆ**ï¼šå®Œæ•´çš„è½¬è´¦æµç¨‹æ¨¡æ‹Ÿï¼Œå¼‚å¸¸åœºæ™¯å¤„ç†
3. âœ… **è®¢å•ç»“ç®—æµç¨‹**ï¼šç›ˆåˆ©/äºæŸ/å¹³å±€ä¸‰ç§ç»“ç®—åœºæ™¯
4. âœ… **èµ„é‡‘æµå‘éªŒè¯**ï¼šDEMO (balance âŸ· frozen_balance) vs REAL (BTSE âŸ· frozen_balance)
5. âœ… **æ—¥å¿—è®°å½•å®Œæ•´æ€§**ï¼šbtse_transfer_logè¡¨çš„å†™å…¥å’ŒæŸ¥è¯¢éªŒè¯
6. âœ… **æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**ï¼šè´¦æˆ·ä½™é¢ä¸äº¤æ˜“æµæ°´çš„å¯¹è´¦éªŒè¯
7. âœ… **ç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹**ï¼šä»ç”¨æˆ·æ³¨å†Œåˆ°è®¢å•ç»“ç®—çš„å®Œæ•´é“¾è·¯æµ‹è¯•
