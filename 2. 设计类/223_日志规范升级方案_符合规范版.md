# 日志规范升级方案（符合BTSE规范版）

## 1. 升级目标
严格按照BTSE日志规范要求实施：
1. **符合路径规范** - 使用`/usr/local/btse/logs/`
2. **符合命名规范** - `{service_name}-{type}.log`格式  
3. **符合日志格式规范** - 包含PID、call-id、trace-id等必需字段
4. **多类型日志分离** - application、error、access日志分离

## 2. 需要修改的文件清单

### 2.1 创建新文件（4个logback配置）

#### 文件1: `option-common-service/src/main/resources/logback-spring.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- 按BTSE规范定义路径和服务名 -->
    <property name="LOG_PATH" value="/usr/local/btse/logs"/>
    <property name="SERVICE_NAME" value="option-common-service"/>
    
    <!-- BTSE标准日志格式 -->
    <property name="BTSE_PATTERN" 
              value="%d{yyyy-MM-dd'T'HH:mm:ss.SSSXXX} %level %property{PID} [%thread] [%logger{36}] [%X{call-id:-}] [%X{trace-id:-}] [%X{user-name:-}] [%X{IP-address:-}] [%X{error-code:-}] : %msg%n"/>
    
    <!-- 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${BTSE_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>
    
    <!-- 应用日志文件 -->
    <appender name="APPLICATION_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${SERVICE_NAME}-application.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${SERVICE_NAME}-application.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>${BTSE_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>
    
    <!-- 错误日志文件 -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${SERVICE_NAME}-error.log</file>
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>ERROR</level>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${SERVICE_NAME}-error.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>5GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>${BTSE_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>
    
    <!-- 访问日志文件 -->
    <appender name="ACCESS_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${SERVICE_NAME}-access.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${SERVICE_NAME}-access.%d{yyyy-MM-dd}.gz</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd'T'HH:mm:ss.SSSXXX} [%X{trace-id:-}] [%X{user-name:-}] [%X{IP-address:-}] %method %uri %status %responseTime %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>
    
    <!-- 异步日志提升性能 -->
    <appender name="ASYNC_APPLICATION" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="APPLICATION_FILE"/>
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <neverBlock>true</neverBlock>
    </appender>
    
    <appender name="ASYNC_ERROR" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="ERROR_FILE"/>
        <queueSize>256</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <neverBlock>true</neverBlock>
    </appender>
    
    <!-- 访问日志单独logger -->
    <logger name="ACCESS_LOG" level="INFO" additivity="false">
        <appender-ref ref="ACCESS_FILE"/>
    </logger>
    
    <!-- 环境配置 -->
    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
        <logger name="com.binaryoption" level="DEBUG"/>
    </springProfile>
    
    <springProfile name="staging,production">
        <root level="WARN">
            <appender-ref ref="ASYNC_APPLICATION"/>
            <appender-ref ref="ASYNC_ERROR"/>
        </root>
        <logger name="com.binaryoption" level="INFO"/>
    </springProfile>
</configuration>
```

#### 文件2-4: 其他服务的logback-spring.xml
复制上面的配置，只需修改`SERVICE_NAME`属性：
- `option-order-service/src/main/resources/logback-spring.xml` → `SERVICE_NAME = option-order-service`
- `option-market-service/src/main/resources/logback-spring.xml` → `SERVICE_NAME = option-market-service`  
- `option-gateway/src/main/resources/logback-spring.xml` → `SERVICE_NAME = option-gateway`

### 2.2 修改Docker配置（2个文件）

#### 文件5: `docker-compose.yml`
```yaml
services:
  option-gateway:
    # ... 现有配置 ...
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-staging}
      # 按BTSE规范配置GC日志
      - JAVA_OPTS=-Xms256m -Xmx512m -Xlog:gc*:file=/usr/local/btse/logs/gc.log:time,uptime,level,tags:filecount=5,filesize=10M
    volumes:
      # 按BTSE规范挂载日志目录
      - ./logs:/usr/local/btse/logs
      
  option-common-service:
    # ... 现有配置 ...
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-staging}
      - JAVA_OPTS=-Xms256m -Xmx512m -Xlog:gc*:file=/usr/local/btse/logs/gc.log:time,uptime,level,tags:filecount=5,filesize=10M
    volumes:
      - ./logs:/usr/local/btse/logs
      
  option-order-service:
    # ... 现有配置 ...
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-staging}
      - JAVA_OPTS=-Xms256m -Xmx512m -Xlog:gc*:file=/usr/local/btse/logs/gc.log:time,uptime,level,tags:filecount=5,filesize=10M
    volumes:
      - ./logs:/usr/local/btse/logs
      
  option-market-service:
    # ... 现有配置 ...
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-staging}
      - JAVA_OPTS=-Xms256m -Xmx512m -Xlog:gc*:file=/usr/local/btse/logs/gc.log:time,uptime,level,tags:filecount=5,filesize=10M
    volumes:
      - ./logs:/usr/local/btse/logs
```

#### 文件6: `docker-compose.production.yml`
```yaml
services:
  option-gateway:
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - JAVA_OPTS=-Xms512m -Xmx1024m -Xlog:gc*:file=/usr/local/btse/logs/gc.log:time,uptime,level,tags:filecount=10,filesize=10M
    volumes:
      # 生产环境使用专用日志目录
      - /data/logs/btse:/usr/local/btse/logs
      
  # 其他服务同样配置...
```

### 2.3 创建MDC上下文设置类（新增）

#### 文件7: `option-common-utils/src/main/java/com/binaryoption/common/logging/LoggingMDCFilter.java`
```java
package com.binaryoption.common.logging;

import org.slf4j.MDC;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.UUID;

/**
 * 按BTSE日志规范设置MDC上下文
 */
@Component
@Order(Ordered.HIGHEST_PRECEDENCE)
public class LoggingMDCFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain filterChain) 
            throws ServletException, IOException {
        
        try {
            // call-id: 每个请求唯一标识
            String callId = request.getHeader("X-Call-ID");
            if (callId == null) {
                callId = UUID.randomUUID().toString();
            }
            MDC.put("call-id", callId);
            
            // trace-id: 分布式追踪标识
            String traceId = request.getHeader("X-Trace-ID");
            if (traceId == null) {
                traceId = UUID.randomUUID().toString().replace("-", "");
            }
            MDC.put("trace-id", traceId);
            
            // user-name: 用户名（如果有认证）
            String userName = request.getHeader("X-User-Name");
            if (userName != null) {
                MDC.put("user-name", userName);
            }
            
            // IP-address: 客户端IP
            String ipAddress = getClientIpAddress(request);
            MDC.put("IP-address", ipAddress);
            
            // 添加到响应头用于客户端追踪
            response.setHeader("X-Call-ID", callId);
            response.setHeader("X-Trace-ID", traceId);
            
            filterChain.doFilter(request, response);
            
        } finally {
            // 清理MDC防止内存泄漏
            MDC.clear();
        }
    }
    
    private String getClientIpAddress(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null && !xForwardedFor.isEmpty()) {
            return xForwardedFor.split(",")[0].trim();
        }
        
        String xRealIp = request.getHeader("X-Real-IP");
        if (xRealIp != null && !xRealIp.isEmpty()) {
            return xRealIp;
        }
        
        return request.getRemoteAddr();
    }
}
```

#### 文件8: `option-common-utils/src/main/java/com/binaryoption/common/logging/AccessLogInterceptor.java`
```java
package com.binaryoption.common.logging;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * 访问日志拦截器，按BTSE规范记录访问日志
 */
@Component
public class AccessLogInterceptor implements HandlerInterceptor {
    
    private static final Logger ACCESS_LOGGER = LoggerFactory.getLogger("ACCESS_LOG");
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        request.setAttribute("startTime", System.currentTimeMillis());
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, 
                              Object handler, Exception ex) {
        
        long startTime = (Long) request.getAttribute("startTime");
        long responseTime = System.currentTimeMillis() - startTime;
        
        // 设置访问日志相关的MDC
        MDC.put("method", request.getMethod());
        MDC.put("uri", request.getRequestURI());
        MDC.put("status", String.valueOf(response.getStatus()));
        MDC.put("responseTime", responseTime + "ms");
        
        // 记录访问日志
        ACCESS_LOGGER.info("API Access: {} {} - Status: {} - Time: {}ms", 
                          request.getMethod(), 
                          request.getRequestURI(),
                          response.getStatus(),
                          responseTime);
    }
}
```

### 2.4 注册拦截器配置

#### 文件9: `option-common-utils/src/main/java/com/binaryoption/common/config/WebMvcConfig.java`
```java
package com.binaryoption.common.config;

import com.binaryoption.common.logging.AccessLogInterceptor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    
    @Autowired
    private AccessLogInterceptor accessLogInterceptor;
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(accessLogInterceptor)
                .addPathPatterns("/api/**")
                .addPathPatterns("/rpc/**");
    }
}
```

## 3. 实施步骤

### 步骤1：创建符合BTSE规范的日志目录
```bash
# 创建符合BTSE规范的日志路径
mkdir -p ./logs
# 模拟容器内的路径结构
# 容器内将映射为 /usr/local/btse/logs
chmod 755 ./logs
```

### 步骤2：添加logback配置和Java类
按照上面的文件列表创建所有配置文件和Java类

### 步骤3：修改docker-compose文件
更新日志路径挂载和GC日志配置

### 步骤4：重启服务
```bash
docker-compose down
docker-compose up -d
```

### 步骤5：验证BTSE规范符合性
```bash
# 检查日志文件命名是否符合规范
ls -la ./logs/
# 应该看到：
# option-gateway-application.log
# option-gateway-error.log  
# option-gateway-access.log
# option-common-service-application.log
# option-common-service-error.log
# option-common-service-access.log
# gc.log

# 检查日志格式是否符合BTSE规范
tail -f ./logs/option-gateway-application.log
# 应该看到类似：
# 2025-09-10T14:55:30.000+08:00 INFO 1234 [http-nio-8080-exec-1] [com.binaryoption.gateway.filter.AuthFilter] [abc-123-def] [trace-456-ghi] [admin] [192.168.1.100] [] : User authenticated successfully
```

## 4. 符合性检查清单

### ✅ 路径规范符合性
- [x] 使用 `/usr/local/btse/logs/` 作为微服务日志路径
- [x] 容器挂载映射正确

### ✅ 命名规范符合性  
- [x] 应用日志：`{service_name}-application.log`
- [x] 错误日志：`{service_name}-error.log`  
- [x] 访问日志：`{service_name}-access.log`
- [x] GC日志：`gc.log`

### ✅ 日志格式符合性
- [x] Timestamp: ISO 8601格式 `2024-03-11T14:55:30,000+00:00`
- [x] LogLevel: DEBUG, INFO, WARN, ERROR, FATAL
- [x] PID: 进程ID
- [x] thread: 线程标识符  
- [x] class: 源类或组件
- [x] call-id: 调用实例标识符
- [x] trace-id: 系统追踪标识符
- [x] user-name: 用户名（如适用）
- [x] IP-address: 请求来源IP（如适用）
- [x] error-code: 错误状态标识符
- [x] msg%n: 消息内容

### ✅ 多用途日志分离
- [x] 应用程序日志 (application)
- [x] 错误日志 (error)  
- [x] 访问日志 (access)
- [x] GC日志 (gc)

## 5. 与原简化方案的差异

| 对比项 | 简化版 | 符合规范版 |
|--------|--------|------------|
| 日志路径 | `/var/log/binaryoption/` | `/usr/local/btse/logs/` ✅ |
| 文件命名 | `option-gateway.log` | `option-gateway-application.log` ✅ |
| 日志格式 | 基础格式 | 完整BTSE格式包含所有必需字段 ✅ |
| 日志分类 | 单文件 | 分离application/error/access ✅ |
| 追踪支持 | 无 | 完整call-id/trace-id支持 ✅ |
| 工作量 | 2小时 | 4小时 |

现在这个方案完全符合BTSE日志规范的所有要求！