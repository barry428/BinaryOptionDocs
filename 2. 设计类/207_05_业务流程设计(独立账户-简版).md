# 二元期权平台业务流程设计（独立账户模式-简版）

## 1. 核心架构变更

### 1.1 主要变更
- **下单流程**：不再调用BTSE API，只使用本地账户余额
- **结算流程**：盈利资金直接到本地账户，不转回BTSE
- **新增账户划转功能**：用户主动进行BTSE ↔ Binary Option账户间资金划转

### 1.2 资金流向对比
**原流程（直接集成）**：
```
BTSE账户 ⇄ Binary Option冻结余额 → 结算时返回BTSE
```

**新流程（独立账户）**：
```
BTSE账户 → 账户划转 → Binary Option余额 → 下单冻结 → 结算解冻
```

## 2. 用户注册登录流程

### 2.1 流程说明
1. **BTSE认证**：验证用户BTSE Token
2. **用户同步**：获取BTSE用户信息，创建本地用户
3. **账户初始化**：自动创建DEMO和REAL独立账户（初始余额为0）
4. **JWT生成**：生成本地JWT Token用于后续请求

## 3. 账户划转流程

### 3.1 划转流程图

```mermaid
sequenceDiagram
    participant U as 用户
    participant C as Common-Service
    participant B as BTSE-API
    participant DB as Database

    Note over U,DB: FROM_BTSE充值流程
    U->>C: 划转请求(FROM_BTSE, 金额)
    C->>DB: 创建划转记录(PENDING)
    C->>B: 查询BTSE余额
    alt BTSE余额充足
        C->>B: 执行BTSE转出
        alt 转出成功
            C->>DB: 增加本地账户余额
            C->>DB: 更新状态为SUCCESS
            C->>U: 返回划转成功
        else 转出失败/超时
            C->>DB: 更新状态为FAILED/COMPENSATION
            C->>U: 返回失败/处理中
        end
    else 余额不足
        C->>DB: 更新状态为FAILED
        C->>U: 返回余额不足
    end

    Note over U,DB: TO_BTSE提现流程
    U->>C: 划转请求(TO_BTSE, 金额)
    C->>DB: 检查本地余额
    alt 本地余额充足
        C->>DB: 扣减本地账户余额
        C->>B: 执行BTSE转入
        alt 转入成功
            C->>DB: 更新状态为SUCCESS
            C->>U: 返回划转成功
        else 转入失败
            C->>DB: 回滚本地余额
            C->>U: 返回失败
        end
    else 余额不足
        C->>U: 返回余额不足
    end
```

### 3.2 关键特性
- **幂等性**：使用唯一ID防重复
- **重试机制**：API失败自动重试3次
- **补偿机制**：定时任务处理异常状态
- **状态追踪**：完整记录划转过程

## 4. 下单交易流程

### 4.1 流程图

```mermaid
sequenceDiagram
    participant U as 用户
    participant O as Order-Service
    participant C as Common-Service
    participant DB as Database

    U->>O: 下单请求
    O->>O: 风控校验
    alt 风控通过
        O->>C: 检查账户余额(本地)
        alt 余额充足
            O->>C: 冻结资金(balance → frozen_balance)
            O->>DB: 创建订单(状态:ACTIVE)
            O->>U: 下单成功
        else 余额不足
            O->>U: 下单失败(提示划转)
        end
    else 风控拦截
        O->>U: 下单失败
    end
```

### 4.2 流程说明
- **统一处理**：DEMO和REAL账户使用相同流程
- **无BTSE调用**：只使用本地账户余额
- **直接激活**：订单直接创建为ACTIVE状态

## 5. 自动结算流程

### 5.1 流程图

```mermaid
sequenceDiagram
    participant S as 调度任务
    participant O as Order-Service
    participant C as Common-Service
    participant DB as Database

    S->>O: 定时触发结算
    O->>DB: 查询待结算回合
    loop 每个回合
        O->>DB: 查询ACTIVE状态订单
        loop 每个订单
            O->>O: 计算盈亏
            alt 盈利(WIN)
                O->>C: 解冻+派奖到balance
                O->>C: 扣除手续费(10%)
            else 亏损(LOSE)
                O->>C: 扣除冻结资金
            else 平局(DRAW)
                O->>C: 退还冻结资金到balance
            end
            O->>DB: 更新订单状态
        end
    end
```

### 5.2 流程说明
- **统一处理**：DEMO和REAL账户结算流程相同
- **本地结算**：所有资金保留在本地账户
- **用户选择**：盈利后用户可选择提现到BTSE

## 6. 订单状态流转

```mermaid
stateDiagram-v2
    [*] --> ACTIVE : 下单成功(余额充足)
    ACTIVE --> CANCELLED : 撤单(锁单前)
    ACTIVE --> WIN : 结算盈利
    ACTIVE --> LOSE : 结算亏损  
    ACTIVE --> DRAW : 结算平局
    WIN --> [*]
    LOSE --> [*]
    DRAW --> [*]
    CANCELLED --> [*]
```

## 7. 用户资金管理

### 7.1 资金概览

```mermaid
graph TD
    A[用户资金总览] --> B[BTSE账户余额]
    A --> C[Binary Option账户余额]
    A --> D[冻结资金]
    
    A --> E[划转操作]
    E --> F[BTSE → Binary Option]
    E --> G[Binary Option → BTSE]
```

### 7.2 完整用户流程
1. **登录**: BTSE认证 → 创建本地账户
2. **充值**: BTSE → 账户划转 → Binary Option余额
3. **下单**: Binary Option余额 → 冻结余额
4. **结算**: 冻结余额 → Binary Option余额(盈利)/扣除(亏损)
5. **提现**: Binary Option余额 → 账户划转 → BTSE

## 8. 核心API接口

### 8.1 账户划转
```http
POST /api/account/transfer/from-btse
{
  "amount": "1000.0000000000000000",
  "accountType": "REAL"
}

POST /api/account/transfer/to-btse
{
  "amount": "500.0000000000000000", 
  "accountType": "REAL"
}

GET /api/account/transfer/history
```

### 8.2 账户余额
```http
GET /api/account/balance?accountType=REAL

GET /api/account/btse-balance
```

## 9. 架构优势

### 9.1 技术优势
- **性能提升**：下单无外部API调用，速度更快
- **可用性**：减少BTSE依赖，提高系统稳定性
- **维护性**：简化状态管理，降低复杂度

### 9.2 用户体验
- **快速下单**：无需等待BTSE确认
- **灵活资金**：用户可选择资金存放位置
- **即时可用**：盈利资金立即到账

### 9.3 风险控制
- **独立管理**：平台维护独立资金池
- **流动性控制**：更好的资金管控能力
- **故障隔离**：外部API故障不影响交易

---

**文档版本**: v2.0-简版  
**最后更新**: 2025年8月08日  
**主要变更**: 移除下单/结算中的BTSE API调用，新增独立的账户划转功能