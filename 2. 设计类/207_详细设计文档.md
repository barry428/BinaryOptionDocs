# äºŒå…ƒæœŸæƒå¹³å°è¯¦ç»†è®¾è®¡æ–‡æ¡£

| ç‰ˆæœ¬   | æ—¥æœŸ         | ä½œè€…    | è¯´æ˜                     |
|--------|--------------|---------|--------------------------|
| v1.0   | 2025å¹´7æœˆ18æ—¥ | Barry  | åˆç¨¿                     |
| v1.1   | 2025å¹´7æœˆ22æ—¥ | Barry | æ›´æ–°å®ç°çŠ¶æ€ï¼Œå®Œæˆæ•°æ®åº“å®ä½“æ˜ å°„ |
| v1.2   | 2025å¹´7æœˆ22æ—¥ | Barry | å®Œæˆç»Ÿä¸€å¼‚å¸¸å¤„ç†æ¡†æ¶å®ç° |
| v1.3   | 2025å¹´7æœˆ23æ—¥ | Barry | å®Œæˆå®‰å…¨é…ç½®ç»Ÿä¸€ï¼Œæ·»åŠ æƒé™æ³¨è§£ä½“ç³» |
| v1.4   | 2025å¹´7æœˆ23æ—¥ | Barry | é‡æ„ä¸ºGatewayä¿¡ä»»æ¨¡å¼å®‰å…¨æ¶æ„ |
| v1.5   | 2025å¹´7æœˆ24æ—¥ | Claude | æ–°å¢ç»Ÿä¸€ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œå®Œå–„ç³»ç»Ÿæ¶æ„ |

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºã€ŠäºŒå…ƒæœŸæƒå¹³å°äº§å“éœ€æ±‚æ–‡æ¡£(PRD)ã€‹ï¼Œè¯¦ç»†è®¾è®¡äºŒå…ƒæœŸæƒäº¤æ˜“å¹³å°çš„æŠ€æœ¯æ¶æ„ã€æ•°æ®æ¨¡å‹ã€APIæ¥å£å’Œä¸šåŠ¡æµç¨‹ã€‚

### 1.1 è®¾è®¡åŸåˆ™
- **å¾®æœåŠ¡æ¶æ„**ï¼šæŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†æœåŠ¡ï¼Œä¾¿äºç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
- **æ•°æ®å®‰å…¨**ï¼šå®ç›˜/æ¨¡æ‹Ÿè´¦æˆ·ä¸¥æ ¼éš”ç¦»ï¼Œé£æ§æ ¡éªŒå…¨è¦†ç›–
- **é«˜å¯ç”¨æ€§**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•ï¼Œå…³é”®æœåŠ¡å†—ä½™éƒ¨ç½²
- **å®æ—¶æ€§**ï¼šäº¤æ˜“ã€è¡Œæƒ…ã€ç»“ç®—ç­‰æ ¸å¿ƒæµç¨‹å®æ—¶å¤„ç†
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤šå¸ç§ã€å¤šå‘¨æœŸæ‰©å±•

### 1.2 æŠ€æœ¯æ ˆ
- **æ¡†æ¶**ï¼šSpring Boot 2.7.18, Spring Cloud Gateway
- **æ•°æ®è®¿é—®**ï¼šMyBatis 3.xï¼ˆæ›¿ä»£JPAï¼Œæä¾›æ›´å¥½çš„SQLæ§åˆ¶ï¼‰
- **æ•°æ®åº“**ï¼šMySQL 8.0, Redis 6.0
- **æœåŠ¡å‘ç°**ï¼šNacos
- **ä»»åŠ¡è°ƒåº¦**ï¼šXXL-Job
- **å¤–éƒ¨æ¥å£**ï¼šBTSE WebSocket API

### 1.3 å½“å‰å®ç°çŠ¶æ€
âœ… **å·²å®Œæˆ**ï¼š
- **å®Œæ•´çš„å¾®æœåŠ¡æ¶æ„**ï¼ˆ11ä¸ªæ¨¡å—ï¼‰ï¼š
  - option-common-serviceï¼ˆç”¨æˆ·è´¦æˆ·æœåŠ¡ï¼‰
  - option-order-serviceï¼ˆäº¤æ˜“è®¢å•æœåŠ¡ï¼‰
  - option-market-serviceï¼ˆè¡Œæƒ…æ•°æ®æœåŠ¡ï¼‰
  - option-admin-serviceï¼ˆåå°ç®¡ç†æœåŠ¡ï¼‰
  - option-gatewayï¼ˆAPIç½‘å…³æœåŠ¡ï¼‰
  - option-job-executorï¼ˆç»Ÿä¸€ä»»åŠ¡æ‰§è¡Œå™¨ï¼‰
  - option-security-baseï¼ˆå®‰å…¨æ¡†æ¶åŸºç¡€ï¼‰
  - option-common-utilsï¼ˆé€šç”¨å·¥å…·åº“ï¼‰
  - option-common-dtoï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰
  - option-parentï¼ˆMavençˆ¶é¡¹ç›®ï¼‰
  - option-xxl-jobï¼ˆä»»åŠ¡è°ƒåº¦æ¡†æ¶ï¼‰

- **å®Œæ•´çš„æ•°æ®åº“è®¾è®¡**ï¼ˆ17å¼ è¡¨ï¼ŒåŒ…å«ç´¢å¼•å’Œå…³ç³»ï¼‰
- **ç”Ÿäº§çº§å®‰å…¨æ¶æ„**ï¼š
  - JWTè®¤è¯ä¸æˆæƒä½“ç³»
  - åŸºäºè§’è‰²å’Œæƒé™çš„è®¿é—®æ§åˆ¶
  - Gatewayä¿¡ä»»æ¨¡å¼å®‰å…¨é…ç½®
  - Redisæƒé™ç¼“å­˜æœºåˆ¶
  - AOPåˆ‡é¢æƒé™éªŒè¯

- **ç»Ÿä¸€ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ**ï¼š
  - XXL-Jobé›†æˆçš„åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦
  - æ•°æ®æ¸…ç†ã€ç»Ÿè®¡èšåˆã€è®¢å•ç»“ç®—ç­‰9ä¸ªä»»åŠ¡å¤„ç†å™¨
  - ä»»åŠ¡ç›‘æ§å’Œæ—¥å¿—ç®¡ç†
  - å¤±è´¥é‡è¯•å’Œå‘Šè­¦æœºåˆ¶

- **å®Œæ•´çš„åŸºç¡€è®¾æ–½**ï¼š
  - Spring Cloudå¾®æœåŠ¡æ¶æ„
  - NacosæœåŠ¡å‘ç°å’Œé…ç½®ä¸­å¿ƒ
  - Redisé›†ç¾¤ç¼“å­˜
  - ç»Ÿä¸€å¼‚å¸¸å¤„ç†å’Œå›½é™…åŒ–æ”¯æŒ
  - ç”Ÿäº§çº§éƒ¨ç½²è„šæœ¬å’Œç›‘æ§

âœ… **ä¸šåŠ¡åŠŸèƒ½å®Œæˆåº¦**ï¼š
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€è´¦æˆ·ç®¡ç† âœ“
- è®¢å•åˆ›å»ºã€é£æ§æ ¡éªŒã€ç»“ç®— âœ“
- è¡Œæƒ…æ•°æ®é‡‡é›†ã€Kçº¿ç”Ÿæˆ âœ“
- åå°ç®¡ç†ã€æƒé™æ§åˆ¶ã€ç»Ÿè®¡æŠ¥è¡¨ âœ“
- å®šæ—¶ä»»åŠ¡è°ƒåº¦å’Œæ•°æ®ç»´æŠ¤ âœ“

ğŸ”„ **æŒç»­ä¼˜åŒ–**ï¼š
- WebSocketå®æ—¶æ¨é€ä¼˜åŒ–
- æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦å®Œå–„
- å‰ç«¯ç•Œé¢é›†æˆå’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        A[Webå‰ç«¯] --> B[ç§»åŠ¨ç«¯H5]
    end
    
    subgraph "ç½‘å…³å±‚"
        C[Spring Cloud Gateway]
    end
    
    subgraph "å¾®æœåŠ¡å±‚"
        D[option-common-service<br/>ç”¨æˆ·è´¦æˆ·æœåŠ¡]
        E[option-order-service<br/>äº¤æ˜“è®¢å•æœåŠ¡]
        F[option-market-service<br/>è¡Œæƒ…æœåŠ¡]
        G1[option-admin-service<br/>åå°ç®¡ç†æœåŠ¡]
        G2[MySQLæ•°æ®åº“]
        H[Redisç¼“å­˜]
        J[Nacosæ³¨å†Œä¸­å¿ƒ]
        L[BTSE API]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚"
        K[XXL-Jobè°ƒåº¦ä¸­å¿ƒ]
        G3[option-job-executor<br/>ç»Ÿä¸€ä»»åŠ¡æ‰§è¡Œå™¨]
    end
    
    A --> C
    B --> C
    C --> D
    C --> E
    C --> F
    C --> G1
    G3 --> D
    G3 --> E
    G3 --> F
    G3 --> G1
    K --> G3
    D --> G2
    E --> G2
    G1 --> G2
    D --> H
    E --> H
    G1 --> H
    D --> J
    E --> J
    F --> J
    G1 --> J
    F --> L
```

### 2.2 æœåŠ¡ç«¯å£é…ç½®

| æœåŠ¡æ¨¡å— | æœåŠ¡ç«¯å£ | é¢å¤–ç«¯å£ | ç”¨é€”è¯´æ˜ |
|---------|---------|----------|----------|
| option-gateway | 8080 | - | APIç½‘å…³ï¼Œç»Ÿä¸€å…¥å£ |
| option-common-service | 8081 | - | ç”¨æˆ·è´¦æˆ·æœåŠ¡ |
| option-order-service | 8082 | - | äº¤æ˜“è®¢å•æœåŠ¡ |
| option-market-service | 8083 | - | è¡Œæƒ…æ•°æ®æœåŠ¡ |
| option-admin-service | 8084 | - | åå°ç®¡ç†æœåŠ¡ |
| option-job-executor | 8085 | 10000 | ç»Ÿä¸€ä»»åŠ¡æ‰§è¡Œå™¨ (10000ä¸ºXXL-Jobå†…éƒ¨é€šä¿¡ç«¯å£) |
| XXL-Job Admin | 9090 | - | ä»»åŠ¡è°ƒåº¦ç®¡ç†ä¸­å¿ƒ |

### 2.3 æœåŠ¡èŒè´£åˆ’åˆ†

#### 2.3.1 option-common-service (ç”¨æˆ·è´¦æˆ·æœåŠ¡)
**èŒè´£**:
- ç”¨æˆ·ç®¡ç†ï¼šæ³¨å†Œã€ç™»å½•ã€ä¿¡æ¯ç»´æŠ¤
- è´¦æˆ·ç®¡ç†ï¼šå®ç›˜/æ¨¡æ‹Ÿè´¦æˆ·ã€ä½™é¢ç®¡ç†
- èµ„äº§ç®¡ç†ï¼šå……å€¼ã€æç°ã€è½¬è´¦è®°å½•
- åŸºç¡€é…ç½®ï¼šå¸ç§ç®¡ç†ã€å…¨å±€å‚æ•°

#### 2.3.2 option-order-service (äº¤æ˜“è®¢å•æœåŠ¡)  
**èŒè´£**:
- äº¤æ˜“ç®¡ç†ï¼šä¸‹å•ã€æ’¤å•ã€è®¢å•æŸ¥è¯¢
- å›åˆç®¡ç†ï¼šäº¤æ˜“å‘¨æœŸã€å€’è®¡æ—¶ã€é”å•
- é£æ§ç®¡ç†ï¼šé™é¢æ ¡éªŒã€é»‘åå•ã€é£æ§æ—¥å¿—
- ç»“ç®—å¼•æ“ï¼šè‡ªåŠ¨ç»“ç®—ã€ç›ˆäºè®¡ç®—ã€èµ„é‡‘åˆ’è½¬

#### 2.3.3 option-market-service (è¡Œæƒ…æœåŠ¡)
**èŒè´£**:
- è¡Œæƒ…æ¨é€ï¼šå®æ—¶ä»·æ ¼ã€Kçº¿æ•°æ®
- BTSEé›†æˆï¼šWebSocketè¿æ¥ç®¡ç†
- æ•°æ®ç¼“å­˜ï¼šä»·æ ¼å¿«ç…§ã€å†å²æ•°æ®

#### 2.3.4 option-admin-service (åå°ç®¡ç†æœåŠ¡)
**èŒè´£**:
- ç”¨æˆ·ç®¡ç†ï¼šç”¨æˆ·æŸ¥è¯¢ã€è´¦æˆ·ç®¡ç†ã€é»‘åå•ç®¡ç†
- äº¤æ˜“ç®¡ç†ï¼šè®¢å•ç›‘æ§ã€å›åˆç®¡ç†ã€ç»“ç®—ç®¡ç†
- é£æ§ç®¡ç†ï¼šé£æ§é…ç½®ã€é£æ§æ—¥å¿—ã€å®æ—¶ç›‘æ§
- ç³»ç»Ÿé…ç½®ï¼šå¸ç§ç®¡ç†ã€å‘¨æœŸé…ç½®ã€å…¨å±€å‚æ•°é…ç½®
- æ•°æ®ç»Ÿè®¡ï¼šä¸šåŠ¡ç»Ÿè®¡ã€è´¢åŠ¡æŠ¥è¡¨ã€ç³»ç»Ÿç›‘æ§

#### 2.3.5 option-job-executor (ç»Ÿä¸€ä»»åŠ¡æ‰§è¡Œå™¨) **[æ–°å¢]**
**èŒè´£**:
- ä»»åŠ¡è°ƒåº¦ï¼šåŸºäºXXL-Jobçš„åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡ç®¡ç†
- æ•°æ®ç»´æŠ¤ï¼šæ•°æ®æ¸…ç†ã€ç»Ÿè®¡èšåˆã€å®Œæ•´æ€§æ£€æŸ¥
- ä¸šåŠ¡è°ƒåº¦ï¼šè®¢å•ç»“ç®—ã€è¶…æ—¶å¤„ç†ã€ç³»ç»Ÿç›‘æ§
- æ—¥å¿—ç®¡ç†ï¼šä»»åŠ¡æ‰§è¡Œæ—¥å¿—ã€æ€§èƒ½ç›‘æ§ã€å¼‚å¸¸å‘Šè­¦

**æ ¸å¿ƒä»»åŠ¡å¤„ç†å™¨**:
- **å¸‚åœºæ•°æ®ç±»**: DataCleanupJobHandler, DataIntegrityJobHandler
- **ç»Ÿè®¡èšåˆç±»**: DailyStatsJobHandler, HourlyStatsJobHandler, StatsCleanupJobHandler  
- **è®¢å•å¤„ç†ç±»**: OrderSettlementJobHandler, OrderTimeoutJobHandler
- **ç³»ç»Ÿç»´æŠ¤ç±»**: HealthCheckJobHandler, LogCleanupJobHandler

**æŠ€æœ¯ç‰¹æ€§**:
- æ”¯æŒä»»åŠ¡å¤±è´¥é‡è¯•å’Œç›‘æ§å‘Šè­¦
- é€šè¿‡Feignå®¢æˆ·ç«¯è°ƒç”¨ä¸šåŠ¡æœåŠ¡æ¥å£
- ç»Ÿä¸€çš„ä»»åŠ¡æ‰§è¡Œæ—¥å¿—å’Œæ€§èƒ½ç»Ÿè®¡
- æ”¯æŒåŠ¨æ€ä»»åŠ¡é…ç½®å’Œå‚æ•°è°ƒæ•´

#### 2.3.6 option-gateway (APIç½‘å…³)
**èŒè´£**:
- è·¯ç”±è½¬å‘ï¼šè¯·æ±‚åˆ†å‘ã€è´Ÿè½½å‡è¡¡
- è®¤è¯é‰´æƒï¼šJWTéªŒè¯ã€ç”¨æˆ·èº«ä»½ä¼ é€’
- é™æµç†”æ–­ï¼šæ¥å£ä¿æŠ¤ã€å¼‚å¸¸å¤„ç†

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 option-common-service æ•°æ®è¡¨

#### 3.1.1 ç”¨æˆ·è¡¨ (user)
```sql
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `external_id` varchar(64) NOT NULL COMMENT 'å¤–éƒ¨ç”¨æˆ·ID(BTSEç”¨æˆ·ID)',
  `password` varchar(128) NOT NULL COMMENT 'å¯†ç (åŠ å¯†)',
  `nickname` varchar(64) DEFAULT NULL COMMENT 'æ˜µç§°',
  `email` varchar(128) DEFAULT NULL COMMENT 'é‚®ç®±',
  `phone` varchar(32) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT 'çŠ¶æ€(1:æ­£å¸¸ 2:ç¦ç”¨)',
  `signature` varchar(128) DEFAULT NULL COMMENT 'ä¸ªæ€§ç­¾å',
  `risk_agreement` tinyint NOT NULL DEFAULT '0' COMMENT 'é£é™©åè®®(0:æœªåŒæ„ 1:å·²åŒæ„)',
  `aml_agreement` tinyint NOT NULL DEFAULT '0' COMMENT 'AMLåè®®(0:æœªåŒæ„ 1:å·²åŒæ„)',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_external_id` (`external_id`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_phone` (`phone`)
) ENGINE=InnoDB COMMENT='ç”¨æˆ·è¡¨';
```

#### 3.1.2 è´¦æˆ·è¡¨ (account)
```sql
CREATE TABLE `account` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·ID',
  `account_type` varchar(16) NOT NULL COMMENT 'è´¦æˆ·ç±»å‹(REAL:å®ç›˜ DEMO:æ¨¡æ‹Ÿ)',
  `currency` varchar(8) NOT NULL DEFAULT 'USDT' COMMENT 'å¸ç§',
  `balance` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'å¯ç”¨ä½™é¢',
  `frozen_balance` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'å†»ç»“ä½™é¢',
  `total_deposit` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'ç´¯è®¡å……å€¼',
  `total_withdraw` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'ç´¯è®¡æç°',
  `total_profit` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'ç´¯è®¡ç›ˆåˆ©',
  `total_loss` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'ç´¯è®¡äºæŸ',
  `reset_count` int NOT NULL DEFAULT '0' COMMENT 'é‡ç½®æ¬¡æ•°(ä»…æ¨¡æ‹Ÿè´¦æˆ·)',
  `last_reset_time` datetime DEFAULT NULL COMMENT 'æœ€åé‡ç½®æ—¶é—´',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_type_currency` (`user_id`,`account_type`,`currency`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB COMMENT='è´¦æˆ·è¡¨';
```

#### 3.1.3 èµ„é‡‘æµæ°´è¡¨ (account_transaction)
```sql
CREATE TABLE `account_transaction` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·ID',
  `account_id` bigint NOT NULL COMMENT 'è´¦æˆ·ID',
  `type` varchar(16) NOT NULL COMMENT 'äº¤æ˜“ç±»å‹(DEPOSIT:å……å€¼ WITHDRAW:æç° CANCEL:æ’¤å• BET_WIN:æŠ•æ³¨ç›ˆåˆ© BET_LOSE:æŠ•æ³¨äºæŸ BET_DRAW:æŠ•æ³¨å¹³å±€ RESET:é‡ç½®)',
  `amount` decimal(32,16) NOT NULL COMMENT 'äº¤æ˜“é‡‘é¢',
  `balance_before` decimal(32,16) NOT NULL COMMENT 'äº¤æ˜“å‰ä½™é¢',
  `balance_after` decimal(32,16) NOT NULL COMMENT 'äº¤æ˜“åä½™é¢',
  `ref_id` bigint DEFAULT NULL COMMENT 'å…³è”ID(è®¢å•IDç­‰)',
  `ref_type` varchar(16) DEFAULT NULL COMMENT 'å…³è”ç±»å‹(ORDERç­‰)',
  `remark` varchar(255) DEFAULT NULL COMMENT 'å¤‡æ³¨',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_account` (`user_id`,`account_id`),
  KEY `idx_ref` (`ref_id`,`ref_type`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB COMMENT='èµ„é‡‘æµæ°´è¡¨';
```

#### 3.1.4 å¸ç§é…ç½®è¡¨ (symbol_config)
```sql
CREATE TABLE `symbol_config` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `symbol` varchar(16) NOT NULL COMMENT 'äº¤æ˜“å¯¹(å¦‚BTC/USDT)',
  `base_currency` varchar(8) NOT NULL COMMENT 'åŸºç¡€å¸ç§(BTC)',
  `quote_currency` varchar(8) NOT NULL COMMENT 'è®¡ä»·å¸ç§(USDT)',
  `enabled` tinyint NOT NULL DEFAULT '1' COMMENT 'æ˜¯å¦å¯ç”¨(0:ç¦ç”¨ 1:å¯ç”¨)',
  `min_amount` decimal(32,16) NOT NULL DEFAULT '10.0000000000000000' COMMENT 'æœ€å°ä¸‹æ³¨é‡‘é¢',
  `max_amount` decimal(32,16) NOT NULL DEFAULT '10000.0000000000000000' COMMENT 'æœ€å¤§ä¸‹æ³¨é‡‘é¢',
  `btse_symbol` varchar(32) NOT NULL COMMENT 'BTSEäº¤æ˜“å¯¹åç§°',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT 'æ’åº',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_symbol` (`symbol`)
) ENGINE=InnoDB COMMENT='å¸ç§é…ç½®è¡¨';
```

### 3.2 option-order-service æ•°æ®è¡¨

#### 3.2.1 å‘¨æœŸé…ç½®è¡¨ (duration_config)
```sql
CREATE TABLE `duration_config` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `duration_minutes` int NOT NULL COMMENT 'å‘¨æœŸæ—¶é•¿(åˆ†é’Ÿ)',
  `duration_name` varchar(32) NOT NULL COMMENT 'å‘¨æœŸåç§°(å¦‚5åˆ†é’Ÿ)',
  `enabled` tinyint NOT NULL DEFAULT '1' COMMENT 'æ˜¯å¦å¯ç”¨(0:ç¦ç”¨ 1:å¯ç”¨)',
  `lock_seconds` int NOT NULL DEFAULT '30' COMMENT 'é”å•æ—¶é—´(ç§’)',
  `base_odds` decimal(10,4) NOT NULL DEFAULT '1.9000' COMMENT 'åŸºç¡€èµ”ç‡',
  `fee_rate` decimal(6,4) NOT NULL DEFAULT '0.1000' COMMENT 'æ‰‹ç»­è´¹ç‡(0.1è¡¨ç¤º10%)',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT 'æ’åº',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_duration` (`duration_minutes`)
) ENGINE=InnoDB COMMENT='å‘¨æœŸé…ç½®è¡¨';
```

#### 3.2.2 äº¤æ˜“å›åˆè¡¨ (trading_round)
```sql
CREATE TABLE `trading_round` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `round_no` varchar(64) NOT NULL COMMENT 'å›åˆç¼–å·',
  `symbol_id` bigint NOT NULL COMMENT 'äº¤æ˜“å¯¹ID',
  `duration_minutes` int NOT NULL COMMENT 'å‘¨æœŸæ—¶é•¿(åˆ†é’Ÿ)',
  `start_time` datetime NOT NULL COMMENT 'å¼€å§‹æ—¶é—´',
  `lock_time` datetime NOT NULL COMMENT 'é”å•æ—¶é—´(ç»“æŸå‰30ç§’)',
  `end_time` datetime NOT NULL COMMENT 'ç»“æŸæ—¶é—´',
  `start_price` decimal(32,16) DEFAULT NULL COMMENT 'å¼€ç›˜ä»·',
  `end_price` decimal(32,16) DEFAULT NULL COMMENT 'æ”¶ç›˜ä»·',
  `status` varchar(16) NOT NULL DEFAULT 'OPEN' COMMENT 'çŠ¶æ€(OPEN:å¼€æ”¾ LOCKED:é”å• SETTLED:å·²ç»“ç®—)',
  `total_up_amount` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'UPæ€»æŠ•æ³¨é¢',
  `total_down_amount` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'DOWNæ€»æŠ•æ³¨é¢',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_round_no` (`round_no`),
  KEY `idx_symbol_time` (`symbol_id`,`start_time`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB COMMENT='äº¤æ˜“å›åˆè¡¨';
```

#### 3.2.3 è®¢å•è¡¨ (option_order)
```sql
CREATE TABLE `option_order` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·ID',
  `account_type` varchar(16) NOT NULL COMMENT 'è´¦æˆ·ç±»å‹(REAL:å®ç›˜ DEMO:æ¨¡æ‹Ÿ)',
  `symbol_id` bigint NOT NULL COMMENT 'äº¤æ˜“å¯¹ID',
  `round_id` bigint NOT NULL COMMENT 'å›åˆID',
  `round_no` varchar(64) NOT NULL COMMENT 'å›åˆç¼–å·',
  `direction` varchar(8) NOT NULL COMMENT 'æ–¹å‘(UP:çœ‹æ¶¨ DOWN:çœ‹è·Œ)',
  `amount` decimal(32,16) NOT NULL COMMENT 'æŠ•æ³¨é‡‘é¢',
  `odds` decimal(10,4) NOT NULL COMMENT 'èµ”ç‡',
  `expected_profit` decimal(32,16) NOT NULL COMMENT 'é¢„æœŸæ”¶ç›Š',
  `order_price` decimal(32,16) NOT NULL COMMENT 'ä¸‹å•ä»·æ ¼',
  `settle_price` decimal(32,16) DEFAULT NULL COMMENT 'ç»“ç®—ä»·æ ¼',
  `status` varchar(16) NOT NULL DEFAULT 'PENDING' COMMENT 'çŠ¶æ€(PENDING:è¿›è¡Œä¸­ WIN:ç›ˆåˆ© LOSE:äºæŸ DRAW:å¹³å±€ CANCELLED:å·²æ’¤é”€)',
  `profit` decimal(32,16) DEFAULT NULL COMMENT 'å®é™…ç›ˆäº',
  `fee` decimal(32,16) DEFAULT NULL COMMENT 'æ‰‹ç»­è´¹',
  `cancel_time` datetime DEFAULT NULL COMMENT 'æ’¤é”€æ—¶é—´',
  `settle_time` datetime DEFAULT NULL COMMENT 'ç»“ç®—æ—¶é—´',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_symbol_round` (`user_id`,`symbol_id`,`round_id`),
  KEY `idx_round_status` (`round_id`,`status`),
  KEY `idx_user_create_time` (`user_id`,`create_time`)
) ENGINE=InnoDB COMMENT='è®¢å•è¡¨';
```

#### 3.2.4 é£æ§é…ç½®è¡¨ (risk_config)
```sql
CREATE TABLE `risk_config` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `config_key` varchar(64) NOT NULL COMMENT 'é…ç½®é”®',
  `config_value` varchar(255) NOT NULL COMMENT 'é…ç½®å€¼',
  `config_type` varchar(16) NOT NULL COMMENT 'é…ç½®ç±»å‹(LIMIT:é™é¢ BLACKLIST:é»‘åå• GLOBAL:å…¨å±€)',
  `description` varchar(255) DEFAULT NULL COMMENT 'æè¿°',
  `enabled` tinyint NOT NULL DEFAULT '1' COMMENT 'æ˜¯å¦å¯ç”¨',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`)
) ENGINE=InnoDB COMMENT='é£æ§é…ç½®è¡¨';
```

#### 3.2.5 é£æ§æ—¥å¿—è¡¨ (risk_log)
```sql
CREATE TABLE `risk_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·ID',
  `risk_type` varchar(32) NOT NULL COMMENT 'é£æ§ç±»å‹(AMOUNT_LIMIT:é‡‘é¢é™åˆ¶ FREQUENCY_LIMIT:é¢‘æ¬¡é™åˆ¶ BLACKLIST:é»‘åå•)',
  `risk_level` varchar(16) NOT NULL COMMENT 'é£é™©çº§åˆ«(LOW:ä½ MEDIUM:ä¸­ HIGH:é«˜)',
  `action` varchar(32) NOT NULL COMMENT 'å¤„ç†åŠ¨ä½œ(BLOCK:é˜»æ–­ WARN:è­¦å‘Š LOG:è®°å½•)',
  `description` varchar(500) NOT NULL COMMENT 'è¯¦ç»†æè¿°',
  `request_data` text COMMENT 'è¯·æ±‚æ•°æ®',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_time` (`user_id`,`create_time`),
  KEY `idx_risk_type` (`risk_type`)
) ENGINE=InnoDB COMMENT='é£æ§æ—¥å¿—è¡¨';
```

### 3.3 option-admin-service æ•°æ®è¡¨

#### 3.3.1 é»‘åå•è¡¨ (blacklist)
```sql
CREATE TABLE `blacklist` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·ID',
  `reason` varchar(255) NOT NULL COMMENT 'åŠ å…¥é»‘åå•åŸå› ',
  `operator_id` bigint NOT NULL COMMENT 'æ“ä½œå‘˜ID',
  `operator_name` varchar(64) NOT NULL COMMENT 'æ“ä½œå‘˜å§“å',
  `start_time` datetime NOT NULL COMMENT 'ç”Ÿæ•ˆæ—¶é—´',
  `end_time` datetime DEFAULT NULL COMMENT 'å¤±æ•ˆæ—¶é—´(NULLè¡¨ç¤ºæ°¸ä¹…)',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT 'çŠ¶æ€(1:ç”Ÿæ•ˆ 0:å¤±æ•ˆ)',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status_time` (`status`,`start_time`,`end_time`)
) ENGINE=InnoDB COMMENT='é»‘åå•è¡¨';
```

#### 3.3.2 ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨ (admin_operation_log)
```sql
CREATE TABLE `admin_operation_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `operator_id` bigint NOT NULL COMMENT 'æ“ä½œå‘˜ID',
  `operator_name` varchar(64) NOT NULL COMMENT 'æ“ä½œå‘˜å§“å',
  `operation_type` varchar(32) NOT NULL COMMENT 'æ“ä½œç±»å‹(USER_UPDATE:ç”¨æˆ·æ›´æ–° CONFIG_UPDATE:é…ç½®æ›´æ–°ç­‰)',
  `operation_desc` varchar(255) NOT NULL COMMENT 'æ“ä½œæè¿°',
  `target_type` varchar(32) DEFAULT NULL COMMENT 'ç›®æ ‡ç±»å‹(USER:ç”¨æˆ· CONFIG:é…ç½®ç­‰)',
  `target_id` varchar(64) DEFAULT NULL COMMENT 'ç›®æ ‡ID',
  `before_data` text COMMENT 'æ“ä½œå‰æ•°æ®',
  `after_data` text COMMENT 'æ“ä½œåæ•°æ®',
  `ip_address` varchar(64) DEFAULT NULL COMMENT 'æ“ä½œIP',
  `user_agent` varchar(255) DEFAULT NULL COMMENT 'ç”¨æˆ·ä»£ç†',
  `result` tinyint NOT NULL DEFAULT '1' COMMENT 'æ“ä½œç»“æœ(1:æˆåŠŸ 0:å¤±è´¥)',
  `error_msg` varchar(500) DEFAULT NULL COMMENT 'é”™è¯¯ä¿¡æ¯',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_operator_time` (`operator_id`,`create_time`),
  KEY `idx_operation_type` (`operation_type`),
  KEY `idx_target` (`target_type`,`target_id`)
) ENGINE=InnoDB COMMENT='ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨';
```

#### 3.3.3 å…¨å±€é…ç½®è¡¨ (global_config)
```sql
CREATE TABLE `global_config` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `config_key` varchar(64) NOT NULL COMMENT 'é…ç½®é”®',
  `config_value` text NOT NULL COMMENT 'é…ç½®å€¼',
  `config_type` varchar(16) NOT NULL COMMENT 'é…ç½®ç±»å‹(STRING:å­—ç¬¦ä¸² NUMBER:æ•°å­— BOOLEAN:å¸ƒå°” JSON:JSONå¯¹è±¡)',
  `config_group` varchar(32) NOT NULL COMMENT 'é…ç½®åˆ†ç»„(SYSTEM:ç³»ç»Ÿ BUSINESS:ä¸šåŠ¡ UI:ç•Œé¢)',
  `description` varchar(255) DEFAULT NULL COMMENT 'é…ç½®æè¿°',
  `enabled` tinyint NOT NULL DEFAULT '1' COMMENT 'æ˜¯å¦å¯ç”¨',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT 'æ’åº',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`),
  KEY `idx_config_group` (`config_group`)
) ENGINE=InnoDB COMMENT='å…¨å±€é…ç½®è¡¨';
```

#### 3.3.4 æ¯æ—¥ç»Ÿè®¡è¡¨ (daily_stats)
```sql
CREATE TABLE `daily_stats` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `stat_date` date NOT NULL COMMENT 'ç»Ÿè®¡æ—¥æœŸ',
  `symbol_id` bigint DEFAULT NULL COMMENT 'äº¤æ˜“å¯¹ID(NULLè¡¨ç¤ºå…¨éƒ¨)',
  `total_users` int NOT NULL DEFAULT '0' COMMENT 'æ€»ç”¨æˆ·æ•°',
  `active_users` int NOT NULL DEFAULT '0' COMMENT 'æ´»è·ƒç”¨æˆ·æ•°',
  `new_users` int NOT NULL DEFAULT '0' COMMENT 'æ–°å¢ç”¨æˆ·æ•°',
  `total_orders` int NOT NULL DEFAULT '0' COMMENT 'è®¢å•æ€»æ•°',
  `pending_orders` int NOT NULL DEFAULT '0' COMMENT 'è¿›è¡Œä¸­è®¢å•æ•°',
  `win_orders` int NOT NULL DEFAULT '0' COMMENT 'ç›ˆåˆ©è®¢å•æ•°',
  `lose_orders` int NOT NULL DEFAULT '0' COMMENT 'äºæŸè®¢å•æ•°',
  `draw_orders` int NOT NULL DEFAULT '0' COMMENT 'å¹³å±€è®¢å•æ•°',
  `total_volume` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'äº¤æ˜“æ€»é‡',
  `total_profit` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'ç”¨æˆ·æ€»ç›ˆåˆ©',
  `total_loss` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'ç”¨æˆ·æ€»äºæŸ',
  `total_fee` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'å¹³å°æ‰‹ç»­è´¹æ”¶å…¥',
  `win_rate` decimal(5,4) NOT NULL DEFAULT '0.0000' COMMENT 'èƒœç‡',
  `avg_order_amount` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'å¹³å‡ä¸‹å•é‡‘é¢',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_date_symbol` (`stat_date`, `symbol_id`),
  KEY `idx_stat_date` (`stat_date`)
) ENGINE=InnoDB COMMENT='æ¯æ—¥ç»Ÿè®¡è¡¨';
```

#### 3.3.5 æ¯å°æ—¶ç»Ÿè®¡è¡¨ (hourly_stats)
```sql
CREATE TABLE `hourly_stats` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `stat_datetime` datetime NOT NULL COMMENT 'ç»Ÿè®¡æ—¶é—´(ç²¾ç¡®åˆ°å°æ—¶)',
  `symbol_id` bigint DEFAULT NULL COMMENT 'äº¤æ˜“å¯¹ID(NULLè¡¨ç¤ºå…¨éƒ¨)',
  `active_users` int NOT NULL DEFAULT '0' COMMENT 'æ´»è·ƒç”¨æˆ·æ•°',
  `total_orders` int NOT NULL DEFAULT '0' COMMENT 'è®¢å•æ€»æ•°',
  `total_volume` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'äº¤æ˜“æ€»é‡',
  `total_profit` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'ç”¨æˆ·æ€»ç›ˆåˆ©',
  `total_loss` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'ç”¨æˆ·æ€»äºæŸ',
  `total_fee` decimal(32,16) NOT NULL DEFAULT '0.0000000000000000' COMMENT 'å¹³å°æ‰‹ç»­è´¹æ”¶å…¥',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_datetime_symbol` (`stat_datetime`, `symbol_id`),
  KEY `idx_stat_datetime` (`stat_datetime`)
) ENGINE=InnoDB COMMENT='æ¯å°æ—¶ç»Ÿè®¡è¡¨';
```

## 4. APIæ¥å£è®¾è®¡

### 4.0 ç»Ÿä¸€å¼‚å¸¸å¤„ç†ä¸å“åº”æ ¼å¼ âœ…

#### 4.0.1 ç»Ÿä¸€å“åº”æ ¼å¼
æ‰€æœ‰APIæ¥å£ç»Ÿä¸€ä½¿ç”¨`ApiResponse<T>`æ³›å‹å“åº”æ ¼å¼ï¼š

```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ApiResponse<T> {
    private Integer code;        // å“åº”ç 
    private String message;      // å“åº”æ¶ˆæ¯
    private T data;             // å“åº”æ•°æ®ï¼ˆæ³›å‹ï¼‰
    @Builder.Default
    private LocalDateTime timestamp = LocalDateTime.now(); // å“åº”æ—¶é—´
    
    // æˆåŠŸå“åº”
    public static <T> ApiResponse<T> success(T data) {
        return ApiResponse.<T>builder()
                .code(200)
                .message("success")
                .data(data)
                .build();
    }
    
    public static <T> ApiResponse<T> success(T data, String message) {
        return ApiResponse.<T>builder()
                .code(200)
                .message(message)
                .data(data)
                .build();
    }
    
    // é”™è¯¯å“åº”
    public static <T> ApiResponse<T> error(Integer code, String message) {
        return ApiResponse.<T>builder()
                .code(code)
                .message(message)
                .build();
    }
}
```

#### 4.0.2 ä¸šåŠ¡å¼‚å¸¸ç±»
ç»Ÿä¸€çš„ä¸šåŠ¡å¼‚å¸¸å¤„ç†ï¼š

```java
@Getter
public class BusinessException extends RuntimeException {
    private final Integer code;
    
    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
    }
    
    // å¸¸ç”¨å¿«æ·æ–¹æ³•
    public static BusinessException notFound(String message) {
        return new BusinessException(404, message);
    }
    
    public static BusinessException badRequest(String message) {
        return new BusinessException(400, message);
    }
    
    public static BusinessException forbidden(String message) {
        return new BusinessException(403, message);
    }
}
```

#### 4.0.3 å…¨å±€å¼‚å¸¸å¤„ç†å™¨
æ¯ä¸ªæœåŠ¡ç»§æ‰¿ç»Ÿä¸€çš„`GlobalExceptionHandler`ï¼š

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    // ä¸šåŠ¡å¼‚å¸¸å¤„ç†
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Void>> handleBusinessException(BusinessException e) {
        log.warn("Business exception: [{}] {}", e.getCode(), e.getMessage());
        ApiResponse<Void> response = ApiResponse.error(e.getCode(), e.getMessage());
        return ResponseEntity.ok(response);
    }
    
    // å‚æ•°éªŒè¯å¼‚å¸¸
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<Map<String, String>>> handleValidationException(
            MethodArgumentNotValidException e) {
        Map<String, String> errors = new HashMap<>();
        e.getBindingResult().getAllErrors().forEach(error -> {
            String fieldName = ((FieldError) error).getField();
            String errorMessage = error.getDefaultMessage();
            errors.put(fieldName, errorMessage);
        });
        
        ApiResponse<Map<String, String>> response = ApiResponse.<Map<String, String>>builder()
                .code(400)
                .message("å‚æ•°éªŒè¯å¤±è´¥")
                .data(errors)
                .build();
        
        return ResponseEntity.badRequest().body(response);
    }
    
    // å…¶ä»–ç³»ç»Ÿå¼‚å¸¸
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Void>> handleGenericException(Exception e) {
        log.error("Unexpected error occurred", e);
        ApiResponse<Void> response = ApiResponse.serverError("ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
        return ResponseEntity.status(500).body(response);
    }
}
```

#### 4.0.4 å“åº”ç è§„èŒƒ
| å“åº”ç  | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| 200 | æˆåŠŸ | æ­£å¸¸ä¸šåŠ¡å¤„ç†æˆåŠŸ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ | å‚æ•°éªŒè¯å¤±è´¥ã€æ ¼å¼é”™è¯¯ |
| 401 | æœªè®¤è¯ | ç”¨æˆ·æœªç™»å½•ã€Tokenæ— æ•ˆ |
| 403 | æƒé™ä¸è¶³ | ç”¨æˆ·æƒé™ä¸å¤Ÿã€æ“ä½œè¢«ç¦æ­¢ |
| 404 | èµ„æºä¸å­˜åœ¨ | ç”¨æˆ·ä¸å­˜åœ¨ã€è®¢å•ä¸å­˜åœ¨ |
| 405 | æ–¹æ³•ä¸æ”¯æŒ | HTTPæ–¹æ³•é”™è¯¯ |
| 409 | ä¸šåŠ¡å†²çª | ç”¨æˆ·å·²å­˜åœ¨ã€é‡å¤æ“ä½œ |
| 500 | ç³»ç»Ÿé”™è¯¯ | æœåŠ¡å†…éƒ¨å¼‚å¸¸ã€æ•°æ®åº“è¿æ¥å¼‚å¸¸ |

#### 4.0.5 æˆåŠŸå“åº”ç¤ºä¾‹
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "username": "test_user",
    "email": "test@example.com"
  },
  "timestamp": "2025-07-22T10:30:45"
}
```

#### 4.0.6 é”™è¯¯å“åº”ç¤ºä¾‹
```json
{
  "code": 404,
  "message": "ç”¨æˆ·ä¸å­˜åœ¨",
  "data": null,
  "timestamp": "2025-07-22T10:30:45"
}
```

#### 4.0.7 å‚æ•°éªŒè¯é”™è¯¯å“åº”ç¤ºä¾‹
```json
{
  "code": 400,
  "message": "å‚æ•°éªŒè¯å¤±è´¥",
  "data": {
    "username": "ç”¨æˆ·åä¸èƒ½ä¸ºç©º",
    "email": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
  },
  "timestamp": "2025-07-22T10:30:45"
}
```

### 4.1 option-common-service æ¥å£

#### 4.1.1 ç”¨æˆ·ç®¡ç†æ¥å£

```http
# åˆ›å»ºç”¨æˆ·
POST /user
Content-Type: application/json
{
  "externalId": "btse_user_123",
  "nickname": "ç”¨æˆ·æ˜µç§°",
  "email": "user@example.com",
  "phone": "+8613800138000",
  "password": "password123"
}

# è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ (Gatewayä¿¡ä»»æ¨¡å¼)
GET /user/me
X-User-Id: 1
X-User-Name: testuser

# åŒæ„é£é™©åè®®
POST /user/agreement
{
  "riskAgreement": true,
  "amlAgreement": true
}
```

#### 4.1.2 è´¦æˆ·ç®¡ç†æ¥å£

```http
# è·å–è´¦æˆ·åˆ—è¡¨ (Gatewayä¿¡ä»»æ¨¡å¼)
GET /account/list?accountType=REAL
X-User-Id: 1
X-User-Name: testuser

# è·å–è´¦æˆ·ä½™é¢ (Gatewayä¿¡ä»»æ¨¡å¼)
GET /account/balance?accountType=REAL&currency=USDT
X-User-Id: 1
X-User-Name: testuser

# é‡ç½®æ¨¡æ‹Ÿè´¦æˆ·
POST /account/reset
{
  "accountType": "DEMO",
  "currency": "USDT"
}

# è·å–èµ„é‡‘æµæ°´ (Gatewayä¿¡ä»»æ¨¡å¼)
GET /account/transactions?page=1&size=20&type=BET
X-User-Id: 1
X-User-Name: testuser
```

### 4.2 option-order-service æ¥å£

#### 4.2.1 äº¤æ˜“æ¥å£

```http
# è·å–å½“å‰å›åˆä¿¡æ¯
GET /trading/rounds/current?symbolId=1&duration=5

# ä¸‹å• (Gatewayä¿¡ä»»æ¨¡å¼)
POST /order/place
X-User-Id: 1
X-User-Name: testuser
{
  "symbolId": 1,
  "accountType": "REAL", 
  "direction": "UP",
  "amount": "100.0000000000000000"
}

# æ’¤å• (Gatewayä¿¡ä»»æ¨¡å¼)
POST /order/cancel/{orderId}
X-User-Id: 1
X-User-Name: testuser

# è·å–æˆ‘çš„è®¢å• (Gatewayä¿¡ä»»æ¨¡å¼)
GET /order/my?status=PENDING&page=1&size=20
X-User-Id: 1
X-User-Name: testuser

# è·å–è®¢å•è¯¦æƒ… (Gatewayä¿¡ä»»æ¨¡å¼)
GET /order/{orderId}
X-User-Id: 1
X-User-Name: testuser
```

#### 4.2.2 é£æ§æ¥å£

```http
# é£æ§æ ¡éªŒ
POST /risk/check
{
  "userId": 123,
  "action": "PLACE_ORDER",
  "amount": "1000.0000000000000000",
  "accountType": "REAL"
}

# è·å–é£æ§æ—¥å¿— (Gatewayä¿¡ä»»æ¨¡å¼)
GET /risk/logs?userId=123&page=1&size=20
X-User-Id: 1
X-User-Name: testuser
```

### 4.3 option-admin-service æ¥å£

#### 4.3.1 ç”¨æˆ·ç®¡ç†æ¥å£

```http
# è·å–ç”¨æˆ·åˆ—è¡¨ (éœ€è¦JWTè®¤è¯)
GET /admin/users?page=1&size=20&status=1&keyword=test
Authorization: Bearer {jwt_token}

# è·å–ç”¨æˆ·è¯¦æƒ… (éœ€è¦JWTè®¤è¯)
GET /admin/users/{userId}
Authorization: Bearer {jwt_token}

# æ›´æ–°ç”¨æˆ·çŠ¶æ€
PUT /admin/users/{userId}/status
{
  "status": 2,  // 1:æ­£å¸¸ 2:ç¦ç”¨
  "reason": "è¿è§„æ“ä½œ"
}

# è·å–ç”¨æˆ·è´¦æˆ·ä¿¡æ¯
GET /admin/users/{userId}/accounts

# è·å–ç”¨æˆ·èµ„é‡‘æµæ°´
GET /admin/users/{userId}/transactions?page=1&size=20
```

#### 4.3.2 äº¤æ˜“ç®¡ç†æ¥å£

```http
# è·å–è®¢å•åˆ—è¡¨
GET /admin/orders?page=1&size=20&status=PENDING&symbolId=1

# è·å–è®¢å•è¯¦æƒ…
GET /admin/orders/{orderId}

# è·å–å›åˆåˆ—è¡¨
GET /admin/rounds?page=1&size=20&status=OPEN&symbolId=1

# è·å–å›åˆè¯¦æƒ…
GET /admin/rounds/{roundId}

# æ‰‹åŠ¨ç»“ç®—å›åˆ(ç´§æ€¥æƒ…å†µ)
POST /admin/rounds/{roundId}/settle
{
  "settlePrice": "45000.12345678",
  "reason": "ç´§æ€¥å¤„ç†"
}
```

#### 4.3.3 é£æ§ç®¡ç†æ¥å£

```http
# è·å–é£æ§é…ç½®
GET /admin/risk/configs

# æ›´æ–°é£æ§é…ç½®
PUT /admin/risk/configs/{configKey}
{
  "configValue": "10000",
  "enabled": true
}

# è·å–é£æ§æ—¥å¿—
GET /admin/risk/logs?page=1&size=20&riskType=AMOUNT_LIMIT

# é»‘åå•ç®¡ç†
GET /admin/risk/blacklist?page=1&size=20
POST /admin/risk/blacklist
{
  "userId": 123,
  "reason": "å¼‚å¸¸äº¤æ˜“è¡Œä¸º",
  "duration": 7  // å¤©æ•°ï¼Œ0è¡¨ç¤ºæ°¸ä¹…
}
```

#### 4.3.4 ç³»ç»Ÿé…ç½®æ¥å£

```http
# å¸ç§é…ç½®ç®¡ç†
GET /admin/configs/symbols
PUT /admin/configs/symbols/{symbolId}
{
  "enabled": true,
  "minAmount": "10.0000000000000000",
  "maxAmount": "10000.0000000000000000"
}

# å‘¨æœŸé…ç½®ç®¡ç†
GET /admin/configs/durations
PUT /admin/configs/durations/{durationId}
{
  "enabled": true,
  "lockSeconds": 30
}

# å…¨å±€é…ç½®ç®¡ç†
GET /admin/configs/global
PUT /admin/configs/global/{configKey}
{
  "configValue": "value",
  "description": "é…ç½®è¯´æ˜"
}
```

#### 4.3.5 æ•°æ®ç»Ÿè®¡æ¥å£

```http
# ä¸šåŠ¡æ¦‚è§ˆç»Ÿè®¡
GET /admin/stats/overview?startDate=2025-07-01&endDate=2025-07-18

# äº¤æ˜“ç»Ÿè®¡
GET /admin/stats/trading?startDate=2025-07-01&endDate=2025-07-18&symbolId=1

# ç”¨æˆ·ç»Ÿè®¡
GET /admin/stats/users?startDate=2025-07-01&endDate=2025-07-18

# è´¢åŠ¡ç»Ÿè®¡
GET /admin/stats/finance?startDate=2025-07-01&endDate=2025-07-18

# å®æ—¶ç›‘æ§æ•°æ®
GET /admin/monitor/realtime
```

## 5. ä¸šåŠ¡æµç¨‹è®¾è®¡

### 5.1 ç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant G as Gateway
    participant C as Common-Service
    participant DB as Database

    U->>G: æ³¨å†Œè¯·æ±‚
    G->>C: è½¬å‘æ³¨å†Œè¯·æ±‚
    C->>DB: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    alt ç”¨æˆ·ä¸å­˜åœ¨
        C->>DB: åˆ›å»ºç”¨æˆ·è®°å½•
        C->>DB: åˆ›å»ºé»˜è®¤è´¦æˆ·(å®ç›˜+æ¨¡æ‹Ÿ)
        C->>G: è¿”å›æˆåŠŸ
        G->>U: æ³¨å†ŒæˆåŠŸ
    else ç”¨æˆ·å·²å­˜åœ¨
        C->>G: è¿”å›ç”¨æˆ·å·²å­˜åœ¨é”™è¯¯
        G->>U: æ³¨å†Œå¤±è´¥
    end
```

### 5.2 ä¸‹å•äº¤æ˜“æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant G as Gateway
    participant O as Order-Service
    participant C as Common-Service
    participant DB as Database

    U->>G: ä¸‹å•è¯·æ±‚
    G->>O: è½¬å‘ä¸‹å•è¯·æ±‚
    O->>O: é£æ§æ ¡éªŒ
    alt é£æ§é€šè¿‡
        O->>C: æ£€æŸ¥è´¦æˆ·ä½™é¢
        alt ä½™é¢å……è¶³
            O->>C: å†»ç»“èµ„é‡‘
            O->>DB: åˆ›å»ºè®¢å•
            O->>G: è¿”å›ä¸‹å•æˆåŠŸ
            G->>U: ä¸‹å•æˆåŠŸ
        else ä½™é¢ä¸è¶³
            O->>G: è¿”å›ä½™é¢ä¸è¶³é”™è¯¯
            G->>U: ä¸‹å•å¤±è´¥
        end
    else é£æ§æ‹¦æˆª
        O->>DB: è®°å½•é£æ§æ—¥å¿—
        O->>G: è¿”å›é£æ§é”™è¯¯
        G->>U: ä¸‹å•å¤±è´¥
    end
```

### 5.3 è‡ªåŠ¨ç»“ç®—æµç¨‹

```mermaid
sequenceDiagram
    participant S as è°ƒåº¦ä»»åŠ¡
    participant O as Order-Service
    participant C as Common-Service
    participant M as Market-Service
    participant DB as Database

    S->>O: å®šæ—¶è§¦å‘ç»“ç®—
    O->>DB: æŸ¥è¯¢å¾…ç»“ç®—å›åˆ
    loop æ¯ä¸ªå›åˆ
        O->>M: è·å–ç»“ç®—ä»·æ ¼
        O->>DB: æŸ¥è¯¢å›åˆå†…æ‰€æœ‰è®¢å•
        loop æ¯ä¸ªè®¢å•
            O->>O: è®¡ç®—ç›ˆäº
            alt ç›ˆåˆ©
                O->>O: è®¡ç®—æ‰‹ç»­è´¹(10%)
                O->>C: è§£å†»èµ„é‡‘+æ´¾å¥–
            else äºæŸ
                O->>C: æ‰£é™¤å†»ç»“èµ„é‡‘
            else å¹³å±€
                O->>C: é€€è¿˜å†»ç»“èµ„é‡‘
            end
            O->>DB: æ›´æ–°è®¢å•çŠ¶æ€
            O->>C: è®°å½•èµ„é‡‘æµæ°´
        end
        O->>DB: æ›´æ–°å›åˆçŠ¶æ€ä¸ºå·²ç»“ç®—
    end
```

### 5.4 è®¢å•çŠ¶æ€æµè½¬ä¸æ•°æ®å˜åŒ–

#### 5.4.1 è®¢å•çŠ¶æ€æµè½¬å›¾
```mermaid
stateDiagram-v2
    [*] --> PENDING : ç”¨æˆ·ä¸‹æ³¨
    PENDING --> CANCELLED : æ’¤å•(é”å•å‰)
    PENDING --> WIN : ç»“ç®—ç›ˆåˆ©
    PENDING --> LOSE : ç»“ç®—äºæŸ  
    PENDING --> DRAW : ç»“ç®—å¹³å±€
    WIN --> [*]
    LOSE --> [*]
    DRAW --> [*]
    CANCELLED --> [*]
```

#### 5.4.2 å„çŠ¶æ€å¯¹åº”çš„æ•°æ®å˜åŒ–

**1. ä¸‹æ³¨é˜¶æ®µ (PENDING)**
```sql
-- è®¢å•è¡¨ï¼šåˆ›å»ºè®¢å•è®°å½•
INSERT INTO option_order (user_id, amount, direction, status, ...) 
VALUES (123, 100.0000000000000000, 'UP', 'PENDING', ...);

-- è´¦æˆ·è¡¨ï¼šè½¬ç§»èµ„é‡‘åˆ°å†»ç»“ä½™é¢
UPDATE account SET 
    balance = balance - 100.0000000000000000,
    frozen_balance = frozen_balance + 100.0000000000000000
WHERE user_id = 123 AND account_type = 'REAL';

-- èµ„é‡‘æµæ°´ï¼šä¸è®°å½•å†»ç»“æµæ°´
```

**2. æ’¤å•é˜¶æ®µ (CANCELLED)**
```sql
-- è®¢å•è¡¨ï¼šæ›´æ–°ä¸ºæ’¤å•çŠ¶æ€
UPDATE option_order SET 
    status = 'CANCELLED', cancel_time = NOW()
WHERE id = è®¢å•ID;

-- è´¦æˆ·è¡¨ï¼šé€€è¿˜å†»ç»“èµ„é‡‘
UPDATE account SET 
    balance = balance + 100.0000000000000000,
    frozen_balance = frozen_balance - 100.0000000000000000
WHERE user_id = 123;

-- èµ„é‡‘æµæ°´ï¼šè®°å½•æ’¤å•é€€æ¬¾
INSERT INTO account_transaction (type, amount, remark) 
VALUES ('CANCEL', 100.0000000000000000, 'æ’¤å•é€€è¿˜èµ„é‡‘');
```

**3. ç›ˆåˆ©ç»“ç®— (WIN)**
```sql
-- è®¢å•è¡¨ï¼šè®°å½•ç›ˆåˆ©ç»“æœ
UPDATE option_order SET 
    status = 'WIN',
    profit = 90.0000000000000000,      -- å®é™…ç›ˆåˆ©
    fee = 9.0000000000000000,          -- 10%æ‰‹ç»­è´¹
    settle_price = 45100.56789012,
    settle_time = NOW()
WHERE id = è®¢å•ID;

-- è´¦æˆ·è¡¨ï¼šæ´¾å‘ç›ˆåˆ©(æ‰£é™¤æ‰‹ç»­è´¹)
UPDATE account SET 
    balance = balance + 181.0000000000000000,        -- æœ¬é‡‘100 + ç›ˆåˆ©90 - æ‰‹ç»­è´¹9
    frozen_balance = frozen_balance - 100.0000000000000000,
    total_profit = total_profit + 81.0000000000000000  -- å‡€ç›ˆåˆ©
WHERE user_id = 123;

-- èµ„é‡‘æµæ°´ï¼šè®°å½•å‡€ç›ˆåˆ©
INSERT INTO account_transaction (type, amount, remark) 
VALUES ('BET_WIN', 81.0000000000000000, 'æŠ•æ³¨ç›ˆåˆ©(å«æœ¬é‡‘,æ‰£é™¤æ‰‹ç»­è´¹)');
```

**4. äºæŸç»“ç®— (LOSE)**
```sql
-- è®¢å•è¡¨ï¼šè®°å½•äºæŸç»“æœ
UPDATE option_order SET 
    status = 'LOSE',
    profit = -100.0000000000000000,    -- äºæŸæœ¬é‡‘
    fee = 0.0000000000000000,          -- äºæŸä¸æ”¶æ‰‹ç»­è´¹
    settle_price = 44900.98765432,
    settle_time = NOW()
WHERE id = è®¢å•ID;

-- è´¦æˆ·è¡¨ï¼šæ‰£é™¤å†»ç»“èµ„é‡‘
UPDATE account SET 
    frozen_balance = frozen_balance - 100.0000000000000000,
    total_loss = total_loss + 100.0000000000000000
WHERE user_id = 123;
-- æ³¨æ„ï¼šbalanceä¸å˜ï¼Œèµ„é‡‘å·²åœ¨ä¸‹æ³¨æ—¶æ‰£é™¤

-- èµ„é‡‘æµæ°´ï¼šè®°å½•äºæŸ
INSERT INTO account_transaction (type, amount, remark) 
VALUES ('BET_LOSE', -100.0000000000000000, 'æŠ•æ³¨äºæŸ');
```

**5. å¹³å±€ç»“ç®— (DRAW)**
```sql
-- è®¢å•è¡¨ï¼šè®°å½•å¹³å±€ç»“æœ
UPDATE option_order SET 
    status = 'DRAW',
    profit = 0.0000000000000000,       -- æ— ç›ˆäº
    fee = 0.0000000000000000,          -- å¹³å±€ä¸æ”¶æ‰‹ç»­è´¹
    settle_price = 45000.12345678,     -- ä¸ä¸‹å•ä»·ç›¸åŒ
    settle_time = NOW()
WHERE id = è®¢å•ID;

-- è´¦æˆ·è¡¨ï¼šé€€è¿˜æœ¬é‡‘
UPDATE account SET 
    balance = balance + 100.0000000000000000,
    frozen_balance = frozen_balance - 100.0000000000000000
WHERE user_id = 123;

-- èµ„é‡‘æµæ°´ï¼šè®°å½•å¹³å±€é€€æ¬¾
INSERT INTO account_transaction (type, amount, remark) 
VALUES ('BET_DRAW', 0.0000000000000000, 'æŠ•æ³¨å¹³å±€é€€è¿˜æœ¬é‡‘');
```

## 6. å…³é”®æŠ€æœ¯å®ç°

### 6.0 åå°æœåŠ¡æŠ€æœ¯å®ç°

#### 6.0.1 æ•°æ®è·å–æœºåˆ¶
option-admin-serviceé€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–æ•°æ®ï¼š

**ç›´æ¥æ•°æ®åº“æŸ¥è¯¢**
```java
@Service
public class AdminUserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private AccountRepository accountRepository;
    
    // ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢(æ”¯æŒåˆ†é¡µã€ç­›é€‰)
    public PageResult<UserVO> getUserList(UserQueryDTO query) {
        // ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œæ”¯æŒå¤æ‚æ¡ä»¶ç­›é€‰
        return userRepository.findByConditions(query);
    }
    
    // ç”¨æˆ·è¯¦æƒ…åŠå…³è”è´¦æˆ·ä¿¡æ¯
    public UserDetailVO getUserDetail(Long userId) {
        User user = userRepository.findById(userId);
        List<Account> accounts = accountRepository.findByUserId(userId);
        return UserDetailVO.builder()
            .user(user)
            .accounts(accounts)
            .build();
    }
}
```

**RPCè°ƒç”¨ä¸šåŠ¡æœåŠ¡**
```java
@Component
public class AdminOrderService {
    
    @Autowired
    private OrderServiceClient orderServiceClient;  // Feignå®¢æˆ·ç«¯
    
    @Autowired
    private CommonServiceClient commonServiceClient;
    
    // è·å–è®¢å•è¯¦æƒ…(é€šè¿‡RPCè°ƒç”¨)
    public OrderDetailVO getOrderDetail(Long orderId) {
        OrderDTO order = orderServiceClient.getOrder(orderId);
        UserDTO user = commonServiceClient.getUser(order.getUserId());
        
        return OrderDetailVO.builder()
            .order(order)
            .user(user)
            .build();
    }
    
    // æ‰‹åŠ¨ç»“ç®—å›åˆ
    public void manualSettleRound(Long roundId, ManualSettleRequest request) {
        orderServiceClient.manualSettle(roundId, request);
    }
}
```

#### 6.0.2 ç»Ÿè®¡æ•°æ®å®ç°

**å®šæ—¶ç»Ÿè®¡ä»»åŠ¡**
```java
@Component
public class StatsCalculationJob {
    
    @Autowired
    private DailyStatsService dailyStatsService;
    
    @Autowired
    private HourlyStatsService hourlyStatsService;
    
    // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œè®¡ç®—ä¸Šä¸€å°æ—¶ç»Ÿè®¡
    @XxlJob("calculateHourlyStats")
    public void calculateHourlyStats() {
        LocalDateTime lastHour = LocalDateTime.now().minusHours(1)
            .withMinute(0).withSecond(0).withNano(0);
        
        List<SymbolConfig> symbols = symbolConfigService.getAllEnabled();
        
        // æŒ‰äº¤æ˜“å¯¹ç»Ÿè®¡
        for (SymbolConfig symbol : symbols) {
            HourlyStats stats = calculateHourlyStatsForSymbol(lastHour, symbol.getId());
            hourlyStatsService.save(stats);
        }
        
        // å…¨å±€ç»Ÿè®¡
        HourlyStats globalStats = calculateHourlyStatsForSymbol(lastHour, null);
        hourlyStatsService.save(globalStats);
    }
    
    // æ¯æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼Œè®¡ç®—æ˜¨æ—¥ç»Ÿè®¡
    @XxlJob("calculateDailyStats")
    public void calculateDailyStats() {
        LocalDate yesterday = LocalDate.now().minusDays(1);
        
        List<SymbolConfig> symbols = symbolConfigService.getAllEnabled();
        
        // æŒ‰äº¤æ˜“å¯¹ç»Ÿè®¡
        for (SymbolConfig symbol : symbols) {
            DailyStats stats = calculateDailyStatsForSymbol(yesterday, symbol.getId());
            dailyStatsService.save(stats);
        }
        
        // å…¨å±€ç»Ÿè®¡
        DailyStats globalStats = calculateDailyStatsForSymbol(yesterday, null);
        dailyStatsService.save(globalStats);
    }
    
    // è®¡ç®—æŒ‡å®šæ—¥æœŸå’Œäº¤æ˜“å¯¹çš„ç»Ÿè®¡æ•°æ®
    private DailyStats calculateDailyStatsForSymbol(LocalDate date, Long symbolId) {
        String symbolCondition = symbolId != null ? "AND symbol_id = ?" : "";
        List<Object> params = new ArrayList<>();
        params.add(date);
        if (symbolId != null) params.add(symbolId);
        
        String sql = """
            SELECT 
                COUNT(DISTINCT o.user_id) as active_users,
                COUNT(o.id) as total_orders,
                COUNT(CASE WHEN o.status = 'PENDING' THEN 1 END) as pending_orders,
                COUNT(CASE WHEN o.status = 'WIN' THEN 1 END) as win_orders,
                COUNT(CASE WHEN o.status = 'LOSE' THEN 1 END) as lose_orders,
                COUNT(CASE WHEN o.status = 'DRAW' THEN 1 END) as draw_orders,
                COALESCE(SUM(o.amount), 0) as total_volume,
                COALESCE(SUM(CASE WHEN o.profit > 0 THEN o.profit ELSE 0 END), 0) as total_profit,
                COALESCE(SUM(CASE WHEN o.profit < 0 THEN ABS(o.profit) ELSE 0 END), 0) as total_loss,
                COALESCE(SUM(o.fee), 0) as total_fee,
                COALESCE(AVG(o.amount), 0) as avg_order_amount
            FROM option_order o
            WHERE DATE(o.create_time) = ? {symbolCondition}
            """.replace("{symbolCondition}", symbolCondition);
        
        // æŸ¥è¯¢æ–°å¢ç”¨æˆ·æ•°
        String newUserSql = "SELECT COUNT(*) FROM user WHERE DATE(create_time) = ?";
        int newUsers = jdbcTemplate.queryForObject(newUserSql, Integer.class, date);
        
        // æŸ¥è¯¢æ€»ç”¨æˆ·æ•°(æˆªæ­¢åˆ°å½“æ—¥)
        String totalUserSql = "SELECT COUNT(*) FROM user WHERE DATE(create_time) <= ?";
        int totalUsers = jdbcTemplate.queryForObject(totalUserSql, Integer.class, date);
        
        return jdbcTemplate.queryForObject(sql, params.toArray(), (rs, rowNum) -> {
            int totalOrders = rs.getInt("total_orders");
            int winOrders = rs.getInt("win_orders");
            BigDecimal winRate = totalOrders > 0 ? 
                BigDecimal.valueOf(winOrders).divide(BigDecimal.valueOf(totalOrders), 4, RoundingMode.HALF_UP) : 
                BigDecimal.ZERO;
            
            return DailyStats.builder()
                .statDate(date)
                .symbolId(symbolId)
                .totalUsers(totalUsers)
                .activeUsers(rs.getInt("active_users"))
                .newUsers(newUsers)
                .totalOrders(totalOrders)
                .pendingOrders(rs.getInt("pending_orders"))
                .winOrders(winOrders)
                .loseOrders(rs.getInt("lose_orders"))
                .drawOrders(rs.getInt("draw_orders"))
                .totalVolume(rs.getBigDecimal("total_volume"))
                .totalProfit(rs.getBigDecimal("total_profit"))
                .totalLoss(rs.getBigDecimal("total_loss"))
                .totalFee(rs.getBigDecimal("total_fee"))
                .winRate(winRate)
                .avgOrderAmount(rs.getBigDecimal("avg_order_amount"))
                .createTime(LocalDateTime.now())
                .updateTime(LocalDateTime.now())
                .build();
        });
    }
}
```

**ç»Ÿè®¡æŸ¥è¯¢æœåŠ¡**
```java
@Service
public class AdminStatsService {
    
    @Autowired
    private DailyStatsRepository dailyStatsRepository;
    
    @Autowired
    private HourlyStatsRepository hourlyStatsRepository;
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    // æŸ¥è¯¢å†å²ç»Ÿè®¡æ•°æ®(ä»é¢„è®¡ç®—è¡¨)
    public List<DailyStatsVO> getDailyStats(String startDate, String endDate, Long symbolId) {
        LocalDate start = LocalDate.parse(startDate);
        LocalDate end = LocalDate.parse(endDate);
        
        return dailyStatsRepository.findByDateRangeAndSymbol(start, end, symbolId)
            .stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());
    }
    
    // æŸ¥è¯¢å½“æ—¥å®æ—¶ç»Ÿè®¡(ç›´æ¥è®¡ç®—)
    public DailyStatsVO getTodayStats(Long symbolId) {
        LocalDate today = LocalDate.now();
        
        // å…ˆå°è¯•ä»ç»Ÿè®¡è¡¨æŸ¥è¯¢
        Optional<DailyStats> cached = dailyStatsRepository.findByStatDateAndSymbolId(today, symbolId);
        if (cached.isPresent()) {
            return convertToVO(cached.get());
        }
        
        // å®æ—¶è®¡ç®—å½“æ—¥æ•°æ®
        return calculateRealtimeStats(today, symbolId);
    }
    
    // å®æ—¶ç›‘æ§æ•°æ®
    public RealtimeMonitorVO getRealtimeMonitor() {
        String sql = """
            SELECT 
                (SELECT COUNT(*) FROM trading_round WHERE status IN ('OPEN', 'LOCKED')) as active_rounds,
                (SELECT COUNT(*) FROM option_order WHERE create_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)) as recent_orders,
                (SELECT COUNT(*) FROM user WHERE create_time >= CURDATE()) as today_new_users,
                (SELECT COUNT(DISTINCT user_id) FROM option_order WHERE create_time >= CURDATE()) as today_active_users
            """;
        
        return jdbcTemplate.queryForObject(sql, (rs, rowNum) -> 
            RealtimeMonitorVO.builder()
                .activeRounds(rs.getInt("active_rounds"))
                .recentOrders(rs.getInt("recent_orders"))
                .todayNewUsers(rs.getInt("today_new_users"))
                .todayActiveUsers(rs.getInt("today_active_users"))
                .timestamp(System.currentTimeMillis())
                .build());
    }
}
```

#### 6.0.3 é…ç½®ç®¡ç†å®ç°
```java
@Service
public class AdminConfigService {
    
    @Autowired
    private RiskConfigRepository riskConfigRepository;
    
    @Autowired
    private SymbolConfigRepository symbolConfigRepository;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // åŠ¨æ€æ›´æ–°é£æ§é…ç½®
    @Transactional
    public void updateRiskConfig(String configKey, String configValue) {
        RiskConfig config = riskConfigRepository.findByConfigKey(configKey);
        if (config != null) {
            config.setConfigValue(configValue);
            config.setUpdateTime(LocalDateTime.now());
            riskConfigRepository.save(config);
            
            // æ›´æ–°Redisç¼“å­˜ï¼Œä¾›å…¶ä»–æœåŠ¡å®æ—¶è¯»å–
            redisTemplate.opsForHash().put("risk_configs", configKey, configValue);
        }
    }
    
    // å¸ç§é…ç½®ç®¡ç†
    public void updateSymbolConfig(Long symbolId, SymbolConfigUpdateRequest request) {
        SymbolConfig config = symbolConfigRepository.findById(symbolId).orElseThrow();
        config.setEnabled(request.getEnabled());
        config.setMinAmount(request.getMinAmount());
        config.setMaxAmount(request.getMaxAmount());
        symbolConfigRepository.save(config);
        
        // æ›´æ–°Redisç¼“å­˜
        redisTemplate.opsForHash().put("symbol_configs", symbolId.toString(), 
            JSON.toJSONString(config));
    }
    
    // é»‘åå•ç®¡ç†
    public void addToBlacklist(Long userId, String reason) {
        // 1. ä¿å­˜åˆ°æ•°æ®åº“
        Blacklist blacklist = Blacklist.builder()
            .userId(userId)
            .reason(reason)
            .status((byte)1)
            .startTime(LocalDateTime.now())
            .build();
        blacklistRepository.save(blacklist);
        
        // 2. æ·»åŠ åˆ°Redisé›†åˆï¼Œä¾›ä¸šåŠ¡æœåŠ¡å¿«é€ŸæŸ¥è¯¢
        redisTemplate.opsForSet().add("blacklist_users", userId.toString());
    }
    
    public void removeFromBlacklist(Long userId) {
        // 1. æ›´æ–°æ•°æ®åº“çŠ¶æ€
        Blacklist blacklist = blacklistRepository.findByUserIdAndStatus(userId, (byte)1);
        if (blacklist != null) {
            blacklist.setStatus((byte)0);
            blacklist.setUpdateTime(LocalDateTime.now());
            blacklistRepository.save(blacklist);
        }
        
        // 2. ä»Redisé›†åˆç§»é™¤
        redisTemplate.opsForSet().remove("blacklist_users", userId.toString());
    }
}
```

**ä¸šåŠ¡æœåŠ¡è¯»å–Redisé…ç½®**
```java
// option-order-service é£æ§æ ¡éªŒ
@Service
public class RiskControlService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Autowired
    private RiskConfigRepository riskConfigRepository;
    
    // è·å–é£æ§é…ç½®
    public String getRiskConfig(String configKey) {
        // ä¼˜å…ˆä»Redisè¯»å–
        String value = (String) redisTemplate.opsForHash().get("risk_configs", configKey);
        if (value == null) {
            // Redisæ²¡æœ‰åˆ™ä»æ•°æ®åº“åŠ è½½å¹¶ç¼“å­˜
            RiskConfig config = riskConfigRepository.findByConfigKey(configKey);
            if (config != null) {
                value = config.getConfigValue();
                redisTemplate.opsForHash().put("risk_configs", configKey, value);
            }
        }
        return value;
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨é»‘åå•
    public boolean isUserBlacklisted(Long userId) {
        return redisTemplate.opsForSet().isMember("blacklist_users", userId.toString());
    }
    
    // é£æ§æ ¡éªŒ
    public RiskResult checkBetLimit(Long userId, BigDecimal amount, String accountType) {
        // é»‘åå•æ£€æŸ¥
        if (isUserBlacklisted(userId)) {
            return RiskResult.block("ç”¨æˆ·å·²è¢«åŠ å…¥é»‘åå•");
        }
        
        // å•ç¬”é™é¢æ£€æŸ¥
        String minAmountStr = getRiskConfig("MIN_BET_AMOUNT");
        String maxAmountStr = getRiskConfig("MAX_BET_AMOUNT");
        
        BigDecimal minAmount = new BigDecimal(minAmountStr != null ? minAmountStr : "10");
        BigDecimal maxAmount = new BigDecimal(maxAmountStr != null ? maxAmountStr : "10000");
        
        if (amount.compareTo(minAmount) < 0 || amount.compareTo(maxAmount) > 0) {
            return RiskResult.block("å•ç¬”æŠ•æ³¨é‡‘é¢è¶…é™");
        }
        
        return RiskResult.pass();
    }
}
```

### 6.1 å›åˆç®¡ç†ç­–ç•¥

#### 6.1.1 å›åˆç”Ÿæˆ
- ä½¿ç”¨XXL-Jobå®šæ—¶ä»»åŠ¡ï¼Œæ¯åˆ†é’Ÿæ£€æŸ¥å¹¶ç”Ÿæˆæ–°å›åˆ
- æ”¯æŒ5åˆ†é’Ÿã€10åˆ†é’Ÿã€15åˆ†é’Ÿç­‰å¤šå‘¨æœŸå¹¶è¡Œ
- å›åˆç¼–å·æ ¼å¼ï¼š`BTC_USDT_5M_20250718_1430`

#### 6.1.2 å€’è®¡æ—¶å®ç°
```java
@Component
public class RoundCountdownService {
    
    public RoundCountdown getCurrentCountdown(Long symbolId, Integer duration) {
        TradingRound round = getCurrentRound(symbolId, duration);
        if (round == null) return null;
        
        long now = System.currentTimeMillis();
        long lockTime = round.getLockTime().getTime();
        long endTime = round.getEndTime().getTime();
        
        if (now >= endTime) {
            return RoundCountdown.builder()
                .status("SETTLED")
                .remainingSeconds(0)
                .build();
        } else if (now >= lockTime) {
            return RoundCountdown.builder()
                .status("LOCKED")
                .remainingSeconds((int)((endTime - now) / 1000))
                .build();
        } else {
            return RoundCountdown.builder()
                .status("OPEN")
                .remainingSeconds((int)((lockTime - now) / 1000))
                .lockWarning(now >= lockTime - 30000) // å‰30ç§’è­¦å‘Š
                .build();
        }
    }
}
```

### 6.2 é£æ§é™é¢æ ¡éªŒå®ç°

#### 6.2.1 Redisæ»‘åŠ¨çª—å£é™é¢æ–¹æ¡ˆ
ä½¿ç”¨Redis + è‡ªåŠ¨è¿‡æœŸçš„æ–¹å¼å®ç°ç”¨æˆ·äº¤æ˜“é™é¢æ ¡éªŒï¼š

**Rediså­˜å‚¨ç»“æ„**:
```redis
# ç”¨æˆ·å„ç»´åº¦é™é¢è¿½è¸ª
user_daily_limit:{userId}:{date} = {amount}     # æ—¥é™é¢ï¼Œ24å°æ—¶è¿‡æœŸ
user_weekly_limit:{userId}:{week} = {amount}    # å‘¨é™é¢ï¼Œ7å¤©è¿‡æœŸ  
user_monthly_limit:{userId}:{month} = {amount}  # æœˆé™é¢ï¼Œ30å¤©è¿‡æœŸ
```

#### 6.2.2 é™é¢æ ¡éªŒæœåŠ¡å®ç°
```java
@Service
public class RiskControlService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // ä¸‹å•å‰é™é¢æ ¡éªŒ
    public RiskResult checkBetLimit(Long userId, BigDecimal amount, String accountType) {
        LocalDate today = LocalDate.now();
        
        // 1. å•ç¬”é™é¢æ£€æŸ¥
        BigDecimal minAmount = getRiskConfig("MIN_BET_AMOUNT", "10");
        BigDecimal maxAmount = getRiskConfig("MAX_BET_AMOUNT", "10000");
        if (amount.compareTo(minAmount) < 0 || amount.compareTo(maxAmount) > 0) {
            return RiskResult.block("å•ç¬”æŠ•æ³¨é‡‘é¢è¶…é™");
        }
        
        // 2. é»‘åå•æ£€æŸ¥
        if (isUserBlacklisted(userId)) {
            return RiskResult.block("ç”¨æˆ·å·²è¢«åŠ å…¥é»‘åå•");
        }
        
        // 3. å•æ—¥é™é¢æ£€æŸ¥
        BigDecimal dailyLimit = getRiskConfig("DAILY_BET_LIMIT", "100000");
        String dailyKey = "user_daily_limit:" + userId + ":" + today.format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        BigDecimal dailyUsed = getAmountFromRedis(dailyKey);
        if (dailyUsed.add(amount).compareTo(dailyLimit) > 0) {
            return RiskResult.block("æ—¥æŠ•æ³¨é¢åº¦è¶…é™ï¼Œå½“å‰å·²ç”¨:" + dailyUsed + "ï¼Œé™é¢:" + dailyLimit);
        }
        
        // 4. å•å‘¨é™é¢æ£€æŸ¥
        BigDecimal weeklyLimit = getRiskConfig("WEEKLY_BET_LIMIT", "500000");
        String weeklyKey = "user_weekly_limit:" + userId + ":" + getWeekKey(today);
        BigDecimal weeklyUsed = getAmountFromRedis(weeklyKey);
        if (weeklyUsed.add(amount).compareTo(weeklyLimit) > 0) {
            return RiskResult.block("å‘¨æŠ•æ³¨é¢åº¦è¶…é™");
        }
        
        // 5. å•æœˆé™é¢æ£€æŸ¥
        BigDecimal monthlyLimit = getRiskConfig("MONTHLY_BET_LIMIT", "2000000");
        String monthlyKey = "user_monthly_limit:" + userId + ":" + today.format(DateTimeFormatter.ofPattern("yyyyMM"));
        BigDecimal monthlyUsed = getAmountFromRedis(monthlyKey);
        if (monthlyUsed.add(amount).compareTo(monthlyLimit) > 0) {
            return RiskResult.block("æœˆæŠ•æ³¨é¢åº¦è¶…é™");
        }
        
        return RiskResult.pass();
    }
    
    // ä¸‹å•æˆåŠŸåæ›´æ–°é™é¢ä½¿ç”¨é‡
    @Transactional
    public void updateBetLimitUsage(Long userId, BigDecimal amount) {
        LocalDate today = LocalDate.now();
        
        String dailyKey = "user_daily_limit:" + userId + ":" + today.format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        String weeklyKey = "user_weekly_limit:" + userId + ":" + getWeekKey(today);
        String monthlyKey = "user_monthly_limit:" + userId + ":" + today.format(DateTimeFormatter.ofPattern("yyyyMM"));
        
        // åŸå­æ€§å¢åŠ é‡‘é¢å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
        redisTemplate.opsForValue().increment(dailyKey, amount.doubleValue());
        redisTemplate.expire(dailyKey, Duration.ofDays(1));
        
        redisTemplate.opsForValue().increment(weeklyKey, amount.doubleValue());
        redisTemplate.expire(weeklyKey, Duration.ofDays(7));
        
        redisTemplate.opsForValue().increment(monthlyKey, amount.doubleValue());
        redisTemplate.expire(monthlyKey, Duration.ofDays(30));
    }
    
    // æ’¤å•æ—¶å‡å°‘ä½¿ç”¨é‡
    public void reduceBetLimitUsage(Long userId, BigDecimal amount) {
        LocalDate today = LocalDate.now();
        
        String dailyKey = "user_daily_limit:" + userId + ":" + today.format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        String weeklyKey = "user_weekly_limit:" + userId + ":" + getWeekKey(today);
        String monthlyKey = "user_monthly_limit:" + userId + ":" + today.format(DateTimeFormatter.ofPattern("yyyyMM"));
        
        redisTemplate.opsForValue().increment(dailyKey, -amount.doubleValue());
        redisTemplate.opsForValue().increment(weeklyKey, -amount.doubleValue());
        redisTemplate.opsForValue().increment(monthlyKey, -amount.doubleValue());
    }
    
    private BigDecimal getAmountFromRedis(String key) {
        Double value = redisTemplate.opsForValue().get(key);
        return value != null ? BigDecimal.valueOf(value) : BigDecimal.ZERO;
    }
    
    private String getWeekKey(LocalDate date) {
        return date.getYear() + "W" + date.get(WeekFields.ISO.weekOfYear());
    }
}
```

#### 6.2.3 æ–¹æ¡ˆä¼˜åŠ¿
- **é«˜æ€§èƒ½**: RedisåŸå­æ“ä½œï¼Œæ¯«ç§’çº§å“åº”
- **è‡ªåŠ¨è¿‡æœŸ**: æ— éœ€å®šæ—¶æ¸…ç†è¿‡æœŸæ•°æ®  
- **å®æ—¶å‡†ç¡®**: æ¯æ¬¡ä¸‹å•éƒ½å®æ—¶æ›´æ–°å’Œæ ¡éªŒ
- **æ”¯æŒæ’¤å•**: æ’¤å•æ—¶å¯å‡å°‘ä½¿ç”¨é‡
- **æ˜“äºç›‘æ§**: å¯å®æ—¶æŸ¥çœ‹ç”¨æˆ·å„ç»´åº¦ä½¿ç”¨æƒ…å†µ

### 6.3 å®æ—¶æ•°æ®æ¨é€

#### 6.3.1 WebSocketæ¨é€
```java
@Component
public class TradingWebSocketHandler extends TextWebSocketHandler {
    
    @EventListener
    public void handleRoundUpdate(RoundUpdateEvent event) {
        TradingRound round = event.getRound();
        Map<String, Object> message = Map.of(
            "type", "ROUND_UPDATE",
            "roundId", round.getId(),
            "status", round.getStatus(),
            "countdown", getCountdown(round),
            "upOdds", round.getUpOdds(),
            "downOdds", round.getDownOdds()
        );
        
        broadcastToSymbolSubscribers(round.getSymbolId(), message);
    }
}
```

## 7. éƒ¨ç½²æ¶æ„

### 7.1 æœåŠ¡éƒ¨ç½²æ‹“æ‰‘

```mermaid
graph TB
    subgraph "è´Ÿè½½å‡è¡¡å±‚"
        LB[Nginxè´Ÿè½½å‡è¡¡]
    end
    
    subgraph "åº”ç”¨æœåŠ¡å±‚"
        GW1[Gateway-1]
        GW2[Gateway-2]
        CS1[Common-Service-1]
        CS2[Common-Service-2]
        OS1[Order-Service-1]
        OS2[Order-Service-2]
        MS1[Market-Service]
    end
    
    subgraph "æ•°æ®å­˜å‚¨å±‚"
        DB1[(MySQLä¸»åº“)]
        DB2[(MySQLä»åº“)]
        RD1[(Redisé›†ç¾¤)]
    end
    
    subgraph "ç›‘æ§è¿ç»´"
        NC[Nacosé›†ç¾¤]
        XXL[XXL-Jobé›†ç¾¤]
        MON[ç›‘æ§å‘Šè­¦]
    end
    
    LB --> GW1
    LB --> GW2
    GW1 --> CS1
    GW1 --> OS1
    GW2 --> CS2
    GW2 --> OS2
    CS1 --> DB1
    OS1 --> DB1
    CS1 --> RD1
    OS1 --> RD1
    CS1 --> NC
    OS1 --> NC
    OS1 --> XXL
```

### 7.2 ç¯å¢ƒé…ç½®

#### 7.2.1 å¼€å‘ç¯å¢ƒ
- å•æœºéƒ¨ç½²ï¼Œä½¿ç”¨Docker Compose
- MySQLå•å®ä¾‹ï¼ŒRediså•å®ä¾‹
- Nacoså•å®ä¾‹

#### 7.2.2 ç”Ÿäº§ç¯å¢ƒ
- é›†ç¾¤éƒ¨ç½²ï¼Œæ¯ä¸ªæœåŠ¡è‡³å°‘2ä¸ªå®ä¾‹
- MySQLä¸»ä»å¤åˆ¶ï¼ŒRedisé›†ç¾¤
- Nacosé›†ç¾¤

## 8. å®‰å…¨è®¾è®¡

### 8.1 æ•°æ®å®‰å…¨
- **å¯†ç åŠ å¯†**ï¼šä½¿ç”¨BCryptåŠ å¯†å­˜å‚¨
- **æ•æ„Ÿæ•°æ®**ï¼šäº¤æ˜“é‡‘é¢ç­‰ä½¿ç”¨AESåŠ å¯†
- **ä¼ è¾“å®‰å…¨**ï¼šHTTPS + WSSåè®®

### 8.2 æ¥å£å®‰å…¨

#### 8.2.1 Gatewayä¿¡ä»»æ¨¡å¼å®‰å…¨æ¶æ„ âœ…

**æ¶æ„æ ¸å¿ƒæ€æƒ³**ï¼š
- **Gatewayç»Ÿä¸€è®¤è¯**ï¼šåªæœ‰Gatewayå±‚å¤„ç†JWTè®¤è¯ï¼Œä¸‹æ¸¸æœåŠ¡å®Œå…¨ä¿¡ä»»Gateway
- **ç”¨æˆ·ä¿¡æ¯ä¼ é€’**ï¼šGatewayè§£æJWTåé€šè¿‡HTTP Headerä¼ é€’ç”¨æˆ·ä¿¡æ¯
- **æœåŠ¡å·®å¼‚åŒ–å®‰å…¨**ï¼šä¸åŒæœåŠ¡é‡‡ç”¨ä¸åŒçš„å®‰å…¨ç­–ç•¥
- **æƒé™æ³¨è§£ä½“ç³»**ï¼šåŸºäºAOPçš„å£°æ˜å¼æƒé™æ§åˆ¶ï¼ˆä»…ç®¡ç†æœåŠ¡ä½¿ç”¨ï¼‰

**å®‰å…¨é…ç½®åˆ†å±‚**ï¼š
- **BaseSecurityConfig**ï¼šJWTè®¤è¯æ¨¡å¼ï¼Œç”¨äºadmin-serviceç®¡ç†ç«¯
- **GatewayTrustSecurityConfig**ï¼šä¿¡ä»»æ¨¡å¼ï¼Œç”¨äºbusinessæœåŠ¡ï¼ˆcommon/order-serviceï¼‰
- **æ¡ä»¶åŒ–é…ç½®**ï¼šé€šè¿‡`security.mode=jwt`é…ç½®é€‰æ‹©è®¤è¯æ¨¡å¼

**æƒé™æ³¨è§£ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
// option-admin-service ç®¡ç†å‘˜æ§åˆ¶å™¨ (ä½¿ç”¨JWTè®¤è¯æ¨¡å¼)
@RestController
@RequestMapping("/admin/users")
@RequireRole(value = "admin", description = "ç®¡ç†å‘˜æƒé™")
public class AdminUserController {
    
    @GetMapping
    public ApiResponse<List<UserVO>> getUserList() {
        // éœ€è¦adminè§’è‰²æ‰èƒ½è®¿é—®ï¼ŒJWTå¿…éœ€
        return userService.getUserList();
    }
    
    @PutMapping("/{userId}/status")
    @RequirePermission(value = "user:update", description = "ç”¨æˆ·çŠ¶æ€æ›´æ–°æƒé™")
    public ApiResponse<Void> updateUserStatus(@PathVariable Long userId) {
        // éœ€è¦JWT + user:updateæƒé™
        return userService.updateStatus(userId);
    }
}

// option-order-service è®¢å•æ§åˆ¶å™¨ (ä½¿ç”¨Gatewayä¿¡ä»»æ¨¡å¼)
@RestController
@RequestMapping("/order")
public class OrderController {
    
    @PostMapping
    public ApiResponse<OrderDTO> createOrder(@RequestBody OrderDTO dto) {
        // Gatewayä¿¡ä»»æ¨¡å¼ï¼šæ— éœ€JWTï¼Œç›´æ¥ä»Headerè·å–ç”¨æˆ·ä¿¡æ¯
        String userId = UserContext.getCurrentUserId();
        return orderService.createOrder(dto, Long.parseLong(userId));
    }
    
    @GetMapping("/my")
    public ApiResponse<List<OrderVO>> getMyOrders() {
        // ä»Gatewayä¼ é€’çš„Headerä¸­è·å–ç”¨æˆ·ID
        String userId = UserContext.getCurrentUserId();
        if (userId == null) {
            throw BusinessException.unauthorized("user.not.authenticated", null);
        }
        return orderService.getOrdersByUserId(Long.parseLong(userId));
    }
}

// option-common-service ç”¨æˆ·æ§åˆ¶å™¨ (ä½¿ç”¨Gatewayä¿¡ä»»æ¨¡å¼)
@RestController
@RequestMapping("/user")
public class UserController {
    
    @GetMapping("/me")
    public ApiResponse<UserVO> getCurrentUser() {
        // Gatewayä¿¡ä»»æ¨¡å¼ï¼šä»UserContextè·å–ç”¨æˆ·ä¿¡æ¯
        String userId = UserContext.getCurrentUserId();
        if (userId == null) {
            throw BusinessException.unauthorized("user.not.authenticated", null);
        }
        return userService.getUser(Long.parseLong(userId));
    }
    
    @GetMapping("/list")
    public ApiResponse<List<UserVO>> getUserList() {
        // æ— éœ€è®¤è¯çš„å…¬å¼€æ¥å£
        return userService.listUsers();
    }
}
```

**ç”¨æˆ·ä¿¡æ¯è·å–å·¥å…·ç±»**ï¼š
```java
// UserContext - ä»Gatewayä¼ é€’çš„Headerä¸­è·å–ç”¨æˆ·ä¿¡æ¯
public class UserContext {
    private static final String USER_ID_HEADER = "X-User-Id";
    private static final String USER_NAME_HEADER = "X-User-Name";
    
    // è·å–å½“å‰ç”¨æˆ·ID
    public static String getCurrentUserId() {
        return getHeader(USER_ID_HEADER);
    }
    
    // è·å–å½“å‰ç”¨æˆ·å
    public static String getCurrentUsername() {
        return getHeader(USER_NAME_HEADER);
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
    public static boolean isAuthenticated() {
        return getCurrentUserId() != null;
    }
    
    private static String getHeader(String headerName) {
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (attributes != null) {
            HttpServletRequest request = attributes.getRequest();
            return request.getHeader(headerName);
        }
        return null;
    }
}
```

**æƒé™ç¼“å­˜æœºåˆ¶ï¼ˆä»…admin-serviceä½¿ç”¨ï¼‰**ï¼š
```java
@Service
public class PermissionCacheService {
    
    @Autowired(required = false)  // å¯é€‰ä¾èµ–ï¼ŒRedisä¸å¯ç”¨æ—¶é™çº§
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç¼“å­˜ç”¨æˆ·æƒé™åˆ°Redisï¼Œ30åˆ†é’Ÿè¿‡æœŸ
    public void cacheUserPermissions(Long userId, Set<String> permissions) {
        if (redisTemplate == null) {
            log.debug("Redis not configured, skipping cache for user permissions: {}", userId);
            return;
        }
        String key = "auth:permissions:user:" + userId;
        redisTemplate.opsForSet().add(key, permissions.toArray());
        redisTemplate.expire(key, 30, TimeUnit.MINUTES);
    }
    
    // é«˜æ€§èƒ½æƒé™æ£€æŸ¥
    public Boolean hasPermission(Long userId, String permission) {
        if (redisTemplate == null) {
            return null; // è¡¨ç¤ºç¼“å­˜ä¸å¯ç”¨ï¼Œéœ€è¦ä»æ•°æ®åº“æŸ¥è¯¢
        }
        String key = "auth:permissions:user:" + userId;
        return redisTemplate.opsForSet().isMember(key, permission);
    }
}
```

#### 8.2.2 JWTè®¤è¯æ¶æ„
- **è®¤è¯æµç¨‹**ï¼šGatewayç»Ÿä¸€å¤„ç†JWTè®¤è¯ï¼Œåç«¯æœåŠ¡æ— JWTä¾èµ–
- **è¯·æ±‚æµå‘**ï¼š`ç”¨æˆ·è¯·æ±‚ â†’ Gateway(JWTæ ¡éªŒ) â†’ åç«¯æœåŠ¡(Headerä¼ é€’)`
- **ç”¨æˆ·ä¿¡æ¯ä¼ é€’**ï¼šGatewayè§£æJWTåé€šè¿‡Headerä¼ é€’ç”¨æˆ·ä¿¡æ¯ç»™åç«¯

```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯
    participant G as Gateway
    participant S as åç«¯æœåŠ¡
    
    C->>G: è¯·æ±‚ + Authorization: Bearer {token}
    G->>G: è§£æJWT token
    alt JWTæœ‰æ•ˆ
        G->>S: è½¬å‘è¯·æ±‚ + X-User-Id + X-User-Name
        S->>S: ä»Headerè·å–ç”¨æˆ·ä¿¡æ¯
        S->>G: è¿”å›ä¸šåŠ¡æ•°æ®
        G->>C: è¿”å›å“åº”
    else JWTæ— æ•ˆ
        G->>C: è¿”å›401è®¤è¯å¤±è´¥
    end
```

#### 8.2.2 Headerä¼ é€’æœºåˆ¶
Gatewayåœ¨è½¬å‘è¯·æ±‚æ—¶æ³¨å…¥ä»¥ä¸‹Headerï¼š
```
X-User-Id: 123                    # ç”¨æˆ·ID
X-User-Name: username             # ç”¨æˆ·å
X-External-Id: btse_user_123      # å¤–éƒ¨ç”¨æˆ·ID(å¯é€‰)
```

åç«¯æœåŠ¡Controllerç¤ºä¾‹ï¼š
```java
@GetMapping("/me")
public Object getCurrentUser(@RequestHeader("X-User-Id") Long userId,
                           @RequestHeader("X-User-Name") String username) {
    // ç›´æ¥ä½¿ç”¨Headerä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ— éœ€JWTå¤„ç†
    return userService.getUser(userId);
}
```

#### 8.2.3 æƒé™æ³¨è§£è¯´æ˜

**@RequirePermission**ï¼šæ–¹æ³•çº§åˆ«æƒé™æ§åˆ¶
```java
@RequirePermission(value = "order:create", description = "åˆ›å»ºè®¢å•æƒé™")
@RequirePermission(value = {"order:read", "order:write"}, 
                  logical = LogicalOperator.AND,  // éœ€è¦åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªæƒé™
                  description = "è®¢å•è¯»å†™æƒé™")
```

**@RequireRole**ï¼šè§’è‰²çº§åˆ«æƒé™æ§åˆ¶
```java
@RequireRole(value = "admin", description = "ç®¡ç†å‘˜è§’è‰²")
@RequireRole(value = {"admin", "operator"}, 
            logical = LogicalOperator.OR,  // æ‹¥æœ‰å…¶ä¸­ä»»ä¸€è§’è‰²å³å¯
            description = "ç®¡ç†å‘˜æˆ–æ“ä½œå‘˜è§’è‰²")
```

**@AllowAnonymous**ï¼šå…è®¸åŒ¿åè®¿é—®
```java
@AllowAnonymous("å…¬å¼€API - æ— éœ€è®¤è¯")
```

**æƒé™ç­–ç•¥**ï¼š
- **order-service, common-service**ï¼šä½¿ç”¨Gatewayä¿¡ä»»æ¨¡å¼ï¼Œæ— JWTè®¤è¯ï¼Œé€šè¿‡Headerè·å–ç”¨æˆ·ä¿¡æ¯
- **admin-service**ï¼šä½¿ç”¨JWTè®¤è¯æ¨¡å¼ï¼Œæ‰€æœ‰ç®¡ç†æ¥å£éƒ½éœ€è¦adminè§’è‰² + JWT token
- **æƒé™ç²’åº¦**ï¼šæ”¯æŒæ“ä½œçº§åˆ«æƒé™ï¼ˆå¦‚order:create, user:updateï¼‰ï¼Œä»…admin-serviceä½¿ç”¨
- **é™çº§å¤„ç†**ï¼šRedis ç­‰ä¸­é—´ä»¶ä¸ºå¯é€‰ä¾èµ–ï¼Œä¸å¯ç”¨æ—¶ä¼˜é›…é™çº§

#### 8.2.4 å…¶ä»–å®‰å…¨æªæ–½
- **æ¥å£ç­¾å**ï¼šå…³é”®æ¥å£ä½¿ç”¨HMACç­¾å
- **é™æµé˜²æŠ¤**ï¼šRedisä»¤ç‰Œæ¡¶é™æµ

### 8.3 ä¸šåŠ¡å®‰å…¨
- **è´¦æˆ·éš”ç¦»**ï¼šå®ç›˜/æ¨¡æ‹Ÿä¸¥æ ¼éš”ç¦»
- **èµ„é‡‘å®‰å…¨**ï¼šæ‰€æœ‰èµ„é‡‘å˜åŠ¨æœ‰æµæ°´è®°å½•
- **é£æ§ä¿æŠ¤**ï¼šå¤šç»´åº¦é£æ§æ ¡éªŒ

## 9. ç›‘æ§å‘Šè­¦

### 9.1 ä¸šåŠ¡ç›‘æ§
- **äº¤æ˜“é‡ç›‘æ§**ï¼šå®æ—¶äº¤æ˜“é‡ã€æˆåŠŸç‡
- **èµ„é‡‘ç›‘æ§**ï¼šä½™é¢å˜åŠ¨ã€å¼‚å¸¸äº¤æ˜“
- **ç”¨æˆ·è¡Œä¸º**ï¼šç™»å½•é‡ã€æ´»è·ƒåº¦

### 9.2 æŠ€æœ¯ç›‘æ§
- **æœåŠ¡ç›‘æ§**ï¼šæ¥å£å“åº”æ—¶é—´ã€é”™è¯¯ç‡
- **èµ„æºç›‘æ§**ï¼šCPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡
- **ä¸­é—´ä»¶ç›‘æ§**ï¼šMySQLã€Redis çŠ¶æ€

## 10. æ‰©å±•æ€§è®¾è®¡

### 10.1 å¤šå¸ç§æ‰©å±•
- å¸ç§é…ç½®è¡¨åŠ¨æ€é…ç½®
- æ–°å¢å¸ç§æ— éœ€ä»£ç å˜æ›´
- æ”¯æŒä¸åŒå¸ç§ä¸åŒå‚æ•°

### 10.2 å¤šå‘¨æœŸæ‰©å±•
- å›åˆç®¡ç†æ”¯æŒä»»æ„æ—¶é•¿
- è°ƒåº¦ä»»åŠ¡åŠ¨æ€ç”Ÿæˆå›åˆ
- å‰ç«¯ç•Œé¢åŠ¨æ€æ¸²æŸ“

### 10.3 å¤šäº¤æ˜“æ‰€æ‰©å±•
- è¡Œæƒ…æœåŠ¡æŠ½è±¡åŒ–
- æ”¯æŒå¤šäº¤æ˜“æ‰€ä»·æ ¼èšåˆ
- æ•…éšœåˆ‡æ¢æœºåˆ¶

## 11. å½“å‰å®ç°è¯¦æƒ… (v1.1æ–°å¢)

### 11.1 æ•°æ®åº“å®ä½“æ˜ å°„å®Œæˆæƒ…å†µ

#### 11.1.1 option-common-service å®ä½“å®ç° âœ…
```
src/main/java/com/binaryoption/commonservice/domain/
â”œâ”€â”€ User.java                    # ç”¨æˆ·è¡¨å®ä½“
â”œâ”€â”€ Account.java                 # è´¦æˆ·è¡¨å®ä½“
â”œâ”€â”€ AccountTransaction.java      # èµ„é‡‘æµæ°´è¡¨å®ä½“
â””â”€â”€ SymbolConfig.java           # å¸ç§é…ç½®è¡¨å®ä½“

src/main/java/com/binaryoption/commonservice/mapper/
â”œâ”€â”€ UserMapper.java + UserMapper.xml
â”œâ”€â”€ AccountMapper.java + AccountMapper.xml
â”œâ”€â”€ AccountTransactionMapper.java + AccountTransactionMapper.xml
â””â”€â”€ SymbolConfigMapper.java + SymbolConfigMapper.xml
```

#### 11.1.2 option-order-service å®ä½“å®ç° âœ…
```
src/main/java/com/binaryoption/orderservice/domain/
â”œâ”€â”€ Order.java                   # è®¢å•è¡¨å®ä½“(å¯¹åº”option_orderè¡¨)
â”œâ”€â”€ TradingRound.java           # äº¤æ˜“å›åˆè¡¨å®ä½“
â”œâ”€â”€ DurationConfig.java         # å‘¨æœŸé…ç½®è¡¨å®ä½“
â”œâ”€â”€ RiskConfig.java            # é£æ§é…ç½®è¡¨å®ä½“
â””â”€â”€ RiskLog.java               # é£æ§æ—¥å¿—è¡¨å®ä½“

src/main/java/com/binaryoption/orderservice/mapper/
â”œâ”€â”€ OrderMapper.java + OrderMapper.xml
â”œâ”€â”€ TradingRoundMapper.java + TradingRoundMapper.xml
â”œâ”€â”€ DurationConfigMapper.java + DurationConfigMapper.xml
â”œâ”€â”€ RiskConfigMapper.java + RiskConfigMapper.xml
â””â”€â”€ RiskLogMapper.java + RiskLogMapper.xml
```

#### 11.1.3 option-admin-service å®ä½“å®ç° âœ…
```
src/main/java/com/binaryoption/adminservice/domain/
â”œâ”€â”€ Blacklist.java              # é»‘åå•è¡¨å®ä½“
â”œâ”€â”€ AdminOperationLog.java      # ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨å®ä½“
â”œâ”€â”€ GlobalConfig.java           # å…¨å±€é…ç½®è¡¨å®ä½“
â”œâ”€â”€ DailyStats.java            # æ¯æ—¥ç»Ÿè®¡è¡¨å®ä½“
â””â”€â”€ HourlyStats.java           # æ¯å°æ—¶ç»Ÿè®¡è¡¨å®ä½“

src/main/java/com/binaryoption/adminservice/mapper/
â”œâ”€â”€ BlacklistMapper.java + BlacklistMapper.xml
â”œâ”€â”€ AdminOperationLogMapper.java + AdminOperationLogMapper.xml
â”œâ”€â”€ GlobalConfigMapper.java + GlobalConfigMapper.xml
â”œâ”€â”€ DailyStatsMapper.java + DailyStatsMapper.xml
â””â”€â”€ HourlyStatsMapper.java + HourlyStatsMapper.xml
```

### 11.2 MyBatisæ˜ å°„ç‰¹ç‚¹

#### 11.2.1 å¤æ‚æŸ¥è¯¢æ”¯æŒ
- **åŠ¨æ€SQLæŸ¥è¯¢**ï¼šæ”¯æŒæ¡ä»¶æŸ¥è¯¢ã€åˆ†é¡µæŸ¥è¯¢ã€æ—¶é—´èŒƒå›´æŸ¥è¯¢
- **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡æ’å…¥ã€æ‰¹é‡æ›´æ–°ã€æ‰¹é‡åˆ é™¤
- **ç»Ÿè®¡èšåˆ**ï¼šæ”¯æŒCOUNTã€SUMã€AVGç­‰èšåˆæŸ¥è¯¢
- **å…³è”æŸ¥è¯¢**ï¼šæ”¯æŒå¤šè¡¨å…³è”å’Œå­æŸ¥è¯¢

#### 11.2.2 æ ¸å¿ƒä¸šåŠ¡åœºæ™¯æ˜ å°„
```xml
<!-- èµ„é‡‘æ“ä½œçš„åŸå­æ€§æ›´æ–° -->
<update id="updateBalance">
    UPDATE account
    SET 
        balance = balance + #{balanceChange},
        frozen_balance = frozen_balance + #{frozenChange},
        update_time = NOW()
    WHERE id = #{id}
</update>

<!-- é£æ§æ—¥å¿—çš„å¤åˆæ¡ä»¶æŸ¥è¯¢ -->
<select id="findByConditions" resultMap="AdminOperationLogResultMap">
    SELECT * FROM admin_operation_log
    <where>
        <if test="operatorId != null">AND operator_id = #{operatorId}</if>
        <if test="operationType != null">AND operation_type = #{operationType}</if>
        <if test="startTime != null">AND create_time >= #{startTime}</if>
        <if test="endTime != null">AND create_time <= #{endTime}</if>
    </where>
    ORDER BY create_time DESC
    LIMIT #{limit} OFFSET #{offset}
</select>
```

### 11.3 ç¼–è¯‘éªŒè¯
```bash
# æœ€æ–°ç¼–è¯‘çŠ¶æ€
mvn clean compile -DskipTests
[INFO] BUILD SUCCESS
[INFO] Total time: 2.728 s

# ç¼–è¯‘ç»Ÿè®¡
- option-common-service: 15ä¸ªæºæ–‡ä»¶ç¼–è¯‘æˆåŠŸ
- option-order-service: 17ä¸ªæºæ–‡ä»¶ç¼–è¯‘æˆåŠŸ  
- option-admin-service: 15ä¸ªæºæ–‡ä»¶ç¼–è¯‘æˆåŠŸ
- æ‰€æœ‰Mapper XMLæ–‡ä»¶åŠ è½½æ­£å¸¸
```

### 11.4 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
```sql
-- ä½ç½®ï¼šdatabase/init.sql
-- åŒ…å«14å¼ è¡¨çš„å®Œæ•´DDLè¯­å¥
-- åŒ…å«åŸºç¡€é…ç½®æ•°æ®çš„INSERTè¯­å¥
-- æ”¯æŒä¸€é”®åˆå§‹åŒ–æ•´ä¸ªæ•°æ®åº“ç»“æ„
```

### 11.5 ä¸‹ä¸€é˜¶æ®µå¼€å‘é‡ç‚¹
1. **Serviceä¸šåŠ¡é€»è¾‘å±‚å¼€å‘**ï¼šåŸºäºå®Œæ•´çš„Mapperå®ç°å¤æ‚ä¸šåŠ¡é€»è¾‘
2. **Controlleræ¥å£å±‚å¼€å‘**ï¼šRESTful APIæ¥å£å®ç°
3. **äº‹åŠ¡ç®¡ç†**ï¼šè·¨è¡¨æ“ä½œçš„äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯
4. **ç¼“å­˜ç­–ç•¥**ï¼šRedisç¼“å­˜çš„åˆç†ä½¿ç”¨
5. **å¼‚å¸¸å¤„ç†**ï¼šç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å’Œé”™è¯¯ç å®šä¹‰

## 12. éƒ¨ç½²è¿ç»´ç®¡ç† **[æ–°å¢]**

### 12.1 è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

é¡¹ç›®æä¾›å®Œæ•´çš„ç”Ÿäº§çº§éƒ¨ç½²è„šæœ¬ï¼š

| è„šæœ¬åç§° | åŠŸèƒ½è¯´æ˜ | ä½¿ç”¨ç¤ºä¾‹ |
|---------|---------|----------|
| `start-all.sh` | å¯åŠ¨æ‰€æœ‰æœåŠ¡ | `./start-all.sh [dev/test/prod] [normal/debug]` |
| `stop-all.sh` | åœæ­¢æ‰€æœ‰æœåŠ¡ | `./stop-all.sh [force]` |
| `status.sh` | æ£€æŸ¥æœåŠ¡çŠ¶æ€ | `./status.sh` |
| `rebuild-restart.sh` | é‡æ–°æ‰“åŒ…å¹¶é‡å¯æŒ‡å®šæœåŠ¡ | `./rebuild-restart.sh option-job-executor dev` |
| `package-all.sh` | æ‰“åŒ…æ‰€æœ‰æ¨¡å— | `./package-all.sh` |

### 12.2 æœåŠ¡å¯åŠ¨é¡ºåº

ç³»ç»Ÿé‡‡ç”¨ä¾èµ–é©±åŠ¨çš„å¯åŠ¨é¡ºåºï¼š
1. **option-common-service** (8081) - åŸºç¡€ç”¨æˆ·æœåŠ¡
2. **option-order-service** (8082) - è®¢å•æœåŠ¡
3. **option-market-service** (8083) - è¡Œæƒ…æœåŠ¡  
4. **option-admin-service** (8084) - ç®¡ç†æœåŠ¡
5. **option-job-executor** (8085) - ä»»åŠ¡æ‰§è¡Œå™¨
6. **option-gateway** (8080) - APIç½‘å…³

### 12.3 ä»»åŠ¡è°ƒåº¦ç®¡ç†

#### 12.3.1 XXL-Jobç®¡ç†ä¸­å¿ƒ
- **è®¿é—®åœ°å€**: http://localhost:9090/xxl-job-admin
- **é»˜è®¤è´¦å·**: admin / 123456
- **æ‰§è¡Œå™¨æ³¨å†Œ**: option-job-executor (127.0.0.1:10000)

#### 12.3.2 æ ¸å¿ƒå®šæ—¶ä»»åŠ¡é…ç½®

| ä»»åŠ¡åç§° | Cronè¡¨è¾¾å¼ | æ‰§è¡Œé¢‘ç‡ | åŠŸèƒ½è¯´æ˜ |
|---------|-----------|----------|----------|
| dataCleanupJobHandler | `0 0 2 * * ?` | æ¯å¤©å‡Œæ™¨2ç‚¹ | æ¸…ç†è¿‡æœŸè¡Œæƒ…æ•°æ® |
| dataIntegrityJobHandler | `0 */5 * * * ?` | æ¯5åˆ†é’Ÿ | æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ |
| dailyStatsJobHandler | `0 0 1 * * ?` | æ¯å¤©å‡Œæ™¨1ç‚¹ | æ¯æ—¥ç»Ÿè®¡èšåˆ |
| hourlyStatsJobHandler | `0 5 * * * ?` | æ¯å°æ—¶ç¬¬5åˆ†é’Ÿ | å°æ—¶ç»Ÿè®¡èšåˆ |
| statsCleanupJobHandler | `0 0 3 * * ?` | æ¯å¤©å‡Œæ™¨3ç‚¹ | æ¸…ç†è¿‡æœŸç»Ÿè®¡æ•°æ® |
| orderSettlementJobHandler | `0 * * * * ?` | æ¯åˆ†é’Ÿ | è®¢å•ç»“ç®—å¤„ç† |
| orderTimeoutJobHandler | `0/30 * * * * ?` | æ¯30ç§’ | è®¢å•è¶…æ—¶å¤„ç† |
| healthCheckJobHandler | `0 */10 * * * ?` | æ¯10åˆ†é’Ÿ | ç³»ç»Ÿå¥åº·æ£€æŸ¥ |
| logCleanupJobHandler | `0 0 4 * * ?` | æ¯å¤©å‡Œæ™¨4ç‚¹ | æ—¥å¿—æ¸…ç†ä»»åŠ¡ |

#### 12.3.3 ä»»åŠ¡ç›‘æ§å’Œå‘Šè­¦
- **æ‰§è¡ŒçŠ¶æ€ç›‘æ§**: é€šè¿‡XXL-Job AdminæŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œå†å²
- **å¤±è´¥é‡è¯•æœºåˆ¶**: æ”¯æŒé…ç½®å¤±è´¥é‡è¯•æ¬¡æ•°å’Œé—´éš”
- **æ—¥å¿—ç®¡ç†**: è‡ªåŠ¨æ¸…ç†7å¤©å‰çš„æ‰§è¡Œæ—¥å¿—
- **å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥å„æœåŠ¡å¥åº·çŠ¶æ€

### 12.4 æ—¥å¿—ç®¡ç†ç­–ç•¥

#### 12.4.1 æ—¥å¿—æ–‡ä»¶ç»“æ„
```
logs/
â”œâ”€â”€ xxl-job/jobhandler/     # XXL-Jobä»»åŠ¡æ‰§è¡Œæ—¥å¿—
â”‚   â”œâ”€â”€ 2025-07-24/         # æŒ‰æ—¥æœŸç›®å½•å­˜å‚¨
â”‚   â””â”€â”€ callbacklog/        # å›è°ƒæ—¥å¿—
â”œâ”€â”€ option-job-executor.log # åº”ç”¨ä¸»æ—¥å¿—
â”œâ”€â”€ option-gateway.log      # ç½‘å…³æ—¥å¿—
â”œâ”€â”€ option-common-service.log # ç”¨æˆ·æœåŠ¡æ—¥å¿—
â”œâ”€â”€ option-order-service.log  # è®¢å•æœåŠ¡æ—¥å¿—
â”œâ”€â”€ option-market-service.log # è¡Œæƒ…æœåŠ¡æ—¥å¿—
â””â”€â”€ option-admin-service.log  # ç®¡ç†æœåŠ¡æ—¥å¿—
```

#### 12.4.2 æ—¥å¿—æ¸…ç†ç­–ç•¥
- **XXL-Jobæ—¥å¿—**: è‡ªåŠ¨æ¸…ç†7å¤©å‰çš„ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
- **åº”ç”¨æ—¥å¿—**: é€šè¿‡LogCleanupJobHandlerå®šæœŸæ¸…ç†
- **æ¸…ç†é¢‘ç‡**: æ¯å¤©å‡Œæ™¨4ç‚¹æ‰§è¡Œæ—¥å¿—æ¸…ç†ä»»åŠ¡

### 12.5 ç›‘æ§å’Œå¥åº·æ£€æŸ¥

#### 12.5.1 æœåŠ¡å¥åº·æ£€æŸ¥
æ‰€æœ‰æœåŠ¡æä¾›æ ‡å‡†çš„Spring Boot Actuatorç«¯ç‚¹ï¼š
- **å¥åº·æ£€æŸ¥**: `GET /actuator/health`
- **æœåŠ¡ä¿¡æ¯**: `GET /actuator/info`  
- **æ€§èƒ½æŒ‡æ ‡**: `GET /actuator/metrics`

#### 12.5.2 æœåŠ¡çŠ¶æ€ç›‘æ§
```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
./status.sh

# è¾“å‡ºç¤ºä¾‹ï¼š
âœ… option-common-service (PID: 1234, Port: 8081) - è¿è¡Œä¸­
âœ… option-order-service (PID: 1235, Port: 8082) - è¿è¡Œä¸­
âœ… option-market-service (PID: 1236, Port: 8083) - è¿è¡Œä¸­
âœ… option-admin-service (PID: 1237, Port: 8084) - è¿è¡Œä¸­
âœ… option-job-executor (PID: 1238, Port: 8085) - è¿è¡Œä¸­
âœ… option-gateway (PID: 1239, Port: 8080) - è¿è¡Œä¸­
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.5  
**æœ€åæ›´æ–°**: 2025å¹´7æœˆ24æ—¥  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸

### v1.5 æ›´æ–°å†…å®¹ (2025-07-24)
- âœ… **ç»Ÿä¸€ä»»åŠ¡æ‰§è¡Œå™¨æ¶æ„å®Œæˆ**ï¼š
  - æ–°å¢option-job-executoræ¨¡å—ï¼šå®Œæ•´çš„XXL-Jobé›†æˆä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ
  - å®ç°9ä¸ªæ ¸å¿ƒä»»åŠ¡å¤„ç†å™¨ï¼šæ•°æ®æ¸…ç†ã€ç»Ÿè®¡èšåˆã€è®¢å•ç»“ç®—ã€ç³»ç»Ÿç›‘æ§
  - ä»»åŠ¡æ‰§è¡Œå™¨ä¸ä¸šåŠ¡æœåŠ¡è§£è€¦ï¼šé€šè¿‡Feignå®¢æˆ·ç«¯è°ƒç”¨å†…éƒ¨æ¥å£
  - å®Œå–„çš„ä»»åŠ¡ç›‘æ§å’Œæ—¥å¿—ç®¡ç†ï¼šæ”¯æŒå¤±è´¥é‡è¯•ã€å‘Šè­¦é€šçŸ¥
- âœ… **ç”Ÿäº§çº§éƒ¨ç½²è¿ç»´ä½“ç³»**ï¼š
  - å®Œæ•´çš„è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼šstart-all.sh, stop-all.sh, status.sh, rebuild-restart.sh
  - æœåŠ¡ä¾èµ–é©±åŠ¨çš„å¯åŠ¨é¡ºåºå’Œå¥åº·æ£€æŸ¥æœºåˆ¶
  - ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†ç­–ç•¥å’Œè‡ªåŠ¨æ¸…ç†æœºåˆ¶
- âœ… **ç³»ç»Ÿæ¶æ„å®Œå–„**ï¼š
  - æ›´æ–°æ¶æ„å›¾åŒ…å«ä»»åŠ¡æ‰§è¡Œå™¨æ¨¡å—
  - å®Œå–„æœåŠ¡ç«¯å£é…ç½®å’ŒèŒè´£åˆ’åˆ†
  - æ–°å¢éƒ¨ç½²è¿ç»´ç®¡ç†ç« èŠ‚

### v1.4 æ›´æ–°å†…å®¹ (2025-07-23)
- âœ… **Gatewayä¿¡ä»»æ¨¡å¼å®‰å…¨æ¶æ„é‡æ„**ï¼š
  - é‡æ„å®‰å…¨æ¶æ„ï¼šGatewayç»Ÿä¸€JWTè®¤è¯ï¼Œä¸‹æ¸¸æœåŠ¡ä¿¡ä»»æ¨¡å¼
  - æ–°å¢GatewayTrustSecurityConfigä¿¡ä»»æ¨¡å¼å®‰å…¨é…ç½®
  - æ–°å¢UserContextå·¥å…·ç±»ï¼Œä»Headerè·å–ç”¨æˆ·ä¿¡æ¯
  - æ¡ä»¶åŒ–å®‰å…¨é…ç½®ï¼šé€šè¿‡security.modeæ§åˆ¶è®¤è¯æ¨¡å¼
  - æ›´æ–°æ‰€æœ‰APIæ¥å£ç¤ºä¾‹ï¼Œåæ˜ æ–°çš„è®¤è¯æ–¹å¼
  - ä¸­é—´ä»¶å¯é€‰ä¾èµ–ï¼šRedis ç­‰æ”¯æŒä¼˜é›…é™çº§
- âœ… **å›½é™…åŒ–æ¶ˆæ¯ç»Ÿä¸€**ï¼š
  - ä¿®å¤ä¸­è‹±æ–‡æ··åˆæ¶ˆæ¯é—®é¢˜
  - ç»Ÿä¸€ä½¿ç”¨å›½é™…åŒ–æ¶ˆæ¯ç 
  - å®‰å…¨å¼‚å¸¸æ¶ˆæ¯æ”¯æŒå¤šè¯­è¨€

### v1.3 æ›´æ–°å†…å®¹ (2025-07-23)
- âœ… **å®‰å…¨é…ç½®ç»Ÿä¸€æ¶æ„å®Œæˆ**ï¼š
  - æ–°å¢BaseSecurityConfigç»Ÿä¸€å®‰å…¨é…ç½®åŸºç±»
  - æ–°å¢æƒé™æ³¨è§£ä½“ç³»(@RequirePermissionã€@RequireRoleã€@AllowAnonymous)
  - æ–°å¢SecurityAspect AOPæƒé™éªŒè¯åˆ‡é¢
  - æ–°å¢PermissionCacheService Redisæƒé™ç¼“å­˜
  - æ–°å¢admin-serviceè§’è‰²æ§åˆ¶å®ç°
  - æ–°å¢è¯¦ç»†çš„æƒé™æ³¨è§£ä½¿ç”¨ç¤ºä¾‹å’Œæœ€ä½³å®è·µ
- âœ… **å›½é™…åŒ–æ”¯æŒæ¡†æ¶å®Œæˆ**ï¼š
  - I18nConfigé…ç½®ç±»å’ŒMessageUtilså·¥å…·ç±»
  - å¤šè¯­è¨€æ¶ˆæ¯èµ„æºæ–‡ä»¶æ”¯æŒ
  - Gatewayè¯­è¨€æ£€æµ‹å’Œä¼ é€’æœºåˆ¶