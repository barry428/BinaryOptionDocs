# 后端项目结构设计

## 1. 项目总览

二元期权交易平台采用微服务架构，基于Spring Boot和Spring Cloud构建，支持MySQL和PostgreSQL双数据库，集成BTSE API进行资金管理。

### 1.1 技术栈
- **框架**: Spring Boot 2.7.x, Spring Cloud 2021.x
- **数据库**: MySQL 8.0+ / PostgreSQL 13+
- **ORM**: MyBatis 3.5+
- **消息队列**: RocketMQ 4.9+
- **缓存**: Redis 6.0+
- **任务调度**: XXL-JOB
- **API网关**: Spring Cloud Gateway
- **服务注册**: Nacos
- **监控**: Spring Boot Actuator
- **文档**: Swagger/OpenAPI 3

### 1.2 架构特点
- 微服务架构，职责分离，独立部署
- 双数据库支持(MySQL/PostgreSQL)
- BTSE API集成，支持Mock模式
- 完整的测试体系
- 国际化支持(中英日韩)

## 2. 项目根目录结构
```
BinaryOption/
├── docs/                           # 项目文档
├── FE/                            # 前端项目
├── logs/                          # 运行日志
├── sql/                           # 数据库脚本
├── test-scripts/                  # 自动化测试脚本
├── option-parent/                 # Maven父项目
├── option-gateway/                # API网关服务
├── option-common-service/         # 公共服务（账户、BTSE）
├── option-order-service/          # 订单服务
├── option-market-service/         # 行情服务
├── option-admin-service/          # 管理后台服务
├── option-job-executor/           # 定时任务执行器
├── option-common-dto/             # 公共DTO
├── option-common-utils/           # 公共工具类
├── option-security-base/          # 安全基础组件
├── option-xxl-job/                # XXL-JOB任务调度
├── package-all.sh                 # 打包脚本
├── start-all.sh                   # 启动脚本
├── stop-all.sh                    # 停止脚本
└── CLAUDE.md                      # 项目记忆文档
```

## 3. 微服务模块设计

### 3.1 option-gateway (API网关)
**端口**: 8080  
**作用**: 统一入口，路由转发，认证鉴权

```
option-gateway/
├── pom.xml
└── src/main/
    ├── java/com/binaryoption/gateway/
    │   └── GatewayApplication.java      # 启动类
    └── resources/
        ├── application.yml              # 主配置
        └── bootstrap.yml               # 引导配置
```

### 3.2 option-common-service (公共服务)
**端口**: 8081  
**核心功能**: 账户管理、BTSE集成、用户管理

```
option-common-service/
├── pom.xml
└── src/main/
    ├── java/com/binaryoption/commonservice/
    │   ├── Application.java
    │   ├── config/                      # 配置类
    │   │   ├── AsyncTransferConfig.java
    │   │   ├── BtseIntegrationConfig.java
    │   │   ├── SecurityConfig.java
    │   │   └── SwaggerConfig.java
    │   ├── controller/                  # REST控制器
    │   │   ├── AccountController.java
    │   │   ├── BtseAuthController.java
    │   │   ├── BtseMonitoringController.java
    │   │   ├── UserController.java
    │   │   └── UserTransferConfigController.java
    │   ├── rpc/                        # RPC控制器
    │   │   ├── AccountRpcController.java
    │   │   ├── BtseTransferRpcController.java
    │   │   └── UserRpcController.java
    │   ├── service/                    # 业务服务
    │   │   ├── AccountService.java
    │   │   ├── BtseTransferService.java
    │   │   ├── BtseUserAuthService.java
    │   │   ├── UserService.java
    │   │   └── UserTransferConfigService.java
    │   ├── integration/               # 外部系统集成
    │   │   ├── BtseApiClient.java
    │   │   ├── BtseApiClientImpl.java
    │   │   ├── BtseMockApiClient.java
    │   │   └── BtseDataConverter.java
    │   ├── domain/                    # 数据模型
    │   │   ├── Account.java
    │   │   ├── AccountTransaction.java
    │   │   ├── BtseTransferLog.java
    │   │   ├── GlobalConfig.java
    │   │   └── User.java
    │   └── mapper/                    # MyBatis映射器
    │       ├── AccountMapper.java
    │       ├── AccountTransactionMapper.java
    │       ├── BtseTransferLogMapper.java
    │       ├── GlobalConfigMapper.java
    │       └── UserMapper.java
    └── resources/
        ├── application.yml             # 主配置(MySQL)
        ├── application-postgresql.yml  # PostgreSQL配置
        ├── application-btse-transfer.yml
        ├── bootstrap.yml
        ├── btse-field-mapping.yml
        ├── i18n/                      # 国际化
        │   ├── messages.properties
        │   ├── messages_en.properties
        │   ├── messages_ja.properties
        │   └── messages_zh_CN.properties
        └── mapper/                    # MyBatis XML映射
            ├── AccountMapper.xml
            ├── AccountTransactionMapper.xml
            ├── BtseTransferLogMapper.xml
            ├── GlobalConfigMapper.xml
            ├── SymbolConfigMapper.xml
            └── UserMapper.xml
```

### 3.3 option-order-service (订单服务)
**端口**: 8082  
**核心功能**: 订单管理、风控、交易轮次、结算

```
option-order-service/
├── pom.xml
└── src/main/
    ├── java/com/binaryoption/orderservice/
    │   ├── Application.java
    │   ├── config/                    # 配置类
    │   │   ├── SecurityConfig.java
    │   │   └── SwaggerConfig.java
    │   ├── controller/                # REST控制器
    │   │   ├── OrderController.java
    │   │   ├── RiskController.java
    │   │   └── TradingController.java
    │   ├── rpc/                      # RPC控制器
    │   │   ├── OrderRpcController.java
    │   │   ├── RiskRpcController.java
    │   │   └── TradingRpcController.java
    │   ├── service/                  # 业务服务
    │   │   ├── OrderService.java
    │   │   ├── RiskService.java
    │   │   ├── SettlementService.java
    │   │   └── TradingRoundService.java
    │   ├── domain/                   # 数据模型
    │   │   ├── Order.java
    │   │   ├── TradingRound.java
    │   │   ├── RiskConfig.java
    │   │   ├── RiskLog.java
    │   │   └── DurationConfig.java
    │   ├── mapper/                   # MyBatis映射器
    │   │   ├── OrderMapper.java
    │   │   ├── TradingRoundMapper.java
    │   │   ├── RiskConfigMapper.java
    │   │   ├── RiskLogMapper.java
    │   │   └── DurationConfigMapper.java
    │   └── client/                   # 外部服务客户端
    │       ├── CommonServiceClient.java
    │       ├── MarketServiceClient.java
    │       └── BtseTransferRpcClient.java
    └── resources/
        ├── application.yml           # 主配置(MySQL)
        ├── application-postgresql.yml # PostgreSQL配置
        ├── bootstrap.yml
        ├── i18n/                    # 国际化
        └── mapper/                  # MyBatis XML映射
            ├── OrderMapper.xml
            ├── TradingRoundMapper.xml
            ├── RiskConfigMapper.xml
            ├── RiskLogMapper.xml
            └── DurationConfigMapper.xml
```

### 3.4 option-market-service (行情服务)
**端口**: 8083  
**核心功能**: 行情数据、价格源管理、WebSocket推送

### 3.5 option-admin-service (管理后台服务)
**端口**: 8084  
**核心功能**: 后台管理、用户管理、系统配置、报表统计

### 3.6 option-job-executor (定时任务执行器)
**端口**: 8085  
**核心功能**: 定时任务执行、结算任务、补偿任务

## 4. 公共模块设计

### 4.1 option-common-dto (公共DTO)
```
option-common-dto/
├── pom.xml
└── src/main/java/com/binaryoption/commondto/
    ├── account/              # 账户相关DTO
    ├── admin/               # 管理相关DTO
    ├── btse/                # BTSE相关DTO
    ├── common/              # 通用DTO
    ├── config/              # 配置相关DTO
    ├── order/               # 订单相关DTO
    ├── risk/                # 风控相关DTO
    ├── stats/               # 统计相关DTO
    ├── symbol/              # 交易品种相关DTO
    ├── trading/             # 交易相关DTO
    └── user/                # 用户相关DTO
```

### 4.2 option-common-utils (公共工具类)
```
option-common-utils/
├── pom.xml
└── src/main/java/com/binaryoption/commonutils/
    ├── exception/           # 异常处理
    ├── validator/           # 参数校验
    ├── btse/               # BTSE工具类
    ├── security/           # 安全工具类
    └── util/               # 通用工具类
```

### 4.3 option-security-base (安全基础组件)
```
option-security-base/
├── pom.xml
└── src/main/java/com/binaryoption/securitybase/
    ├── AuthUserUtil.java
    ├── CustomUserDetails.java
    ├── JwtAuthenticationFilter.java
    └── filter/
```

## 5. 代码规范与约定

### 5.1 包结构规范
```
com.binaryoption.{servicename}/
├── config/                 # 配置类
├── controller/             # REST控制器（对外API）
├── rpc/                   # RPC控制器（内部服务调用）
├── service/               # 业务服务层
├── domain/                # 数据模型（实体类）
├── mapper/                # MyBatis映射器接口
├── client/                # 外部服务客户端
├── integration/           # 第三方系统集成
├── exception/             # 异常处理
└── util/                  # 工具类
```

### 5.2 命名规范

#### 5.2.1 类命名
- **Controller**: `XxxController` (REST API) 或 `XxxRpcController` (RPC)
- **Service**: `XxxService`
- **Domain**: 实体名，如 `User`, `Order`, `Account`
- **DTO**: `XxxDTO`, `XxxRequestDTO`, `XxxResponseDTO`, `XxxVO`
- **Mapper**: `XxxMapper`
- **Config**: `XxxConfig`

#### 5.2.2 方法命名
- **查询**: `find`, `get`, `query`, `list`
- **新增**: `create`, `add`, `insert`
- **更新**: `update`, `modify`
- **删除**: `delete`, `remove`
- **校验**: `validate`, `check`

### 5.3 配置文件规范

#### 5.3.1 多环境配置
```
resources/
├── application.yml              # 主配置(默认MySQL)
├── application-postgresql.yml   # PostgreSQL配置
├── application-dev.yml         # 开发环境
├── application-test.yml        # 测试环境
├── application-prod.yml        # 生产环境
└── bootstrap.yml              # 引导配置(Nacos等)
```

#### 5.3.2 数据库支持
- 使用MyBatis的`databaseId`机制支持MySQL和PostgreSQL
- XML映射文件中区分数据库特定SQL:
```xml
<insert id="insert" databaseId="mysql">...</insert>
<insert id="insert" databaseId="postgresql">...</insert>
```

### 5.4 异常处理规范

#### 5.4.1 异常类型
- **BusinessException**: 业务异常
- **SystemException**: 系统异常  
- **ValidationException**: 参数校验异常

#### 5.4.2 异常处理
```java
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<String> handleBusinessException(BusinessException e) {
        log.error("业务异常: {}", e.getMessage());
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public Result<String> handleException(Exception e) {
        log.error("系统异常: {}", e.getMessage());
        return Result.error("SYSTEM_ERROR", "系统异常");
    }
}
```

### 5.5 日志规范

#### 5.5.1 日志级别
- **ERROR**: 系统错误、业务异常
- **WARN**: 警告信息、重要业务事件
- **INFO**: 关键业务流程、状态变更
- **DEBUG**: 调试信息

#### 5.5.2 日志格式
```java
// 业务日志
log.info("订单创建成功，用户：{}，订单：{}，金额：{}", userId, orderId, amount);

// 异常日志（简化版，避免大段堆栈）
log.error("BTSE转账失败，用户：{}，金额：{}，错误：{}", userId, amount, e.getMessage());

// 调试日志
log.debug("🔍 开始处理BTSE转账，用户：{}，金额：{}", userId, amount);
```

### 5.6 数据库设计规范

#### 5.6.1 表命名
- 小写字母，下划线分隔
- 业务模块前缀: `user_`, `order_`, `btse_`, `risk_`

#### 5.6.2 字段规范
- **主键**: `id` (BIGINT AUTO_INCREMENT)
- **创建时间**: `create_time` (DATETIME)
- **更新时间**: `update_time` (DATETIME, ON UPDATE CURRENT_TIMESTAMP)
- **逻辑删除**: `is_deleted` (TINYINT, 0:未删除 1:已删除)
- **状态字段**: 使用VARCHAR存储状态码

### 5.7 API设计规范

#### 5.7.1 REST API
```
GET    /api/orders          # 查询列表
GET    /api/orders/{id}     # 查询详情
POST   /api/orders          # 创建
PUT    /api/orders/{id}     # 更新
DELETE /api/orders/{id}     # 删除
```

#### 5.7.2 RPC API
```
POST /rpc/order/create          # 创建订单
POST /rpc/order/settle          # 订单结算
GET  /rpc/order/{id}            # 查询订单
POST /rpc/btse/transfer         # BTSE转账
```

#### 5.7.3 响应格式
```json
{
    "code": 200,
    "message": "success",
    "data": {},
    "success": true,
    "error": false
}
```

## 6. 部署与运维

### 6.1 部署脚本
```bash
# 启动所有服务
./start-all.sh

# 停止所有服务  
./stop-all.sh

# 检查服务状态
./status.sh

# 重新构建并重启
./rebuild-restart.sh
```

### 6.2 服务端口分配
| 服务 | 端口 | 说明 |
|-----|------|------|
| option-gateway | 8080 | API网关 |
| option-common-service | 8081 | 公共服务 |
| option-order-service | 8082 | 订单服务 |
| option-market-service | 8083 | 行情服务 |
| option-admin-service | 8084 | 管理后台 |
| option-job-executor | 8085 | 任务执行器 |

### 6.3 监控与日志
- **日志路径**: `logs/`目录下各服务日志
- **健康检查**: `/actuator/health`
- **指标监控**: `/actuator/metrics`

## 7. 测试规范

### 7.1 测试脚本结构
```
test-scripts/
├── modules/                # 模块化测试
│   ├── auth/              # 认证测试
│   ├── account/           # 账户测试  
│   ├── order/             # 订单测试
│   ├── market/            # 行情测试
│   └── rpc/               # RPC测试
├── flows/                 # 流程测试
├── integration/           # 集成测试
├── utils/                 # 测试工具
└── simple-flow-test.sh    # 简单流程测试
```

### 7.2 测试数据管理
- 使用脚本自动化创建测试数据
- 支持MySQL和PostgreSQL双数据库测试
- 提供数据清理和重置功能

## 8. BTSE集成设计

### 8.1 BTSE服务架构
```
BtseTransferService          # 主要业务服务
├── BtseApiClient           # API客户端接口
├── BtseApiClientImpl       # 真实API实现
├── BtseMockApiClient       # Mock实现
└── BtseDataConverter       # 数据转换器
```

### 8.2 资金流向设计
- **DEMO账户**: balance ↔ frozen_balance（本地流转）
- **REAL账户**: BTSE ↔ frozen_balance（绕过balance字段）

### 8.3 订单状态机
```
PENDING → ACTIVE → WIN/LOSE/DRAW
   ↓         ↓
CANCELLED  CANCELLED
```

### 8.4 结算差异
- **DEMO**: 资金回到balance
- **REAL**: 盈利转出到BTSE，亏损扣除frozen_balance

## 9. 总结

本项目采用清晰的微服务架构，职责分离，模块化设计：

1. **网关层**: 统一入口，路由分发
2. **业务层**: 各微服务独立部署，功能内聚
3. **数据层**: 支持MySQL/PostgreSQL，读写分离
4. **集成层**: BTSE API集成，Mock支持
5. **任务层**: XXL-JOB调度，异步处理

代码规范完整，支持多环境部署，具备完善的测试体系和监控机制。
