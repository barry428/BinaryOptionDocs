# 二元期权平台业务流程设计（流程图版）

> 文档版本: v1.9  
> 最后更新: 2025-08-06  

## 概述

本文档展示二元期权平台的核心业务流程图，包括用户注册登录、交易下单、自动结算和补偿机制等关键流程。

## 1. 用户创建和登录流程

### 1.1 流程图

```mermaid
sequenceDiagram
    participant U as 用户
    participant G as Gateway
    participant C as Common-Service
    participant B as BTSE-API
    participant DB as Database

    U->>G: 登录请求(BTSE Token)
    G->>C: 转发登录请求
    C->>B: 验证BTSE用户认证
    alt BTSE认证成功
        B->>C: 返回用户信息
        C->>DB: 查询本地用户
        alt 用户不存在
            C->>B: 获取BTSE用户详情
            C->>DB: 创建用户记录
            C->>DB: 创建默认账户(实盘+模拟)
        end
        C->>C: 生成本地JWT Token
        C->>G: 返回登录成功
        G->>U: 登录成功(JWT Token)
    else BTSE认证失败
        B->>C: 认证失败
        C->>G: 返回认证失败错误
        G->>U: 登录失败
    end
```

### 1.2 核心特点
- 支持本地注册和BTSE认证双模式
- 自动创建DEMO和REAL两种账户类型（余额初始为0）
- DEMO账户可领取体验金，REAL账户需BTSE充值

---

## 2. 下单交易流程

### 2.1 流程图

```mermaid
sequenceDiagram
    participant U as 用户
    participant G as Gateway
    participant O as Order-Service
    participant C as Common-Service
    participant B as BTSE-API
    participant DB as Database

    U->>G: 下单请求
    G->>O: 转发下单请求
    O->>O: 风控校验
    alt 风控通过
        alt DEMO账户
            O->>C: 检查本地余额
            alt 余额充足
                O->>C: 冻结资金
                O->>DB: 创建订单(状态:ACTIVE)
                O->>G: 返回下单成功
                G->>U: 下单成功
            else 余额不足
                O->>G: 返回余额不足错误
                G->>U: 下单失败
            end
        else REAL账户
            O->>DB: 创建预订单(状态:PENDING)
            O->>B: 查询BTSE账户余额
            alt BTSE余额充足
                O->>B: 执行BTSE划转(转入)
                alt 划转成功
                    O->>C: 增加冻结余额
                    O->>DB: 更新订单状态为ACTIVE
                    O->>DB: 记录BTSE转入流水
                    O->>G: 返回下单成功
                    G->>U: 下单成功
                else 划转失败
                    O->>DB: 更新订单状态为CANCELLED
                    O->>G: 返回划转失败错误
                    G->>U: 下单失败
                end
            else BTSE余额不足
                O->>DB: 更新订单状态为CANCELLED
                O->>G: 返回余额不足错误
                G->>U: 下单失败
            end
        end
    else 风控拦截
        O->>DB: 记录风控日志
        O->>G: 返回风控错误
        G->>U: 下单失败
    end
```

### 2.2 资金流向差异

**DEMO账户**：
- balance → frozen_balance（直接ACTIVE订单）

**REAL账户**：
- BTSE → frozen_balance（先PENDING，后ACTIVE）
- 使用预订单ID确保幂等性

---

## 3. 自动结算流程

### 3.1 流程图

```mermaid
sequenceDiagram
    participant S as 调度任务
    participant O as Order-Service
    participant C as Common-Service
    participant M as Market-Service
    participant B as BTSE-API
    participant DB as Database

    S->>O: 定时触发结算
    O->>DB: 查询待结算回合
    loop 每个回合
        O->>M: 获取结算价格
        O->>DB: 查询回合内ACTIVE状态订单
        loop 每个订单
            O->>O: 计算盈亏
            alt DEMO账户
                alt 盈利
                    O->>O: 计算手续费(10%)
                    O->>C: 解冻资金+派奖到balance
                else 亏损
                    O->>C: 扣除冻结资金
                else 平局
                    O->>C: 退还冻结资金到balance
                end
                O->>DB: 更新订单状态(WIN/LOSE/DRAW)
                O->>C: 记录资金流水
            else REAL账户
                alt 盈利
                    O->>O: 计算手续费(10%)
                    O->>C: 扣除冻结资金
                    O->>B: 执行BTSE划转(转出净利润)
                    O->>DB: 记录BTSE转出流水
                else 亏损
                    O->>C: 扣除冻结资金
                else 平局
                    O->>C: 扣除冻结资金
                    O->>B: 执行BTSE划转(转出本金)
                    O->>DB: 记录BTSE转出流水
                end
                O->>DB: 更新订单状态(WIN/LOSE/DRAW)
                O->>C: 记录资金流水
            end
        end
        O->>DB: 更新回合状态为已结算
    end
```

### 3.2 结算差异

**DEMO账户**：
- WIN：扣除frozen_balance，全部收益转balance
- LOSE：扣除frozen_balance
- DRAW：frozen_balance → balance (退还本金)

**REAL账户**：
- WIN：扣除frozen_balance，全部收益转BTSE
- LOSE：扣除frozen_balance
- DRAW：扣除frozen_balance，本金转BTSE

---

## 4. 订单状态流转

### 4.1 状态流转图

```mermaid
stateDiagram-v2
    [*] --> PENDING : REAL账户创建预订单
    [*] --> ACTIVE : DEMO账户直接下单
    PENDING --> ACTIVE : BTSE划转成功(补偿机制)
    PENDING --> CANCELLED : BTSE划转失败/超时(补偿机制)
    ACTIVE --> CANCELLED : 撤单(锁单前)
    ACTIVE --> WIN : 结算盈利
    ACTIVE --> LOSE : 结算亏损  
    ACTIVE --> DRAW : 结算平局
    WIN --> [*]
    LOSE --> [*]
    DRAW --> [*]
    CANCELLED --> [*]
```

### 4.2 状态说明

| 状态 | 含义 | 触发条件 | 后续状态 |
|------|------|----------|----------|
| PENDING | 待确认 | REAL账户创建预订单 | ACTIVE/CANCELLED |
| ACTIVE | 进行中 | DEMO下单或REAL划转成功 | WIN/LOSE/DRAW/CANCELLED |
| WIN | 盈利 | 结算时用户预测正确 | 终态 |
| LOSE | 亏损 | 结算时用户预测错误 | 终态 |
| DRAW | 平局 | 结算价格等于下单价格 | 终态 |
| CANCELLED | 已撤销 | 划转失败/超时/用户撤单 | 终态 |

---

## 5. 回合管理流程

### 5.1 回合生命周期

```mermaid
stateDiagram-v2
    [*] --> OPEN : 创建回合
    OPEN --> LOCKED : 到达锁单时间
    LOCKED --> SETTLED : 结算完成
    SETTLED --> [*]
```

### 5.2 回合重叠机制
- **5分钟回合**：每1分钟创建新回合，同时存在5个重叠回合
- **15分钟回合**：每3分钟创建新回合，同时存在5个重叠回合
- **30分钟回合**：每6分钟创建新回合，同时存在5个重叠回合

---

## 6. 风控处理流程

### 6.1 风控检查流程

```mermaid
flowchart TD
    A[下单请求] --> B[用户状态检查]
    B --> C{用户正常?}
    C -->|否| D[记录风控日志]
    C -->|是| E[金额限制检查]
    E --> F{金额合规?}
    F -->|否| D
    F -->|是| G[频次限制检查]
    G --> H{频次合规?}
    H -->|否| D
    H -->|是| I[黑名单检查]
    I --> J{在黑名单?}
    J -->|是| D
    J -->|否| K[风控通过]
    D --> L[阻断交易]
    K --> M[继续交易流程]
```

### 6.2 风控限制规则
**金额限制**：
- 单笔最小金额：10 USDT
- 单笔最大金额：10,000 USDT
- 日累计限额：50,000 USDT

**频次限制**：
- 每分钟最多5笔订单
- 每小时最多100笔订单

---

## 7. 补偿机制流程

### 7.1 PENDING订单补偿流程

```mermaid
flowchart TD
    A[定时任务/RPC触发] --> B[查询PENDING订单]
    B --> C{订单存在?}
    C -->|否| D[结束]
    C -->|是| E[检查订单创建时间]
    E --> F{超过5秒?}
    F -->|否| G[跳过]
    F -->|是| H[尝试BTSE转入]
    H --> I{转账成功?}
    I -->|是| J[增加frozen_balance]
    J --> K[更新订单为ACTIVE]
    I -->|否| L[更新订单为CANCELLED]
    L --> M[记录失败原因]
```

### 7.2 补偿机制特点
- **触发方式**：RPC接口、定时任务、手动触发
- **处理策略**：转账成功→ACTIVE，转账失败→CANCELLED
- **超时设置**：5秒超时检测
- **适用范围**：仅REAL账户（DEMO账户不会有PENDING订单）

---

## 8. 异常处理流程

### 8.1 BTSE API异常处理

```mermaid
flowchart TD
    A[BTSE API调用] --> B{调用成功?}
    B -->|是| C[正常处理]
    B -->|否| D[记录异常日志]
    D --> E{重要操作?}
    E -->|是| F[发送告警]
    E -->|否| G[使用降级策略]
    F --> H[人工介入]
    G --> I[继续处理]
```

### 8.2 数据一致性策略
- **下单时划转失败**：直接返回失败，不创建订单
- **结算时转出失败**：资金保留在平台，记录异常待处理
- **补偿机制**：定时任务重试失败的转账操作

---

## 业务流程总结

### 核心设计原则
1. **账户隔离**：DEMO和REAL账户完全独立
2. **状态机管理**：订单状态严格按流程流转
3. **补偿机制**：确保数据最终一致性
4. **风控优先**：多层风控检查保障系统安全

### 关键流程节点
1. **下单阶段**：DEMO直接ACTIVE，REAL先PENDING
2. **补偿阶段**：PENDING尝试完成BTSE转账
3. **结算阶段**：只处理ACTIVE订单，按账户类型差异化处理

### 资金安全保障
- 预订单机制确保资金安全
- Client Transfer ID保证幂等性
- 补偿机制处理异常情况
- 完整的审计日志记录

---

**文档版本**: v1.9  
**最后更新**: 2025年8月06日  
**维护者**: Barry  