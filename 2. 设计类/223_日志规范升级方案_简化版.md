# 日志规范升级方案（简化版）

## 1. 升级目标
解决当前最紧急的两个问题：
1. **防止磁盘爆满** - 添加日志轮转
2. **监控JVM性能** - 添加GC日志

## 2. 需要修改的文件清单

### 2.1 创建新文件（4个）

#### 文件1: `option-common-service/src/main/resources/logback-spring.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <property name="LOG_PATH" value="/var/log/binaryoption"/>
    <property name="APP_NAME" value="option-common-service"/>
    
    <!-- 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 文件输出（带轮转） -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APP_NAME}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${APP_NAME}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 环境配置 -->
    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
        <logger name="com.binaryoption" level="DEBUG"/>
    </springProfile>
    
    <springProfile name="staging,production">
        <root level="WARN">
            <appender-ref ref="FILE"/>
        </root>
        <logger name="com.binaryoption" level="INFO"/>
    </springProfile>
</configuration>
```

#### 文件2: `option-order-service/src/main/resources/logback-spring.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <property name="LOG_PATH" value="/var/log/binaryoption"/>
    <property name="APP_NAME" value="option-order-service"/>
    
    <!-- 与common-service相同的配置，只需修改APP_NAME -->
    <!-- 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 文件输出（带轮转） -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APP_NAME}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${APP_NAME}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 环境配置 -->
    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
        <logger name="com.binaryoption" level="DEBUG"/>
    </springProfile>
    
    <springProfile name="staging,production">
        <root level="WARN">
            <appender-ref ref="FILE"/>
        </root>
        <logger name="com.binaryoption" level="INFO"/>
    </springProfile>
</configuration>
```

#### 文件3: `option-market-service/src/main/resources/logback-spring.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <property name="LOG_PATH" value="/var/log/binaryoption"/>
    <property name="APP_NAME" value="option-market-service"/>
    
    <!-- 与上面相同配置，APP_NAME改为option-market-service -->
    <!-- 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 文件输出（带轮转） -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APP_NAME}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${APP_NAME}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 环境配置 -->
    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
        <logger name="com.binaryoption" level="DEBUG"/>
    </springProfile>
    
    <springProfile name="staging,production">
        <root level="WARN">
            <appender-ref ref="FILE"/>
        </root>
        <logger name="com.binaryoption" level="INFO"/>
    </springProfile>
</configuration>
```

#### 文件4: `option-gateway/src/main/resources/logback-spring.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <property name="LOG_PATH" value="/var/log/binaryoption"/>
    <property name="APP_NAME" value="option-gateway"/>
    
    <!-- 与上面相同配置，APP_NAME改为option-gateway -->
    <!-- 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 文件输出（带轮转） -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${APP_NAME}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${APP_NAME}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 环境配置 -->
    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
        <logger name="org.springframework.cloud.gateway" level="DEBUG"/>
    </springProfile>
    
    <springProfile name="staging,production">
        <root level="WARN">
            <appender-ref ref="FILE"/>
        </root>
        <logger name="org.springframework.cloud.gateway" level="INFO"/>
    </springProfile>
</configuration>
```

### 2.2 修改现有文件（2个）

#### 文件5: `docker-compose.yml`
在每个服务中添加JAVA_OPTS环境变量，配置GC日志：

```yaml
services:
  option-gateway:
    # ... 现有配置 ...
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-staging}
      # 添加下面这行
      - JAVA_OPTS=-Xms256m -Xmx512m -Xlog:gc*:file=/var/log/binaryoption/gc-gateway.log:time,uptime,level,tags:filecount=5,filesize=10M
    volumes:
      # 确保有日志目录挂载
      - ./logs:/var/log/binaryoption
      
  option-common-service:
    # ... 现有配置 ...
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-staging}
      # 添加下面这行
      - JAVA_OPTS=-Xms256m -Xmx512m -Xlog:gc*:file=/var/log/binaryoption/gc-common.log:time,uptime,level,tags:filecount=5,filesize=10M
    volumes:
      # 确保有日志目录挂载
      - ./logs:/var/log/binaryoption
      
  option-order-service:
    # ... 现有配置 ...
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-staging}
      # 添加下面这行
      - JAVA_OPTS=-Xms256m -Xmx512m -Xlog:gc*:file=/var/log/binaryoption/gc-order.log:time,uptime,level,tags:filecount=5,filesize=10M
    volumes:
      # 确保有日志目录挂载
      - ./logs:/var/log/binaryoption
      
  option-market-service:
    # ... 现有配置 ...
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-staging}
      # 添加下面这行
      - JAVA_OPTS=-Xms256m -Xmx512m -Xlog:gc*:file=/var/log/binaryoption/gc-market.log:time,uptime,level,tags:filecount=5,filesize=10M
    volumes:
      # 确保有日志目录挂载
      - ./logs:/var/log/binaryoption
```

#### 文件6: `docker-compose.production.yml`
同样添加JAVA_OPTS，但使用生产环境的内存配置：

```yaml
services:
  option-gateway:
    environment:
      - SPRING_PROFILES_ACTIVE=production
      # 生产环境使用更大的内存
      - JAVA_OPTS=-Xms512m -Xmx1024m -Xlog:gc*:file=/var/log/binaryoption/gc-gateway.log:time,uptime,level,tags:filecount=10,filesize=10M
    volumes:
      - /data/logs/binaryoption:/var/log/binaryoption
      
  option-common-service:
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - JAVA_OPTS=-Xms512m -Xmx1024m -Xlog:gc*:file=/var/log/binaryoption/gc-common.log:time,uptime,level,tags:filecount=10,filesize=10M
    volumes:
      - /data/logs/binaryoption:/var/log/binaryoption
      
  option-order-service:
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - JAVA_OPTS=-Xms512m -Xmx1024m -Xlog:gc*:file=/var/log/binaryoption/gc-order.log:time,uptime,level,tags:filecount=10,filesize=10M
    volumes:
      - /data/logs/binaryoption:/var/log/binaryoption
      
  option-market-service:
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - JAVA_OPTS=-Xms512m -Xmx1024m -Xlog:gc*:file=/var/log/binaryoption/gc-market.log:time,uptime,level,tags:filecount=10,filesize=10M
    volumes:
      - /data/logs/binaryoption:/var/log/binaryoption
```

### 2.3 删除或注释的配置

需要在各服务的`application-*.yml`中删除或注释掉原有的logging配置：

```yaml
# 注释掉以下配置（因为改用logback-spring.xml）
# logging:
#   level:
#     com.binaryoption: INFO
#     root: WARN
#   pattern:
#     console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
#   file:
#     name: /var/log/binaryoption/option-xxx-service.log
```

## 3. 实施步骤

### 步骤1：创建日志目录
```bash
# 在宿主机上创建日志目录
mkdir -p ./logs
chmod 755 ./logs
```

### 步骤2：添加logback配置文件
按照上面的模板，在每个服务的`src/main/resources/`目录下创建`logback-spring.xml`

### 步骤3：修改docker-compose文件
添加JAVA_OPTS环境变量和volumes挂载

### 步骤4：重启服务
```bash
docker-compose down
docker-compose up -d
```

### 步骤5：验证
```bash
# 检查日志文件是否生成
ls -la ./logs/

# 应该看到：
# option-gateway.log
# option-common-service.log
# option-order-service.log
# option-market-service.log
# gc-gateway.log
# gc-common.log
# gc-order.log
# gc-market.log

# 检查日志轮转（等文件达到100MB后）
# 会自动生成：option-gateway.2025-09-10.1.gz
```

## 4. 配置说明

### 日志轮转配置
- **单文件大小限制**: 100MB
- **保留天数**: 30天
- **总大小限制**: 10GB
- **压缩格式**: gzip

### GC日志配置
- **文件大小**: 10MB
- **文件数量**: 5个（循环使用）
- **记录内容**: GC时间、类型、内存变化

## 5. 注意事项

1. **确保日志目录权限正确**，容器需要有写权限
2. **定期清理旧日志**，虽然配置了自动清理，但建议定期检查
3. **监控磁盘空间**，避免日志占满磁盘
4. **生产环境建议使用独立的日志分区**

## 6. 回滚方案

如果出现问题，可以快速回滚：

1. 删除`logback-spring.xml`文件
2. 恢复`application-*.yml`中的logging配置
3. 从docker-compose.yml中移除JAVA_OPTS
4. 重启服务

## 7. 总结

通过这个简化方案，我们可以：
- ✅ 解决日志文件无限增长问题（通过日志轮转）
- ✅ 监控JVM性能（通过GC日志）
- ✅ 最小化改动，降低风险
- ✅ 快速实施（预计2小时完成）