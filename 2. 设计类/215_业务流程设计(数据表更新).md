# 业务流程设计 - 数据表更新流程

本文档描述二元期权交易系统中两个核心API接口的业务流程和相关数据表更新操作。

## 1. API接口概览

### 1.1 轮次查询接口
- **接口路径**: `{{API_URL}}/public/order/round/current/1`
- **请求方法**: GET
- **功能**: 查询指定交易对的当前活跃轮次信息
- **认证**: 无需登录认证（公开接口）

### 1.2 订单创建接口
- **接口路径**: `{{API_URL}}/order`
- **请求方法**: POST
- **功能**: 创建二元期权交易订单
- **认证**: 需要用户登录认证

## 2. 轮次查询业务流程

### 2.1 业务逻辑流程

```
用户请求 → 获取交易对信息 → 获取启用的周期配置 → 创建/更新轮次 → 返回轮次列表
```

### 2.2 核心服务调用链

1. **PublicOrderController.getCurrentTradingRound()**
2. **TradingRoundService.getAllCurrentRounds()**
3. **DurationConfigMapper.findAllEnabled()** - 查询启用的周期配置
4. **TradingRoundService.getOrCreateRoundForDuration()** - 为每个周期创建轮次

### 2.3 涉及的数据表操作

#### 2.3.1 查询操作
| 表名 | 操作类型 | 字段 | 说明 |
|------|---------|------|------|
| bo_symbol_config | SELECT | id, symbol, enabled | 验证交易对有效性 |
| bo_duration_config | SELECT | duration_minutes, enabled, lock_seconds | 获取所有启用的周期配置 |
| bo_trading_round | SELECT | * | 查询现有轮次 |

#### 2.3.2 插入/更新操作
| 表名 | 操作类型 | 触发条件 | 更新字段 |
|------|---------|----------|----------|
| bo_trading_round | INSERT | 当前时间段无对应轮次时 | 创建新轮次记录 |
| bo_trading_round | UPDATE | 轮次状态需要更新时 | status: OPEN → LOCKED |

#### 2.3.3 bo_trading_round 表结构关键字段
```sql
CREATE TABLE bo_trading_round (
    id bigint PRIMARY KEY,
    round_no varchar(64) NOT NULL,           -- 轮次编号
    symbol_id bigint NOT NULL,               -- 交易对ID
    duration_minutes integer NOT NULL,       -- 轮次时长（分钟）
    start_time timestamp NOT NULL,           -- 开始时间
    lock_time timestamp NOT NULL,            -- 锁定时间
    end_time timestamp NOT NULL,             -- 结束时间
    start_price numeric(32,16),              -- 开始价格
    end_price numeric(32,16),                -- 结束价格
    status varchar(16) DEFAULT 'OPEN',       -- 状态：OPEN/LOCKED/SETTLING/SETTLED
    total_up_amount numeric(32,16) DEFAULT 0, -- UP方向总投注额
    total_down_amount numeric(32,16) DEFAULT 0, -- DOWN方向总投注额
    create_time timestamp DEFAULT CURRENT_TIMESTAMP,
    update_time timestamp DEFAULT CURRENT_TIMESTAMP
);
```

## 3. 订单创建业务流程

### 3.1 业务逻辑流程

```
订单请求 → 用户验证 → 风控检查 → 资金验证 → 创建预订单 → 资金处理 → 激活订单 → 对冲执行 → 统计更新
```

### 3.2 核心服务调用链

1. **OrderController.createOrder()**
2. **OrderService.createOrder()**
3. **RiskControlService.checkOrderRisk()** - 风控检查
4. **AccountRpcClient.validateBalance()** - 验证余额
5. **OrderService.createPreOrder()** - 创建预订单
6. **AccountRpcClient.freezeBalance()** - 冻结资金
7. **OrderService.activateOrder()** - 激活订单
8. **OrderHedgeService.executeHedge()** - 执行对冲
9. **TradingRoundService.updateRoundBetAmount()** - 更新轮次投注统计

### 3.3 涉及的数据表操作

#### 3.3.1 订单相关表操作

| 表名 | 操作类型 | 字段/条件 | 说明 |
|------|---------|-----------|------|
| bo_option_order | INSERT | 完整订单记录 | 创建新订单，初始状态为PENDING |
| bo_option_order | UPDATE | status: PENDING → ACTIVE | 资金处理成功后激活订单 |
| bo_option_order | UPDATE | status: ACTIVE → WIN/LOSE/DRAW | 轮次结算时更新订单状态 |

#### 3.3.2 账户相关表操作

| 表名 | 操作类型 | 触发条件 | 更新字段 |
|------|---------|----------|----------|
| bo_account | UPDATE | 资金冻结 | balance ↓, frozen_balance ↑ |
| bo_account | UPDATE | 订单结算 | frozen_balance ↓, balance ↑ (盈利时) |
| bo_account_transaction | INSERT | 每次资金变动 | 记录资金流水 |

#### 3.3.3 轮次统计表操作

| 表名 | 操作类型 | 更新字段 | 说明 |
|------|---------|----------|------|
| bo_trading_round | UPDATE | total_up_amount 或 total_down_amount | 累加投注金额 |
| bo_user_round | INSERT/UPDATE | 用户轮次关联记录 | 记录用户在轮次中的参与情况 |

#### 3.3.4 对冲相关表操作

| 表名 | 操作类型 | 条件 | 说明 |
|------|---------|------|------|
| bo_option_order_hedge | INSERT | 启用对冲功能时 | 记录对冲操作详情 |
| bo_btse_transfer_log | INSERT | REAL账户订单 | 记录BTSE转账日志 |

#### 3.3.5 风控统计表操作

| 表名 | 操作类型 | 更新字段 | 说明 |
|------|---------|----------|------|
| bo_user_risk_stats | UPDATE | 日/周/月/总计统计 | 更新用户交易统计 |
| bo_risk_log | INSERT | 风控触发时 | 记录风控日志 |
