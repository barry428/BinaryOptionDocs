# 二元期权平台开发计划

| 版本   | 日期         | 作者    | 说明                     |
|--------|--------------|---------|--------------------------|
| v1.0   | 2025年7月22日 | Barry  | 基于详细设计文档制定     |

## 1. 项目概览

### 1.1 开发原则
- **模块化开发**：每个模块独立可测试、可验证
- **渐进式交付**：从核心功能开始，逐步完善
- **数据驱动**：每个模块完成都有明确的验证标准
- **依赖明确**：严格按照模块间依赖关系进行开发

### 1.2 技术栈
- **框架**：Spring Boot 2.7+, Spring Cloud Gateway
- **数据库**：MySQL 8.0, Redis 6.0
- **服务发现**：Nacos
- **任务调度**：XXL-Job
- **外部接口**：BTSE WebSocket API

## 2. 开发阶段划分

### 阶段一：基础设施层 (第1-2周)
- 环境搭建
- 数据库设计
- 基础框架搭建

### 阶段二：核心服务层 (第3-6周)
- 用户账户服务
- 交易订单服务
- 行情服务

### 阶段三：管理服务层 (第7-8周)
- 后台管理服务
- 统计分析功能

### 阶段四：集成测试与部署 (第9-10周)
- 系统集成测试
- 性能测试
- 生产环境部署

## 3. 详细开发计划

### 模块1：基础设施搭建
**开发周期**：第1周  
**前置依赖**：无  
**负责模块**：基础设施层

#### 开发任务
1. **项目初始化** (1天)
   - 创建Maven多模块项目
   - 配置父POM依赖管理
   - 搭建基础项目结构
   ```
   binary-option-platform/
   ├── option-common/          # 公共模块
   ├── option-common-service/  # 用户账户服务
   ├── option-order-service/   # 交易订单服务
   ├── option-market-service/  # 行情服务
   ├── option-admin-service/   # 后台管理服务
   └── option-gateway/         # API网关
   ```

2. **环境配置** (2天)
   - Docker Compose环境搭建
   - MySQL数据库配置
   - Redis配置
   - Nacos服务注册中心配置
   - XXL-Job调度中心配置

3. **数据库初始化** (2天)
   - 执行所有建表SQL脚本
   - 插入基础配置数据
   - 创建数据库索引

#### 验收标准
- [ ] 所有服务能正常启动
- [ ] Nacos注册中心正常工作
- [ ] 数据库连接池正常
- [ ] Redis连接正常
- [ ] XXL-Job调度中心可访问

---

### 模块2：公共模块开发
**开发周期**：第1周  
**前置依赖**：基础设施搭建  
**负责模块**：option-common

#### 开发任务
1. **基础实体类** (1天)
   - User实体类
   - Account实体类
   - 公共BaseEntity类
   - 枚举类定义

2. **公共工具类** (1天)
   - JWT工具类
   - 加密解密工具类
   - 日期时间工具类
   - 数字精度处理工具类

3. **统一响应和异常处理** (1天)
   - Result统一响应实体
   - 全局异常处理器
   - 业务异常类定义

#### 验收标准
- [ ] 工具类单元测试全部通过
- [ ] JWT生成和解析功能正常
- [ ] 异常处理机制生效
- [ ] 数字精度计算准确

---

### 模块3：API网关开发
**开发周期**：第2周  
**前置依赖**：公共模块  
**负责模块**：option-gateway

#### 开发任务
1. **网关基础配置** (2天)
   - Spring Cloud Gateway配置
   - 路由规则配置
   - 跨域配置

2. **JWT认证过滤器** (2天)
   - JWT认证逻辑实现
   - Header信息传递
   - 白名单接口配置

3. **限流熔断** (1天)
   - Redis限流实现
   - 熔断降级配置

#### 验收标准
- [ ] 路由转发功能正常
- [ ] JWT认证拦截生效
- [ ] Header传递给后端服务正确
- [ ] 限流功能正常
- [ ] 跨域请求处理正常

---

### 模块4：用户账户服务
**开发周期**：第3周  
**前置依赖**：API网关  
**负责模块**：option-common-service

#### 开发任务
1. **用户管理功能** (2天)
   - 用户注册接口
   - 用户信息查询接口
   - 用户信息更新接口
   - 用户状态管理

2. **账户管理功能** (2天)
   - 账户创建(实盘+模拟)
   - 余额查询接口
   - 资金冻结/解冻
   - 模拟账户重置

3. **资金流水记录** (1天)
   - 资金流水写入
   - 资金流水查询接口
   - 流水分页查询

#### 验收标准
- [ ] 用户注册流程完整
- [ ] 默认创建实盘+模拟账户
- [ ] 余额查询准确
- [ ] 资金冻结/解冻正确
- [ ] 资金流水记录完整
- [ ] 模拟账户重置功能正常

#### 测试用例
```bash
# 用户注册测试
curl -X POST http://localhost:8080/user \
  -H "Content-Type: application/json" \
  -d '{"externalId":"test_001","nickname":"测试用户","email":"test@example.com","password":"123456"}'

# 余额查询测试
curl -X GET "http://localhost:8080/account/balance?accountType=REAL&currency=USDT" \
  -H "Authorization: Bearer {token}"
```

---

### 模块5：行情服务开发
**开发周期**：第3周  
**前置依赖**：基础设施、公共模块  
**负责模块**：option-market-service

#### 开发任务
1. **BTSE WebSocket集成** (2天)
   - WebSocket连接管理
   - 心跳保持机制
   - 断线重连逻辑

2. **价格数据处理** (2天)
   - 实时价格解析
   - Redis价格缓存
   - 价格快照存储

3. **价格查询接口** (1天)
   - 当前价格查询
   - 历史价格查询
   - K线数据接口(可选)

#### 验收标准
- [ ] BTSE WebSocket连接稳定
- [ ] 价格数据实时更新
- [ ] Redis缓存价格正确
- [ ] 价格查询接口正常
- [ ] 断线重连机制生效

#### 测试用例
```bash
# 价格查询测试
curl -X GET "http://localhost:8080/market/price/current?symbol=BTC/USDT"

# 历史价格测试
curl -X GET "http://localhost:8080/market/price/history?symbol=BTC/USDT&startTime=xxx&endTime=xxx"
```

---

### 模块6：交易回合管理
**开发周期**：第4周  
**前置依赖**：行情服务  
**负责模块**：option-order-service

#### 开发任务
1. **回合生成任务** (2天)
   - XXL-Job定时任务配置
   - 多周期回合生成逻辑
   - 回合状态管理

2. **倒计时功能** (1天)
   - 回合倒计时计算
   - 锁单时间控制
   - 回合状态流转

3. **回合查询接口** (2天)
   - 当前回合查询
   - 回合历史查询
   - 回合统计信息

#### 验收标准
- [ ] 定时任务正常生成回合
- [ ] 多周期回合并行运行
- [ ] 倒计时计算准确
- [ ] 回合状态流转正确
- [ ] 锁单机制生效

#### 测试用例
```bash
# 当前回合查询
curl -X GET "http://localhost:8080/trading/rounds/current?symbolId=1&duration=5"

# 回合历史查询
curl -X GET "http://localhost:8080/trading/rounds/history?symbolId=1&page=1&size=20"
```

---

### 模块7：风控系统
**开发周期**：第4周  
**前置依赖**：用户账户服务  
**负责模块**：option-order-service

#### 开发任务
1. **风控配置管理** (1天)
   - 风控配置数据结构
   - Redis配置缓存
   - 配置热更新机制

2. **限额校验功能** (2天)
   - 单笔限额校验
   - 日/周/月限额校验
   - Redis滑动窗口实现

3. **黑名单管理** (1天)
   - 黑名单检查
   - Redis黑名单缓存
   - 风控日志记录

4. **风控校验接口** (1天)
   - 统一风控校验入口
   - 风控结果返回
   - 风控日志查询

#### 验收标准
- [ ] 风控配置热更新正常
- [ ] 各类限额校验准确
- [ ] 黑名单拦截生效
- [ ] 风控日志记录完整
- [ ] Redis滑动窗口计算正确

#### 测试用例
```bash
# 风控校验测试
curl -X POST http://localhost:8080/risk/check \
  -H "Content-Type: application/json" \
  -d '{"userId":123,"action":"PLACE_ORDER","amount":"1000","accountType":"REAL"}'
```

---

### 模块8：交易下单功能
**开发周期**：第5周  
**前置依赖**：回合管理、风控系统  
**负责模块**：option-order-service

#### 开发任务
1. **下单核心逻辑** (2天)
   - 下单参数校验
   - 风控校验集成
   - 余额检查和冻结
   - 订单创建和存储

2. **撤单功能** (1天)
   - 撤单时间限制
   - 资金解冻逻辑
   - 订单状态更新

3. **订单查询功能** (2天)
   - 我的订单列表
   - 订单详情查询
   - 订单状态筛选

#### 验收标准
- [ ] 下单流程完整无误
- [ ] 风控校验正确拦截
- [ ] 资金冻结/解冻准确
- [ ] 撤单功能正常
- [ ] 订单查询接口正常

#### 测试用例
```bash
# 下单测试
curl -X POST http://localhost:8080/order/place \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"symbolId":1,"accountType":"REAL","direction":"UP","amount":"100"}'

# 撤单测试
curl -X POST http://localhost:8080/order/cancel/123 \
  -H "Authorization: Bearer {token}"
```

---

### 模块9：自动结算引擎
**开发周期**：第5-6周  
**前置依赖**：交易下单功能、行情服务  
**负责模块**：option-order-service

#### 开发任务
1. **结算任务调度** (2天)
   - XXL-Job结算任务
   - 待结算回合查询
   - 结算价格获取

2. **盈亏计算逻辑** (2天)
   - 盈利/亏损/平局判断
   - 手续费计算(10%)
   - 净盈亏计算

3. **资金结算处理** (2天)
   - 盈利资金派发
   - 亏损资金扣除
   - 平局资金退还
   - 资金流水记录

4. **结算异常处理** (1天)
   - 结算失败重试
   - 异常订单处理
   - 结算日志记录

#### 验收标准
- [ ] 定时结算任务正常运行
- [ ] 盈亏计算逻辑正确
- [ ] 手续费计算准确(盈利收取10%)
- [ ] 资金结算准确无误
- [ ] 资金流水记录完整
- [ ] 异常处理机制完善

#### 测试用例
```sql
-- 验证结算结果
SELECT 
    id, status, amount, profit, fee, settle_price 
FROM option_order 
WHERE round_id = ? AND status IN ('WIN','LOSE','DRAW');

-- 验证资金流水
SELECT 
    type, amount, balance_before, balance_after, remark 
FROM account_transaction 
WHERE ref_id = ? AND ref_type = 'ORDER';
```

---

### 模块10：后台管理-用户管理
**开发周期**：第7周  
**前置依赖**：用户账户服务  
**负责模块**：option-admin-service

#### 开发任务
1. **用户列表管理** (2天)
   - 用户列表查询(分页、筛选)
   - 用户详情查询
   - 用户状态管理

2. **账户管理功能** (2天)
   - 用户账户查询
   - 资金流水查询
   - 账户异常处理

3. **黑名单管理** (1天)
   - 黑名单添加/移除
   - 黑名单列表查询
   - 黑名单同步Redis

#### 验收标准
- [ ] 用户列表查询功能完善
- [ ] 用户状态管理正常
- [ ] 账户信息展示完整
- [ ] 黑名单管理功能正常

---

### 模块11：后台管理-交易管理
**开发周期**：第7周  
**前置依赖**：交易订单服务  
**负责模块**：option-admin-service

#### 开发任务
1. **订单监控管理** (2天)
   - 订单列表查询
   - 订单详情查询
   - 异常订单处理

2. **回合管理功能** (2天)
   - 回合列表查询
   - 回合详情统计
   - 手动结算功能

3. **风控日志查询** (1天)
   - 风控日志列表
   - 风控统计分析
   - 风控配置管理

#### 验收标准
- [ ] 订单监控功能完善
- [ ] 回合管理功能正常
- [ ] 手动结算功能可用
- [ ] 风控日志查询正常

---

### 模块12：数据统计分析
**开发周期**：第8周  
**前置依赖**：所有业务服务  
**负责模块**：option-admin-service

#### 开发任务
1. **统计数据计算** (2天)
   - 每日统计任务
   - 每小时统计任务
   - 统计数据存储

2. **业务统计报表** (2天)
   - 交易统计报表
   - 用户统计报表
   - 财务统计报表

3. **实时监控数据** (1天)
   - 实时数据查询
   - 监控仪表盘数据
   - 关键指标监控

#### 验收标准
- [ ] 统计任务正常执行
- [ ] 统计数据准确
- [ ] 报表查询功能完善
- [ ] 实时监控数据正确

---

### 模块13：系统集成测试
**开发周期**：第9周  
**前置依赖**：所有功能模块  

#### 测试任务
1. **功能集成测试** (3天)
   - 完整交易流程测试
   - 用户注册到交易全流程
   - 边界条件测试

2. **性能测试** (2天)
   - 接口并发测试
   - 数据库性能测试
   - Redis缓存性能测试

#### 验收标准
- [ ] 所有功能正常运行
- [ ] 性能指标达到要求
- [ ] 无严重bug

---

### 模块14：部署上线
**开发周期**：第10周  
**前置依赖**：集成测试通过  

#### 部署任务
1. **生产环境搭建** (2天)
   - 服务器环境配置
   - 数据库主从配置
   - Redis集群配置

2. **应用部署** (2天)
   - 服务打包部署
   - 配置文件调整
   - 监控告警配置

3. **上线验证** (1天)
   - 生产环境功能验证
   - 性能监控检查
   - 日志分析

#### 验收标准
- [ ] 生产环境稳定运行
- [ ] 所有功能正常
- [ ] 监控告警正常

## 4. 风险控制

### 4.1 技术风险
- **数据一致性风险**：使用事务控制、分布式锁
- **性能风险**：Redis缓存、数据库优化
- **安全风险**：JWT认证、数据加密

### 4.2 进度风险
- **依赖阻塞**：并行开发独立模块
- **技术难点**：提前技术调研
- **资源不足**：合理分配开发任务

## 5. 质量保证

### 5.1 代码质量
- 代码审查制度
- 单元测试覆盖率>80%
- 集成测试完整覆盖

### 5.2 文档质量
- API文档完整
- 部署文档详细
- 运维手册完善

## 6. 交付物清单

### 6.1 代码交付物
- [ ] 完整源代码
- [ ] 数据库脚本
- [ ] 配置文件模板
- [ ] Docker部署脚本

### 6.2 文档交付物
- [ ] API接口文档
- [ ] 部署运维文档
- [ ] 用户使用手册
- [ ] 测试报告

---

**制定人员**: 开发团队  
**审核状态**: 待确认  
**预计完成时间**: 10周  
**关键里程碑**: 
- 第2周末: 基础设施完成
- 第6周末: 核心交易功能完成  
- 第8周末: 管理功能完成
- 第10周末: 系统上线