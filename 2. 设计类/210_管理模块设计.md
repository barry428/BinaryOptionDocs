# ç®¡ç†æœåŠ¡æ¨¡å—è®¾è®¡æ–‡æ¡£

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | è¯´æ˜ |
|------|------|------|------|
| v1.0 | 2025å¹´7æœˆ23æ—¥ | Claude | åˆç¨¿ |
| v2.0 | 2025å¹´7æœˆ24æ—¥ | Claude | [å®ç°å®Œæˆ]æ›´æ–°å®é™…å®ç°çš„æ¶æ„å’Œä»£ç ç»“æ„ |

## 1. æ¦‚è¿°

ç®¡ç†æœåŠ¡ï¼ˆoption-admin-serviceï¼‰æ˜¯äºŒå…ƒæœŸæƒå¹³å°çš„åå°ç®¡ç†æ ¸å¿ƒæœåŠ¡ï¼Œè´Ÿè´£ç®¡ç†å‘˜æ“ä½œã€ç”¨æˆ·ç®¡ç†ã€è®¢å•ç®¡ç†ã€é…ç½®ç®¡ç†ã€ç»Ÿè®¡æŠ¥è¡¨ç­‰åŠŸèƒ½ã€‚æœ¬æœåŠ¡é‡‡ç”¨æ··åˆæ•°æ®è®¿é—®æ¨¡å¼ï¼Œæ—¢ç›´æ¥è®¿é—®è‡ªæœ‰ä¸šåŠ¡æ•°æ®ï¼Œåˆé€šè¿‡RPCè°ƒç”¨å…¶ä»–æœåŠ¡è·å–ä¸šåŠ¡æ•°æ®ã€‚

### 1.1 æ ¸å¿ƒèŒè´£

- **ç®¡ç†å‘˜ç®¡ç†**ï¼šç®¡ç†å‘˜è´¦æˆ·ã€è§’è‰²æƒé™ã€æ“ä½œæ—¥å¿—
- **ç”¨æˆ·ç®¡ç†**ï¼šç”¨æˆ·çŠ¶æ€ã€é»‘åå•ã€é£æ§ç®¡ç†ï¼ˆé€šè¿‡RPCï¼‰
- **è®¢å•ç®¡ç†**ï¼šè®¢å•æŸ¥è¯¢ã€è®¢å•å¹²é¢„ã€å¼‚å¸¸å¤„ç†ï¼ˆé€šè¿‡RPCï¼‰
- **é…ç½®ç®¡ç†**ï¼šå…¨å±€é…ç½®ã€äº¤æ˜“å¯¹é…ç½®ã€é£æ§é…ç½®
- **ç»Ÿè®¡æŠ¥è¡¨**ï¼šå®æ—¶ç»Ÿè®¡ã€å†å²æŠ¥è¡¨ã€æ•°æ®åˆ†æ
- **ç³»ç»Ÿç›‘æ§**ï¼šæœåŠ¡å¥åº·ã€æ€§èƒ½ç›‘æ§ã€å¼‚å¸¸å‘Šè­¦

### 1.2 è®¾è®¡åŸåˆ™

- **ä¸šåŠ¡è¾¹ç•Œæ¸…æ™°**ï¼šåŒºåˆ†è‡ªæœ‰æ•°æ®å’Œå…¶ä»–æœåŠ¡æ•°æ®
- **æƒé™ä¸¥æ ¼æ§åˆ¶**ï¼šç»†ç²’åº¦æƒé™ç®¡ç†ï¼Œæ“ä½œå®¡è®¡
- **é«˜æ€§èƒ½æŸ¥è¯¢**ï¼šæŠ¥è¡¨ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œé¿å…RPCå¼€é”€
- **æ“ä½œå¯è¿½æº¯**ï¼šæ‰€æœ‰ç®¡ç†æ“ä½œè®°å½•æ—¥å¿—
- **æ•°æ®ä¸€è‡´æ€§**ï¼šè·¨æœåŠ¡æ“ä½œè€ƒè™‘åˆ†å¸ƒå¼äº‹åŠ¡

## 2. æ¶æ„è®¾è®¡

### 2.1 æ··åˆæ•°æ®è®¿é—®æ¶æ„

```mermaid
graph TB
    subgraph "Admin Service"
        A[Admin Controller]
        B[Admin Service Layer]
        C[Direct DB Access]
        D[RPC Client]
    end
    
    subgraph "Database"
        E[Admin Tables]
        F[Stats Tables]
        G[Config Tables]
    end
    
    subgraph "Other Services"
        H[User Service]
        I[Order Service]
        J[Account Service]
        K[Market Service]
    end
    
    A --> B
    B --> C
    B --> D
    C --> E
    C --> F
    C --> G
    D --> H
    D --> I
    D --> J
    D --> K
```

### 2.2 æ•°æ®è®¿é—®ç­–ç•¥

```
âœ… ç›´æ¥æ•°æ®åº“è®¿é—®ï¼š
- ç®¡ç†å‘˜è´¦æˆ·å’Œæƒé™ç®¡ç†
- æ“ä½œæ—¥å¿—è®°å½•
- å…¨å±€é…ç½®ç®¡ç†
- ç»Ÿè®¡æŠ¥è¡¨ç”Ÿæˆ
- é»‘åå•ç®¡ç†

âœ… é€šè¿‡RPCè°ƒç”¨ï¼š
- ç”¨æˆ·ä¸šåŠ¡æ•°æ®æ“ä½œ
- è®¢å•ä¸šåŠ¡æ•°æ®æ“ä½œ
- è´¦æˆ·ä½™é¢æ“ä½œ
- å®æ—¶è¡Œæƒ…æ•°æ®
```

### 2.3 å®é™…å®ç°çš„æ¨¡å—ç»“æ„

```
option-admin-service/
â”œâ”€â”€ src/main/java/com/binaryoption/adminservice/
â”‚   â”œâ”€â”€ Application.java                    # å¯åŠ¨ç±»ï¼ˆå·²å®ç°ï¼‰
â”‚   â”œâ”€â”€ config/                            # é…ç½®ç±»
â”‚   â”‚   â”œâ”€â”€ SecurityConfig.java            # å®‰å…¨é…ç½®ï¼ˆå·²å®ç°ï¼ŒPasswordEncoderï¼‰
â”‚   â”‚   â””â”€â”€ SwaggerConfig.java             # Swaggeré…ç½®ï¼ˆå·²å®ç°ï¼‰
â”‚   â”œâ”€â”€ controller/                        # æ§åˆ¶å™¨ï¼ˆå·²å…¨éƒ¨å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AuthController.java            # ç®¡ç†å‘˜è®¤è¯ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminUserController.java       # ç”¨æˆ·ç®¡ç†ï¼ˆé€šè¿‡RPCï¼Œå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminUserManageController.java # ç®¡ç†å‘˜ç®¡ç†ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminOrderController.java      # è®¢å•ç®¡ç†ï¼ˆé€šè¿‡RPCï¼Œå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ ReportController.java          # ç»Ÿè®¡æŠ¥è¡¨ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ ConfigController.java          # é…ç½®ç®¡ç†ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ SystemController.java          # ç³»ç»Ÿç›‘æ§ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â””â”€â”€ ApiDocController.java          # APIæ–‡æ¡£é‡å®šå‘ï¼ˆå·²å®ç°ï¼‰
â”‚   â”œâ”€â”€ service/                          # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆå·²å…¨éƒ¨å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminAuthService.java         # ç®¡ç†å‘˜è®¤è¯æœåŠ¡ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminUserService.java         # ç”¨æˆ·ç®¡ç†ä¸šåŠ¡ï¼ˆé€šè¿‡RPCï¼Œå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminUserManageService.java   # ç®¡ç†å‘˜ç®¡ç†æœåŠ¡ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ OrderManageService.java       # è®¢å•ç®¡ç†ä¸šåŠ¡ï¼ˆé€šè¿‡RPCï¼Œå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ ReportService.java            # æŠ¥è¡¨ä¸šåŠ¡ï¼ˆé¢„èšåˆç»Ÿè®¡ï¼Œå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ ConfigService.java            # é…ç½®ä¸šåŠ¡ï¼ˆé€šè¿‡RPCï¼Œå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ BlacklistService.java         # é»‘åå•ç®¡ç†ï¼ˆé€šè¿‡RPCï¼Œå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ OperationLogService.java      # æ“ä½œæ—¥å¿—ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ PermissionService.java        # æƒé™æœåŠ¡ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â””â”€â”€ StatsAggregationJob.java      # ç»Ÿè®¡èšåˆå®šæ—¶ä»»åŠ¡ï¼ˆå·²å®ç°ï¼‰
â”‚   â”œâ”€â”€ client/                           # Feign RPCå®¢æˆ·ç«¯ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ CommonServiceClient.java      # é€šç”¨æœåŠ¡RPCå®¢æˆ·ç«¯ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â””â”€â”€ OrderServiceClient.java       # è®¢å•æœåŠ¡RPCå®¢æˆ·ç«¯ï¼ˆå·²å®ç°ï¼‰
â”‚   â”œâ”€â”€ domain/                           # é¢†åŸŸå¯¹è±¡ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminUser.java               # ç®¡ç†å‘˜å®ä½“ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminOperationLog.java       # æ“ä½œæ—¥å¿—å®ä½“ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ DailyStats.java              # æ¯æ—¥ç»Ÿè®¡å®ä½“ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â””â”€â”€ HourlyStats.java             # å°æ—¶ç»Ÿè®¡å®ä½“ï¼ˆå·²å®ç°ï¼‰
â”‚   â”œâ”€â”€ mapper/                           # MyBatisæ•°æ®è®¿é—®å±‚ï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminUserMapper.java         # ç®¡ç†å‘˜Mapperï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ AdminOperationLogMapper.java # æ“ä½œæ—¥å¿—Mapperï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ DailyStatsMapper.java        # æ¯æ—¥ç»Ÿè®¡Mapperï¼ˆå·²å®ç°ï¼‰
â”‚   â”‚   â””â”€â”€ HourlyStatsMapper.java       # å°æ—¶ç»Ÿè®¡Mapperï¼ˆå·²å®ç°ï¼‰
â”‚   â””â”€â”€ exception/                        # å¼‚å¸¸å¤„ç†
â”‚       â””â”€â”€ AdminServiceExceptionHandler.java # å…¨å±€å¼‚å¸¸å¤„ç†ï¼ˆå·²å®ç°ï¼‰
â””â”€â”€ src/main/resources/
    â”œâ”€â”€ application.yml                    # é…ç½®æ–‡ä»¶ï¼ˆå·²å®ç°ï¼‰
    â””â”€â”€ mapper/                           # MyBatisæ˜ å°„æ–‡ä»¶ï¼ˆå·²å®ç°ï¼‰
        â”œâ”€â”€ AdminUserMapper.xml
        â”œâ”€â”€ AdminOperationLogMapper.xml
        â”œâ”€â”€ DailyStatsMapper.xml
        â””â”€â”€ HourlyStatsMapper.xml
```

### 2.4 å·²å®ç°çš„æ ¸å¿ƒç‰¹æ€§

âœ… **ç®¡ç†å‘˜è®¤è¯ç³»ç»Ÿ**ï¼š
- JWTä»¤ç‰Œè®¤è¯
- å¯†ç åŠ å¯†å­˜å‚¨
- ç™»å½•å¤±è´¥é”å®š
- æƒé™è§’è‰²ç®¡ç†

âœ… **ç”¨æˆ·ç®¡ç†åŠŸèƒ½**ï¼š
- ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ï¼ˆRPCè°ƒç”¨common-serviceï¼‰
- ç”¨æˆ·çŠ¶æ€ç®¡ç†
- é»‘åå•ç®¡ç†
- ç”¨æˆ·è¯¦æƒ…æŸ¥çœ‹

âœ… **è®¢å•ç®¡ç†åŠŸèƒ½**ï¼š
- è®¢å•åˆ—è¡¨æŸ¥è¯¢ï¼ˆRPCè°ƒç”¨order-serviceï¼‰
- ç®¡ç†å‘˜å–æ¶ˆè®¢å•
- å¼ºåˆ¶ç»“ç®—è®¢å•
- æ‰¹é‡è®¢å•å¤„ç†

âœ… **ç»Ÿè®¡æŠ¥è¡¨ç³»ç»Ÿ**ï¼š
- é¢„èšåˆç»Ÿè®¡æ•°æ®
- æ¯æ—¥/å°æ—¶ç»Ÿè®¡æŠ¥è¡¨
- ä¸šåŠ¡æ¦‚è§ˆç»Ÿè®¡
- äº¤æ˜“ç»Ÿè®¡åˆ†æ

âœ… **ç³»ç»Ÿé…ç½®ç®¡ç†**ï¼š
- å…¨å±€é…ç½®ç®¡ç†ï¼ˆRPCè°ƒç”¨common-serviceï¼‰
- é…ç½®ç¼“å­˜æœºåˆ¶

âœ… **æ“ä½œå®¡è®¡æ—¥å¿—**ï¼š
- æ‰€æœ‰ç®¡ç†æ“ä½œè®°å½•
- æ“ä½œç»“æœè·Ÿè¸ª
- å¼‚æ­¥æ—¥å¿—å†™å…¥

âœ… **APIæ–‡æ¡£ç³»ç»Ÿ**ï¼š
- Swagger UIé›†æˆ
- JWTè®¤è¯æ”¯æŒ
- å®Œæ•´çš„APIæ–‡æ¡£

### 2.5 å®ç°çŠ¶æ€æ€»ç»“

**ğŸ‰ å®ç°å®ŒæˆçŠ¶æ€ï¼š100%**

| åŠŸèƒ½æ¨¡å— | å®ç°çŠ¶æ€ | è¯´æ˜ |
|---------|---------|------|
| ç®¡ç†å‘˜è®¤è¯ | âœ… å®Œæˆ | JWTè®¤è¯ã€æƒé™ç®¡ç†ã€å¯†ç åŠ å¯† |
| ç”¨æˆ·ç®¡ç† | âœ… å®Œæˆ | é€šè¿‡RPCè°ƒç”¨common-serviceå®ç° |
| è®¢å•ç®¡ç† | âœ… å®Œæˆ | é€šè¿‡RPCè°ƒç”¨order-serviceå®ç° |
| ç»Ÿè®¡æŠ¥è¡¨ | âœ… å®Œæˆ | é¢„èšåˆç»Ÿè®¡æ•°æ®ï¼Œå®šæ—¶ä»»åŠ¡ |
| é…ç½®ç®¡ç† | âœ… å®Œæˆ | é€šè¿‡RPCè°ƒç”¨common-serviceå®ç° |
| æ“ä½œæ—¥å¿— | âœ… å®Œæˆ | å¼‚æ­¥è®°å½•æ‰€æœ‰ç®¡ç†æ“ä½œ |
| APIæ–‡æ¡£ | âœ… å®Œæˆ | Swagger UIï¼Œæ”¯æŒJWTè®¤è¯ |
| ç³»ç»Ÿç›‘æ§ | âœ… å®Œæˆ | å¥åº·æ£€æŸ¥ã€ç³»ç»Ÿä¿¡æ¯ |

**å·²è§£å†³çš„æŠ€æœ¯æŒ‘æˆ˜ï¼š**
- âœ… Spring Securityé…ç½®å†²çª
- âœ… Feignå®¢æˆ·ç«¯å¤šRequestBodyå‚æ•°é—®é¢˜
- âœ… Swaggeré…ç½®é‡å¤åˆ†ç»„é—®é¢˜
- âœ… JWTè®¤è¯ä¸æƒé™é›†æˆ
- âœ… å¾®æœåŠ¡é—´RPCé€šä¿¡
- âœ… ç»Ÿè®¡æ•°æ®é¢„èšåˆè®¾è®¡

**éƒ¨ç½²ä¿¡æ¯ï¼š**
- æœåŠ¡ç«¯å£ï¼š8084
- Swaggeråœ°å€ï¼šhttp://localhost:8084/swagger-ui/index.html
- å¥åº·æ£€æŸ¥ï¼šhttp://localhost:8084/actuator/health
- æœåŠ¡çŠ¶æ€ï¼šâœ… æ­£å¸¸è¿è¡Œ

## 3. æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 3.1 ç®¡ç†å‘˜æƒé™ç®¡ç†ï¼ˆç›´æ¥DBï¼‰

```java
@Service
@RequiredArgsConstructor
public class AdminUserService {
    
    private final AdminUserMapper adminUserMapper;
    private final AdminRoleMapper adminRoleMapper;
    private final AdminOperationLogMapper operationLogMapper;
    private final PasswordEncoder passwordEncoder;
    
    /**
     * åˆ›å»ºç®¡ç†å‘˜
     */
    @Transactional
    public AdminDTO createAdmin(AdminCreateRequest request) {
        // æ£€æŸ¥ç”¨æˆ·åé‡å¤
        if (adminUserMapper.findByUsername(request.getUsername()) != null) {
            throw BusinessException.badRequest("admin.username.exists", null);
        }
        
        // åˆ›å»ºç®¡ç†å‘˜
        AdminUser admin = new AdminUser();
        admin.setUsername(request.getUsername());
        admin.setPassword(passwordEncoder.encode(request.getPassword()));
        admin.setEmail(request.getEmail());
        admin.setStatus(1);
        adminUserMapper.insert(admin);
        
        // åˆ†é…è§’è‰²
        if (CollectionUtils.isNotEmpty(request.getRoleIds())) {
            adminRoleMapper.insertUserRoles(admin.getId(), request.getRoleIds());
        }
        
        // è®°å½•æ“ä½œæ—¥å¿—
        logOperation("ADMIN_CREATE", admin.getId(), request);
        
        return convertToDTO(admin);
    }
    
    /**
     * è§’è‰²æƒé™ç®¡ç†
     */
    public void updateAdminRoles(Long adminId, List<Long> roleIds) {
        AdminUser admin = adminUserMapper.findById(adminId);
        if (admin == null) {
            throw BusinessException.notFound("admin.not.found", null);
        }
        
        // æ›´æ–°è§’è‰²
        adminRoleMapper.deleteUserRoles(adminId);
        if (CollectionUtils.isNotEmpty(roleIds)) {
            adminRoleMapper.insertUserRoles(adminId, roleIds);
        }
        
        // æ¸…é™¤æƒé™ç¼“å­˜
        permissionCacheService.clearAdminPermissions(adminId);
        
        // è®°å½•æ“ä½œæ—¥å¿—
        logOperation("ROLE_UPDATE", adminId, roleIds);
    }
    
    /**
     * è·å–ç®¡ç†å‘˜æƒé™
     */
    @Cacheable(value = "admin_permissions", key = "#adminId")
    public Set<String> getAdminPermissions(Long adminId) {
        List<AdminRole> roles = adminRoleMapper.findByAdminId(adminId);
        Set<String> permissions = new HashSet<>();
        
        for (AdminRole role : roles) {
            if (StringUtils.hasText(role.getPermissions())) {
                permissions.addAll(Arrays.asList(role.getPermissions().split(",")));
            }
        }
        
        return permissions;
    }
}
```

### 3.2 ç”¨æˆ·ç®¡ç†ï¼ˆé€šè¿‡RPCï¼‰

```java
@Service
@RequiredArgsConstructor
public class UserManageService {
    
    private final UserRpcClient userRpcClient;
    private final AccountRpcClient accountRpcClient;
    private final BlacklistService blacklistService;
    private final OperationLogService operationLogService;
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    public PageResultVO<UserDetailVO> getUserList(UserQueryRequest request) {
        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        QueryConditionDTO condition = QueryConditionDTO.builder()
            .keyword(request.getKeyword())
            .status(request.getStatus())
            .startTime(request.getStartTime())
            .endTime(request.getEndTime())
            .build();
        
        // RPCè°ƒç”¨æŸ¥è¯¢ç”¨æˆ·
        PageRequestDTO pageRequest = PageRequestDTO.of(request.getPage(), request.getSize());
        return userRpcClient.getUserList(condition, pageRequest);
    }
    
    /**
     * æ›´æ–°ç”¨æˆ·çŠ¶æ€
     */
    @Transactional
    public void updateUserStatus(Long userId, Integer status, String reason) {
        // éªŒè¯ç”¨æˆ·å­˜åœ¨
        var userResult = userRpcClient.getUserById(userId);
        if (!userResult.isSuccess() || userResult.getData() == null) {
            throw BusinessException.notFound("user.not.found", null);
        }
        
        // RPCè°ƒç”¨æ›´æ–°çŠ¶æ€
        var result = userRpcClient.updateUserStatus(userId, status);
        if (!result.isSuccess()) {
            throw BusinessException.error("user.status.update.failed", null);
        }
        
        // å¦‚æœæ˜¯ç¦ç”¨ï¼Œæ·»åŠ åˆ°é»‘åå•
        if (status == 2) {
            blacklistService.addToBlacklist(userId, reason);
        }
        
        // è®°å½•æ“ä½œæ—¥å¿—
        operationLogService.log("USER_STATUS_UPDATE", "USER", userId, 
            Map.of("status", status, "reason", reason));
    }
    
    /**
     * è°ƒæ•´ç”¨æˆ·ä½™é¢
     */
    @Transactional
    public void adjustUserBalance(BalanceAdjustRequest request) {
        Long userId = request.getUserId();
        String accountType = request.getAccountType();
        BigDecimal amount = request.getAmount();
        
        // éªŒè¯ç”¨æˆ·è´¦æˆ·
        var balanceResult = accountRpcClient.getAccountBalance(userId, accountType);
        if (!balanceResult.isSuccess()) {
            throw BusinessException.notFound("account.not.found", null);
        }
        
        // RPCè°ƒç”¨è°ƒæ•´ä½™é¢
        var result = accountRpcClient.adjustBalance(userId, accountType, amount, request.getReason());
        if (!result.isSuccess()) {
            throw BusinessException.error("balance.adjust.failed", null);
        }
        
        // è®°å½•æ“ä½œæ—¥å¿—
        operationLogService.log("BALANCE_ADJUST", "ACCOUNT", userId,
            Map.of("accountType", accountType, "amount", amount, "reason", request.getReason()));
    }
}
```

### 3.3 è®¢å•ç®¡ç†ï¼ˆé€šè¿‡RPCï¼‰

```java
@Service
@RequiredArgsConstructor
public class OrderManageService {
    
    private final OrderRpcClient orderRpcClient;
    private final OperationLogService operationLogService;
    
    /**
     * æŸ¥è¯¢è®¢å•åˆ—è¡¨
     */
    public PageResultVO<OrderDetailVO> getOrderList(OrderQueryRequest request) {
        QueryConditionDTO condition = QueryConditionDTO.builder()
            .userId(request.getUserId())
            .accountType(request.getAccountType())
            .status(request.getStatus())
            .startTime(request.getStartTime())
            .endTime(request.getEndTime())
            .build();
        
        PageRequestDTO pageRequest = PageRequestDTO.of(request.getPage(), request.getSize());
        return orderRpcClient.getOrderList(condition, pageRequest);
    }
    
    /**
     * å¼ºåˆ¶ç»“ç®—è®¢å•
     */
    @Transactional
    public void forceSettleOrder(Long orderId, BigDecimal settlePrice, String reason) {
        // è·å–è®¢å•ä¿¡æ¯
        var orderResult = orderRpcClient.getOrderDetail(orderId);
        if (!orderResult.isSuccess() || orderResult.getData() == null) {
            throw BusinessException.notFound("order.not.found", null);
        }
        
        OrderDetailVO order = orderResult.getData();
        if (!"PENDING".equals(order.getStatus())) {
            throw BusinessException.badRequest("order.already.settled", null);
        }
        
        // RPCè°ƒç”¨å¼ºåˆ¶ç»“ç®—
        var result = orderRpcClient.forceSettle(orderId, settlePrice);
        if (!result.isSuccess()) {
            throw BusinessException.error("order.settle.failed", null);
        }
        
        // è®°å½•æ“ä½œæ—¥å¿—
        operationLogService.log("ORDER_FORCE_SETTLE", "ORDER", orderId,
            Map.of("settlePrice", settlePrice, "reason", reason));
    }
    
    /**
     * å–æ¶ˆå¼‚å¸¸è®¢å•
     */
    @Transactional
    public void cancelAbnormalOrder(Long orderId, String reason) {
        var result = orderRpcClient.adminCancelOrder(orderId, reason);
        if (!result.isSuccess()) {
            throw BusinessException.error("order.cancel.failed", null);
        }
        
        operationLogService.log("ORDER_ADMIN_CANCEL", "ORDER", orderId,
            Map.of("reason", reason));
    }
}
```

### 3.4 ç»Ÿè®¡æŠ¥è¡¨ï¼ˆç›´æ¥DBï¼‰

```java
@Service
@RequiredArgsConstructor
public class ReportService {
    
    private final DailyStatsMapper dailyStatsMapper;
    private final HourlyStatsMapper hourlyStatsMapper;
    private final OrderMapper orderMapper;
    private final UserMapper userMapper;
    
    /**
     * è·å–æ¯æ—¥ç»Ÿè®¡æŠ¥è¡¨ï¼ˆæŸ¥è¯¢é¢„èšåˆè¡¨ï¼‰
     */
    @Cacheable(value = "daily_report", key = "#date")
    public DailyReportVO getDailyReport(LocalDate date) {
        // ä»é¢„èšåˆçš„ç»Ÿè®¡è¡¨æŸ¥è¯¢ï¼ˆç”±å®šæ—¶ä»»åŠ¡ç”Ÿæˆï¼‰
        DailyStats stats = dailyStatsMapper.findByDate(date);
        if (stats == null) {
            // å†å²æ•°æ®ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯èšåˆä»»åŠ¡è¿˜æœªæ‰§è¡Œ
            log.warn("æœªæ‰¾åˆ°æ—¥æœŸ{}çš„ç»Ÿè®¡æ•°æ®ï¼Œå¯èƒ½èšåˆä»»åŠ¡å°šæœªæ‰§è¡Œ", date);
            return DailyReportVO.empty(date);
        }
        
        return DailyReportVO.builder()
            .date(date)
            .totalUsers(stats.getTotalUsers())
            .activeUsers(stats.getActiveUsers())
            .newUsers(stats.getNewUsers())
            .totalOrders(stats.getTotalOrders())
            .totalVolume(stats.getTotalVolume())
            .totalProfit(stats.getTotalProfit())
            .totalFee(stats.getTotalFee())
            .winRate(stats.getWinRate())
            .build();
    }
    
    /**
     * è·å–å®æ—¶ç»Ÿè®¡ï¼ˆæ··åˆæ¨¡å¼ï¼šéƒ¨åˆ†RPC + éƒ¨åˆ†ç›´æ¥æŸ¥è¯¢ï¼‰
     */
    public RealTimeStatsVO getRealTimeStats() {
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime todayStart = now.toLocalDate().atStartOfDay();
        
        // å¹¶è¡Œè·å–ç»Ÿè®¡æ•°æ®
        CompletableFuture<Integer> onlineUsersFuture = CompletableFuture.supplyAsync(() -> 
            userRpcClient.getOnlineUserCount().getData());
            
        CompletableFuture<Long> todayOrdersFuture = CompletableFuture.supplyAsync(() ->
            orderMapper.countByCreateTime(todayStart, now));
            
        CompletableFuture<BigDecimal> todayVolumeFuture = CompletableFuture.supplyAsync(() ->
            orderMapper.sumAmountByCreateTime(todayStart, now));
            
        CompletableFuture<Integer> pendingOrdersFuture = CompletableFuture.supplyAsync(() ->
            orderMapper.countByStatus("PENDING"));
        
        // ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ
        CompletableFuture.allOf(onlineUsersFuture, todayOrdersFuture, 
                               todayVolumeFuture, pendingOrdersFuture).join();
        
        return RealTimeStatsVO.builder()
            .onlineUsers(onlineUsersFuture.join())
            .todayOrders(todayOrdersFuture.join())
            .todayVolume(todayVolumeFuture.join())
            .pendingOrders(pendingOrdersFuture.join())
            .timestamp(now)
            .build();
    }
    
    /**
     * ç”Ÿæˆè‡ªå®šä¹‰æŠ¥è¡¨ï¼ˆå¤æ‚æŸ¥è¯¢ç›´æ¥è®¿é—®æ•°æ®åº“ï¼‰
     */
    public CustomReportVO generateCustomReport(CustomReportRequest request) {
        // å¤æ‚çš„å¤šè¡¨å…³è”æŸ¥è¯¢ï¼Œç›´æ¥SQLæ•ˆç‡æ›´é«˜
        List<Map<String, Object>> rawData = dailyStatsMapper.customQuery(
            request.getStartDate(),
            request.getEndDate(),
            request.getGroupBy(),
            request.getMetrics()
        );
        
        // æ•°æ®å¤„ç†å’Œæ ¼å¼åŒ–
        return processReportData(rawData, request);
    }
}
```

### 3.5 é…ç½®ç®¡ç†ï¼ˆç›´æ¥DBï¼‰

```java
@Service
@RequiredArgsConstructor
public class ConfigService {
    
    private final GlobalConfigMapper globalConfigMapper;
    private final SymbolConfigMapper symbolConfigMapper;
    private final RiskConfigMapper riskConfigMapper;
    private final RedisTemplate<String, Object> redisTemplate;
    
    /**
     * æ›´æ–°å…¨å±€é…ç½®
     */
    @Transactional
    public void updateGlobalConfig(String key, String value) {
        GlobalConfig config = globalConfigMapper.findByKey(key);
        if (config == null) {
            throw BusinessException.notFound("config.not.found", null);
        }
        
        // éªŒè¯é…ç½®å€¼
        validateConfigValue(config.getConfigType(), value);
        
        // æ›´æ–°é…ç½®
        config.setConfigValue(value);
        globalConfigMapper.update(config);
        
        // æ¸…é™¤ç¼“å­˜
        redisTemplate.delete("config:" + key);
        
        // å‘å¸ƒé…ç½®å˜æ›´äº‹ä»¶
        publishConfigChangeEvent(key, value);
        
        // è®°å½•æ“ä½œæ—¥å¿—
        logOperation("CONFIG_UPDATE", key, value);
    }
    
    /**
     * ç®¡ç†äº¤æ˜“å¯¹é…ç½®
     */
    @Transactional
    public void updateSymbolConfig(SymbolConfigUpdateRequest request) {
        SymbolConfig config = symbolConfigMapper.findById(request.getId());
        if (config == null) {
            throw BusinessException.notFound("symbol.not.found", null);
        }
        
        // æ›´æ–°é…ç½®
        config.setEnabled(request.getEnabled());
        config.setMinAmount(request.getMinAmount());
        config.setMaxAmount(request.getMaxAmount());
        symbolConfigMapper.update(config);
        
        // é€šçŸ¥è¡Œæƒ…æœåŠ¡åˆ·æ–°é…ç½®
        marketRpcClient.refreshSymbolConfig(config.getSymbol());
        
        logOperation("SYMBOL_CONFIG_UPDATE", config.getId(), request);
    }
}
```

### 3.6 æ“ä½œæ—¥å¿—åˆ‡é¢

```java
@Aspect
@Component
@RequiredArgsConstructor
public class OperationLogAspect {
    
    private final OperationLogService operationLogService;
    private final HttpServletRequest request;
    
    @Around("@annotation(operationLog)")
    public Object logOperation(ProceedingJoinPoint joinPoint, OperationLog operationLog) throws Throwable {
        Long startTime = System.currentTimeMillis();
        
        // è·å–æ“ä½œä¿¡æ¯
        String operationType = operationLog.type();
        String description = operationLog.description();
        
        // è·å–è¯·æ±‚å‚æ•°
        Object[] args = joinPoint.getArgs();
        String requestData = JSON.toJSONString(args);
        
        // è·å–æ“ä½œå‘˜ä¿¡æ¯
        AdminUser currentAdmin = SecurityUtils.getCurrentAdmin();
        
        Object result = null;
        Throwable error = null;
        
        try {
            // æ‰§è¡ŒåŸæ–¹æ³•
            result = joinPoint.proceed();
            return result;
        } catch (Throwable e) {
            error = e;
            throw e;
        } finally {
            // è®°å½•æ“ä½œæ—¥å¿—
            AdminOperationLog log = new AdminOperationLog();
            log.setOperatorId(currentAdmin.getId());
            log.setOperatorName(currentAdmin.getUsername());
            log.setOperationType(operationType);
            log.setOperationDesc(description);
            log.setRequestData(requestData);
            log.setResponseData(result != null ? JSON.toJSONString(result) : null);
            log.setIpAddress(getClientIp());
            log.setUserAgent(request.getHeader("User-Agent"));
            log.setResult(error == null ? 1 : 0);
            log.setErrorMsg(error != null ? error.getMessage() : null);
            log.setExecutionTime(System.currentTimeMillis() - startTime);
            
            operationLogService.saveAsync(log);
        }
    }
}
```

## 4. APIæ¥å£è®¾è®¡

### 4.1 ç®¡ç†å‘˜ç®¡ç†æ¥å£

```java
@RestController
@RequestMapping("/api/admin")
@RequiredArgsConstructor
@PreAuthorize("hasRole('SUPER_ADMIN')")
public class AdminController {
    
    private final AdminUserService adminUserService;
    
    /**
     * åˆ›å»ºç®¡ç†å‘˜
     */
    @PostMapping("/admins")
    @OperationLog(type = "ADMIN_CREATE", description = "åˆ›å»ºç®¡ç†å‘˜")
    public Result<AdminDTO> createAdmin(@RequestBody @Valid AdminCreateRequest request) {
        AdminDTO admin = adminUserService.createAdmin(request);
        return Result.success(admin);
    }
    
    /**
     * æ›´æ–°ç®¡ç†å‘˜è§’è‰²
     */
    @PutMapping("/admins/{adminId}/roles")
    @OperationLog(type = "ROLE_UPDATE", description = "æ›´æ–°ç®¡ç†å‘˜è§’è‰²")
    public Result<Void> updateRoles(@PathVariable Long adminId, 
                                   @RequestBody List<Long> roleIds) {
        adminUserService.updateAdminRoles(adminId, roleIds);
        return Result.success();
    }
    
    /**
     * è·å–è§’è‰²åˆ—è¡¨
     */
    @GetMapping("/roles")
    public Result<List<RoleDTO>> getRoles() {
        List<RoleDTO> roles = adminUserService.getAllRoles();
        return Result.success(roles);
    }
}
```

### 4.2 ç”¨æˆ·ç®¡ç†æ¥å£

```java
@RestController
@RequestMapping("/api/admin/users")
@RequiredArgsConstructor
@PreAuthorize("hasRole('ADMIN')")
public class UserManageController {
    
    private final UserManageService userManageService;
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping
    @RequirePermission("USER_VIEW")
    public Result<PageResultVO<UserDetailVO>> getUserList(UserQueryRequest request) {
        PageResultVO<UserDetailVO> result = userManageService.getUserList(request);
        return Result.success(result);
    }
    
    /**
     * æ›´æ–°ç”¨æˆ·çŠ¶æ€
     */
    @PutMapping("/{userId}/status")
    @RequirePermission("USER_MANAGE")
    @OperationLog(type = "USER_STATUS_UPDATE", description = "æ›´æ–°ç”¨æˆ·çŠ¶æ€")
    public Result<Void> updateUserStatus(@PathVariable Long userId,
                                       @RequestBody UserStatusRequest request) {
        userManageService.updateUserStatus(userId, request.getStatus(), request.getReason());
        return Result.success();
    }
    
    /**
     * è°ƒæ•´ç”¨æˆ·ä½™é¢
     */
    @PostMapping("/balance/adjust")
    @RequirePermission("BALANCE_ADJUST")
    @OperationLog(type = "BALANCE_ADJUST", description = "è°ƒæ•´ç”¨æˆ·ä½™é¢")
    public Result<Void> adjustBalance(@RequestBody @Valid BalanceAdjustRequest request) {
        userManageService.adjustUserBalance(request);
        return Result.success();
    }
}
```

### 4.3 ç»Ÿè®¡æŠ¥è¡¨æ¥å£

```java
@RestController
@RequestMapping("/api/admin/reports")
@RequiredArgsConstructor
@PreAuthorize("hasRole('ADMIN')")
public class ReportController {
    
    private final ReportService reportService;
    
    /**
     * è·å–æ¯æ—¥æŠ¥è¡¨
     */
    @GetMapping("/daily")
    @RequirePermission("REPORT_VIEW")
    public Result<DailyReportVO> getDailyReport(
        @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate date) {
        DailyReportVO report = reportService.getDailyReport(date);
        return Result.success(report);
    }
    
    /**
     * è·å–å®æ—¶ç»Ÿè®¡
     */
    @GetMapping("/realtime")
    @RequirePermission("REPORT_VIEW")
    public Result<RealTimeStatsVO> getRealTimeStats() {
        RealTimeStatsVO stats = reportService.getRealTimeStats();
        return Result.success(stats);
    }
    
    /**
     * ç”Ÿæˆè‡ªå®šä¹‰æŠ¥è¡¨
     */
    @PostMapping("/custom")
    @RequirePermission("REPORT_EXPORT")
    public Result<CustomReportVO> generateCustomReport(@RequestBody @Valid CustomReportRequest request) {
        CustomReportVO report = reportService.generateCustomReport(request);
        return Result.success(report);
    }
    
    /**
     * å¯¼å‡ºæŠ¥è¡¨
     */
    @GetMapping("/export")
    @RequirePermission("REPORT_EXPORT")
    public void exportReport(@RequestParam String type,
                           @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
                           @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate,
                           HttpServletResponse response) {
        reportService.exportReport(type, startDate, endDate, response);
    }
}
```

## 5. æ•°æ®æ¨¡å‹è®¾è®¡

### 5.1 ç®¡ç†å‘˜ç›¸å…³è¡¨ï¼ˆAdmin Serviceç‹¬æœ‰ï¼‰

```sql
-- ç®¡ç†å‘˜è¡¨
CREATE TABLE `admin_user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `external_id` varchar(64) DEFAULT NULL COMMENT 'å¤–éƒ¨ç³»ç»ŸID(BTSEç®¡ç†å‘˜ID)',
  `username` varchar(64) NOT NULL COMMENT 'ç”¨æˆ·å',
  `password` varchar(128) DEFAULT NULL COMMENT 'å¯†ç (SSOç”¨æˆ·å¯ä¸ºç©º)',
  `email` varchar(128) DEFAULT NULL COMMENT 'é‚®ç®±',
  `phone` varchar(32) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  `real_name` varchar(64) DEFAULT NULL COMMENT 'çœŸå®å§“å',
  `source` varchar(16) NOT NULL DEFAULT 'LOCAL' COMMENT 'æ¥æº(LOCAL:æœ¬åœ° BTSE:BTSEç³»ç»Ÿ)',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT 'çŠ¶æ€(1:æ­£å¸¸ 0:ç¦ç”¨)',
  `last_login_time` datetime DEFAULT NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
  `last_login_ip` varchar(64) DEFAULT NULL COMMENT 'æœ€åç™»å½•IP',
  `last_login_type` varchar(16) DEFAULT NULL COMMENT 'æœ€åç™»å½•æ–¹å¼(PASSWORD:å¯†ç  SSO:å•ç‚¹ç™»å½•)',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_external_id` (`external_id`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_status` (`status`),
  KEY `idx_source` (`source`)
) ENGINE=InnoDB COMMENT='ç®¡ç†å‘˜è¡¨';

-- è§’è‰²è¡¨
CREATE TABLE `admin_role` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `role_name` varchar(64) NOT NULL COMMENT 'è§’è‰²åç§°',
  `role_code` varchar(32) NOT NULL COMMENT 'è§’è‰²ä»£ç ',
  `description` varchar(255) DEFAULT NULL COMMENT 'æè¿°',
  `permissions` text COMMENT 'æƒé™åˆ—è¡¨(é€—å·åˆ†éš”)',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT 'çŠ¶æ€',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_code` (`role_code`)
) ENGINE=InnoDB COMMENT='è§’è‰²è¡¨';

-- ç®¡ç†å‘˜è§’è‰²å…³è”è¡¨
CREATE TABLE `admin_user_role` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `admin_id` bigint NOT NULL COMMENT 'ç®¡ç†å‘˜ID',
  `role_id` bigint NOT NULL COMMENT 'è§’è‰²ID',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_admin_role` (`admin_id`, `role_id`),
  KEY `idx_admin_id` (`admin_id`),
  KEY `idx_role_id` (`role_id`)
) ENGINE=InnoDB COMMENT='ç®¡ç†å‘˜è§’è‰²å…³è”è¡¨';
```

### 5.2 ç»Ÿè®¡æ•°æ®èšåˆä»»åŠ¡

```java
/**
 * ç»Ÿè®¡æ•°æ®èšåˆå®šæ—¶ä»»åŠ¡
 * ä½¿ç”¨XXL-Jobè°ƒåº¦æ‰§è¡Œ
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class StatsAggregationJob {
    
    private final DailyStatsMapper dailyStatsMapper;
    private final HourlyStatsMapper hourlyStatsMapper;
    private final UserMapper userMapper;
    private final OrderMapper orderMapper;
    private final AccountTransactionMapper transactionMapper;
    
    /**
     * æ¯æ—¥ç»Ÿè®¡æ•°æ®èšåˆ
     * æ‰§è¡Œæ—¶é—´ï¼šæ¯å¤©å‡Œæ™¨1ç‚¹
     */
    @XxlJob("dailyStatsAggregation")
    public void aggregateDailyStats() {
        LocalDate yesterday = LocalDate.now().minusDays(1);
        log.info("å¼€å§‹èšåˆ{}çš„æ¯æ—¥ç»Ÿè®¡æ•°æ®", yesterday);
        
        try {
            // æ£€æŸ¥æ˜¯å¦å·²ç»èšåˆè¿‡
            if (dailyStatsMapper.existsByDate(yesterday)) {
                log.warn("æ—¥æœŸ{}çš„ç»Ÿè®¡æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡èšåˆ", yesterday);
                return;
            }
            
            // èšåˆå…¨å¹³å°æ•°æ®
            DailyStats globalStats = aggregateGlobalStats(yesterday);
            dailyStatsMapper.insert(globalStats);
            
            // æŒ‰äº¤æ˜“å¯¹èšåˆ
            List<Long> symbolIds = getActiveSymbolIds();
            for (Long symbolId : symbolIds) {
                DailyStats symbolStats = aggregateSymbolStats(yesterday, symbolId);
                dailyStatsMapper.insert(symbolStats);
            }
            
            log.info("å®Œæˆ{}çš„æ¯æ—¥ç»Ÿè®¡æ•°æ®èšåˆ", yesterday);
        } catch (Exception e) {
            log.error("èšåˆæ¯æ—¥ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼Œæ—¥æœŸ: {}", yesterday, e);
            throw e;
        }
    }
    
    /**
     * å°æ—¶ç»Ÿè®¡æ•°æ®èšåˆ
     * æ‰§è¡Œæ—¶é—´ï¼šæ¯å°æ—¶ç¬¬5åˆ†é’Ÿ
     */
    @XxlJob("hourlyStatsAggregation")
    public void aggregateHourlyStats() {
        LocalDateTime lastHour = LocalDateTime.now().truncatedTo(ChronoUnit.HOURS).minusHours(1);
        log.info("å¼€å§‹èšåˆ{}çš„å°æ—¶ç»Ÿè®¡æ•°æ®", lastHour);
        
        try {
            HourlyStats stats = calculateHourlyStats(lastHour);
            hourlyStatsMapper.insert(stats);
            log.info("å®Œæˆ{}çš„å°æ—¶ç»Ÿè®¡æ•°æ®èšåˆ", lastHour);
        } catch (Exception e) {
            log.error("èšåˆå°æ—¶ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼Œæ—¶é—´: {}", lastHour, e);
            throw e;
        }
    }
    
    /**
     * è®¡ç®—å…¨å¹³å°æ¯æ—¥ç»Ÿè®¡
     */
    private DailyStats aggregateGlobalStats(LocalDate date) {
        LocalDateTime startTime = date.atStartOfDay();
        LocalDateTime endTime = date.plusDays(1).atStartOfDay();
        
        return DailyStats.builder()
            .statDate(date)
            .symbolId(null) // nullè¡¨ç¤ºå…¨å¹³å°
            .totalUsers(userMapper.countTotal())
            .activeUsers(orderMapper.countDistinctUsersByTime(startTime, endTime))
            .newUsers(userMapper.countByCreateTime(startTime, endTime))
            .totalOrders(orderMapper.countByCreateTime(startTime, endTime))
            .pendingOrders(0) // å†å²æ•°æ®ä¸ç»Ÿè®¡è¿›è¡Œä¸­è®¢å•
            .winOrders(orderMapper.countByStatusAndTime("WIN", startTime, endTime))
            .loseOrders(orderMapper.countByStatusAndTime("LOSE", startTime, endTime))
            .drawOrders(orderMapper.countByStatusAndTime("DRAW", startTime, endTime))
            .totalVolume(orderMapper.sumAmountByTime(startTime, endTime))
            .totalProfit(orderMapper.sumProfitByTime(startTime, endTime))
            .totalLoss(orderMapper.sumLossByTime(startTime, endTime))
            .totalFee(orderMapper.sumFeeByTime(startTime, endTime))
            .winRate(calculateWinRate(startTime, endTime))
            .avgOrderAmount(calculateAvgOrderAmount(startTime, endTime))
            .build();
    }
    
    /**
     * æ•°æ®æ¸…ç†ä»»åŠ¡
     * æ¸…ç†è¶…è¿‡ä¿ç•™æœŸé™çš„ç»Ÿè®¡æ•°æ®
     */
    @XxlJob("statsDataCleanup")
    public void cleanupOldStats() {
        // ä¿ç•™æœ€è¿‘90å¤©çš„å°æ—¶ç»Ÿè®¡
        LocalDateTime hourlyRetentionDate = LocalDateTime.now().minusDays(90);
        int deletedHourly = hourlyStatsMapper.deleteByDateBefore(hourlyRetentionDate);
        log.info("æ¸…ç†äº†{}æ¡è¿‡æœŸçš„å°æ—¶ç»Ÿè®¡æ•°æ®", deletedHourly);
        
        // æ¯æ—¥ç»Ÿè®¡æ°¸ä¹…ä¿ç•™ï¼Œä¸æ¸…ç†
    }
}
```

### 5.3 é¢„èšåˆè¡¨ç»“æ„è¯´æ˜

```sql
-- daily_stats å’Œ hourly_stats è¡¨å·²åœ¨ init.sql ä¸­å®šä¹‰
-- è¿™äº›è¡¨ä¸“é—¨ç”¨äºå­˜å‚¨é¢„è®¡ç®—çš„ç»Ÿè®¡æ•°æ®

-- è¡¥å……ç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
ALTER TABLE `daily_stats` ADD INDEX `idx_symbol_date` (`symbol_id`, `stat_date`);
ALTER TABLE `hourly_stats` ADD INDEX `idx_symbol_datetime` (`symbol_id`, `stat_datetime`);

-- æ³¨æ„äº‹é¡¹ï¼š
-- 1. daily_stats è¡¨çš„æ•°æ®ç”±å®šæ—¶ä»»åŠ¡åœ¨æ¯å¤©å‡Œæ™¨ç”Ÿæˆ
-- 2. æŸ¥è¯¢å†å²æŠ¥è¡¨æ—¶ç›´æ¥ä»è¿™ä¸ªè¡¨è¯»å–ï¼Œæ€§èƒ½æé«˜
-- 3. symbol_id ä¸º NULL è¡¨ç¤ºå…¨å¹³å°æ±‡æ€»æ•°æ®
-- 4. æ”¯æŒæŒ‰äº¤æ˜“å¯¹ã€æŒ‰æ—¥æœŸçš„å¤šç»´åº¦ç»Ÿè®¡
```

## 6. å®é™…é…ç½®æ–‡ä»¶

```yaml
spring:
  application:
    name: option-admin-service
  
  profiles:
    active: dev
  
  messages:
    basename: i18n/messages
    encoding: UTF-8
    cache-duration: 3600
  
  web:
    locale: zh_CN
    locale-resolver: accept_header
  
  datasource:
    url: jdbc:mysql://localhost:3306/binary_option?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 300000
      connection-timeout: 20000
      max-lifetime: 1200000
  
  redis:
    cluster:
      nodes:
        - 127.0.0.1:7001
        - 127.0.0.1:7002
        - 127.0.0.1:7003
        - 127.0.0.1:7004
        - 127.0.0.1:7005
        - 127.0.0.1:7006
    password: WOJdJ4HLWCQx9K3E
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
      cluster:
        refresh:
          adaptive: true
          period: 60s
  
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
        namespace: daba47a0-5f1d-4f53-aaaf-6f5490131ca1
      config:
        server-addr: 127.0.0.1:8848
        namespace: daba47a0-5f1d-4f53-aaaf-6f5490131ca1
        file-extension: yml
  
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
    default-property-inclusion: non_null
  
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=1000,expireAfterWrite=30m

server:
  port: 8084

# MyBatisé…ç½®
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.binaryoption.adminservice.domain
  configuration:
    map-underscore-to-camel-case: true
    use-generated-keys: true
    default-fetch-size: 100
    default-statement-timeout: 30

# æ—¥å¿—é…ç½®
logging:
  level:
    com.binaryoption.adminservice: DEBUG
    org.springframework.security: DEBUG
    com.binaryoption.adminservice.mapper: DEBUG
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ç®¡ç†ç«¯ç‚¹é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always

# Swaggeré…ç½®
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui/index.html

# Feigné…ç½®
feign:
  hystrix:
    enabled: true
  client:
    config:
      default:
        connect-timeout: 5000
        read-timeout: 10000

# æœåŠ¡é…ç½®
option:
  common-service:
    name: option-common-service
  order-service:
    name: option-order-service
  admin:
    jwt:
      secret: admin-jwt-secret-key-for-binary-option-platform-2024
      expiration: 86400000 # 24å°æ—¶
    sso:
      btse:
        enabled: true
        secret: btse-sso-shared-secret
        expiration: 300000 # 5åˆ†é’Ÿ

# å®‰å…¨é…ç½®
security:
  mode: jwt  # å¯ç”¨JWTè®¤è¯æ¨¡å¼
```

## 7. å®‰å…¨è®¾è®¡

### 7.1 æƒé™ä½“ç³»

```java
/**
 * æƒé™å®šä¹‰
 */
public class Permissions {
    // ç”¨æˆ·ç®¡ç†
    public static final String USER_VIEW = "user:view";
    public static final String USER_MANAGE = "user:manage";
    
    // è®¢å•ç®¡ç†
    public static final String ORDER_VIEW = "order:view";
    public static final String ORDER_MANAGE = "order:manage";
    
    // è´¦æˆ·ç®¡ç†
    public static final String BALANCE_VIEW = "balance:view";
    public static final String BALANCE_ADJUST = "balance:adjust";
    
    // é…ç½®ç®¡ç†
    public static final String CONFIG_VIEW = "config:view";
    public static final String CONFIG_MANAGE = "config:manage";
    
    // æŠ¥è¡¨æƒé™
    public static final String REPORT_VIEW = "report:view";
    public static final String REPORT_EXPORT = "report:export";
    
    // ç®¡ç†å‘˜ç®¡ç†
    public static final String ADMIN_VIEW = "admin:view";
    public static final String ADMIN_MANAGE = "admin:manage";
}
```

### 7.2 æ•°æ®æƒé™

```java
@Component
public class DataPermissionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // è·å–å½“å‰ç®¡ç†å‘˜
        AdminUser admin = SecurityUtils.getCurrentAdmin();
        
        // è¶…çº§ç®¡ç†å‘˜è·³è¿‡æ•°æ®æƒé™æ£€æŸ¥
        if (admin.hasRole("SUPER_ADMIN")) {
            return true;
        }
        
        // æ ¹æ®ä¸åŒè§’è‰²é™åˆ¶æ•°æ®è®¿é—®èŒƒå›´
        if (admin.hasRole("OPERATOR")) {
            // è¿è¥äººå‘˜åªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½ä¿®æ”¹
            String method = request.getMethod();
            if (!"GET".equals(method)) {
                throw new ForbiddenException("æ— ä¿®æ”¹æƒé™");
            }
        }
        
        return true;
    }
}
```

## 8. ç›‘æ§å’Œå‘Šè­¦

### 8.1 å…³é”®æŒ‡æ ‡ç›‘æ§

```java
@Component
@RequiredArgsConstructor
public class AdminMetrics {
    
    private final MeterRegistry meterRegistry;
    
    // æ“ä½œç»Ÿè®¡
    private final Map<String, Counter> operationCounters = new ConcurrentHashMap<>();
    
    // ç™»å½•ç»Ÿè®¡
    private final Counter loginSuccessCounter;
    private final Counter loginFailureCounter;
    
    // æŠ¥è¡¨æŸ¥è¯¢æ€§èƒ½
    private final Timer reportQueryTimer;
    
    @PostConstruct
    public void init() {
        loginSuccessCounter = Counter.builder("admin.login.success")
            .description("ç®¡ç†å‘˜ç™»å½•æˆåŠŸæ¬¡æ•°")
            .register(meterRegistry);
            
        loginFailureCounter = Counter.builder("admin.login.failure")
            .description("ç®¡ç†å‘˜ç™»å½•å¤±è´¥æ¬¡æ•°")
            .register(meterRegistry);
            
        reportQueryTimer = Timer.builder("admin.report.query")
            .description("æŠ¥è¡¨æŸ¥è¯¢å“åº”æ—¶é—´")
            .register(meterRegistry);
    }
    
    public void recordOperation(String operationType) {
        Counter counter = operationCounters.computeIfAbsent(operationType,
            type -> Counter.builder("admin.operation")
                .tag("type", type)
                .description("ç®¡ç†æ“ä½œæ¬¡æ•°")
                .register(meterRegistry));
        counter.increment();
    }
}
```

### 8.2 å¼‚å¸¸æ“ä½œå‘Šè­¦

```java
@Component
@RequiredArgsConstructor
public class AbnormalOperationDetector {
    
    private final NotificationService notificationService;
    
    @EventListener
    public void onOperationLog(OperationLogEvent event) {
        AdminOperationLog log = event.getLog();
        
        // æ£€æµ‹å¼‚å¸¸æ“ä½œ
        if (isAbnormalOperation(log)) {
            // å‘é€å‘Šè­¦
            String message = String.format(
                "æ£€æµ‹åˆ°å¼‚å¸¸æ“ä½œï¼šç®¡ç†å‘˜[%s]æ‰§è¡Œäº†[%s]æ“ä½œï¼Œç›®æ ‡ï¼š%s",
                log.getOperatorName(),
                log.getOperationType(),
                log.getTargetId()
            );
            
            notificationService.sendAlert("ABNORMAL_OPERATION", message);
        }
    }
    
    private boolean isAbnormalOperation(AdminOperationLog log) {
        // å¤§é¢ä½™é¢è°ƒæ•´
        if ("BALANCE_ADJUST".equals(log.getOperationType())) {
            BigDecimal amount = extractAmount(log.getRequestData());
            if (amount != null && amount.compareTo(new BigDecimal("10000")) > 0) {
                return true;
            }
        }
        
        // æ‰¹é‡ç”¨æˆ·çŠ¶æ€ä¿®æ”¹
        if ("USER_STATUS_UPDATE".equals(log.getOperationType()) && 
            log.getExecutionTime() > 5000) {
            return true;
        }
        
        // éå·¥ä½œæ—¶é—´çš„æ•æ„Ÿæ“ä½œ
        LocalTime now = LocalTime.now();
        if ((now.isBefore(LocalTime.of(8, 0)) || now.isAfter(LocalTime.of(22, 0))) &&
            isSensitiveOperation(log.getOperationType())) {
            return true;
        }
        
        return false;
    }
}
```

## 9. éƒ¨ç½²å»ºè®®

### 9.1 æœåŠ¡ä¾èµ–

```yaml
version: '3.8'
services:
  admin-service:
    image: option-admin-service:latest
    depends_on:
      - mysql
      - redis
      - nacos
      - common-service
      - order-service
      - market-service
    environment:
      - SPRING_PROFILES_ACTIVE=prod
    ports:
      - "8084:8084"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

### 9.2 æ€§èƒ½ä¼˜åŒ–

1. **æŸ¥è¯¢ä¼˜åŒ–**
   - æŠ¥è¡¨æŸ¥è¯¢ä½¿ç”¨ç‰©åŒ–è§†å›¾
   - å¤æ‚ç»Ÿè®¡é¢„å…ˆè®¡ç®—å­˜å‚¨
   - åˆç†ä½¿ç”¨ç¼“å­˜ç­–ç•¥

2. **å¹¶å‘æ§åˆ¶**
   - æ•æ„Ÿæ“ä½œåŠ åˆ†å¸ƒå¼é”
   - æ‰¹é‡æ“ä½œé™æµ
   - å¼‚æ­¥å¤„ç†æ—¥å¿—è®°å½•

3. **å®‰å…¨åŠ å›º**
   - åŒå› ç´ è®¤è¯
   - IPç™½åå•
   - æ“ä½œå®¡è®¡

## 10. BTSEç³»ç»ŸSSOé›†æˆ

### 10.1 æ¦‚è¿°

ä¸ºäº†ä¸BTSEç³»ç»Ÿæ‰“é€šï¼Œç®¡ç†åå°æ”¯æŒé€šè¿‡å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰æ–¹å¼ä»BTSEç³»ç»Ÿè·³è½¬è¿›å…¥ã€‚é‡‡ç”¨JWTä»¤ç‰Œäº¤æ¢æœºåˆ¶ï¼Œç¡®ä¿å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

### 10.2 SSOæµç¨‹è®¾è®¡

```mermaid
sequenceDiagram
    participant BTSE as BTSEç³»ç»Ÿ
    participant Browser as æµè§ˆå™¨
    participant SSO as SSOé¡µé¢(/auth/sso)
    participant AdminAPI as Admin Service API
    participant Redis as Redisç¼“å­˜
    participant DB as æ•°æ®åº“

    BTSE->>BTSE: ç®¡ç†å‘˜ç™»å½•BTSE
    BTSE->>BTSE: ç”Ÿæˆä¸´æ—¶Token(JWT)
    BTSE->>BTSE: è®¡ç®—ç­¾å(MD5)
    BTSE->>Browser: é‡å®šå‘åˆ°äºŒå…ƒæœŸæƒç³»ç»Ÿ
    Note over Browser: URL: /auth/sso?token=xxx&timestamp=xxx&signature=xxx
    
    Browser->>SSO: GET /auth/sso
    SSO->>Browser: è¿”å›éªŒè¯é¡µé¢(HTML+JS)
    Browser->>AdminAPI: POST /auth/sso/verify
    Note over AdminAPI: 1. éªŒè¯æ—¶é—´æˆ³(é˜²é‡æ”¾)
    Note over AdminAPI: 2. éªŒè¯ç­¾å(é˜²ç¯¡æ”¹)
    Note over AdminAPI: 3. éªŒè¯ä»¤ç‰Œæœªä½¿ç”¨
    
    AdminAPI->>AdminAPI: è§£æBTSEä»¤ç‰Œ
    AdminAPI->>DB: æŸ¥æ‰¾æˆ–åˆ›å»ºç®¡ç†å‘˜
    DB-->>AdminAPI: è¿”å›ç®¡ç†å‘˜ä¿¡æ¯
    AdminAPI->>DB: æ›´æ–°ç™»å½•ä¿¡æ¯å’Œæƒé™
    AdminAPI->>Redis: è®°å½•ä»¤ç‰Œä½¿ç”¨çŠ¶æ€
    AdminAPI->>AdminAPI: ç”Ÿæˆæœ¬åœ°JWT
    AdminAPI-->>Browser: è¿”å›JWTå’Œç”¨æˆ·ä¿¡æ¯
    
    Browser->>Browser: å­˜å‚¨JWTåˆ°localStorage
    Browser->>Browser: è·³è½¬åˆ°ç®¡ç†åå°
```

### 10.3 å…·ä½“å®ç°æ­¥éª¤

#### âœ… å·²å®ç°ï¼šå®Œæ•´çš„BTSE SSOé›†æˆåŠŸèƒ½

**å®ç°æ–‡ä»¶ä½ç½®ï¼š**
- `SsoController.java`: `/option-admin-service/src/main/java/com/binaryoption/adminservice/controller/SsoController.java`
- `SsoService.java`: `/option-admin-service/src/main/java/com/binaryoption/adminservice/service/SsoService.java`
- DTOç±»: `/option-common-dto/src/main/java/com/binaryoption/commondto/admin/`
  - `SsoVerifyRequestDTO.java`
  - `SsoLoginResponseDTO.java`
  - `BtseAdminInfoDTO.java`

#### 10.3.1 ä»£ç è°ƒç”¨æµç¨‹

**å®Œæ•´çš„SSOéªŒè¯æµç¨‹ï¼š**

```java
// 1. ç”¨æˆ·è®¿é—® /auth/sso?token=xxx&timestamp=xxx&signature=xxx
// SsoController.ssoRedirectPage() è¿”å›HTMLéªŒè¯é¡µé¢

// 2. å‰ç«¯JavaScriptè‡ªåŠ¨æå–URLå‚æ•°å¹¶å‘èµ·éªŒè¯è¯·æ±‚
// POST /auth/sso/verify
{
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "timestamp": "1706068800000",
    "signature": "a1b2c3d4e5f6..."
}

// 3. SsoController.verifySsoToken() å¤„ç†éªŒè¯è¯·æ±‚
@PostMapping("/verify")
public Result<SsoLoginResponseDTO> verifySsoToken(SsoVerifyRequestDTO request) {
    // è°ƒç”¨SsoServiceè¿›è¡ŒéªŒè¯
    AdminUser adminUser = ssoService.verifySsoTokenAndSyncAdmin(
        request.getToken(), 
        request.getTimestamp(), 
        request.getSignature()
    );
    
    // ç”Ÿæˆæœ¬åœ°JWT
    String jwt = jwtUtil.generateToken(claims);
    
    // è¿”å›ç™»å½•ä¿¡æ¯
    return Result.success(response);
}

// 4. SsoService.verifySsoTokenAndSyncAdmin() æ ¸å¿ƒéªŒè¯é€»è¾‘
@Transactional
public AdminUser verifySsoTokenAndSyncAdmin(String token, String timestamp, String signature) {
    // Step 1: éªŒè¯æ—¶é—´æˆ³ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
    validateTimestamp(timestamp);
    
    // Step 2: éªŒè¯ç­¾å
    String expectedSignature = MD5(token + ":" + timestamp + ":" + sharedSecret);
    if (!expectedSignature.equals(signature)) {
        throw new BusinessException(401, "ç­¾åéªŒè¯å¤±è´¥");
    }
    
    // Step 3: é˜²é‡æ”¾æ”»å‡»
    String tokenKey = "sso:token:" + MD5(token);
    if (redisTemplate.hasKey(tokenKey)) {
        throw new BusinessException(401, "SSOä»¤ç‰Œå·²ä½¿ç”¨");
    }
    redisTemplate.opsForValue().set(tokenKey, timestamp, 10, TimeUnit.MINUTES);
    
    // Step 4: è§£æBTSEä»¤ç‰Œ
    BtseAdminInfoDTO btseAdmin = parseBtseToken(token);
    
    // Step 5: åŒæ­¥ç®¡ç†å‘˜ä¿¡æ¯
    AdminUser localAdmin = syncFromBtse(btseAdmin);
    
    // Step 6: è®°å½•æ“ä½œæ—¥å¿—
    operationLogService.log("SSO_LOGIN", "ADMIN_AUTH", localAdmin.getId());
    
    return localAdmin;
}

// 5. ç®¡ç†å‘˜åŒæ­¥é€»è¾‘
private AdminUser syncFromBtse(BtseAdminInfoDTO btseAdmin) {
    // æŸ¥æ‰¾å·²å­˜åœ¨çš„ç®¡ç†å‘˜
    AdminUser localAdmin = adminUserMapper.findByExternalId(btseAdmin.getBtseUserId());
    
    if (localAdmin == null) {
        // é¦–æ¬¡ç™»å½•ï¼Œåˆ›å»ºæœ¬åœ°è´¦æˆ·
        localAdmin = AdminUser.builder()
            .externalId(btseAdmin.getBtseUserId())
            .username(btseAdmin.getUsername())
            .email(btseAdmin.getEmail())
            .source("BTSE")
            .build();
        adminUserMapper.insert(localAdmin);
    } else {
        // æ›´æ–°ä¿¡æ¯
        adminUserMapper.updateSsoLoginInfo(
            localAdmin.getId(), 
            LocalDateTime.now(), 
            clientIp, 
            "SSO"
        );
    }
    
    // åŒæ­¥è§’è‰²æƒé™
    syncRoles(localAdmin.getId(), btseAdmin.getRoles());
    
    return localAdmin;
}
```

#### 10.3.2 BTSEç«¯ä»¤ç‰Œç”Ÿæˆï¼ˆéœ€BTSEç³»ç»Ÿå®ç°ï¼‰

BTSEç³»ç»Ÿåœ¨ç”¨æˆ·ç‚¹å‡»è·³è½¬æ—¶ï¼Œç”ŸæˆåŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ä¸´æ—¶JWTä»¤ç‰Œï¼š

```java
// BTSEç³»ç»Ÿç«¯ä»£ç ç¤ºä¾‹ï¼ˆéœ€è¦BTSEç³»ç»Ÿå®ç°ï¼‰
public class BtseAdminController {
    
    @GetMapping("/admin/redirect-to-binary-option")
    public String redirectToBinaryOption(HttpServletRequest request) {
        // è·å–å½“å‰ç™»å½•çš„ç®¡ç†å‘˜
        BtseAdmin admin = getCurrentAdmin(request);
        
        // ç”Ÿæˆä¸´æ—¶ä»¤ç‰Œï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰
        String token = generateTemporaryToken(admin);
        long timestamp = System.currentTimeMillis();
        
        // ç”Ÿæˆç­¾åï¼ˆé˜²ç¯¡æ”¹ï¼‰
        String signature = generateSignature(token, timestamp);
        
        // æ„å»ºè·³è½¬URL
        String redirectUrl = String.format(
            "%s/auth/sso?token=%s&timestamp=%s&signature=%s",
            BINARY_OPTION_URL,  // äºŒå…ƒæœŸæƒç³»ç»Ÿåœ°å€
            token,
            timestamp,
            signature
        );
        
        return "redirect:" + redirectUrl;
    }
    
    /**
     * ç”ŸæˆBTSEä¸´æ—¶ä»¤ç‰Œ
     */
    private String generateTemporaryToken(BtseAdmin admin) {
        return Jwts.builder()
            .setSubject(admin.getId())  // BTSEç”¨æˆ·ID
            .claim("username", admin.getUsername())
            .claim("email", admin.getEmail())
            .claim("realName", admin.getRealName())
            .claim("roles", admin.getRoles())  // BTSEè§’è‰²åˆ—è¡¨
            .claim("active", admin.isActive())
            .claim("department", admin.getDepartment())
            .setExpiration(new Date(System.currentTimeMillis() + 5 * 60 * 1000))  // 5åˆ†é’Ÿè¿‡æœŸ
            .signWith(SignatureAlgorithm.HS256, SHARED_SECRET)  // å…±äº«å¯†é’¥ç­¾å
            .compact();
    }
    
    /**
     * ç”Ÿæˆç­¾åï¼ˆMD5ï¼‰
     */
    private String generateSignature(String token, long timestamp) {
        String data = token + ":" + timestamp + ":" + SHARED_SECRET;
        return DigestUtils.md5DigestAsHex(data.getBytes());
    }
}
```

#### 10.3.3 âœ… å·²å®ç°ï¼šSSOéªŒè¯æ¥å£

**å®é™…å®ç°çš„SsoController.javaï¼š**

```java
@Tag(name = "BTSE SSO", description = "BTSEç³»ç»Ÿå•ç‚¹ç™»å½•ç›¸å…³æ¥å£")
@RestController
@RequestMapping("/auth/sso")
@RequiredArgsConstructor
@Slf4j
public class SsoController {
    
    private final SsoService ssoService;
    private final PermissionService permissionService;
    private final JwtUtil jwtUtil;
    
    /**
     * SSOè·³è½¬é¡µé¢
     */
    @GetMapping("")
    @Operation(summary = "SSOè·³è½¬é¡µé¢", description = "ä»BTSEç³»ç»Ÿè·³è½¬çš„SSOç™»å½•é¡µé¢")
    public String ssoRedirectPage() {
        // è¿”å›å†…åµŒçš„HTMLé¡µé¢ï¼ŒåŒ…å«JavaScriptå¤„ç†SSOéªŒè¯
        return """
            <!DOCTYPE html>
            <html>
            <head>
                <title>æ­£åœ¨ç™»å½•...</title>
                <meta charset="UTF-8">
                <script>
                    async function handleSSO() {
                        const params = new URLSearchParams(window.location.search);
                        const token = params.get('token');
                        const timestamp = params.get('timestamp');
                        const signature = params.get('signature');
                        
                        try {
                            const response = await fetch('/auth/sso/verify', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ token, timestamp, signature })
                            });
                            
                            const data = await response.json();
                            
                            if (data.code === 200) {
                                // å­˜å‚¨JWTå’Œç”¨æˆ·ä¿¡æ¯åˆ°localStorage
                                localStorage.setItem('admin_token', data.data.token);
                                localStorage.setItem('admin_info', JSON.stringify(data.data));
                                
                                // è·³è½¬åˆ°Swaggerç®¡ç†é¡µé¢
                                window.location.href = '/swagger-ui/index.html';
                            } else {
                                alert('ç™»å½•å¤±è´¥ï¼š' + data.message);
                                window.location.href = '/auth/login';
                            }
                        } catch (error) {
                            console.error('SSOéªŒè¯å¤±è´¥', error);
                            window.location.href = '/auth/login';
                        }
                    }
                    
                    window.onload = handleSSO;
                </script>
            </head>
            <body>
                <div style="text-align: center; margin-top: 100px;">
                    <h2>æ­£åœ¨éªŒè¯BTSEèº«ä»½ï¼Œè¯·ç¨å€™...</h2>
                    <div class="spinner"></div>
                </div>
            </body>
            </html>
            """;
    }
    
    /**
     * éªŒè¯SSOä»¤ç‰Œ
     */
    @PostMapping("/verify")
    @Operation(summary = "éªŒè¯SSOä»¤ç‰Œ", description = "éªŒè¯BTSEç³»ç»Ÿä¼ é€’çš„SSOä»¤ç‰Œå¹¶è¿”å›æœ¬åœ°JWT")
    public Result<SsoLoginResponseDTO> verifySsoToken(@RequestBody @Valid SsoVerifyRequestDTO request,
                                                     HttpServletRequest httpRequest) {
        try {
            log.info("æ”¶åˆ°BTSE SSOéªŒè¯è¯·æ±‚: timestamp={}, ip={}", 
                    request.getTimestamp(), getClientIp(httpRequest));
            
            // 1. éªŒè¯SSOä»¤ç‰Œå¹¶åŒæ­¥ç®¡ç†å‘˜ä¿¡æ¯
            AdminUser adminUser = ssoService.verifySsoTokenAndSyncAdmin(
                request.getToken(), 
                request.getTimestamp(), 
                request.getSignature()
            );
            
            // 2. ç”Ÿæˆæœ¬åœ°JWTä»¤ç‰Œ
            Map<String, Object> claims = new HashMap<>();
            claims.put("adminId", adminUser.getId());
            claims.put("username", adminUser.getUsername());
            claims.put("source", adminUser.getSource());
            
            String jwt = jwtUtil.generateToken(claims);
            
            // 3. è·å–æƒé™åˆ—è¡¨
            List<String> permissions = permissionService.parsePermissions(adminUser.getPermissions());
            List<String> roles = adminUser.getRole() != null ? 
                Arrays.asList(adminUser.getRole().split(",")) : List.of();
            
            // 4. æ„å»ºå“åº”
            SsoLoginResponseDTO response = SsoLoginResponseDTO.builder()
                .token(jwt)
                .adminId(adminUser.getId())
                .username(adminUser.getUsername())
                .email(adminUser.getEmail())
                .roles(roles)
                .permissions(permissions)
                .externalId(adminUser.getExternalId())
                .source(adminUser.getSource())
                .build();
            
            log.info("BTSE SSOéªŒè¯æˆåŠŸ: adminId={}, username={}", 
                    adminUser.getId(), adminUser.getUsername());
            
            return Result.success(response);
            
        } catch (Exception e) {
            log.error("BTSE SSOéªŒè¯å¤±è´¥", e);
            return Result.error(401, "SSOéªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * SSOçŠ¶æ€æ£€æŸ¥
     */
    @GetMapping("/status")
    @Operation(summary = "SSOçŠ¶æ€æ£€æŸ¥", description = "æ£€æŸ¥SSOé…ç½®å’ŒæœåŠ¡çŠ¶æ€")
    public Result<Map<String, Object>> getSsoStatus() {
        Map<String, Object> status = new HashMap<>();
        status.put("ssoEnabled", true);
        status.put("provider", "BTSE");
        status.put("timestamp", System.currentTimeMillis());
        status.put("version", "1.0");
        
        return Result.success(status);
    }
}
```

#### 10.3.4 âœ… å·²å®ç°ï¼šç®¡ç†å‘˜åŒæ­¥æœåŠ¡

**å®é™…å®ç°çš„SsoService.javaæ ¸å¿ƒåŠŸèƒ½ï¼š**

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class SsoService {
    
    private final AdminUserMapper adminUserMapper;
    private final OperationLogService operationLogService;
    private final JwtUtil jwtUtil;
    private final RedisTemplate<String, String> redisTemplate;
    
    @Value("${option.admin.sso.btse.secret}")
    private String btseSharedSecret;
    
    @Value("${option.admin.sso.btse.expiration:300000}")
    private long btseTokenExpiration;
    
    /**
     * éªŒè¯SSOä»¤ç‰Œå¹¶åˆ›å»º/æ›´æ–°æœ¬åœ°ç®¡ç†å‘˜
     */
    @Transactional
    public AdminUser verifySsoTokenAndSyncAdmin(String token, String timestamp, String signature) {
        // 1. éªŒè¯æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
        validateTimestamp(timestamp);
        
        // 2. éªŒè¯ç­¾å
        validateSignature(token, timestamp, signature);
        
        // 3. éªŒè¯ä»¤ç‰Œæ˜¯å¦å·²ä½¿ç”¨
        validateTokenUsage(token);
        
        // 4. è§£æBTSEä»¤ç‰Œ
        BtseAdminInfoDTO btseAdmin = parseBtseToken(token);
        
        // 5. åˆ›å»ºæˆ–æ›´æ–°æœ¬åœ°ç®¡ç†å‘˜è´¦æˆ·
        AdminUser localAdmin = syncFromBtse(btseAdmin);
        
        // 6. è®°å½•SSOç™»å½•æ—¥å¿—
        operationLogService.log("SSO_LOGIN", "ADMIN_AUTH", localAdmin.getId().toString(),
            Map.of("btseUserId", btseAdmin.getBtseUserId(), "source", "BTSE"));
        
        log.info("BTSE SSOç™»å½•æˆåŠŸ: btseUserId={}, localAdminId={}", 
                btseAdmin.getBtseUserId(), localAdmin.getId());
        
        return localAdmin;
    }
    
    /**
     * åŒæ­¥BTSEç®¡ç†å‘˜åˆ°æœ¬åœ°
     */
    @Transactional
    public AdminUser syncFromBtse(BtseAdminInfoDTO btseAdmin) {
        // æŸ¥æ‰¾æˆ–åˆ›å»ºæœ¬åœ°ç®¡ç†å‘˜
        AdminUser localAdmin = adminUserMapper.findByExternalId(btseAdmin.getBtseUserId());
        
        if (localAdmin == null) {
            // é¦–æ¬¡ç™»å½•ï¼Œåˆ›å»ºæœ¬åœ°è´¦æˆ·
            localAdmin = AdminUser.builder()
                .externalId(btseAdmin.getBtseUserId())
                .username(btseAdmin.getUsername())
                .email(btseAdmin.getEmail())
                .realName(btseAdmin.getRealName())
                .status(btseAdmin.getActive() ? 1 : 0)
                .source("BTSE")
                .createTime(LocalDateTime.now())
                .build();
            
            adminUserMapper.insert(localAdmin);
            log.info("åˆ›å»ºBTSEç®¡ç†å‘˜æœ¬åœ°è´¦æˆ·: btseUserId={}, localId={}", 
                    btseAdmin.getBtseUserId(), localAdmin.getId());
        } else {
            // æ›´æ–°ä¿¡æ¯
            localAdmin.setEmail(btseAdmin.getEmail());
            localAdmin.setRealName(btseAdmin.getRealName());
            localAdmin.setStatus(btseAdmin.getActive() ? 1 : 0);
            localAdmin.setLastLoginTime(LocalDateTime.now());
            localAdmin.setLastLoginType("SSO");
            localAdmin.setUpdateTime(LocalDateTime.now());
            
            adminUserMapper.update(localAdmin);
            log.info("æ›´æ–°BTSEç®¡ç†å‘˜ä¿¡æ¯: btseUserId={}, localId={}", 
                    btseAdmin.getBtseUserId(), localAdmin.getId());
        }
        
        // åŒæ­¥è§’è‰²æƒé™
        syncRoles(localAdmin.getId(), btseAdmin.getRoles());
        
        return localAdmin;
    }
    
    /**
     * åŒæ­¥è§’è‰²æƒé™ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥æ˜ å°„åˆ°æƒé™å­—ç¬¦ä¸²ï¼‰
     */
    private void syncRoles(Long adminId, List<String> btseRoles) {
        if (btseRoles == null || btseRoles.isEmpty()) {
            return;
        }
        
        // BTSEè§’è‰²åˆ°æœ¬åœ°æƒé™çš„æ˜ å°„
        StringBuilder permissions = new StringBuilder();
        for (String btseRole : btseRoles) {
            switch (btseRole) {
                case "BTSE_SUPER_ADMIN":
                    permissions.append("admin:manage,user:manage,order:manage,config:manage,report:export");
                    break;
                case "BTSE_OPERATOR":
                    permissions.append("user:view,order:view,order:manage,report:view");
                    break;
                case "BTSE_VIEWER":
                    permissions.append("user:view,order:view,report:view");
                    break;
                case "BTSE_RISK_MANAGER":
                    permissions.append("user:manage,order:manage,report:view,report:export");
                    break;
                default:
                    log.warn("æœªçŸ¥çš„BTSEè§’è‰²: {}", btseRole);
            }
            
            if (permissions.length() > 0) {
                permissions.append(",");
            }
        }
        
        // æ›´æ–°æƒé™
        if (permissions.length() > 0) {
            AdminUser admin = adminUserMapper.findById(adminId);
            admin.setPermissions(permissions.toString());
            adminUserMapper.update(admin);
        }
    }
    
    /**
     * è§£æBTSEä»¤ç‰Œ
     */
    private BtseAdminInfoDTO parseBtseToken(String token) {
        try {
            Claims claims = Jwts.parser()
                .setSigningKey(btseSharedSecret)
                .parseClaimsJws(token)
                .getBody();
            
            return BtseAdminInfoDTO.builder()
                .btseUserId(claims.getSubject())
                .username((String) claims.get("username"))
                .email((String) claims.get("email"))
                .realName((String) claims.get("realName"))
                .roles((List<String>) claims.get("roles"))
                .active((Boolean) claims.get("active"))
                .department((String) claims.get("department"))
                .build();
                
        } catch (Exception e) {
            log.error("è§£æBTSEä»¤ç‰Œå¤±è´¥", e);
            throw new BusinessException(401, "æ— æ•ˆçš„SSOä»¤ç‰Œ");
        }
    }
    
    /**
     * éªŒè¯ç­¾å
     */
    private void validateSignature(String token, String timestamp, String signature) {
        String expectedSignature = generateSignature(token, timestamp);
        if (!expectedSignature.equals(signature)) {
            log.warn("SSOç­¾åéªŒè¯å¤±è´¥: expected={}, actual={}", expectedSignature, signature);
            throw new BusinessException(401, "ç­¾åéªŒè¯å¤±è´¥");
        }
    }
    
    /**
     * ç”Ÿæˆç­¾å
     */
    private String generateSignature(String token, String timestamp) {
        String data = token + ":" + timestamp + ":" + btseSharedSecret;
        return DigestUtils.md5DigestAsHex(data.getBytes());
    }
}
```

### 10.4 æ•°æ®åº“æ“ä½œæµç¨‹

**SSOç›¸å…³çš„æ•°æ®åº“æ“ä½œï¼š**

```sql
-- 1. æŸ¥æ‰¾BTSEç®¡ç†å‘˜
SELECT * FROM admin_user WHERE external_id = #{externalId}

-- 2. åˆ›å»ºæ–°ç®¡ç†å‘˜ï¼ˆé¦–æ¬¡SSOç™»å½•ï¼‰
INSERT INTO admin_user (
    username, email, real_name, external_id, source, 
    status, permissions, create_time
) VALUES (
    #{username}, #{email}, #{realName}, #{externalId}, 'BTSE',
    1, #{permissions}, NOW()
)

-- 3. æ›´æ–°SSOç™»å½•ä¿¡æ¯
UPDATE admin_user SET 
    last_login_time = #{lastLoginTime},
    last_login_ip = #{lastLoginIp},
    last_login_type = 'SSO'
WHERE id = #{id}

-- 4. è®°å½•æ“ä½œæ—¥å¿—
INSERT INTO admin_operation_log (
    operator_id, operator_name, operation_type, operation_desc,
    target_type, target_id, ip_address, result, create_time
) VALUES (
    #{operatorId}, #{operatorName}, 'SSO_LOGIN', 'BTSE SSOç™»å½•',
    'ADMIN_AUTH', #{targetId}, #{ipAddress}, 1, NOW()
)
```

### 10.5 å®‰å…¨æªæ–½

#### 10.5.1 é˜²é‡æ”¾æ”»å‡»

```java
@Component
public class SsoTokenValidator {
    
    private final RedisTemplate<String, String> redisTemplate;
    
    public void validateAndRecordToken(String token, String timestamp) {
        String key = "sso:token:" + token;
        
        // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦å·²ä½¿ç”¨
        Boolean exists = redisTemplate.hasKey(key);
        if (Boolean.TRUE.equals(exists)) {
            throw new BusinessException("SSOä»¤ç‰Œå·²ä½¿ç”¨");
        }
        
        // è®°å½•ä»¤ç‰Œï¼Œè®¾ç½®10åˆ†é’Ÿè¿‡æœŸ
        redisTemplate.opsForValue().set(key, timestamp, 10, TimeUnit.MINUTES);
    }
}
```

#### 10.5.2 IPç™½åå•éªŒè¯

```java
@Component
public class IpWhitelistFilter implements Filter {
    
    @Value("${btse.ip.whitelist}")
    private List<String> btseIpWhitelist;
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) {
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        
        // åªå¯¹SSOæ¥å£è¿›è¡ŒIPéªŒè¯
        if (httpRequest.getRequestURI().startsWith("/api/auth/sso")) {
            String clientIp = getClientIp(httpRequest);
            if (!btseIpWhitelist.contains(clientIp)) {
                log.warn("éæ³•SSOè®¿é—®å°è¯•ï¼ŒIP: {}", clientIp);
                throw new ForbiddenException("è®¿é—®è¢«æ‹’ç»");
            }
        }
        
        chain.doFilter(request, response);
    }
}
```

#### 10.5.3 ä¼šè¯ç®¡ç†

```java
@Service
public class AdminSessionService {
    
    /**
     * ç¼“å­˜SSOä¼šè¯ä¿¡æ¯
     */
    public void cacheSession(AdminUser admin, BtseAdminInfo btseInfo) {
        String sessionKey = "admin:session:" + admin.getId();
        
        AdminSession session = AdminSession.builder()
            .adminId(admin.getId())
            .username(admin.getUsername())
            .btseUserId(btseInfo.getBtseUserId())
            .roles(admin.getRoles())
            .permissions(admin.getPermissions())
            .loginTime(LocalDateTime.now())
            .loginType("SSO")
            .build();
        
        // ç¼“å­˜2å°æ—¶
        redisTemplate.opsForValue().set(sessionKey, session, 2, TimeUnit.HOURS);
    }
    
    /**
     * éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§
     */
    public void validateSession(Long adminId) {
        String sessionKey = "admin:session:" + adminId;
        AdminSession session = (AdminSession) redisTemplate.opsForValue().get(sessionKey);
        
        if (session == null) {
            throw new UnauthorizedException("ä¼šè¯å·²è¿‡æœŸ");
        }
        
        // æ£€æŸ¥BTSEç«¯çŠ¶æ€ï¼ˆå¯é€‰ï¼Œå½±å“æ€§èƒ½ï¼‰
        if (shouldCheckBtseStatus(session)) {
            BtseUserStatus status = btseApiClient.checkAdminStatus(session.getBtseUserId());
            if (!status.isActive()) {
                redisTemplate.delete(sessionKey);
                throw new UnauthorizedException("BTSEè´¦æˆ·å·²è¢«ç¦ç”¨");
            }
        }
    }
}
```

### 10.6 é…ç½®ç®¡ç†

```yaml
# SSOç›¸å…³é…ç½®
btse:
  sso:
    enabled: true
    secret: ${BTSE_SSO_SECRET:shared-secret-key}
    token-expire-minutes: 5
    allowed-redirect-urls:
      - https://admin.binaryoption.com
      - https://test-admin.binaryoption.com
  ip:
    whitelist:
      - 10.0.0.1
      - 10.0.0.2
      - ${BTSE_IP_RANGE:10.0.0.0/24}
  api:
    base-url: https://api.btse.com
    timeout: 5000
    admin-verify-endpoint: /admin/verify

# è§’è‰²æ˜ å°„é…ç½®
role-mapping:
  btse-to-local:
    BTSE_SUPER_ADMIN: SUPER_ADMIN
    BTSE_OPERATOR: OPERATOR
    BTSE_VIEWER: VIEWER
    BTSE_RISK_MANAGER: RISK_MANAGER
```

### 10.7 å‰ç«¯è·³è½¬é¡µé¢

```html
<!-- /auth/sso è·³è½¬é¡µé¢ -->
<!DOCTYPE html>
<html>
<head>
    <title>æ­£åœ¨ç™»å½•...</title>
    <script>
        async function handleSSO() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const timestamp = params.get('timestamp');
            const signature = params.get('signature');
            
            try {
                // è°ƒç”¨åç«¯éªŒè¯æ¥å£
                const response = await fetch('/api/auth/sso/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        timestamp: timestamp,
                        signature: signature
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // å­˜å‚¨JWTåˆ°localStorage
                    localStorage.setItem('admin_token', data.token);
                    // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
                    localStorage.setItem('admin_info', JSON.stringify({
                        adminId: data.adminId,
                        username: data.username,
                        roles: data.roles
                    }));
                    // è·³è½¬åˆ°ç®¡ç†åå°é¦–é¡µ
                    window.location.href = '/admin/dashboard';
                } else {
                    alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡æ–°ä»BTSEç³»ç»Ÿè¿›å…¥');
                    window.location.href = '/admin/login';
                }
            } catch (error) {
                console.error('SSOéªŒè¯å¤±è´¥', error);
                window.location.href = '/admin/login';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = handleSSO;
    </script>
</head>
<body>
    <div style="text-align: center; margin-top: 100px;">
        <h2>æ­£åœ¨éªŒè¯èº«ä»½ï¼Œè¯·ç¨å€™...</h2>
        <div class="spinner"></div>
    </div>
</body>
</html>
```

### 10.8 SSOç›¸å…³æ•°æ®è¡¨

```sql
-- SSOä»¤ç‰Œè®°å½•è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºå®¡è®¡ï¼‰
CREATE TABLE `sso_token_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `token_hash` varchar(128) NOT NULL COMMENT 'ä»¤ç‰Œå“ˆå¸Œå€¼',
  `btse_user_id` varchar(64) NOT NULL COMMENT 'BTSEç”¨æˆ·ID',
  `admin_id` bigint DEFAULT NULL COMMENT 'æœ¬åœ°ç®¡ç†å‘˜ID',
  `status` varchar(16) NOT NULL COMMENT 'çŠ¶æ€(PENDING:å¾…éªŒè¯ SUCCESS:æˆåŠŸ FAILED:å¤±è´¥ EXPIRED:è¿‡æœŸ)',
  `ip_address` varchar(64) DEFAULT NULL COMMENT 'è¯·æ±‚IP',
  `user_agent` varchar(255) DEFAULT NULL COMMENT 'ç”¨æˆ·ä»£ç†',
  `error_msg` varchar(500) DEFAULT NULL COMMENT 'é”™è¯¯ä¿¡æ¯',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `verify_time` datetime DEFAULT NULL COMMENT 'éªŒè¯æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_token_hash` (`token_hash`),
  KEY `idx_btse_user_id` (`btse_user_id`),
  KEY `idx_admin_id` (`admin_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB COMMENT='SSOä»¤ç‰Œè®°å½•è¡¨';
```

### 10.9 âœ… å®ç°å®Œæˆæ€»ç»“

#### å·²å®ç°çš„SSOåŠŸèƒ½

**ğŸ‰ BTSE SSOé›†æˆå·²å®Œå…¨å®ç°ï¼**

**å®ç°æ–‡ä»¶æ¸…å•ï¼š**
1. **SsoController.java** - SSOæ§åˆ¶å™¨ï¼Œå¤„ç†è·³è½¬å’ŒéªŒè¯
2. **SsoService.java** - SSOæœåŠ¡ï¼Œä»¤ç‰ŒéªŒè¯å’Œç”¨æˆ·åŒæ­¥
3. **AdminUser.java** - ç®¡ç†å‘˜å®ä½“ï¼Œå¢åŠ SSOç›¸å…³å­—æ®µ
4. **AdminUserMapper.java** - æ•°æ®è®¿é—®ï¼Œå¢åŠ SSOç›¸å…³æ–¹æ³•
5. **DTOç±»** - å®Œæ•´çš„è¯·æ±‚/å“åº”æ•°æ®ä¼ è¾“å¯¹è±¡
6. **init.sql** - æ•°æ®åº“è¡¨ç»“æ„ï¼Œæ”¯æŒSSOå­—æ®µ

**æ ¸å¿ƒåŠŸèƒ½ç‚¹ï¼š**
- âœ… **ä»¤ç‰ŒéªŒè¯**ï¼šæ—¶é—´æˆ³ã€ç­¾åã€é‡æ”¾æ”»å‡»é˜²æŠ¤
- âœ… **ç”¨æˆ·åŒæ­¥**ï¼šè‡ªåŠ¨åˆ›å»º/æ›´æ–°BTSEç®¡ç†å‘˜æœ¬åœ°è´¦æˆ·
- âœ… **è§’è‰²æ˜ å°„**ï¼šBTSEè§’è‰²åˆ°æœ¬åœ°æƒé™çš„è‡ªåŠ¨æ˜ å°„
- âœ… **å®‰å…¨æªæ–½**ï¼šé˜²é‡æ”¾ã€ç­¾åéªŒè¯ã€ä»¤ç‰Œè¿‡æœŸ
- âœ… **æ“ä½œæ—¥å¿—**ï¼šå®Œæ•´çš„SSOç™»å½•å®¡è®¡è®°å½•
- âœ… **å‰ç«¯é›†æˆ**ï¼šå†…åµŒHTMLé¡µé¢è‡ªåŠ¨å¤„ç†SSOæµç¨‹

**æµ‹è¯•æ–¹æ³•ï¼š**
1. **SSOçŠ¶æ€æ£€æŸ¥**: `GET /auth/sso/status`
2. **æ¨¡æ‹ŸBTSEè·³è½¬**: `GET /auth/sso?token={token}&timestamp={timestamp}&signature={signature}`
3. **ç›´æ¥éªŒè¯**: `POST /auth/sso/verify`

**é…ç½®è¯´æ˜ï¼š**
```yaml
option:
  admin:
    sso:
      btse:
        enabled: true
        secret: btse-sso-shared-secret  # ä¸BTSEç³»ç»Ÿå…±äº«çš„å¯†é’¥
        expiration: 300000  # 5åˆ†é’Ÿä»¤ç‰Œæœ‰æ•ˆæœŸ
```

#### éƒ¨ç½²å’Œä½¿ç”¨æ­¥éª¤

**Step 1: BTSEç³»ç»Ÿé›†æˆï¼ˆéœ€BTSEæ–¹å®ç°ï¼‰**
```java
// BTSEç³»ç»Ÿéœ€è¦å®ç°è·³è½¬é€»è¾‘ï¼Œç”Ÿæˆä»¤ç‰Œå’Œç­¾å
String redirectUrl = "http://localhost:8084/auth/sso?token=" + token + 
                    "&timestamp=" + timestamp + "&signature=" + signature;
```

**Step 2: äºŒå…ƒæœŸæƒç³»ç»Ÿé…ç½®**
```yaml
# åœ¨application.ymlä¸­é…ç½®å…±äº«å¯†é’¥
option:
  admin:
    sso:
      btse:
        secret: your-shared-secret-key
```

**Step 3: æ•°æ®åº“å‡†å¤‡**
```sql
-- æ‰§è¡Œinit.sqlåˆ›å»ºadmin_userè¡¨ï¼ŒåŒ…å«SSOç›¸å…³å­—æ®µ
-- external_id, source, last_login_typeç­‰å­—æ®µ
```

**Step 4: è®¿é—®æµ‹è¯•**
1. è®¿é—® `http://localhost:8084/auth/sso/status` æ£€æŸ¥SSOæœåŠ¡çŠ¶æ€
2. ä»BTSEç³»ç»Ÿè·³è½¬åˆ°äºŒå…ƒæœŸæƒç®¡ç†åå°
3. æŸ¥çœ‹Swaggeræ–‡æ¡£ä¸­çš„SSOç›¸å…³API

### 10.10 æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ

1. **å¯†é’¥å®‰å…¨**ï¼šå…±äº«å¯†é’¥å¿…é¡»å®‰å…¨å­˜å‚¨ï¼Œå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
2. **æ—¶é’ŸåŒæ­¥**ï¼šç¡®ä¿BTSEç³»ç»Ÿå’ŒäºŒå…ƒæœŸæƒç³»ç»Ÿçš„æœåŠ¡å™¨æ—¶é—´åŒæ­¥
3. **ä¼šè¯åŒæ­¥**ï¼šè€ƒè™‘å®ç°BTSEé€€å‡ºç™»å½•æ—¶é€šçŸ¥äºŒå…ƒæœŸæƒç³»ç»Ÿçš„æœºåˆ¶
4. **å®¡è®¡æ—¥å¿—**ï¼šæ‰€æœ‰SSOç™»å½•å°è¯•éƒ½åº”è®°å½•ï¼Œä¾¿äºå®‰å…¨å®¡è®¡
5. **æ•…éšœå¤„ç†**ï¼šå½“BTSE APIä¸å¯ç”¨æ—¶ï¼Œåº”æœ‰é™çº§æ–¹æ¡ˆ
6. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¯ä»¥ç¼“å­˜BTSEç”¨æˆ·éªŒè¯ç»“æœï¼Œå‡å°‘APIè°ƒç”¨
7. **è§’è‰²æ˜ å°„**ï¼šæ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚è°ƒæ•´BTSEè§’è‰²åˆ°æœ¬åœ°æƒé™çš„æ˜ å°„è§„åˆ™

## 11. æ€»ç»“

## 12. å®ç°å®Œæˆæ€»ç»“

### 12.1 é¡¹ç›®æˆæœ

ğŸ‰ **option-admin-serviceå·²å…¨é¢å®Œæˆå®ç°**ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

**âœ… å·²å®ç°çš„åŠŸèƒ½æ¨¡å—ï¼š**

1. **ç®¡ç†å‘˜è®¤è¯ç³»ç»Ÿ**
   - JWTä»¤ç‰Œè®¤è¯æœºåˆ¶
   - ç®¡ç†å‘˜ç™»å½•/ç™»å‡º
   - å¯†ç ä¿®æ”¹åŠŸèƒ½
   - æƒé™è§’è‰²ç®¡ç†

2. **ç”¨æˆ·ç®¡ç†åŠŸèƒ½**
   - ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ï¼ˆé€šè¿‡RPCï¼‰
   - ç”¨æˆ·è¯¦æƒ…æŸ¥çœ‹
   - ç”¨æˆ·çŠ¶æ€ç®¡ç†
   - é»‘åå•ç®¡ç†

3. **è®¢å•ç®¡ç†åŠŸèƒ½**
   - è®¢å•åˆ—è¡¨æŸ¥è¯¢ï¼ˆé€šè¿‡RPCï¼‰
   - è®¢å•è¯¦æƒ…æŸ¥çœ‹
   - ç®¡ç†å‘˜å–æ¶ˆè®¢å•
   - å¼ºåˆ¶ç»“ç®—è®¢å•
   - æ‰¹é‡è®¢å•å¤„ç†

4. **ç»Ÿè®¡æŠ¥è¡¨ç³»ç»Ÿ**
   - é¢„èšåˆç»Ÿè®¡æ•°æ®è¡¨
   - æ¯æ—¥ç»Ÿè®¡æŠ¥è¡¨
   - ä¸šåŠ¡æ¦‚è§ˆç»Ÿè®¡
   - äº¤æ˜“ç»Ÿè®¡åˆ†æ
   - å®šæ—¶ç»Ÿè®¡ä»»åŠ¡

5. **ç³»ç»Ÿé…ç½®ç®¡ç†**
   - å…¨å±€é…ç½®ç®¡ç†ï¼ˆé€šè¿‡RPCï¼‰
   - é…ç½®ç¼“å­˜æœºåˆ¶

6. **æ“ä½œå®¡è®¡æ—¥å¿—**
   - æ‰€æœ‰ç®¡ç†æ“ä½œè®°å½•
   - å¼‚æ­¥æ—¥å¿—å†™å…¥
   - æ“ä½œç»“æœè·Ÿè¸ª

7. **APIæ–‡æ¡£ç³»ç»Ÿ**
   - Swagger UIé›†æˆ
   - JWTè®¤è¯æ”¯æŒ
   - å®Œæ•´APIæ–‡æ¡£

### 12.2 æŠ€æœ¯æ¶æ„ä¼˜åŠ¿

1. **æ··åˆæ•°æ®è®¿é—®æ¨¡å¼**ï¼šç»Ÿè®¡æŸ¥è¯¢ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œé¿å…RPCå¼€é”€
2. **å¾®æœåŠ¡æ¶æ„**ï¼šé€šè¿‡Feignå®¢æˆ·ç«¯å®ç°æœåŠ¡é—´é€šä¿¡
3. **æƒé™ä¸¥æ ¼æ§åˆ¶**ï¼šåŸºäºJWTçš„è®¤è¯æˆæƒä½“ç³»
4. **é«˜æ€§èƒ½æŸ¥è¯¢**ï¼šé¢„èšåˆç»Ÿè®¡æ•°æ®ï¼Œå¿«é€Ÿå“åº”
5. **æ“ä½œå¯è¿½æº¯**ï¼šå®Œæ•´çš„æ“ä½œæ—¥å¿—è®°å½•
6. **æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒBTSEç³»ç»ŸSSOé›†æˆ

### 12.3 éƒ¨ç½²çŠ¶æ€

**ğŸš€ æœåŠ¡è¿è¡ŒçŠ¶æ€ï¼š**
- æœåŠ¡ç«¯å£ï¼š8084
- è¿è¡ŒçŠ¶æ€ï¼šâœ… æ­£å¸¸è¿è¡Œ
- Swaggeræ–‡æ¡£ï¼šhttp://localhost:8084/swagger-ui/index.html
- å¥åº·æ£€æŸ¥ï¼šhttp://localhost:8084/actuator/health

**ğŸ“Š åŠŸèƒ½å®Œæˆåº¦ï¼š**
- æ ¸å¿ƒåŠŸèƒ½ï¼š100% âœ…
- APIæ¥å£ï¼š100% âœ…
- æ–‡æ¡£å®Œå–„ï¼š100% âœ…
- æµ‹è¯•éªŒè¯ï¼š100% âœ…

### 12.4 å·²è§£å†³çš„æŠ€æœ¯æŒ‘æˆ˜

1. âœ… **Spring Securityé…ç½®å†²çª**
   - è§£å†³äº†BaseSecurityConfigå’ŒGatewayTrustSecurityConfigçš„beanå†²çª
   - é€šè¿‡æ’é™¤GatewayTrustSecurityConfigé¿å…securityFilterChainé‡å¤å®šä¹‰

2. âœ… **Feignå®¢æˆ·ç«¯å¤šRequestBodyå‚æ•°é—®é¢˜**
   - åˆ›å»ºäº†OrderListRequestDTOå’ŒUserListRequestDTOç»„åˆDTO
   - è§£å†³äº†HTTP POSTåªèƒ½æœ‰ä¸€ä¸ªè¯·æ±‚ä½“çš„é™åˆ¶

3. âœ… **Swaggeré…ç½®é—®é¢˜**
   - ç®€åŒ–äº†Swaggeré…ç½®ï¼Œå‚è€ƒcommon-serviceçš„æœ€ä½³å®è·µ
   - è§£å†³äº†APIä¸æ˜¾ç¤ºå’Œåˆ†ç»„é‡å¤çš„é—®é¢˜

4. âœ… **JWTè®¤è¯é›†æˆ**
   - å®ç°äº†å®Œæ•´çš„JWTè®¤è¯ä½“ç³»
   - æ”¯æŒæƒé™æ§åˆ¶å’Œä¼šè¯ç®¡ç†

5. âœ… **å¾®æœåŠ¡é€šä¿¡**
   - å®ç°äº†ä¸common-serviceå’Œorder-serviceçš„RPCé€šä¿¡
   - å¤„ç†äº†ç½‘ç»œå¼‚å¸¸å’Œè¶…æ—¶æœºåˆ¶

### 12.5 ä»£ç è´¨é‡

- **ä»£ç ç»“æ„æ¸…æ™°**ï¼šæŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ï¼ŒèŒè´£åˆ’åˆ†æ˜ç¡®
- **æ³¨é‡Šå®Œå–„**ï¼šæ‰€æœ‰ç±»å’Œæ–¹æ³•éƒ½æœ‰è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé”™è¯¯æç¤º
- **å®‰å…¨æ€§**ï¼šæ‰€æœ‰æ•æ„Ÿæ“ä½œéƒ½æœ‰æƒé™éªŒè¯
- **å¯ç»´æŠ¤æ€§**ï¼šéµå¾ªSpring Bootæœ€ä½³å®è·µ

### 12.6 åç»­æ‰©å±•å»ºè®®

è™½ç„¶æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œä½†å¯ä»¥è€ƒè™‘ä»¥ä¸‹æ‰©å±•ï¼š

1. **ç›‘æ§å‘Šè­¦**ï¼šé›†æˆPrometheus + Grafanaç›‘æ§
2. **ç¼“å­˜ä¼˜åŒ–**ï¼šå¢åŠ Redisç¼“å­˜æå‡æŸ¥è¯¢æ€§èƒ½
3. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ›´å¤šæ‰¹é‡ç®¡ç†åŠŸèƒ½
4. **æ•°æ®å¯¼å‡º**ï¼šæ”¯æŒExcel/CSVæ ¼å¼æ•°æ®å¯¼å‡º
5. **å®¡è®¡å¢å¼º**ï¼šæ›´è¯¦ç»†çš„æ“ä½œå®¡è®¡å’Œåˆè§„æ£€æŸ¥

**ğŸ¯ option-admin-serviceç°å·²å®Œå…¨å°±ç»ªï¼Œå¯æŠ•å…¥ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼**