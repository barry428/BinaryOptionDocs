# 应用程序日志内部标准规范

## 文档信息
- **版本**: 0.3
- **日期**: 2025年6月25日
- **作者**: Jimmy.lin

## 目的
本文档旨在为组织内所有应用程序建立标准化的日志记录方法。该标准旨在确保一致性，提高日志可读性，并便于跨不同应用程序进行调试和监控。

## 范围
本标准适用于BTSE开发、部署或维护的所有软件应用程序，无论使用何种编程语言或平台。

---

## 1. 日志文件位置和命名规范

目前，不同服务和应用程序的日志文件位置和命名规范各不相同。但是，维护了标准的命名规范以确保识别和管理日志文件的一致性。

### 关于未来统一日志路径的说明
**目标更新**: 未来，所有应用程序和服务将把日志文件路径标准化为 `/var/log/app_logs/`，以整合日志管理并便于访问和监控。具体的过渡时间表和详细信息将适时通知。

### 通用服务 (Tomcat)
- **服务**: spot, futures, admin
- **日志路径**: `/usr/local/tomcat/logs/`
- **命名规范**:
  - 应用程序类型: `{service_name}-{type}.log`
  - GC类型: `gc.log`
- **特定要求**: 对于基于Tomcat的应用程序，必须配置日志记录以支持创建不同用途的日志（例如：访问日志、错误日志、应用程序特定日志），以确保全面的监控和故障排除能力。

### 微服务
微服务将遵循更特定于服务的日志路径，反映其运营领域，并确保日志在各自的服务目录中易于定位。

- **服务**: walletservice, tradeview, payment, oauth, fix-server, scheduler-service, 3rd-party-login, sumup, message, ipservice, user-report, upload-service, aquanow-liquidity, vendor-service
- **日志路径**: 因服务而异，没有特定日志目录的服务通常遵循 `/usr/local/btse/logs`
- **命名规范**:
  - 应用程序类型: `{service_name}-{type}.log`
  - GC类型: `gc.log`

对于具有唯一日志路径的服务（例如：3rd-party-login），必须使用提供的特定路径。

### Node.js 服务
Node.js服务将遵循各自的目录，并使用统一的日志文件命名规范。

- **示例服务**: node-universe, position_taking, trading-competition
- **日志路径**: 因服务而异，例如：`/usr/local/{service}/logs/`
- **命名规范**:
  - 应用程序类型: `{service_name}-{type}.log`
  - GC类型: `gc.log`

### 定价服务 (Pricer)
定价服务专注于特定的金融和定价功能，将遵循专用的日志路径规范。

- **示例服务**: funding-rate-monitor, fiat-exchange-rate
- **日志路径**: 通常遵循 `/usr/local/{service}/logs/`
- **命名规范**:
  - 应用程序类型: `{service_name}-{type}.log`
  - GC类型: `gc.log`

---

## 2. 日志级别标准（建议）

### 日志级别定义
- **ERROR**: 错误事件，但应用程序可能继续运行
- **WARN**: 潜在的有害情况
- **INFO**: 信息性消息，突出应用程序的运行进度
- **DEBUG**: 调试级别的信息性事件
- **TRACE**: 更细粒度的信息性事件

### 使用建议
- **生产环境**: 默认使用 INFO 级别
- **测试环境**: 可使用 DEBUG 级别
- **开发环境**: 根据需要使用 DEBUG 或 TRACE 级别

---

## 3. 日志格式建议

### 基本格式
```
[时间戳] [日志级别] [线程名/ID] [类名/模块名] - 日志消息
```

### 示例
```
[2025-06-25 10:30:45.123] [INFO] [main] [com.btse.OrderService] - 订单创建成功，订单ID: 12345
[2025-06-25 10:30:45.456] [ERROR] [worker-1] [com.btse.PaymentService] - 支付处理失败，错误代码: PAY_001
```

---

## 4. 日志轮转策略

### 建议配置
- **按大小轮转**: 单个日志文件达到100MB时进行轮转
- **按时间轮转**: 每日进行日志轮转
- **保留策略**: 
  - 生产环境保留30天
  - 测试环境保留7天
- **压缩**: 旧日志文件应进行gzip压缩

---

## 5. 最佳实践

1. **避免记录敏感信息**
   - 不记录密码、密钥、令牌等敏感信息
   - 对个人身份信息（PII）进行脱敏处理

2. **使用结构化日志**
   - 考虑使用JSON格式的结构化日志，便于日志分析工具处理

3. **包含上下文信息**
   - 在日志中包含请求ID、用户ID、会话ID等上下文信息
   - 便于跟踪和关联相关日志

4. **性能考虑**
   - 避免在高频执行的代码路径中记录过多日志
   - 使用异步日志记录以减少性能影响

5. **错误日志规范**
   - 记录完整的异常堆栈信息
   - 包含错误发生时的相关参数和状态

---

## 6. 监控和告警

### 关键指标监控
- ERROR级别日志的频率和数量
- 特定错误模式的出现
- 日志文件大小和增长速度

### 告警配置建议
- ERROR级别日志超过阈值时触发告警
- 关键业务流程失败时立即告警
- 日志服务异常时告警

---

## 7. 合规性和审计

### 审计日志要求
- 记录所有安全相关事件
- 记录用户登录、登出、权限变更等操作
- 确保审计日志的完整性和不可篡改性

### 保留期限
- 审计日志根据合规要求保留（通常为1-7年）
- 定期备份关键日志到长期存储

---

## 附录

### A. 日志类型定义
- **application**: 应用程序业务日志
- **access**: 访问日志
- **error**: 错误日志
- **audit**: 审计日志
- **performance**: 性能日志
- **gc**: 垃圾回收日志

### B. 环境变量配置
- `LOG_LEVEL`: 设置日志级别
- `LOG_PATH`: 覆盖默认日志路径
- `LOG_FORMAT`: 设置日志格式（text/json）

### C. 常见问题排查
1. **日志文件未生成**
   - 检查文件系统权限
   - 验证日志路径配置
   - 确认日志框架已正确初始化

2. **日志文件过大**
   - 检查日志轮转配置
   - 审查日志级别设置
   - 识别并优化过度日志记录的代码

3. **日志丢失**
   - 验证日志缓冲区设置
   - 检查异步日志队列大小
   - 确认日志写入权限

---

## 版本历史
- **0.3** (2025-06-25): 初始版本，建立基本日志标准
- 待更新: 统一日志路径到 `/var/log/app_logs/`

---

*注：本文档将根据实际需求和最佳实践持续更新*