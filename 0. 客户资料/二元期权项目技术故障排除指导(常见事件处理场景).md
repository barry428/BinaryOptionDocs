# 二元期权项目技术故障排除指导（常见业务问题处理）

## 📋 文档信息
- **更新日期**: 2024-10-20
- **版本**: v2.0
- **维护团队**: 技术支持团队

---

## 🎯 概述

本文档针对二元期权平台日常运营中的常见业务问题，提供快速诊断步骤和解决方案。适用于客服、技术支持和运维团队使用。

---

## 🚨 常见业务问题处理

### 1. 下单失败问题

#### 1.1 用户反馈无法下单

**常见症状**：
- 点击下单按钮无反应
- 提示"下单失败，请稍后重试"
- 下单后订单未生成

**初步检查步骤**：

1. **确认用户基本信息**
```
用户ID: ___________
账户类型: DEMO/REAL
下单金额: ___________
交易对: ___________
时间戳: ___________
```

2. **前端检查**
- [ ] 确认用户已登录
- [ ] 检查账户余额是否足够
- [ ] 验证下单金额是否在允许范围内
- [ ] 确认交易对是否有效且已开启

3. **后端服务检查**
```bash
# 检查order-service服务状态
curl -X GET "http://localhost:8082/actuator/health"

# 查看下单相关日志
tail -f logs/option-order-service.log | grep "createOrder"

# 检查用户账户状态
curl -X GET "http://localhost:8081/rpc/borc/account/user/{userId}/balance/{accountType}"
```

**常见原因及解决方案**：

| 错误码/现象 | 原因 | 解决方案 |
|-------------|------|----------|
| 余额不足 | 账户余额小于下单金额 | 指导用户充值或降低下单金额 |
| 下单金额超限 | 超过单笔最大限额 | 告知用户当前限额，建议调整金额 |
| 交易对已关闭 | 该交易对暂停交易 | 等待交易对重新开启或选择其他交易对 |
| 服务异常 | order-service不可用 | 重启服务，联系技术团队 |
| **Fixture价格获取失败** | **期权定价服务无法获取当前价格** | **检查BTSE API连接，重启market-service，必要时启用Mock模式** |
| **BTSE转账失败** | **REAL账户资金划转到BTSE失败** | **检查BTSE服务状态，查看transfer日志，执行转账补偿脚本** |
| **风控检查未通过** | **用户触发风控规则限制** | **检查用户风控状态，确认是否需要解除限制或调整风控参数** |

#### 1.2 下单失败技术诊断

**Fixture价格获取失败**：
```bash
# 检查期权定价服务
curl -X GET "http://localhost:8083/actuator/health"

# 检查BTSE API连接
curl -X GET "https://api.btse.co/optionpricing/api/fixtures"

# 查看定价相关日志
tail -f logs/option-market-service.log | grep -E "fixture|pricing"

# 临时启用Mock模式
export BTSE_MARKET_MOCK_ENABLED=true
./rebuild-restart.sh option-market-service staging
```

**BTSE转账失败诊断**：
```bash
# 检查转账日志
tail -f logs/option-common-service.log | grep -E "transfer|btse"

# 查看转账记录
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT * FROM bo_btse_transfer_log WHERE status = 'FAILED' ORDER BY create_time DESC LIMIT 10"

# 执行转账补偿
curl -X POST "http://localhost:8081/rpc/borc/transfer/compensate-transfer-in"
curl -X POST "http://localhost:8081/rpc/borc/transfer/compensate-transfer-out"
```

**风控检查失败诊断**：
```bash
# 检查用户风控状态
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT * FROM bo_user_risk_stats WHERE user_id = {userId}"

# 查看风控日志
tail -f logs/option-order-service.log | grep -E "risk|blacklist"

# 检查黑名单状态
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT * FROM bo_blacklist WHERE user_id = {userId} AND is_active = true"
```

**升级标准**：
- 5分钟内无法解决 → L2技术支持
- 影响多个用户 → 立即升级L3

---

### 2. 行情无法展示

#### 2.1 K线图不显示或数据异常

**常见症状**：
- K线图空白或加载失败
- 价格数据不更新
- WebSocket连接失败

**初步检查步骤**：

1. **前端检查**
- [ ] 刷新页面是否恢复
- [ ] 检查浏览器控制台错误
- [ ] 测试其他交易对是否正常

2. **服务状态检查**
```bash
# 检查market-service状态
curl -X GET "http://localhost:8083/actuator/health"

# 检查WebSocket连接
curl -X GET "http://localhost:8083/ws/market"

# 查看行情服务日志
tail -f logs/option-market-service.log | grep -E "WebSocket|market"
```

3. **数据源检查**
```bash
# 检查BTSE期权定价API
curl -X GET "https://api.btse.co/optionpricing/api/fixtures"

# 检查BTSE历史数据API
curl -X GET "https://api.btse.co/optionpricing/api/history?symbol=BTC-USDT&interval=1m&limit=100"

# 测试BTSE WebSocket连接
wscat -c "wss://ws.btse.co/ws/oe"

# 检查本地WebSocket服务
wscat -c "ws://localhost:8083/ws/market"

# 查看Mock模式状态
grep "BTSE_MARKET_MOCK_ENABLED" .env
```

**常见原因及解决方案**：

| 症状 | 可能原因 | 解决方案 |
|------|----------|----------|
| K线图空白 | market-service异常 | 重启market-service |
| 价格不更新 | WebSocket连接断开 | 检查BTSE WebSocket (wss://ws.btse.co)，重启WebSocket服务 |
| **历史数据缺失** | **BTSE历史API无响应** | **检查history API，清理缓存，切换Mock模式** |
| **实时行情断开** | **BTSE WebSocket连接失败** | **检查wss://ws.btse.co连接，重启market-service** |
| 数据延迟严重 | BTSE API响应慢 | 检查BTSE服务状态，考虑切换Mock模式 |
| 特定交易对无数据 | 交易对配置错误 | 检查symbol_config表配置 |
| **Fixture数据异常** | **期权定价API错误** | **检查fixtures API响应，验证定价数据格式** |

**临时应急方案**：
```bash
# 启用Mock模式提供模拟数据
export BTSE_MARKET_MOCK_ENABLED=true
./rebuild-restart.sh option-market-service staging
```

#### 2.2 行情数据详细诊断

**BTSE API连接诊断**：
```bash
# 测试所有BTSE API端点
curl -v -X GET "https://api.btse.co/optionpricing/api/fixtures" | jq
curl -v -X GET "https://api.btse.co/optionpricing/api/history?symbol=BTC-USDT&interval=1m&limit=10" | jq

# 检查API响应时间
time curl -X GET "https://api.btse.co/optionpricing/api/fixtures"

# 验证特定交易对数据
curl -X GET "https://api.btse.co/optionpricing/api/history?symbol={symbol}&interval=1m&limit=1" | jq '.[] | {symbol, price, timestamp}'
```

**WebSocket连接诊断**：
```bash
# 安装wscat（如果未安装）
npm install -g wscat

# 测试BTSE WebSocket
wscat -c "wss://ws.btse.co/ws/oe" -x '{"op":"subscribe","args":["update:BTCPFC"]}'

# 测试本地WebSocket
wscat -c "ws://localhost:8083/ws/market" -x '{"action":"subscribe","symbol":"BTC-USDT"}'

# 检查WebSocket连接数
ss -tuln | grep :8083
```

**市场数据缓存检查**：
```bash
# 检查Redis中的市场数据
redis-cli -c -p 7001 keys "bo:market:*"
redis-cli -c -p 7001 get "bo:market:BTC-USDT"

# 清理市场数据缓存
redis-cli -c -p 7001 del "bo:market:*"

# 检查数据库中的K线数据
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT symbol, COUNT(*) FROM kline_data WHERE create_time > NOW() - INTERVAL '1 hour' GROUP BY symbol"
```

---

### 3. 订单查询问题

#### 3.1 当前订单无法显示

**常见症状**：
- 订单列表为空
- 订单状态不更新
- 订单详情查询失败

**检查步骤**：

1. **确认查询条件**
```
用户ID: ___________
账户类型: DEMO/REAL
查询时间范围: ___________
订单状态: ___________
```

2. **数据库检查**
```sql
-- 检查用户是否有订单
SELECT COUNT(*) FROM bo_option_order 
WHERE user_id = {userId} AND account_type = '{accountType}';

-- 检查订单状态分布
SELECT status, COUNT(*) FROM bo_option_order 
WHERE user_id = {userId} 
GROUP BY status;

-- 检查最近订单
SELECT id, symbol, amount, status, create_time 
FROM bo_option_order 
WHERE user_id = {userId} 
ORDER BY create_time DESC LIMIT 10;
```

3. **API测试**
```bash
# 测试订单查询API
curl -X GET "http://localhost:8082/api/borc/order/list?accountType=DEMO&page=1&size=10" \
  -H "Authorization: Bearer {token}"

# 测试订单详情API
curl -X GET "http://localhost:8082/api/borc/order/{orderId}" \
  -H "Authorization: Bearer {token}"
```

#### 3.2 历史订单查询缓慢

**常见原因**：
- 数据量过大，查询超时
- 数据库索引缺失
- 分页参数不合理

**优化方案**：
```sql
-- 检查索引是否存在
EXPLAIN ANALYZE SELECT * FROM bo_option_order 
WHERE user_id = {userId} AND account_type = '{accountType}' 
ORDER BY create_time DESC LIMIT 20;

-- 如需要，创建复合索引
CREATE INDEX CONCURRENTLY idx_option_order_user_account_time 
ON bo_option_order(user_id, account_type, create_time DESC);
```

---

### 4. 订单结算失败问题

#### 4.1 订单无法结算

**常见症状**：
- 交易轮次结束后订单状态未更新
- 订单一直显示为ACTIVE状态
- 用户反馈盈利订单未到账
- 结算日志出现错误

**初步检查步骤**：

1. **确认订单基本信息**
```
订单ID: ___________
用户ID: ___________
交易对: ___________
轮次ID: ___________
订单状态: ___________
创建时间: ___________
```

2. **检查轮次状态**
```sql
-- 查看交易轮次状态
SELECT id, symbol, status, start_time, end_time, open_price, close_price 
FROM bo_trading_round 
WHERE id = {roundId};

-- 检查是否有未结算的轮次
SELECT COUNT(*) FROM bo_trading_round 
WHERE status = 'LOCKED' AND end_time < NOW() - INTERVAL '5 minutes';
```

3. **检查结算服务状态**
```bash
# 检查order-service定时任务
tail -f logs/option-order-service.log | grep -E "settlement|结算"

# 手动触发结算
curl -X POST "http://localhost:8082/rpc/borc/order/settle-by-round/{roundId}"
```

**常见原因及解决方案**：

| 错误现象 | 原因 | 解决方案 |
|----------|------|----------|
| **Fixture获取close价格失败** | **期权定价服务无法获取结算价格** | **检查BTSE API连接，重启market-service，手动设置轮次close_price** |
| **Transfer失败** | **REAL账户盈利资金转出到BTSE失败** | **检查BTSE服务状态，执行转账补偿，手动处理转账** |
| 订单状态未更新 | 结算定时任务异常 | 重启order-service，手动执行结算脚本 |
| 分布式锁超时 | 多实例结算冲突 | 清理Redis分布式锁，重启服务 |
| 数据库事务失败 | 数据库连接异常或死锁 | 检查数据库状态，重试结算操作 |

#### 4.2 结算失败技术诊断

**Fixture close价格获取失败**：
```bash
# 检查轮次close_price是否为空
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT id, symbol, close_price, end_time FROM bo_trading_round WHERE close_price IS NULL AND status = 'LOCKED'"

# 检查期权定价API
curl -X GET "https://api.btse.co/optionpricing/api/fixtures"

# 手动设置close_price（紧急情况）
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "UPDATE bo_trading_round SET close_price = {price} WHERE id = {roundId}"

# 重新触发结算
curl -X POST "http://localhost:8082/rpc/borc/order/settle-by-round/{roundId}"
```

**Transfer失败诊断**：
```bash
# 检查盈利转账失败记录
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT * FROM bo_btse_transfer_log WHERE status = 'FAILED' AND transfer_type = 'WITHDRAW' ORDER BY create_time DESC LIMIT 10"

# 查看transfer相关日志
tail -f logs/option-common-service.log | grep -E "transferToBtseForSettlement|settlement"

# 执行转账补偿
curl -X POST "http://localhost:8081/rpc/borc/transfer/compensate-transfer-out"

# 手动处理转账（极端情况）
curl -X POST "http://localhost:8081/rpc/borc/transfer/manual-transfer" \
  -H "Content-Type: application/json" \
  -d '{"userId": {userId}, "amount": {amount}, "type": "WITHDRAW", "reason": "settlement_compensation"}'
```

**分布式锁问题诊断**：
```bash
# 检查Redis分布式锁
redis-cli -c -p 7001 keys "bo:lock:*"

# 清理过期锁（谨慎操作）
redis-cli -c -p 7001 del "bo:lock:settlement:{roundId}"

# 检查定时任务运行状态
curl -X GET "http://localhost:8082/actuator/scheduledtasks"
```

**批量结算修复**：
```bash
# 批量结算未完成的轮次
./test-scripts/settle-by-round.sh $(PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option -t -c "SELECT id FROM bo_trading_round WHERE status = 'LOCKED' AND end_time < NOW() - INTERVAL '5 minutes'" | tr '\n' ' ')

# 检查结算结果
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT status, COUNT(*) FROM bo_trading_round GROUP BY status"
```

---

### 5. 常见异常报错处理

#### 5.1 Token相关错误

**错误信息**：
```
"Authentication failed"
"Token expired"
"Invalid token"
"Unauthorized access"
```

**处理步骤**：
1. **确认Token状态**
```bash
# 检查Redis中的token
redis-cli -c -p 7001 get "oauth_token:{tokenValue}"

# 检查token过期时间
redis-cli -c -p 7001 ttl "oauth_token:{tokenValue}"
```

2. **重新获取Token**
```bash
# 测试OAuth流程
./test-scripts/simple-flow-test-oauth.sh
```

#### 5.2 数据库连接错误

**错误信息**：
```
"Connection timeout"
"Database connection failed"
"Too many connections"
```

**处理步骤**：
```bash
# 检查数据库连接
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option -c "SELECT 1"

# 检查连接数
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT count(*) FROM pg_stat_activity WHERE datname='binary_option'"

# 检查慢查询
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT query, state, query_start FROM pg_stat_activity WHERE state != 'idle'"
```

#### 5.3 BTSE API调用失败

**错误信息**：
```
"BTSE API timeout"
"BTSE service unavailable"
"Invalid BTSE response"
```

**处理步骤**：
1. **检查BTSE服务状态**
```bash
# 测试BTSE API连通性
curl -X GET "https://api.btse.co/optionpricing/api/health" -w "%{http_code}"

# 检查OAuth认证
curl -X POST "https://api.btse.co/oauth/token" \
  -H "Content-Type: application/json" \
  -d '{"client_id":"binary_option","client_secret":"..."}'
```

2. **启用Mock模式**
```bash
# 临时启用Mock模式
export BTSE_MOCK_ENABLED=true
./rebuild-restart.sh all staging
```

---

### 6. 登录状态和资产信息问题

#### 6.1 无法获取登录状态

**常见症状**：
- 用户显示未登录状态
- 登录后页面未刷新
- 登录状态不持久

**检查步骤**：

1. **前端状态检查**
```javascript
// 在浏览器控制台检查
console.log('Auth Store:', window.$nuxt.$store.state.auth)
console.log('User Store:', window.$nuxt.$store.state.user)
```

2. **OAuth Token检查**
```bash
# 检查用户的OAuth token
redis-cli -c -p 7001 get "oauth_token:{userId}"

# 检查token对应的用户信息
./test-scripts/utils/debug-oauth-flow.sh {userId}
```

3. **Gateway路由检查**
```bash
# 测试认证接口
curl -X GET "http://localhost:8080/api/borc/auth/status" \
  -H "Authorization: Bearer {token}"
```

#### 6.2 资产信息无法加载

**常见症状**：
- 账户余额显示为0或加载失败
- 账户类型切换异常
- 资产统计数据错误

**检查步骤**：

1. **账户数据检查**
```sql
-- 检查用户账户信息
SELECT * FROM bo_account 
WHERE user_id = {userId};

-- 检查资产统计
SELECT account_type, balance, frozen_amount, 
       total_profit, total_loss, total_deposit, total_withdraw
FROM bo_account 
WHERE user_id = {userId};
```

2. **API接口测试**
```bash
# 测试账户余额API
curl -X GET "http://localhost:8081/rpc/borc/account/user/{userId}/balance/DEMO"

# 测试账户切换
curl -X POST "http://localhost:8081/api/borc/account/switch" \
  -H "Content-Type: application/json" \
  -d '{"accountType":"REAL"}'
```

**常见解决方案**：

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 余额显示异常 | 缓存数据过期 | 清理Redis缓存，重新加载 |
| 切换账户失败 | 权限验证失败 | 检查用户状态和权限配置 |
| 统计数据错误 | 数据计算异常 | 重新计算用户统计数据 |
| REAL账户无法使用 | BTSE账户异常 | 检查BTSE账户状态和余额 |

---

## 🔧 快速诊断工具

### 用户状态一键检查脚本
```bash
#!/bin/bash
# 使用方法: ./user-diagnosis.sh {userId}
USER_ID=$1

echo "=== 用户诊断报告 ==="
echo "用户ID: $USER_ID"
echo "检查时间: $(date)"
echo

# 检查用户基本信息
echo "1. 用户基本信息"
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT id, external_id, username, create_time FROM bo_user WHERE id = $USER_ID"

# 检查账户信息
echo "2. 账户信息"
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT account_type, balance, frozen_amount FROM bo_account WHERE user_id = $USER_ID"

# 检查OAuth状态
echo "3. OAuth状态"
redis-cli -c -p 7001 get "oauth_token:user_$USER_ID" | head -c 50

# 检查最近订单
echo "4. 最近订单(最近5条)"
PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option \
  -c "SELECT id, symbol, amount, status, create_time FROM bo_option_order WHERE user_id = $USER_ID ORDER BY create_time DESC LIMIT 5"

echo "=== 诊断完成 ==="
```

### 服务健康检查脚本
```bash
#!/bin/bash
echo "=== 服务健康检查 ==="

services=("common-service:8081" "order-service:8082" "market-service:8083" "gateway:8080")

for service in "${services[@]}"; do
    name=$(echo $service | cut -d: -f1)
    port=$(echo $service | cut -d: -f2)
    
    echo -n "$name: "
    if curl -s "http://localhost:$port/actuator/health" > /dev/null; then
        echo "✅ 正常"
    else
        echo "❌ 异常"
    fi
done

echo
echo "数据库连接: "
if PGPASSWORD=root psql -U postgres -h localhost -p 5432 -d binary_option -c "SELECT 1" > /dev/null 2>&1; then
    echo "✅ 正常"
else
    echo "❌ 异常"
fi

echo
echo "Redis集群: "
if redis-cli -c -p 7001 ping > /dev/null 2>&1; then
    echo "✅ 正常"
else
    echo "❌ 异常"
fi
```

---

## 📞 问题升级流程

### L1 客服处理（5分钟）
- [ ] 收集用户基本信息
- [ ] 确认问题现象
- [ ] 尝试简单解决方案（刷新、重新登录等）
- [ ] 无法解决 → 升级L2

### L2 技术支持（30分钟）
- [ ] 使用诊断脚本检查
- [ ] 查看相关日志
- [ ] 尝试技术解决方案
- [ ] 复杂问题 → 升级L3

### L3 开发团队
- [ ] 代码级别调试
- [ ] 数据修复
- [ ] 系统优化

---

## 📝 问题记录模板

```
【问题单号】: BO-2024102001
【用户ID】: 123456
【问题类型】: 下单失败/行情异常/订单查询/登录问题/其他
【问题描述】: 
【重现步骤】: 
【用户环境】: PC/H5, Chrome/Safari/其他
【处理人】: 
【处理时间】: 
【解决方案】: 
【问题状态】: 已解决/转L2/转L3/待用户确认
```

---

## 🔄 常用恢复命令

```bash
# 重启所有服务
./rebuild-restart.sh all staging

# 清理Redis缓存
redis-cli -c -p 7001 flushdb

# 重新计算用户统计
curl -X POST "http://localhost:8081/rpc/borc/account/recalculate/{userId}"

# 检查订单补偿
./test-scripts/modules/rpc/order/compensate-pending.sh

# 重新加载交易对配置
curl -X POST "http://localhost:8083/admin/symbol/reload"
```

---

**联系方式**：
- **技术支持**: tech-support@company.com
- **紧急联系**: +86-400-xxx-xxxx
- **内部群组**: 技术支持群