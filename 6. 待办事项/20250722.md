# Binary Option 项目优化计划
**日期**: 2025-07-22  
**状态**: 待执行  

## 项目架构现状分析

### 当前模块架构
1. **option-parent** - Maven父项目，统一管理依赖版本
2. **option-common-dto** - 公共DTO定义 ✅ (新增)
3. **option-common-utils** - 公共工具类(JWT, Redis, RocketMQ)
4. **option-security-base** - 安全基础组件
5. **option-common-service** - 用户服务(使用JPA)
6. **option-order-service** - 订单服务(使用JPA)
7. **option-market-service** - 市场数据服务(WebSocket)
8. **option-admin-service** - 后台管理服务 ✅ (新增)
9. **option-gateway** - Spring Cloud Gateway网关
10. **option-xxl-job** - 定时任务调度服务(已使用MyBatis)

### 技术栈
- **框架**: Spring Boot 2.7.18 + Spring Cloud Alibaba
- **服务发现**: Nacos
- **数据库**: MySQL + JPA(业务服务) + MyBatis(XXL-Job)
- **网关**: Spring Cloud Gateway
- **安全**: Spring Security + JWT
- **消息队列**: RocketMQ
- **缓存**: Redis
- **任务调度**: XXL-Job
- **Java版本**: 17

## 优化方案

### 🎯 优化目标
1. 技术栈统一，提升项目一致性
2. 提升数据访问层性能
3. 优化缓存策略
4. 统一安全配置
5. 改善代码可维护性

### 📋 优化计划

#### 第一阶段：数据访问层统一 (JPA → MyBatis) 
**优先级**: 🔥 高
**预计耗时**: 2-3天

**背景**: 
- 当前JPA和MyBatis混用，技术栈不统一
- MyBatis更适合复杂业务查询和性能优化
- XXL-Job已使用MyBatis，保持一致性

**执行步骤**:
1. **option-common-service** JPA → MyBatis迁移
   - [x] 添加MyBatis依赖
   - [x] 创建User相关Mapper接口和XML
   - [x] 重写UserService业务逻辑
   - [x] 测试验证功能完整性
   
2. **option-order-service** JPA → MyBatis迁移
   - [x] 添加MyBatis依赖
   - [x] 创建Order相关Mapper接口和XML
   - [x] 重写OrderService业务逻辑
   - [x] 测试验证功能完整性

3. **移除JPA依赖**
   - [x] 清理spring-boot-starter-data-jpa依赖
   - [x] 删除@Entity注解和JPA相关代码
   - [x] 更新配置文件

**迁移收益**:
- ✅ 技术栈统一
- ✅ 复杂查询性能提升
- ✅ SQL可控性增强
- ✅ 与XXL-Job技术栈保持一致

#### 第二阶段：缓存策略优化
**优先级**: 🔥 高
**预计耗时**: 1-2天

**实施内容**:
1. **用户信息缓存**
   - [ ] 用户基础信息Redis缓存
   - [ ] 用户权限信息缓存
   - [ ] 缓存失效策略

2. **订单数据缓存**
   - [ ] 热点订单数据缓存
   - [ ] 订单状态变更缓存同步
   - [ ] 分页查询结果缓存

3. **市场数据缓存**
   - [ ] 实时价格数据缓存
   - [ ] K线数据缓存策略
   - [ ] WebSocket推送优化

#### 第三阶段：安全配置统一
**优先级**: 🟡 中
**预计耗时**: 1天

**实施内容**:
1. **抽取公共安全配置**
   - [x] ✅ 将重复的SecurityConfig抽取到option-security-base
   - [x] ✅ 创建通用的JWT过滤器配置
   - [x] ✅ 统一异常处理

2. **权限控制优化**
   - [x] ✅ 基于角色的权限控制
   - [x] ✅ API接口权限注解
   - [x] ✅ 权限缓存策略

#### 第四阶段：性能优化
**优先级**: 🟡 中  
**预计耗时**: 2-3天

**实施内容**:
1. **数据库优化**
   - [ ] 分析慢查询日志
   - [ ] 添加必要索引
   - [ ] 查询语句优化

2. **连接池优化**
   - [ ] HikariCP连接池调优
   - [ ] Redis连接池配置
   - [ ] 监控指标添加

3. **JVM参数调优**
   - [ ] GC策略选择
   - [ ] 内存分配优化
   - [ ] 启动脚本优化

### 📊 执行检查点

#### 完成标准
- [ ] 所有模块编译通过
- [ ] 单元测试覆盖率 > 80%
- [ ] 接口功能测试通过
- [ ] 性能测试指标达标
- [ ] 代码Review通过

#### 回滚方案
- 保留当前JPA版本的Git分支
- 数据库备份策略
- 配置文件版本控制

### 🔍 风险评估

**高风险点**:
1. **JPA → MyBatis迁移**可能引入业务逻辑错误
2. **缓存策略**可能导致数据一致性问题
3. **配置变更**可能影响现有功能

**风险控制**:
- 分模块渐进式迁移
- 充分的测试覆盖
- 监控和告警机制
- 快速回滚方案

### 📅 时间规划

```
Week 1: JPA → MyBatis 迁移
├── Day 1-2: option-common-service 迁移
├── Day 3-4: option-order-service 迁移  
└── Day 5: 测试验证和问题修复

Week 2: 缓存策略 + 安全配置优化
├── Day 1-3: 缓存策略实施
├── Day 4: 安全配置统一
└── Day 5: 测试验证

Week 3: 性能优化 + 文档完善
├── Day 1-3: 性能调优
├── Day 4: 监控和告警
└── Day 5: 文档更新和知识转移
```

---

## 执行日志

### 2025-07-22
- [x] ✅ 项目结构分析完成
- [x] ✅ 编译错误修复(DTO导入、Spring Security兼容性)
- [x] ✅ 优化方案制定完成
- [x] ✅ option-common-service JPA → MyBatis迁移完成
  - [x] 添加MyBatis依赖
  - [x] 创建UserMapper接口和XML文件
  - [x] 重写UserService使用MyBatis
  - [x] 移除JPA相关配置和注解
  - [x] 编译测试通过
- [x] ✅ option-order-service JPA → MyBatis迁移完成
  - [x] 添加MyBatis依赖
  - [x] 创建OrderMapper接口和XML文件  
  - [x] 重写OrderService使用MyBatis
  - [x] 移除JPA相关配置和注解
  - [x] 编译测试通过

### 2025-07-23
- [x] ✅ 安全配置统一完成
  - [x] 创建BaseSecurityConfig统一安全配置基类
  - [x] 实现JwtAuthenticationFilterImpl通用JWT过滤器
  - [x] 创建SecurityExceptionHandler统一异常处理(支持国际化)
  - [x] 实现SecurityAspect AOP权限验证切面
  - [x] 创建@RequirePermission、@RequireRole、@AllowAnonymous权限注解
  - [x] 实现PermissionCacheService Redis权限缓存
  - [x] 更新各服务SecurityConfig继承BaseSecurityConfig
  - [x] 在admin-service添加@RequireRole("admin")角色控制
  - [x] 添加安全相关国际化消息(中英文)
  - [x] 修复所有编译错误，确保项目编译通过

## 🎉 第一、三阶段完成总结

### ✅ **第一阶段 - 数据访问层统一 (已完成)**：
1. **option-common-service** - 完全从JPA迁移到MyBatis
2. **option-order-service** - 完全从JPA迁移到MyBatis
3. **技术栈统一** - 所有业务服务现在都使用MyBatis
4. **编译验证** - 所有模块编译通过

### ✅ **第三阶段 - 安全配置统一 (已完成)**：
1. **option-security-base** - 统一安全配置基础包
2. **BaseSecurityConfig** - 提供统一的安全配置基类
3. **权限注解体系** - @RequirePermission、@RequireRole、@AllowAnonymous
4. **Redis权限缓存** - 提升权限验证性能
5. **国际化支持** - 安全异常消息支持多语言
6. **合理的权限策略** - admin-service使用角色控制，其他服务保持简单认证

### 📊 **总体成果**：
- ✅ 数据访问技术统一 (MyBatis)
- ✅ 与XXL-Job技术栈保持一致
- ✅ 为复杂查询优化奠定基础
- ✅ 提升SQL可控性
- ✅ 安全配置架构统一
- ✅ 权限控制灵活且高性能
- ✅ 支持多语言国际化
- ✅ admin管理功能权限保护

## 📋 **计划调整** (2025-07-22 晚)
**用户需求变更**：优先完成数据表设计和实现，确保可以调试

### 🎯 **新的优先任务**：
根据 `docs/2. 设计类/207_详细设计文档.md` 中的数据表设计，创建完整的数据库结构和对应的代码实现。

### 📊 **需要创建的数据表**：

#### option-common-service (4张表)
- [x] `user` - 用户表 (已存在，需完善)
- [ ] `account` - 账户表
- [ ] `account_transaction` - 资金流水表  
- [ ] `symbol_config` - 币种配置表

#### option-order-service (5张表)
- [x] `option_order` - 订单表 (已存在)
- [ ] `duration_config` - 周期配置表
- [ ] `trading_round` - 交易回合表
- [ ] `risk_config` - 风控配置表
- [ ] `risk_log` - 风控日志表

#### option-admin-service (5张表)
- [ ] `blacklist` - 黑名单表
- [ ] `admin_operation_log` - 管理员操作日志表
- [ ] `global_config` - 全局配置表
- [ ] `daily_stats` - 每日统计表
- [ ] `hourly_stats` - 每小时统计表

### 🚀 **执行计划**：
1. **创建数据库表结构** - 使用文档中的SQL语句
2. **实体类和Mapper** - 为每张表创建对应的Java类和MyBatis映射
3. **基础Service** - 实现基本的CRUD操作
4. **调试验证** - 编译测试，确保功能正常

### 🔄 **原计划暂停**：
- 第二阶段缓存策略优化暂停
- 专注于数据库层面的完整实现

---

**备注**: 
- 该文档会在执行过程中持续更新进度
- 遇到问题时及时记录和调整方案
- 完成后进行总结和经验分享