# è¡¥å¿è½¬å‡ºé€»è¾‘åˆ†æ

## å½“å‰è¡¥å¿æœºåˆ¶åˆ†æ

### 1. è¡¥å¿è§¦å‘æ¡ä»¶
```java
// å®šæ—¶ä»»åŠ¡ï¼šæ¯5ç§’æ‰§è¡Œä¸€æ¬¡
// å¤„ç†è¶…æ—¶5åˆ†é’Ÿçš„PENDINGè½¬å‡ºè®°å½•
@Scheduled(fixedRate = 5000)
List<BtseTransferLog> pendingRecords = btseTransferLogMapper.findTimeoutPendingTransfers(
    BusinessConstants.BtseTransferDirection.OUT, 
    timeoutTime,  // 5åˆ†é’Ÿå‰
    BusinessConstants.BtseTransferStatus.PENDING,
    maxRecords    // æœ€å¤š100æ¡
);
```

### 2. è¡¥å¿å¤„ç†é€»è¾‘
```java
// æŸ¥è¯¢BTSEå®é™…çŠ¶æ€ â†’ æ ¹æ®å®é™…çŠ¶æ€è¿›è¡Œè¡¥å¿
BtseTransferStatusDTO actualStatus = queryTransferStatus(transferLog.getTraceId());

if (actualStatus.getStatus().equals("SUCCESS")) {
    // å®é™…æˆåŠŸï¼šæ¸…é™¤frozen_balance
    handleSuccessfulTransferOutCompensation();
} else if (actualStatus.getStatus().equals("FAILED")) {
    // å®é™…å¤±è´¥ï¼šfrozen_balance â†’ balanceï¼ˆé€€å›èµ„é‡‘ï¼‰
    handleFailedTransferOutCompensation();
} else {
    // çŠ¶æ€æœªç¡®å®šï¼šç»§ç»­ç­‰å¾…
    return false;
}
```

### 3. å½“å‰å…³è”å­—æ®µ
```java
// btse_transfer_logè¡¨å­—æ®µ
private Long orderId;  // å…³è”è®¢å•ID - å°†åˆ é™¤
```

## æ–°æ–¹æ¡ˆä¸‹çš„è°ƒæ•´éœ€æ±‚

### 1. è¡¨ç»“æ„è°ƒæ•´
```sql
-- åˆ é™¤å­—æ®µ
ALTER TABLE btse_transfer_log DROP COLUMN order_id;

-- æ–°å¢å­—æ®µ
ALTER TABLE btse_transfer_log ADD COLUMN transfer_type VARCHAR(20) NOT NULL DEFAULT 'MANUAL_OUT';
ALTER TABLE btse_transfer_log ADD COLUMN refer_id BIGINT;

-- æ›´æ–°ç°æœ‰æ•°æ®
UPDATE btse_transfer_log SET 
    transfer_type = CASE 
        WHEN direction = 'IN' THEN 'ORDER_IN'
        WHEN direction = 'OUT' THEN 'MANUAL_OUT'
    END,
    refer_id = order_id
WHERE order_id IS NOT NULL;
```

### 2. è¡¥å¿é€»è¾‘è°ƒæ•´

#### åŸæ–¹æ¡ˆè¡¥å¿é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
```java
// âœ… è½¬å…¥è¡¥å¿ï¼šORDER_INç±»å‹ï¼Œrefer_idä¸ºè®¢å•ID
compensateTransferInRecord(transferLog) {
    // é€»è¾‘ä¿æŒä¸å˜ï¼š
    // 1. æŸ¥è¯¢BTSEå®é™…çŠ¶æ€
    // 2. æˆåŠŸâ†’æ›´æ–°ä½™é¢+å–æ¶ˆè®¢å•+é€€è¿˜
    // 3. å¤±è´¥â†’æ›´æ–°çŠ¶æ€ä¸ºFAILED
}

// âœ… åŸè½¬å‡ºè¡¥å¿ï¼šMANUAL_OUTç±»å‹ï¼Œrefer_idä¸ºç©ºæˆ–å…¶ä»–
compensateTransferOutRecord(transferLog) {
    // é€»è¾‘ä¿æŒä¸å˜ï¼š
    // 1. æŸ¥è¯¢BTSEå®é™…çŠ¶æ€  
    // 2. æˆåŠŸâ†’æ¸…é™¤frozen_balance
    // 3. å¤±è´¥â†’frozen_balanceå›åˆ°balance
}
```

#### æ–°å¢è¡¥å¿é€»è¾‘
```java
// ğŸ†• è½®æ¬¡è½¬å‡ºè¡¥å¿ï¼šROUND_OUTç±»å‹ï¼Œrefer_idä¸ºè½®æ¬¡ID
compensateRoundTransferOutRecord(transferLog) {
    // æ–°é€»è¾‘ï¼š
    // 1. æŸ¥è¯¢BTSEå®é™…çŠ¶æ€
    // 2. æˆåŠŸâ†’æ¸…é™¤frozen_balance
    // 3. å¤±è´¥â†’frozen_balanceå›åˆ°balance
    // 4. ç‰¹æ®Šå¤„ç†ï¼šå¯èƒ½éœ€è¦æ›´æ–°user_roundè¡¨çŠ¶æ€
}
```

### 3. å®šæ—¶ä»»åŠ¡è°ƒæ•´

#### ç°æœ‰å®šæ—¶ä»»åŠ¡ï¼ˆä¿æŒä¸å˜ï¼‰
```java
@Scheduled(fixedRate = 5000)
public void executeTransferInCompensationTask() {
    // âœ… å¤„ç†ORDER_INç±»å‹çš„è¡¥å¿
    compensatePendingTransferIn(5, 100);
}

@Scheduled(fixedRate = 5000) 
public void executeTransferOutCompensationTask() {
    // âœ… å¤„ç†MANUAL_OUTå’ŒROUND_OUTç±»å‹çš„è¡¥å¿
    compensatePendingTransferOut(5, 100);
}
```

#### è¡¥å¿æŸ¥è¯¢éœ€è¦è°ƒæ•´
```java
// åŸæŸ¥è¯¢ï¼šæŒ‰directionæŸ¥è¯¢
List<BtseTransferLog> findTimeoutPendingTransfers(direction, timeoutTime, status, maxRecords)

// æ–°æŸ¥è¯¢ï¼šæŒ‰transfer_typeæŸ¥è¯¢ï¼ˆå¯é€‰ï¼‰
List<BtseTransferLog> findTimeoutPendingTransfersByType(transferType, timeoutTime, status, maxRecords)
```

## å½±å“è¯„ä¼°

### 1. æ— éœ€è°ƒæ•´çš„éƒ¨åˆ† âœ…
- **è¡¥å¿è§¦å‘æœºåˆ¶**ï¼šå®šæ—¶ä»»åŠ¡é¢‘ç‡å’Œè¶…æ—¶æ—¶é—´ä¿æŒä¸å˜
- **BTSEçŠ¶æ€æŸ¥è¯¢**ï¼šä½¿ç”¨traceIdæŸ¥è¯¢å®é™…çŠ¶æ€çš„é€»è¾‘ä¸å˜
- **èµ„é‡‘å¤„ç†é€»è¾‘**ï¼šæˆåŠŸæ¸…é™¤frozen_balanceï¼Œå¤±è´¥é€€å›balanceçš„é€»è¾‘ä¸å˜
- **é‡è¯•æœºåˆ¶**ï¼š3æ¬¡é‡è¯•+é€’å¢å»¶è¿Ÿçš„ç­–ç•¥ä¿æŒä¸å˜

### 2. éœ€è¦è°ƒæ•´çš„éƒ¨åˆ† ğŸ“
- **è¡¨ç»“æ„**ï¼šåˆ é™¤order_idï¼Œå¢åŠ transfer_typeå’Œrefer_id
- **å®ä½“å­—æ®µ**ï¼šBtseTransferLogå®ä½“å¯¹åº”è°ƒæ•´
- **MapperæŸ¥è¯¢**ï¼šæ”¯æŒæŒ‰transfer_typeç­›é€‰ï¼ˆå¯é€‰ï¼‰
- **æ—¥å¿—è®°å½•**ï¼šè½¬å‡ºæ—¶è®¾ç½®æ­£ç¡®çš„transfer_typeå’Œrefer_id

### 3. æ–°å¢è¡¥å¿é€»è¾‘ ğŸ†•
- **è½®æ¬¡è½¬å‡ºè¡¥å¿**ï¼šå¤„ç†ROUND_OUTç±»å‹çš„è½¬å‡ºè®°å½•
- **user_roundçŠ¶æ€**ï¼šè½¬å‡ºå¤±è´¥æ—¶å¯èƒ½éœ€è¦æ ‡è®°user_roundè¡¨

## æ¨èè°ƒæ•´æ–¹æ¡ˆ

### ç¬¬ä¸€é˜¶æ®µï¼šè¡¨ç»“æ„è¿ç§»
1. å¢åŠ æ–°å­—æ®µï¼štransfer_type, refer_id
2. æ•°æ®è¿ç§»ï¼šå°†order_idæ˜ å°„åˆ°refer_id
3. åˆ é™¤æ—§å­—æ®µï¼šorder_id

### ç¬¬äºŒé˜¶æ®µï¼šä»£ç è°ƒæ•´
1. æ›´æ–°BtseTransferLogå®ä½“
2. è°ƒæ•´è½¬è´¦è®°å½•æ–¹æ³•ï¼Œè®¾ç½®æ­£ç¡®çš„transfer_type
3. è¡¥å¿é€»è¾‘ä¿æŒä¸å˜ï¼ˆæŒ‰directionå¤„ç†å³å¯ï¼‰

### ç¬¬ä¸‰é˜¶æ®µï¼šè½®æ¬¡è½¬å‡ºå®ç°
1. å®ç°è½®æ¬¡çº§åˆå¹¶è½¬å‡º
2. è®¾ç½®transfer_typeä¸ºROUND_OUTï¼Œrefer_idä¸ºè½®æ¬¡ID
3. ç°æœ‰è¡¥å¿é€»è¾‘è‡ªåŠ¨è¦†ç›–æ–°ç±»å‹

## ç»“è®º

**è¡¥å¿é€»è¾‘åŸºæœ¬ä¸éœ€è¦è°ƒæ•´**ï¼Œç°æœ‰çš„è¡¥å¿æœºåˆ¶å·²ç»å¾ˆå®Œå–„ï¼š
- âœ… å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤„ç†è¶…æ—¶è®°å½•
- âœ… æŸ¥è¯¢BTSEå®é™…çŠ¶æ€è¿›è¡Œç²¾ç¡®è¡¥å¿  
- âœ… èµ„é‡‘å¤„ç†é€»è¾‘æ­£ç¡®ï¼ˆæˆåŠŸæ¸…é™¤ï¼Œå¤±è´¥é€€å›ï¼‰
- âœ… é‡è¯•å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶å®Œå–„

**åªéœ€è¦åšè¡¨ç»“æ„è°ƒæ•´**ï¼Œè¡¥å¿é€»è¾‘è‡ªåŠ¨é€‚é…æ–°çš„è½¬å‡ºç±»å‹ã€‚