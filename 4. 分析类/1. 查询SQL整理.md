# äºŒå…ƒæœŸæƒå¹³å° SQLæŸ¥è¯¢æ•´ç†æ–‡æ¡£

## æ–‡æ¡£æ¦‚è¿°
æœ¬æ–‡æ¡£æ•´ç†äº†äºŒå…ƒæœŸæƒäº¤æ˜“å¹³å°ä¸­æ‰€æœ‰MyBatis Mapperçš„SQLæŸ¥è¯¢è¯­å¥ï¼Œç”¨äºæ€§èƒ½åˆ†æå’Œä¼˜åŒ–å‚è€ƒã€‚

## æœåŠ¡æ¶æ„
- **option-common-service** : è´¦æˆ·ç®¡ç†ã€BTSEé›†æˆã€ç”¨æˆ·ç®¡ç†
- **option-order-service** : è®¢å•å¤„ç†ã€é£æ§ã€äº¤æ˜“è½®æ¬¡

---

## option-common-service SQLæŸ¥è¯¢åˆ†æ

### 1. AccountMapper.xml - è´¦æˆ·ç®¡ç†æ ¸å¿ƒæŸ¥è¯¢

#### 1.1 åŸºç¡€æŸ¥è¯¢
```sql
-- æ ¹æ®IDæŸ¥è¯¢è´¦æˆ·
SELECT id, user_id, account_type, currency, balance, frozen_balance, 
       total_deposit, total_withdraw, total_profit, total_loss, 
       reset_count, last_reset_time, create_time, update_time
FROM account 
WHERE id = #{id}

-- ç´¢å¼•: PRIMARY KEY (id)
```

```sql
-- æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è´¦æˆ·åˆ—è¡¨
SELECT id, user_id, account_type, currency, balance, frozen_balance, 
       total_deposit, total_withdraw, total_profit, total_loss, 
       reset_count, last_reset_time, create_time, update_time
FROM account 
WHERE user_id = #{userId} 
ORDER BY account_type, currency

-- ç´¢å¼•: CREATE INDEX idx_account_user_id ON account (user_id);
```

```sql
-- æ ¹æ®ç”¨æˆ·IDå’Œè´¦æˆ·ç±»å‹æŸ¥è¯¢è´¦æˆ· (é«˜é¢‘)
SELECT id, user_id, account_type, currency, balance, frozen_balance, 
       total_deposit, total_withdraw, total_profit, total_loss, 
       reset_count, last_reset_time, create_time, update_time
FROM account 
WHERE user_id = #{userId} 
  AND account_type = #{accountType}

-- ç´¢å¼•: CREATE INDEX idx_account_user_type ON account (user_id, account_type);
```

#### 1.2 å†™å…¥æ“ä½œ
```sql
-- æ’å…¥æ–°è´¦æˆ·è®°å½•
INSERT INTO account (
    user_id, account_type, currency, balance, frozen_balance, 
    total_deposit, total_withdraw, total_profit, total_loss, 
    reset_count, last_reset_time, create_time, update_time
) VALUES (
    #{userId}, #{accountType}, #{currency}, #{balance}, #{frozenBalance},
    #{totalDeposit}, #{totalWithdraw}, #{totalProfit}, #{totalLoss},
    #{resetCount}, #{lastResetTime}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
)

-- ç´¢å¼•: PRIMARY KEY (id), UNIQUE (user_id, account_type)
```

#### 1.3 åŸå­æ›´æ–°æ“ä½œ
```sql
-- åŸå­æ€§ä½™é¢å˜æ›´ (ä¸šåŠ¡æ ¸å¿ƒï¼Œå¹¶å‘å®‰å…¨)
UPDATE account 
SET balance = balance + #{balanceChange}, 
    frozen_balance = frozen_balance + #{frozenChange}, 
    update_time = CURRENT_TIMESTAMP 
WHERE id = #{id} 
  AND balance + #{balanceChange} >= 0 
  AND frozen_balance + #{frozenChange} >= 0

-- ç´¢å¼•: PRIMARY KEY (id)
```

```sql
-- ä¸“ç”¨è½¬å‡ºå†»ç»“æ“ä½œ
UPDATE account 
SET balance = balance - #{amount}, 
    frozen_balance = frozen_balance + #{amount}, 
    update_time = CURRENT_TIMESTAMP 
WHERE id = #{id} 
  AND balance >= #{amount}

-- ç´¢å¼•: PRIMARY KEY (id)
```

#### 1.4 ç»Ÿè®¡å¯¹è´¦æŸ¥è¯¢
```sql
-- è´¦æˆ·ä½™é¢å¹³è¡¡æ£€æŸ¥ (å¯¹è´¦ä½¿ç”¨)
SELECT COALESCE(SUM(total_deposit) - SUM(total_withdraw) - SUM(balance) - SUM(frozen_balance) + SUM(total_profit) - SUM(total_loss), 0) 
FROM account 
WHERE account_type = #{accountType}

-- ç´¢å¼•: CREATE INDEX idx_account_type ON account (account_type);
```

```sql
-- è´¦æˆ·æ±‡æ€»æ•°æ®æŸ¥è¯¢ (å¯¹è´¦è¯¦æƒ…)
SELECT SUM(total_deposit) as total_deposit,
       SUM(total_withdraw) as total_withdraw,
       SUM(balance) as current_balance,
       SUM(frozen_balance) as current_frozen_balance,
       SUM(total_profit) as account_total_profit,
       SUM(total_loss) as account_total_loss
FROM account 
WHERE account_type = #{accountType}

-- ç´¢å¼•: CREATE INDEX idx_account_type ON account (account_type);
```

### 2. AccountTransactionMapper.xml - äº¤æ˜“æµæ°´æŸ¥è¯¢

#### 2.1 å†™å…¥æ“ä½œ
```sql
-- æ’å…¥äº¤æ˜“æµæ°´è®°å½• (æ¯æ¬¡ä½™é¢å˜åŠ¨éƒ½ä¼šè®°å½•)
INSERT INTO account_transaction (
    user_id, account_id, type, amount, frozen_amount, 
    balance_before, balance_after, frozen_before, frozen_after, 
    ref_id, ref_type, description, remark, create_time
) VALUES (
    #{userId}, #{accountId}, #{type}, #{amount}, 
    COALESCE(#{frozenAmount}, 0), #{balanceBefore}, #{balanceAfter},
    COALESCE(#{frozenBefore}, 0), COALESCE(#{frozenAfter}, 0),
    #{refId}, #{refType}, #{description}, #{remark}, 
    COALESCE(#{createTime}, CURRENT_TIMESTAMP)
)

-- åˆ é™¤æµæ°´è®°å½• (æå°‘ä½¿ç”¨ï¼Œä¸»è¦ç”¨äºæ•°æ®æ¸…ç†)
DELETE FROM account_transaction WHERE id = ?;

-- ç´¢å¼•: PRIMARY KEY (id), idx_transaction_user_time, idx_transaction_account_time
```

**æ‰§è¡Œé¢‘ç‡**: é«˜é¢‘ - ä¸AccountMapperåŒæ­¥ï¼Œæ¯ç¬”èµ„é‡‘æ“ä½œéƒ½è®°å½•ï¼Œçº¦1000 QPS
**ä¼˜åŒ–è¦ç‚¹**: è‡ªå¢ä¸»é”®ï¼Œç´¢å¼•user_idå’Œaccount_idï¼Œæ”¯æŒåˆ†åº“åˆ†è¡¨

#### 2.2 ç®¡ç†åå°æŸ¥è¯¢
```sql
-- ç”¨æˆ·æµæ°´åˆ†é¡µæŸ¥è¯¢ (ç®¡ç†åå°ä½¿ç”¨)
SELECT id, user_id, account_id, type, amount, frozen_amount, 
       balance_before, balance_after, frozen_before, frozen_after, 
       ref_id, ref_type, description, remark, create_time
FROM account_transaction 
WHERE user_id = #{userId} 
ORDER BY create_time DESC 
LIMIT #{limit} OFFSET #{offset}

-- ç´¢å¼•: CREATE INDEX idx_transaction_user_time ON account_transaction (user_id, create_time DESC);
```

```sql
-- æŒ‰è´¦æˆ·ç±»å‹æŸ¥è¯¢æµæ°´ (å¯¹è´¦ä½¿ç”¨)
SELECT at.id, at.user_id, at.account_id, at.type, at.amount, at.frozen_amount, 
       at.balance_before, at.balance_after, at.frozen_before, at.frozen_after, 
       at.ref_id, at.ref_type, at.description, at.remark, at.create_time
FROM account_transaction at 
INNER JOIN account a ON at.account_id = a.id 
WHERE a.account_type = #{accountType} 
ORDER BY at.create_time DESC 
LIMIT #{limit} OFFSET #{offset}

-- ç´¢å¼•: 
-- CREATE INDEX idx_transaction_account_time ON account_transaction (account_id, create_time DESC);
-- CREATE INDEX idx_account_type ON account (account_type);
```

#### 2.2 å¯¹è´¦èšåˆæŸ¥è¯¢
```sql
-- äº¤æ˜“æµæ°´é‡‘é¢æ±‡æ€» (å¯¹è´¦æ£€æŸ¥ä½¿ç”¨)
SELECT COALESCE(SUM(at.amount + COALESCE(at.frozen_amount, 0)), 0) 
FROM account_transaction at 
INNER JOIN account a ON at.account_id = a.id 
WHERE a.account_type = #{accountType}

-- ç´¢å¼•: 
-- CREATE INDEX idx_transaction_account_id ON account_transaction (account_id);
-- CREATE INDEX idx_account_type ON account (account_type);
```

### 3. BtseTransferLogMapper.xml - BTSEè½¬è´¦æ—¥å¿—æŸ¥è¯¢

#### 3.1 è¶…æ—¶å¤„ç†æŸ¥è¯¢
```sql
-- æŸ¥è¯¢è¶…æ—¶è½¬è´¦è®°å½• (å®šæ—¶ä»»åŠ¡ä½¿ç”¨)
SELECT id, trace_id, user_id, order_id, direction, amount, currency, 
       transfer_id, api_method, status, error_message, request_data, 
       response_data, retry_count, environment, is_mock, 
       request_time, response_time, create_time, update_time
FROM btse_transfer_log 
WHERE direction = #{direction} 
  AND status = #{status} 
  AND create_time < #{timeoutTime} 
ORDER BY create_time ASC 
LIMIT #{limit}

-- ç´¢å¼•: CREATE INDEX idx_btse_transfer_timeout ON btse_transfer_log (direction, status, create_time);
```

#### 3.2 è®¢å•è½¬è´¦è®°å½•æŸ¥è¯¢
```sql
-- æŸ¥è¯¢è®¢å•æˆåŠŸè½¬è´¦è®°å½•
SELECT id, trace_id, user_id, order_id, direction, amount, currency, 
       transfer_id, api_method, status, error_message, request_data, 
       response_data, retry_count, environment, is_mock, 
       request_time, response_time, create_time, update_time
FROM btse_transfer_log 
WHERE order_id = #{orderId} 
  AND direction = #{direction} 
  AND status = 'SUCCESS' 
ORDER BY create_time DESC 
LIMIT 1

-- ç´¢å¼•: CREATE INDEX idx_btse_transfer_order ON btse_transfer_log (order_id, direction, status, create_time DESC);
```

#### 3.3 å†™å…¥æ“ä½œ (INSERT/UPDATE/DELETE)
```sql
-- è®°å½•BTSEè½¬è´¦æ“ä½œ
INSERT INTO btse_transfer_log (
    trace_id, user_id, order_id, direction, amount, currency, 
    transfer_id, api_method, status, error_message, request_data, 
    response_data, retry_count, environment, is_mock, 
    request_time, response_time, create_time, update_time
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'PENDING', ?, ?, ?, 0, ?, ?, 
         CURRENT_TIMESTAMP, NULL, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);

-- æ›´æ–°è½¬è´¦çŠ¶æ€
UPDATE btse_transfer_log SET
    status = ?,
    transfer_id = ?,
    response_data = ?,
    response_time = CURRENT_TIMESTAMP,
    update_time = CURRENT_TIMESTAMP
WHERE trace_id = ? AND direction = ?;

-- æ›´æ–°è½¬è´¦é”™è¯¯ä¿¡æ¯
UPDATE btse_transfer_log SET
    status = 'FAILED',
    error_message = ?,
    response_time = CURRENT_TIMESTAMP,
    update_time = CURRENT_TIMESTAMP
WHERE id = ?;
```

**æ‰§è¡Œé¢‘ç‡**: ä½é¢‘ - REALè´¦æˆ·è½¬è´¦çº¦50 QPSï¼ŒçŠ¶æ€æ›´æ–°çº¦50 QPS
**ä¼˜åŒ–è¦ç‚¹**: trace_idç´¢å¼•ï¼Œå¤åˆç´¢å¼•(direction, status, create_time)æ”¯æŒè¡¥å¿æŸ¥è¯¢

### 4. GlobalConfigMapper.xml - å…¨å±€é…ç½®æŸ¥è¯¢

```sql
-- æ ¹æ®é…ç½®é”®æŸ¥è¯¢ (é«˜é¢‘è®¿é—®)
SELECT id, config_key, config_value, config_type, config_group, 
       description, enabled, sort_order, create_time, update_time
FROM global_config 
WHERE config_key = #{configKey} 
  AND enabled = 1

-- ç´¢å¼•: CREATE UNIQUE INDEX uk_global_config_key ON global_config (config_key);
```

### 5. SymbolConfigMapper.xml - äº¤æ˜“å¯¹é…ç½®æŸ¥è¯¢

```sql
-- æŸ¥è¯¢å¯ç”¨çš„äº¤æ˜“å¯¹
SELECT id, symbol, base_currency, quote_currency, enabled, 
       min_amount, max_amount, btse_symbol, sort_order, 
       create_time, update_time
FROM symbol_config 
WHERE enabled = 1 
ORDER BY sort_order, id

-- ç´¢å¼•: CREATE INDEX idx_symbol_config_enabled ON symbol_config (enabled, sort_order);
```

### 6. UserMapper.xml - ç”¨æˆ·ç®¡ç†æŸ¥è¯¢

```sql
-- æ ¹æ®å¤–éƒ¨IDæŸ¥è¯¢ç”¨æˆ· (OAuthè®¤è¯é«˜é¢‘ä½¿ç”¨)
SELECT id, external_id, password, nickname, email, phone, 
       status, signature, risk_agreement, aml_agreement, 
       create_time, update_time
FROM "user" 
WHERE external_id = #{externalId}

-- ç´¢å¼•: CREATE UNIQUE INDEX uk_user_external_id ON "user" (external_id);
```

```sql
-- æ—¶é—´èŒƒå›´æŸ¥è¯¢æ–°ç”¨æˆ· (ç»Ÿè®¡åˆ†æä½¿ç”¨)
SELECT id, external_id, password, nickname, email, phone, 
       status, signature, risk_agreement, aml_agreement, 
       create_time, update_time
FROM "user" 
WHERE create_time BETWEEN #{startTime} AND #{endTime} 
ORDER BY create_time DESC

-- ç´¢å¼•: CREATE INDEX idx_user_create_time ON "user" (create_time DESC);
```

---

## option-order-service SQLæŸ¥è¯¢åˆ†æ

### 7. OrderMapper.xml - è®¢å•ç®¡ç†æ ¸å¿ƒæŸ¥è¯¢

#### 7.1 å†™å…¥æ“ä½œ
```sql
-- æ’å…¥è®¢å•è®°å½• (ä¸‹å•æ—¶)
INSERT INTO option_order (
    user_id, account_type, symbol_id, round_id, round_no, 
    direction, amount, odds, expected_profit, order_price, 
    status, create_time, update_time
) VALUES (
    #{userId}, #{accountType}, #{symbolId}, #{roundId}, #{roundNo},
    #{direction}, #{amount}, #{odds}, #{expectedProfit}, #{orderPrice},
    #{status}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
)

-- ç´¢å¼•: PRIMARY KEY (id), idx_order_user_account_time, idx_order_round_status
```

```sql
-- æ›´æ–°è®¢å•çŠ¶æ€ (çŠ¶æ€å˜æ›´æ—¶)
UPDATE option_order 
SET status = #{status}, 
    update_time = CURRENT_TIMESTAMP 
WHERE id = #{id}

-- ç´¢å¼•: PRIMARY KEY (id)
```

```sql
-- ç»“ç®—è®¢å• (ç»“ç®—æ—¶ä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰ç»“ç®—å­—æ®µ)
UPDATE option_order 
SET status = #{status}, 
    settle_price = #{settlePrice}, 
    profit = #{profit}, 
    fee = #{fee}, 
    settle_time = #{settleTime}, 
    update_time = CURRENT_TIMESTAMP 
WHERE id = #{id}

-- æ‰¹é‡çŠ¶æ€æ›´æ–° (æŒ‰è½®æ¬¡ç»“ç®—)
UPDATE option_order SET 
    status = ?,
    settle_price = ?,
    profit = ?,
    settle_time = CURRENT_TIMESTAMP,
    update_time = CURRENT_TIMESTAMP
WHERE round_id = ? AND status = 'ACTIVE';

-- ç´¢å¼•: PRIMARY KEY (id), idx_order_round_status
```

**æ‰§è¡Œé¢‘ç‡**: é«˜é¢‘ - ä¸‹å•çº¦500 QPSï¼ŒçŠ¶æ€æ›´æ–°çº¦200 QPSï¼Œç»“ç®—çº¦50 QPS
**ä¼˜åŒ–è¦ç‚¹**: å¤åˆç´¢å¼•(user_id, order_status)ï¼Œround_idç´¢å¼•æ”¯æŒæ‰¹é‡ç»“ç®—

#### 7.2 è®¢å•åŸºç¡€æŸ¥è¯¢
```sql
-- æ ¹æ®IDæŸ¥è¯¢è®¢å•
SELECT id, user_id, account_type, symbol_id, round_id, round_no, 
       direction, amount, odds, expected_profit, order_price, settle_price, 
       status, profit, fee, settle_time, cancel_time, 
       create_time, update_time
FROM option_order 
WHERE id = #{id}

-- ç´¢å¼•: PRIMARY KEY (id)
```

```sql
-- ç”¨æˆ·è®¢å•åˆ—è¡¨æŸ¥è¯¢ (é«˜é¢‘è®¿é—®)
SELECT id, user_id, account_type, symbol_id, round_id, round_no, 
       direction, amount, odds, expected_profit, order_price, settle_price, 
       status, profit, fee, settle_time, cancel_time, 
       create_time, update_time
FROM option_order 
WHERE user_id = #{userId} 
  AND account_type = #{accountType} 
ORDER BY id DESC 
LIMIT #{limit} OFFSET #{offset}

-- ç´¢å¼•: CREATE INDEX idx_order_user_account_time ON option_order (user_id, account_type, create_time DESC);
```

#### 7.3 ç»“ç®—ç›¸å…³æŸ¥è¯¢
```sql
-- è½®æ¬¡å¾…ç»“ç®—è®¢å•æŸ¥è¯¢ (å®šæ—¶ä»»åŠ¡å…³é”®æŸ¥è¯¢)
SELECT id, user_id, account_type, symbol_id, round_id, round_no, 
       direction, amount, odds, expected_profit, order_price, settle_price, 
       status, profit, fee, settle_time, cancel_time, 
       create_time, update_time
FROM option_order 
WHERE round_id = #{roundId} 
  AND status = 'ACTIVE' 
ORDER BY id ASC

-- ç´¢å¼•: CREATE INDEX idx_order_round_status ON option_order (round_id, status);
```

#### 7.4 ç»Ÿè®¡èšåˆæŸ¥è¯¢
```sql
-- ç”¨æˆ·æ—¶é—´èŒƒå›´é‡‘é¢ç»Ÿè®¡ (é£æ§æ£€æŸ¥ä½¿ç”¨)
SELECT COALESCE(SUM(amount), 0) 
FROM option_order 
WHERE user_id = #{userId} 
  AND account_type = #{accountType} 
  AND create_time >= #{startTime}
  AND create_time <= #{endTime}

-- ç´¢å¼•: CREATE INDEX idx_order_user_account_time_range ON option_order (user_id, account_type, create_time);
```

```sql
-- ç”¨æˆ·ç›ˆåˆ©ç»Ÿè®¡
SELECT COALESCE(SUM(profit), 0) 
FROM option_order 
WHERE user_id = #{userId} 
  AND account_type = #{accountType} 
  AND profit IS NOT NULL

-- ç´¢å¼•: CREATE INDEX idx_order_user_profit ON option_order (user_id, account_type, profit) WHERE profit IS NOT NULL;
```

#### 7.5 å¤æ‚å†å²æŸ¥è¯¢

```sql
-- ç”¨æˆ·å†å²è½®æ¬¡IDæŸ¥è¯¢ (MySQLç‰ˆæœ¬)
SELECT DISTINCT round_id
FROM option_order o
WHERE o.user_id = #{userId}
  AND o.account_type = #{accountType}
  AND o.status IN ('WIN', 'LOSE')
GROUP BY round_id
ORDER BY MAX(o.settle_time) DESC
LIMIT #{limit} OFFSET #{offset}

-- ç´¢å¼•: CREATE INDEX idx_order_user_status_settle ON option_order (user_id, account_type, status, settle_time DESC);
```

```sql
-- ç”¨æˆ·å†å²è½®æ¬¡IDæŸ¥è¯¢ (PostgreSQLç‰ˆæœ¬)
SELECT round_id
FROM (
  SELECT round_id, MAX(settle_time) as max_settle_time
  FROM option_order
  WHERE user_id = #{userId}
    AND account_type = #{accountType}
    AND status IN ('WIN', 'LOSE')
  GROUP BY round_id
  ORDER BY max_settle_time DESC
  LIMIT #{limit} OFFSET #{offset}
) subquery

-- ç´¢å¼•: CREATE INDEX idx_order_user_status_settle ON option_order (user_id, account_type, status, settle_time DESC);
-- æ³¨æ„: æ­¤æŸ¥è¯¢å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Œæ·±åº¦åˆ†é¡µæ—¶æ€§èƒ½ä¸‹é™æ˜æ˜¾ï¼Œåç»­éœ€è¦ä¼˜åŒ–
```

### 8. TradingRoundMapper.xml - äº¤æ˜“è½®æ¬¡æŸ¥è¯¢

#### 8.1 å†™å…¥æ“ä½œ
```sql
-- æ’å…¥æ–°äº¤æ˜“è½®æ¬¡
INSERT INTO trading_round (
    round_no, symbol_id, duration_minutes, start_time, 
    lock_time, end_time, start_price, status,
    total_up_amount, total_down_amount, create_time, update_time
) VALUES (
    #{roundNo}, #{symbolId}, #{durationMinutes}, #{startTime},
    #{lockTime}, #{endTime}, #{startPrice}, #{status},
    0.0, 0.0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
)

-- è½®æ¬¡çŠ¶æ€æ›´æ–° (OPEN -> LOCKED -> COMPLETED)
UPDATE trading_round SET 
    status = ?,
    update_time = CURRENT_TIMESTAMP
WHERE id = ?;

-- è½®æ¬¡ç»“ç®—æ›´æ–°
UPDATE trading_round SET 
    status = 'COMPLETED',
    end_price = ?,
    update_time = CURRENT_TIMESTAMP
WHERE id = ?;

-- åŸå­æ€§æŠ•æ³¨é¢æ›´æ–° (å¹¶å‘å®‰å…¨)
UPDATE trading_round SET 
    total_up_amount = total_up_amount + ?, 
    total_down_amount = total_down_amount + ?, 
    update_time = CURRENT_TIMESTAMP 
WHERE id = ?;

-- ç´¢å¼•: PRIMARY KEY (id), idx_trading_round_current
```

**æ‰§è¡Œé¢‘ç‡**: ä½é¢‘ - åˆ›å»ºçº¦10 QPSï¼ŒçŠ¶æ€æ›´æ–°çº¦5 QPSï¼ŒæŠ•æ³¨é¢æ›´æ–°çº¦500 QPS
**ä¼˜åŒ–è¦ç‚¹**: å¤åˆç´¢å¼•(symbol_id, duration_minutes, status)æ”¯æŒè½®æ¬¡æŸ¥è¯¢

#### 8.2 è½®æ¬¡çŠ¶æ€æŸ¥è¯¢
```sql
-- æŸ¥è¯¢å½“å‰è¿›è¡Œä¸­è½®æ¬¡ (é«˜é¢‘æŸ¥è¯¢ï¼Œä¸‹å•æ—¶ä½¿ç”¨)
SELECT id, round_no, symbol_id, duration_minutes, start_time, 
       lock_time, end_time, start_price, end_price, status, 
       total_up_amount, total_down_amount, create_time, update_time
FROM trading_round 
WHERE symbol_id = #{symbolId} 
  AND duration_minutes = #{durationMinutes} 
  AND status IN ('OPEN', 'LOCKED') 
  AND CURRENT_TIMESTAMP BETWEEN start_time AND end_time 
ORDER BY start_time DESC 
LIMIT 1

-- ç´¢å¼•: CREATE INDEX idx_trading_round_current ON trading_round (symbol_id, duration_minutes, status, start_time, end_time);
```

```sql
-- æŸ¥è¯¢éœ€è¦ç»“ç®—çš„è½®æ¬¡ (å®šæ—¶ä»»åŠ¡ä½¿ç”¨)
SELECT id, round_no, symbol_id, duration_minutes, start_time, 
       lock_time, end_time, start_price, end_price, status, 
       total_up_amount, total_down_amount, create_time, update_time
FROM trading_round 
WHERE status IN ('OPEN', 'LOCKED') 
  AND end_time <= #{currentTime} 
ORDER BY end_time

-- ç´¢å¼•: CREATE INDEX idx_trading_round_settlement ON trading_round (status, end_time);
```

#### 8.3 è½®æ¬¡æ›´æ–°æ“ä½œ
```sql
-- åŸå­æ€§æŠ•æ³¨é¢æ›´æ–° (å¹¶å‘å®‰å…¨å…³é”®)
UPDATE trading_round 
SET total_up_amount = total_up_amount + #{upAmountChange}, 
    total_down_amount = total_down_amount + #{downAmountChange}, 
    update_time = CURRENT_TIMESTAMP 
WHERE id = #{id}

-- ç´¢å¼•: PRIMARY KEY (id)
```

### 9. BlacklistMapper.xml - é»‘åå•æŸ¥è¯¢

```sql
-- æŸ¥è¯¢æœ‰æ•ˆé»‘åå• (é£æ§æ£€æŸ¥ä½¿ç”¨)
SELECT id, user_id, reason, operator_id, operator_name, 
       start_time, end_time, status, create_time, update_time
FROM blacklist 
WHERE user_id = #{userId} 
  AND status = 1 
  AND start_time <= #{currentTime} 
  AND (end_time IS NULL OR end_time > #{currentTime}) 
LIMIT 1

-- ç´¢å¼•: CREATE INDEX idx_blacklist_user_status_time ON blacklist (user_id, status, start_time, end_time);
```

### 10. RiskConfigMapper.xml - é£æ§é…ç½®æŸ¥è¯¢

```sql
-- æ ¹æ®é…ç½®é”®æŸ¥è¯¢é£æ§é…ç½®
SELECT id, config_key, config_value, config_type, description, 
       enabled, create_time, update_time
FROM risk_config 
WHERE config_key = #{configKey}

-- ç´¢å¼•: CREATE UNIQUE INDEX uk_risk_config_key ON risk_config (config_key);
```

### 11. RiskLogMapper.xml - é£æ§æ—¥å¿—æŸ¥è¯¢

```sql
-- æ—¶é—´èŒƒå›´æŸ¥è¯¢é£æ§æ—¥å¿— (åˆ†é¡µæŸ¥è¯¢)
SELECT id, user_id, order_id, risk_type, risk_level, risk_score, 
       trigger_value, threshold_value, action_taken, action_result, 
       description, create_time
FROM risk_log 
WHERE create_time BETWEEN #{startTime} AND #{endTime} 
ORDER BY create_time DESC 
LIMIT #{limit} OFFSET #{offset}

-- ç´¢å¼•: CREATE INDEX idx_risk_log_time_range ON risk_log (create_time DESC);
```

```sql
-- æ‰¹é‡æ’å…¥é£æ§æ—¥å¿— (æ€§èƒ½å…³é”®)
INSERT INTO risk_log (
  user_id, order_id, risk_type, risk_level, risk_score,
  trigger_value, threshold_value, action_taken, action_result,
  description, create_time
) VALUES
  (#{log.userId}, #{log.orderId}, #{log.riskType}, #{log.riskLevel}, #{log.riskScore},
   #{log.triggerValue}, #{log.thresholdValue}, #{log.actionTaken}, #{log.actionResult},
   #{log.description}, COALESCE(#{log.createTime}, CURRENT_TIMESTAMP)),
  ...

-- ç´¢å¼•: PRIMARY KEY (id) è‡ªå¢ä¸»é”®
```

### 12. OrderHedgeMapper.xml - è®¢å•å¯¹å†²æŸ¥è¯¢

#### 12.1 å†™å…¥æ“ä½œ
```sql
-- æ’å…¥å¯¹å†²è®°å½• (REALè´¦æˆ·ä¸‹å•æ—¶)
INSERT INTO option_order_hedge (
    order_id, symbol, expiration, strike, side, fixture_price,
    hedge_amount, hedge_status, hedge_time, hedge_message, retry_count,
    create_time, update_time
) VALUES (
    #{orderId}, #{symbol}, #{expiration}, #{strike}, #{side}, #{fixturePrice},
    #{hedgeAmount}, #{hedgeStatus}, #{hedgeTime}, #{hedgeMessage}, #{retryCount},
    CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
)

-- ç´¢å¼•: PRIMARY KEY (id), idx_order_hedge_order_id, idx_order_hedge_status_create_time
```

#### 12.2 åŸºç¡€æŸ¥è¯¢
```sql
-- æ ¹æ®è®¢å•IDæŸ¥è¯¢å¯¹å†²è®°å½• (æ¯æ¬¡REALè´¦æˆ·ä¸‹å•éƒ½ä¼šæŸ¥è¯¢)
SELECT id, order_id, symbol, expiration, strike, side, 
       fixture_price, hedge_amount, hedge_status, hedge_time, 
       hedge_message, retry_count, create_time, update_time
FROM option_order_hedge 
WHERE order_id = #{orderId}

-- ç´¢å¼•: CREATE INDEX idx_order_hedge_order_id ON option_order_hedge (order_id);
```

#### 12.3 çŠ¶æ€ç®¡ç†æŸ¥è¯¢
```sql
-- æŸ¥è¯¢å¾…å¤„ç†çš„å¯¹å†²è®°å½• (å®šæ—¶ä»»åŠ¡ä½¿ç”¨)
SELECT id, order_id, symbol, expiration, strike, side, 
       fixture_price, hedge_amount, hedge_status, hedge_time, 
       hedge_message, retry_count, create_time, update_time
FROM option_order_hedge 
WHERE hedge_status = 'PENDING' 
ORDER BY create_time ASC 
LIMIT #{limit}

-- ç´¢å¼•: CREATE INDEX idx_order_hedge_status_create_time ON option_order_hedge (hedge_status, create_time);
```

```sql
-- æŸ¥è¯¢å¤±è´¥çš„å¯¹å†²è®°å½• (è¡¥å¿ä»»åŠ¡ä½¿ç”¨)
SELECT id, order_id, symbol, expiration, strike, side, 
       fixture_price, hedge_amount, hedge_status, hedge_time, 
       hedge_message, retry_count, create_time, update_time
FROM option_order_hedge 
WHERE hedge_status = 'FAILED' 
  AND retry_count < #{maxRetryCount} 
  AND create_time > CURRENT_TIMESTAMP - INTERVAL '1 DAY' 
ORDER BY create_time ASC 
LIMIT #{limit}

-- ç´¢å¼•: CREATE INDEX idx_order_hedge_status_retry ON option_order_hedge (hedge_status, retry_count, create_time);
```

#### 12.3 çŠ¶æ€æ›´æ–°æ“ä½œ
```sql
-- æ›´æ–°å¯¹å†²çŠ¶æ€ (æ¯æ¬¡å¯¹å†²æ“ä½œå®Œæˆå)
UPDATE option_order_hedge 
SET hedge_status = #{hedgeStatus}, 
    hedge_time = #{hedgeTime}, 
    hedge_message = #{hedgeMessage}, 
    update_time = CURRENT_TIMESTAMP 
WHERE order_id = #{orderId}

-- ç´¢å¼•: CREATE INDEX idx_order_hedge_order_id ON option_order_hedge (order_id);
```

### 13. UserRiskStatsMapper.xml - ç”¨æˆ·é£æ§ç»Ÿè®¡æŸ¥è¯¢ (æ–°å¢)

#### 13.1 åŸºç¡€æŸ¥è¯¢
```sql
-- æ ¹æ®ç”¨æˆ·IDå’Œè´¦æˆ·ç±»å‹æŸ¥è¯¢é£æ§ç»Ÿè®¡ (é«˜é¢‘æŸ¥è¯¢ï¼Œæ›¿ä»£åŸé£æ§SQL)
SELECT id, user_id, account_type, today_order_count, today_order_amount, 
       today_win_count, today_loss_count, today_profit,
       week_order_count, week_order_amount, week_win_count, week_loss_count, week_profit,
       month_order_count, month_order_amount, month_win_count, month_loss_count, month_profit,
       total_order_count, total_order_amount, total_win_count, total_loss_count, total_profit,
       last_order_time, last_reset_date, last_reset_week, last_reset_month,
       create_time, update_time
FROM user_risk_stats 
WHERE user_id = #{userId} 
  AND account_type = #{accountType}

-- ç´¢å¼•: CREATE INDEX idx_user_risk_stats_user_account ON user_risk_stats (user_id, account_type);
```

```sql
-- æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·é£æ§ç»Ÿè®¡ (æ‰¹é‡é£æ§æ£€æŸ¥ä½¿ç”¨)
SELECT id, user_id, account_type, today_order_count, today_order_amount, 
       today_win_count, today_loss_count, today_profit,
       week_order_count, week_order_amount, week_win_count, week_loss_count, week_profit,
       month_order_count, month_order_amount, month_win_count, month_loss_count, month_profit,
       total_order_count, total_order_amount, total_win_count, total_loss_count, total_profit,
       last_order_time, last_reset_date, last_reset_week, last_reset_month,
       create_time, update_time
FROM user_risk_stats 
WHERE user_id IN (#{userIds}) 
  AND account_type = #{accountType} 
ORDER BY user_id

-- ç´¢å¼•: CREATE INDEX idx_user_risk_stats_user_id ON user_risk_stats (user_id);
```

#### 13.2 å®šæ—¶é‡ç½®æŸ¥è¯¢
```sql
-- æŸ¥è¯¢éœ€è¦é‡ç½®çš„ç»Ÿè®¡è®°å½• (å®šæ—¶ä»»åŠ¡ä½¿ç”¨)
SELECT id, user_id, account_type, today_order_count, today_order_amount, 
       today_win_count, today_loss_count, today_profit,
       week_order_count, week_order_amount, week_win_count, week_loss_count, week_profit,
       month_order_count, month_order_amount, month_win_count, month_loss_count, month_profit,
       total_order_count, total_order_amount, total_win_count, total_loss_count, total_profit,
       last_order_time, last_reset_date, last_reset_week, last_reset_month,
       create_time, update_time
FROM user_risk_stats 
WHERE (last_reset_date IS NULL OR last_reset_date < CURRENT_DATE)
   OR (last_reset_week IS NULL OR last_reset_week < DATE_TRUNC('week', CURRENT_DATE))
   OR (last_reset_month IS NULL OR last_reset_month < DATE_TRUNC('month', CURRENT_DATE)) 
ORDER BY update_time 
LIMIT #{limit}

-- ç´¢å¼•: CREATE INDEX idx_user_risk_stats_update_time ON user_risk_stats (update_time);
```

#### 13.3 å†™å…¥æ“ä½œ (INSERT/UPDATE)
```sql
-- æ’å…¥æˆ–åˆå§‹åŒ–ç”¨æˆ·é£æ§ç»Ÿè®¡è®°å½•
INSERT INTO user_risk_stats (
    user_id, account_type, today_order_count, today_order_amount, 
    today_win_count, today_loss_count, today_profit,
    week_order_count, week_order_amount, week_win_count, week_loss_count, week_profit,
    month_order_count, month_order_amount, month_win_count, month_loss_count, month_profit,
    total_order_count, total_order_amount, total_win_count, total_loss_count, total_profit,
    last_order_time, last_reset_date, last_reset_week, last_reset_month,
    create_time, update_time
) VALUES (?, ?, 0, 0.00, 0, 0, 0.00, 0, 0.00, 0, 0, 0.00, 0, 0.00, 0, 0, 0.00,
         0, 0.00, 0, 0, 0.00, NULL, NULL, NULL, NULL, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);

-- å¢é‡æ›´æ–°ç»Ÿè®¡æ•°æ® (æ¯æ¬¡ä¸‹å•)
UPDATE user_risk_stats SET
    today_order_count = today_order_count + 1,
    week_order_count = week_order_count + 1,
    month_order_count = month_order_count + 1,
    total_order_count = total_order_count + 1,
    today_order_amount = today_order_amount + ?,
    week_order_amount = week_order_amount + ?,
    month_order_amount = month_order_amount + ?,
    total_order_amount = total_order_amount + ?,
    last_order_time = CURRENT_TIMESTAMP,
    update_time = CURRENT_TIMESTAMP
WHERE user_id = ? AND account_type = ?;

-- ç»“ç®—åæ›´æ–°ç›ˆäºç»Ÿè®¡
UPDATE user_risk_stats SET
    today_win_count = today_win_count + ?,
    today_loss_count = today_loss_count + ?,
    today_profit = today_profit + ?,
    week_win_count = week_win_count + ?,
    week_loss_count = week_loss_count + ?,
    week_profit = week_profit + ?,
    month_win_count = month_win_count + ?,
    month_loss_count = month_loss_count + ?,
    month_profit = month_profit + ?,
    total_win_count = total_win_count + ?,
    total_loss_count = total_loss_count + ?,
    total_profit = total_profit + ?,
    update_time = CURRENT_TIMESTAMP
WHERE user_id = ? AND account_type = ?;
```

**æ‰§è¡Œé¢‘ç‡**: ä¸­é¢‘ - å¢é‡æ›´æ–°çº¦500 QPSï¼Œç»“ç®—æ›´æ–°çº¦50 QPSï¼Œåˆå§‹åŒ–çº¦10 QPS
**ä¼˜åŒ–è¦ç‚¹**: å¤åˆç´¢å¼•(user_id, account_type)ï¼Œæ”¯æŒæŒ‰å‘¨æœŸç±»å‹æ‰¹é‡æ“ä½œ

#### 13.4 æ‰¹é‡é‡ç½®æ“ä½œ
```sql
-- æ‰¹é‡é‡ç½®ä»Šæ—¥ç»Ÿè®¡
UPDATE user_risk_stats 
SET today_order_count = 0,
    today_order_amount = 0,
    today_win_count = 0,
    today_loss_count = 0,
    today_profit = 0,
    last_reset_date = #{resetDate} 
WHERE id IN (#{ids})

-- ç´¢å¼•: PRIMARY KEY (id)
```

```sql
-- æ‰¹é‡é‡ç½®æœ¬å‘¨ç»Ÿè®¡
UPDATE user_risk_stats 
SET week_order_count = 0,
    week_order_amount = 0,
    week_win_count = 0,
    week_loss_count = 0,
    week_profit = 0,
    last_reset_week = #{resetWeek} 
WHERE id IN (#{ids})

-- ç´¢å¼•: PRIMARY KEY (id)
```

```sql
-- æ‰¹é‡é‡ç½®æœ¬æœˆç»Ÿè®¡
UPDATE user_risk_stats 
SET month_order_count = 0,
    month_order_amount = 0,
    month_win_count = 0,
    month_loss_count = 0,
    month_profit = 0,
    last_reset_month = #{resetMonth} 
WHERE id IN (#{ids})

-- ç´¢å¼•: PRIMARY KEY (id)
```

---

## SQLæ“ä½œé¢‘ç‡å’Œæ€§èƒ½åˆ†çº§ï¼ˆåŸºäºå®é™…åœºæ™¯ï¼‰

### åœºæ™¯å‡è®¾
- **ç”¨æˆ·è§„æ¨¡**ï¼š100-1000 åœ¨çº¿ç”¨æˆ·
- **è½®æ¬¡å‘¨æœŸ**ï¼š5åˆ†é’Ÿä¸€è½®ï¼Œæ¯å°æ—¶12è½®
- **ç”¨æˆ·è¡Œä¸º**ï¼šæ¯ç”¨æˆ·5åˆ†é’Ÿå†…ä¸‹å•0-10ç¬”ï¼ˆå¹³å‡5ç¬”ï¼‰
- **æŸ¥è¯¢è¡Œä¸º**ï¼šæ¯ç”¨æˆ·æ¯åˆ†é’ŸæŸ¥è¯¢0-5æ¬¡ï¼ˆå¹³å‡2.5æ¬¡ï¼‰
- **äº¤æ˜“å¯¹æ•°é‡**ï¼šå•å¸å¯¹åœºæ™¯ï¼ˆå¯æ‰©å±•ï¼‰

### æ“ä½œé¢‘ç‡è®¡ç®—ï¼ˆåŸºäº1000ç”¨æˆ·ï¼ŒåŒ…å«è¯»å†™æ“ä½œï¼‰

#### ğŸ”´ è¶…é«˜é¢‘æ“ä½œ (æ¯ç§’10-100æ¬¡)

**è¯»æ“ä½œ (SELECT)**

1. **å½“å‰è½®æ¬¡æŸ¥è¯¢** `TradingRoundMapper.findCurrentRound`
   - è§¦å‘ï¼šæ¯æ¬¡ä¸‹å•å‰æŸ¥è¯¢
   - é¢‘ç‡ï¼š1000ç”¨æˆ· Ã— 5å•/5åˆ†é’Ÿ = 1000å•/åˆ†é’Ÿ = **17æ¬¡/ç§’**
   - ç´¢å¼•ï¼šidx_trading_round_current (symbol_id, duration_minutes, status, start_time, end_time)

2. **è´¦æˆ·æŸ¥è¯¢** `AccountMapper.findByUserIdAndAccountType`  
   - è§¦å‘ï¼šä¸‹å•ã€æŸ¥è¯¢ä½™é¢ã€è½¬è´¦
   - é¢‘ç‡ï¼šä¸‹å•(17æ¬¡/ç§’) + æŸ¥è¯¢(42æ¬¡/ç§’) = **59æ¬¡/ç§’**
   - ç´¢å¼•ï¼šidx_user_account_type (user_id, account_type)

3. **ç”¨æˆ·è®¢å•åˆ—è¡¨** `OrderMapper.findByUserIdAndAccountType`
   - è§¦å‘ï¼šç”¨æˆ·æŸ¥çœ‹å½“å‰è®¢å•ã€å†å²è®¢å•
   - é¢‘ç‡ï¼š1000ç”¨æˆ· Ã— 2.5æ¬¡/åˆ†é’Ÿ = **42æ¬¡/ç§’**
   - ç´¢å¼•ï¼šidx_option_order_user_account_create_time

**å†™æ“ä½œ (INSERT/UPDATE/DELETE)**

1. **ä½™é¢åŸå­æ›´æ–°** `AccountMapper.atomicBalanceChange`
   - è§¦å‘ï¼šä¸‹å•å†»ç»“ã€ç»“ç®—ã€è½¬è´¦
   - é¢‘ç‡ï¼šä¸‹å•(17æ¬¡/ç§’) + ç»“ç®—(3.3æ¬¡/ç§’) + è½¬è´¦(2æ¬¡/ç§’) = **22æ¬¡/ç§’**
   - ç´¢å¼•ï¼šPRIMARY KEY (id)

2. **è®¢å•åˆ›å»º** `OrderMapper.insert`
   - è§¦å‘ï¼šç”¨æˆ·ä¸‹å•
   - é¢‘ç‡ï¼š**17æ¬¡/ç§’**
   - ç´¢å¼•ï¼šå†™å…¥æ“ä½œï¼Œä¾èµ–ä¸»é”®å’Œå¤åˆç´¢å¼•

3. **äº¤æ˜“æµæ°´è®°å½•** `AccountTransactionMapper.insert`
   - è§¦å‘ï¼šæ¯æ¬¡ä½™é¢å˜åŠ¨ï¼ˆä¸ä½™é¢æ›´æ–°åŒæ­¥ï¼‰
   - é¢‘ç‡ï¼š**22æ¬¡/ç§’**
   - ç´¢å¼•ï¼šå†™å…¥æ“ä½œï¼Œä¾èµ–ä¸»é”®

4. **è½®æ¬¡æŠ•æ³¨é¢æ›´æ–°** `TradingRoundMapper.updateBetAmounts`
   - è§¦å‘ï¼šæ¯æ¬¡ä¸‹å•åæ›´æ–°è½®æ¬¡ç»Ÿè®¡
   - é¢‘ç‡ï¼š**17æ¬¡/ç§’**
   - ç´¢å¼•ï¼šPRIMARY KEY (id)

#### ğŸŸ¡ é«˜é¢‘æ“ä½œ (æ¯ç§’1-10æ¬¡)

**è¯»æ“ä½œ (SELECT)**

1. **é£æ§ç»Ÿè®¡æŸ¥è¯¢** `UserRiskStatsMapper.selectByUserIdAndAccountType`
   - è§¦å‘ï¼šæ¯æ¬¡ä¸‹å•å‰çš„é£æ§æ£€æŸ¥
   - é¢‘ç‡ï¼š17æ¬¡/ç§’
   ```sql
   SELECT today_order_count, today_order_amount, week_order_count, week_order_amount,
          month_order_count, month_order_amount, total_order_count, total_order_amount,
          today_win_count, today_loss_count, today_profit,
          week_win_count, week_loss_count, week_profit,
          month_win_count, month_loss_count, month_profit
   FROM user_risk_stats 
   WHERE user_id = ? AND account_type = ?
   ```
   - ç´¢å¼•ï¼šidx_user_risk_stats_user_account

**å†™æ“ä½œ (INSERT/UPDATE/DELETE)**

1. **ç”¨æˆ·é£æ§ç»Ÿè®¡æ›´æ–°** `UserRiskStatsMapper.incrementOrderStats`
   - è§¦å‘ï¼šä¸‹å•æ—¶æ›´æ–°ç»Ÿè®¡ã€ç»“ç®—æ—¶æ›´æ–°ç»Ÿè®¡
   - é¢‘ç‡ï¼šä¸‹å•(17æ¬¡/ç§’) + ç»“ç®—(3.3æ¬¡/ç§’) = **20æ¬¡/ç§’**
   - ç´¢å¼•ï¼šPRIMARY KEY (id)

2. **è®¢å•çŠ¶æ€æ›´æ–°** `OrderMapper.updateStatus`
   - è§¦å‘ï¼šè®¢å•çŠ¶æ€å˜æ›´ï¼ˆPENDING->ACTIVE->WIN/LOSEï¼‰
   - é¢‘ç‡ï¼šçŠ¶æ€å˜æ›´çº¦**10æ¬¡/ç§’**
   - ç´¢å¼•ï¼šPRIMARY KEY (id)

3. **è®¢å•å¯¹å†²è®°å½•åˆ›å»º** `OrderHedgeMapper.insert`
   - è§¦å‘ï¼šREALè´¦æˆ·è®¢å•åˆ›å»ºæ—¶
   - é¢‘ç‡ï¼šREALè´¦æˆ·è®¢å•çº¦8.5æ¬¡/ç§’ï¼ˆå‡è®¾50%ä¸ºREALè´¦æˆ·ï¼‰
   - ç´¢å¼•ï¼šå†™å…¥æ“ä½œï¼Œorder_idç´¢å¼•

4. **è®¢å•å¯¹å†²çŠ¶æ€æ›´æ–°** `OrderHedgeMapper.updateHedgeStatus`
   - è§¦å‘ï¼šREALè´¦æˆ·è®¢å•å¯¹å†²æ“ä½œå®Œæˆå
   - é¢‘ç‡ï¼šREALè´¦æˆ·è®¢å•çº¦**8.5æ¬¡/ç§’**
   - ç´¢å¼•ï¼šidx_order_hedge_order_id

#### ğŸŸ  ä¸­é¢‘æŸ¥è¯¢ (æ¯åˆ†é’Ÿ1-60æ¬¡)

1. **è½®æ¬¡ç»“ç®—æŸ¥è¯¢** `OrderMapper.findPendingOrdersByRound`
   - è§¦å‘ï¼šæ¯5åˆ†é’Ÿç»“ç®—ä¸€æ¬¡
   - é¢‘ç‡ï¼š12è½®/å°æ—¶ = **0.2æ¬¡/åˆ†é’Ÿ**ï¼ˆä½†æŸ¥è¯¢è¿”å›å¤§é‡æ•°æ®ï¼‰
   - ç´¢å¼•ï¼šidx_option_order_round_status

2. **è½®æ¬¡çŠ¶æ€æ›´æ–°** `TradingRoundMapper.updateStatus`
   - è§¦å‘ï¼šè½®æ¬¡é”å®šã€ç»“ç®—
   - é¢‘ç‡ï¼š12è½®/å°æ—¶ Ã— 2æ¬¡ = **0.4æ¬¡/åˆ†é’Ÿ**
   - ç´¢å¼•ï¼šPRIMARY KEY (id)

3. **BTSEè½¬è´¦è¶…æ—¶å¤„ç†** `BtseTransferLogMapper.findTimeoutPendingTransfers`
   - è§¦å‘ï¼šæ¯5ç§’æ‰§è¡Œä¸€æ¬¡
   - é¢‘ç‡ï¼š**12æ¬¡/åˆ†é’Ÿ**
   - ç´¢å¼•ï¼šidx_btse_transfer_timeout

4. **é»‘åå•æ£€æŸ¥** `BlacklistMapper.findByUserId`
   - è§¦å‘ï¼šæ¯æ¬¡ä¸‹å•å‰
   - é¢‘ç‡ï¼š1000æ¬¡/åˆ†é’Ÿ = **17æ¬¡/ç§’**ï¼ˆåº”å½’ç±»ä¸ºé«˜é¢‘ï¼‰
   - ç´¢å¼•ï¼šidx_blacklist_user_status_time

5. **å¤±è´¥å¯¹å†²è¡¥å¿æŸ¥è¯¢** `OrderHedgeMapper.findFailedHedges`
   - è§¦å‘ï¼šæ¯5ç§’æ‰§è¡Œä¸€æ¬¡è¡¥å¿ä»»åŠ¡
   - é¢‘ç‡ï¼š**12æ¬¡/åˆ†é’Ÿ**
   - ç´¢å¼•ï¼šidx_order_hedge_status_retry

#### ğŸŸ¢ ä½é¢‘æŸ¥è¯¢ (æ¯å°æ—¶1-60æ¬¡)

1. **ç”¨æˆ·ç»Ÿè®¡** `UserMapper.findByCreateTimeBetween`
   - è§¦å‘ï¼šåå°ç»Ÿè®¡ä»»åŠ¡
   - é¢‘ç‡ï¼š**æ¯å°æ—¶1æ¬¡**
   - ç´¢å¼•ï¼šidx_user_create_time

2. **é£æ§æ—¥å¿—è®°å½•** `RiskLogMapper.insert`
   - è§¦å‘ï¼šè§¦å‘é£æ§è§„åˆ™æ—¶
   - é¢‘ç‡ï¼šçº¦**10-20æ¬¡/å°æ—¶**
   - ç´¢å¼•ï¼šå†™å…¥æ“ä½œ

3. **é…ç½®æŸ¥è¯¢** `GlobalConfigMapper.findByKey`
   - è§¦å‘ï¼šç³»ç»Ÿåˆå§‹åŒ–ã€é…ç½®åˆ·æ–°
   - é¢‘ç‡ï¼š**ç¼“å­˜å‘½ä¸­ç‡99%ï¼Œå®é™…æŸ¥è¯¢<1æ¬¡/åˆ†é’Ÿ**
   - ç´¢å¼•ï¼šuk_config_key

4. **é£æ§ç»Ÿè®¡é‡ç½®æŸ¥è¯¢** `UserRiskStatsMapper.selectNeedResetRecords`
   - è§¦å‘ï¼šå®šæ—¶ä»»åŠ¡æ£€æŸ¥éœ€è¦é‡ç½®çš„ç»Ÿè®¡è®°å½•
   - é¢‘ç‡ï¼š**æ¯å°æ—¶4æ¬¡**ï¼ˆæ¯15åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
   - ç´¢å¼•ï¼šidx_user_risk_stats_update_time

5. **æ‰¹é‡é‡ç½®é£æ§ç»Ÿè®¡** `UserRiskStatsMapper.batchReset*Stats`
   - è§¦å‘ï¼šå®šæ—¶ä»»åŠ¡æ‰¹é‡é‡ç½®è¿‡æœŸç»Ÿè®¡æ•°æ®
   - é¢‘ç‡ï¼š**æ¯å¤©3-4æ¬¡**ï¼ˆæ—¥é‡ç½®1æ¬¡ï¼Œå‘¨é‡ç½®å¶å°”ï¼Œæœˆé‡ç½®å¶å°”ï¼‰
   - ç´¢å¼•ï¼šPRIMARY KEY (id)

### ä¸åŒç”¨æˆ·è§„æ¨¡ä¸‹çš„æ“ä½œé‡å¯¹æ¯”ï¼ˆè¯»+å†™ï¼‰

| æ“ä½œç±»å‹ | æ“ä½œåˆ†ç±» | 100ç”¨æˆ·/ç§’ | 500ç”¨æˆ·/ç§’ | 1000ç”¨æˆ·/ç§’ |
|---------|---------|-----------|-----------|------------|
| **è¯»æ“ä½œ (SELECT)** |  |  |  |  |
| è´¦æˆ·æŸ¥è¯¢ | é«˜é¢‘è¯» | 5.9 | 29.5 | 59 |
| è®¢å•åˆ—è¡¨æŸ¥è¯¢ | é«˜é¢‘è¯» | 4.2 | 21 | 42 |
| å½“å‰è½®æ¬¡æŸ¥è¯¢ | é«˜é¢‘è¯» | 1.7 | 8.5 | 17 |
| é£æ§ç»Ÿè®¡æŸ¥è¯¢ | é«˜é¢‘è¯» | 1.7 | 8.5 | 17 |
| **å†™æ“ä½œ (INSERT/UPDATE/DELETE)** |  |  |  |  |
| ä½™é¢åŸå­æ›´æ–° | è¶…é«˜é¢‘å†™ | 2.2 | 11 | 22 |
| è®¢å•åˆ›å»º | è¶…é«˜é¢‘å†™ | 1.7 | 8.5 | 17 |
| äº¤æ˜“æµæ°´è®°å½• | è¶…é«˜é¢‘å†™ | 2.2 | 11 | 22 |
| è½®æ¬¡æŠ•æ³¨é¢æ›´æ–° | è¶…é«˜é¢‘å†™ | 1.7 | 8.5 | 17 |
| é£æ§ç»Ÿè®¡æ›´æ–° | é«˜é¢‘å†™ | 2.0 | 10 | 20 |
| è®¢å•çŠ¶æ€æ›´æ–° | é«˜é¢‘å†™ | 1.0 | 5 | 10 |
| å¯¹å†²è®°å½•åˆ›å»º | é«˜é¢‘å†™ | 0.85 | 4.25 | 8.5 |
| å¯¹å†²çŠ¶æ€æ›´æ–° | é«˜é¢‘å†™ | 0.85 | 4.25 | 8.5 |
| **å°è®¡** |  |  |  |  |
| è¯»æ“ä½œQPS | - | 13.5 | 67.5 | 135 |
| å†™æ“ä½œQPS | - | 12.4 | 62 | 124 |
| **æ€»QPS** | - | **25.9** | **129.5** | **259** |

### é‡è¦æ€§èƒ½æŒ‡æ ‡æ€»ç»“
- **è¯»å†™æ¯”ä¾‹**ï¼šçº¦ 52% è¯»æ“ä½œï¼Œ48% å†™æ“ä½œ
- **å³°å€¼QPS**ï¼š1000ç”¨æˆ·åœºæ™¯ä¸‹çº¦259 QPS
- **å…³é”®ç“¶é¢ˆ**ï¼šä½™é¢åŸå­æ›´æ–°å’Œäº¤æ˜“æµæ°´è®°å½•ï¼ˆå„22 QPSï¼‰
- **ç´¢å¼•ä¼˜åŒ–é‡ç‚¹**ï¼šuser_id, account_type, order_id, round_idç›¸å…³å¤åˆç´¢å¼•
- **åˆ†åº“åˆ†è¡¨å»ºè®®**ï¼šåŸºäºuser_idåˆ†ç‰‡ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•


---
