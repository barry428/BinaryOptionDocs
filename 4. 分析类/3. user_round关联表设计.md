# user_round 关联表设计

## 表结构设计

```sql
-- 用户轮次参与记录表
CREATE TABLE user_round (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    round_id BIGINT NOT NULL,
    account_type VARCHAR(10) NOT NULL,  -- DEMO/REAL
    first_order_time TIMESTAMP NOT NULL,  -- 首次下单时间
    last_settle_time TIMESTAMP,           -- 最后结算时间
    total_orders INTEGER DEFAULT 0,       -- 该轮次订单数
    total_amount DECIMAL(18,8) DEFAULT 0, -- 总投注金额
    net_profit DECIMAL(18,8) DEFAULT 0,   -- 净盈亏
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 联合唯一索引，保证用户在同一轮次同一账户类型只有一条记录
    UNIQUE(user_id, round_id, account_type)
);

-- 主要查询索引
CREATE INDEX idx_user_round_query ON user_round(user_id, account_type, last_settle_time DESC);

-- 轮次查询索引
CREATE INDEX idx_round_users ON user_round(round_id, account_type);
```

## 业务逻辑

### 1. 记录时机
- **创建时机**: 用户首次在某轮次下单时创建记录
- **更新时机**: 轮次结算时更新统计信息

### 2. 核心字段说明
- `first_order_time`: 用户在该轮次的首次下单时间
- `last_settle_time`: 该轮次最后结算时间（用于排序分页）
- `total_orders`: 用户在该轮次的订单总数
- `total_amount`: 用户在该轮次的总投注金额
- `net_profit`: 用户在该轮次的净盈亏

### 3. 查询优化
```sql
-- 原来的复杂查询（性能差）
SELECT DISTINCT round_id FROM option_order 
WHERE user_id = ? AND account_type = ? AND status IN ('WIN', 'LOSE')
GROUP BY round_id ORDER BY MAX(settle_time) DESC 
LIMIT ? OFFSET ?

-- 新的高效查询（性能优）
SELECT round_id FROM user_round 
WHERE user_id = ? AND account_type = ? AND last_settle_time IS NOT NULL
ORDER BY last_settle_time DESC 
LIMIT ? OFFSET ?
```

## 性能优势

1. **直接索引查询**: `idx_user_round_query(user_id, account_type, last_settle_time DESC)` 完美覆盖查询
2. **避免GROUP BY**: 不需要对大量订单记录进行分组聚合
3. **减少数据扫描**: 用户参与的轮次数量远小于订单数量
4. **支持高效分页**: 基于last_settle_time的直接排序分页

## 数据量对比
假设用户有1000个订单分布在50个轮次：
- **原方案**: 扫描1000条订单记录，执行GROUP BY
- **新方案**: 直接查询50条user_round记录，基于索引排序

性能提升预期：**10-20倍**