# äºŒå…ƒæœŸæƒå¹³å° SQLä¼˜åŒ–å’Œç´¢å¼•è®¾è®¡

## æ–‡æ¡£æ¦‚è¿°
åŸºäºSQLæŸ¥è¯¢æ•´ç†æ–‡æ¡£ä¸­çš„æŸ¥è¯¢æ¨¡å¼ï¼Œæœ¬æ–‡æ¡£æä¾›å…·ä½“çš„æ€§èƒ½ä¼˜åŒ–å»ºè®®å’Œç´¢å¼•è®¾è®¡æ–¹æ¡ˆã€‚

## ç´¢å¼•è®¾è®¡ç­–ç•¥

### 1. è¶…é«˜é¢‘æŸ¥è¯¢ä¼˜åŒ– (æ¯ç§’æ•°ç™¾æ¬¡)

#### 1.1 accountè¡¨ç´¢å¼•ä¼˜åŒ–
```sql
-- å¤åˆæŸ¥è¯¢ç´¢å¼• (user_id + account_type + currency)
CREATE INDEX idx_account_user_type_currency ON account (user_id, account_type, currency);

-- è´¦æˆ·ç±»å‹ç»Ÿè®¡ç´¢å¼•
CREATE INDEX idx_account_type_for_stats ON account (account_type, total_deposit, total_withdraw, balance, frozen_balance, total_profit, total_loss);

-- è¦†ç›–ç´¢å¼• (åŒ…å«å¸¸ç”¨æŸ¥è¯¢å­—æ®µ)
CREATE INDEX idx_account_covering ON account (user_id, account_type, currency) 
INCLUDE (id, balance, frozen_balance, total_deposit, total_withdraw, total_profit, total_loss);
```

#### 1.2 trading_roundè¡¨ç´¢å¼•ä¼˜åŒ–
```sql
-- å½“å‰è½®æ¬¡æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_trading_round_current ON trading_round (symbol_id, duration_minutes, status, start_time, end_time);

-- ç»“ç®—æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_trading_round_settlement ON trading_round (status, end_time);

-- è½®æ¬¡ç»´æŠ¤ç´¢å¼•
CREATE INDEX idx_trading_round_maintenance ON trading_round (status, lock_time);

-- å¤åˆå”¯ä¸€ç´¢å¼• (é˜²æ­¢é‡å¤è½®æ¬¡)
CREATE UNIQUE INDEX uk_trading_round_key ON trading_round (symbol_id, start_time, duration_minutes);
```

#### 1.3 option_orderè¡¨ç´¢å¼•ä¼˜åŒ–
```sql
-- ç”¨æˆ·è®¢å•åˆ—è¡¨ç´¢å¼•
CREATE INDEX idx_order_user_type_time ON option_order (user_id, account_type, create_time DESC);

-- è½®æ¬¡ç»“ç®—ç´¢å¼•
CREATE INDEX idx_order_round_status ON option_order (round_id, status);

-- è®¢å•çŠ¶æ€ç´¢å¼•
CREATE INDEX idx_order_status_time ON option_order (status, create_time);

-- è¦†ç›–ç´¢å¼• (ç”¨æˆ·è®¢å•æŸ¥è¯¢)
CREATE INDEX idx_order_user_covering ON option_order (user_id, account_type, create_time DESC) 
INCLUDE (id, symbol_id, round_id, direction, amount, odds, expected_profit, status, profit, fee);
```

### 2. é«˜é¢‘æŸ¥è¯¢ä¼˜åŒ– (æ¯åˆ†é’Ÿæ•°åæ¬¡)

#### 2.1 btse_transfer_logè¡¨ç´¢å¼•ä¼˜åŒ–
```sql
-- è¶…æ—¶å¤„ç†æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_btse_transfer_timeout ON btse_transfer_log (direction, status, create_time);

-- è®¢å•è½¬è´¦è®°å½•ç´¢å¼•
CREATE INDEX idx_btse_transfer_order ON btse_transfer_log (order_id, direction, status, create_time DESC);

-- ç”¨æˆ·è½¬è´¦è®°å½•ç´¢å¼•
CREATE INDEX idx_btse_transfer_user ON btse_transfer_log (user_id, direction, status, create_time DESC);
```

#### 2.2 account_transactionè¡¨ç´¢å¼•ä¼˜åŒ–
```sql
-- ç”¨æˆ·æµæ°´åˆ†é¡µç´¢å¼•
CREATE INDEX idx_transaction_user_time ON account_transaction (user_id, create_time DESC);

-- è´¦æˆ·ç±»å‹æµæ°´ç´¢å¼• (æ”¯æŒJOINæŸ¥è¯¢)
CREATE INDEX idx_transaction_account_time ON account_transaction (account_id, create_time DESC);

-- ç±»å‹èšåˆç´¢å¼•
CREATE INDEX idx_transaction_type_amount ON account_transaction (type, amount, frozen_amount);
```

### 3. ä¸­é¢‘æŸ¥è¯¢ä¼˜åŒ– (æ¯å°æ—¶æ•°æ¬¡)

#### 3.1 é£æ§ç›¸å…³ç´¢å¼•
```sql
-- é»‘åå•æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_blacklist_user_status_time ON blacklist (user_id, status, start_time, end_time);

-- é£æ§æ—¥å¿—æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_risk_log_user_time ON risk_log (user_id, create_time DESC);
CREATE INDEX idx_risk_log_type_time ON risk_log (risk_type, create_time DESC);
CREATE INDEX idx_risk_log_action_time ON risk_log (action_taken, create_time DESC);
CREATE INDEX idx_risk_log_time_range ON risk_log (create_time DESC);

-- é£æ§é…ç½®ç´¢å¼•
CREATE UNIQUE INDEX uk_risk_config_key ON risk_config (config_key);
CREATE INDEX idx_risk_config_type_enabled ON risk_config (config_type, enabled);
```

#### 3.2 å…¨å±€é…ç½®å’Œäº¤æ˜“å¯¹ç´¢å¼•
```sql
-- å…¨å±€é…ç½®ç´¢å¼•
CREATE UNIQUE INDEX uk_global_config_key ON global_config (config_key);
CREATE INDEX idx_global_config_enabled ON global_config (enabled, config_group);

-- äº¤æ˜“å¯¹é…ç½®ç´¢å¼•
CREATE UNIQUE INDEX uk_symbol_config_symbol ON symbol_config (symbol);
CREATE INDEX idx_symbol_config_enabled ON symbol_config (enabled, sort_order);
```

#### 3.3 ç”¨æˆ·ç®¡ç†ç´¢å¼•
```sql
-- OAuthè®¤è¯ç´¢å¼•
CREATE UNIQUE INDEX uk_user_external_id ON "user" (external_id);

-- æ—¶é—´èŒƒå›´ç»Ÿè®¡ç´¢å¼•
CREATE INDEX idx_user_create_time ON "user" (create_time DESC);
CREATE INDEX idx_user_status_time ON "user" (status, create_time DESC);
```

## æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

### 1. è¶…é«˜é¢‘æŸ¥è¯¢ä¼˜åŒ–

#### é—®é¢˜ï¼šaccountè¡¨å¤šSUMèšåˆæŸ¥è¯¢
```sql
-- åŸå§‹æŸ¥è¯¢ (æ€§èƒ½é—®é¢˜)
SELECT COALESCE(SUM(total_deposit) - SUM(total_withdraw) - SUM(balance) - SUM(frozen_balance) + SUM(total_profit) - SUM(total_loss), 0) 
FROM account 
WHERE account_type = #{accountType}
```

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
1. **åˆ›å»ºç‰©åŒ–è§†å›¾** (PostgreSQL)
```sql
CREATE MATERIALIZED VIEW account_stats_by_type AS
SELECT 
    account_type,
    SUM(total_deposit) as sum_deposit,
    SUM(total_withdraw) as sum_withdraw,
    SUM(balance) as sum_balance,
    SUM(frozen_balance) as sum_frozen,
    SUM(total_profit) as sum_profit,
    SUM(total_loss) as sum_loss,
    COUNT(*) as account_count
FROM account 
GROUP BY account_type;

-- åˆ›å»ºåˆ·æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION refresh_account_stats()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY account_stats_by_type;
END;
$$ LANGUAGE plpgsql;
```

2. **Redisç¼“å­˜ä¼˜åŒ–**
```java
@Cacheable(value = "accountStats", key = "#accountType", unless = "#result == null")
public BigDecimal getAccountTypeBalance(AccountType accountType) {
    // åŸå§‹æŸ¥è¯¢é€»è¾‘
}
```

#### é—®é¢˜ï¼šå¤æ‚EXISTSå­æŸ¥è¯¢
```sql
-- åŸå§‹æŸ¥è¯¢ (æ€§èƒ½ç“¶é¢ˆ)
SELECT * FROM option_order o 
WHERE o.account_type = 'REAL' 
  AND o.status = 'WIN' 
  AND NOT EXISTS (
    SELECT 1 FROM btse_transfer_log b 
    WHERE b.order_id = o.id 
      AND b.direction = 'OUT' 
      AND b.status = 'SUCCESS'
  )
```

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
1. **LEFT JOINé‡å†™**
```sql
SELECT o.* 
FROM option_order o 
LEFT JOIN btse_transfer_log b ON (b.order_id = o.id AND b.direction = 'OUT' AND b.status = 'SUCCESS')
WHERE o.account_type = 'REAL' 
  AND o.status = 'WIN' 
  AND b.id IS NULL
```

2. **ä¸“ç”¨ç´¢å¼•**
```sql
CREATE INDEX idx_btse_transfer_order_direction_status ON btse_transfer_log (order_id, direction, status);
```

### 2. å†å²æŸ¥è¯¢ä¼˜åŒ– (PostgreSQLçª—å£å‡½æ•°)

#### é—®é¢˜ï¼šå¤æ‚åˆ†ç»„æŸ¥è¯¢
```sql
-- MySQLç‰ˆæœ¬ (æ€§èƒ½è¾ƒå·®)
SELECT DISTINCT round_id 
FROM option_order o 
WHERE o.user_id = #{userId} 
  AND o.status IN ('WIN', 'LOSE') 
GROUP BY round_id 
ORDER BY MAX(o.settle_time) DESC
```

**PostgreSQLä¼˜åŒ–ç‰ˆæœ¬å·²å®ç°ï¼š**
```sql
SELECT round_id 
FROM (
  SELECT round_id, 
         ROW_NUMBER() OVER (PARTITION BY round_id ORDER BY settle_time DESC) as rn,
         MAX(settle_time) OVER (PARTITION BY round_id) as max_settle_time
  FROM option_order 
  WHERE user_id = #{userId} 
    AND status IN ('WIN', 'LOSE')
) t 
WHERE rn = 1 
ORDER BY max_settle_time DESC
```

**é…å¥—ç´¢å¼•ï¼š**
```sql
CREATE INDEX idx_order_user_status_settle ON option_order (user_id, status, settle_time DESC);
```

### 3. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

#### æ·±åº¦åˆ†é¡µé—®é¢˜
**é—®é¢˜è¯†åˆ«ï¼š**
- `LIMIT #{limit} OFFSET #{offset}` åœ¨å¤§æ•°æ®é‡æ—¶æ€§èƒ½æ€¥å‰§ä¸‹é™
- OFFSETè¶Šå¤§ï¼Œæ‰«æè¡Œæ•°è¶Šå¤š

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
1. **æ¸¸æ ‡åˆ†é¡µ (Cursor Pagination)**
```sql
-- æ›¿ä»£ OFFSET åˆ†é¡µ
SELECT * FROM option_order 
WHERE user_id = #{userId} 
  AND create_time < #{lastCreateTime}  -- æ¸¸æ ‡æ¡ä»¶
ORDER BY create_time DESC 
LIMIT #{limit}
```

2. **IDèŒƒå›´åˆ†é¡µ**
```sql
-- åŸºäºIDçš„åˆ†é¡µ
SELECT * FROM option_order 
WHERE user_id = #{userId} 
  AND id < #{lastId}  -- æ¸¸æ ‡æ¡ä»¶
ORDER BY id DESC 
LIMIT #{limit}
```

## æ•°æ®åº“ç‰¹å®šä¼˜åŒ–

### MySQLä¼˜åŒ–é…ç½®
```sql
-- æŸ¥è¯¢ç¼“å­˜ (é€‚ç”¨äºè¯»å¤šå†™å°‘åœºæ™¯)
SET GLOBAL query_cache_type = ON;
SET GLOBAL query_cache_size = 268435456; -- 256MB

-- InnoDBä¼˜åŒ–
SET GLOBAL innodb_buffer_pool_size = 1073741824; -- 1GB
SET GLOBAL innodb_log_file_size = 268435456; -- 256MB

-- æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = ON;
SET GLOBAL long_query_time = 0.1; -- 100ms
```

### PostgreSQLä¼˜åŒ–é…ç½®
```sql
-- å…±äº«ç¼“å†²åŒº
ALTER SYSTEM SET shared_buffers = '256MB';

-- å·¥ä½œå†…å­˜
ALTER SYSTEM SET work_mem = '4MB';

-- ç»´æŠ¤å·¥ä½œå†…å­˜
ALTER SYSTEM SET maintenance_work_mem = '64MB';

-- ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
ALTER SYSTEM SET default_statistics_target = 100;

-- é¢„å†™æ—¥å¿—
ALTER SYSTEM SET wal_buffers = '16MB';
```

## å…³é”®è¡¨ç´¢å¼•DDL

### æ ¸å¿ƒä¸šåŠ¡è¡¨ç´¢å¼•
```sql
-- ======================
-- account è¡¨ç´¢å¼• (æ ¸å¿ƒ)
-- ======================
ALTER TABLE account ADD PRIMARY KEY (id);
CREATE UNIQUE INDEX uk_account_user_type_currency ON account (user_id, account_type, currency);
CREATE INDEX idx_account_user_id ON account (user_id);
CREATE INDEX idx_account_type ON account (account_type);
CREATE INDEX idx_account_balance ON account (balance) WHERE balance > 0;
CREATE INDEX idx_account_update_time ON account (update_time DESC);

-- ======================
-- option_order è¡¨ç´¢å¼• (æ ¸å¿ƒ)
-- ======================
ALTER TABLE option_order ADD PRIMARY KEY (id);
CREATE INDEX idx_order_user_account_time ON option_order (user_id, account_type, create_time DESC);
CREATE INDEX idx_order_round_status ON option_order (round_id, status);
CREATE INDEX idx_order_status_time ON option_order (status, create_time DESC);
CREATE INDEX idx_order_settle_time ON option_order (settle_time DESC) WHERE settle_time IS NOT NULL;
CREATE INDEX idx_order_user_profit ON option_order (user_id, account_type, profit) WHERE profit IS NOT NULL;
CREATE INDEX idx_order_time_range ON option_order (user_id, account_type, create_time);

-- ======================
-- trading_round è¡¨ç´¢å¼• (é«˜é¢‘)
-- ======================
ALTER TABLE trading_round ADD PRIMARY KEY (id);
CREATE UNIQUE INDEX uk_trading_round_no ON trading_round (round_no);
CREATE UNIQUE INDEX uk_trading_round_symbol_time ON trading_round (symbol_id, start_time, duration_minutes);
CREATE INDEX idx_trading_round_current ON trading_round (symbol_id, duration_minutes, status, start_time, end_time);
CREATE INDEX idx_trading_round_settlement ON trading_round (status, end_time);
CREATE INDEX idx_trading_round_lock ON trading_round (status, lock_time);

-- ======================
-- account_transaction è¡¨ç´¢å¼•
-- ======================
ALTER TABLE account_transaction ADD PRIMARY KEY (id);
CREATE INDEX idx_transaction_user_time ON account_transaction (user_id, create_time DESC);
CREATE INDEX idx_transaction_account_time ON account_transaction (account_id, create_time DESC);
CREATE INDEX idx_transaction_type ON account_transaction (type);
CREATE INDEX idx_transaction_ref ON account_transaction (ref_type, ref_id);

-- ======================
-- btse_transfer_log è¡¨ç´¢å¼•
-- ======================
ALTER TABLE btse_transfer_log ADD PRIMARY KEY (id);
CREATE INDEX idx_btse_transfer_timeout ON btse_transfer_log (direction, status, create_time);
CREATE INDEX idx_btse_transfer_order ON btse_transfer_log (order_id, direction, status, create_time DESC);
CREATE INDEX idx_btse_transfer_user ON btse_transfer_log (user_id, direction, create_time DESC);
CREATE INDEX idx_btse_transfer_id ON btse_transfer_log (transfer_id);
CREATE INDEX idx_btse_transfer_trace ON btse_transfer_log (trace_id);
```

### é£æ§å’Œé…ç½®è¡¨ç´¢å¼•
```sql
-- ======================
-- blacklist è¡¨ç´¢å¼•
-- ======================
ALTER TABLE blacklist ADD PRIMARY KEY (id);
CREATE INDEX idx_blacklist_user_status_time ON blacklist (user_id, status, start_time, end_time);
CREATE INDEX idx_blacklist_time_range ON blacklist (start_time, end_time);

-- ======================
-- risk_log è¡¨ç´¢å¼•
-- ======================
ALTER TABLE risk_log ADD PRIMARY KEY (id);
CREATE INDEX idx_risk_log_user_time ON risk_log (user_id, create_time DESC);
CREATE INDEX idx_risk_log_order ON risk_log (order_id, create_time DESC);
CREATE INDEX idx_risk_log_type_time ON risk_log (risk_type, create_time DESC);
CREATE INDEX idx_risk_log_action_time ON risk_log (action_taken, create_time DESC);
CREATE INDEX idx_risk_log_time_range ON risk_log (create_time DESC);

-- ======================
-- risk_config è¡¨ç´¢å¼•
-- ======================
ALTER TABLE risk_config ADD PRIMARY KEY (id);
CREATE UNIQUE INDEX uk_risk_config_key ON risk_config (config_key);
CREATE INDEX idx_risk_config_type_enabled ON risk_config (config_type, enabled);

-- ======================
-- global_config è¡¨ç´¢å¼•
-- ======================
ALTER TABLE global_config ADD PRIMARY KEY (id);
CREATE UNIQUE INDEX uk_global_config_key ON global_config (config_key);
CREATE INDEX idx_global_config_enabled ON global_config (enabled, config_group);

-- ======================
-- symbol_config è¡¨ç´¢å¼•
-- ======================
ALTER TABLE symbol_config ADD PRIMARY KEY (id);
CREATE UNIQUE INDEX uk_symbol_config_symbol ON symbol_config (symbol);
CREATE INDEX idx_symbol_config_enabled ON symbol_config (enabled, sort_order);

-- ======================
-- user è¡¨ç´¢å¼•
-- ======================
ALTER TABLE "user" ADD PRIMARY KEY (id);
CREATE UNIQUE INDEX uk_user_external_id ON "user" (external_id);
CREATE INDEX idx_user_create_time ON "user" (create_time DESC);
CREATE INDEX idx_user_status ON "user" (status);
```

## æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ‰¹é‡æ“ä½œä¼˜åŒ–

#### æ‰¹é‡æ’å…¥ä¼˜åŒ–
```sql
-- é£æ§æ—¥å¿—æ‰¹é‡æ’å…¥ (å·²å®ç°)
INSERT INTO risk_log (user_id, order_id, risk_type, ...) VALUES
  (?, ?, ?, ...),
  (?, ?, ?, ...),
  (?, ?, ?, ...);
```

**å»ºè®®ï¼š**
- æ‰¹é‡å¤§å°æ§åˆ¶åœ¨500-1000æ¡
- ä½¿ç”¨äº‹åŠ¡åŒ…è£…æ‰¹é‡æ“ä½œ
- è€ƒè™‘ä½¿ç”¨LOAD DATA INFILE (MySQL) æˆ– COPY (PostgreSQL)

### 2. æ—¶é—´èŒƒå›´æŸ¥è¯¢ä¼˜åŒ–

#### åˆ†åŒºè¡¨ç­–ç•¥ (å¤§æ•°æ®é‡åœºæ™¯)
```sql
-- account_transaction æŒ‰æœˆåˆ†åŒº (PostgreSQL)
CREATE TABLE account_transaction (
    id BIGSERIAL,
    user_id BIGINT NOT NULL,
    create_time TIMESTAMP NOT NULL,
    ...
) PARTITION BY RANGE (create_time);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE account_transaction_202501 PARTITION OF account_transaction
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE account_transaction_202502 PARTITION OF account_transaction
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
```

#### æ—¶é—´èŒƒå›´æŸ¥è¯¢ç´¢å¼•ç­–ç•¥
```sql
-- åŸºäºæ—¶é—´çš„å¤åˆç´¢å¼• (è¦†ç›–æŸ¥è¯¢æ¡ä»¶)
CREATE INDEX idx_order_user_time_status ON option_order (user_id, create_time, status);
CREATE INDEX idx_transaction_time_type ON account_transaction (create_time, type);
```

### 3. èšåˆæŸ¥è¯¢ä¼˜åŒ–

#### ç»Ÿè®¡è¡¨ç­–ç•¥
```sql
-- åˆ›å»ºæ¯æ—¥ç»Ÿè®¡è¡¨
CREATE TABLE daily_order_stats (
    stat_date DATE PRIMARY KEY,
    account_type VARCHAR(10) NOT NULL,
    total_orders BIGINT DEFAULT 0,
    total_amount DECIMAL(20,8) DEFAULT 0,
    total_profit DECIMAL(20,8) DEFAULT 0,
    win_orders BIGINT DEFAULT 0,
    lose_orders BIGINT DEFAULT 0,
    win_rate DECIMAL(5,4) DEFAULT 0,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_daily_stats_type_date ON daily_order_stats (account_type, stat_date DESC);
```

#### å¢é‡ç»Ÿè®¡æ›´æ–°
```java
// è§¦å‘å™¨æˆ–å®šæ—¶ä»»åŠ¡æ›´æ–°ç»Ÿè®¡
@Scheduled(cron = "0 1 0 * * ?") // æ¯å¤©å‡Œæ™¨1ç‚¹
public void updateDailyStats() {
    // è®¡ç®—æ˜¨æ—¥ç»Ÿè®¡æ•°æ®
    // æ›´æ–°daily_order_statsè¡¨
}
```

## æ•°æ®åº“ç‰ˆæœ¬å·®å¼‚ä¼˜åŒ–

### MySQLä¸“ç”¨ä¼˜åŒ–
```sql
-- åˆ†åŒºè¡¨ (åŸºäºæ—¶é—´)
ALTER TABLE account_transaction 
PARTITION BY RANGE (YEAR(create_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- å…¨æ–‡ç´¢å¼• (æè¿°å­—æ®µ)
ALTER TABLE risk_log ADD FULLTEXT(description);
```

### PostgreSQLä¸“ç”¨ä¼˜åŒ–
```sql
-- éƒ¨åˆ†ç´¢å¼• (æ¡ä»¶ç´¢å¼•)
CREATE INDEX idx_order_active ON option_order (user_id, create_time DESC) 
WHERE status = 'ACTIVE';

CREATE INDEX idx_account_positive_balance ON account (user_id, account_type) 
WHERE balance > 0;

-- è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_user_lower_email ON "user" (LOWER(email));

-- GINç´¢å¼• (JSONå­—æ®µï¼Œå¦‚æœæœ‰)
CREATE INDEX idx_transfer_request_data ON btse_transfer_log USING GIN (request_data);
```

## ç›‘æ§å’Œç»´æŠ¤å»ºè®®

### 1. æ€§èƒ½ç›‘æ§
```sql
-- MySQLæ…¢æŸ¥è¯¢ç›‘æ§
SELECT 
    query_time,
    lock_time,
    rows_examined,
    rows_sent,
    sql_text
FROM mysql.slow_log 
WHERE start_time > DATE_SUB(NOW(), INTERVAL 1 DAY)
ORDER BY query_time DESC;

-- PostgreSQLæ…¢æŸ¥è¯¢ç›‘æ§
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    max_time
FROM pg_stat_statements 
WHERE total_time > 1000  -- è¶…è¿‡1ç§’çš„æŸ¥è¯¢
ORDER BY total_time DESC;
```

### 2. ç´¢å¼•ç»´æŠ¤
```sql
-- MySQLç´¢å¼•ä½¿ç”¨ç‡æ£€æŸ¥
SELECT 
    TABLE_NAME,
    INDEX_NAME,
    CARDINALITY,
    SEQ_IN_INDEX,
    COLUMN_NAME
FROM information_schema.STATISTICS 
WHERE TABLE_SCHEMA = 'binary_option'
ORDER BY TABLE_NAME, INDEX_NAME;

-- PostgreSQLç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_tup_read > 0
ORDER BY idx_tup_read DESC;
```

### 3. å®šæœŸç»´æŠ¤ä»»åŠ¡
```sql
-- MySQLè¡¨ä¼˜åŒ–
OPTIMIZE TABLE account, option_order, trading_round;

-- PostgreSQLç»Ÿè®¡ä¿¡æ¯æ›´æ–°
ANALYZE account;
ANALYZE option_order;
ANALYZE trading_round;

-- é‡å»ºç´¢å¼• (å¿…è¦æ—¶)
REINDEX INDEX idx_order_user_account_time;
```

## ç¼“å­˜ç­–ç•¥å»ºè®®

### 1. Redisç¼“å­˜å±‚æ¬¡
```yaml
# åº”ç”¨å±‚ç¼“å­˜é…ç½®
cache:
  redis:
    # L1: çƒ­ç‚¹æ•°æ® (1åˆ†é’Ÿ)
    hot-data-ttl: 60
    # L2: é…ç½®æ•°æ® (1å°æ—¶)  
    config-ttl: 3600
    # L3: ç»Ÿè®¡æ•°æ® (5åˆ†é’Ÿ)
    stats-ttl: 300
```

### 2. ç¼“å­˜å¤±æ•ˆç­–ç•¥
```java
@CacheEvict(value = "accountStats", allEntries = true)
public void evictAccountStatsCache() {
    // è´¦æˆ·æ“ä½œåæ¸…ç†ç¼“å­˜
}

@CachePut(value = "symbolConfig", key = "#symbol")
public SymbolConfig updateSymbolConfig(String symbol, SymbolConfig config) {
    // æ›´æ–°ååˆ·æ–°ç¼“å­˜
}
```

## æ€»ç»“å’Œå®æ–½ä¼˜å…ˆçº§

### ğŸ”´ ç¬¬ä¸€ä¼˜å…ˆçº§ (ç«‹å³å®æ–½)
1. **accountè¡¨å¤åˆç´¢å¼•**: `idx_account_user_type_currency`
2. **option_orderç”¨æˆ·ç´¢å¼•**: `idx_order_user_account_time`
3. **trading_roundå½“å‰è½®æ¬¡ç´¢å¼•**: `idx_trading_round_current`
4. **btse_transfer_logè¶…æ—¶ç´¢å¼•**: `idx_btse_transfer_timeout`

### ğŸŸ¡ ç¬¬äºŒä¼˜å…ˆçº§ (1å‘¨å†…å®æ–½)
1. è¦†ç›–ç´¢å¼•ä¼˜åŒ–é«˜é¢‘æŸ¥è¯¢
2. åˆ†åŒºè¡¨ç­–ç•¥ (å†å²æ•°æ®)
3. ç‰©åŒ–è§†å›¾ (èšåˆæŸ¥è¯¢)
4. Redisç¼“å­˜é›†æˆ

### ğŸŸ¢ ç¬¬ä¸‰ä¼˜å…ˆçº§ (1æœˆå†…å®æ–½)
1. æ·±åº¦åˆ†é¡µæ¸¸æ ‡ä¼˜åŒ–
2. å…¨æ–‡ç´¢å¼• (æœç´¢åŠŸèƒ½)
3. è¡¨è¾¾å¼ç´¢å¼• (PostgreSQL)
4. ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ

### é¢„æœŸæ€§èƒ½æå‡
- **æŸ¥è¯¢å“åº”æ—¶é—´**: å‡å°‘60-80%
- **å¹¶å‘å¤„ç†èƒ½åŠ›**: æå‡3-5å€
- **æ•°æ®åº“CPUä½¿ç”¨ç‡**: é™ä½40-60%
- **ç£ç›˜I/O**: å‡å°‘50-70%

---

*æœ€åæ›´æ–°: 2025-09-01*
*æ–‡æ¡£ç‰ˆæœ¬: v1.0*