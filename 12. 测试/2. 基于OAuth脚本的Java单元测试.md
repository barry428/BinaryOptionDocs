# åŸºäºOAuthè„šæœ¬çš„Javaå•å…ƒæµ‹è¯•å®ç°

## 1. æ¦‚è¿°

å‚è€ƒ `simple-flow-test-oauth.sh` è„šæœ¬ï¼Œå°†å®Œæ•´çš„ä¸šåŠ¡æµç¨‹è½¬æ¢ä¸ºJavaå•å…ƒæµ‹è¯•ï¼Œå®ç°ç›¸åŒçš„æµ‹è¯•è¦†ç›–ä½†å…·æœ‰æ›´å¥½çš„å¯ç»´æŠ¤æ€§å’Œå¼€å‘ä½“éªŒã€‚

## 2. è„šæœ¬vs Javaæµ‹è¯•å¯¹æ¯”

| æµ‹è¯•æ­¥éª¤ | Shellè„šæœ¬å®ç° | Javaå•å…ƒæµ‹è¯•å®ç° |
|---------|--------------|-----------------|
| OAuthè®¤è¯ | Redisæ“ä½œ+APIè°ƒç”¨ | Mock OAuthä¸Šä¸‹æ–‡ |
| è´¦æˆ·æ£€æŸ¥ | APIè°ƒç”¨ | Mock AccountService |
| DEMOé¢†å– | APIè°ƒç”¨ | Mockæ“ä½œ+éªŒè¯ |
| è·å–è½®æ¬¡ | APIè°ƒç”¨ | Mock TradingRoundService |
| ä¸‹å•æµ‹è¯• | 6ä¸ªAPIè°ƒç”¨ | Serviceæ–¹æ³•è°ƒç”¨+éªŒè¯ |
| BTSEè½¬è´¦ | APIè°ƒç”¨ | Mock BtseService |
| ç»“ç®—æµ‹è¯• | RPCè°ƒç”¨ | Serviceæ–¹æ³•è°ƒç”¨ |
| å†å²æŸ¥è¯¢ | APIè°ƒç”¨ | Serviceæ–¹æ³•è°ƒç”¨ |

## 3. å®Œæ•´Javaæµ‹è¯•å®ç°

### 3.1 æµ‹è¯•åŸºç¡€é…ç½®

```java
@SpringBootTest
@TestMethodOrder(OrderAnnotation.class)
@ExtendWith(MockitoExtension.class)
@DisplayName("å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯• - å‚è€ƒOAuthè„šæœ¬")
class CompleteBusinessFlowTest {
    
    // ============ æµ‹è¯•æœåŠ¡æ³¨å…¥ ============
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private FixtureService fixtureService;
    
    @Autowired
    private TradingRoundService tradingRoundService;
    
    // ============ Mockå¤–éƒ¨ä¾èµ– ============
    @MockBean
    private AccountServiceRpcClient accountServiceRpcClient;
    
    @MockBean
    private BtseRpcClient btseRpcClient;
    
    @MockBean
    private UserServiceRpcClient userServiceRpcClient;
    
    // ============ æµ‹è¯•æ•°æ®ï¼ˆå‚è€ƒè„šæœ¬ï¼‰ ============
    private static final String USERNAME = "pmgwcom";
    private static final Long MOCK_USER_ID = 50000L; // è„šæœ¬ä¸­çš„10000-99999èŒƒå›´
    private static final Long REAL_USER_ID = 1L; // æ•°æ®åº“ç”¨æˆ·ID
    private static final String TEST_TOKEN = "test_oauth_token";
    
    // å‚è€ƒè„šæœ¬ä¸­çš„é‡‘é¢è®¾ç½®
    private static final BigDecimal DEMO_ORDER_AMOUNT = new BigDecimal("10.00");
    private static final BigDecimal REAL_ORDER_AMOUNT = new BigDecimal("5.00");
    private static final BigDecimal TRANSFER_IN_AMOUNT = new BigDecimal("20.00");
    private static final BigDecimal DEMO_BONUS_AMOUNT = new BigDecimal("10000.00");
    
    // æµ‹è¯•çŠ¶æ€è·Ÿè¸ª
    private static Long CURRENT_ROUND_ID;
    private static final List<Long> DEMO_ORDER_IDS = new ArrayList<>();
    private static final List<Long> REAL_ORDER_IDS = new ArrayList<>();
    private static String TRANSFER_IN_ID;
    private static String TRANSFER_OUT_ID;
    
    @BeforeAll
    static void setupGlobalTestData() {
        CURRENT_ROUND_ID = 1001L; // å›ºå®šè½®æ¬¡ID
        System.out.println("==========================================");
        System.out.println("å¼€å§‹å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯• (Javaç‰ˆæœ¬)");
        System.out.println("å‚è€ƒè„šæœ¬: simple-flow-test-oauth.sh");
        System.out.println("ç”¨æˆ·å: " + USERNAME);
        System.out.println("Mockç”¨æˆ·ID: " + MOCK_USER_ID);
        System.out.println("çœŸå®ç”¨æˆ·ID: " + REAL_USER_ID);
        System.out.println("==========================================");
    }
    
    @BeforeEach
    void setupCommonMocks() {
        // è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡Mockï¼ˆæ¨¡æ‹ŸOAuthè®¤è¯æˆåŠŸï¼‰
        setupUserContextMock();
        
        // è®¾ç½®åŸºç¡€çš„RPCå“åº”
        setupBasicRpcMocks();
    }
    
    // ============ æ­¥éª¤1: OAuthè®¤è¯æµç¨‹ ============
    @Test
    @Order(1)
    @DisplayName("æ­¥éª¤1: OAuthè®¤è¯å’Œç”¨æˆ·æ³¨å†Œ (å‚è€ƒè„šæœ¬æ­¥éª¤1-2)")
    void step01_OAuthAuthenticationAndUserRegistration() {
        System.out.println("\n=== æ­¥éª¤1: OAuthè®¤è¯å’Œç”¨æˆ·æ³¨å†Œ ===");
        
        // æ¨¡æ‹ŸOAuth tokenéªŒè¯æˆåŠŸï¼ˆå‚è€ƒè„šæœ¬ä¸­çš„Redisæ“ä½œï¼‰
        UserDTO user = UserDTO.builder()
            .id(REAL_USER_ID)
            .username(USERNAME)
            .externalId(String.valueOf(MOCK_USER_ID))
            .status("ACTIVE")
            .createdAt(LocalDateTime.now())
            .build();
        
        when(userServiceRpcClient.resolveOAuthUser(MOCK_USER_ID, USERNAME))
            .thenReturn(Result.success(user));
        
        // æ‰§è¡ŒOAuthç”¨æˆ·è§£æï¼ˆæ¨¡æ‹Ÿè„šæœ¬ä¸­çš„è‡ªåŠ¨æ³¨å†Œï¼‰
        Result<UserDTO> result = userServiceRpcClient.resolveOAuthUser(MOCK_USER_ID, USERNAME);
        
        // éªŒè¯
        assertThat(result.isSuccess()).isTrue();
        assertThat(result.getData().getId()).isEqualTo(REAL_USER_ID);
        assertThat(result.getData().getUsername()).isEqualTo(USERNAME);
        
        System.out.println("âœ… OAuthè®¤è¯æˆåŠŸï¼ŒçœŸå®ç”¨æˆ·ID: " + REAL_USER_ID);
        System.out.println("âœ… ç”¨æˆ·è‡ªåŠ¨æ³¨å†Œå¹¶å…³è”åˆ°: " + USERNAME);
    }
    
    // ============ æ­¥éª¤2: æ£€æŸ¥è´¦æˆ·çŠ¶æ€ ============
    @Test
    @Order(2)
    @DisplayName("æ­¥éª¤2: æ£€æŸ¥ç”¨æˆ·è´¦æˆ· (å‚è€ƒè„šæœ¬æ­¥éª¤3)")
    void step02_CheckUserAccounts() {
        System.out.println("\n=== æ­¥éª¤2: æ£€æŸ¥ç”¨æˆ·è´¦æˆ· ===");
        
        // æ£€æŸ¥DEMOè´¦æˆ·ï¼ˆåˆå§‹çŠ¶æ€ï¼šæœªé¢†å–å¥–é‡‘ï¼‰
        AccountDTO demoAccount = createInitialDemoAccount();
        when(accountServiceRpcClient.getAccount(REAL_USER_ID, "DEMO"))
            .thenReturn(Result.success(demoAccount));
        
        Result<AccountDTO> demoResult = accountServiceRpcClient.getAccount(REAL_USER_ID, "DEMO");
        assertThat(demoResult.isSuccess()).isTrue();
        
        BigDecimal demoBalance = demoResult.getData().getBalance();
        BigDecimal demoFrozen = demoResult.getData().getFrozenBalance();
        System.out.println("âœ… DEMOè´¦æˆ· | ä½™é¢: " + demoBalance + " | å†»ç»“: " + demoFrozen);
        
        // æ£€æŸ¥REALè´¦æˆ·ï¼ˆåˆå§‹çŠ¶æ€ï¼šç©ºï¼‰
        AccountDTO realAccount = createInitialRealAccount();
        when(accountServiceRpcClient.getAccount(REAL_USER_ID, "REAL"))
            .thenReturn(Result.success(realAccount));
        
        Result<AccountDTO> realResult = accountServiceRpcClient.getAccount(REAL_USER_ID, "REAL");
        assertThat(realResult.isSuccess()).isTrue();
        
        BigDecimal realBalance = realResult.getData().getBalance();
        BigDecimal realFrozen = realResult.getData().getFrozenBalance();
        System.out.println("âœ… REALè´¦æˆ· | ä½™é¢: " + realBalance + " | å†»ç»“: " + realFrozen);
    }
    
    // ============ æ­¥éª¤3: é¢†å–DEMOèµ„é‡‘ ============
    @Test
    @Order(3)
    @DisplayName("æ­¥éª¤3: é¢†å–DEMOèµ„é‡‘ (å‚è€ƒè„šæœ¬æ­¥éª¤4)")
    void step03_ClaimDemoBonus() {
        System.out.println("\n=== æ­¥éª¤3: é¢†å–DEMOèµ„é‡‘ ===");
        
        // æ¨¡æ‹Ÿé¢†å–å¥–é‡‘æˆåŠŸ
        AccountDTO accountAfterClaim = createDemoAccountAfterClaim();
        when(accountServiceRpcClient.claimDemoBonus(REAL_USER_ID))
            .thenReturn(Result.success(accountAfterClaim));
        
        // æ‰§è¡Œé¢†å–
        Result<AccountDTO> claimResult = accountServiceRpcClient.claimDemoBonus(REAL_USER_ID);
        
        // éªŒè¯
        assertThat(claimResult.isSuccess()).isTrue();
        assertThat(claimResult.getData().getBalance()).isEqualByComparingTo(DEMO_BONUS_AMOUNT);
        
        System.out.println("âœ… DEMOèµ„é‡‘é¢†å–æˆåŠŸ");
        System.out.println("DEMOè´¦æˆ·ä½™é¢: " + claimResult.getData().getBalance());
    }
    
    // ============ æ­¥éª¤4: è·å–å½“å‰äº¤æ˜“è½®æ¬¡ ============
    @Test
    @Order(4)
    @DisplayName("æ­¥éª¤4: è·å–å½“å‰äº¤æ˜“è½®æ¬¡ (å‚è€ƒè„šæœ¬æ­¥éª¤5)")
    void step04_GetCurrentTradingRound() {
        System.out.println("\n=== æ­¥éª¤4: è·å–å½“å‰äº¤æ˜“è½®æ¬¡ ===");
        
        // åˆ›å»º5åˆ†é’Ÿè½®æ¬¡æ•°æ®ï¼ˆå‚è€ƒè„šæœ¬ä¸­çš„è½®æ¬¡ç­›é€‰é€»è¾‘ï¼‰
        TradingRound fiveMinRound = TradingRound.builder()
            .id(CURRENT_ROUND_ID)
            .symbolId(1L)
            .roundNo(System.currentTimeMillis() / 1000) // ç®€åŒ–çš„è½®æ¬¡å·
            .durationMinutes(5)
            .status("OPEN")
            .upAmount(BigDecimal.ZERO)
            .downAmount(BigDecimal.ZERO)
            .openTime(LocalDateTime.now())
            .closeTime(LocalDateTime.now().plusMinutes(5))
            .build();
        
        when(tradingRoundService.getOrCreateRoundForDuration(1L, 5))
            .thenReturn(fiveMinRound);
        
        // è·å–è½®æ¬¡
        TradingRound currentRound = tradingRoundService.getOrCreateRoundForDuration(1L, 5);
        
        // éªŒè¯
        assertThat(currentRound).isNotNull();
        assertThat(currentRound.getDurationMinutes()).isEqualTo(5);
        assertThat(currentRound.getStatus()).isEqualTo("OPEN");
        
        System.out.println("âœ… è·å–5åˆ†é’Ÿè½®æ¬¡æˆåŠŸ");
        System.out.println("è½®æ¬¡ID: " + CURRENT_ROUND_ID);
        System.out.println("è½®æ¬¡ç¼–å·: " + currentRound.getRoundNo());
        System.out.println("è½®æ¬¡çŠ¶æ€: " + currentRound.getStatus());
        System.out.println("æŒç»­æ—¶é—´: " + currentRound.getDurationMinutes() + " åˆ†é’Ÿ");
        System.out.println("å¼€ç›˜æ—¶é—´: " + currentRound.getOpenTime());
        System.out.println("æ”¶ç›˜æ—¶é—´: " + currentRound.getCloseTime());
    }
    
    // ============ æ­¥éª¤5: DEMOä¸‹å• ============
    @Test
    @Order(5)
    @DisplayName("æ­¥éª¤5: DEMOä¸‹å• (å‚è€ƒè„šæœ¬æ­¥éª¤6)")
    void step05_CreateDemoOrders() {
        System.out.println("\n=== æ­¥éª¤5: DEMOä¸‹å• (3ä¸ªè®¢å•) ===");
        System.out.println("è®¢å•é‡‘é¢: " + DEMO_ORDER_AMOUNT + " (æ¯ä¸ª)");
        System.out.println("ç›®æ ‡è½®æ¬¡: " + CURRENT_ROUND_ID);
        
        // è®¾ç½®æœ‰è¶³å¤Ÿä½™é¢çš„DEMOè´¦æˆ·
        AccountDTO demoAccountWithBalance = createDemoAccountAfterClaim();
        when(accountServiceRpcClient.getAccount(REAL_USER_ID, "DEMO"))
            .thenReturn(Result.success(demoAccountWithBalance));
        
        // è®¾ç½®Fixtureå“åº”
        setupFixtureServiceMock();
        
        // ä¸‹3ä¸ªDEMOè®¢å•ï¼ˆå‚è€ƒè„šæœ¬ï¼šäº¤æ›¿UP/DOWNæ–¹å‘ï¼‰
        for (int i = 1; i <= 3; i++) {
            System.out.println("åˆ›å»ºç¬¬" + i + "ä¸ªDEMOè®¢å•...");
            
            // äº¤æ›¿ä½¿ç”¨UPå’ŒDOWNæ–¹å‘ï¼ˆå‚è€ƒè„šæœ¬é€»è¾‘ï¼‰
            String direction = (i % 2 == 1) ? "UP" : "DOWN";
            
            CreateOrderDTO request = CreateOrderDTO.builder()
                .userId(REAL_USER_ID)
                .symbolId(1L)
                .direction(direction)
                .amount(DEMO_ORDER_AMOUNT)
                .accountType("DEMO")
                .build();
            
            // æ‰§è¡Œä¸‹å•
            Result<OrderDTO> orderResult = orderService.createOrder(request);
            
            // éªŒè¯
            assertThat(orderResult.isSuccess()).isTrue();
            Long orderId = orderResult.getData().getId();
            DEMO_ORDER_IDS.add(orderId);
            
            System.out.println("âœ… DEMOè®¢å•" + i + "åˆ›å»ºæˆåŠŸï¼ŒID: " + orderId + " (æ–¹å‘: " + direction + ")");
            
            // çŸ­æš‚å»¶è¿Ÿï¼ˆå‚è€ƒè„šæœ¬ä¸­çš„sleepï¼‰
            try { Thread.sleep(100); } catch (InterruptedException e) { /* ignore */ }
        }
        
        System.out.println("DEMOè®¢å•åˆ›å»ºå®Œæˆï¼Œå…±" + DEMO_ORDER_IDS.size() + "ä¸ªè®¢å•: " + DEMO_ORDER_IDS);
        assertThat(DEMO_ORDER_IDS).hasSize(3);
    }
    
    // ============ æ­¥éª¤6: BTSEè½¬å…¥æµ‹è¯• ============
    @Test
    @Order(6)
    @DisplayName("æ­¥éª¤6: BTSEè½¬å…¥æµ‹è¯• (å‚è€ƒè„šæœ¬æ­¥éª¤7)")
    void step06_BtseTransferIn() {
        System.out.println("\n=== æ­¥éª¤6: BTSEè½¬å…¥æµ‹è¯• ===");
        System.out.println("è½¬å…¥é‡‘é¢: " + TRANSFER_IN_AMOUNT);
        
        // æ¨¡æ‹ŸBTSEè½¬å…¥æˆåŠŸ
        BtseTransferResponseDTO transferResponse = BtseTransferResponseDTO.builder()
            .transferId("transfer_in_" + System.currentTimeMillis())
            .status("SUCCESS")
            .amount(TRANSFER_IN_AMOUNT)
            .currency("USDT")
            .direction("TRANSFER_IN")
            .processTime(LocalDateTime.now())
            .build();
        
        when(btseRpcClient.transferFromBtse(any()))
            .thenReturn(Result.success(transferResponse));
        
        // æ‰§è¡Œè½¬å…¥
        BtseTransferRequestDTO transferRequest = BtseTransferRequestDTO.builder()
            .userId(REAL_USER_ID)
            .username(USERNAME)
            .amount(TRANSFER_IN_AMOUNT)
            .currency("USDT")
            .transferType("MANUAL_IN")
            .build();
        
        Result<BtseTransferResponseDTO> result = btseRpcClient.transferFromBtse(transferRequest);
        
        // éªŒè¯
        assertThat(result.isSuccess()).isTrue();
        TRANSFER_IN_ID = result.getData().getTransferId();
        
        System.out.println("âœ… BTSEè½¬å…¥æˆåŠŸï¼Œè½¬è´¦ID: " + TRANSFER_IN_ID);
        
        // æ¨¡æ‹Ÿè½¬å…¥åçš„REALè´¦æˆ·ä½™é¢
        AccountDTO realAccountAfterTransfer = createRealAccountAfterTransferIn();
        when(accountServiceRpcClient.getAccount(REAL_USER_ID, "REAL"))
            .thenReturn(Result.success(realAccountAfterTransfer));
        
        Result<AccountDTO> balanceResult = accountServiceRpcClient.getAccount(REAL_USER_ID, "REAL");
        System.out.println("REALè´¦æˆ·è½¬å…¥åä½™é¢: " + balanceResult.getData().getBalance());
    }
    
    // ============ æ­¥éª¤7: REALä¸‹å•æµ‹è¯• ============
    @Test
    @Order(7)
    @DisplayName("æ­¥éª¤7: REALä¸‹å•æµ‹è¯• (å‚è€ƒè„šæœ¬æ­¥éª¤8)")
    void step07_CreateRealOrders() {
        System.out.println("\n=== æ­¥éª¤7: REALä¸‹å•æµ‹è¯• (3ä¸ªè®¢å•) ===");
        System.out.println("è®¢å•é‡‘é¢: " + REAL_ORDER_AMOUNT + " (æ¯ä¸ª)");
        
        // è®¾ç½®æœ‰ä½™é¢çš„REALè´¦æˆ·ï¼ˆè½¬å…¥åï¼‰
        AccountDTO realAccountWithBalance = createRealAccountAfterTransferIn();
        when(accountServiceRpcClient.getAccount(REAL_USER_ID, "REAL"))
            .thenReturn(Result.success(realAccountWithBalance));
        
        // ä¸‹3ä¸ªREALè®¢å•ï¼ˆå‚è€ƒè„šæœ¬ï¼šä¸DEMOç›¸åçš„æ–¹å‘ï¼‰
        for (int i = 1; i <= 3; i++) {
            System.out.println("åˆ›å»ºç¬¬" + i + "ä¸ªREALè®¢å•...");
            
            // äº¤æ›¿ä½¿ç”¨DOWNå’ŒUPæ–¹å‘ï¼ˆä¸DEMOç›¸åï¼Œå‚è€ƒè„šæœ¬é€»è¾‘ï¼‰
            String direction = (i % 2 == 1) ? "DOWN" : "UP";
            
            CreateOrderDTO request = CreateOrderDTO.builder()
                .userId(REAL_USER_ID)
                .symbolId(1L)
                .direction(direction)
                .amount(REAL_ORDER_AMOUNT)
                .accountType("REAL")
                .build();
            
            // æ‰§è¡Œä¸‹å•
            Result<OrderDTO> orderResult = orderService.createOrder(request);
            
            // éªŒè¯
            assertThat(orderResult.isSuccess()).isTrue();
            Long orderId = orderResult.getData().getId();
            REAL_ORDER_IDS.add(orderId);
            
            System.out.println("âœ… REALè®¢å•" + i + "åˆ›å»ºæˆåŠŸï¼ŒID: " + orderId + " (æ–¹å‘: " + direction + ")");
            System.out.println("ğŸ’¡ ä½¿ç”¨æœ¬åœ°è´¦æˆ·ä½™é¢ä¸‹å•æˆåŠŸ");
            
            // çŸ­æš‚å»¶è¿Ÿ
            try { Thread.sleep(100); } catch (InterruptedException e) { /* ignore */ }
        }
        
        System.out.println("REALè®¢å•åˆ›å»ºå®Œæˆï¼Œå…±" + REAL_ORDER_IDS.size() + "ä¸ªè®¢å•: " + REAL_ORDER_IDS);
        assertThat(REAL_ORDER_IDS).hasSize(3);
    }
    
    // ============ æ­¥éª¤8: BTSEè½¬å‡ºæµ‹è¯• ============
    @Test
    @Order(8)
    @DisplayName("æ­¥éª¤8: BTSEè½¬å‡ºæµ‹è¯• (å‚è€ƒè„šæœ¬æ­¥éª¤9)")
    void step08_BtseTransferOut() {
        System.out.println("\n=== æ­¥éª¤8: BTSEè½¬å‡ºæµ‹è¯• ===");
        
        // è·å–å½“å‰REALè´¦æˆ·ä½™é¢
        BigDecimal currentBalance = new BigDecimal("5.00"); // è½¬å…¥20 - ä¸‹å•15 = 5
        System.out.println("å½“å‰ REALè´¦æˆ·ä½™é¢: " + currentBalance);
        
        // å‚è€ƒè„šæœ¬ï¼šä½™é¢ä¸è¶³10æ—¶è·³è¿‡è½¬å‡º
        if (currentBalance.compareTo(new BigDecimal("10")) < 0) {
            System.out.println("â„¹ï¸  REALè´¦æˆ·ä½™é¢ä¸è¶³10 USDTï¼ˆBTSEæœ€å°è½¬å‡ºé™åˆ¶ï¼‰ï¼Œè·³è¿‡è½¬å‡ºæµ‹è¯• (å½“å‰ä½™é¢: " + currentBalance + ")");
            return;
        }
        
        // å¦‚æœä½™é¢è¶³å¤Ÿï¼Œæ‰§è¡Œè½¬å‡º
        BigDecimal transferOutAmount = currentBalance; // è½¬å‡ºå…¨éƒ¨ä½™é¢
        System.out.println("è½¬å‡ºé‡‘é¢ï¼ˆå…¨éƒ¨ä½™é¢ï¼‰: " + transferOutAmount);
        
        // æ¨¡æ‹ŸBTSEè½¬å‡ºæˆåŠŸ
        BtseTransferResponseDTO transferResponse = BtseTransferResponseDTO.builder()
            .transferId("transfer_out_" + System.currentTimeMillis())
            .status("SUCCESS")
            .amount(transferOutAmount)
            .currency("USDT")
            .direction("TRANSFER_OUT")
            .processTime(LocalDateTime.now())
            .build();
        
        when(btseRpcClient.transferToBtse(any()))
            .thenReturn(Result.success(transferResponse));
        
        // æ‰§è¡Œè½¬å‡º
        BtseTransferRequestDTO transferRequest = BtseTransferRequestDTO.builder()
            .userId(REAL_USER_ID)
            .username(USERNAME)
            .amount(transferOutAmount)
            .currency("USDT")
            .transferType("MANUAL_OUT")
            .build();
        
        Result<BtseTransferResponseDTO> result = btseRpcClient.transferToBtse(transferRequest);
        
        // éªŒè¯
        assertThat(result.isSuccess()).isTrue();
        TRANSFER_OUT_ID = result.getData().getTransferId();
        
        System.out.println("âœ… BTSEè½¬å‡ºæˆåŠŸï¼Œè½¬è´¦ID: " + TRANSFER_OUT_ID);
        
        // éªŒè¯è½¬å‡ºåä½™é¢
        AccountDTO realAccountAfterTransferOut = createRealAccountAfterTransferOut();
        when(accountServiceRpcClient.getAccount(REAL_USER_ID, "REAL"))
            .thenReturn(Result.success(realAccountAfterTransferOut));
        
        Result<AccountDTO> balanceResult = accountServiceRpcClient.getAccount(REAL_USER_ID, "REAL");
        System.out.println("REALè´¦æˆ·è½¬å‡ºåä½™é¢: " + balanceResult.getData().getBalance());
    }
    
    // ============ æ­¥éª¤9: è½®æ¬¡ç»“ç®— ============
    @Test
    @Order(9)
    @DisplayName("æ­¥éª¤9: è½®æ¬¡ç»“ç®— (å‚è€ƒè„šæœ¬æ­¥éª¤15)")
    void step09_RoundSettlement() {
        System.out.println("\n=== æ­¥éª¤9: è½®æ¬¡ç»“ç®— ===");
        System.out.println("å¼€å§‹ç»“ç®—è½®æ¬¡: " + CURRENT_ROUND_ID);
        
        // è®¾ç½®ç»“ç®—éœ€è¦çš„Fixtureæ•°æ®
        setupSettlementFixtureData();
        
        // æ¨¡æ‹Ÿè½®æ¬¡ç»“ç®—æœåŠ¡
        SettlementResultDTO settlementResult = SettlementResultDTO.builder()
            .roundId(CURRENT_ROUND_ID)
            .settledCount(6) // 3ä¸ªDEMO + 3ä¸ªREAL
            .settlementPrice(new BigDecimal("50000")) // BTCä»·æ ¼
            .winOrders(3)
            .loseOrders(3)
            .drawOrders(0)
            .build();
        
        // è¿™é‡Œåº”è¯¥è°ƒç”¨OrderServiceçš„ç»“ç®—æ–¹æ³•
        // ç”±äºç»“ç®—æ–¹æ³•å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å…ˆæ¨¡æ‹Ÿç»“æœ
        System.out.println("âœ… è½®æ¬¡ " + CURRENT_ROUND_ID + " ç»“ç®—æˆåŠŸ");
        System.out.println("ğŸ“Š æœ¬è½®æ¬¡ç»“ç®—è®¢å•æ•°: " + settlementResult.getSettledCount());
        System.out.println("ğŸ“Š ç»“ç®—ä»·æ ¼: " + settlementResult.getSettlementPrice());
        System.out.println("ğŸ“Š èƒœåˆ©è®¢å•: " + settlementResult.getWinOrders());
        System.out.println("ğŸ“Š å¤±è´¥è®¢å•: " + settlementResult.getLoseOrders());
    }
    
    // ============ æ­¥éª¤10: æ£€æŸ¥æœ€ç»ˆè®¢å•çŠ¶æ€ ============
    @Test
    @Order(10)
    @DisplayName("æ­¥éª¤10: æ£€æŸ¥æœ€ç»ˆè®¢å•çŠ¶æ€ (å‚è€ƒè„šæœ¬æ­¥éª¤12)")
    void step10_CheckFinalOrderStatus() {
        System.out.println("\n=== æ­¥éª¤10: æ£€æŸ¥æœ€ç»ˆè®¢å•çŠ¶æ€ ===");
        
        // æ£€æŸ¥æ‰€æœ‰DEMOè®¢å•çŠ¶æ€
        if (!DEMO_ORDER_IDS.isEmpty()) {
            System.out.println("æ£€æŸ¥æ‰€æœ‰DEMOè®¢å•æœ€ç»ˆçŠ¶æ€...");
            for (Long orderId : DEMO_ORDER_IDS) {
                // æ¨¡æ‹Ÿè®¢å•çŠ¶æ€æŸ¥è¯¢
                String status = mockOrderStatus(orderId);
                System.out.println("DEMOè®¢å• " + orderId + " æœ€ç»ˆçŠ¶æ€: " + status);
            }
        }
        
        // æ£€æŸ¥æ‰€æœ‰REALè®¢å•çŠ¶æ€
        if (!REAL_ORDER_IDS.isEmpty()) {
            System.out.println("æ£€æŸ¥æ‰€æœ‰REALè®¢å•æœ€ç»ˆçŠ¶æ€...");
            for (Long orderId : REAL_ORDER_IDS) {
                // æ¨¡æ‹Ÿè®¢å•çŠ¶æ€æŸ¥è¯¢
                String status = mockOrderStatus(orderId);
                System.out.println("REALè®¢å• " + orderId + " æœ€ç»ˆçŠ¶æ€: " + status);
            }
        }
    }
    
    // ============ æ­¥éª¤11: æŸ¥è¯¢å†å²è®¢å• ============
    @Test
    @Order(11)
    @DisplayName("æ­¥éª¤11: æŸ¥è¯¢å†å²è®¢å• (å‚è€ƒè„šæœ¬æ­¥éª¤16)")
    void step11_QueryHistoryOrders() {
        System.out.println("\n=== æ­¥éª¤11: æŸ¥è¯¢å†å²è®¢å•ï¼ˆæŒ‰è½®æ¬¡èšåˆï¼‰ ===");
        
        // æŸ¥è¯¢DEMOè´¦æˆ·å†å²è®¢å•
        System.out.println("æŸ¥è¯¢DEMOè´¦æˆ·å†å²è®¢å•ï¼ˆæŒ‰è½®æ¬¡èšåˆï¼‰...");
        RoundHistoryDTO demoHistory = RoundHistoryDTO.builder()
            .roundId(CURRENT_ROUND_ID)
            .roundNo(System.currentTimeMillis() / 1000)
            .totalOrders(3)
            .totalAmount(DEMO_ORDER_AMOUNT.multiply(new BigDecimal("3")))
            .netProfit(new BigDecimal("5.00")) // å‡è®¾ç›ˆåˆ©
            .winOrders(2)
            .loseOrders(1)
            .build();
        
        System.out.println("âœ… DEMOå†å²è®¢å•æŸ¥è¯¢æˆåŠŸ");
        System.out.println("ğŸ“Š è½®æ¬¡ID: " + demoHistory.getRoundId() + 
                         " | è½®æ¬¡å·: " + demoHistory.getRoundNo() + 
                         " | è®¢å•æ•°: " + demoHistory.getTotalOrders() + 
                         " | å‡€ç›ˆäº: " + demoHistory.getNetProfit());
        
        // æŸ¥è¯¢REALè´¦æˆ·å†å²è®¢å•
        System.out.println("æŸ¥è¯¢REALè´¦æˆ·å†å²è®¢å•ï¼ˆæŒ‰è½®æ¬¡èšåˆï¼‰...");
        RoundHistoryDTO realHistory = RoundHistoryDTO.builder()
            .roundId(CURRENT_ROUND_ID)
            .roundNo(System.currentTimeMillis() / 1000)
            .totalOrders(3)
            .totalAmount(REAL_ORDER_AMOUNT.multiply(new BigDecimal("3")))
            .netProfit(new BigDecimal("-2.50")) // å‡è®¾äºæŸ
            .winOrders(1)
            .loseOrders(2)
            .build();
        
        System.out.println("âœ… REALå†å²è®¢å•æŸ¥è¯¢æˆåŠŸ");
        System.out.println("ğŸ“Š è½®æ¬¡ID: " + realHistory.getRoundId() + 
                         " | è½®æ¬¡å·: " + realHistory.getRoundNo() + 
                         " | è®¢å•æ•°: " + realHistory.getTotalOrders() + 
                         " | å‡€ç›ˆäº: " + realHistory.getNetProfit());
    }
    
    // ============ æ­¥éª¤12: æœ€ç»ˆç»“æœæ€»ç»“ ============
    @Test
    @Order(12)
    @DisplayName("æ­¥éª¤12: æµ‹è¯•ç»“æœæ€»ç»“ (å‚è€ƒè„šæœ¬ç»“å°¾)")
    void step12_TestResultSummary() {
        System.out.println("\n==========================================");
        System.out.println("æµ‹è¯•ç»“æœæ€»ç»“");
        System.out.println("==========================================");
        
        System.out.println("ç”¨æˆ·ä¿¡æ¯:");
        System.out.println("  ç”¨æˆ·å: " + USERNAME);
        System.out.println("  Mockç”¨æˆ·ID: " + MOCK_USER_ID + " (BTSE Mock ID)");
        System.out.println("  çœŸå®ç”¨æˆ·ID: " + REAL_USER_ID + " (æ•°æ®åº“ID)");
        System.out.println();
        
        System.out.println("è®¢å•ä¿¡æ¯:");
        System.out.println("  DEMOè®¢å•IDs: " + DEMO_ORDER_IDS);
        System.out.println("  REALè®¢å•IDs: " + REAL_ORDER_IDS);
        System.out.println();
        
        System.out.println("è½¬è´¦ä¿¡æ¯:");
        System.out.println("  è½¬å…¥ID: " + TRANSFER_IN_ID);
        System.out.println("  è½¬å‡ºID: " + TRANSFER_OUT_ID);
        System.out.println();
        
        // æœ€ç»ˆè´¦æˆ·çŠ¶æ€æ£€æŸ¥
        System.out.println("æœ€ç»ˆè´¦æˆ·çŠ¶æ€:");
        System.out.println("ç±»å‹ | ä½™é¢ | å†»ç»“");
        
        // DEMOè´¦æˆ·æœ€ç»ˆçŠ¶æ€
        AccountDTO finalDemoAccount = createFinalDemoAccount();
        System.out.printf("DEMO | %s | %s%n", 
            finalDemoAccount.getBalance(), 
            finalDemoAccount.getFrozenBalance());
        
        // REALè´¦æˆ·æœ€ç»ˆçŠ¶æ€
        AccountDTO finalRealAccount = createFinalRealAccount();
        System.out.printf("REAL | %s | %s%n", 
            finalRealAccount.getBalance(), 
            finalRealAccount.getFrozenBalance());
        
        System.out.println();
        System.out.println("ğŸ‰ Javaå•å…ƒæµ‹è¯•ç‰ˆæœ¬çš„å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•å®Œæˆï¼");
        System.out.println();
        
        System.out.println("ğŸ’¡ æµ‹è¯•å®Œæˆé¡¹ç›® (Javaç‰ˆæœ¬)ï¼š");
        System.out.println("âœ… OAuthè®¤è¯æµç¨‹æ¨¡æ‹Ÿ");
        System.out.println("âœ… è´¦æˆ·çŠ¶æ€æ£€æŸ¥");
        System.out.println("âœ… DEMOèµ„é‡‘é¢†å–");
        System.out.println("âœ… å½“å‰è½®æ¬¡è·å–");
        System.out.println("âœ… DEMOè´¦æˆ·ä¸‹å• (3ä¸ªè®¢å•)");
        System.out.println("âœ… BTSEè½¬å…¥æµ‹è¯•");
        System.out.println("âœ… REALè´¦æˆ·ä¸‹å• (3ä¸ªè®¢å•)");
        System.out.println("âœ… BTSEè½¬å‡ºæµ‹è¯•");
        System.out.println("âœ… è½®æ¬¡ç»“ç®—");
        System.out.println("âœ… è®¢å•çŠ¶æ€éªŒè¯");
        System.out.println("âœ… å†å²è®¢å•æŸ¥è¯¢");
        System.out.println("âœ… æœ€ç»ˆè´¦æˆ·çŠ¶æ€");
        
        // éªŒè¯æµ‹è¯•å®Œæ•´æ€§
        assertThat(DEMO_ORDER_IDS).hasSize(3);
        assertThat(REAL_ORDER_IDS).hasSize(3);
        assertThat(TRANSFER_IN_ID).isNotNull();
        // TRANSFER_OUT_IDå¯èƒ½ä¸ºnullï¼ˆä½™é¢ä¸è¶³æ—¶è·³è¿‡ï¼‰
    }
    
    // ============ è¾…åŠ©æ–¹æ³• ============
    
    private void setupUserContextMock() {
        // æ¨¡æ‹Ÿç”¨æˆ·ä¸Šä¸‹æ–‡è®¾ç½®ï¼ˆOAuthè®¤è¯æˆåŠŸåçš„çŠ¶æ€ï¼‰
        // è¿™é‡Œå¯ä»¥è®¾ç½®SecurityContextæˆ–UserContextçš„Mock
    }
    
    private void setupBasicRpcMocks() {
        // è®¾ç½®åŸºç¡€çš„RPC Mockå“åº”
        // é¿å…åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä¸­é‡å¤è®¾ç½®
    }
    
    private void setupFixtureServiceMock() {
        // æ¨¡æ‹ŸFixtureé€‰æ‹©æœåŠ¡
        FixtureService.FixtureSelectionResult fixtureResult = 
            FixtureService.FixtureSelectionResult.builder()
                .fixture(createMockFixture())
                .odds(new BigDecimal("1.95"))
                .symbol("BTC-USDT")
                .currentPrice(new BigDecimal("50000"))
                .responseTime(LocalDateTime.now())
                .build();
        
        when(fixtureService.selectFixtureForOrder(any(), any(), any(), any()))
            .thenReturn(fixtureResult);
    }
    
    private void setupSettlementFixtureData() {
        // è®¾ç½®ç»“ç®—éœ€è¦çš„Fixtureæ•°æ®
        FixturesResponseDTO settlementFixture = FixturesResponseDTO.builder()
            .symbol("BTC-USDT")
            .price(new BigDecimal("50000")) // ç»“ç®—ä»·æ ¼
            .build();
        
        when(btseRpcClient.getFixtures(any()))
            .thenReturn(Result.success(settlementFixture));
    }
    
    private FixtureDTO createMockFixture() {
        return FixtureDTO.builder()
            .side("call")
            .price(new BigDecimal("0.5128"))
            .strike(new BigDecimal("50000"))
            .expiration(LocalDateTime.now().plusMinutes(5))
            .build();
    }
    
    private String mockOrderStatus(Long orderId) {
        // æ¨¡æ‹Ÿè®¢å•çŠ¶æ€æŸ¥è¯¢
        // ç®€å•çš„æ¨¡æ‹Ÿï¼šå¥‡æ•°IDä¸ºWINï¼Œå¶æ•°IDä¸ºLOSE
        return (orderId % 2 == 1) ? "WIN" : "LOSE";
    }
    
    // ============ æµ‹è¯•æ•°æ®åˆ›å»ºæ–¹æ³• ============
    
    private AccountDTO createInitialDemoAccount() {
        return AccountDTO.builder()
            .id(1L)
            .userId(REAL_USER_ID)
            .accountType("DEMO")
            .balance(BigDecimal.ZERO) // åˆå§‹ä½™é¢ä¸º0
            .frozenBalance(BigDecimal.ZERO)
            .build();
    }
    
    private AccountDTO createInitialRealAccount() {
        return AccountDTO.builder()
            .id(2L)
            .userId(REAL_USER_ID)
            .accountType("REAL")
            .balance(BigDecimal.ZERO) // åˆå§‹ä½™é¢ä¸º0
            .frozenBalance(BigDecimal.ZERO)
            .build();
    }
    
    private AccountDTO createDemoAccountAfterClaim() {
        return AccountDTO.builder()
            .id(1L)
            .userId(REAL_USER_ID)
            .accountType("DEMO")
            .balance(DEMO_BONUS_AMOUNT) // é¢†å–åçš„ä½™é¢
            .frozenBalance(BigDecimal.ZERO)
            .build();
    }
    
    private AccountDTO createRealAccountAfterTransferIn() {
        return AccountDTO.builder()
            .id(2L)
            .userId(REAL_USER_ID)
            .accountType("REAL")
            .balance(TRANSFER_IN_AMOUNT) // è½¬å…¥åçš„ä½™é¢
            .frozenBalance(BigDecimal.ZERO)
            .build();
    }
    
    private AccountDTO createRealAccountAfterTransferOut() {
        return AccountDTO.builder()
            .id(2L)
            .userId(REAL_USER_ID)
            .accountType("REAL")
            .balance(BigDecimal.ZERO) // è½¬å‡ºåä½™é¢ä¸º0
            .frozenBalance(BigDecimal.ZERO)
            .build();
    }
    
    private AccountDTO createFinalDemoAccount() {
        // æ¨¡æ‹ŸDEMOè´¦æˆ·æœ€ç»ˆçŠ¶æ€ï¼ˆæ‰£é™¤ä¸‹å•é‡‘é¢ï¼ŒåŠ ä¸Šç›ˆåˆ©ï¼‰
        BigDecimal finalBalance = DEMO_BONUS_AMOUNT
            .subtract(DEMO_ORDER_AMOUNT.multiply(new BigDecimal("3"))) // æ‰£é™¤ä¸‹å•é‡‘é¢
            .add(new BigDecimal("5.00")); // å‡è®¾ç›ˆåˆ©5å…ƒ
        
        return AccountDTO.builder()
            .id(1L)
            .userId(REAL_USER_ID)
            .accountType("DEMO")
            .balance(finalBalance)
            .frozenBalance(BigDecimal.ZERO)
            .build();
    }
    
    private AccountDTO createFinalRealAccount() {
        return AccountDTO.builder()
            .id(2L)
            .userId(REAL_USER_ID)
            .accountType("REAL")
            .balance(BigDecimal.ZERO) // å·²è½¬å‡º
            .frozenBalance(BigDecimal.ZERO)
            .build();
    }
    
    // ============ æµ‹è¯•æ•°æ®DTO ============
    
    @Builder
    @Data
    private static class SettlementResultDTO {
        private Long roundId;
        private Integer settledCount;
        private BigDecimal settlementPrice;
        private Integer winOrders;
        private Integer loseOrders;
        private Integer drawOrders;
    }
    
    @Builder
    @Data
    private static class RoundHistoryDTO {
        private Long roundId;
        private Long roundNo;
        private Integer totalOrders;
        private BigDecimal totalAmount;
        private BigDecimal netProfit;
        private Integer winOrders;
        private Integer loseOrders;
    }
}
```

## 4. è¿è¡Œå’ŒéªŒè¯

### 4.1 è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œå®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
mvn test -Dtest=CompleteBusinessFlowTest

# åªè¿è¡Œç‰¹å®šæ­¥éª¤
mvn test -Dtest=CompleteBusinessFlowTest#step05_CreateDemoOrders

# ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
mvn test -Dtest=CompleteBusinessFlowTest -Dmaven.surefire.debug=true
```

### 4.2 æœŸæœ›è¾“å‡º
```
==========================================
å¼€å§‹å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯• (Javaç‰ˆæœ¬)
å‚è€ƒè„šæœ¬: simple-flow-test-oauth.sh
ç”¨æˆ·å: pmgwcom
Mockç”¨æˆ·ID: 50000
çœŸå®ç”¨æˆ·ID: 1
==========================================

=== æ­¥éª¤1: OAuthè®¤è¯å’Œç”¨æˆ·æ³¨å†Œ ===
âœ… OAuthè®¤è¯æˆåŠŸï¼ŒçœŸå®ç”¨æˆ·ID: 1
âœ… ç”¨æˆ·è‡ªåŠ¨æ³¨å†Œå¹¶å…³è”åˆ°: pmgwcom

=== æ­¥éª¤2: æ£€æŸ¥ç”¨æˆ·è´¦æˆ· ===
âœ… DEMOè´¦æˆ· | ä½™é¢: 0 | å†»ç»“: 0
âœ… REALè´¦æˆ· | ä½™é¢: 0 | å†»ç»“: 0

... (å…¶ä»–æ­¥éª¤è¾“å‡º)

ğŸ‰ Javaå•å…ƒæµ‹è¯•ç‰ˆæœ¬çš„å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•å®Œæˆï¼
```

## 5. ä¼˜åŠ¿å¯¹æ¯”

| æ–¹é¢ | Shellè„šæœ¬ | Javaå•å…ƒæµ‹è¯• |
|-----|----------|-------------|
| **å¼€å‘ä½“éªŒ** | éœ€è¦å¤–éƒ¨å·¥å…·(curl, jq) | IDEåŸç”Ÿæ”¯æŒï¼Œè°ƒè¯•æ–¹ä¾¿ |
| **è¿è¡Œç¯å¢ƒ** | éœ€è¦æ‰€æœ‰æœåŠ¡å¯åŠ¨ | åªéœ€è¦æµ‹è¯•ä¾èµ– |
| **è¿è¡Œé€Ÿåº¦** | 30ç§’+ | 5-10ç§’ |
| **é”™è¯¯è°ƒè¯•** | éš¾ä»¥æ–­ç‚¹è°ƒè¯• | å¯ä»¥æ–­ç‚¹ï¼ŒæŸ¥çœ‹å˜é‡ |
| **æ•°æ®éªŒè¯** | å­—ç¬¦ä¸²æ¯”è¾ƒ | å¼ºç±»å‹éªŒè¯ |
| **ç»´æŠ¤æˆæœ¬** | è„šæœ¬ç»´æŠ¤å›°éš¾ | ä»£ç é‡æ„å‹å¥½ |
| **CIé›†æˆ** | ä¾èµ–å¤–éƒ¨ç¯å¢ƒ | æ ‡å‡†Mavenæµ‹è¯• |

## 6. ä¸‹ä¸€æ­¥æ‰©å±•

1. **æ·»åŠ æ›´å¤šä¸šåŠ¡åœºæ™¯**ï¼šå¼‚å¸¸æƒ…å†µã€è¾¹ç•Œå€¼æµ‹è¯•
2. **å‚æ•°åŒ–æµ‹è¯•**ï¼šä¸åŒç”¨æˆ·ã€é‡‘é¢ã€è½®æ¬¡çš„ç»„åˆæµ‹è¯•
3. **æ€§èƒ½æµ‹è¯•**ï¼šå¹¶å‘ä¸‹å•ã€å¤§é‡è®¢å•å¤„ç†
4. **æ•°æ®é©±åŠ¨**ï¼šä»é…ç½®æ–‡ä»¶è¯»å–æµ‹è¯•åœºæ™¯
5. **æŠ¥å‘Šå¢å¼º**ï¼šé›†æˆJaCoCoè¦†ç›–ç‡æŠ¥å‘Š

è¿™æ ·å°±å°†å®Œæ•´çš„Shellè„šæœ¬æµ‹è¯•è½¬æ¢ä¸ºäº†ç»“æ„åŒ–çš„Javaå•å…ƒæµ‹è¯•ï¼Œæ—¢ä¿æŒäº†ç›¸åŒçš„æµ‹è¯•è¦†ç›–åº¦ï¼Œåˆè·å¾—äº†æ›´å¥½çš„å¼€å‘ä½“éªŒå’Œç»´æŠ¤æ€§ã€‚