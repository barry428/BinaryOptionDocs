# option-order-service 单元测试方案

## 1. 概述

本文档为`option-order-service`服务制定单元测试方案，旨在确保代码质量和功能正确性，同时遵循单元测试的核心原则：快速、隔离、可重复。

## 2. 测试框架和工具

### 2.1 核心框架
- **JUnit 5**: Java单元测试标准框架
- **Spring Boot Test**: Spring Boot应用测试支持
- **Mockito**: Mock框架，用于模拟依赖对象

### 2.2 依赖配置
项目pom.xml已包含必要的测试依赖：
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
</dependency>
```

## 3. 测试策略

### 3.1 测试分类
1. **单元测试 (Unit Test)**: 测试单个类的方法逻辑，隔离外部依赖
2. **集成测试 (Integration Test)**: 测试多个组件协同工作
3. **契约测试 (Contract Test)**: 验证服务间API契约

### 3.2 测试原则
1. **快速执行**: 单元测试应在毫秒级完成
2. **环境隔离**: 不依赖外部服务(数据库、Redis、API)
3. **数据独立**: 测试间无数据依赖
4. **可重复性**: 多次执行结果一致

## 4. 测试目录结构

```
src/test/java/com/binaryoption/orderservice/
├── client/          # 客户端调用测试
├── config/          # 配置类测试
├── converter/       # 数据转换器测试
├── service/         # 服务层测试
├── util/            # 工具类测试
└── OrderServiceApplicationTests.java  # 应用启动测试
```

## 5. 核心服务测试方案

### 5.1 OrderService 测试

#### 5.1.1 测试要点
- 订单创建流程验证
- 风控检查逻辑
- 资金处理流程
- 异常处理路径

#### 5.1.2 Mock策略
```java
// Mock依赖服务
@MockBean
private OrderMapper orderMapper;

@MockBean
private AccountRpcClient accountRpcClient;

@MockBean
private BtseTransferRpcClient btseTransferRpcClient;

@MockBean
private RiskControlService riskControlService;
```

#### 5.1.3 测试用例示例
```java
@Test
void shouldCreateOrderSuccessfully() {
    // Given
    OrderCreateRequestDTO request = createValidOrderRequest();
    given(riskControlService.checkOrderRisk(any())).willReturn(RiskCheckResult.pass());
    given(accountRpcClient.getAccountBalance(any(), any())).willReturn(Result.success(createAccountDTO()));
    
    // When
    Result<OrderDTO> result = orderService.createOrder(request);
    
    // Then
    assertThat(result.isSuccess()).isTrue();
    verify(orderMapper).insert(any(Order.class));
    verify(btseTransferRpcClient).transferFromBtse(any(), any(), any(), any(), any());
}
```

### 5.2 OrderSettlementService 测试

#### 5.2.1 测试要点
- 订单结算逻辑
- 盈亏计算准确性
- 手续费计算
- 资金结算处理

#### 5.2.2 Mock策略
```java
@MockBean
private OrderMapper orderMapper;

@MockBean
private AccountRpcClient accountRpcClient;

@MockBean
private BtseRpcClient btseRpcClient;
```

#### 5.2.3 测试用例示例
```java
@Test
void shouldSettleWinOrderCorrectly() {
    // Given
    Order order = createActiveOrder();
    given(orderMapper.findById(any())).willReturn(order);
    given(btseRpcClient.getFixtures(any())).willReturn(Result.success(createWinFixtureResponse()));
    
    // When
    orderSettlementService.settleOrdersByRound(1L);
    
    // Then
    verify(accountRpcClient).atomicOrderSettlement(any(), any(), any(), any(), any(), any(), any(), any(), eq(true), any(), any());
}
```

## 6. 测试数据管理

### 6.1 测试数据工厂
创建测试数据工厂类，提供常用的测试对象：
```java
public class TestDataFactory {
    public static OrderCreateRequestDTO createValidOrderRequest() {
        OrderCreateRequestDTO request = new OrderCreateRequestDTO();
        request.setUserId(1L);
        request.setAccountType("REAL");
        request.setSymbolId(1L);
        request.setDirection("UP");
        request.setAmount(new BigDecimal("100"));
        return request;
    }
}
```

### 6.2 参数化测试
使用JUnit 5的参数化测试验证边界条件：
```java
@ParameterizedTest
@ValueSource(strings = {"UP", "DOWN"})
void shouldHandleBothDirectionOrders(String direction) {
    // 测试买涨和买跌订单
}
```

## 7. 测试覆盖率目标

### 7.1 覆盖率指标
- **行覆盖率**: ≥ 80%
- **分支覆盖率**: ≥ 70%
- **方法覆盖率**: ≥ 85%

### 7.2 关键路径覆盖
确保覆盖以下关键路径：
1. 正常业务流程
2. 异常处理路径
3. 边界条件处理
4. 配置依赖路径

## 8. 持续集成

### 8.1 CI/CD集成
在CI/CD流水线中添加测试步骤：
```bash
# 执行单元测试
mvn test

# 生成测试报告
mvn surefire-report:report

# 检查测试覆盖率
mvn jacoco:report
```

### 8.2 质量门禁
- 测试通过率100%
- 关键模块测试覆盖率≥80%
- 无严重测试失败

## 9. 最佳实践

### 9.1 命名规范
- 测试方法名采用`shouldDoSomethingWhenCondition`格式
- 测试类名采用被测试类名+Test格式

### 9.2 测试组织
- 每个业务方法对应一个或多个测试方法
- 使用Given-When-Then结构组织测试代码
- 合理使用@BeforeEach和@AfterEach进行测试准备和清理

### 9.3 性能优化
- 避免在测试中使用Thread.sleep()
- 使用Mockito的verify()验证交互而非状态
- 合理使用@TestConfiguration优化测试启动时间

## 10. 实施计划

### 10.1 阶段一：基础框架搭建
- [x] 创建测试目录结构
- [x] 配置测试依赖
- [ ] 编写基础测试用例

### 10.2 阶段二：核心服务测试
- [ ] OrderService单元测试
- [ ] OrderSettlementService单元测试
- [ ] 其他服务类单元测试

### 10.3 阶段三：覆盖率提升
- [ ] 达到覆盖率目标
- [ ] 集成CI/CD流水线
- [ ] 建立测试报告机制