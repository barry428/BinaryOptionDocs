# option-common-service 单元测试方案

## 1. 概述

本文档为`option-common-service`模块中的服务类制定详细的单元测试方案。该模块包含以下核心服务：

1. **AccountService** - 账户管理服务
2. **BtseTransferService** - BTSE资金划转服务
3. **UserService** - 用户管理服务
4. **GlobalConfigService** - 全局配置服务
5. **ReconciliationService** - 对账服务
6. **BtseTransferScheduledTaskService** - BTSE划转定时任务服务

## 2. 测试原则

### 2.1 单元测试范围
- 仅测试当前类的业务逻辑
- 使用Mock对象隔离外部依赖
- 验证方法的输入输出和边界条件
- 不依赖数据库、网络等外部资源

### 2.2 测试框架
- JUnit 5
- Mockito
- Spring Boot Test

### 2.3 测试覆盖率目标
- 代码行覆盖率 ≥ 80%
- 分支覆盖率 ≥ 70%
- 关键业务逻辑100%覆盖

## 3. 各服务测试方案

### 3.1 AccountService 测试方案

#### 3.1.1 核心功能点
1. 账户查询功能
2. 账户创建和管理
3. 余额操作（增加、扣减）
4. 原子性操作（并发安全）
5. 统计功能

#### 3.1.2 测试用例设计

##### 查询功能测试
- `getAccountById()` - 根据ID查询账户
- `getAccountsByUserId()` - 根据用户ID查询账户列表
- `getAccountByUserIdAndType()` - 根据用户ID和账户类型获取账户信息
- `getAccountBalance()` - 获取账户余额信息
- `getAccount()` - 获取账户信息（返回域对象）

##### 分页查询测试
- `getAccountList()` - 分页查询账户列表
- `getAccountListByType()` - 根据账户类型查询账户列表

##### 账户管理测试
- `createDefaultAccounts()` - 创建默认账户
- `createAccount()` - 创建账户
- `updateAccountStatus()` - 更新账户状态

##### 余额操作测试
- `addBalance()` - 添加余额
- `subtractBalance()` - 扣减余额
- `claimDemoBonus()` - 领取DEMO账户初始资金
- `hasEnoughBalance()` - 检查账户余额是否充足

##### 原子操作测试
- `atomicBalanceChange()` - 原子性余额变更
- `atomicTransferOut()` - 转出时的原子操作
- `atomicTransferIn()` - 转入时的原子操作
- `atomicOrderSettlement()` - 订单结算的原子性操作

##### 统计功能测试
- `updateDepositStats()` - 更新存款统计
- `updateWithdrawStats()` - 更新取款统计
- `updateOrderSettlementStats()` - 更新账户盈亏统计
- `getTotalAccountCount()` - 获取账户总数
- `getAccountCountByType()` - 按类型获取账户数
- `getTotalBalanceByType()` - 按类型获取总余额
- `getTotalProfitByType()` - 按类型获取总盈利

### 3.2 BtseTransferService 测试方案

#### 3.2.1 核心功能点
1. BTSE资金划转（转入、转出）
2. 划转状态查询
3. 超时补偿机制
4. 异常处理

#### 3.2.2 测试用例设计

##### 资金划转测试
- `transferFromBtse()` - 从BTSE转入资金
- `transferToBtse()` - 转出资金到BTSE
- `transferToBtseWithOrder()` - 支持订单关联的转出
- `transferToBtseWithRound()` - 轮次合并转出

##### 状态查询测试
- `queryTransferStatus()` - 查询BTSE划转状态
- `checkOrderBtseTransferStatus()` - 检查订单的BTSE转账状态

##### 补偿机制测试
- `compensatePendingTransferIn()` - 补偿超时的转入交易
- `compensatePendingTransferOut()` - 补偿超时的转出交易

##### 异常处理测试
- 网络超时处理
- 余额不足处理
- API调用失败处理
- 并发冲突处理

### 3.3 UserService 测试方案

#### 3.3.1 核心功能点
1. 用户查询功能
2. 用户创建和管理
3. 用户状态管理
4. 统计功能

#### 3.3.2 测试用例设计

##### 查询功能测试
- `getUserById()` - 根据ID查询用户
- `getUserByExternalId()` - 根据外部ID查询用户

##### 分页查询测试
- `getUserList()` - 分页查询用户列表
- `getUserListByStatus()` - 根据状态查询用户列表
- `getNewUsers()` - 获取新注册用户

##### 用户管理测试
- `createUser()` - 创建用户
- `updateUser()` - 更新用户信息
- `updateUserStatus()` - 更新用户状态
- `updateLoginInfo()` - 更新登录信息
- `updateAgreements()` - 更新协议同意状态

##### 统计功能测试
- `getTotalUserCount()` - 获取用户总数
- `getActiveUserCount()` - 获取活跃用户数

### 3.4 GlobalConfigService 测试方案

#### 3.4.1 核心功能点
1. 配置值获取
2. 不同类型配置值处理
3. 默认值处理

#### 3.4.2 测试用例设计

##### 配置获取测试
- `getConfigValue()` - 获取配置值
- `getStringConfig()` - 获取字符串配置值
- `getNumberConfig()` - 获取数字配置值
- `getBooleanConfig()` - 获取布尔配置值
- `getIntConfig()` - 获取整数配置值
- `getConfigsByGroup()` - 按组获取配置列表

### 3.5 ReconciliationService 测试方案

#### 3.5.1 核心功能点
1. 单用户对账
2. 批量对账
3. 差异检测
4. 容差处理

#### 3.5.2 测试用例设计

##### 对账功能测试
- `reconcileUserAccounts()` - 单用户对账
- `reconcileBatch()` - 批量对账

##### 差异检测测试
- 账户余额差异检测
- 交易汇总差异检测
- BTSE划转记录检测
- 订单盈亏统计检测

### 3.6 BtseTransferScheduledTaskService 测试方案

#### 3.6.1 核心功能点
1. 定时任务执行
2. 分布式锁机制
3. 异常处理

#### 3.6.2 测试用例设计

##### 定时任务测试
- `executeTransferInCompensationTask()` - 执行转入补偿任务
- `executeTransferOutCompensationTask()` - 执行转出补偿任务

## 4. Mock对象设计

### 4.1 AccountService 依赖
- AccountMapper
- AccountTransactionMapper
- GlobalConfigService
- AccountConverter

### 4.2 BtseTransferService 依赖
- BtseApiClient
- AccountService
- UserService
- BtseTransferLogMapper
- UserRoundRpcClient

### 4.3 UserService 依赖
- UserMapper
- AccountService
- UserConverter

### 4.4 GlobalConfigService 依赖
- GlobalConfigMapper

### 4.5 ReconciliationService 依赖
- AccountMapper
- AccountTransactionMapper
- BtseTransferLogMapper
- OrderStatRpcClient

### 4.6 BtseTransferScheduledTaskService 依赖
- BtseTransferRpcController

## 5. 测试数据工厂

创建TestDataFactory类，提供以下测试数据构建方法：
- Account相关测试数据
- User相关测试数据
- BtseTransfer相关测试数据
- GlobalConfig相关测试数据

## 6. 异常场景测试

### 6.1 业务异常
- 账户不存在
- 余额不足
- 用户不存在
- 配置不存在

### 6.2 系统异常
- 网络超时
- 数据库连接失败
- RPC调用失败

### 6.3 并发场景
- 同时修改同一账户余额
- 同时创建相同用户

## 7. 测试执行计划

### 7.1 第一阶段 - 基础功能测试
1. AccountService基础查询功能
2. UserService基础查询功能
3. GlobalConfigService功能

### 7.2 第二阶段 - 核心业务逻辑测试
1. AccountService余额操作
2. BtseTransferService资金划转
3. UserService用户管理

### 7.3 第三阶段 - 异常处理测试
1. 各服务异常场景处理
2. 网络异常模拟
3. 并发安全测试

### 7.4 第四阶段 - 集成测试
1. 对账服务测试
2. 定时任务测试
3. 端到端业务流程测试

## 8. 质量保证措施

### 8.1 代码审查
- 测试用例覆盖所有业务场景
- Mock对象使用合理
- 断言准确无误

### 8.2 持续集成
- 每次提交自动运行单元测试
- 测试覆盖率报告生成
- 失败测试自动告警

### 8.3 性能监控
- 测试执行时间监控
- 内存使用情况监控
- 测试稳定性监控