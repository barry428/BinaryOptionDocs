# 读写分离实施 - 文件修改清单

## 一、文件树形结构（基于实际项目结构）

```
BinaryOption/
├── option-common-utils/
│   └── src/main/java/com/binaryoption/commonutils/
│       ├── datasource/                                     【新增目录】
│       │   ├── DynamicDataSource.java                    【新增】动态数据源路由
│       │   └── ReadWriteDataSourceAspect.java             【新增】读写分离AOP切面
│       └── config/
│           └── DataSourceConfig.java                      【新增】数据源配置类
│
├── option-common-service/
│   ├── src/main/resources/
│   │   └── application.yml                                【修改】添加主从数据源配置
│   └── src/main/java/com/binaryoption/commonservice/service/
│       ├── AccountService.java                            【修改】查询方法添加@Transactional(readOnly=true)
│       ├── UserService.java                               【修改】查询方法添加@Transactional(readOnly=true)
│       ├── BtseTransferService.java                       【修改】查询方法添加@Transactional(readOnly=true)
│       ├── GlobalConfigService.java                       【修改】查询方法添加@Transactional(readOnly=true)
│       └── ReconciliationService.java                     【修改】查询方法添加@Transactional(readOnly=true)
│
├── option-order-service/
│   ├── src/main/resources/
│   │   └── application.yml                                【修改】添加主从数据源配置
│   └── src/main/java/com/binaryoption/orderservice/service/
│       ├── OrderService.java                              【修改】查询方法添加@Transactional(readOnly=true)
│       ├── SymbolService.java                             【修改】查询方法添加@Transactional(readOnly=true)
│       ├── TradingRoundService.java                       【修改】查询方法添加@Transactional(readOnly=true)
│       ├── OrderStatisticsService.java                    【修改】查询方法添加@Transactional(readOnly=true)
│       ├── FixtureService.java                            【修改】查询方法添加@Transactional(readOnly=true)
│       ├── OrderHedgeService.java                         【修改】查询方法添加@Transactional(readOnly=true)
│       ├── OrderSettlementService.java                    【修改】查询方法添加@Transactional(readOnly=true)
│       ├── RiskControlService.java                        【修改】查询方法添加@Transactional(readOnly=true)
│       └── UserRiskStatsService.java                      【修改】查询方法添加@Transactional(readOnly=true)
│
└── option-market-service/
    ├── src/main/resources/
    │   └── application.yml                                 【修改】添加主从数据源配置
    └── src/main/java/com/binaryoption/marketservice/
        ├── integration/                                    【可能需要修改】
        │   ├── BtseMarketDataClient.java                   【查询方法添加@Transactional(readOnly=true)】
        │   └── BtseWebSocketClient.java                    【查询方法添加@Transactional(readOnly=true)】
        └── （注意：market-service似乎没有service包，主要是integration和ws）
```

## 二、详细修改内容

### 2.1 新增文件（3个）

#### 📁 `option-common-utils/src/main/java/com/binaryoption/commonutils/datasource/DynamicDataSource.java`
```
【文件类型】：新增 Java 类
【文件大小】：约80行代码
【主要功能】：
- 继承 AbstractRoutingDataSource
- 实现动态数据源路由逻辑
- 提供 useMaster() / useSlave() / clear() 方法
- 基于 ThreadLocal 存储当前线程的数据源类型
【关键方法】：
- determineCurrentLookupKey() - 决定使用哪个数据源
- setDataSourceType() - 设置数据源类型
```

#### 📁 `option-common-utils/src/main/java/com/binaryoption/commonutils/datasource/ReadWriteDataSourceAspect.java`
```
【文件类型】：新增 Java 类
【文件大小】：约60行代码
【主要功能】：
- AOP切面，拦截所有Service层方法
- 根据 @Transactional(readOnly) 注解判断数据源
- 在方法执行前设置数据源，执行后清理ThreadLocal
【关键逻辑】：
- @Transactional(readOnly=true) → 使用从库
- @Transactional 或无注解 → 使用主库
- @Order(Ordered.HIGHEST_PRECEDENCE) 确保在事务切面前执行
```

#### 📁 `option-common-utils/src/main/java/com/binaryoption/commonutils/config/DataSourceConfig.java`
```
【文件类型】：新增 Java 配置类
【文件大小】：约100行代码
【主要功能】：
- 配置主数据源 masterDataSource
- 配置从数据源 slaveDataSource
- 配置动态数据源 dynamicDataSource
- 配置 SqlSessionFactory 和 TransactionManager
【关键配置】：
- @ConditionalOnProperty 控制是否启用读写分离
- @Primary 标记 dynamicDataSource 为主数据源
- 支持 MapperScan 自动扫描
```

### 2.2 修改配置文件（3个）

#### 📄 `option-common-service/src/main/resources/application.yml`
```yaml
【修改类型】：添加数据源配置
【修改位置】：spring.datasource 节点下
【添加内容】：
spring:
  datasource:
    master:                                    # 主库配置
      jdbc-url: jdbc:postgresql://localhost:5433/binary_option
      username: postgres
      password: root
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: MasterHikariPool
        minimum-idle: 10
        maximum-pool-size: 30
    slave:                                     # 从库配置
      jdbc-url: jdbc:postgresql://localhost:5434/binary_option_slave
      username: postgres  
      password: root
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: SlaveHikariPool
        minimum-idle: 5
        maximum-pool-size: 20

datasource:
  read-write-separation:
    enabled: true                              # 启用读写分离
    fallback-to-master: true                   # 从库故障时回退到主库
```

#### 📄 `option-order-service/src/main/resources/application.yml`
```yaml
【修改内容】：与 common-service 相同的数据源配置
【注意】：端口和数据库名根据实际情况调整
```

#### 📄 `option-market-service/src/main/resources/application.yml`
```yaml
【修改内容】：与 common-service 相同的数据源配置
【注意】：如果 market-service 是只读服务，可以配置为只连接从库
```

### 2.3 修改Service文件（9个）

#### 📄 `option-common-service/.../AccountService.java`
```java
【修改方式】：在查询方法上添加注解
【需要修改的方法】：
- getAccount(Long userId, String accountType)          → @Transactional(readOnly = true)
- getAccountBalance(Long userId, String accountType)   → @Transactional(readOnly = true)
- getAccountStatistics(Long userId)                    → @Transactional(readOnly = true)
- checkBalance(Long userId, BigDecimal amount)         → @Transactional(readOnly = true)
- getAccountTransactions(Long userId, ...)             → @Transactional(readOnly = true)

【不需要修改的方法】：
- addBalance() / subtractBalance() / freezeBalance()    → 保持 @Transactional
- recordBalanceChangeTransaction()                      → 保持 @Transactional
- updateOrderSettlementStats()                         → 保持 @Transactional

【修改示例】：
// 原代码
public AccountDTO getAccount(Long userId, String accountType) {
    Account account = accountMapper.selectByUserIdAndType(userId, accountType);
    return AccountConverter.toDTO(account);
}

// 修改后
@Transactional(readOnly = true)
public AccountDTO getAccount(Long userId, String accountType) {
    Account account = accountMapper.selectByUserIdAndType(userId, accountType);
    return AccountConverter.toDTO(account);
}
```

#### 📄 `option-common-service/.../UserService.java`
```java
【修改方式】：在查询方法上添加注解
【需要修改的方法】：
- getUserById(Long userId)                             → @Transactional(readOnly = true)
- getUserByExternalId(String externalId)               → @Transactional(readOnly = true)
- getUserInfo(Long userId)                             → @Transactional(readOnly = true)
- validateUser(Long userId)                            → @Transactional(readOnly = true)

【不需要修改的方法】：
- createUser() / updateUser() / deleteUser()           → 保持 @Transactional
- resolveOAuthUser()                                   → 保持 @Transactional

【预计修改】：5-8个方法
```

#### 📄 `option-common-service/.../BtseTransferService.java`
```java
【修改方式】：在查询方法上添加注解
【需要修改的方法】：
- getTransferStatus(String transferId)                 → @Transactional(readOnly = true)
- getTransferHistory(Long userId, ...)                 → @Transactional(readOnly = true)
- checkTransferRecord(String clientTransferId)         → @Transactional(readOnly = true)

【不需要修改的方法】：
- transferToBtse() / transferFromBtse()                → 保持 @Transactional
- recordTransfer() / updateTransferStatus()            → 保持 @Transactional

【预计修改】：3-5个方法
```

#### 📄 `option-order-service/.../OrderService.java`
```java
【修改方式】：在查询方法上添加注解
【需要修改的方法】：
- getOrder(Long orderId)                               → @Transactional(readOnly = true)
- getOrdersByUserId(Long userId)                       → @Transactional(readOnly = true)
- getOrdersByRound(Long roundId)                       → @Transactional(readOnly = true)
- queryOrders(OrderQueryDTO query)                     → @Transactional(readOnly = true)
- getActiveOrders(Long userId)                         → @Transactional(readOnly = true)
- getHistoryOrders(Long userId, PageDTO page)          → @Transactional(readOnly = true)
- getOrderStatistics(Long userId)                      → @Transactional(readOnly = true)

【不需要修改的方法】：
- createOrder() / updateOrderStatus() / cancelOrder()  → 保持 @Transactional
- settleOrders() / processOrderSettlement()            → 保持 @Transactional

【预计修改】：8-12个方法
```

#### 📄 `option-order-service/.../SymbolService.java`
```java
【修改方式】：在查询方法上添加注解
【需要修改的方法】：
- getActiveSymbols()                                   → @Transactional(readOnly = true)
- getSymbolById(Long symbolId)                         → @Transactional(readOnly = true)
- getSymbolByName(String symbol)                       → @Transactional(readOnly = true)
- getAllSymbols()                                      → @Transactional(readOnly = true)
- getBtseSymbolById(Long symbolId)                     → @Transactional(readOnly = true)

【不需要修改的方法】：
- updateSymbolConfig() / enableSymbol()                → 保持 @Transactional

【预计修改】：5-6个方法
```

#### 📄 `option-order-service/.../TradingRoundService.java`
```java
【修改方式】：在查询方法上添加注解
【需要修改的方法】：
- getCurrentRound(Long symbolId)                       → @Transactional(readOnly = true)
- getRoundById(Long roundId)                           → @Transactional(readOnly = true)
- getRoundHistory(Long symbolId, Integer limit)        → @Transactional(readOnly = true)
- getRoundStatistics(Long roundId)                     → @Transactional(readOnly = true)
- getOrCreateRoundForDuration(...)                     → @Transactional(readOnly = true)

【不需要修改的方法】：
- createRound() / updateRoundStatus()                  → 保持 @Transactional
- lockRound() / settleRound()                          → 保持 @Transactional

【预计修改】：4-6个方法
```

#### 📄 `option-order-service/.../OrderStatisticsService.java`
```java
【修改方式】：所有方法都是查询，全部添加 readOnly
【需要修改的方法】：
- calculateUserStatistics(Long userId)                 → @Transactional(readOnly = true)
- getRoundStatistics(Long roundId)                     → @Transactional(readOnly = true)
- getSymbolStatistics(Long symbolId)                   → @Transactional(readOnly = true)

【预计修改】：3-4个方法
```

#### 📄 `option-order-service/.../FixtureService.java`
```java
【修改方式】：查询方法添加 readOnly
【需要修改的方法】：
- selectFixtureForOrder() - 如果只查询不写入                → @Transactional(readOnly = true)

【不需要修改的方法】：
- performOrderHedge() - 涉及外部API调用                   → 保持 @Transactional

【预计修改】：1-2个方法
```

#### 📄 `option-market-service/.../MarketService.java`
```java
【修改方式】：大部分是查询，几乎都要加 readOnly
【需要修改的方法】：
- getMarketData(String symbol)                         → @Transactional(readOnly = true)
- getKlineData(String symbol, String interval)         → @Transactional(readOnly = true)
- getMarketStatistics()                                → @Transactional(readOnly = true)

【预计修改】：3-5个方法
```

## 三、修改工作量估算

### 3.1 按文件类型分类

| 文件类型 | 数量 | 预计工作量 | 难度 |
|---------|------|-----------|------|
| **新增Java类** | 3个 | 2小时 | 中等 |
| **修改配置文件** | 3个 | 30分钟 | 简单 |
| **修改Service类** | 9个 | 3小时 | 简单 |
| **测试验证** | - | 2小时 | 简单 |
| **总计** | 15个文件 | **7.5小时** | **中等** |

### 3.2 按服务分类

| 服务 | 修改文件数 | 方法数量 | 工作量 |
|------|-----------|---------|--------|
| **option-common-utils** | 3个新增 | - | 2小时 |
| **option-common-service** | 4个修改 | 15-20个方法 | 1.5小时 |
| **option-order-service** | 6个修改 | 25-35个方法 | 2.5小时 |
| **option-market-service** | 2个修改 | 5-8个方法 | 0.5小时 |
| **集成测试** | - | - | 1小时 |

### 3.3 关键注意事项

#### ⚠️ **容易出错的地方**
1. **配置文件**：数据库连接信息要确认正确
2. **包名导入**：新增的类要确保 import 路径正确
3. **注解位置**：`@Transactional(readOnly = true)` 要加在正确的方法上
4. **混合操作**：包含查询+写入的方法不能加 `readOnly = true`

#### ✅ **验证要点**
1. **启动验证**：所有服务能正常启动
2. **日志验证**：看到 "uses SLAVE datasource" 和 "uses MASTER datasource" 日志
3. **功能验证**：核心业务流程正常工作
4. **性能验证**：查询性能有所提升

#### 🔄 **回滚方案**
1. **快速回滚**：配置文件中设置 `enabled: false`
2. **完全回滚**：删除新增文件，恢复Service方法注解

这个清单确保了实施过程的可控性和可追踪性！