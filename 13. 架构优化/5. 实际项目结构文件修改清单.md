# è¯»å†™åˆ†ç¦»å®æ–½ - å®é™…é¡¹ç›®ç»“æ„æ–‡ä»¶ä¿®æ”¹æ¸…å•

## ä¸€ã€æ–‡ä»¶æ ‘å½¢ç»“æ„ï¼ˆåŸºäºå®é™…é¡¹ç›®ç»“æ„ï¼‰

```
BinaryOption/
â”œâ”€â”€ option-common-utils/
â”‚   â””â”€â”€ src/main/java/com/binaryoption/commonutils/
â”‚       â”œâ”€â”€ datasource/                                     ã€æ–°å¢ç›®å½•ã€‘
â”‚       â”‚   â”œâ”€â”€ DynamicDataSource.java                    ã€æ–°å¢ã€‘åŠ¨æ€æ•°æ®æºè·¯ç”±
â”‚       â”‚   â””â”€â”€ ReadWriteDataSourceAspect.java             ã€æ–°å¢ã€‘è¯»å†™åˆ†ç¦»AOPåˆ‡é¢
â”‚       â””â”€â”€ config/
â”‚           â””â”€â”€ DataSourceConfig.java                      ã€æ–°å¢ã€‘æ•°æ®æºé…ç½®ç±»
â”‚
â”œâ”€â”€ option-common-service/
â”‚   â”œâ”€â”€ src/main/resources/
â”‚   â”‚   â””â”€â”€ application.yml                                ã€ä¿®æ”¹ã€‘æ·»åŠ ä¸»ä»æ•°æ®æºé…ç½®
â”‚   â””â”€â”€ src/main/java/com/binaryoption/commonservice/service/
â”‚       â”œâ”€â”€ AccountService.java                            ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â”œâ”€â”€ UserService.java                               ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â”œâ”€â”€ BtseTransferService.java                       ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â”œâ”€â”€ GlobalConfigService.java                       ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â””â”€â”€ ReconciliationService.java                     ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚
â”œâ”€â”€ option-order-service/
â”‚   â”œâ”€â”€ src/main/resources/
â”‚   â”‚   â””â”€â”€ application.yml                                ã€ä¿®æ”¹ã€‘æ·»åŠ ä¸»ä»æ•°æ®æºé…ç½®
â”‚   â””â”€â”€ src/main/java/com/binaryoption/orderservice/service/
â”‚       â”œâ”€â”€ OrderService.java                              ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â”œâ”€â”€ SymbolService.java                             ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â”œâ”€â”€ TradingRoundService.java                       ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â”œâ”€â”€ OrderStatisticsService.java                    ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â”œâ”€â”€ FixtureService.java                            ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â”œâ”€â”€ OrderHedgeService.java                         ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â”œâ”€â”€ OrderSettlementService.java                    ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â”œâ”€â”€ RiskControlService.java                        ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚       â””â”€â”€ UserRiskStatsService.java                      ã€ä¿®æ”¹ã€‘æŸ¥è¯¢æ–¹æ³•æ·»åŠ @Transactional(readOnly=true)
â”‚
â””â”€â”€ option-market-service/
    â””â”€â”€ ï¼ˆä¸éœ€è¦ä¿®æ”¹ - è¯¥æœåŠ¡ä¸ä½¿ç”¨æ•°æ®åº“ï¼Œä¸»è¦æ˜¯WebSocketå’Œå¤–éƒ¨APIé›†æˆï¼‰
```

## äºŒã€æ–‡ä»¶ç»Ÿè®¡å’Œå·¥ä½œé‡

### 2.1 æ–°å¢æ–‡ä»¶ï¼ˆ3ä¸ªæ–‡ä»¶ï¼Œ2å°æ—¶ï¼‰

| æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ | ä»£ç è¡Œæ•° | å·¥ä½œé‡ |
|---------|------|---------|--------|
| `option-common-utils/.../datasource/DynamicDataSource.java` | åŠ¨æ€æ•°æ®æºè·¯ç”± | ~80è¡Œ | 45åˆ†é’Ÿ |
| `option-common-utils/.../datasource/ReadWriteDataSourceAspect.java` | AOPåˆ‡é¢æ‹¦æˆª | ~60è¡Œ | 45åˆ†é’Ÿ |
| `option-common-utils/.../config/DataSourceConfig.java` | é…ç½®æ•´åˆ | ~100è¡Œ | 30åˆ†é’Ÿ |

### 2.2 ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆ2ä¸ªæ–‡ä»¶ï¼Œ20åˆ†é’Ÿï¼‰

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | å·¥ä½œé‡ |
|---------|---------|--------|
| `option-common-service/src/main/resources/application.yml` | æ·»åŠ ä¸»ä»æ•°æ®æºé…ç½® | 10åˆ†é’Ÿ |
| `option-order-service/src/main/resources/application.yml` | æ·»åŠ ä¸»ä»æ•°æ®æºé…ç½® | 10åˆ†é’Ÿ |
| ~~`option-market-service/src/main/resources/application.yml`~~ | ~~ä¸éœ€è¦ä¿®æ”¹ï¼ˆæ— æ•°æ®åº“æ“ä½œï¼‰~~ | ~~0åˆ†é’Ÿ~~ |

### 2.3 ä¿®æ”¹Serviceæ–‡ä»¶ï¼ˆ14ä¸ªæ–‡ä»¶ï¼Œ3.5å°æ—¶ï¼‰

#### **option-common-service (5ä¸ªæ–‡ä»¶ï¼Œ1.5å°æ—¶ï¼‰**
| æ–‡ä»¶ | é¢„è®¡æŸ¥è¯¢æ–¹æ³•æ•° | å·¥ä½œé‡ | è¯´æ˜ |
|------|---------------|--------|------|
| `AccountService.java` | 8-10ä¸ª | 30åˆ†é’Ÿ | æ ¸å¿ƒä¸šåŠ¡æœåŠ¡ï¼Œæ–¹æ³•è¾ƒå¤š |
| `UserService.java` | 5-8ä¸ª | 20åˆ†é’Ÿ | ç”¨æˆ·ç›¸å…³æŸ¥è¯¢ |
| `BtseTransferService.java` | 4-6ä¸ª | 20åˆ†é’Ÿ | è½¬è´¦è®°å½•æŸ¥è¯¢ |
| `GlobalConfigService.java` | 2-3ä¸ª | 10åˆ†é’Ÿ | é…ç½®æŸ¥è¯¢ |
| `ReconciliationService.java` | 2-3ä¸ª | 10åˆ†é’Ÿ | å¯¹è´¦æŸ¥è¯¢ |

#### **option-order-service (9ä¸ªæ–‡ä»¶ï¼Œ2å°æ—¶ï¼‰**
| æ–‡ä»¶ | é¢„è®¡æŸ¥è¯¢æ–¹æ³•æ•° | å·¥ä½œé‡ | è¯´æ˜ |
|------|---------------|--------|------|
| `OrderService.java` | 10-15ä¸ª | 30åˆ†é’Ÿ | æœ€å¤æ‚çš„æœåŠ¡ |
| `SymbolService.java` | 5-8ä¸ª | 20åˆ†é’Ÿ | äº¤æ˜“å¯¹æŸ¥è¯¢ |
| `TradingRoundService.java` | 5-8ä¸ª | 20åˆ†é’Ÿ | è½®æ¬¡æŸ¥è¯¢ |
| `OrderStatisticsService.java` | 3-5ä¸ª | 15åˆ†é’Ÿ | ç»Ÿè®¡æŸ¥è¯¢ |
| `OrderHedgeService.java` | 2-4ä¸ª | 15åˆ†é’Ÿ | å¯¹å†²æŸ¥è¯¢ |
| `OrderSettlementService.java` | 2-4ä¸ª | 15åˆ†é’Ÿ | ç»“ç®—æŸ¥è¯¢ |
| `RiskControlService.java` | 3-5ä¸ª | 15åˆ†é’Ÿ | é£æ§æŸ¥è¯¢ |
| `UserRiskStatsService.java` | 2-3ä¸ª | 10åˆ†é’Ÿ | ç”¨æˆ·é£é™©ç»Ÿè®¡ |
| `FixtureService.java` | 1-2ä¸ª | 10åˆ†é’Ÿ | æœŸæƒåˆçº¦ï¼ˆä¸»è¦æ˜¯å¤–éƒ¨APIï¼‰ |

#### **option-market-serviceï¼ˆæ— éœ€ä¿®æ”¹ï¼‰**
```
âœ… ç¡®è®¤ï¼šmarket-service ä¸ä½¿ç”¨æ•°æ®åº“
- integration/ ç›®å½•ï¼šå¤–éƒ¨BTSE APIé›†æˆï¼Œæ— æ•°æ®åº“æ“ä½œ
- ws/ ç›®å½•ï¼šWebSocketå®æ—¶æ•°æ®æ¨é€ï¼Œæ— æ•°æ®åº“æ“ä½œ
- è¯¥æœåŠ¡çº¯ç²¹å¤„ç†å¤–éƒ¨APIå’ŒWebSocketï¼Œæ— éœ€è¯»å†™åˆ†ç¦»é…ç½®
```

## ä¸‰ã€å®æ–½ä¼˜å…ˆçº§

### ğŸš€ **ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼Œå¿…é¡»å®æ–½ï¼‰**
```
1. option-common-utilsï¼ˆæ–°å¢3ä¸ªæ ¸å¿ƒç±»ï¼‰
2. option-common-service/AccountService.java
3. option-order-service/OrderService.java  
4. é…ç½®æ–‡ä»¶ä¿®æ”¹ï¼ˆ2ä¸ªapplication.ymlï¼‰
```

### ğŸ“ˆ **ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆé‡è¦æŸ¥è¯¢æœåŠ¡ï¼‰**
```
5. option-common-service/UserService.java
6. option-order-service/SymbolService.java
7. option-order-service/TradingRoundService.java
8. option-common-service/BtseTransferService.java
```

### ğŸ”§ **ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆè¾…åŠ©æœåŠ¡ï¼‰**
```
9. option-order-service å‰©ä½™6ä¸ªServiceæ–‡ä»¶
10. option-common-service å‰©ä½™2ä¸ªServiceæ–‡ä»¶
```

### âŒ **æ— éœ€ä¿®æ”¹**
```
âœ… option-market-service - ç¡®è®¤ä¸ä½¿ç”¨æ•°æ®åº“ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹
```

## å››ã€å…·ä½“å®æ–½æ­¥éª¤

### Step 1: åŸºç¡€æ¶æ„æ­å»ºï¼ˆ1å°æ—¶ï¼‰
```bash
# 1. åˆ›å»ºç›®å½•å’Œæ ¸å¿ƒç±»
mkdir -p option-common-utils/src/main/java/com/binaryoption/commonutils/datasource

# 2. ç¼–å†™3ä¸ªæ ¸å¿ƒJavaç±»
# - DynamicDataSource.java
# - ReadWriteDataSourceAspect.java  
# - DataSourceConfig.java

# 3. ä¿®æ”¹2ä¸ªapplication.ymlé…ç½®æ–‡ä»¶ï¼ˆcommon-service å’Œ order-serviceï¼‰
```

### Step 2: æ ¸å¿ƒæœåŠ¡æ”¹é€ ï¼ˆ1å°æ—¶ï¼‰
```bash
# ä¿®æ”¹æœ€é‡è¦çš„2ä¸ªæœåŠ¡
# - AccountService.java
# - OrderService.java

# å¯åŠ¨æµ‹è¯•ï¼Œç¡®ä¿åŸºç¡€åŠŸèƒ½æ­£å¸¸
```

### Step 3: å…¶ä»–æœåŠ¡é€æ­¥æ”¹é€ ï¼ˆ2.5å°æ—¶ï¼‰
```bash
# æŒ‰ä¼˜å…ˆçº§é€ä¸ªä¿®æ”¹å‰©ä½™çš„Serviceæ–‡ä»¶
# æ¯ä¿®æ”¹ä¸€ä¸ªæœåŠ¡å°±æµ‹è¯•ä¸€æ¬¡
```

### Step 4: éªŒè¯å’Œä¼˜åŒ–ï¼ˆ1å°æ—¶ï¼‰
```bash
# 1. åŠŸèƒ½æµ‹è¯•
# 2. æ€§èƒ½æµ‹è¯•  
# 3. æ—¥å¿—éªŒè¯
# 4. ç›‘æ§é…ç½®
```

## äº”ã€é£é™©ç‚¹å’Œæ³¨æ„äº‹é¡¹

### âš ï¸ **æ½œåœ¨é£é™©**
1. **market-serviceç»“æ„ç‰¹æ®Š**ï¼šä¸»è¦æ˜¯integrationå±‚ï¼Œå¯èƒ½ä¸éœ€è¦æ•°æ®åº“äº‹åŠ¡
2. **é…ç½®å†²çª**ï¼šç°æœ‰é…ç½®æ–‡ä»¶å¯èƒ½æœ‰è‡ªå®šä¹‰é…ç½®éœ€è¦ä¿ç•™
3. **æµ‹è¯•ç¯å¢ƒ**ï¼šéœ€è¦å‡†å¤‡ä»åº“ç¯å¢ƒè¿›è¡Œæµ‹è¯•

### âœ… **ç¼“è§£æªæ–½**
1. **åˆ†æ­¥å®æ–½**ï¼šå…ˆå®æ–½æ ¸å¿ƒæœåŠ¡ï¼Œç¡®ä¿ç¨³å®šåå†æ‰©å±•
2. **é…ç½®å¼€å…³**ï¼šæ·»åŠ  `enabled: false` é…ç½®ï¼Œæ”¯æŒå¿«é€Ÿå›æ»š
3. **å……åˆ†æµ‹è¯•**ï¼šæ¯ä¸ªæ­¥éª¤éƒ½è¦éªŒè¯åŠŸèƒ½æ­£å¸¸

### ğŸ” **éªŒè¯æ–¹æ³•**
```bash
# 1. æ—¥å¿—éªŒè¯
grep "uses SLAVE datasource" logs/*.log
grep "uses MASTER datasource" logs/*.log

# 2. æ•°æ®åº“è¿æ¥éªŒè¯
# ä¸»åº“è¿æ¥æ•°åº”è¯¥å‡å°‘ï¼Œä»åº“è¿æ¥æ•°åº”è¯¥å¢åŠ 

# 3. åŠŸèƒ½éªŒè¯
# è¿è¡Œç°æœ‰çš„æµ‹è¯•è„šæœ¬ç¡®ä¿ä¸šåŠ¡åŠŸèƒ½æ­£å¸¸
./test-scripts/simple-flow-test-oauth.sh
```

## å…­ã€æ€»ç»“

### ğŸ“Š **å·¥ä½œé‡æ±‡æ€»**
- **æ€»æ–‡ä»¶æ•°**ï¼š17ä¸ªï¼ˆ3æ–°å¢ + 14ä¿®æ”¹ï¼‰
- **æ€»å·¥ä½œé‡**ï¼šçº¦5.5å°æ—¶
- **å…³é”®è·¯å¾„**ï¼šæ ¸å¿ƒæ¶æ„(1h) â†’ æ ¸å¿ƒæœåŠ¡(1h) â†’ å…¶ä»–æœåŠ¡(2.5h) â†’ éªŒè¯(1h)
- **ç®€åŒ–ç‚¹**ï¼šmarket-service æ— éœ€ä¿®æ”¹ï¼ŒèŠ‚çœäº†30åˆ†é’Ÿ

### ğŸ¯ **æˆåŠŸæ ‡å‡†**
1. âœ… æ‰€æœ‰æœåŠ¡æ­£å¸¸å¯åŠ¨
2. âœ… æŸ¥è¯¢æ“ä½œè‡ªåŠ¨èµ°ä»åº“ï¼ˆæ—¥å¿—å¯è§ï¼‰
3. âœ… å†™æ“ä½œè‡ªåŠ¨èµ°ä¸»åº“ï¼ˆæ—¥å¿—å¯è§ï¼‰
4. âœ… æ ¸å¿ƒä¸šåŠ¡æµç¨‹æµ‹è¯•é€šè¿‡
5. âœ… æŸ¥è¯¢æ€§èƒ½æœ‰æ‰€æå‡

**è¿™ä¸ªåŸºäºå®é™…é¡¹ç›®ç»“æ„çš„æ–¹æ¡ˆæ›´åŠ å‡†ç¡®å’Œå¯æ“ä½œï¼**