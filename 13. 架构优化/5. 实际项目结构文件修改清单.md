# 读写分离实施 - 实际项目结构文件修改清单

## 一、文件树形结构（基于实际项目结构）

```
BinaryOption/
├── option-common-utils/
│   └── src/main/java/com/binaryoption/commonutils/
│       ├── datasource/                                     【新增目录】
│       │   ├── DynamicDataSource.java                    【新增】动态数据源路由
│       │   └── ReadWriteDataSourceAspect.java             【新增】读写分离AOP切面
│       └── config/
│           └── DataSourceConfig.java                      【新增】数据源配置类
│
├── option-common-service/
│   ├── src/main/resources/
│   │   └── application.yml                                【修改】添加主从数据源配置
│   └── src/main/java/com/binaryoption/commonservice/service/
│       ├── AccountService.java                            【修改】查询方法添加@Transactional(readOnly=true)
│       ├── UserService.java                               【修改】查询方法添加@Transactional(readOnly=true)
│       ├── BtseTransferService.java                       【修改】查询方法添加@Transactional(readOnly=true)
│       ├── GlobalConfigService.java                       【修改】查询方法添加@Transactional(readOnly=true)
│       └── ReconciliationService.java                     【修改】查询方法添加@Transactional(readOnly=true)
│
├── option-order-service/
│   ├── src/main/resources/
│   │   └── application.yml                                【修改】添加主从数据源配置
│   └── src/main/java/com/binaryoption/orderservice/service/
│       ├── OrderService.java                              【修改】查询方法添加@Transactional(readOnly=true)
│       ├── SymbolService.java                             【修改】查询方法添加@Transactional(readOnly=true)
│       ├── TradingRoundService.java                       【修改】查询方法添加@Transactional(readOnly=true)
│       ├── OrderStatisticsService.java                    【修改】查询方法添加@Transactional(readOnly=true)
│       ├── FixtureService.java                            【修改】查询方法添加@Transactional(readOnly=true)
│       ├── OrderHedgeService.java                         【修改】查询方法添加@Transactional(readOnly=true)
│       ├── OrderSettlementService.java                    【修改】查询方法添加@Transactional(readOnly=true)
│       ├── RiskControlService.java                        【修改】查询方法添加@Transactional(readOnly=true)
│       └── UserRiskStatsService.java                      【修改】查询方法添加@Transactional(readOnly=true)
│
└── option-market-service/
    └── （不需要修改 - 该服务不使用数据库，主要是WebSocket和外部API集成）
```

## 二、文件统计和工作量

### 2.1 新增文件（3个文件，2小时）

| 文件路径 | 功能 | 代码行数 | 工作量 |
|---------|------|---------|--------|
| `option-common-utils/.../datasource/DynamicDataSource.java` | 动态数据源路由 | ~80行 | 45分钟 |
| `option-common-utils/.../datasource/ReadWriteDataSourceAspect.java` | AOP切面拦截 | ~60行 | 45分钟 |
| `option-common-utils/.../config/DataSourceConfig.java` | 配置整合 | ~100行 | 30分钟 |

### 2.2 修改配置文件（2个文件，20分钟）

| 文件路径 | 修改内容 | 工作量 |
|---------|---------|--------|
| `option-common-service/src/main/resources/application.yml` | 添加主从数据源配置 | 10分钟 |
| `option-order-service/src/main/resources/application.yml` | 添加主从数据源配置 | 10分钟 |
| ~~`option-market-service/src/main/resources/application.yml`~~ | ~~不需要修改（无数据库操作）~~ | ~~0分钟~~ |

### 2.3 修改Service文件（14个文件，3.5小时）

#### **option-common-service (5个文件，1.5小时）**
| 文件 | 预计查询方法数 | 工作量 | 说明 |
|------|---------------|--------|------|
| `AccountService.java` | 8-10个 | 30分钟 | 核心业务服务，方法较多 |
| `UserService.java` | 5-8个 | 20分钟 | 用户相关查询 |
| `BtseTransferService.java` | 4-6个 | 20分钟 | 转账记录查询 |
| `GlobalConfigService.java` | 2-3个 | 10分钟 | 配置查询 |
| `ReconciliationService.java` | 2-3个 | 10分钟 | 对账查询 |

#### **option-order-service (9个文件，2小时）**
| 文件 | 预计查询方法数 | 工作量 | 说明 |
|------|---------------|--------|------|
| `OrderService.java` | 10-15个 | 30分钟 | 最复杂的服务 |
| `SymbolService.java` | 5-8个 | 20分钟 | 交易对查询 |
| `TradingRoundService.java` | 5-8个 | 20分钟 | 轮次查询 |
| `OrderStatisticsService.java` | 3-5个 | 15分钟 | 统计查询 |
| `OrderHedgeService.java` | 2-4个 | 15分钟 | 对冲查询 |
| `OrderSettlementService.java` | 2-4个 | 15分钟 | 结算查询 |
| `RiskControlService.java` | 3-5个 | 15分钟 | 风控查询 |
| `UserRiskStatsService.java` | 2-3个 | 10分钟 | 用户风险统计 |
| `FixtureService.java` | 1-2个 | 10分钟 | 期权合约（主要是外部API） |

#### **option-market-service（无需修改）**
```
✅ 确认：market-service 不使用数据库
- integration/ 目录：外部BTSE API集成，无数据库操作
- ws/ 目录：WebSocket实时数据推送，无数据库操作
- 该服务纯粹处理外部API和WebSocket，无需读写分离配置
```

## 三、实施优先级

### 🚀 **第一优先级（核心业务，必须实施）**
```
1. option-common-utils（新增3个核心类）
2. option-common-service/AccountService.java
3. option-order-service/OrderService.java  
4. 配置文件修改（2个application.yml）
```

### 📈 **第二优先级（重要查询服务）**
```
5. option-common-service/UserService.java
6. option-order-service/SymbolService.java
7. option-order-service/TradingRoundService.java
8. option-common-service/BtseTransferService.java
```

### 🔧 **第三优先级（辅助服务）**
```
9. option-order-service 剩余6个Service文件
10. option-common-service 剩余2个Service文件
```

### ❌ **无需修改**
```
✅ option-market-service - 确认不使用数据库，无需任何修改
```

## 四、具体实施步骤

### Step 1: 基础架构搭建（1小时）
```bash
# 1. 创建目录和核心类
mkdir -p option-common-utils/src/main/java/com/binaryoption/commonutils/datasource

# 2. 编写3个核心Java类
# - DynamicDataSource.java
# - ReadWriteDataSourceAspect.java  
# - DataSourceConfig.java

# 3. 修改2个application.yml配置文件（common-service 和 order-service）
```

### Step 2: 核心服务改造（1小时）
```bash
# 修改最重要的2个服务
# - AccountService.java
# - OrderService.java

# 启动测试，确保基础功能正常
```

### Step 3: 其他服务逐步改造（2.5小时）
```bash
# 按优先级逐个修改剩余的Service文件
# 每修改一个服务就测试一次
```

### Step 4: 验证和优化（1小时）
```bash
# 1. 功能测试
# 2. 性能测试  
# 3. 日志验证
# 4. 监控配置
```

## 五、风险点和注意事项

### ⚠️ **潜在风险**
1. **market-service结构特殊**：主要是integration层，可能不需要数据库事务
2. **配置冲突**：现有配置文件可能有自定义配置需要保留
3. **测试环境**：需要准备从库环境进行测试

### ✅ **缓解措施**
1. **分步实施**：先实施核心服务，确保稳定后再扩展
2. **配置开关**：添加 `enabled: false` 配置，支持快速回滚
3. **充分测试**：每个步骤都要验证功能正常

### 🔍 **验证方法**
```bash
# 1. 日志验证
grep "uses SLAVE datasource" logs/*.log
grep "uses MASTER datasource" logs/*.log

# 2. 数据库连接验证
# 主库连接数应该减少，从库连接数应该增加

# 3. 功能验证
# 运行现有的测试脚本确保业务功能正常
./test-scripts/simple-flow-test-oauth.sh
```

## 六、总结

### 📊 **工作量汇总**
- **总文件数**：17个（3新增 + 14修改）
- **总工作量**：约5.5小时
- **关键路径**：核心架构(1h) → 核心服务(1h) → 其他服务(2.5h) → 验证(1h)
- **简化点**：market-service 无需修改，节省了30分钟

### 🎯 **成功标准**
1. ✅ 所有服务正常启动
2. ✅ 查询操作自动走从库（日志可见）
3. ✅ 写操作自动走主库（日志可见）
4. ✅ 核心业务流程测试通过
5. ✅ 查询性能有所提升

**这个基于实际项目结构的方案更加准确和可操作！**