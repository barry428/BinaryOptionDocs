# å¼€å‘ç¯å¢ƒè¯»å†™åˆ†ç¦»é…ç½®æ–¹æ¡ˆ

## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 å¼€å‘ç¯å¢ƒç‰¹ç‚¹
- **å•æ•°æ®åº“**ï¼šåªæœ‰ä¸€ä¸ªæ•°æ®åº“å®ä¾‹
- **ç›®æ ‡**ï¼šéªŒè¯è¯»å†™åˆ†ç¦»é€»è¾‘ï¼Œä½†ä¸éœ€è¦çœŸæ­£çš„ä¸»ä»å¤åˆ¶
- **æ–¹æ¡ˆ**ï¼šä¸»åº“å’Œä»åº“é…ç½®ä¸ºåŒä¸€ä¸ªæ•°æ®åº“ï¼Œé€šè¿‡æ—¥å¿—ç›‘æ§è·¯ç”±æ•ˆæœ

### 1.2 æŠ€æœ¯å®ç°
```yaml
# æ ¸å¿ƒæ€è·¯ï¼šä¸¤ä¸ªæ•°æ®æºæŒ‡å‘åŒä¸€ä¸ªæ•°æ®åº“
spring:
  datasource:
    master: 
      jdbc-url: jdbc:postgresql://localhost:5433/binary_option  # åŒä¸€ä¸ªåº“
    slave:  
      jdbc-url: jdbc:postgresql://localhost:5433/binary_option  # åŒä¸€ä¸ªåº“
```

## äºŒã€è¯¦ç»†é…ç½®

### 2.1 å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶

#### ğŸ“„ `option-common-service/src/main/resources/application-dev.yml`
```yaml
spring:
  datasource:
    # ä¸»åº“é…ç½®
    master:
      jdbc-url: jdbc:postgresql://localhost:5433/binary_option
      username: postgres
      password: root
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: MasterHikariPool-DEV
        minimum-idle: 5
        maximum-pool-size: 10
        connection-timeout: 30000
        
    # ä»åº“é…ç½®ï¼ˆæŒ‡å‘åŒä¸€ä¸ªæ•°æ®åº“ï¼‰
    slave:
      jdbc-url: jdbc:postgresql://localhost:5433/binary_option  # ğŸ‘ˆ åŒä¸€ä¸ªæ•°æ®åº“
      username: postgres
      password: root
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: SlaveHikariPool-DEV
        minimum-idle: 3
        maximum-pool-size: 8
        connection-timeout: 30000

# è¯»å†™åˆ†ç¦»é…ç½®
datasource:
  read-write-separation:
    enabled: true                    # å¯ç”¨è¯»å†™åˆ†ç¦»é€»è¾‘
    fallback-to-master: true

# æ—¥å¿—é…ç½® - è¯¦ç»†æ˜¾ç¤ºæ•°æ®æºåˆ‡æ¢
logging:
  level:
    com.binaryoption.commonutils.datasource: DEBUG  # æ˜¾ç¤ºæ•°æ®æºåˆ‡æ¢æ—¥å¿—
    com.zaxxer.hikari: DEBUG                         # æ˜¾ç¤ºè¿æ¥æ± æ—¥å¿—
    root: INFO
```

#### ğŸ“„ `option-order-service/src/main/resources/application-dev.yml`
```yaml
# ä¸ common-service ç›¸åŒçš„é…ç½®
spring:
  datasource:
    master:
      jdbc-url: jdbc:postgresql://localhost:5433/binary_option
      username: postgres
      password: root
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: MasterHikariPool-OrderService-DEV
        minimum-idle: 5
        maximum-pool-size: 10
        
    slave:
      jdbc-url: jdbc:postgresql://localhost:5433/binary_option  # ğŸ‘ˆ åŒä¸€ä¸ªæ•°æ®åº“
      username: postgres
      password: root
      driver-class-name: org.postgresql.Driver
      hikari:
        pool-name: SlaveHikariPool-OrderService-DEV
        minimum-idle: 3
        maximum-pool-size: 8

datasource:
  read-write-separation:
    enabled: true
    fallback-to-master: true

logging:
  level:
    com.binaryoption.commonutils.datasource: DEBUG
    com.zaxxer.hikari: DEBUG
```

### 2.2 å¢å¼ºçš„æ—¥å¿—é…ç½®

#### ğŸ“„ `logback-spring.xml` å¢å¼ºé…ç½®
```xml
<!-- åœ¨ç°æœ‰çš„ logback-spring.xml ä¸­æ·»åŠ ä»¥ä¸‹é…ç½® -->

<!-- æ•°æ®æºåˆ‡æ¢ä¸“ç”¨æ—¥å¿— -->
<logger name="com.binaryoption.commonutils.datasource" level="DEBUG" additivity="false">
    <appender-ref ref="CONSOLE"/>
    <appender-ref ref="APPLICATION_FILE"/>
</logger>

<!-- HikariCP è¿æ¥æ± æ—¥å¿— -->
<logger name="com.zaxxer.hikari" level="DEBUG" additivity="false">
    <appender-ref ref="CONSOLE"/>
    <appender-ref ref="APPLICATION_FILE"/>
</logger>

<!-- ä¸ºå¼€å‘ç¯å¢ƒæ·»åŠ å½©è‰²è¾“å‡º -->
<springProfile name="dev">
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %highlight(%-5level) %cyan(%logger{36}) - %msg%n</pattern>
        </encoder>
    </appender>
</springProfile>
```

## ä¸‰ã€ç›‘æ§å’ŒéªŒè¯

### 3.1 æ—¥å¿—è¾“å‡ºç¤ºä¾‹

#### **æŸ¥è¯¢æ“ä½œæ—¥å¿—**
```log
# æ‰§è¡ŒæŸ¥è¯¢æ—¶çš„æ—¥å¿—è¾“å‡º
14:23:45.123 [http-nio-8081-exec-1] DEBUG c.b.c.d.ReadWriteDataSourceAspect - Method [getOrder] uses SLAVE datasource
14:23:45.124 [http-nio-8081-exec-1] DEBUG c.b.c.d.DynamicDataSource - Current DataSource: SLAVE
14:23:45.125 [HikariPool-SlaveHikariPool-DEV] DEBUG com.zaxxer.hikari.HikariDataSource - SlaveHikariPool-DEV - Starting...
14:23:45.126 [HikariPool-SlaveHikariPool-DEV] DEBUG com.zaxxer.hikari.HikariDataSource - SlaveHikariPool-DEV - Start completed.
14:23:45.135 [http-nio-8081-exec-1] INFO  c.b.c.s.OrderService - [TIMING] OrderService getOrder 12ms
```

#### **å†™æ“ä½œæ—¥å¿—**
```log
# æ‰§è¡Œå†™æ“ä½œæ—¶çš„æ—¥å¿—è¾“å‡º
14:25:32.456 [http-nio-8081-exec-2] DEBUG c.b.c.d.ReadWriteDataSourceAspect - Method [createOrder] uses MASTER datasource
14:25:32.457 [http-nio-8081-exec-2] DEBUG c.b.c.d.DynamicDataSource - Current DataSource: MASTER
14:25:32.458 [HikariPool-MasterHikariPool-DEV] DEBUG com.zaxxer.hikari.HikariDataSource - MasterHikariPool-DEV - Starting...
14:25:32.459 [HikariPool-MasterHikariPool-DEV] DEBUG com.zaxxer.hikari.HikariDataSource - MasterHikariPool-DEV - Start completed.
14:25:32.478 [http-nio-8081-exec-2] INFO  c.b.c.s.OrderService - [TIMING] OrderService createOrder 25ms
```

### 3.2 éªŒè¯è„šæœ¬

#### ğŸ“„ `test-scripts/verify-datasource-routing.sh`
```bash
#!/bin/bash

echo "=== è¯»å†™åˆ†ç¦»è·¯ç”±éªŒè¯è„šæœ¬ ==="

# é…ç½®
source common/config-dev.sh

# 1. æ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼Œæ£€æŸ¥æ—¥å¿—
echo "1. æµ‹è¯•æŸ¥è¯¢æ“ä½œï¼ˆåº”è¯¥ä½¿ç”¨ SLAVEï¼‰"
curl -s "$API_BASE/api/order/1" > /dev/null
sleep 1

echo "2. æµ‹è¯•åˆ›å»ºæ“ä½œï¼ˆåº”è¯¥ä½¿ç”¨ MASTERï¼‰"
curl -s -X POST "$API_BASE/api/order" \
  -H "Content-Type: application/json" \
  -d '{"amount": 100, "direction": "UP"}' > /dev/null
sleep 1

echo "3. åˆ†ææœ€è¿‘çš„æ—¥å¿—"
echo "=== SLAVE æ•°æ®æºä½¿ç”¨æƒ…å†µ ==="
tail -n 100 logs/option-order-service-application.log | grep "uses SLAVE datasource" | tail -5

echo "=== MASTER æ•°æ®æºä½¿ç”¨æƒ…å†µ ==="
tail -n 100 logs/option-order-service-application.log | grep "uses MASTER datasource" | tail -5

echo "=== è¿æ¥æ± ä½¿ç”¨æƒ…å†µ ==="
tail -n 100 logs/option-order-service-application.log | grep "HikariPool.*DEV" | tail -10
```

### 3.3 å®æ—¶ç›‘æ§è„šæœ¬

#### ğŸ“„ `test-scripts/monitor-datasource-realtime.sh`
```bash
#!/bin/bash

echo "=== å®æ—¶ç›‘æ§æ•°æ®æºè·¯ç”± ==="
echo "æŒ‰ Ctrl+C åœæ­¢ç›‘æ§"

# å®æ—¶è·Ÿè¸ªæ—¥å¿—
tail -f logs/option-*-application.log | grep --line-buffered -E "(uses SLAVE|uses MASTER|HikariPool.*DEV)" | while read line; do
    timestamp=$(date '+%H:%M:%S')
    
    if echo "$line" | grep -q "uses SLAVE"; then
        echo "[$timestamp] ğŸ”µ READ  -> SLAVE: $line"
    elif echo "$line" | grep -q "uses MASTER"; then
        echo "[$timestamp] ğŸ”´ WRITE -> MASTER: $line"
    elif echo "$line" | grep -q "HikariPool"; then
        echo "[$timestamp] ğŸ”— POOL: $line"
    fi
done
```

## å››ã€è¿æ¥æ± åŒºåˆ†ç­–ç•¥

### 4.1 é€šè¿‡è¿æ¥æ± åç§°åŒºåˆ†

```yaml
# å³ä½¿æŒ‡å‘åŒä¸€ä¸ªæ•°æ®åº“ï¼Œä¹Ÿä½¿ç”¨ä¸åŒçš„è¿æ¥æ± åç§°
spring:
  datasource:
    master:
      hikari:
        pool-name: "MasterPool-${spring.application.name}-DEV"  # ä¸»åº“è¿æ¥æ± 
    slave:
      hikari:
        pool-name: "SlavePool-${spring.application.name}-DEV"   # ä»åº“è¿æ¥æ± 
```

### 4.2 è¿æ¥æ± ç›‘æ§

```java
// å¯ä»¥æ·»åŠ ç›‘æ§Beanæ¥è·Ÿè¸ªè¿æ¥æ± ä½¿ç”¨æƒ…å†µ
@Component
@ConditionalOnProperty(name = "spring.profiles.active", havingValue = "dev")
public class DevDataSourceMonitor {
    
    @Autowired
    @Qualifier("masterDataSource")
    private HikariDataSource masterDataSource;
    
    @Autowired
    @Qualifier("slaveDataSource")  
    private HikariDataSource slaveDataSource;
    
    @Scheduled(fixedDelay = 30000) // æ¯30ç§’è¾“å‡ºä¸€æ¬¡
    public void logConnectionPoolStats() {
        log.info("=== è¿æ¥æ± ä½¿ç”¨æƒ…å†µ ===");
        log.info("Master Pool: active={}, idle={}, total={}", 
            masterDataSource.getHikariPoolMXBean().getActiveConnections(),
            masterDataSource.getHikariPoolMXBean().getIdleConnections(),
            masterDataSource.getHikariPoolMXBean().getTotalConnections());
            
        log.info("Slave Pool: active={}, idle={}, total={}",
            slaveDataSource.getHikariPoolMXBean().getActiveConnections(), 
            slaveDataSource.getHikariPoolMXBean().getIdleConnections(),
            slaveDataSource.getHikariPoolMXBean().getTotalConnections());
    }
}
```

## äº”ã€ç”Ÿäº§ç¯å¢ƒåˆ‡æ¢

### 5.1 é…ç½®ç¯å¢ƒåŒºåˆ†

#### **å¼€å‘ç¯å¢ƒ** (`application-dev.yml`)
```yaml
spring:
  datasource:
    master:
      jdbc-url: jdbc:postgresql://localhost:5433/binary_option      # åŒä¸€ä¸ªåº“
    slave:
      jdbc-url: jdbc:postgresql://localhost:5433/binary_option      # åŒä¸€ä¸ªåº“
```

#### **ç”Ÿäº§ç¯å¢ƒ** (`application-prod.yml`)
```yaml
spring:
  datasource:
    master:
      jdbc-url: jdbc:postgresql://prod-master:5432/binary_option    # çœŸæ­£çš„ä¸»åº“
    slave:
      jdbc-url: jdbc:postgresql://prod-slave:5432/binary_option     # çœŸæ­£çš„ä»åº“
```

### 5.2 å¹³æ»‘åˆ‡æ¢

```yaml
# å¯ä»¥é€šè¿‡é…ç½®å¼€å…³æ§åˆ¶
datasource:
  read-write-separation:
    enabled: true
    dev-mode: true  # å¼€å‘æ¨¡å¼ï¼šä¸»ä»æŒ‡å‘åŒä¸€ä¸ªåº“
```

## å…­ã€æµ‹è¯•åœºæ™¯

### 6.1 åŠŸèƒ½éªŒè¯æµ‹è¯•

```bash
# 1. æŸ¥è¯¢æ“ä½œæµ‹è¯•
echo "æµ‹è¯•æŸ¥è¯¢æ“ä½œ..."
curl "$API_BASE/api/account/balance?userId=1"
# æœŸæœ›æ—¥å¿—ï¼šuses SLAVE datasource

# 2. å†™æ“ä½œæµ‹è¯•  
echo "æµ‹è¯•å†™æ“ä½œ..."
curl -X POST "$API_BASE/api/order" -d '{"amount":100}'
# æœŸæœ›æ—¥å¿—ï¼šuses MASTER datasource

# 3. æ··åˆæ“ä½œæµ‹è¯•
echo "æµ‹è¯•æ··åˆæ“ä½œ..."
curl -X PUT "$API_BASE/api/order/1/status" -d '{"status":"SETTLED"}'
# æœŸæœ›æ—¥å¿—ï¼šuses MASTER datasourceï¼ˆå› ä¸ºåŒ…å«å†™æ“ä½œï¼‰
```

### 6.2 å‹åŠ›æµ‹è¯•

```bash
# å¹¶å‘æµ‹è¯•ï¼Œè§‚å¯Ÿè¿æ¥æ± ä½¿ç”¨
for i in {1..50}; do
    curl -s "$API_BASE/api/order/list" &
done
wait

# æ£€æŸ¥æ—¥å¿—ä¸­çš„è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
grep "SlavePool.*DEV" logs/*.log | wc -l
```

## ä¸ƒã€ä¼˜åŠ¿æ€»ç»“

### âœ… **å¼€å‘ç¯å¢ƒä¼˜åŠ¿**
1. **æ— éœ€ä¸»ä»å¤åˆ¶**ï¼šåªéœ€è¦ä¸€ä¸ªæ•°æ®åº“å®ä¾‹
2. **é€»è¾‘éªŒè¯**ï¼šå¯ä»¥å®Œæ•´éªŒè¯è¯»å†™åˆ†ç¦»çš„è·¯ç”±é€»è¾‘
3. **æ—¥å¿—æ¸…æ™°**ï¼šé€šè¿‡è¿æ¥æ± åç§°æ¸…æ¥šçœ‹åˆ°è·¯ç”±æ•ˆæœ
4. **æˆæœ¬ä½**ï¼šæ— éœ€é¢å¤–çš„æ•°æ®åº“èµ„æº

### âœ… **ç”Ÿäº§å°±ç»ª**
1. **é…ç½®å…¼å®¹**ï¼šç”Ÿäº§ç¯å¢ƒåªéœ€è¦ä¿®æ”¹æ•°æ®åº“è¿æ¥åœ°å€
2. **é€»è¾‘ä¸€è‡´**ï¼šå¼€å‘å’Œç”Ÿäº§ä½¿ç”¨å®Œå…¨ç›¸åŒçš„è·¯ç”±é€»è¾‘
3. **æµ‹è¯•å……åˆ†**ï¼šå¼€å‘ç¯å¢ƒå·²ç»éªŒè¯äº†æ‰€æœ‰è·¯ç”±åœºæ™¯

### âœ… **ç›‘æ§å®Œå–„**
1. **å®æ—¶æ—¥å¿—**ï¼šæ¸…æ¥šçœ‹åˆ°æ¯ä¸ªæ“ä½œä½¿ç”¨çš„æ•°æ®æº
2. **è¿æ¥æ± ç›‘æ§**ï¼šå¯ä»¥è§‚å¯Ÿåˆ°ä¸åŒè¿æ¥æ± çš„ä½¿ç”¨æƒ…å†µ
3. **æ€§èƒ½æŒ‡æ ‡**ï¼šä¸ºç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–æä¾›åŸºç¡€æ•°æ®

**è¿™ä¸ªæ–¹æ¡ˆæ—¢å®ç”¨åˆç»æµï¼Œå®Œç¾é€‚åˆå¼€å‘ç¯å¢ƒçš„éœ€æ±‚ï¼**