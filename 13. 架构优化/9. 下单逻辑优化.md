# 下单逻辑性能优化指南

## 概述

本文档提供了通过分析access日志来监控和优化下单流程各环节性能的完整指南。下单流程涉及多个微服务调用，通过access日志可以精确分析每个环节的耗时，找出性能瓶颈并进行针对性优化。

## 下单流程架构

完整下单流程包含以下5个关键步骤：

1. **完整下单接口** - 订单创建主流程
2. **获取订单价格** - Fixture API调用获取期权定价
3. **BTSE账户处理** - REAL账户资金转入处理
4. **本地账户处理** - 冻结用户资金
5. **订单对冲** - BTSE期权对冲下单

## API端点映射

| 步骤 | API端点 | 服务 | 说明 |
|------|---------|------|------|
| 1 | `POST /api/borc/order` | order-service | 订单创建主接口 |
| 2 | `POST /rpc/borc/btse/fixtures` | common-service | 获取期权定价 |
| 3 | `POST /rpc/borc/btse-transfer/transfer-from-btse` | common-service | BTSE资金转入 |
| 4 | `POST /rpc/borc/account/atomic/transfer-out` | common-service | 冻结用户资金 |
| 5 | `POST /rpc/borc/btse/newbet` | common-service | BTSE期权对冲 |

## 实际日志格式分析

基于您提供的日志样例，实际日志格式为：
```
message:2025-11-03T11:40:09 INFO 7 [http-nio-8080-exec-4] [ACCESS_LOG] [callId] [traceId] [username] [ip] [] : API Access: POST /api/borc/order/list/history?accountType=REAL - Status: 200 - Time: 51ms
```

**关键字段提取**：
- **API路径**：`POST /api/borc/order/list/history`
- **状态码**：`Status: 200`
- **耗时**：`Time: 51ms`
- **用户名**：`username` 字段
- **追踪ID**：`traceId` 字段

## Kibana查询语句

基于实际日志格式，以下是正确的KQL查询语句。**注意**：KQL主要用于过滤数据，统计分析建议通过Kibana的Visualize功能完成。

### 1. 完整下单流程性能分析

**基础过滤查询**：
```kql
message:"API Access: POST /api/borc/order - Status:" AND NOT message:"/api/borc/order/list/history"
```

**配置步骤**：
1. 在Discover中使用上述KQL过滤数据
2. 创建可视化图表，添加以下配置：
   - **Y轴 Metrics**: 
     - Average of extracted "Time: Xms" 
     - Max of extracted duration
     - Percentiles (90, 95, 99) of duration
   - **X轴 Buckets**: Date Histogram (@timestamp, 1分钟间隔)

### 2. Fixture API性能分析

**基础过滤查询**：
```kql
message:"API Access: POST /rpc/borc/btse/fixtures"
```

### 3. BTSE转账性能分析

**基础过滤查询**：
```kql
message:"API Access: POST /rpc/borc/btse-transfer/transfer-from-btse"
```

### 4. 账户操作性能分析

**基础过滤查询**：
```kql
message:"API Access: POST /rpc/borc/account/atomic/transfer-out"
```

### 5. 订单对冲性能分析

**基础过滤查询**：
```kql
message:"API Access: POST /rpc/borc/btse/newbet"
```

## 字段提取配置

为了进行统计分析，需要在Kibana中配置字段提取：

### 1. 提取耗时字段
在**Management > Index Patterns**中添加字段提取规则：
- **Field name**: `api_duration`
- **Pattern**: `Time: (\d+)ms`
- **Type**: number

### 2. 提取状态码字段
- **Field name**: `api_status`
- **Pattern**: `Status: (\d+)`
- **Type**: number

### 3. 提取API路径字段
- **Field name**: `api_path`
- **Pattern**: `API Access: POST ([^\s?]+)`
- **Type**: keyword

## 错误率监控

### 1. 错误请求过滤

**4xx错误**：
```kql
message:"API Access: POST" AND message:"Status: 4"
```

**5xx错误**：
```kql
message:"API Access: POST" AND message:"Status: 5"
```

**下单流程所有错误**：
```kql
(
  (message:"API Access: POST /api/borc/order - Status:" AND NOT message:"/api/borc/order/list/history") OR 
  message:"API Access: POST /rpc/borc/btse/fixtures" OR 
  message:"API Access: POST /rpc/borc/btse-transfer/transfer-from-btse" OR 
  message:"API Access: POST /rpc/borc/account/atomic/transfer-out" OR 
  message:"API Access: POST /rpc/borc/btse/newbet"
) AND (message:"Status: 4" OR message:"Status: 5")
```

### 2. 超时请求监控

**查找可能的超时请求（超过5秒）**：
```kql
message:"API Access: POST" AND message:"Time:" AND NOT message:"Time: [0-4]"
```

**更精确的超时过滤（需要手动验证）**：
- 查看日志中的 `Time: Xms` 或 `Time: Xs` 模式
- 使用字段提取后可以精确过滤

## 用户体验分析

### 1. 成功下单请求

```kql
message:"API Access: POST /api/borc/order - Status: 200" AND NOT message:"/api/borc/order/list/history"
```

### 2. 高频用户识别

```kql
message:"API Access: POST /api/borc/order - Status:" AND NOT message:"/api/borc/order/list/history"
```
在Kibana中按 `username` 字段聚合，统计每小时下单次数。

### 3. 慢请求识别

根据日志格式，可以查找耗时较长的请求：
- 查看 `Time: XXXms` 中XXX较大的值
- 建议配置字段提取后进行精确分析

## 性能基准和告警阈值

### 建议性能指标

| 步骤 | P50延迟 | P90延迟 | P95延迟 | 错误率 |
|------|---------|---------|---------|--------|
| 完整下单 | <500ms | <1500ms | <2000ms | <1% |
| Fixture API | <200ms | <500ms | <800ms | <0.5% |
| BTSE转账 | <300ms | <1000ms | <1500ms | <2% |
| 账户操作 | <50ms | <150ms | <300ms | <0.1% |
| 订单对冲 | <400ms | <1200ms | <2000ms | <5% |

### 告警规则

**基础KQL过滤 + Kibana Watcher配置**

1. **高延迟告警**：
```kql
message:"API Access: POST /api/borc/order - Status:" AND NOT message:"/api/borc/order/list/history"
```
在Kibana Watcher中配置：
- 监控提取的 `api_duration` 字段P95值
- 阈值：3000ms
- 时间窗口：5分钟

2. **高错误率告警**：
```kql
message:"API Access: POST /api/borc/order - Status:" AND NOT message:"/api/borc/order/list/history" AND (message:"Status: 4" OR message:"Status: 5")
```
在Kibana Watcher中配置：
- 计算错误率 = 错误数 / 总请求数
- 阈值：5%
- 时间窗口：5分钟

## 优化建议

### 1. 数据库优化

- **订单表索引优化**：确保`(user_id, account_type, status)`组合索引存在
- **账户表查询优化**：添加`(user_id, account_type)`覆盖索引
- **连接池调优**：根据QPS调整连接池大小

### 2. 外部API优化

- **BTSE API调用**：增加连接复用和请求缓存
- **Fixture API缓存**：对短期内的重复查询进行缓存
- **超时设置**：合理设置各API的超时时间

### 3. 应用层优化

- **异步处理**：对冲操作改为异步执行
- **批量操作**：账户更新使用批量事务
- **缓存策略**：用户状态和配置信息缓存

### 4. 监控和运维

- **实时监控**：设置关键指标的实时告警
- **容量规划**：根据性能趋势进行容量评估
- **降级机制**：在高负载时启用功能降级

## 性能测试脚本

```bash
#!/bin/bash
# 性能测试脚本示例

# 1. 并发下单测试
for i in {1..100}; do
  curl -X POST "http://localhost:8082/api/borc/order" \
    -H "Content-Type: application/json" \
    -d '{"userId":1,"symbolId":1,"direction":"UP","amount":100,"accountType":"DEMO"}' &
done
wait

# 2. 查看测试结果
echo "Performance test completed. Check Kibana for results."
```

## 总结

通过systematically监控这5个关键API端点的性能指标，可以：

1. **识别瓶颈**：快速定位性能瓶颈所在的具体环节
2. **优化决策**：基于数据制定针对性的优化策略
3. **容量规划**：根据性能趋势进行系统容量评估
4. **用户体验**：确保下单流程的响应速度满足用户期望
5. **系统稳定性**：通过监控和告警保障系统稳定运行

建议将这些KQL查询配置为Kibana Dashboard，实现下单性能的实时监控和历史趋势分析。